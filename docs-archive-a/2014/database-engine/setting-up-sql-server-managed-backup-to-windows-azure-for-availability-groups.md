---
title: Configuration de la SQL Server la gestion de sauvegarde sur Azure pour les groupes de disponibilité | Microsoft Docs
description: Ce didacticiel vous montre comment configurer SQL Server sauvegarde managée sur Microsoft Azure pour les bases de données qui participent à des groupes de disponibilité Always On.
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: backup-restore
ms.topic: conceptual
ms.assetid: 0c4553cd-d8e4-4691-963a-4e414cc0f1ba
author: mashamsft
ms.author: mathoma
ms.openlocfilehash: ebae9f75ac25698582b7f3e4c78c2fb773bd803e
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87600216"
---
# <a name="setting-up-sql-server-managed-backup-to-azure-for-availability-groups"></a><span data-ttu-id="0417b-103">Configuration de la sauvegarde managée de SQL Server sur Azure pour les groupes de disponibilité</span><span class="sxs-lookup"><span data-stu-id="0417b-103">Setting up SQL Server Managed Backup to Azure for Availability Groups</span></span>
  <span data-ttu-id="0417b-104">Cette rubrique est un didacticiel sur la configuration de la [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] pour les bases de données participant à des groupes de disponibilité AlwaysOn.</span><span class="sxs-lookup"><span data-stu-id="0417b-104">This topic is a tutorial on configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for databases participating in AlwaysOn Availability Groups.</span></span>  
  
## <a name="availability-group-configurations"></a><span data-ttu-id="0417b-105">Configurations de groupe de disponibilité</span><span class="sxs-lookup"><span data-stu-id="0417b-105">Availability Group Configurations</span></span>  
 [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)]<span data-ttu-id="0417b-106">est pris en charge pour les bases de données de groupe de disponibilité, que les réplicas soient configurés localement ou entièrement sur Azure, ou qu’il s’agisse d’une implémentation hybride entre un ordinateur local et un ou plusieurs ordinateurs virtuels Azure.</span><span class="sxs-lookup"><span data-stu-id="0417b-106">is supported for Availability Group databases, whether the replicas are all configured on-premises, or entirely on Azure, or a Hybrid implementation between on-premises and on one or more Azure virtual machines.</span></span> <span data-ttu-id="0417b-107">Cependant, tenez compte des éléments suivants pour une ou plusieurs implémentations :</span><span class="sxs-lookup"><span data-stu-id="0417b-107">However you might need to consider the following for one or more implementations:</span></span>  
  
-   <span data-ttu-id="0417b-108">Fréquence de sauvegarde du journal : la fréquence de sauvegarde du fichier journal dépend de la croissance du journal au cours d'une plage de temps déterminée.</span><span class="sxs-lookup"><span data-stu-id="0417b-108">Log Backup Frequency: The frequency of log backup is both time and log growth.</span></span> <span data-ttu-id="0417b-109">Par exemple, la sauvegarde de fichier journal est effectuée une fois toutes les 2 heures sauf si l'espace de journal utilisé pendant la période de 2 heures est de 5 Mo ou plus.</span><span class="sxs-lookup"><span data-stu-id="0417b-109">For example, the log backup is taken once every 2 hours unless the log space used within the two hour period is 5 MB or more.</span></span> <span data-ttu-id="0417b-110">Ceci s'applique à toutes les implémentations, locales, dans le cloud, ou hybrides.</span><span class="sxs-lookup"><span data-stu-id="0417b-110">This applies to all implementations, on-premises, cloud, or a Hybrid.</span></span>  
  
-   <span data-ttu-id="0417b-111">Bande passante réseau : cela s’applique aux implémentations où les réplicas se trouvent dans des emplacements physiques différents, comme dans un Cloud hybride, ou dans des régions Azure différentes dans une configuration Cloud uniquement.</span><span class="sxs-lookup"><span data-stu-id="0417b-111">Network Bandwidth: This applies to implementations where the replicas are located in different physical locations, like in a hybrid cloud, or across different Azure regions in a cloud only configuration.</span></span> <span data-ttu-id="0417b-112">La bande passante réseau peut affecter la latence des serveurs secondaires, et si les serveurs secondaires sont configurés avec la réplication synchrone, cela peut entraîner une croissance du journal sur le serveur principal.</span><span class="sxs-lookup"><span data-stu-id="0417b-112">The network bandwidth can affect the latency of the secondaries and if the secondaries are set to synchronous replication, then this can cause log growth on the primary.</span></span> <span data-ttu-id="0417b-113">Si les serveurs secondaires utilisent la réplication synchrone, il est possible qu'ils n'arrivent pas à garder le pas en raison du temps de réponse du réseau, ce qui peut entraîner une perte de données en cas de basculement vers le réplica secondaire.</span><span class="sxs-lookup"><span data-stu-id="0417b-113">If the secondaries are set to synchronous replication, the secondaries may not be able to keep up due to network latency, which can result in data loss in the event of a failover to the secondary replica.</span></span>  
  
### <a name="configuring-ss_smartbackup-for-availability-databases"></a><span data-ttu-id="0417b-114">Configuration de la [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] pour les bases de données de disponibilité</span><span class="sxs-lookup"><span data-stu-id="0417b-114">Configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for Availability Databases.</span></span>  
 <span data-ttu-id="0417b-115">**Autorisations :**</span><span class="sxs-lookup"><span data-stu-id="0417b-115">**Permissions:**</span></span>  
  
-   <span data-ttu-id="0417b-116">Requiert l’appartenance au rôle de base de données **db_backupoperator** , avec les autorisations **ALTER ANY CREDENTIAL** et les `EXECUTE` autorisations sur **sp_delete_backuphistory**procédure stockée.</span><span class="sxs-lookup"><span data-stu-id="0417b-116">Requires membership in **db_backupoperator** database role, with **ALTER ANY CREDENTIAL** permissions, and `EXECUTE` permissions on **sp_delete_backuphistory**stored procedure.</span></span>  
  
-   <span data-ttu-id="0417b-117">Requiert des autorisations **Select** sur la fonction **smart_admin. fn_get_current_xevent_settings**.</span><span class="sxs-lookup"><span data-stu-id="0417b-117">Requires **SELECT** permissions on the **smart_admin.fn_get_current_xevent_settings**function.</span></span>  
  
-   <span data-ttu-id="0417b-118">Requiert `EXECUTE` des autorisations sur la procédure stockée **smart_admin. sp_get_backup_diagnostics** .</span><span class="sxs-lookup"><span data-stu-id="0417b-118">Requires `EXECUTE` permissions on the **smart_admin.sp_get_backup_diagnostics** stored procedure.</span></span> <span data-ttu-id="0417b-119">En outre, nécessite les autorisations `VIEW SERVER STATE`, car elle appelle en interne d'autres objets système qui nécessitent cette autorisation.</span><span class="sxs-lookup"><span data-stu-id="0417b-119">In addition, it requires `VIEW SERVER STATE` permissions as it internally calls other system objects that require this permission.</span></span>  
  
-   <span data-ttu-id="0417b-120">Requiert `EXECUTE` des autorisations sur `smart_admin.sp_set_instance_backup` les `smart_admin.sp_backup_master_switch` procédures stockées et.</span><span class="sxs-lookup"><span data-stu-id="0417b-120">Requires `EXECUTE` permissions on the `smart_admin.sp_set_instance_backup` and `smart_admin.sp_backup_master_switch` stored procedures.</span></span>  
  
 <span data-ttu-id="0417b-121">Les étapes de base de configuration d'un groupe de disponibilité AlwaysOn avec la [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] sont les suivantes.</span><span class="sxs-lookup"><span data-stu-id="0417b-121">The following are the basic steps to setting up an AlwaysOn Availability Group with [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].</span></span> <span data-ttu-id="0417b-122">Un didacticiel pas à pas détaillé est décrit plus loin dans cette rubrique.</span><span class="sxs-lookup"><span data-stu-id="0417b-122">A detailed step-by step tutorial is described later in this topic.</span></span>  
  
1.  <span data-ttu-id="0417b-123">Une fois que vous avez créé le groupe de disponibilité, configurez le réplica de sauvegarde par défaut.</span><span class="sxs-lookup"><span data-stu-id="0417b-123">Once you have created Availability Group, configure the preferred backup replica.</span></span> <span data-ttu-id="0417b-124">Ce paramètre du groupe de disponibilité est également utilisé par la [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] pour déterminer quel réplica utiliser pour la sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="0417b-124">This setting for the Availability Group is also used by [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] to determine which replica to use for backup.</span></span> <span data-ttu-id="0417b-125">Pour obtenir des instructions pas à pas sur la configuration de la préférence de sauvegarde, consultez [configurer la sauvegarde sur les réplicas de disponibilité &#40;SQL Server&#41;](availability-groups/windows/configure-backup-on-availability-replicas-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="0417b-125">For step by step instructions about how to set up the backup preference, see [Configure Backup on Availability Replicas &#40;SQL Server&#41;](availability-groups/windows/configure-backup-on-availability-replicas-sql-server.md).</span></span>  <span data-ttu-id="0417b-126">Si vous créez un groupe de disponibilité AlwaysOn, consultez [prise en main avec groupes de disponibilité AlwaysOn &#40;SQL Server&#41;](availability-groups/windows/getting-started-with-always-on-availability-groups-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="0417b-126">If you are creating a new AlwaysOn Availability Group, see [Getting Started with AlwaysOn Availability Groups &#40;SQL Server&#41;](availability-groups/windows/getting-started-with-always-on-availability-groups-sql-server.md).</span></span>  
  
2.  <span data-ttu-id="0417b-127">Configurez l'accès à la connexion en lecture seule sur les réplicas secondaires.</span><span class="sxs-lookup"><span data-stu-id="0417b-127">Configure read only connection access to the secondary replicas.</span></span> <span data-ttu-id="0417b-128">Pour obtenir des instructions pas à pas sur la configuration de l’accès en lecture seule, consultez [configurer l’accès en lecture seule sur un réplica de disponibilité &#40;SQL Server&#41;](availability-groups/windows/configure-read-only-access-on-an-availability-replica-sql-server.md)</span><span class="sxs-lookup"><span data-stu-id="0417b-128">For step by step instructions about how to configure read only access, see [Configure Read-Only Access on an Availability Replica &#40;SQL Server&#41;](availability-groups/windows/configure-read-only-access-on-an-availability-replica-sql-server.md)</span></span>  
  
3.  <span data-ttu-id="0417b-129">Spécifiez le réplica de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="0417b-129">Specify Backup replica.</span></span> <span data-ttu-id="0417b-130">Le paramètre du réplica de sauvegarde par défaut est utilisé par la [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] pour déterminer quelle base de données utiliser pour planifier les sauvegardes.</span><span class="sxs-lookup"><span data-stu-id="0417b-130">The preferred backup replica setting is used by [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] to determine which database to use for scheduling backups from..</span></span>  <span data-ttu-id="0417b-131">Pour déterminer si le réplica actuel est le réplica de sauvegarde par défaut, utilisez la fonction [sys. fn_hadr_backup_is_preferred_replica &#40;Transact-SQL&#41;](/sql/relational-databases/system-functions/sys-fn-hadr-backup-is-preferred-replica-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="0417b-131">To determine whether the current replica is the preferred backup replica, use the [sys.fn_hadr_backup_is_preferred_replica  &#40;Transact-SQL&#41;](/sql/relational-databases/system-functions/sys-fn-hadr-backup-is-preferred-replica-transact-sql) function.</span></span>  
  
4.  <span data-ttu-id="0417b-132">À chaque réplication de [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] la configuration d’exécution de la base de données à l’aide de la procédure stockée **Smart-admin. sp_set_db_backup** .</span><span class="sxs-lookup"><span data-stu-id="0417b-132">On each replica run [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] configuration for the database using the **smart-admin.sp_set_db_backup** stored procedure.</span></span>  
  
     <span data-ttu-id="0417b-133">\*\* [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] comportement après un basculement :\*\* [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] continue à fonctionner et à gérer les copies de sauvegarde et la capacité de récupération après un événement de basculement.</span><span class="sxs-lookup"><span data-stu-id="0417b-133">**[!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] behavior after a failover:** [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] will continue to work and maintain backup copies and recoverability after a failover event.</span></span> <span data-ttu-id="0417b-134">Aucune action spécifique n'est requise après un basculement.</span><span class="sxs-lookup"><span data-stu-id="0417b-134">No specific action is required after a failover.</span></span>  
  
#### <a name="considerations-and-requirements"></a><span data-ttu-id="0417b-135">Conditions requises et éléments à prendre en compte :</span><span class="sxs-lookup"><span data-stu-id="0417b-135">Considerations and Requirements:</span></span>  
 <span data-ttu-id="0417b-136">La configuration de la [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] pour des bases de données participant à un groupe de disponibilité AlwaysOn nécessite des conditions spécifiques.</span><span class="sxs-lookup"><span data-stu-id="0417b-136">Configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for databases participating in AlwaysOn Availability Group requires specific considerations and requirements.</span></span> <span data-ttu-id="0417b-137">Voici la liste des éléments à prendre en considération et des conditions requises :</span><span class="sxs-lookup"><span data-stu-id="0417b-137">Following is a list of considerations and requirements:</span></span>  
  
-   <span data-ttu-id="0417b-138">Les paramètres de configuration de la [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] doivent être identiques pour toutes les bases de données sur tous les nœuds de [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] qui participent au même groupe de disponibilité.</span><span class="sxs-lookup"><span data-stu-id="0417b-138">The [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] configuration settings should be the same for all the databases on all the nodes of [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] participating in the same Availability Group.</span></span> <span data-ttu-id="0417b-139">Vous pouvez obtenir cela en utilisant la même configuration de la [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] pour le réplica principal et tous les réplicas secondaires, ou en utilisant les mêmes paramètres de la [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] par défaut sur tous les nœuds qui participent aux groupes de disponibilité.</span><span class="sxs-lookup"><span data-stu-id="0417b-139">You can achieve this either by setting  the same [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] configurations for the primary and all the replicas at the database level, or by setting the same default [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] settings on all the nodes participating in the Availability Groups.</span></span> <span data-ttu-id="0417b-140">Nous recommandons de configurer la [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] sur la base de données, car en configurant la [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] au niveau de la base de données, vous pouvez isoler les paramètres sur la base de données. De plus, les paramètres par défaut modifiés sont appliqués à toutes les autres bases de données sur l'instance.</span><span class="sxs-lookup"><span data-stu-id="0417b-140">We recommend setting [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] at the database because configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] at the database level lets you isolate the settings to the databases and changes to default settings affect all other databases on the instance.</span></span>  
  
-   <span data-ttu-id="0417b-141">Spécifiez le réplica de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="0417b-141">Specify Backup replica.</span></span> <span data-ttu-id="0417b-142">Le paramètre du réplica de sauvegarde par défaut est utilisé par la [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] pour planifier les sauvegardes.</span><span class="sxs-lookup"><span data-stu-id="0417b-142">The preferred backup replica setting is used by [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] to schedule the backups.</span></span> <span data-ttu-id="0417b-143">Pour déterminer si le réplica actuel est le réplica de sauvegarde par défaut, utilisez la fonction [sys. fn_hadr_backup_is_preferred_replica &#40;Transact-SQL&#41;](/sql/relational-databases/system-functions/sys-fn-hadr-backup-is-preferred-replica-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="0417b-143">To determine whether the current replica is the preferred backup replica, use the [sys.fn_hadr_backup_is_preferred_replica  &#40;Transact-SQL&#41;](/sql/relational-databases/system-functions/sys-fn-hadr-backup-is-preferred-replica-transact-sql) function.</span></span>  
  
-   <span data-ttu-id="0417b-144">Si le réplica secondaire est configuré comme réplica par défaut, il doit avoir au moins un accès à la connexion en lecture seule.</span><span class="sxs-lookup"><span data-stu-id="0417b-144">If the secondary replica is configured as the preferred replica, it should be configured to have at least read only connection access.</span></span> <span data-ttu-id="0417b-145">Les groupes de disponibilité qui n'ont pas d'accès à la connexion sur les bases de données secondaires ne sont pas pris en charge.</span><span class="sxs-lookup"><span data-stu-id="0417b-145">Availability groups that have no connection access to secondary databases are not supported.</span></span>  <span data-ttu-id="0417b-146">Pour plus d’informations, consultez [Configurer l’accès en lecture seule sur un réplica de disponibilité &#40;SQL Server&#41;](availability-groups/windows/configure-read-only-access-on-an-availability-replica-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="0417b-146">For more information, see [Configure Read-Only Access on an Availability Replica &#40;SQL Server&#41;](availability-groups/windows/configure-read-only-access-on-an-availability-replica-sql-server.md).</span></span>  
  
-   <span data-ttu-id="0417b-147">Si vous configurez la [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] après avoir configuré le groupe de disponibilité, la [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] tentera de copier toutes les sauvegardes existantes sur le conteneur de stockage.</span><span class="sxs-lookup"><span data-stu-id="0417b-147">If you are configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] after you configure the Availability Group, [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] will attempt to copy any existing backups based and copy them over to the storage container.</span></span>  <span data-ttu-id="0417b-148">Si la [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] n'arrive pas à trouver ou à accéder aux sauvegardes existantes, elle planifiera une sauvegarde de bases de données complète.</span><span class="sxs-lookup"><span data-stu-id="0417b-148">If [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] is unable to find or access existing backups, it will schedule a full database backup.</span></span> <span data-ttu-id="0417b-149">Cela vise précisément à optimiser les opérations de sauvegarde pour les bases de données d'un groupe de disponibilité.</span><span class="sxs-lookup"><span data-stu-id="0417b-149">This is done specifically to optimize the backup operations for Availability Group databases.</span></span>  
  
-   <span data-ttu-id="0417b-150">Vous pouvez envisager de désactiver les paramètres au niveau de l’instance si vous créez une nouvelle base de données de disponibilité et que vous n’envisagez pas d’appliquer les paramètres au niveau de l’instance à la base de données.</span><span class="sxs-lookup"><span data-stu-id="0417b-150">You may want to consider disabling the instance level settings if you are creating a new availability database, and you don't intend to apply the instance level settings to the database</span></span>  
  
-   <span data-ttu-id="0417b-151">Lorsque vous utilisez le chiffrement, utilisez le même certificat sur tous les réplicas.</span><span class="sxs-lookup"><span data-stu-id="0417b-151">When using encryption, use the same certificate on all the replicas.</span></span> <span data-ttu-id="0417b-152">Cela permet des opérations de sauvegarde continues et ininterrompues en cas de basculement ou de restauration sur un réplica différent.</span><span class="sxs-lookup"><span data-stu-id="0417b-152">This facilitates continued and uninterrupted backup operations in the event of a failover or restores to a different replica.</span></span>  
  
#### <a name="enable-and-configure-ss_smartbackup-for-an-availability-database"></a><span data-ttu-id="0417b-153">Activer et configurer la [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] pour une base de données de disponibilité</span><span class="sxs-lookup"><span data-stu-id="0417b-153">Enable and Configure [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for an Availability Database</span></span>  
 <span data-ttu-id="0417b-154">Ce didacticiel décrit les étapes d'activation et de configuration de la [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] pour une base de données (AGTestDB) sur les ordinateurs Node1 et Node2, puis les étapes d'activation de la surveillance de l'état d'intégrité de la [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].</span><span class="sxs-lookup"><span data-stu-id="0417b-154">This tutorial describes the steps to enable and configure [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for a database (AGTestDB) on computers Node1 and Node2, followed by steps to enable monitoring the [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] health status.</span></span>  
  
1.  <span data-ttu-id="0417b-155">**Créez un compte de stockage Azure :** Les sauvegardes sont stockées dans le service de stockage d’objets BLOB Azure.</span><span class="sxs-lookup"><span data-stu-id="0417b-155">**Create an Azure storage account:** The backups are stored in the Azure Blob storage service.</span></span> <span data-ttu-id="0417b-156">Vous devez d’abord créer un compte de stockage Azure, si vous n’en avez pas déjà un.</span><span class="sxs-lookup"><span data-stu-id="0417b-156">You must first create an Azure storage account, if you do not already have one.</span></span> <span data-ttu-id="0417b-157">Pour plus d’informations, consultez [création d’un compte de stockage Azure](https://www.windowsazure.com/manage/services/storage/how-to-create-a-storage-account/).</span><span class="sxs-lookup"><span data-stu-id="0417b-157">For more information, see [Creating an Azure Storage Account](https://www.windowsazure.com/manage/services/storage/how-to-create-a-storage-account/).</span></span> <span data-ttu-id="0417b-158">Notez le nom du compte de stockage, les clés d'accès et l'URL du compte de stockage.</span><span class="sxs-lookup"><span data-stu-id="0417b-158">Make a note of the storage account name, access keys, and URL of the storage account.</span></span> <span data-ttu-id="0417b-159">Le nom du compte de stockage et les informations de clé d'accès sont utilisés pour créer un objet contenant les informations d'identification SQL.</span><span class="sxs-lookup"><span data-stu-id="0417b-159">The storage account name and access key information is used to create a SQL Credential.</span></span> <span data-ttu-id="0417b-160">La [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] se sert des informations d'identification SQL pour authentifier le compte de stockage pendant les opérations de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="0417b-160">The SQL Credential is used by [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] during backup operations to authenticate to the storage account.</span></span>  
  
2.  <span data-ttu-id="0417b-161">**Créer des informations d’identification SQL :** Créez des informations d’identification SQL en utilisant le nom du compte de stockage comme identité et la clé d’accès de stockage comme mot de passe.</span><span class="sxs-lookup"><span data-stu-id="0417b-161">**Create a SQL Credential:** Create a SQL Credential using the name of the storage account as the Identity and the storage access key as the password.</span></span>  
  
3.  <span data-ttu-id="0417b-162">**Vérifiez que le service SQL Server Agent est démarré et exécuté :** Démarrez SQL Server Agent s’il n’est pas exécuté actuellement.</span><span class="sxs-lookup"><span data-stu-id="0417b-162">**Ensure SQL Server Agent service is Started and Running:** Start SQL Server Agent if it is not currently running.</span></span> [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] <span data-ttu-id="0417b-163">nécessite l'exécution de SQL Server Agent sur l'instance pour effectuer les opérations de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="0417b-163">requires SQL Server Agent to be running on the instance to perform backup operations.</span></span>  <span data-ttu-id="0417b-164">Vous pouvez configurer l'exécution automatique de l'Agent SQL, pour vous assurer que les opérations de sauvegarde se déroulent régulièrement.</span><span class="sxs-lookup"><span data-stu-id="0417b-164">You may want to set SQL Agent to run automatically to make sure that backup operations can occur regularly.</span></span>  
  
4.  <span data-ttu-id="0417b-165">**Déterminez la période de rétention :** Déterminez la période de rétention souhaitée pour les fichiers de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="0417b-165">**Determine the retention period:** Determine the retention period that you want for the backup files.</span></span> <span data-ttu-id="0417b-166">La période de rétention est spécifiée en jours, sur une plage de 1 à 30.</span><span class="sxs-lookup"><span data-stu-id="0417b-166">The retention period is specified in days and can range from 1 to 30.</span></span> <span data-ttu-id="0417b-167">Elle détermine le délai de récupérabilité de la base de données.</span><span class="sxs-lookup"><span data-stu-id="0417b-167">The retention period determines the recoverability time frame for the database.</span></span>  
  
5.  <span data-ttu-id="0417b-168">**Créez un certificat ou une clé asymétrique à utiliser pour le chiffrement lors de la sauvegarde :** Créez le certificat sur le premier nœud Node1, puis exportez-le vers un fichier à l’aide du [certificat de sauvegarde &#40;&#41;Transact-SQL ](/sql/t-sql/statements/backup-certificate-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="0417b-168">**Create a Certificate or Asymmetric key to use for encryption during back up:** Create the certificate on the first node Node1, and then export it to a file using [BACKUP CERTIFICATE &#40;Transact-SQL&#41;](/sql/t-sql/statements/backup-certificate-transact-sql)..</span></span> <span data-ttu-id="0417b-169">Sur le nœud 2, créez un certificat en utilisant le fichier exporté du nœud 1.</span><span class="sxs-lookup"><span data-stu-id="0417b-169">On Node 2, create a certificate using the file exported from Node 1 .</span></span> <span data-ttu-id="0417b-170">Pour plus d’informations sur la création d’un certificat à partir d’un fichier, consultez l’exemple dans [Create certificate &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-certificate-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="0417b-170">For more information on creating a certificate from a file, see the example in [CREATE CERTIFICATE &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-certificate-transact-sql).</span></span>  
  
6.  <span data-ttu-id="0417b-171">**Activez et configurez [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] pour AGTestDB sur Node1 :** Démarrez SQL Server Management Studio et connectez-vous à l’instance sur Node1 où la base de données de disponibilité est installée.</span><span class="sxs-lookup"><span data-stu-id="0417b-171">**Enable and configure [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for AGTestDB on Node1:** Start SQL Server Management Studio  and connect to the instance on Node1 where the availability database  is installed.</span></span> <span data-ttu-id="0417b-172">Dans la fenêtre de requête, exécutez l'instruction suivante après avoir modifié les valeurs du nom de la base de données, de l'URL de stockage, des informations d'identification SQL et de la période de rétention selon vos besoins.</span><span class="sxs-lookup"><span data-stu-id="0417b-172">From the query window run the following statement after you modify the values for the database name, storage URL, SQL Credential and retention period per your requirements:</span></span>  
  
    ```sql  
    Use msdb;  
    GO  
    EXEC smart_admin.sp_set_db_backup   
                    @database_name='AGTestDB'   
                    ,@retention_days=30   
                    ,@credential_name='MyCredential'  
                    ,@encryption_algorithm ='AES_128'  
                    ,@encryptor_type= 'Certificate'  
                    ,@encryptor_name='MyBackupCert'  
                    ,@enable_backup=1;  
    GO  
    ```  
  
     <span data-ttu-id="0417b-173">Pour plus d’informations sur la création d’un certificat pour le chiffrement, consultez l’étape **créer un certificat de sauvegarde** dans [créer une sauvegarde chiffrée](../relational-databases/backup-restore/create-an-encrypted-backup.md).</span><span class="sxs-lookup"><span data-stu-id="0417b-173">For more information on creating a certificate for encryption, see the **Create a Backup Certificate** step in [Create an Encrypted Backup](../relational-databases/backup-restore/create-an-encrypted-backup.md).</span></span>  
  
7.  <span data-ttu-id="0417b-174">**Activez et configurez [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] pour AGTestDB sur Node2 :** Démarrez SQL Server Management Studio et connectez-vous à l’instance sur Node2 où la base de données de disponibilité est installée.</span><span class="sxs-lookup"><span data-stu-id="0417b-174">**Enable and configure [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for AGTestDB on Node2:** Start SQL Server Management Studio and connect to the instance on Node2 where the availability database  is installed.</span></span> <span data-ttu-id="0417b-175">Dans la fenêtre de requête, exécutez l'instruction suivante après avoir modifié les valeurs du nom de la base de données, de l'URL de stockage, des informations d'identification SQL et de la période de rétention selon vos besoins.</span><span class="sxs-lookup"><span data-stu-id="0417b-175">From the query window run the following statement after you modify the values for the database name, storage URL, SQL Credential and retention period per your requirements:</span></span>  
  
    ```sql  
    Use msdb;  
    GO  
    EXEC smart_admin.sp_set_db_backup   
                    @database_name='AGTestDB'   
                    ,@retention_days=30   
                    ,@credential_name='MyCredential'  
                    ,@encryption_algorithm ='AES_128'  
                    ,@encryptor_type= 'Certificate'  
                    ,@encryptor_name='MyBackupCert'  
                    ,@enable_backup=1;  
    GO  
    ```  
  
     [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] <span data-ttu-id="0417b-176">est maintenant activée sur la base de données spécifiée.</span><span class="sxs-lookup"><span data-stu-id="0417b-176">is now enabled on the database you specified.</span></span> <span data-ttu-id="0417b-177">Un délai de 15 minutes au maximum peut être nécessaire pour le démarrage des opérations de sauvegarde sur la base de données.</span><span class="sxs-lookup"><span data-stu-id="0417b-177">It may take up to 15 minutes for the backup operations on the database to start to run.</span></span> <span data-ttu-id="0417b-178">La sauvegarde aura lieu sur le réplica de sauvegarde par défaut.</span><span class="sxs-lookup"><span data-stu-id="0417b-178">The backup will occur on the preferred backup replica.</span></span>  
  
8.  <span data-ttu-id="0417b-179">**Passez en revue la configuration par défaut des événements étendus :**  Passez en revue la configuration des événements étendus en exécutant l’instruction Transact-SQL suivante sur le réplica qui [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] utilise pour planifier les sauvegardes à partir de.</span><span class="sxs-lookup"><span data-stu-id="0417b-179">**Review Extended Event Default Configuration:**  Review the Extended Event configuration by running the following transact-SQL statement on the replica that [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] is using to schedule the backups from.</span></span> <span data-ttu-id="0417b-180">Il s'agit généralement des paramètres du réplica de sauvegarde par défaut pour le groupe de disponibilité auquel appartient la base de données.</span><span class="sxs-lookup"><span data-stu-id="0417b-180">This is usually the preferred backup replica setting for the Availability Group that the database belongs to.</span></span>  
  
    ```sql  
    SELECT * FROM smart_admin.fn_get_current_xevent_settings(); 
    ```  
  
     <span data-ttu-id="0417b-181">Les événements du canal d'administration, opérationnel et analytique doivent être activés par défaut et ne doivent pas pouvoir être désactivés.</span><span class="sxs-lookup"><span data-stu-id="0417b-181">You should see that Admin, Operational  and Analytical channel events are enabled by default and cannot be disabled.</span></span> <span data-ttu-id="0417b-182">Cela est en principe suffisant pour surveiller les événements qui nécessitent une intervention manuelle.</span><span class="sxs-lookup"><span data-stu-id="0417b-182">This should be sufficient to monitor the events that require manual intervention.</span></span>  <span data-ttu-id="0417b-183">Vous pouvez activer les événements de débogage, mais ces canaux comprennent des événements d'information et de débogage que la [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] utilise pour détecter et résoudre les problèmes.</span><span class="sxs-lookup"><span data-stu-id="0417b-183">You can enable the debug events, but these channels include informational and debug events that [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] uses to detect issues and solve them.</span></span> <span data-ttu-id="0417b-184">Pour plus d’informations, consultez [Monitor SQL Server Managed Backup to Azure](../relational-databases/backup-restore/sql-server-managed-backup-to-microsoft-azure.md).</span><span class="sxs-lookup"><span data-stu-id="0417b-184">For more information, see [Monitor SQL Server Managed Backup to Azure](../relational-databases/backup-restore/sql-server-managed-backup-to-microsoft-azure.md).</span></span>  
  
9. <span data-ttu-id="0417b-185">**Activez et configurez les notifications de l’état d’intégrité :** [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] fournit une procédure stockée qui crée un travail d’agent pour envoyer des notifications par e-mail des erreurs ou des avertissements susceptibles de nécessiter une intervention.</span><span class="sxs-lookup"><span data-stu-id="0417b-185">**Enable and Configure Notification for Health Status:** [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] has a stored procedure that creates an agent job to send out e-mail notifications of errors or warnings that may require attention.</span></span>  <span data-ttu-id="0417b-186">Pour recevoir ces notifications, vous devez activer l'exécution de la procédure stockée qui crée un travail SQL Server Agent.</span><span class="sxs-lookup"><span data-stu-id="0417b-186">To receive such notifications, you must enable run the stored procedure which creates a SQL Server Agent Job.</span></span> <span data-ttu-id="0417b-187">Les étapes suivantes décrivent la procédure d'activation et de configuration des notifications par courrier électronique :</span><span class="sxs-lookup"><span data-stu-id="0417b-187">The following steps describe the process to enable and configure e-mail notifications:</span></span>  
  
    1.  <span data-ttu-id="0417b-188">Configurez la messagerie de base de données si elle n'est pas déjà activée sur l'instance.</span><span class="sxs-lookup"><span data-stu-id="0417b-188">Setup Database Mail if it is not already enabled on the instance.</span></span> <span data-ttu-id="0417b-189">Pour plus d'informations, consultez [Configure Database Mail](../relational-databases/database-mail/configure-database-mail.md).</span><span class="sxs-lookup"><span data-stu-id="0417b-189">For more information, see [Configure Database Mail](../relational-databases/database-mail/configure-database-mail.md).</span></span>  
  
    2.  <span data-ttu-id="0417b-190">Configurez la notification SQL Server Agent afin qu'elle utilise la messagerie de base de données.</span><span class="sxs-lookup"><span data-stu-id="0417b-190">Configure SQL Server Agent Notification to use Database Mail.</span></span> <span data-ttu-id="0417b-191">Pour plus d’informations, consultez [Configurer la messagerie de SQL Server Agent en vue de l’utilisation de la messagerie de base de données](../relational-databases/database-mail/configure-sql-server-agent-mail-to-use-database-mail.md).</span><span class="sxs-lookup"><span data-stu-id="0417b-191">For more information, see [Configure SQL Server Agent Mail to Use Database Mail](../relational-databases/database-mail/configure-sql-server-agent-mail-to-use-database-mail.md).</span></span>  
  
    3.  <span data-ttu-id="0417b-192">**Activez les notifications par e-mail afin de recevoir les erreurs de sauvegarde et les avertissements :** Dans la fenêtre de requête, exécutez les instructions Transact-SQL suivantes :</span><span class="sxs-lookup"><span data-stu-id="0417b-192">**Enable e-mail notifications to receive backup errors and warnings:** From the query window, run the following Transact-SQL statements:</span></span>  
  
        ```sql  
        EXEC msdb.smart_admin.sp_set_parameter  
        @parameter_name = 'SSMBackup2WANotificationEmailIds',  
        @parameter_value = '<email>'  
        ```  
  
         <span data-ttu-id="0417b-193">Pour plus d’informations et pour obtenir un exemple de script complet, consultez [Monitor SQL Server Managed Backup to Azure](../relational-databases/backup-restore/sql-server-managed-backup-to-microsoft-azure.md).</span><span class="sxs-lookup"><span data-stu-id="0417b-193">For more information and a full sample script see [Monitor SQL Server Managed Backup to Azure](../relational-databases/backup-restore/sql-server-managed-backup-to-microsoft-azure.md).</span></span>  
  
10. <span data-ttu-id="0417b-194">**Affichez les fichiers de sauvegarde dans le compte de stockage Azure :** Connectez-vous au compte de stockage à partir de SQL Server Management Studio ou du Portail de gestion Azure.</span><span class="sxs-lookup"><span data-stu-id="0417b-194">**View backup files in the Azure Storage Account:** Connect to the storage account from SQL Server Management Studio or the Azure Management Portal.</span></span> <span data-ttu-id="0417b-195">Vous verrez un conteneur pour l'instance de SQL Server qui héberge la base de données que vous avez configurée pour utiliser la [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].</span><span class="sxs-lookup"><span data-stu-id="0417b-195">You will see a container for the instance of SQL Server that hosts the database you configured to use [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)].</span></span> <span data-ttu-id="0417b-196">Vous pourrez voir aussi une base de données et une sauvegarde de journal 15 minutes après l'activation de la [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] pour la base de données.</span><span class="sxs-lookup"><span data-stu-id="0417b-196">You may also see a database and a log backup within 15 minutes of enabling [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for the database.</span></span>  
  
11. <span data-ttu-id="0417b-197">**Supervisez l’état d’intégrité :**  Vous pouvez le superviser au moyen des notifications par e-mail configurées précédemment, ou en supervisant activement les événements enregistrés.</span><span class="sxs-lookup"><span data-stu-id="0417b-197">**Monitor the Health Status:**  You can monitor through e-mail notifications you configured previously, or actively monitor the events logged.</span></span> <span data-ttu-id="0417b-198">Voici quelques exemples d'instructions Transact SQL utilisées pour afficher les événements :</span><span class="sxs-lookup"><span data-stu-id="0417b-198">The following are some example Transact-SQL Statements used to view the events:</span></span>  
  
    ```sql  
    --  view all admin events  
    Use msdb;  
    Go  
    DECLARE @startofweek datetime  
    DECLARE @endofweek datetime  
    SET @startofweek = DATEADD(Day, 1-DATEPART(WEEKDAY, CURRENT_TIMESTAMP), CURRENT_TIMESTAMP)   
    SET @endofweek = DATEADD(Day, 7-DATEPART(WEEKDAY, CURRENT_TIMESTAMP), CURRENT_TIMESTAMP)  
  
    DECLARE @eventresult TABLE  
    (event_type nvarchar(512),  
    event varchar (512),  
    timestamp datetime  
    )  
  
    INSERT INTO @eventresult  
  
    EXEC smart_admin.sp_get_backup_diagnostics @begin_time = @startofweek, @end_time = @endofweek  
  
    SELECT * from @eventresult  
    WHERE event_type LIKE '%admin%'  
    ```  
  
    ```sql  
    -- to enable debug events  
    Use msdb;  
    Go  
    EXEC smart_admin.sp_set_parameter 'FileRetentionDebugXevent', 'True'  
    ```  
  
    ```sql  
    --  View all events in the current week  
    Use msdb;  
    Go  
    DECLARE @startofweek datetime  
    DECLARE @endofweek datetime  
    SET @startofweek = DATEADD(Day, 1-DATEPART(WEEKDAY, CURRENT_TIMESTAMP), CURRENT_TIMESTAMP)   
    SET @endofweek = DATEADD(Day, 7-DATEPART(WEEKDAY, CURRENT_TIMESTAMP), CURRENT_TIMESTAMP)  
  
    EXEC smart_admin.sp_get_backup_diagnostics @begin_time = @startofweek, @end_time = @endofweek;  
    ```  
  
 <span data-ttu-id="0417b-199">Les étapes de cette section sont propres à la configuration initiale de la [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] sur la base de données.</span><span class="sxs-lookup"><span data-stu-id="0417b-199">The steps described in this section are specifically for configuring [!INCLUDE[ss_smartbackup](../includes/ss-smartbackup-md.md)] for the first time on the database.</span></span> <span data-ttu-id="0417b-200">Vous pouvez modifier les configurations existantes à l’aide de la même procédure stockée système **smart_admin. sp_set_db_backup** et fournir les nouvelles valeurs.</span><span class="sxs-lookup"><span data-stu-id="0417b-200">You can modify the existing configurations using the same system stored procedure **smart_admin.sp_set_db_backup** and provide the new values.</span></span> <span data-ttu-id="0417b-201">Pour plus d’informations, consultez [SQL Server gestion de la sauvegarde vers Azure-paramètres de rétention et de stockage](../../2014/database-engine/sql-server-managed-backup-to-windows-azure-retention-and-storage-settings.md).</span><span class="sxs-lookup"><span data-stu-id="0417b-201">For more information, see [SQL Server Managed Backup to Azure - Retention and Storage Settings](../../2014/database-engine/sql-server-managed-backup-to-windows-azure-retention-and-storage-settings.md).</span></span>  
  
### <a name="considerations-when-removing-a-database-from-alwayson-availability-group-configuration"></a><span data-ttu-id="0417b-202">Éléments à prendre en considération lors de la suppression d'une base de données de la configuration d'un groupe de disponibilité AlwaysOn</span><span class="sxs-lookup"><span data-stu-id="0417b-202">Considerations when Removing a Database from AlwaysOn Availability Group Configuration</span></span>  
 <span data-ttu-id="0417b-203">Si une base de données est supprimée de la configuration du groupe de disponibilité AlwaysOn et est désormais une base de données autonome, nous vous recommandons de procéder à une sauvegarde à l’aide de [smart_admin. sp_backup_on_demand &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/managed-backup-sp-backup-on-demand-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="0417b-203">If a database is removed from the AlwaysOn Availability Group configuration and is now a stand-alone database, we recommend doing backup using [smart_admin.sp_backup_on_demand &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/managed-backup-sp-backup-on-demand-transact-sql).</span></span> <span data-ttu-id="0417b-204">Lorsque vous créez une sauvegarde de base de données de cette façon, une nouvelle chaîne de sauvegarde et le fichier sont placés dans le conteneur associé à l'instance au lieu du conteneur de disponibilité où les sauvegardes ont été enregistrées lorsque la base de données faisait partie d'un groupe de disponibilité.</span><span class="sxs-lookup"><span data-stu-id="0417b-204">When you create a database backup  this way, it establishes  a new backup chain and the file will be placed in the instance specific container as opposed to Availability container where the backups were stored when the database was part of Availability Group.</span></span>  
  
> [!WARNING]  
>  <span data-ttu-id="0417b-205">Dans ce scénario, la récupérabilité de la base de données à partir de sauvegardes antérieures à la modification de l'état du groupe de disponibilité n'est pas garantie.</span><span class="sxs-lookup"><span data-stu-id="0417b-205">The recoverability of the database in this scenario from backups previous to the change in the Availability Group status is not guaranteed.</span></span>  
  
