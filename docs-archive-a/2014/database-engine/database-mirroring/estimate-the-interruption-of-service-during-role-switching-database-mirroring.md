---
title: Estimer l’interruption de service pendant le basculement de rôle (mise en miroir de bases de données) | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- parallel redo [SQL Server]
- role switching [SQL Server]
- database mirroring [SQL Server], queues
- failover [SQL Server], database mirroring
- redo [database mirroring]
- database mirroring [SQL Server], failover
ms.assetid: 586a6f25-672b-491b-bc2f-deab2ccda6e2
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 283c0dfad8d9f91693ab92ed415b4368dd3f0396
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87601653"
---
# <a name="estimate-the-interruption-of-service-during-role-switching-database-mirroring"></a><span data-ttu-id="afce9-102">Estimer l'interruption de service au cours d'un basculement de rôle (mise en miroir de bases de données)</span><span class="sxs-lookup"><span data-stu-id="afce9-102">Estimate the Interruption of Service During Role Switching (Database Mirroring)</span></span>
  <span data-ttu-id="afce9-103">Au cours d'un basculement de rôle, la durée pendant laquelle la mise en miroir de base de données sera hors service dépend du type de basculement de rôle et de la raison du changement de rôle.</span><span class="sxs-lookup"><span data-stu-id="afce9-103">During a role switch, the amount of time that database mirroring will be out of service depends on the type of role switching and the cause of the role switch.</span></span>

-   <span data-ttu-id="afce9-104">Pour un basculement automatique, deux facteurs influent sur la durée d'interruption de service : le temps requis pour que le serveur miroir reconnaisse que l'instance du serveur principal est défaillante, c'est-à-dire la durée de détection d'erreur, ainsi que le temps requis pour le basculement de la base de données, c'est-à-dire la durée de basculement.</span><span class="sxs-lookup"><span data-stu-id="afce9-104">For automatic failover, two factors contribute to the time service is interrupted: the time required for the mirror server to recognize that the principal server instance has failed, that is error detection, plus the time required to fail over the database, that is failover time.</span></span>

-   <span data-ttu-id="afce9-105">Pour une opération de service forcé, bien qu'une défaillance ait lieu, la détection de la défaillance et la réaction à cette dernière dépendent de la réactivité humaine.</span><span class="sxs-lookup"><span data-stu-id="afce9-105">For a forced-service operation, though a failure has occurred, detecting and responding to the failure depends on human responsiveness.</span></span> <span data-ttu-id="afce9-106">Toutefois, l'estimation de l'interruption potentielle de service se limite à l'estimation du temps requis pour que le serveur miroir bascule les rôles après l'exécution de la commande de service forcé.</span><span class="sxs-lookup"><span data-stu-id="afce9-106">However, estimating the potential interruption of service is limited to estimating the time for the mirror server to switch roles after the forced service command is issued.</span></span>

    > [!NOTE]
    >  <span data-ttu-id="afce9-107">Pour réduire le temps requis pour détecter des conditions spécifiques, telles que certains types d'erreurs, vous pouvez définir des alertes pour ces conditions.</span><span class="sxs-lookup"><span data-stu-id="afce9-107">To reduce the time required to detect specific conditions such as some types of errors, you can define alerts for those conditions.</span></span>

-   <span data-ttu-id="afce9-108">Pour un basculement manuel, seul le temps nécessaire au basculement de la base de données après la commande de basculement est pris en compte.</span><span class="sxs-lookup"><span data-stu-id="afce9-108">For a manual failover, only the time required to fail over the database after the failover command is issued.</span></span>

## <a name="error-detection"></a><span data-ttu-id="afce9-109">Détection d'erreurs</span><span class="sxs-lookup"><span data-stu-id="afce9-109">Error detection</span></span>
 <span data-ttu-id="afce9-110">Le temps nécessaire au système pour remarquer une erreur dépend du type d’erreur ; par exemple, une erreur réseau est détectée quasiment instantanément, alors que la détection d’un serveur qui ne répond pas prend 10 secondes (avec le délai d’attente par défaut).</span><span class="sxs-lookup"><span data-stu-id="afce9-110">The time for the system to notice an error depends on the type of error; for example, a network error is noticed almost instantly, while noticing a server that is not responding takes 10 seconds (with the default timeout).</span></span>

 <span data-ttu-id="afce9-111">Pour plus d’informations sur les erreurs susceptibles d’entraîner une défaillance lors d’une session de mise en miroir de bases de données et sur la détection du dépassement d’un délai d’attente en mode haute sécurité avec basculement automatique, consultez [Défaillances possibles pendant la mise en miroir d’une base de données](possible-failures-during-database-mirroring.md).</span><span class="sxs-lookup"><span data-stu-id="afce9-111">For information on errors that can cause a failure during a database mirroring session and timeout detection in high-safety mode with automatic failover, see [Possible Failures During Database Mirroring](possible-failures-during-database-mirroring.md)).</span></span>

## <a name="failover-time"></a><span data-ttu-id="afce9-112">Temps de basculement</span><span class="sxs-lookup"><span data-stu-id="afce9-112">Failover time</span></span>
 <span data-ttu-id="afce9-113">Le temps de basculement est principalement constitué du temps nécessaire au serveur miroir précédent pour restaurer par progression tout journal restant dans sa file d’attente de restauration par progression, plus un court temps supplémentaire. Pour plus d’informations sur la manière dont le serveur miroir traite les enregistrements de journal, consultez [Mise en miroir de base de données &#40;SQL Server&#41;](database-mirroring-sql-server.md)).</span><span class="sxs-lookup"><span data-stu-id="afce9-113">Failover time consists mainly of the time that the former mirror server requires to roll forward any log remaining in its redo queue, plus a short additional time (for more information about how the mirror server processes log records, see [Database Mirroring &#40;SQL Server&#41;](database-mirroring-sql-server.md)).</span></span> <span data-ttu-id="afce9-114">Pour plus d'informations sur l'estimation du temps de basculement, consultez la section Estimation du taux de restauration par progression du basculement, plus loin dans cette rubrique.</span><span class="sxs-lookup"><span data-stu-id="afce9-114">For information on estimating failover time, see Estimating Your Failover Redo Rate, later in this topic.</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="afce9-115">Si le basculement se produit au cours d'une transaction dans laquelle un index ou une table sont créés puis modifiés, le basculement peut prendre plus de temps qu'habituellement.</span><span class="sxs-lookup"><span data-stu-id="afce9-115">If failover occurs during a transaction in which an index or table is created and then changed, failover might take longer than usual.</span></span>  <span data-ttu-id="afce9-116">Par exemple, un basculement effectué au cours des opérations ci-dessous peut prendre plus de temps : BEGIN TRANSACTION, CREATE INDEX sur une table et SELECT INTO dans la table.</span><span class="sxs-lookup"><span data-stu-id="afce9-116">For example, failing over during the following series of operations might increase failover time:  BEGIN TRANSACTION, CREATE INDEX on a table, and SELECT INTO the table.</span></span> <span data-ttu-id="afce9-117">La possibilité d'augmentation de la durée de basculement au cours d'une telle transaction demeure jusqu'à ce que la transaction soit terminée par une instruction COMMIT TRANSACTION ou ROLLBACK TRANSACTION.</span><span class="sxs-lookup"><span data-stu-id="afce9-117">The possibility of increased failover time during such a transaction remains until it is completed with either a COMMIT TRANSACTION or ROLLBACK TRANSACTION statement.</span></span>

### <a name="the-redo-queue"></a><span data-ttu-id="afce9-118">File d'attente de restauration par progression</span><span class="sxs-lookup"><span data-stu-id="afce9-118">The Redo Queue</span></span>
 <span data-ttu-id="afce9-119">La restauration par progression de la base de données implique l'application de tous les enregistrements de journal figurant actuellement dans la file d'attente de restauration par progression sur le serveur miroir.</span><span class="sxs-lookup"><span data-stu-id="afce9-119">Rolling forward the database involves applying whatever log records are currently in the redo queue on the mirror server.</span></span> <span data-ttu-id="afce9-120">La *file d’attente de restauration par progression* est constituée des enregistrements de journal écrits sur le disque du serveur miroir, mais qui ne sont pas encore restaurés par progression dans la base de données miroir.</span><span class="sxs-lookup"><span data-stu-id="afce9-120">The *redo queue* consists of the log records that have been written to disk on the mirror server but not yet rolled forward on the mirror database.</span></span>

 <span data-ttu-id="afce9-121">Le temps de basculement de la base de données dépend de la rapidité avec laquelle le serveur miroir peut restaurer par progression le journal dans la file d'attente de restauration par progression qui est ensuite déterminé principalement par la configuration matérielle du système et par la charge de travail en cours.</span><span class="sxs-lookup"><span data-stu-id="afce9-121">Failover time for the database depends on how fast the mirror server can roll forward the log in the redo queue, which, in turn, is determined primarily by the system hardware and the current work load.</span></span> <span data-ttu-id="afce9-122">Il peut arriver qu'une base de données principale soit si occupée que le serveur principal envoie le journal au serveur miroir beaucoup plus rapidement que s'il restaurait le journal par progression.</span><span class="sxs-lookup"><span data-stu-id="afce9-122">Potentially, a principal database can become so busy that the principal server ships log to the mirror server much faster than it can roll the log forward.</span></span> <span data-ttu-id="afce9-123">Dans ce cas, le basculement peut durer un temps significatif pendant que le serveur miroir restaure par progression le journal dans la file d'attente de restauration par progression.</span><span class="sxs-lookup"><span data-stu-id="afce9-123">In this situation, failover might take significant time while the mirror server rolls forward the log in the redo queue.</span></span> <span data-ttu-id="afce9-124">Pour connaître la taille actuelle de la file d’attente de restauration par progression, utilisez le compteur **File d’attente de restauration par progression** de l’objet de performance de mise en miroir de bases de données.</span><span class="sxs-lookup"><span data-stu-id="afce9-124">To learn the current size of the redo queue, use the **Redo Queue** counter in the database mirroring performance object.</span></span> <span data-ttu-id="afce9-125">Pour plus d’informations, consultez [SQL Server, objet Database Mirroring](../../relational-databases/performance-monitor/sql-server-database-mirroring-object.md).</span><span class="sxs-lookup"><span data-stu-id="afce9-125">For more information, see [SQL Server, Database Mirroring Object](../../relational-databases/performance-monitor/sql-server-database-mirroring-object.md).</span></span>

### <a name="estimating-the-failover-redo-rate"></a><span data-ttu-id="afce9-126">Estimation du taux de restauration par progression du basculement</span><span class="sxs-lookup"><span data-stu-id="afce9-126">Estimating the Failover Redo Rate</span></span>
 <span data-ttu-id="afce9-127">Vous pouvez mesurer le temps nécessaire à la restauration par progression des enregistrements de journal (*vitesse de restauration par progression*) à l’aide d’une copie de test de la base de données de production.</span><span class="sxs-lookup"><span data-stu-id="afce9-127">You can measure the amount of time required to roll forward log records-the *redo rate*-by using a test copy of the production database.</span></span>

 <span data-ttu-id="afce9-128">La méthode permettant d'estimer la durée de la restauration par progression pendant le basculement dépend du nombre de threads utilisés par le serveur miroir pendant la phase de restauration par progression.</span><span class="sxs-lookup"><span data-stu-id="afce9-128">The method for estimating roll forward time during failover depends on the number of threads the mirror server uses during the redo phase.</span></span> <span data-ttu-id="afce9-129">Le nombre de threads dépend des éléments suivants :</span><span class="sxs-lookup"><span data-stu-id="afce9-129">The number of threads depends on the following:</span></span>

-   <span data-ttu-id="afce9-130">Dans [!INCLUDE[ssStandard](../../includes/ssstandard-md.md)], le serveur miroir utilise toujours un thread unique pour restaurer la base de données par progression.</span><span class="sxs-lookup"><span data-stu-id="afce9-130">In [!INCLUDE[ssStandard](../../includes/ssstandard-md.md)], the mirror server always uses a single thread to roll forward the database.</span></span>

-   <span data-ttu-id="afce9-131">Dans [!INCLUDE[ssEnterprise](../../includes/ssenterprise-md.md)], les serveurs miroirs des ordinateurs disposant de moins de cinq processeurs utilisent également un thread unique.</span><span class="sxs-lookup"><span data-stu-id="afce9-131">In [!INCLUDE[ssEnterprise](../../includes/ssenterprise-md.md)], mirror servers on computers with fewer than five CPUs also use only a single thread.</span></span> <span data-ttu-id="afce9-132">S’il dispose de cinq unités centrales ou davantage, un serveur miroir distribue ses opérations de restauration par progression entre les différents threads pendant un basculement (ceci porte le nom de *restauration par progression parallèle*).</span><span class="sxs-lookup"><span data-stu-id="afce9-132">With five or more CPUs, a mirror server distributes its roll forward operations among multiple threads during a failover (this is known as *parallel redo*).</span></span> <span data-ttu-id="afce9-133">La restauration par progression parallèle est optimisée pour utiliser un thread par groupe de quatre unités centrales.</span><span class="sxs-lookup"><span data-stu-id="afce9-133">Parallel redo is optimized to use one thread for every four CPUs.</span></span>

#### <a name="estimating-the-single-threaded-redo-rate"></a><span data-ttu-id="afce9-134">Estimation du taux de restauration par progression monothread</span><span class="sxs-lookup"><span data-stu-id="afce9-134">Estimating the Single-Threaded Redo Rate</span></span>
 <span data-ttu-id="afce9-135">Pour une restauration par progression monothread, la restauration par progression de la base de données miroir pendant le basculement prend environ le même temps que la restauration d'une sauvegarde du journal pour restaurer le même volume du journal.</span><span class="sxs-lookup"><span data-stu-id="afce9-135">For single-threaded redo, roll forward of the mirror database during failover takes approximately the same amount of time as a restore of a log backup takes to roll forward the same amount of log.</span></span> <span data-ttu-id="afce9-136">Pour estimer le temps de basculement, créez une base de données de test dans l'environnement dans lequel vous avez l'intention d'exécuter la mise en miroir.</span><span class="sxs-lookup"><span data-stu-id="afce9-136">To estimate failover time, create a test database in the environment under which you intend to run mirroring.</span></span> <span data-ttu-id="afce9-137">Ensuite, extrayez une sauvegarde de journal de la base de données de production.</span><span class="sxs-lookup"><span data-stu-id="afce9-137">Then take a log backup from the production database.</span></span> <span data-ttu-id="afce9-138">Pour mesurer le taux de restauration par progression de cette sauvegarde de journal, chronométrez le temps nécessaire à sa restauration avec l'instruction WITH NORECOVERY dans la base de données de test.</span><span class="sxs-lookup"><span data-stu-id="afce9-138">To measure the redo rate for that log backup, time how long it takes you to restore the log backup WITH NORECOVERY onto the test database.</span></span>

 <span data-ttu-id="afce9-139">Quand vous connaissez le taux de restauration par progression de votre serveur miroir, vous pouvez estimer le temps de basculement de la base de données à un moment donné en divisant le volume du journal en cours à restaurer par progression sur le serveur miroir (tel qu’il est mesuré par le compteur de performance **File d’attente de restauration par progression** ) par le taux de restauration par progression.</span><span class="sxs-lookup"><span data-stu-id="afce9-139">Once you know the redo rate of your mirror server, you can estimate the time to fail over the database at a given point in time by dividing the amount of current log to be redone on the mirror (as measured by the **Redo Queue** performance counter) by the redo rate.</span></span> <span data-ttu-id="afce9-140">Dans des conditions normales, si le serveur miroir peut suivre la charge du principal, **File d’attente de restauration par progression** a une valeur petite ou proche de zéro, et le basculement ne dure que quelques secondes.</span><span class="sxs-lookup"><span data-stu-id="afce9-140">Under normal conditions, if the mirror server can keep up with the load from the principal, the **Redo Queue** is small or close to zero, and a failover only takes a few seconds.</span></span>

#### <a name="estimating-the-parallel-redo-rate"></a><span data-ttu-id="afce9-141">Estimation du taux de restauration par progression parallèle</span><span class="sxs-lookup"><span data-stu-id="afce9-141">Estimating the Parallel Redo Rate</span></span>
 <span data-ttu-id="afce9-142">Dans [!INCLUDE[ssEnterprise](../../includes/ssenterprise-md.md)], la restauration par progression parallèle est optimisée pour utiliser un thread par groupe de quatre unités centrales.</span><span class="sxs-lookup"><span data-stu-id="afce9-142">In [!INCLUDE[ssEnterprise](../../includes/ssenterprise-md.md)], parallel redo is optimized to use one thread for every four CPUs.</span></span> <span data-ttu-id="afce9-143">Pour estimer plus précisément la durée de la restauration par progression parallèle, il est conseillé d'accéder à un système de test en cours d'exécution plutôt qu'à une base de données de test.</span><span class="sxs-lookup"><span data-stu-id="afce9-143">To estimate roll forward time for parallel redo, it is more accurate to access a running test system than a test database.</span></span> <span data-ttu-id="afce9-144">Tout en surveillant la file d'attente de restauration par progression sur le serveur miroir, augmentez la charge sur le serveur principal.</span><span class="sxs-lookup"><span data-stu-id="afce9-144">While monitoring the redo queue on the mirror server, increase the load on the principal server.</span></span> <span data-ttu-id="afce9-145">Lors d'un fonctionnement normal, la file d'attente de restauration par progression est proche de zéro.</span><span class="sxs-lookup"><span data-stu-id="afce9-145">In normal operation, the redo queue is close to zero.</span></span> <span data-ttu-id="afce9-146">Augmentez la charge sur le serveur principal jusqu’à ce que la file d’attente de restauration par progression commence à s’agrandir en continu ; le système est alors à son taux de restauration par progression maximal et le compteur de performance **Octets restaurés par progression/s** représente à ce stade le taux de restauration par progression maximal.</span><span class="sxs-lookup"><span data-stu-id="afce9-146">Increase the load on the principal server until the Redo Queue starts to grow continuously; the system is then at its maximum redo rate, and the **Redo Bytes/sec** performance counter at this point represents the maximum redo rate.</span></span> <span data-ttu-id="afce9-147">Pour plus d’informations, consultez [SQL Server, objet Database Mirroring](../../relational-databases/performance-monitor/sql-server-database-mirroring-object.md).</span><span class="sxs-lookup"><span data-stu-id="afce9-147">For more information, see [SQL Server, Database Mirroring Object](../../relational-databases/performance-monitor/sql-server-database-mirroring-object.md).</span></span>

## <a name="estimating-interruption-of-service-during-automatic-failover"></a><span data-ttu-id="afce9-148">Estimation de l'interruption de service au cours d'un basculement automatique</span><span class="sxs-lookup"><span data-stu-id="afce9-148">Estimating Interruption of Service During Automatic Failover</span></span>
 <span data-ttu-id="afce9-149">La figure suivante illustre la manière dont le temps de détection des erreurs et le temps de basculement contribuent à la durée totale nécessaire à l’exécution d’un basculement automatique sur **Partner_B**.</span><span class="sxs-lookup"><span data-stu-id="afce9-149">The following figure illustrates how error detection and failover time contribute to the overall time required for an automatic failover to complete on **Partner_B**.</span></span> <span data-ttu-id="afce9-150">Le basculement doit disposer d'un certain temps pour restaurer par progression la base de données (phase de restauration par progression) ainsi que d'un peu de temps pour mettre la base de données en ligne.</span><span class="sxs-lookup"><span data-stu-id="afce9-150">Failover requires time to roll forward the database (the redo phase) plus a small amount of time to bring the database online.</span></span> <span data-ttu-id="afce9-151">La phase de restauration par progression, qui implique la restauration de toute transaction non validée, se produit après la mise en ligne de la nouvelle base de données principale et se poursuit après le basculement.</span><span class="sxs-lookup"><span data-stu-id="afce9-151">The undo phase, which involves rolling back any uncommitted transactions, occurs after the new principal database goes online and continues after fail over.</span></span> <span data-ttu-id="afce9-152">La base de données est disponible pendant la phase de restauration.</span><span class="sxs-lookup"><span data-stu-id="afce9-152">The database is available during the undo phase.</span></span>

 <span data-ttu-id="afce9-153">![Détection d’erreur et temps de basculement](../media/dbm-failovauto-time.gif "Détection d’erreur et temps de basculement")</span><span class="sxs-lookup"><span data-stu-id="afce9-153">![Error detection and failover time](../media/dbm-failovauto-time.gif "Error detection and failover time")</span></span>

## <a name="see-also"></a><span data-ttu-id="afce9-154">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="afce9-154">See Also</span></span>
 <span data-ttu-id="afce9-155">Basculement du rôle [de mode de fonctionnement de mise en miroir de bases](database-mirroring-operating-modes.md) de données [au cours d’une session de mise en miroir de bases de données &#40;SQL Server&#41;](role-switching-during-a-database-mirroring-session-sql-server.md) [surveillance de la mise SQL Server &#40;en miroir](monitoring-database-mirroring-sql-server.md)</span><span class="sxs-lookup"><span data-stu-id="afce9-155">[Database Mirroring Operating Modes](database-mirroring-operating-modes.md) [Role Switching During a Database Mirroring Session &#40;SQL Server&#41;](role-switching-during-a-database-mirroring-session-sql-server.md) [Monitoring Database Mirroring &#40;SQL Server&#41;](monitoring-database-mirroring-sql-server.md)</span></span>


