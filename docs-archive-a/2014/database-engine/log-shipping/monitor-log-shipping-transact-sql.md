---
title: Surveiller la copie des journaux de transaction (Transact-SQL) | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- log shipping [SQL Server], status
- history tables [SQL Server]
- historical information [SQL Server], log shipping
- log shipping [SQL Server], monitoring
- alerts [SQL Server], log shipping
- status information [SQL Server], log shipping
- monitoring log shipping [SQL Server]
ms.assetid: acf3cd99-55f7-4287-8414-0892f830f423
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 0ab87d5d8aa08b7b2860fe52fd097f33af327a94
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87602984"
---
# <a name="monitor-log-shipping-transact-sql"></a><span data-ttu-id="c8f3e-102">Surveiller la copie des journaux de transaction (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="c8f3e-102">Monitor Log Shipping (Transact-SQL)</span></span>
  <span data-ttu-id="c8f3e-103">Une fois l'envoi de journaux configuré, vous pouvez contrôler les informations d'état de l'ensemble des serveurs d'envoi de journaux.</span><span class="sxs-lookup"><span data-stu-id="c8f3e-103">After you have configured log shipping, you can monitor information about the status of all the log shipping servers.</span></span> <span data-ttu-id="c8f3e-104">L'historique et l'état des opérations d'envoi de journaux sont toujours enregistrés localement par les travaux d'envoi de journaux.</span><span class="sxs-lookup"><span data-stu-id="c8f3e-104">The history and status of log shipping operations are always saved locally by the log shipping jobs.</span></span> <span data-ttu-id="c8f3e-105">L'historique et l'état de l'opération de sauvegarde sont stockés sur le serveur principal, tandis que l'historique et l'état des opérations de copie et de restauration sont stockés sur le serveur secondaire.</span><span class="sxs-lookup"><span data-stu-id="c8f3e-105">The history and status of the backup operation are stored at the primary server, and the history and status of the copy and restore operations are stored at the secondary server.</span></span> <span data-ttu-id="c8f3e-106">Si vous avez implémenté un serveur moniteur distant, ces informations sont également stockées sur le serveur moniteur.</span><span class="sxs-lookup"><span data-stu-id="c8f3e-106">If you have implemented a remote monitor server, this information is also stored on the monitor server.</span></span>  
  
 <span data-ttu-id="c8f3e-107">Vous pouvez définir des alertes qui se déclenchent si les opérations d'envoi de journaux ne sont pas exécutées conformément à la planification.</span><span class="sxs-lookup"><span data-stu-id="c8f3e-107">You can configure alerts that will fire if log shipping operations fail to occur as scheduled.</span></span> <span data-ttu-id="c8f3e-108">Les erreurs sont signalées par un travail d'alerte qui surveille l'état des opérations de sauvegarde et de restauration.</span><span class="sxs-lookup"><span data-stu-id="c8f3e-108">Errors are raised by an alert job that watches the status of the backup and restore operations.</span></span> <span data-ttu-id="c8f3e-109">Vous pouvez définir des alertes qui indiquent à l'opérateur l'occurrence de ces erreurs.</span><span class="sxs-lookup"><span data-stu-id="c8f3e-109">You can define alerts that notify an operator when these errors are raised.</span></span> <span data-ttu-id="c8f3e-110">Si un serveur moniteur est configuré, un travail d'alerte s'exécute sur le serveur moniteur qui signale les erreurs de toutes les opérations dans la configuration d'envoi des journaux.</span><span class="sxs-lookup"><span data-stu-id="c8f3e-110">If a monitor server is configured, one alert job runs on the monitor server that raises errors for all operations in the log shipping configuration.</span></span> <span data-ttu-id="c8f3e-111">Si aucun serveur moniteur n'est défini, un travail d'alerte s'exécute sur l'instance du serveur principal qui surveille la sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="c8f3e-111">If a monitor server is not specified, an alert job runs on the primary server instance, which monitors the backup operation.</span></span> <span data-ttu-id="c8f3e-112">Si aucun serveur moniteur n'est défini, un travail d'alerte s'exécute également sur chaque instance de serveur secondaire pour surveiller les opérations de copie et de restauration.</span><span class="sxs-lookup"><span data-stu-id="c8f3e-112">If a monitor server is not specified, an alert job also runs on each secondary server instance to monitor the local copy and restore operations.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="c8f3e-113">Pour analyser une configuration d'envoi de journaux, vous devez ajouter le serveur moniteur lorsque vous activez l'envoi de journaux.</span><span class="sxs-lookup"><span data-stu-id="c8f3e-113">To monitor a log shipping configuration, you must add the monitor server when you enable log shipping.</span></span> <span data-ttu-id="c8f3e-114">Si vous ajoutez un serveur moniteur ultérieurement, vous devez supprimer la configuration d'envoi de journaux, puis la remplacer par une nouvelle configuration qui inclut un serveur moniteur.</span><span class="sxs-lookup"><span data-stu-id="c8f3e-114">If you add a monitor server later, you must remove the log shipping configuration and then replace it with a new configuration that includes a monitor server.</span></span> <span data-ttu-id="c8f3e-115">Pour plus d’informations, consultez [Configurer la copie des journaux de transaction &#40;Transact-SQL&#41;](configure-log-shipping-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="c8f3e-115">For more information, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span> <span data-ttu-id="c8f3e-116">Qui plus est, une fois le serveur moniteur configuré, il ne peut pas être modifié sans que l'envoi de journaux ne soit auparavant supprimé.</span><span class="sxs-lookup"><span data-stu-id="c8f3e-116">Furthermore, after the monitor server has been configured, it cannot be changed without removing log shipping first.</span></span>  
  
## <a name="history-tables-containing-monitoring-information"></a><span data-ttu-id="c8f3e-117">Tables d'historique contenant les informations d'analyse</span><span class="sxs-lookup"><span data-stu-id="c8f3e-117">History Tables Containing Monitoring Information</span></span>  
 <span data-ttu-id="c8f3e-118">Les tables d'historique d'analyse contiennent des métadonnées stockées sur le serveur moniteur.</span><span class="sxs-lookup"><span data-stu-id="c8f3e-118">The monitoring history tables contain metadata that is stored on the monitor server.</span></span> <span data-ttu-id="c8f3e-119">Une copie des informations spécifiques à un serveur principal ou secondaire est également stockée localement.</span><span class="sxs-lookup"><span data-stu-id="c8f3e-119">A copy of information specific to a given primary or secondary server is also stored locally.</span></span>  
  
 <span data-ttu-id="c8f3e-120">Vous pouvez interroger ces tables pour contrôler l'état d'une session d'envoi de journaux.</span><span class="sxs-lookup"><span data-stu-id="c8f3e-120">You can query these tables to monitor the status of a log shipping session.</span></span> <span data-ttu-id="c8f3e-121">Pour connaître l'état de l'envoi des journaux, par exemple, vérifiez l'état et l'historique du travail de sauvegarde, du travail de copie et du travail de restauration.</span><span class="sxs-lookup"><span data-stu-id="c8f3e-121">For example, to learn status of log shipping, check the status and history of the backup job, copy job, and restore job.</span></span> <span data-ttu-id="c8f3e-122">Vous pouvez afficher un historique d'envoi de journaux et des informations d'erreur spécifiques en interrogeant les tables d'analyse.</span><span class="sxs-lookup"><span data-stu-id="c8f3e-122">You can view specific log shipping history and error details by querying the following monitoring tables.</span></span>  
  
|<span data-ttu-id="c8f3e-123">Table de charge de travail</span><span class="sxs-lookup"><span data-stu-id="c8f3e-123">Table</span></span>|<span data-ttu-id="c8f3e-124">Description</span><span class="sxs-lookup"><span data-stu-id="c8f3e-124">Description</span></span>|  
|-----------|-----------------|  
|[<span data-ttu-id="c8f3e-125">log_shipping_monitor_alert</span><span class="sxs-lookup"><span data-stu-id="c8f3e-125">log_shipping_monitor_alert</span></span>](/sql/relational-databases/system-tables/log-shipping-monitor-alert-transact-sql)|<span data-ttu-id="c8f3e-126">Contient l'ID du travail d'alerte.</span><span class="sxs-lookup"><span data-stu-id="c8f3e-126">Stores alert job ID.</span></span>|  
|[<span data-ttu-id="c8f3e-127">log_shipping_monitor_error_detail</span><span class="sxs-lookup"><span data-stu-id="c8f3e-127">log_shipping_monitor_error_detail</span></span>](/sql/relational-databases/system-tables/log-shipping-monitor-error-detail-transact-sql)|<span data-ttu-id="c8f3e-128">Contient les informations d'erreur des travaux d'envoi des journaux.</span><span class="sxs-lookup"><span data-stu-id="c8f3e-128">Stores error details for log shipping jobs.</span></span> <span data-ttu-id="c8f3e-129">Vous pouvez interroger cette table pour identifier les erreurs d'une session d'agent.</span><span class="sxs-lookup"><span data-stu-id="c8f3e-129">You can query this table see the errors for an agent session.</span></span> <span data-ttu-id="c8f3e-130">Vous pouvez également trier les erreurs en fonction de leurs date et heure d'enregistrement.</span><span class="sxs-lookup"><span data-stu-id="c8f3e-130">Optionally, you can sort the errors by the date and time at which each was logged.</span></span> <span data-ttu-id="c8f3e-131">Chaque erreur est consignée sous la forme d'une séquence d'exceptions, et plusieurs erreurs (séquences) peuvent être consignées pour chaque session d'agent.</span><span class="sxs-lookup"><span data-stu-id="c8f3e-131">Each error is logged as a sequence of exceptions, and multiple errors (sequences) can per agent session.</span></span>|  
|[<span data-ttu-id="c8f3e-132">log_shipping_monitor_history_detail</span><span class="sxs-lookup"><span data-stu-id="c8f3e-132">log_shipping_monitor_history_detail</span></span>](/sql/relational-databases/system-tables/log-shipping-monitor-history-detail-transact-sql)|<span data-ttu-id="c8f3e-133">Contient l'historique des agents d'envoi de journaux.</span><span class="sxs-lookup"><span data-stu-id="c8f3e-133">Contains history details for log shipping agents.</span></span> <span data-ttu-id="c8f3e-134">Vous pouvez interroger cette table pour consulter l'historique d'une session d'agent.</span><span class="sxs-lookup"><span data-stu-id="c8f3e-134">You can query this table to see the history detail for an agent session.</span></span>|  
|[<span data-ttu-id="c8f3e-135">log_shipping_monitor_primary</span><span class="sxs-lookup"><span data-stu-id="c8f3e-135">log_shipping_monitor_primary</span></span>](/sql/relational-databases/system-tables/log-shipping-monitor-primary-transact-sql)|<span data-ttu-id="c8f3e-136">Contient un enregistrement d'analyse pour la base de données principale dans chaque configuration d'envoi de journaux, y compris des informations sur le dernier fichier de sauvegarde et le dernier fichier restauré, qui sont utiles pour l'analyse.</span><span class="sxs-lookup"><span data-stu-id="c8f3e-136">Stores one monitor record for the primary database in each log shipping configuration, including information about the last backup file and last restored file that is useful for monitoring.</span></span>|  
|[<span data-ttu-id="c8f3e-137">log_shipping_monitor_secondary</span><span class="sxs-lookup"><span data-stu-id="c8f3e-137">log_shipping_monitor_secondary</span></span>](/sql/relational-databases/system-tables/log-shipping-monitor-secondary-transact-sql)|<span data-ttu-id="c8f3e-138">Contient un enregistrement d'analyse pour chaque base de données secondaire, y compris des informations sur le dernier fichier de sauvegarde et le dernier fichier restauré, qui sont utiles pour l'analyse.</span><span class="sxs-lookup"><span data-stu-id="c8f3e-138">Stores one monitor record for each secondary database, including information about the last backup file and last restored file that is useful for monitoring.</span></span>|  
  
## <a name="stored-procedures-for-monitoring-log-shipping"></a><span data-ttu-id="c8f3e-139">Procédures stockées pour l'analyse de l'envoi des journaux</span><span class="sxs-lookup"><span data-stu-id="c8f3e-139">Stored Procedures for Monitoring Log Shipping</span></span>  
 <span data-ttu-id="c8f3e-140">Les informations d’analyse et d’historique sont stockées dans des tables dans **msdb**, accessibles à l’aide de procédures stockées d’envoi de journaux.</span><span class="sxs-lookup"><span data-stu-id="c8f3e-140">Monitoring and history information is stored in tables in **msdb**, which can be accessed using log shipping stored procedures.</span></span> <span data-ttu-id="c8f3e-141">Exécutez les procédures stockées suivantes sur les serveurs indiqués dans le tableau ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="c8f3e-141">Run these stored procedures on the servers indicated in the following table.</span></span>  
  
|<span data-ttu-id="c8f3e-142">Procédure stockée</span><span class="sxs-lookup"><span data-stu-id="c8f3e-142">Stored procedure</span></span>|<span data-ttu-id="c8f3e-143">Description</span><span class="sxs-lookup"><span data-stu-id="c8f3e-143">Description</span></span>|<span data-ttu-id="c8f3e-144">Serveur concerné</span><span class="sxs-lookup"><span data-stu-id="c8f3e-144">Run this procedure on</span></span>|  
|----------------------|-----------------|---------------------------|  
|[<span data-ttu-id="c8f3e-145">sp_help_log_shipping_monitor_primary</span><span class="sxs-lookup"><span data-stu-id="c8f3e-145">sp_help_log_shipping_monitor_primary</span></span>](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-monitor-primary-transact-sql)|<span data-ttu-id="c8f3e-146">Retourne les enregistrements d’analyse de la base de données primaire spécifiée, à partir de la table **log_shipping_monitor_primary** .</span><span class="sxs-lookup"><span data-stu-id="c8f3e-146">Returns monitor records for the specified primary database from the **log_shipping_monitor_primary** table.</span></span>|<span data-ttu-id="c8f3e-147">Serveur moniteur ou serveur principal</span><span class="sxs-lookup"><span data-stu-id="c8f3e-147">Monitor server or primary server</span></span>|  
|[<span data-ttu-id="c8f3e-148">sp_help_log_shipping_monitor_secondary</span><span class="sxs-lookup"><span data-stu-id="c8f3e-148">sp_help_log_shipping_monitor_secondary</span></span>](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-monitor-secondary-transact-sql)|<span data-ttu-id="c8f3e-149">Retourne les enregistrements d’analyse de la base de données secondaire définie depuis la table **log_shipping_monitor_secondary** .</span><span class="sxs-lookup"><span data-stu-id="c8f3e-149">Returns monitor records for the specified secondary database from the **log_shipping_monitor_secondary** table.</span></span>|<span data-ttu-id="c8f3e-150">Serveur moniteur ou serveur secondaire</span><span class="sxs-lookup"><span data-stu-id="c8f3e-150">Monitor server or secondary server</span></span>|  
|[<span data-ttu-id="c8f3e-151">sp_help_log_shipping_alert_job</span><span class="sxs-lookup"><span data-stu-id="c8f3e-151">sp_help_log_shipping_alert_job</span></span>](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-alert-job-transact-sql)|<span data-ttu-id="c8f3e-152">Retourne l'ID du travail d'alerte.</span><span class="sxs-lookup"><span data-stu-id="c8f3e-152">Returns the job ID of the alert job.</span></span>|<span data-ttu-id="c8f3e-153">Serveur moniteur, serveur principal ou serveur secondaire si aucune surveillance n'est définie</span><span class="sxs-lookup"><span data-stu-id="c8f3e-153">Monitor server, or primary or secondary server if no monitor is defined</span></span>|  
|[<span data-ttu-id="c8f3e-154">sp_help_log_shipping_primary_database</span><span class="sxs-lookup"><span data-stu-id="c8f3e-154">sp_help_log_shipping_primary_database</span></span>](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-primary-database-transact-sql)|<span data-ttu-id="c8f3e-155">Extrait les paramètres de la base de données primaire et affiche les valeurs des tables **log_shipping_primary_databases** et **log_shipping_monitor_primary** .</span><span class="sxs-lookup"><span data-stu-id="c8f3e-155">Retrieves primary database settings and displays the values from the **log_shipping_primary_databases** and **log_shipping_monitor_primary** tables.</span></span>|<span data-ttu-id="c8f3e-156">Serveur principal</span><span class="sxs-lookup"><span data-stu-id="c8f3e-156">Primary server</span></span>|  
|[<span data-ttu-id="c8f3e-157">sp_help_log_shipping_primary_secondary</span><span class="sxs-lookup"><span data-stu-id="c8f3e-157">sp_help_log_shipping_primary_secondary</span></span>](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-primary-secondary-transact-sql)|<span data-ttu-id="c8f3e-158">Extrait les noms des bases de données secondaires d'une base de données principale.</span><span class="sxs-lookup"><span data-stu-id="c8f3e-158">Retrieves secondary database names for a primary database.</span></span>|<span data-ttu-id="c8f3e-159">Serveur principal</span><span class="sxs-lookup"><span data-stu-id="c8f3e-159">Primary server</span></span>|  
|[<span data-ttu-id="c8f3e-160">sp_help_log_shipping_secondary_database</span><span class="sxs-lookup"><span data-stu-id="c8f3e-160">sp_help_log_shipping_secondary_database</span></span>](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-secondary-database-transact-sql)|<span data-ttu-id="c8f3e-161">Extrait les paramètres des bases de données secondaires depuis les tables **log_shipping_secondary**, **log_shipping_secondary_databases** et **log_shipping_monitor_secondary** tables.</span><span class="sxs-lookup"><span data-stu-id="c8f3e-161">Retrieves secondary-database settings from the **log_shipping_secondary**, **log_shipping_secondary_databases** and **log_shipping_monitor_secondary** tables.</span></span>|<span data-ttu-id="c8f3e-162">Serveur secondaire</span><span class="sxs-lookup"><span data-stu-id="c8f3e-162">Secondary server</span></span>|  
|[<span data-ttu-id="c8f3e-163">sp_help_log_shipping_secondary_primary &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="c8f3e-163">sp_help_log_shipping_secondary_primary &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-secondary-primary-transact-sql)|<span data-ttu-id="c8f3e-164">Cette procédure stockée récupère les paramètres d'une base de données primaire donnée sur le serveur secondaire.</span><span class="sxs-lookup"><span data-stu-id="c8f3e-164">This stored procedure retrieves the settings for a given primary database on the secondary server.</span></span>|<span data-ttu-id="c8f3e-165">Serveur secondaire</span><span class="sxs-lookup"><span data-stu-id="c8f3e-165">Secondary server</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="c8f3e-166">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="c8f3e-166">See Also</span></span>  
 <span data-ttu-id="c8f3e-167">[Afficher le rapport de la copie des journaux de transaction &#40;SQL Server Management Studio&#41;](view-the-log-shipping-report-sql-server-management-studio.md) </span><span class="sxs-lookup"><span data-stu-id="c8f3e-167">[View the Log Shipping Report &#40;SQL Server Management Studio&#41;](view-the-log-shipping-report-sql-server-management-studio.md) </span></span>  
 [<span data-ttu-id="c8f3e-168">Tables et procédures stockées de copie des journaux de transaction</span><span class="sxs-lookup"><span data-stu-id="c8f3e-168">Log Shipping Stored Procedures and Tables</span></span>](log-shipping-tables-and-stored-procedures.md)  
  
  
