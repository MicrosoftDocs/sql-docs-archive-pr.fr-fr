---
title: Mise à niveau de la copie des journaux de transaction vers SQL Server 2014 (Transact-SQL) | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- log shipping [SQL Server], upgrading
ms.assetid: b1289cc3-f5be-40bb-8801-0e3eed40336e
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 80330d03853c984cfd26100b02918eb218705085
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87614782"
---
# <a name="upgrade-log-shipping-to-sql-server-2014-transact-sql"></a><span data-ttu-id="a79dc-102">Mettre à niveau la copie des journaux de transaction vers SQL Server 2014 (Transact-SQL)</span><span class="sxs-lookup"><span data-stu-id="a79dc-102">Upgrade Log Shipping to SQL Server 2014 (Transact-SQL)</span></span>
  <span data-ttu-id="a79dc-103">Il est possible de conserver les configurations de copie des journaux de transaction lors d'une mise à niveau de [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)], [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)], [!INCLUDE[ssKilimanjaro](../../includes/sskilimanjaro-md.md)], ou [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] vers [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span><span class="sxs-lookup"><span data-stu-id="a79dc-103">It is possible to preserve log shipping configurations when upgrading from [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)], [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)], [!INCLUDE[ssKilimanjaro](../../includes/sskilimanjaro-md.md)], or [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span></span> <span data-ttu-id="a79dc-104">Cette rubrique décrit les scénarios et les méthodes conseillées pour la mise à niveau d'une configuration de la copie des journaux de transaction.</span><span class="sxs-lookup"><span data-stu-id="a79dc-104">This topic describes alternative scenarios and best practices for upgrading a log shipping configuration.</span></span>

> [!NOTE]
>  <span data-ttu-id="a79dc-105">[La compression de la sauvegarde](../../relational-databases/backup-restore/backup-compression-sql-server.md) a été introduite dans [!INCLUDE[ssEnterpriseEd10](../../includes/ssenterpriseed10-md.md)].</span><span class="sxs-lookup"><span data-stu-id="a79dc-105">[Backup compression](../../relational-databases/backup-restore/backup-compression-sql-server.md) was introduced in [!INCLUDE[ssEnterpriseEd10](../../includes/ssenterpriseed10-md.md)].</span></span> <span data-ttu-id="a79dc-106">Une configuration mise à niveau de copie des journaux de transaction utilise l’option de configuration du niveau serveur par défaut pour la **compression de sauvegarde** pour contrôler si la compression de la sauvegarde est utilisée pour les fichiers de sauvegarde du journal des transactions.</span><span class="sxs-lookup"><span data-stu-id="a79dc-106">An upgraded log shipping configuration uses the **backup compression default** server-level configuration option to control whether backup compression is used for the transaction log backup files.</span></span> <span data-ttu-id="a79dc-107">Le comportement de la compression de la sauvegarde des sauvegardes de fichiers journaux peut être spécifié pour chaque configuration de la copie des journaux de transaction.</span><span class="sxs-lookup"><span data-stu-id="a79dc-107">The backup compression behavior of log backups can be specified for each log shipping configuration.</span></span> <span data-ttu-id="a79dc-108">Pour plus d’informations, consultez [Configurer la copie des journaux de transaction &#40;Transact-SQL&#41;](configure-log-shipping-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="a79dc-108">For more information, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span>


##  <a name="protect-your-data-before-the-upgrade"></a><a name="ProtectData"></a> <span data-ttu-id="a79dc-109">Protéger vos données avant la mise à niveau</span><span class="sxs-lookup"><span data-stu-id="a79dc-109">Protect Your Data Before the Upgrade</span></span>
 <span data-ttu-id="a79dc-110">Comme méthode conseillée, nous vous recommandons de protéger vos données avant une mise à niveau de la copie des journaux de transaction.</span><span class="sxs-lookup"><span data-stu-id="a79dc-110">As a best practice, we recommend that you protect your data before a log shipping upgrade.</span></span>

 <span data-ttu-id="a79dc-111">**Pour protéger vos données**</span><span class="sxs-lookup"><span data-stu-id="a79dc-111">**To protect your data**</span></span>

1.  <span data-ttu-id="a79dc-112">Effectuez une sauvegarde complète de chaque base de données primaire.</span><span class="sxs-lookup"><span data-stu-id="a79dc-112">Perform a full database backup on every primary database.</span></span>

     <span data-ttu-id="a79dc-113">Pour plus d’informations, consultez [Créer une sauvegarde complète de base de données &#40;SQL Server&#41;](../../relational-databases/backup-restore/create-a-full-database-backup-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="a79dc-113">For more information, see [Create a Full Database Backup &#40;SQL Server&#41;](../../relational-databases/backup-restore/create-a-full-database-backup-sql-server.md).</span></span>

2.  <span data-ttu-id="a79dc-114">Exécutez la commande [DBCC CHECKDB](/sql/t-sql/database-console-commands/dbcc-checkdb-transact-sql) sur chaque base de données primaire.</span><span class="sxs-lookup"><span data-stu-id="a79dc-114">Run the [DBCC CHECKDB](/sql/t-sql/database-console-commands/dbcc-checkdb-transact-sql) command on every primary database.</span></span>

##  <a name="upgrading-the-monitor-server-instance"></a><a name="UpgradeMonitor"></a><span data-ttu-id="a79dc-115">Mise à niveau de l’instance du serveur moniteur</span><span class="sxs-lookup"><span data-stu-id="a79dc-115">Upgrading the Monitor Server Instance</span></span>
 <span data-ttu-id="a79dc-116">L'instance du serveur moniteur, si elle existe, peut être mise à niveau à tout moment.</span><span class="sxs-lookup"><span data-stu-id="a79dc-116">The monitor server instance, if any, can be upgraded at any time.</span></span>

 <span data-ttu-id="a79dc-117">Pendant que le serveur moniteur est mis à niveau, la configuration de la copie des journaux de transaction continue à fonctionner, mais son état n'est pas enregistré dans les tables sur le moniteur.</span><span class="sxs-lookup"><span data-stu-id="a79dc-117">While the monitor server is being upgraded, the log shipping configuration continues to work, but its status is not recorded in the tables on the monitor.</span></span> <span data-ttu-id="a79dc-118">Les alertes qui ont été configurées ne sont pas déclenchées tant que le serveur moniteur est en cours de mise à niveau.</span><span class="sxs-lookup"><span data-stu-id="a79dc-118">Any alerts that have been configured will not be triggered while the monitor server is being upgraded.</span></span> <span data-ttu-id="a79dc-119">Après la mise à niveau, vous pouvez mettre à jour les informations dans les tables du moniteur en exécutant la procédure stockée système [sp_refresh_log_shipping_monitor](/sql/relational-databases/system-stored-procedures/sp-refresh-log-shipping-monitor-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a79dc-119">After the upgrade, you can update the information in the monitor tables by executing the [sp_refresh_log_shipping_monitor](/sql/relational-databases/system-stored-procedures/sp-refresh-log-shipping-monitor-transact-sql) system stored procedure.</span></span>

##  <a name="upgrading-log-shipping-configurations-with-a-single-secondary-server"></a><a name="UpgradeSingleSecondary"></a><span data-ttu-id="a79dc-120">Mise à niveau des configurations de copie des journaux de route avec un seul serveur secondaire</span><span class="sxs-lookup"><span data-stu-id="a79dc-120">Upgrading Log Shipping Configurations with a Single Secondary Server</span></span>
 <span data-ttu-id="a79dc-121">Le processus de mise à niveau décrit dans cette section présume une configuration composée du serveur principal et d'un seul serveur secondaire.</span><span class="sxs-lookup"><span data-stu-id="a79dc-121">The upgrade process described in this section assumes a configuration consisting of the primary server and only one secondary server.</span></span> <span data-ttu-id="a79dc-122">La figure ci-après illustre cette configuration, avec une instance du serveur principal, A, et une seule instance du serveur secondaire, B.</span><span class="sxs-lookup"><span data-stu-id="a79dc-122">This configuration is represented in the following illustration, which shows a primary server instance, A, and a single secondary server instance, B.</span></span>

 <span data-ttu-id="a79dc-123">![Un serveur secondaire et aucun serveur moniteur](../media/ls-2-wayconfig-nomonitor.gif "Un serveur secondaire et aucun serveur moniteur")</span><span class="sxs-lookup"><span data-stu-id="a79dc-123">![One secondary server and no monitor server](../media/ls-2-wayconfig-nomonitor.gif "One secondary server and no monitor server")</span></span>

 <span data-ttu-id="a79dc-124">Pour plus d'informations sur la mise à niveau de plusieurs serveurs secondaires, consultez [Mise à niveau de plusieurs instances du serveur secondaire](#MultipleSecondaries), plus loin dans cette rubrique.</span><span class="sxs-lookup"><span data-stu-id="a79dc-124">For information about upgrading multiple secondary servers, see [Upgrading Multiple Secondary Server Instances](#MultipleSecondaries), later in this topic.</span></span>
 

###  <a name="upgrading-the-secondary-server-instance"></a><a name="UpgradeSecondary"></a><span data-ttu-id="a79dc-125">Mise à niveau de l’instance de serveur secondaire</span><span class="sxs-lookup"><span data-stu-id="a79dc-125">Upgrading the Secondary Server Instance</span></span>
 <span data-ttu-id="a79dc-126">Le processus de mise à niveau implique la mise à niveau des instances de serveur secondaire d'une configuration [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] (ou une version supérieure) de copie des journaux de transaction vers [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] avant la mise à niveau de l'instance du serveur principal.</span><span class="sxs-lookup"><span data-stu-id="a79dc-126">The upgrade process involves upgrading the secondary server instances of a [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] or higher log shipping configuration to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] before upgrading the primary server instance.</span></span> <span data-ttu-id="a79dc-127">Mettez toujours à niveau l'instance du serveur secondaire en premier.</span><span class="sxs-lookup"><span data-stu-id="a79dc-127">Always upgrade the secondary server instance first.</span></span> <span data-ttu-id="a79dc-128">Si le serveur principal a été mis à niveau avant un serveur secondaire, la copie des journaux de transaction échoue parce qu'une sauvegarde créée sur une version plus récente de [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] ne peut pas être restaurée sur une version antérieure de [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="a79dc-128">If the primary server were upgraded before a secondary server, log shipping would fail because a backup created on a newer version of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] cannot be restored on an older version of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span>

 <span data-ttu-id="a79dc-129">La copie des journaux de transaction se poursuit durant le processus de mise à niveau parce que les serveurs secondaires mis à niveau continuent à restaurer les sauvegardes des journaux à partir du serveur principal [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] (ou une version supérieure).</span><span class="sxs-lookup"><span data-stu-id="a79dc-129">Log shipping continues throughout the upgrade process because the upgraded secondary servers continue to restore the log backups from the [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] or higher primary server.</span></span> <span data-ttu-id="a79dc-130">Le processus de mise à niveau des instances de serveur secondaire dépend en partie du fait que la configuration de la copie des journaux de transaction possède ou non plusieurs serveurs secondaires.</span><span class="sxs-lookup"><span data-stu-id="a79dc-130">The process for upgrading the secondary server instances depends partly on whether the log shipping configuration possesses multiple secondary servers.</span></span> <span data-ttu-id="a79dc-131">Pour plus d'informations, consultez [Mise à niveau de plusieurs instances du serveur secondaire](#MultipleSecondaries), plus loin dans cette rubrique.</span><span class="sxs-lookup"><span data-stu-id="a79dc-131">For more information, see [Upgrading Multiple Secondary Server Instances](#MultipleSecondaries), later in this topic.</span></span>

 <span data-ttu-id="a79dc-132">Pendant que l'instance de serveur secondaire est mise à niveau, les travaux de copie et de restauration de la copie des journaux de transaction ne s'exécutent pas, de telle sorte que les sauvegardes des journaux des transactions non restaurées s'accumulent.</span><span class="sxs-lookup"><span data-stu-id="a79dc-132">While the secondary server instance is being upgraded, the log shipping copy and restore jobs do not run, so unrestored transaction log backups will accumulate.</span></span> <span data-ttu-id="a79dc-133">La quantité accumulée dépend de la fréquence de la sauvegarde planifiée sur le serveur principal.</span><span class="sxs-lookup"><span data-stu-id="a79dc-133">The amount of accumulation depends on the frequency of scheduled backup on the primary server.</span></span> <span data-ttu-id="a79dc-134">De même, si un serveur moniteur séparé a été configuré, il se peut que des alertes soient déclenchées et indiquent que les restaurations n'ont pas été effectuées sur une durée supérieure à l'intervalle configuré.</span><span class="sxs-lookup"><span data-stu-id="a79dc-134">Also, if a separate monitor server has been configured, alerts might be raised indicating restores have not been performed for longer than the configured interval.</span></span>

 <span data-ttu-id="a79dc-135">Une fois que le serveur secondaire a été mis à niveau, les travaux des agents de la copie des journaux de transaction reprennent et poursuivent la copie et la restauration des sauvegardes de journaux à partir de l'instance du serveur principal, le serveur A. La durée requise pour que le serveur secondaire mette la base de données secondaire à jour varie, selon le temps nécessaire pour mettre à niveau le serveur secondaire et la fréquence des sauvegardes sur le serveur principal.</span><span class="sxs-lookup"><span data-stu-id="a79dc-135">Once the secondary server has been upgraded, the log shipping agents jobs resume and continue to copy and restore log backups from the primary server instance, server A. The amount of time required for the secondary server to bring the secondary database up to date varies, depending on the time taken to upgrade the secondary server and the frequency of the backups on the primary server.</span></span>

> [!NOTE]
>  <span data-ttu-id="a79dc-136">Pendant la mise à niveau du serveur, la base de données secondaire n'est pas mise à niveau vers une base de données [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="a79dc-136">During the server upgrade, the secondary database is not upgraded to a [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] database.</span></span> <span data-ttu-id="a79dc-137">Elle ne sera mise à niveau que si elle est placée en ligne.</span><span class="sxs-lookup"><span data-stu-id="a79dc-137">It will get upgraded only if it is brought online.</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="a79dc-138">L'option RESTORE WITH STANDBY n'est pas prise en charge pour une base de données qui requiert une mise à niveau.</span><span class="sxs-lookup"><span data-stu-id="a79dc-138">The RESTORE WITH STANDBY option is not supported for a database that requires upgrading.</span></span> <span data-ttu-id="a79dc-139">Si une base de données secondaire mise à niveau a été configurée à l'aide de RESTORE WITH STANDBY, les journaux des transactions ne peuvent plus être restaurés après la mise à niveau.</span><span class="sxs-lookup"><span data-stu-id="a79dc-139">If an upgraded secondary database has been configured by using RESTORE WITH STANDBY, transaction logs can no longer be restored after upgrade.</span></span> <span data-ttu-id="a79dc-140">Pour reprendre la copie des journaux de transaction sur cette base de données secondaire, vous devrez reconfigurer la copie des journaux de transaction sur ce serveur de secours.</span><span class="sxs-lookup"><span data-stu-id="a79dc-140">To resume log shipping on that secondary database, you will need to set up log shipping again on that standby server.</span></span> <span data-ttu-id="a79dc-141">Pour plus d’informations sur l’option STANDBY, consultez [Restore Arguments &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-arguments-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="a79dc-141">For more information about the STANDBY option, see [RESTORE Arguments &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-arguments-transact-sql).</span></span>

###  <a name="upgrading-the-primary-server-instance"></a><a name="UpgradePrimary"></a> <span data-ttu-id="a79dc-142">Mise à niveau de l'instance du serveur principal</span><span class="sxs-lookup"><span data-stu-id="a79dc-142">Upgrading the Primary Server Instance</span></span>
 <span data-ttu-id="a79dc-143">Lors de la planification d'une mise à niveau, un élément important à prendre en compte est la durée pendant laquelle votre base de données ne sera pas disponible.</span><span class="sxs-lookup"><span data-stu-id="a79dc-143">When planning an upgrade, a significant consideration is the amount of time that your database will be unavailable.</span></span> <span data-ttu-id="a79dc-144">Le scénario de mise à niveau le plus simple est que la base de données ne soit pas disponible pendant que vous mettez à niveau le serveur principal (scénario 1, ci-après).</span><span class="sxs-lookup"><span data-stu-id="a79dc-144">The simplest upgrade scenario involves the database being unavailable while you upgrade the primary server (scenario 1, below).</span></span>

 <span data-ttu-id="a79dc-145">Au prix d'un processus de mise à niveau plus compliqué, vous pouvez augmenter la disponibilité de votre base de données en basculant le serveur principal [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] (ou une version supérieure) vers un serveur secondaire [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] avant de mettre à niveau le serveur principal d'origine (scénario 2, ci-après).</span><span class="sxs-lookup"><span data-stu-id="a79dc-145">At the cost of a more complicated upgrade process, you can maximize your database availability by failing over the [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)] or higher primary server to a [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] secondary server before upgrading the original primary server (scenario 2, below).</span></span> <span data-ttu-id="a79dc-146">Il existe deux variantes du scénario de basculement :</span><span class="sxs-lookup"><span data-stu-id="a79dc-146">There are two variants of the failover scenario.</span></span> <span data-ttu-id="a79dc-147">vous pouvez revenir au serveur principal d'origine et sauvegarder la configuration de la copie des journaux de transaction originale.</span><span class="sxs-lookup"><span data-stu-id="a79dc-147">You can switch back to the original primary server and keep the original log shipping configuration.</span></span> <span data-ttu-id="a79dc-148">Autre solution, vous pouvez supprimer la configuration de la copie des journaux de transaction originale avant de mettre à niveau le serveur principal d'origine, puis, ultérieurement, créer une configuration à l'aide du nouveau serveur principal.</span><span class="sxs-lookup"><span data-stu-id="a79dc-148">Alternatively, you can remove the original log shipping configuration before upgrading the original primary server and later create a new configuration using the new primary server.</span></span> <span data-ttu-id="a79dc-149">Cette section décrit ces deux scénarios.</span><span class="sxs-lookup"><span data-stu-id="a79dc-149">This section describes both these scenarios.</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="a79dc-150">Veillez à mettre à niveau l'instance du serveur secondaire avant l'instance du serveur principal.</span><span class="sxs-lookup"><span data-stu-id="a79dc-150">Be sure to upgrade the secondary server instance before upgrading the primary server instance.</span></span> <span data-ttu-id="a79dc-151">Pour plus d'informations, consultez [Mise à niveau de l'instance du serveur secondaire](#UpgradeSecondary), plus haut dans cette rubrique.</span><span class="sxs-lookup"><span data-stu-id="a79dc-151">For more information, see [Upgrading the Secondary Server Instance](#UpgradeSecondary), earlier in this topic.</span></span>


####  <a name="scenario-1-upgrade-primary-server-instance-without-failover"></a><a name="Scenario1"></a><span data-ttu-id="a79dc-152">Scénario 1 : mettre à niveau l’instance de serveur principal sans basculement</span><span class="sxs-lookup"><span data-stu-id="a79dc-152">Scenario 1: Upgrade Primary Server Instance Without Failover</span></span>
 <span data-ttu-id="a79dc-153">C'est le scénario plus simple, mais il se traduit par un temps mort plus important que le basculement.</span><span class="sxs-lookup"><span data-stu-id="a79dc-153">This is the simpler scenario, but it causes more downtime than using failover.</span></span> <span data-ttu-id="a79dc-154">L'instance de serveur principal est simplement mise à niveau et la base de données n'est pas disponible pendant cette mise à niveau.</span><span class="sxs-lookup"><span data-stu-id="a79dc-154">The primary server instance is simply upgraded and the database is unavailable during this upgrade.</span></span>

 <span data-ttu-id="a79dc-155">Une fois que le serveur est mis à niveau, la base de données est automatiquement remise en ligne, ce qui entraîne sa mise à niveau.</span><span class="sxs-lookup"><span data-stu-id="a79dc-155">Once the server is upgraded, the database is automatically brought back online, which causes it to be upgraded.</span></span> <span data-ttu-id="a79dc-156">Après que la base de données a été mise à niveau, les travaux de la copie des journaux de transaction reprennent.</span><span class="sxs-lookup"><span data-stu-id="a79dc-156">After the database is upgraded, the log shipping jobs resume.</span></span>

#### <a name="scenario-2-upgrade-primary-server-instance-with-failover"></a><span data-ttu-id="a79dc-157">Scénario 2 : mettre à niveau l'instance de serveur principal avec basculement</span><span class="sxs-lookup"><span data-stu-id="a79dc-157">Scenario 2: Upgrade Primary Server Instance with Failover</span></span>
 <span data-ttu-id="a79dc-158">Ce scénario optimise la disponibilité et réduit le temps mort.</span><span class="sxs-lookup"><span data-stu-id="a79dc-158">This scenario maximizes availability and minimizes downtime.</span></span> <span data-ttu-id="a79dc-159">Il utilise un basculement contrôlé vers l'instance de serveur secondaire, ce qui maintient la base de données disponible pendant que vous mettez à niveau l'instance de serveur principal d'origine.</span><span class="sxs-lookup"><span data-stu-id="a79dc-159">It utilizes a controlled failover to the secondary server instance, which keeps the database available while the original primary server instance is upgraded.</span></span> <span data-ttu-id="a79dc-160">Le temps mort est limité à la période de temps relativement courte nécessaire au basculement, et non à la durée requise pour mettre à niveau l'instance de serveur principal.</span><span class="sxs-lookup"><span data-stu-id="a79dc-160">Downtime is limited to the relatively short time required to fail over, rather than the time required to upgrade the primary server instance.</span></span>

 <span data-ttu-id="a79dc-161">La mise à niveau de l'instance de serveur principal avec le basculement implique trois procédures générales : exécuter un basculement contrôlé sur le serveur secondaire, mettre à niveau l'instance de serveur principal d'origine vers [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]et installer la copie des journaux de transaction sur une instance de serveur principal [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="a79dc-161">Upgrading the primary server instance with failover involves three general procedures: performing a controlled failover to the secondary server, upgrading the original primary server instance to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)], and setting up log shipping on a [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] primary server instance.</span></span> <span data-ttu-id="a79dc-162">Ces procédures sont décrites dans la présente section.</span><span class="sxs-lookup"><span data-stu-id="a79dc-162">These procedures are described in this section.</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="a79dc-163">Si vous prévoyez d'avoir l'instance de serveur secondaire comme nouvelle instance de serveur principal, vous devez supprimer la configuration de la copie des journaux de transaction.</span><span class="sxs-lookup"><span data-stu-id="a79dc-163">If you plan to have the secondary server instance as the new primary server instance, you need to remove the log shipping configuration.</span></span> <span data-ttu-id="a79dc-164">La copie des journaux de transaction doit être reconfigurée à partir du nouveau serveur principal vers le nouveau serveur secondaire, une fois que l'instance de serveur principal d'origine a été mise à niveau.</span><span class="sxs-lookup"><span data-stu-id="a79dc-164">Log shipping will need to be reconfigured from the new primary to the new secondary, after the original primary server instance has been upgraded.</span></span> <span data-ttu-id="a79dc-165">Pour plus d’informations, consultez [Supprimer l’envoi de journaux &#40;SQL Server&#41;](remove-log-shipping-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="a79dc-165">For more information, see [Remove Log Shipping &#40;SQL Server&#41;](remove-log-shipping-sql-server.md).</span></span>


#####  <a name="procedure-1-perform-a-controlled-failover-to-the-secondary-server"></a><a name="Procedure1"></a><span data-ttu-id="a79dc-166">Procédure 1 : effectuer un basculement contrôlé sur le serveur secondaire</span><span class="sxs-lookup"><span data-stu-id="a79dc-166">Procedure 1: Perform a Controlled Failover to the Secondary Server</span></span>
 <span data-ttu-id="a79dc-167">Basculement contrôlé vers le serveur secondaire :</span><span class="sxs-lookup"><span data-stu-id="a79dc-167">Controlled failover to the secondary server:</span></span>

1.  <span data-ttu-id="a79dc-168">Exécutez manuellement une [sauvegarde de la fin du journal](../../relational-databases/backup-restore/tail-log-backups-sql-server.md) du journal des transactions sur la base de données primaire en spécifiant WITH NORECOVERY.</span><span class="sxs-lookup"><span data-stu-id="a79dc-168">Manually perform a [tail-log backup](../../relational-databases/backup-restore/tail-log-backups-sql-server.md) of the transaction log on the primary database specifying WITH NORECOVERY.</span></span> <span data-ttu-id="a79dc-169">Cette sauvegarde capture les enregistrements de journal qui n'ont pas encore été sauvegardés et place la base de données hors connexion.</span><span class="sxs-lookup"><span data-stu-id="a79dc-169">This log backup captures any log records that have not been backed up yet and takes the database offline.</span></span> <span data-ttu-id="a79dc-170">Notez que pendant que la base de données est hors connexion, le travail de sauvegarde de la copie des journaux de transaction échoue.</span><span class="sxs-lookup"><span data-stu-id="a79dc-170">Note that while the database is offline, the log shipping backup job will fail.</span></span>

     <span data-ttu-id="a79dc-171">L'exemple suivant crée une sauvegarde de la fin du journal de la base de données `AdventureWorks` du serveur principal.</span><span class="sxs-lookup"><span data-stu-id="a79dc-171">The following example creates a tail log backup of the `AdventureWorks` database on the primary server.</span></span> <span data-ttu-id="a79dc-172">Le fichier de sauvegarde est intitulé `Failover_AW_20080315.trn`:</span><span class="sxs-lookup"><span data-stu-id="a79dc-172">The backup file is named `Failover_AW_20080315.trn`:</span></span>

    ```
    BACKUP LOG AdventureWorks 
      TO DISK = N'\\FileServer\LogShipping\AdventureWorks\Failover_AW_20080315.trn' 
       WITH NORECOVERY;
    GO
    ```

     <span data-ttu-id="a79dc-173">Nous vous recommandons d'utiliser une convention d'affectation des noms de fichier distincte afin de différencier le fichier de sauvegarde créé manuellement des fichiers de sauvegarde créés par le travail de sauvegarde de la copie des journaux de transaction.</span><span class="sxs-lookup"><span data-stu-id="a79dc-173">We recommend that you use a distinct file naming convention to differentiate the manually-created backup file from the backup files created by the log shipping backup job.</span></span>

2.  <span data-ttu-id="a79dc-174">Sur le serveur secondaire :</span><span class="sxs-lookup"><span data-stu-id="a79dc-174">On the secondary server:</span></span>

    1.  <span data-ttu-id="a79dc-175">Assurez-vous que toutes les sauvegardes effectuées automatiquement par les travaux de sauvegarde de la copie des journaux de transaction ont été appliquées.</span><span class="sxs-lookup"><span data-stu-id="a79dc-175">Ensure that all backups taken automatically by the log shipping backup jobs have been applied.</span></span> <span data-ttu-id="a79dc-176">Pour vérifier quels travaux de sauvegarde ont été appliqués, utilisez la procédure stockée système [sp_help_log_shipping_monitor](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-monitor-transact-sql) sur le serveur moniteur ou sur les serveurs principal et secondaires.</span><span class="sxs-lookup"><span data-stu-id="a79dc-176">To check which backup jobs have been applied, use the [sp_help_log_shipping_monitor](/sql/relational-databases/system-stored-procedures/sp-help-log-shipping-monitor-transact-sql) system stored procedure on the monitor server or on the primary and secondary servers.</span></span> <span data-ttu-id="a79dc-177">Le même fichier doit apparaître dans les colonnes **last_backup_file**, **last_copied_file**et **last_restored_file** .</span><span class="sxs-lookup"><span data-stu-id="a79dc-177">The same file should be listed in the **last_backup_file**, **last_copied_file**, and **last_restored_file** columns.</span></span> <span data-ttu-id="a79dc-178">Si l'un des fichiers de sauvegarde n'a pas été copié et restauré, appelez manuellement les travaux de copie et de restauration de l'agent pour la configuration de la copie des journaux de transaction.</span><span class="sxs-lookup"><span data-stu-id="a79dc-178">If any of the backup files have not been copied and restored, manually invoke the agent copy and restore jobs for the log shipping configuration.</span></span>

         <span data-ttu-id="a79dc-179">Pour plus d'informations sur le démarrage d'un travail, consultez [Start a Job](../../ssms/agent/start-a-job.md).</span><span class="sxs-lookup"><span data-stu-id="a79dc-179">For information about starting a job, see [Start a Job](../../ssms/agent/start-a-job.md).</span></span>

    2.  <span data-ttu-id="a79dc-180">Copiez le dernier fichier de sauvegarde de journal créé dans l'étape 1 à partir du partage de fichiers vers l'emplacement local utilisé par la copie des journaux de transaction sur le serveur secondaire.</span><span class="sxs-lookup"><span data-stu-id="a79dc-180">Copy your the final log backup file that you created in step 1 from the file share to the local location that is used by log shipping on the secondary server.</span></span>

    3.  <span data-ttu-id="a79dc-181">Restaurez la dernière sauvegarde de fichier journal en spécifiant WITH RECOVERY pour mettre la base de données en ligne.</span><span class="sxs-lookup"><span data-stu-id="a79dc-181">Restore the final log backup specifying WITH RECOVERY to bring the database online.</span></span> <span data-ttu-id="a79dc-182">Dans le cadre de sa mise en ligne, la base de données est mise à niveau vers [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span><span class="sxs-lookup"><span data-stu-id="a79dc-182">As part of being brought online, the database will upgraded to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span></span>

         <span data-ttu-id="a79dc-183">L'exemple suivant restaure sauvegarde de la fin du journal de la base de données `AdventureWorks` sur la base de données secondaire.</span><span class="sxs-lookup"><span data-stu-id="a79dc-183">The following example restores the tail log backup of the `AdventureWorks` database on the secondary database.</span></span> <span data-ttu-id="a79dc-184">L'exemple utilise l'option WITH RECOVERY, qui place la base de données en ligne :</span><span class="sxs-lookup"><span data-stu-id="a79dc-184">The example uses the WITH RECOVERY option, which brings the database online:</span></span>

        ```
        RESTORE LOG AdventureWorks 
          FROM DISK = N'c:\logshipping\Failover_AW_20080315.trn' 
           WITH RECOVERY;
        GO
        ```

        > [!NOTE]
        >  <span data-ttu-id="a79dc-185">Pour une configuration qui contient plusieurs serveurs secondaires, certains éléments supplémentaires sont à prendre en compte.</span><span class="sxs-lookup"><span data-stu-id="a79dc-185">For a configuration that contains more than one secondary server, there are additional considerations.</span></span> <span data-ttu-id="a79dc-186">Pour plus d'informations, consultez [Mise à niveau de plusieurs instances du serveur secondaire](#MultipleSecondaries), plus loin dans cette rubrique.</span><span class="sxs-lookup"><span data-stu-id="a79dc-186">For more information, see [Upgrading Multiple Secondary Server Instances](#MultipleSecondaries), later in this topic.</span></span>

    4.  <span data-ttu-id="a79dc-187">Basculez la base de données en redirigeant les clients depuis le serveur principal original (serveur A) vers le serveur secondaire en ligne (serveur B).</span><span class="sxs-lookup"><span data-stu-id="a79dc-187">Fail over the database by redirecting clients from the original primary server (server A) to the online secondary server (server B).</span></span>

    5.  <span data-ttu-id="a79dc-188">Veillez à ce que le journal des transactions de la base de données secondaire ne se remplisse pas pendant que la base de données est en ligne.</span><span class="sxs-lookup"><span data-stu-id="a79dc-188">Take care that the transaction log of the secondary database does not fill while the database is online.</span></span> <span data-ttu-id="a79dc-189">Pour empêcher le journal des transactions de se remplir, vous pouvez avoir besoin de le sauvegarder.</span><span class="sxs-lookup"><span data-stu-id="a79dc-189">To prevent the transaction log from filling, you might need to back it up.</span></span> <span data-ttu-id="a79dc-190">Si tel est le cas, nous vous recommandons de le sauvegarder dans un emplacement partagé, un *partage de sauvegarde*, pour que les sauvegardes soient disponibles pour être restaurées sur l'autre instance de serveur.</span><span class="sxs-lookup"><span data-stu-id="a79dc-190">If so, we recommend that you back it up to a shared location, a *backup share*, to make the backups available for restoring on the other server instance.</span></span>

#####  <a name="procedure-2-upgrade-the-original-primary-server-instance-to-sscurrent"></a><a name="Procedure2"></a><span data-ttu-id="a79dc-191">Procédure 2 : mettre à niveau l’instance du serveur principal d’origine vers[!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]</span><span class="sxs-lookup"><span data-stu-id="a79dc-191">Procedure 2: Upgrade the Original Primary Server Instance to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]</span></span>
 <span data-ttu-id="a79dc-192">Après avoir mis à niveau l'instance du serveur principal d'origine vers [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)], la base de données demeure hors connexion et dans le format.</span><span class="sxs-lookup"><span data-stu-id="a79dc-192">After you upgrade the original primary server instance to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)], the database will still be offline and in the format.</span></span>

#####  <a name="procedure-3-set-up-log-shipping-on-sscurrent"></a><a name="Procedure3"></a><span data-ttu-id="a79dc-193">Procédure 3 : configurer la copie des journaux de connexion sur[!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]</span><span class="sxs-lookup"><span data-stu-id="a79dc-193">Procedure 3: Set Up Log Shipping on [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)]</span></span>
 <span data-ttu-id="a79dc-194">Le reste du processus de mise à niveau dépend du fait que la copie des journaux de transaction est toujours configurée ou pas, comme suit :</span><span class="sxs-lookup"><span data-stu-id="a79dc-194">The rest of the upgrade process depends on whether log shipping is still configured, as follows:</span></span>

-   <span data-ttu-id="a79dc-195">Si vous avez conservé la configuration de copie des journaux de transaction [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)](ou version supérieure), revenez à l'instance du serveur principal d'origine.</span><span class="sxs-lookup"><span data-stu-id="a79dc-195">If you have kept the [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)]or higher log shipping configuration, switch back to the original primary server instance.</span></span> <span data-ttu-id="a79dc-196">Pour plus d'informations, consultez [Pour revenir à l'instance du serveur principal d'origine](#SwitchToOrigPrimary), plus loin dans cette section.</span><span class="sxs-lookup"><span data-stu-id="a79dc-196">For more information, see [To Switch Back to the Original Primary Server Instance](#SwitchToOrigPrimary), later in this section.</span></span>

-   <span data-ttu-id="a79dc-197">Si vous avez supprimé la configuration de la copie des journaux de transaction avant le basculement, créez une nouvelle configuration de la copie des journaux de transaction dans laquelle l'instance de serveur secondaire d'origine est la nouvelle instance de serveur principal.</span><span class="sxs-lookup"><span data-stu-id="a79dc-197">If you removed the log shipping configuration before failing over, create a new log shipping configuration in which the original secondary server instance is the new primary server instance.</span></span> <span data-ttu-id="a79dc-198">Pour plus d'informations, consultez [Pour conserver l'ancienne instance du serveur secondaire comme nouvelle instance du serveur principal](#KeepOldSecondaryAsNewPrimary), plus loin dans cette section.</span><span class="sxs-lookup"><span data-stu-id="a79dc-198">For more information, see [To Keep the Old Secondary Server Instance As the New Primary Server Instance](#KeepOldSecondaryAsNewPrimary), later in this section.</span></span>

######  <a name="to-switch-back-to-the-original-primary-server-instance"></a><a name="SwitchToOrigPrimary"></a><span data-ttu-id="a79dc-199">Pour revenir à l’instance du serveur principal d’origine</span><span class="sxs-lookup"><span data-stu-id="a79dc-199">To Switch Back to the Original Primary Server Instance</span></span>

1.  <span data-ttu-id="a79dc-200">Sur le serveur principal temporaire (serveur B), sauvegardez la fin du journal avec l'option WITH NORECOVERY pour créer une sauvegarde de la fin du journal et placer la base de données hors connexion.</span><span class="sxs-lookup"><span data-stu-id="a79dc-200">On the interim primary server (server B), back up the tail of the log using WITH NORECOVERY to create a tail-log backup and take the database offline.</span></span> <span data-ttu-id="a79dc-201">La sauvegarde de la fin du journal s'intitule `Switchback_AW_20080315.trn`. Par exemple :</span><span class="sxs-lookup"><span data-stu-id="a79dc-201">The tail log backup is named `Switchback_AW_20080315.trn`.For example:</span></span>

    ```
    BACKUP LOG AdventureWorks 
      TO DISK = N'\\FileServer\LogShipping\AdventureWorks\Switchback_AW_20080315.trn' 
       WITH NORECOVERY;
    GO
    ```

2.  <span data-ttu-id="a79dc-202">Si les sauvegardes des journaux des transactions ont eu lieu sur la base de données primaire temporaire, autres que la sauvegarde de fin créée à l'étape 1, restaurez ces sauvegardes de journaux à l'aide de WITH NORECOVERY sur la base de données hors connexion du serveur principal d'origine (serveur A).</span><span class="sxs-lookup"><span data-stu-id="a79dc-202">If any transaction log backups were taken on the interim primary database, other than the tail backup that you created in step 1, restore those log backups using WITH NORECOVERY to the offline database on the original primary server (server A).</span></span> <span data-ttu-id="a79dc-203">La base de données est mise à niveau au format [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] lorsque la première sauvegarde de journal est restaurée.</span><span class="sxs-lookup"><span data-stu-id="a79dc-203">The database is upgraded to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] format when the first log backup is restored.</span></span>

3.  <span data-ttu-id="a79dc-204">Restaurez la sauvegarde de la fin du journal, `Switchback_AW_20080315.trn`, sur la base de données primaire d'origine (sur le serveur A) à l'aide de l'option WITH RECOVERY pour mettre la base de données en ligne.</span><span class="sxs-lookup"><span data-stu-id="a79dc-204">Restore the tail-log backup, `Switchback_AW_20080315.trn`, on the original primary database (on server A) using WITH RECOVERY to bring the database online.</span></span>

4.  <span data-ttu-id="a79dc-205">Basculez à nouveau vers la base de données primaire d'origine (sur le serveur A) en redirigeant les clients vers le serveur secondaire en ligne à partir du serveur principal d'origine.</span><span class="sxs-lookup"><span data-stu-id="a79dc-205">Fail over back to the original primary database (on server A) by redirecting clients to the online secondary server from the original primary server.</span></span>

 <span data-ttu-id="a79dc-206">Après que la base de données a été placée en ligne, la configuration de la copie des journaux de transaction d'origine se poursuit.</span><span class="sxs-lookup"><span data-stu-id="a79dc-206">After the database comes online, the original log shipping configuration will resume.</span></span>

######  <a name="to-keep-the-old-secondary-server-instance-as-the-new-primary-server-instance"></a><a name="KeepOldSecondaryAsNewPrimary"></a><span data-ttu-id="a79dc-207">Pour conserver l’ancienne instance de serveur secondaire comme nouvelle instance de serveur principal</span><span class="sxs-lookup"><span data-stu-id="a79dc-207">To Keep the Old Secondary Server Instance As the New Primary Server Instance</span></span>
 <span data-ttu-id="a79dc-208">Établissez une nouvelle configuration de la copie des journaux de transaction en utilisant l'ancienne instance de serveur secondaire, B, comme serveur principal et l'ancienne instance de serveur principal, A, comme nouveau serveur secondaire :</span><span class="sxs-lookup"><span data-stu-id="a79dc-208">Establish a new log shipping configuration using the old secondary server instance, B, as the primary server and the old primary server instance, A, as the new secondary server, as follows:</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="a79dc-209">L'ancienne configuration de la copie des journaux de transaction doit avoir été supprimée du serveur principal d'origine au démarrage du processus avant d'effectuer la sauvegarde manuelle des journaux des transactions qui a placé la base de données hors connexion.</span><span class="sxs-lookup"><span data-stu-id="a79dc-209">The old log shipping configuration should have been removed from the original primary server at the start of the process before taking the manual transaction log backup that took the database offline.</span></span>

1.  <span data-ttu-id="a79dc-210">Pour éviter d'effectuer une sauvegarde et une restauration complètes de la base de données sur le nouveau serveur secondaire (serveur A), appliquez les sauvegardes de journaux de la nouvelle base de données primaire vers la nouvelle base de données secondaire.</span><span class="sxs-lookup"><span data-stu-id="a79dc-210">To avoid performing a complete backup and restore of the database on the new secondary server (server A), apply the log backups from the new primary database to the new secondary database.</span></span> <span data-ttu-id="a79dc-211">Dans l'exemple de configuration, cela nécessite de restaurer les sauvegardes de journaux effectuées sur le serveur B vers la base de données du serveur A.</span><span class="sxs-lookup"><span data-stu-id="a79dc-211">In the example configuration, this involves restoring the log backups taken on server B to the database on server A.</span></span>

2.  <span data-ttu-id="a79dc-212">Sauvegardez le journal à partir de la nouvelle base de données primaire (serveur B).</span><span class="sxs-lookup"><span data-stu-id="a79dc-212">Back up the log from the new primary database (on server B).</span></span>

3.  <span data-ttu-id="a79dc-213">Restaurez les sauvegardes des journaux vers la nouvelle instance de serveur secondaire (serveur A) à l'aide de WITH NORECOVERY.</span><span class="sxs-lookup"><span data-stu-id="a79dc-213">Restore the log backups to the new secondary server instance (server A) using WITH NORECOVERY.</span></span> <span data-ttu-id="a79dc-214">La première opération de restauration met à jour la base de données vers [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span><span class="sxs-lookup"><span data-stu-id="a79dc-214">The first restore operation updates the database to [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span></span>

4.  <span data-ttu-id="a79dc-215">Configurez la copie des journaux de transaction avec le précédent serveur secondaire (serveur B) comme instance de serveur principal.</span><span class="sxs-lookup"><span data-stu-id="a79dc-215">Configure log shipping with the former secondary server (server B) as the primary server instance.</span></span>

    > [!IMPORTANT]
    >  <span data-ttu-id="a79dc-216">Si vous utilisez [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)], spécifiez que la base de données secondaire est déjà initialisée.</span><span class="sxs-lookup"><span data-stu-id="a79dc-216">If you use [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)], specify that the secondary database is already initialized.</span></span>

     <span data-ttu-id="a79dc-217">Pour plus d’informations, consultez [Configurer la copie des journaux de transaction &#40;Transact-SQL&#41;](configure-log-shipping-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="a79dc-217">For more information, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span>

5.  <span data-ttu-id="a79dc-218">Basculez la base de données en redirigeant les clients depuis le serveur principal original (serveur A) vers le serveur secondaire en ligne (serveur B).</span><span class="sxs-lookup"><span data-stu-id="a79dc-218">Fail over the database by redirecting clients from the original primary server (server A) to the online secondary server (server B).</span></span>

    > [!IMPORTANT]
    >  <span data-ttu-id="a79dc-219">Lorsque vous basculez vers une nouvelle base de données primaire, vous devez vous assurer que ses métadonnées sont cohérentes avec celles de la base de données principale d'origine.</span><span class="sxs-lookup"><span data-stu-id="a79dc-219">When you failover to a new primary database, you should ensure that its metadata is consistent with the metadata of the original primary database.</span></span> <span data-ttu-id="a79dc-220">Pour plus d’informations, consultez [Gérer les métadonnées durant la mise à disposition d’une base de données sur une autre instance de serveur &#40;SQL Server&#41;](../../relational-databases/databases/manage-metadata-when-making-a-database-available-on-another-server.md).</span><span class="sxs-lookup"><span data-stu-id="a79dc-220">For more information, see [Manage Metadata When Making a Database Available on Another Server Instance &#40;SQL Server&#41;](../../relational-databases/databases/manage-metadata-when-making-a-database-available-on-another-server.md).</span></span>

##  <a name="upgrading-multiple-secondary-server-instances"></a><a name="MultipleSecondaries"></a><span data-ttu-id="a79dc-221">Mise à niveau de plusieurs instances de serveur secondaire</span><span class="sxs-lookup"><span data-stu-id="a79dc-221">Upgrading Multiple Secondary Server Instances</span></span>
 <span data-ttu-id="a79dc-222">La figure ci-après illustre cette configuration, avec une instance du serveur principal, A, et deux instances du serveur secondaire, B et C.</span><span class="sxs-lookup"><span data-stu-id="a79dc-222">This configuration is represented in the following illustration, which shows a primary server instance, A, and two secondary server instances, B and C.</span></span>

 <span data-ttu-id="a79dc-223">![Deux serveurs secondaires et aucun serveur moniteur](../media/ls-3-wayconfig-nomonitor.gif "Deux serveurs secondaires et aucun serveur moniteur")</span><span class="sxs-lookup"><span data-stu-id="a79dc-223">![Two secondary servers and no monitor server](../media/ls-3-wayconfig-nomonitor.gif "Two secondary servers and no monitor server")</span></span>

 <span data-ttu-id="a79dc-224">Cette section traite de la procédure de mise à niveau avec basculement et du retour au serveur principal d'origine</span><span class="sxs-lookup"><span data-stu-id="a79dc-224">This section discusses how to upgrade using a failover and then switching back to the original primary server.</span></span> <span data-ttu-id="a79dc-225">Lors de la mise à niveau de l'instance principale avec le basculement, le processus est plus complexe quand il y a plusieurs instances de serveur secondaire.</span><span class="sxs-lookup"><span data-stu-id="a79dc-225">When upgrading the primary instance with failover the process is more complex when there are multiple secondary server instances.</span></span> <span data-ttu-id="a79dc-226">Dans la procédure suivante, après que tous les serveurs secondaires ont été mis à niveau, le serveur principal est basculé vers l'une des bases de données secondaires mises à niveau.</span><span class="sxs-lookup"><span data-stu-id="a79dc-226">In the following procedure, after all the secondary servers are upgraded, the primary server is failed over to one of the upgraded secondary databases.</span></span> <span data-ttu-id="a79dc-227">Le serveur principal d'origine est mis à niveau et la copie des journaux de transaction est basculée vers ce serveur.</span><span class="sxs-lookup"><span data-stu-id="a79dc-227">The original primary server is upgraded, and log shipping is failed over back to it.</span></span>

> [!IMPORTANT]
>  <span data-ttu-id="a79dc-228">Mettez toujours à niveau toutes les instances de serveur secondaires avant de mettre à niveau le serveur principal.</span><span class="sxs-lookup"><span data-stu-id="a79dc-228">Always upgrade all the secondary server instances before you upgrade the primary server.</span></span>

 <span data-ttu-id="a79dc-229">**Pour effectuer une mise à niveau avec basculement et retourner au serveur principal d'origine**</span><span class="sxs-lookup"><span data-stu-id="a79dc-229">**To upgrade using a failover and then switching back to original primary server**</span></span>

1.  <span data-ttu-id="a79dc-230">Mettez à niveau toutes les instances de serveur secondaire (serveur B et serveur C).</span><span class="sxs-lookup"><span data-stu-id="a79dc-230">Upgrade all the secondary server instances (server B and server C).</span></span>

2.  <span data-ttu-id="a79dc-231">Récupérez la fin du journal des transactions de la base de données primaire (sur le serveur A) et placez la base de données hors connexion, en sauvegardant le journal des transactions avec l'option WITH NORECOVERY.</span><span class="sxs-lookup"><span data-stu-id="a79dc-231">Obtain the tail of the transaction log of the primary database (on server A), and take the database offline, by backing up the transaction log using WITH NORECOVERY.</span></span>

3.  <span data-ttu-id="a79dc-232">Sur le serveur secondaire vers lequel vous prévoyez de basculer (serveur B), mettez la base de données secondaire en ligne, en restaurant la sauvegarde du journal à l'aide de WITH RECOVERY.</span><span class="sxs-lookup"><span data-stu-id="a79dc-232">On the secondary server to which you plan to fail over (server B), bring the secondary database online, by restoring the log backup using WITH RECOVERY.</span></span>

4.  <span data-ttu-id="a79dc-233">Sur chaque autre serveur secondaire (serveur C), laissez la base de données secondaire hors ligne en restaurant la sauvegarde de journal à l'aide de WITH NORECOVERY.</span><span class="sxs-lookup"><span data-stu-id="a79dc-233">On every other secondary server (server C), leave the secondary database offline by restoring the log backup using WITH NORECOVERY.</span></span>

    > [!NOTE]
    >  <span data-ttu-id="a79dc-234">Les travaux de copie et de restauration de la copie des journaux de transaction s'exécutent sur les serveurs secondaires, mais les travaux demeurent inactifs parce que les nouveaux fichiers de sauvegarde des journaux ne sont pas placés sur le partage de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="a79dc-234">The log shipping copy and restore jobs will run on the secondary servers, but the jobs will do nothing because new log-backup files will not be placed on the backup share.</span></span>

5.  <span data-ttu-id="a79dc-235">Basculez la base de données en redirigeant les clients depuis le serveur principal original (serveur A) vers le serveur secondaire en ligne (serveur B).</span><span class="sxs-lookup"><span data-stu-id="a79dc-235">Fail over the database by redirecting clients from the original primary server (server A) to the online secondary server (server B).</span></span> <span data-ttu-id="a79dc-236">La base de données en ligne devient un serveur principal temporaire, en conservant la base de données disponible pendant que le serveur principal d'origine est hors connexion (serveur A).</span><span class="sxs-lookup"><span data-stu-id="a79dc-236">The online database becomes an interim primary server, keeping the database available while the original primary server is offline (server A).</span></span>

6.  <span data-ttu-id="a79dc-237">Mettez à niveau le serveur principal d'origine (serveur A).</span><span class="sxs-lookup"><span data-stu-id="a79dc-237">Upgrade the original primary server (server A).</span></span>

7.  <span data-ttu-id="a79dc-238">Sur la base de données vers laquelle vous avez basculé-la base de données primaire temporaire (sur le serveur B), sauvegardez manuellement le journal des transactions à l’aide de WITH NORECOVERY.</span><span class="sxs-lookup"><span data-stu-id="a79dc-238">On the database to which you failed over-the interim primary database (on server B), manually back up the transaction log using WITH NORECOVERY.</span></span> <span data-ttu-id="a79dc-239">La base de données est alors placée hors connexion.</span><span class="sxs-lookup"><span data-stu-id="a79dc-239">This takes the database offline.</span></span>

8.  <span data-ttu-id="a79dc-240">Restaurez toutes les sauvegardes des journaux des transactions que vous avez créées sur la base de données primaire temporaire (sur le serveur B) sur chaque autre base de données secondaire (sur le serveur C) à l'aide de WITH NORECOVERY.</span><span class="sxs-lookup"><span data-stu-id="a79dc-240">Restore all transaction log backups that you created on the interim primary database (on server B) to every other secondary database (on server C) using WITH NORECOVERY.</span></span> <span data-ttu-id="a79dc-241">Cela permet à la copie des journaux de transaction de se poursuivre depuis la base de données primaire d'origine après sa mise à niveau, sans nécessiter une restauration de base de données complète sur chaque base de données secondaire.</span><span class="sxs-lookup"><span data-stu-id="a79dc-241">This allows log shipping to continue from the original primary database after its upgrade, without requiring a full database restore on each secondary database.</span></span>

9. <span data-ttu-id="a79dc-242">Restaurez le journal des transactions depuis le serveur principal temporaire (serveur B) vers la base de données primaire d'origine (sur le serveur A) à l'aide de l'option WITH RECOVERY.</span><span class="sxs-lookup"><span data-stu-id="a79dc-242">Restore the transaction log from the interim primary server (server B) to the original primary database (on server A) using WITH RECOVERY.</span></span>

##  <a name="redeploying-log-shipping"></a><a name="Redeploying"></a><span data-ttu-id="a79dc-243">Redéploiement de la copie des journaux de session</span><span class="sxs-lookup"><span data-stu-id="a79dc-243">Redeploying Log Shipping</span></span>
 <span data-ttu-id="a79dc-244">Si vous ne souhaitez pas migrer la configuration de la copie des journaux de transaction à l'aide de l'une des procédures indiquées ci-dessus, vous pouvez redéployer entièrement la copie des journaux de transaction en réinitialisant la base de données secondaire avec une sauvegarde et une restauration complètes de la base de données primaire.</span><span class="sxs-lookup"><span data-stu-id="a79dc-244">If you do not want to migrate your log shipping configuration using one of the procedures shown above, you can redeploy log shipping from scratch by reinitializing your secondary database with a full backup and restore of the primary database.</span></span> <span data-ttu-id="a79dc-245">Cette option peut être souhaitable si vous avez une base de données peu volumineuse ou si une haute disponibilité n'est pas primordiale pendant la mise à niveau.</span><span class="sxs-lookup"><span data-stu-id="a79dc-245">This may be a desirable option if you have a small database or if high availability is not crucial during the upgrade procedure.</span></span>

 <span data-ttu-id="a79dc-246">Pour plus d’informations sur l’activation de la copie des journaux de session, consultez [configurer la copie des journaux de &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="a79dc-246">For information about enabling log shipping, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span>

## <a name="see-also"></a><span data-ttu-id="a79dc-247">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="a79dc-247">See Also</span></span>
 <span data-ttu-id="a79dc-248">Les [sauvegardes du journal des transactions &#40;SQL Server&#41;](../../relational-databases/backup-restore/transaction-log-backups-sql-server.md) [appliquer les sauvegardes du journal des transactions &#40;SQL Server&#41;](../../relational-databases/backup-restore/apply-transaction-log-backups-sql-server.md) [les tables et les procédures stockées de copie des journaux de](log-shipping-tables-and-stored-procedures.md) transaction.</span><span class="sxs-lookup"><span data-stu-id="a79dc-248">[Transaction Log Backups &#40;SQL Server&#41;](../../relational-databases/backup-restore/transaction-log-backups-sql-server.md) [Apply Transaction Log Backups &#40;SQL Server&#41;](../../relational-databases/backup-restore/apply-transaction-log-backups-sql-server.md) [Log Shipping Tables and Stored Procedures](log-shipping-tables-and-stored-procedures.md)</span></span>
