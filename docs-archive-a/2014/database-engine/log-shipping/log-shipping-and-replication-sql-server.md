---
title: Copie des journaux de transaction et réplication (SQL Server) | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: high-availability
ms.topic: conceptual
helpviewer_keywords:
- replication [SQL Server], log shipping and
- log shipping [SQL Server], replication and
ms.assetid: 132bebfd-0206-4d23-829a-b38e5ed17bc9
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: e3b1a0e08c5850b9e31202965909dfcfe1273e47
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87611286"
---
# <a name="log-shipping-and-replication-sql-server"></a><span data-ttu-id="e7edc-102">Copie des journaux de transaction et réplication (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="e7edc-102">Log Shipping and Replication (SQL Server)</span></span>
  <span data-ttu-id="e7edc-103">La copie des journaux de transaction consiste à avoir deux exemplaires d'une même base de données qui résident généralement sur des ordinateurs différents.</span><span class="sxs-lookup"><span data-stu-id="e7edc-103">Log shipping involves two copies of a single database that typically reside on different computers.</span></span> <span data-ttu-id="e7edc-104">À un moment donné précis, les clients ne peuvent accéder qu'à un seul exemplaire de la base de données.</span><span class="sxs-lookup"><span data-stu-id="e7edc-104">At any given time, only one copy of the database is currently available to clients.</span></span> <span data-ttu-id="e7edc-105">Cet exemplaire s'appelle la base de données primaire.</span><span class="sxs-lookup"><span data-stu-id="e7edc-105">This copy is known as the primary database.</span></span> <span data-ttu-id="e7edc-106">Les mises à jour apportées par les clients à la base de données primaire sont répercutées, par copie des journaux de transaction, à l'autre exemplaire de la base de données appelé base de données secondaire.</span><span class="sxs-lookup"><span data-stu-id="e7edc-106">Updates made by clients to the primary database are propagated by means of log shipping to the other copy of the database, known as the secondary database.</span></span> <span data-ttu-id="e7edc-107">La copie des journaux de transaction consiste à répercuter dans la base de données secondaire chaque insertion, mise à jour ou suppression apportée à la base de données primaire.</span><span class="sxs-lookup"><span data-stu-id="e7edc-107">Log shipping involves applying the transaction log from every insertion, update, or deletion made on the primary database onto the secondary database.</span></span>  
  
 <span data-ttu-id="e7edc-108">La copie des journaux de transaction peut intervenir en parallèle à la réplication selon les principes suivants :</span><span class="sxs-lookup"><span data-stu-id="e7edc-108">Log shipping can be used in conjunction with replication, with the following behavior:</span></span>  
  
-   <span data-ttu-id="e7edc-109">La réplication s'arrête après le basculement de la copie des journaux de transaction.</span><span class="sxs-lookup"><span data-stu-id="e7edc-109">Replication does not continue after a log shipping failover.</span></span> <span data-ttu-id="e7edc-110">Si un basculement se produit, les agents de réplication ne se connectent pas à la base de données secondaire, ainsi les transactions ne sont pas répliquées sur les Abonnés.</span><span class="sxs-lookup"><span data-stu-id="e7edc-110">If a failover occurs, replication agents do not connect to the secondary, so transactions are not replicated to Subscribers.</span></span> <span data-ttu-id="e7edc-111">Si une restauration automatique de la base de données primaire a lieu, la réplication reprend.</span><span class="sxs-lookup"><span data-stu-id="e7edc-111">If a failback to the primary occurs, replication resumes.</span></span> <span data-ttu-id="e7edc-112">Toutes les transactions copiées à l'aide des journaux de transactions de la base de données secondaire vers la base de données primaire sont répliquées sur les Abonnés.</span><span class="sxs-lookup"><span data-stu-id="e7edc-112">All transactions that log shipping copies from the secondary back to the primary are replicated to Subscribers.</span></span>  
  
-   <span data-ttu-id="e7edc-113">Si la base de données primaire est définitivement perdue, la base de données secondaire peut être renommée afin que la réplication puisse se poursuivre.</span><span class="sxs-lookup"><span data-stu-id="e7edc-113">If the primary is permanently lost, the secondary can be renamed so that replication can continue.</span></span> <span data-ttu-id="e7edc-114">Le reste de cette rubrique décrit les conditions requises et les procédures à suivre pour gérer cette situation.</span><span class="sxs-lookup"><span data-stu-id="e7edc-114">The remainder of this topic describes the requirements and procedures for handling this case.</span></span> <span data-ttu-id="e7edc-115">L'exemple concerne la base de données de publication, qui est la base de données la plus fréquemment utilisée pour la copie des journaux de transaction, mais un processus similaire peut être appliqué aux bases de données d'abonnement et de distribution.</span><span class="sxs-lookup"><span data-stu-id="e7edc-115">The example given is the publication database, which is the most common database to log ship, but a similar process can also be applied to subscription and distribution databases.</span></span>  
  
 <span data-ttu-id="e7edc-116">Pour plus d’informations sur la récupération des bases de données impliquées dans la réplication sans avoir à reconfigurer la réplication, consultez [Sauvegarder et restaurer des bases de données répliquées](../../relational-databases/replication/administration/back-up-and-restore-replicated-databases.md).</span><span class="sxs-lookup"><span data-stu-id="e7edc-116">For information about recovering databases involved in replication without any need to reconfigure replication, see [Back Up and Restore Replicated Databases](../../relational-databases/replication/administration/back-up-and-restore-replicated-databases.md).</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="e7edc-117">Nous vous recommandons d'utiliser la mise en miroir des bases de données plutôt que la copie des journaux de transaction pour assurer la disponibilité de la base de données de publication.</span><span class="sxs-lookup"><span data-stu-id="e7edc-117">We recommend using database mirroring, rather than log shipping, to provide availability for the publication database.</span></span> <span data-ttu-id="e7edc-118">Pour plus d’informations, consultez [Mise en miroir de bases de données et réplication &#40;SQL Server&#41;](../database-mirroring/database-mirroring-and-replication-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="e7edc-118">For more information, see [Database Mirroring and Replication &#40;SQL Server&#41;](../database-mirroring/database-mirroring-and-replication-sql-server.md).</span></span>  
  
## <a name="requirements-and-procedures-for-replicating-from-the-secondary-if-the-primary-is-lost"></a><span data-ttu-id="e7edc-119">Conditions requises et procédures à suivre pour assurer une réplication à partir de la base de données secondaire en cas de perte de la base de données primaire</span><span class="sxs-lookup"><span data-stu-id="e7edc-119">Requirements and Procedures for Replicating from the Secondary If the Primary Is Lost</span></span>  
 <span data-ttu-id="e7edc-120">Tenez compte des exigences et des points suivants :</span><span class="sxs-lookup"><span data-stu-id="e7edc-120">Be aware of the following requirements and considerations:</span></span>  
  
-   <span data-ttu-id="e7edc-121">Si une base de données primaire contient plusieurs bases de données de publication, copiez les journaux de toutes les bases de données de publication sur la même base de données secondaire.</span><span class="sxs-lookup"><span data-stu-id="e7edc-121">If a primary contains more than one publication database, log ship all of the publication databases to the same secondary.</span></span>  
  
-   <span data-ttu-id="e7edc-122">Le chemin d'installation de l'instance du serveur secondaire doit être identique à celui du serveur principal.</span><span class="sxs-lookup"><span data-stu-id="e7edc-122">The installation path for the secondary server instance must be the same as the primary.</span></span> <span data-ttu-id="e7edc-123">Les emplacements des bases de données utilisateur sur le serveur secondaire doivent être identiques à ceux du serveur principal.</span><span class="sxs-lookup"><span data-stu-id="e7edc-123">User database locations on the secondary server must be the same as on the primary.</span></span>  
  
-   <span data-ttu-id="e7edc-124">Sauvegardez la clé principale du service sur le serveur principal.</span><span class="sxs-lookup"><span data-stu-id="e7edc-124">Back up the service master key at the primary.</span></span> <span data-ttu-id="e7edc-125">Cette clé sera restaurée sur le serveur secondaire.</span><span class="sxs-lookup"><span data-stu-id="e7edc-125">This key will be restored at the secondary.</span></span> <span data-ttu-id="e7edc-126">Pour plus d’informations, consultez [BACKUP SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/backup-service-master-key-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="e7edc-126">For more information, see [BACKUP SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/backup-service-master-key-transact-sql).</span></span>  
  
-   <span data-ttu-id="e7edc-127">La copie des journaux de transaction ne vous protège pas contre les pertes de données.</span><span class="sxs-lookup"><span data-stu-id="e7edc-127">Log shipping does not guarantee against data loss.</span></span> <span data-ttu-id="e7edc-128">Une défaillance de la base de données primaire peut entraîner la perte des données qui n'ont pas encore été sauvegardées ou des sauvegardes égarées suite à la défaillance.</span><span class="sxs-lookup"><span data-stu-id="e7edc-128">A failure on the primary database can result in the loss of data that has not yet been backed up or for backups that are lost during the failure.</span></span>  
  
### <a name="log-shipping-with-transactional-replication"></a><span data-ttu-id="e7edc-129">Copie des journaux de transaction et réplication transactionnelle</span><span class="sxs-lookup"><span data-stu-id="e7edc-129">Log Shipping with Transactional Replication</span></span>  
 <span data-ttu-id="e7edc-130">En cas de réplication transactionnelle, le comportement de la copie des journaux de transaction dépend de l’option **sync with backup** .</span><span class="sxs-lookup"><span data-stu-id="e7edc-130">For transactional replication, the behavior of log shipping depends on the **sync with backup** option.</span></span> <span data-ttu-id="e7edc-131">Cette option ne peut pas être définie dans les bases de données de publication et de distribution. En cas de copie des journaux de transaction pour le serveur de publication, seuls les paramètres de la base de données de publication s'appliquent.</span><span class="sxs-lookup"><span data-stu-id="e7edc-131">This option can be set on the publication database and distribution database; in log shipping for the Publisher, only the setting on the publication database is relevant.</span></span>  
  
 <span data-ttu-id="e7edc-132">L'activation de cette option garantit que les transactions ne sont pas remises à la base de données de distribution tant qu'elles ne sont pas sauvegardées dans la base de données de publication.</span><span class="sxs-lookup"><span data-stu-id="e7edc-132">Setting this option on the publication database ensures that transactions are not delivered to the distribution database until they are backed up at the publication database.</span></span> <span data-ttu-id="e7edc-133">La dernière sauvegarde de la base de données de publication peut alors être restaurée sur le serveur secondaire sans que la base de distribution possède des transactions que la base de données de publication n'aurait pas.</span><span class="sxs-lookup"><span data-stu-id="e7edc-133">The last publication database backup can then be restored at the secondary server without any possibility of the distribution database having transactions that the restored publication database does not have.</span></span> <span data-ttu-id="e7edc-134">Cette option permet aussi, en cas de basculement du serveur de publication sur un serveur secondaire, d'assurer la cohérence entre le serveur de publication, le serveur de distribution et les Abonnés.</span><span class="sxs-lookup"><span data-stu-id="e7edc-134">This option guarantees that if the Publisher fails over to a secondary server, consistency is maintained between the Publisher, Distributor, and Subscribers.</span></span> <span data-ttu-id="e7edc-135">La latence et le débit sont affectés puisque les transactions ne peuvent pas être fournies à la base de données de distribution sans avoir été sauvegardées au préalable sur le serveur de publication. Si votre application tolère cette latence, nous vous recommandons d'activer cette option sur la base de données de publication.</span><span class="sxs-lookup"><span data-stu-id="e7edc-135">Latency and throughput are affected because transactions cannot be delivered to the distribution database until they have been backed up at the Publisher; if your application can tolerate this latency, we recommend that you set this option on the publication database.</span></span> <span data-ttu-id="e7edc-136">Si l’option **sync with backup** n’est pas activée, les Abonnés risquent de recevoir des modifications qui ne figurent plus dans la base de données restaurée au niveau du serveur secondaire.</span><span class="sxs-lookup"><span data-stu-id="e7edc-136">If the **sync with backup** option is not set, Subscribers might receive changes that are no longer included in the recovered database at the secondary server.</span></span> <span data-ttu-id="e7edc-137">Pour plus d’informations, voir [Stratégies de sauvegarde et de restauration de la réplication transactionnelle et d'instantané](../../relational-databases/replication/transactional/transactional-replication.md).</span><span class="sxs-lookup"><span data-stu-id="e7edc-137">For more information, see [Strategies for Backing Up and Restoring Snapshot and Transactional Replication](../../relational-databases/replication/transactional/transactional-replication.md).</span></span>  
  
 <span data-ttu-id="e7edc-138">**Pour configurer la réplication transactionnelle et la copie des journaux de transaction avec l'option sync with backup**</span><span class="sxs-lookup"><span data-stu-id="e7edc-138">**To configure transactional replication and log shipping with the sync with backup option**</span></span>  
  
1.  <span data-ttu-id="e7edc-139">Si l'option sync with backup n'est pas activée sur la base de données de publication, exécutez `sp_replicationdboption '<publicationdatabasename>', 'sync with backup', 'true'`.</span><span class="sxs-lookup"><span data-stu-id="e7edc-139">If the sync with backup option is not set on the publication database, execute `sp_replicationdboption '<publicationdatabasename>', 'sync with backup', 'true'`.</span></span> <span data-ttu-id="e7edc-140">Pour plus d’informations, consultez [sp_replicationdboption &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-replicationdboption-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="e7edc-140">For more information, see [sp_replicationdboption &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-replicationdboption-transact-sql).</span></span>  
  
2.  <span data-ttu-id="e7edc-141">Configurez la copie des journaux de transaction pour la base de données de publication.</span><span class="sxs-lookup"><span data-stu-id="e7edc-141">Configure log shipping for the publication database.</span></span> <span data-ttu-id="e7edc-142">Pour plus d’informations, consultez [Configurer la copie des journaux de transaction &#40;Transact-SQL&#41;](configure-log-shipping-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="e7edc-142">For more information, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span>  
  
3.  <span data-ttu-id="e7edc-143">Lorsque le serveur de publication tombe en panne, restaurez le dernier journal de la base de données sur le serveur secondaire en utilisant l'option KEEP_REPLICATION de RESTORE LOG.</span><span class="sxs-lookup"><span data-stu-id="e7edc-143">If the Publisher fails, restore the last log of the database to the secondary server, using the KEEP_REPLICATION option of RESTORE LOG.</span></span> <span data-ttu-id="e7edc-144">De cette façon, vous conservez tous les paramètres de réplication pour la base de données.</span><span class="sxs-lookup"><span data-stu-id="e7edc-144">This retains all replication settings for the database.</span></span> <span data-ttu-id="e7edc-145">Pour plus d’informations, consultez [Basculer vers un serveur secondaire d’envoi de journaux &#40;SQL Server&#41;](fail-over-to-a-log-shipping-secondary-sql-server.md) et [RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="e7edc-145">For more information, see [Fail Over to a Log Shipping Secondary &#40;SQL Server&#41;](fail-over-to-a-log-shipping-secondary-sql-server.md) and [RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql).</span></span>  
  
4.  <span data-ttu-id="e7edc-146">Restaurez la base de données **msdb** et les bases de données **master** du serveur principal vers le serveur secondaire.</span><span class="sxs-lookup"><span data-stu-id="e7edc-146">Restore the **msdb** database and **master** databases from the primary to the secondary.</span></span> <span data-ttu-id="e7edc-147">Pour plus d’informations, consultez [Sauvegarder et restaurer des bases de données système &#40;SQL Server&#41;](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="e7edc-147">For more information, see [Back Up and Restore of System Databases &#40;SQL Server&#41;](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md).</span></span> <span data-ttu-id="e7edc-148">Si le serveur principal était également un serveur de distribution, restaurez la base de données de distribution du serveur principal sur le serveur secondaire.</span><span class="sxs-lookup"><span data-stu-id="e7edc-148">If the primary was also a Distributor, restore the distribution database from the primary to the secondary.</span></span>  
  
     <span data-ttu-id="e7edc-149">Ces bases de données doivent être cohérentes avec la base de données de publication au niveau du serveur principal en termes de configuration et de paramètres de la réplication.</span><span class="sxs-lookup"><span data-stu-id="e7edc-149">These databases must be consistent with the publication database at the primary in terms of replication configuration and settings.</span></span>  
  
5.  <span data-ttu-id="e7edc-150">Au niveau du serveur secondaire, renommez l'ordinateur, puis l'instance [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] d'après le nom du serveur principal.</span><span class="sxs-lookup"><span data-stu-id="e7edc-150">At the secondary server, rename the computer and then rename the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] instance to match the primary server name.</span></span> <span data-ttu-id="e7edc-151">Pour plus d'informations sur la modification du nom de l'ordinateur, consultez la documentation Windows.</span><span class="sxs-lookup"><span data-stu-id="e7edc-151">For information about renaming the computer, see the Windows documentation.</span></span> <span data-ttu-id="e7edc-152">Pour plus d’informations sur le renommage du serveur, consultez [Renommer un ordinateur qui héberge une instance autonome de SQL Server](../install-windows/rename-a-computer-that-hosts-a-stand-alone-instance-of-sql-server.md) et [Renommer une instance de cluster de basculement SQL Server](../../sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance.md).</span><span class="sxs-lookup"><span data-stu-id="e7edc-152">For information about renaming the server, see [Rename a Computer that Hosts a Stand-Alone Instance of SQL Server](../install-windows/rename-a-computer-that-hosts-a-stand-alone-instance-of-sql-server.md) and [Rename a SQL Server Failover Cluster Instance](../../sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance.md).</span></span>  
  
6.  <span data-ttu-id="e7edc-153">Au niveau du serveur secondaire, restaurez la clé principale du service qui a été sauvegardée depuis le serveur principal.</span><span class="sxs-lookup"><span data-stu-id="e7edc-153">At the secondary server, restore the service master key that was backed up from the primary.</span></span> <span data-ttu-id="e7edc-154">Pour plus d’informations, consultez [RESTORE SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-service-master-key-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="e7edc-154">For more information, see [RESTORE SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-service-master-key-transact-sql).</span></span>  
  
 <span data-ttu-id="e7edc-155">**Pour configurer la réplication transactionnelle et la copie des journaux de transaction sans l'option sync with backup**</span><span class="sxs-lookup"><span data-stu-id="e7edc-155">**To configure transactional replication and log shipping without the sync with backup option**</span></span>  
  
1.  <span data-ttu-id="e7edc-156">Configurez la copie des journaux de transaction pour la base de données de publication.</span><span class="sxs-lookup"><span data-stu-id="e7edc-156">Configure log shipping for the publication database.</span></span> <span data-ttu-id="e7edc-157">Pour plus d’informations, consultez [Configurer la copie des journaux de transaction &#40;Transact-SQL&#41;](configure-log-shipping-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="e7edc-157">For more information, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span>  
  
2.  <span data-ttu-id="e7edc-158">Lorsque le serveur de publication tombe en panne, restaurez le dernier journal de la base de données sur le serveur secondaire en utilisant l'option KEEP_REPLICATION de RESTORE LOG.</span><span class="sxs-lookup"><span data-stu-id="e7edc-158">If the Publisher fails, restore the last log of the database to the secondary server, using the KEEP_REPLICATION option of RESTORE LOG.</span></span> <span data-ttu-id="e7edc-159">De cette façon, vous conservez tous les paramètres de réplication pour la base de données.</span><span class="sxs-lookup"><span data-stu-id="e7edc-159">This retains all replication settings for the database.</span></span> <span data-ttu-id="e7edc-160">Pour plus d’informations, consultez [Basculer vers un serveur secondaire d’envoi de journaux &#40;SQL Server&#41;](fail-over-to-a-log-shipping-secondary-sql-server.md) et [RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="e7edc-160">For more information, see [Fail Over to a Log Shipping Secondary &#40;SQL Server&#41;](fail-over-to-a-log-shipping-secondary-sql-server.md) and [RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql).</span></span>  
  
3.  <span data-ttu-id="e7edc-161">Restaurez la base de données **msdb** et les bases de données **master** du serveur principal vers le serveur secondaire.</span><span class="sxs-lookup"><span data-stu-id="e7edc-161">Restore the **msdb** database and **master** databases from the primary to the secondary.</span></span> <span data-ttu-id="e7edc-162">Pour plus d’informations, consultez [Sauvegarder et restaurer des bases de données système &#40;SQL Server&#41;](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="e7edc-162">For more information, see [Back Up and Restore of System Databases &#40;SQL Server&#41;](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md).</span></span> <span data-ttu-id="e7edc-163">Si le serveur principal était également un serveur de distribution, restaurez la base de données de distribution du serveur principal sur le serveur secondaire.</span><span class="sxs-lookup"><span data-stu-id="e7edc-163">If the primary was also a Distributor, restore the distribution database from the primary to the secondary.</span></span>  
  
     <span data-ttu-id="e7edc-164">Ces bases de données doivent être cohérentes avec la base de données de publication au niveau du serveur principal en termes de configuration et de paramètres de la réplication.</span><span class="sxs-lookup"><span data-stu-id="e7edc-164">These databases must be consistent with the publication database at the primary in terms of replication configuration and settings.</span></span>  
  
4.  <span data-ttu-id="e7edc-165">Au niveau du serveur secondaire, renommez l'ordinateur, puis l'instance [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] d'après le nom du serveur principal.</span><span class="sxs-lookup"><span data-stu-id="e7edc-165">At the secondary server, rename the computer and then rename the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] instance to match the primary server name.</span></span> <span data-ttu-id="e7edc-166">Pour plus d'informations sur la modification du nom de l'ordinateur, consultez la documentation Windows.</span><span class="sxs-lookup"><span data-stu-id="e7edc-166">For information about renaming the computer, see the Windows documentation.</span></span> <span data-ttu-id="e7edc-167">Pour plus d’informations sur le renommage du serveur, consultez [Renommer un ordinateur qui héberge une instance autonome de SQL Server](../install-windows/rename-a-computer-that-hosts-a-stand-alone-instance-of-sql-server.md) et [Renommer une instance de cluster de basculement SQL Server](../../sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance.md).</span><span class="sxs-lookup"><span data-stu-id="e7edc-167">For information about renaming the server, see [Rename a Computer that Hosts a Stand-Alone Instance of SQL Server](../install-windows/rename-a-computer-that-hosts-a-stand-alone-instance-of-sql-server.md) and [Rename a SQL Server Failover Cluster Instance](../../sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance.md).</span></span>  
  
     <span data-ttu-id="e7edc-168">Vous pouvez recevoir un message d'erreur de l'Agent de lecture du journal indiquant que la base de données de publication et la base de données de distribution ne sont pas synchronisées.</span><span class="sxs-lookup"><span data-stu-id="e7edc-168">You might receive an error message from the Log Reader Agent that the publication database and the distribution database are not synchronized.</span></span>  
  
5.  <span data-ttu-id="e7edc-169">Au niveau du serveur secondaire, restaurez la clé principale du service qui a été sauvegardée depuis le serveur principal.</span><span class="sxs-lookup"><span data-stu-id="e7edc-169">At the secondary server, restore the service master key that was backed up from the primary.</span></span> <span data-ttu-id="e7edc-170">Pour plus d’informations, consultez [RESTORE SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-service-master-key-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="e7edc-170">For more information, see [RESTORE SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-service-master-key-transact-sql).</span></span>  
  
6.  <span data-ttu-id="e7edc-171">Exécutez **sp_replrestart**.</span><span class="sxs-lookup"><span data-stu-id="e7edc-171">Execute **sp_replrestart**.</span></span> <span data-ttu-id="e7edc-172">Cette procédure stockée permet d'obliger l'Agent de lecture du journal à ignorer toutes les transactions répliquées précédentes dans le journal de la base de données de publication.</span><span class="sxs-lookup"><span data-stu-id="e7edc-172">This stored procedure can be used to force the Log Reader Agent to ignore all the previous replicated transactions in the publication database log.</span></span> <span data-ttu-id="e7edc-173">Les transactions appliquées après l'exécution de la procédure stockée sont traitées par l'Agent de lecture du journal.</span><span class="sxs-lookup"><span data-stu-id="e7edc-173">Transactions applied after the completion of the stored procedure are processed by the Log Reader Agent.</span></span> <span data-ttu-id="e7edc-174">Pour plus d’informations, consultez [sp_replrestart &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-replrestart-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="e7edc-174">For more information, see [sp_replrestart &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-replrestart-transact-sql).</span></span>  
  
7.  <span data-ttu-id="e7edc-175">Redémarrez l'Agent de lecture du journal après exécution correcte de la procédure stockée.</span><span class="sxs-lookup"><span data-stu-id="e7edc-175">Restart the Log Reader Agent after the stored procedure executes successfully.</span></span> <span data-ttu-id="e7edc-176">Pour plus d’informations, consultez [Démarrer et arrêter un Agent de réplication &#40;SQL Server Management Studio&#41;](../../relational-databases/replication/agents/start-and-stop-a-replication-agent-sql-server-management-studio.md).</span><span class="sxs-lookup"><span data-stu-id="e7edc-176">For more information, see [Start and Stop a Replication Agent &#40;SQL Server Management Studio&#41;](../../relational-databases/replication/agents/start-and-stop-a-replication-agent-sql-server-management-studio.md).</span></span>  
  
8.  <span data-ttu-id="e7edc-177">Les transactions qui ont déjà été distribuées à l'Abonné peuvent être appliquées au serveur de publication.</span><span class="sxs-lookup"><span data-stu-id="e7edc-177">Transactions that have already been distributed to Subscriber might be applied at the Publisher.</span></span> <span data-ttu-id="e7edc-178">Pour être sûr que l’agent de distribution poursuivra le traitement en dépit d’une erreur rencontrée lors de la réapplication des transactions sur un Abonné, spécifiez le profil de l’agent intitulé **Continuer avec les erreurs de cohérence des données**.</span><span class="sxs-lookup"><span data-stu-id="e7edc-178">To ensure that the Distribution Agent does not fail with an error when attempting to reapply these transactions at a Subscriber, specify the agent profile titled **Continue On Data Consistency Errors**.</span></span>  
  
### <a name="log-shipping-with-merge-replication"></a><span data-ttu-id="e7edc-179">Copie des journaux de transaction et réplication de fusion</span><span class="sxs-lookup"><span data-stu-id="e7edc-179">Log Shipping with Merge Replication</span></span>  
 <span data-ttu-id="e7edc-180">Suivez les étapes de la procédure ci-dessous pour configurer la réplication de fusion et la copie des journaux de transaction.</span><span class="sxs-lookup"><span data-stu-id="e7edc-180">Follow the steps in the procedure below to configure merge replication and log shipping.</span></span>  
  
 <span data-ttu-id="e7edc-181">**Pour configurer la réplication de fusion et la copie des journaux de transaction**</span><span class="sxs-lookup"><span data-stu-id="e7edc-181">**To configure merge replication and log shipping**</span></span>  
  
1.  <span data-ttu-id="e7edc-182">Configurez la copie des journaux de transaction pour la base de données de publication.</span><span class="sxs-lookup"><span data-stu-id="e7edc-182">Configure log shipping for the publication database.</span></span> <span data-ttu-id="e7edc-183">Pour plus d’informations, consultez [Configurer la copie des journaux de transaction &#40;Transact-SQL&#41;](configure-log-shipping-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="e7edc-183">For more information, see [Configure Log Shipping &#40;SQL Server&#41;](configure-log-shipping-sql-server.md).</span></span>  
  
2.  <span data-ttu-id="e7edc-184">Si le serveur de publication tombe en panne, au niveau du serveur secondaire, renommez l'ordinateur, puis l'instance [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] d'après le nom du serveur principal.</span><span class="sxs-lookup"><span data-stu-id="e7edc-184">If the Publisher fails, at the secondary server, rename the computer and then rename the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] instance to match the primary server name.</span></span> <span data-ttu-id="e7edc-185">Pour plus d'informations sur la modification du nom de l'ordinateur, consultez la documentation Windows.</span><span class="sxs-lookup"><span data-stu-id="e7edc-185">For information about renaming the computer, see the Windows documentation.</span></span> <span data-ttu-id="e7edc-186">Pour plus d’informations sur le renommage du serveur, consultez [Renommer un ordinateur qui héberge une instance autonome de SQL Server](../install-windows/rename-a-computer-that-hosts-a-stand-alone-instance-of-sql-server.md) et [Renommer une instance de cluster de basculement SQL Server](../../sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance.md).</span><span class="sxs-lookup"><span data-stu-id="e7edc-186">For information about renaming the server, see [Rename a Computer that Hosts a Stand-Alone Instance of SQL Server](../install-windows/rename-a-computer-that-hosts-a-stand-alone-instance-of-sql-server.md) and [Rename a SQL Server Failover Cluster Instance](../../sql-server/failover-clusters/install/rename-a-sql-server-failover-cluster-instance.md).</span></span>  
  
3.  <span data-ttu-id="e7edc-187">Restaurez le dernier journal de la base de données sur le serveur secondaire en utilisant l'option KEEP_REPLICATION de RESTORE LOG.</span><span class="sxs-lookup"><span data-stu-id="e7edc-187">Restore the last log of the database to the secondary server, using the KEEP_REPLICATION option of RESTORE LOG.</span></span> <span data-ttu-id="e7edc-188">De cette façon, vous conservez tous les paramètres de réplication pour la base de données.</span><span class="sxs-lookup"><span data-stu-id="e7edc-188">This retains all replication settings for the database.</span></span> <span data-ttu-id="e7edc-189">Pour plus d’informations, consultez [Basculer vers un serveur secondaire d’envoi de journaux &#40;SQL Server&#41;](fail-over-to-a-log-shipping-secondary-sql-server.md) et [RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="e7edc-189">For more information, see [Fail Over to a Log Shipping Secondary &#40;SQL Server&#41;](fail-over-to-a-log-shipping-secondary-sql-server.md) and [RESTORE &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-statements-transact-sql).</span></span>  
  
4.  <span data-ttu-id="e7edc-190">Restaurez la base de données **msdb** et les bases de données **master** du serveur principal vers le serveur secondaire.</span><span class="sxs-lookup"><span data-stu-id="e7edc-190">Restore the **msdb** database and **master** databases from the primary to the secondary.</span></span> <span data-ttu-id="e7edc-191">Pour plus d’informations, consultez [Sauvegarder et restaurer des bases de données système &#40;SQL Server&#41;](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="e7edc-191">For more information, see [Back Up and Restore of System Databases &#40;SQL Server&#41;](../../relational-databases/backup-restore/back-up-and-restore-of-system-databases-sql-server.md).</span></span> <span data-ttu-id="e7edc-192">Si le serveur principal était également un serveur de distribution, restaurez la base de données de distribution du serveur principal sur le serveur secondaire.</span><span class="sxs-lookup"><span data-stu-id="e7edc-192">If the primary was also a Distributor, restore the distribution database from the primary to the secondary.</span></span>  
  
     <span data-ttu-id="e7edc-193">Ces bases de données doivent être cohérentes avec la base de données de publication au niveau du serveur principal en termes de configuration et de paramètres de la réplication.</span><span class="sxs-lookup"><span data-stu-id="e7edc-193">These databases must be consistent with the publication database at the primary in terms of replication configuration and settings.</span></span>  
  
5.  <span data-ttu-id="e7edc-194">Au niveau du serveur secondaire, restaurez la clé principale du service qui a été sauvegardée depuis le serveur principal.</span><span class="sxs-lookup"><span data-stu-id="e7edc-194">At the secondary server, restore the service master key that was backed up from the primary.</span></span> <span data-ttu-id="e7edc-195">Pour plus d’informations, consultez [RESTORE SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-service-master-key-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="e7edc-195">For more information, see [RESTORE SERVICE MASTER KEY &#40;Transact-SQL&#41;](/sql/t-sql/statements/restore-service-master-key-transact-sql).</span></span>  
  
6.  <span data-ttu-id="e7edc-196">Synchronisez la base de données de publication avec une ou plusieurs bases de données d'abonnement.</span><span class="sxs-lookup"><span data-stu-id="e7edc-196">Synchronize the publication database with one or more subscription databases.</span></span> <span data-ttu-id="e7edc-197">Cela vous permet de télécharger les modifications qui ont été apportées précédemment à la base de données de publication mais qui ne figurent pas dans la sauvegarde restaurée.</span><span class="sxs-lookup"><span data-stu-id="e7edc-197">This allows you to upload those changes made previously in the publication database, but not represented in the restored backup.</span></span> <span data-ttu-id="e7edc-198">Les données qui peuvent être chargées dépendent de la façon dont une publication est filtrée :</span><span class="sxs-lookup"><span data-stu-id="e7edc-198">The data that can be uploaded depends on the way in which a publication is filtered:</span></span>  
  
    -   <span data-ttu-id="e7edc-199">Si la publication n'est pas filtrée, vous devriez pouvoir mettre à jour la base de données de publication en la synchronisant avec l'Abonné le plus à jour.</span><span class="sxs-lookup"><span data-stu-id="e7edc-199">If the publication is not filtered, you should be able to bring the publication database up-to-date by synchronizing with the most up-to-date Subscriber.</span></span>  
  
    -   <span data-ttu-id="e7edc-200">Si la publication est filtrée, il est possible que vous ne puissiez pas mettre à jour la base de données de publication.</span><span class="sxs-lookup"><span data-stu-id="e7edc-200">If the publication is filtered, you might not be able to bring the publication database up-to-date.</span></span> <span data-ttu-id="e7edc-201">Prenez une table qui est partitionnée de telle façon que chaque abonnement reçoit des données client seulement pour une région : Nord, Est, Sud et Ouest.</span><span class="sxs-lookup"><span data-stu-id="e7edc-201">Consider a table that is partitioned such that each subscription receives customer data only for a single region: North, East, South, and West.</span></span> <span data-ttu-id="e7edc-202">S'il y a au moins un Abonné pour chaque partition de données, la synchronisation avec un Abonné pour chaque partition doit permettre la mise à jour de la base de données de publication.</span><span class="sxs-lookup"><span data-stu-id="e7edc-202">If there is at least one Subscriber for each partition of data, synchronizing with a Subscriber for each partition should bring the publication database up-to-date.</span></span> <span data-ttu-id="e7edc-203">Cependant, si par exemple des données de la partition Ouest n'ont été répliquées vers aucun des Abonnés, ces données ne peuvent pas être mises à jour au niveau du serveur de publication.</span><span class="sxs-lookup"><span data-stu-id="e7edc-203">However, if data in the West partition, for example, was not replicated to any Subscribers, this data at the Publisher cannot be brought up-to-date.</span></span> <span data-ttu-id="e7edc-204">Dans ce cas, nous vous conseillons de réinitialiser tous les abonnements de façon à ce que les données du serveur de publication et des Abonnés convergent.</span><span class="sxs-lookup"><span data-stu-id="e7edc-204">In this case, we recommend reinitializing all subscriptions so that the data at the Publisher and Subscribers converges.</span></span> <span data-ttu-id="e7edc-205">Pour plus d’informations, consultez [Réinitialiser des abonnements](../../relational-databases/replication/reinitialize-subscriptions.md).</span><span class="sxs-lookup"><span data-stu-id="e7edc-205">For more information, see [Reinitialize Subscriptions](../../relational-databases/replication/reinitialize-subscriptions.md).</span></span>  
  
     <span data-ttu-id="e7edc-206">Si la synchronisation se fait avec un Abonné exécutant une version de [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] antérieure à [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)], l'abonnement ne peut pas être anonyme. Il doit s'agir d'un abonnement client ou d'un abonnement serveur (appelées abonnement local et abonnement global dans les versions précédentes).</span><span class="sxs-lookup"><span data-stu-id="e7edc-206">If you synchronize with a Subscriber that is running a version of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] prior to [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)], the subscription cannot be anonymous; it must be a client subscription or server subscription (referred to as local subscriptions and global subscriptions in previous releases).</span></span> <span data-ttu-id="e7edc-207">Pour plus d’informations, consultez [Synchroniser les données](../../relational-databases/replication/synchronize-data.md).</span><span class="sxs-lookup"><span data-stu-id="e7edc-207">For more information, see [Synchronize Data](../../relational-databases/replication/synchronize-data.md).</span></span>   
  
## <a name="see-also"></a><span data-ttu-id="e7edc-208">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="e7edc-208">See Also</span></span>  
 <span data-ttu-id="e7edc-209">[Réplication SQL Server](../../relational-databases/replication/sql-server-replication.md) </span><span class="sxs-lookup"><span data-stu-id="e7edc-209">[SQL Server Replication](../../relational-databases/replication/sql-server-replication.md) </span></span>  
 <span data-ttu-id="e7edc-210">[À propos de la copie des journaux des transactions &#40;SQL Server&#41;](about-log-shipping-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="e7edc-210">[About Log Shipping &#40;SQL Server&#41;](about-log-shipping-sql-server.md) </span></span>  
 [<span data-ttu-id="e7edc-211">Mise en miroir de bases de données et réplication &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="e7edc-211">Database Mirroring and Replication &#40;SQL Server&#41;</span></span>](../database-mirroring/database-mirroring-and-replication-sql-server.md)  
  
  
