---
title: Guide du verrouillage des transactions et du contrôle de version de ligne SQL Server | Microsoft Docs
ms.custom: ''
ms.date: 01/24/2019
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
ms.assetid: c7757153-9697-4f01-881c-800e254918c9
author: rothja
ms.author: jroth
ms.openlocfilehash: c79f9997249568c88409394441d28c71da453d63
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87601852"
---
# <a name="sql-server-transaction-locking-and-row-versioning-guide"></a><span data-ttu-id="968d3-102">Guide du verrouillage des transactions et du contrôle de version de ligne SQL Server</span><span class="sxs-lookup"><span data-stu-id="968d3-102">SQL Server Transaction Locking and Row Versioning Guide</span></span>

  <span data-ttu-id="968d3-103">Dans une base de données, une mauvaise gestion des transactions conduit souvent à des problèmes de contention et de détérioration des performances dans les systèmes comprenant de nombreux utilisateurs.</span><span class="sxs-lookup"><span data-stu-id="968d3-103">In any database, mismanagement of transactions often leads to contention and performance problems in systems that have many users.</span></span> <span data-ttu-id="968d3-104">Plus le nombre d'utilisateurs qui ont accès aux données est grand, plus il est important que les applications utilisent les transactions de manière efficace.</span><span class="sxs-lookup"><span data-stu-id="968d3-104">As the number of users that access the data increases, it becomes important to have applications that use transactions efficiently.</span></span> <span data-ttu-id="968d3-105">Ce guide présente les mécanismes de verrouillage et de contrôle de version de ligne utilisés par le [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] pour garantir l'intégrité physique de chaque transaction et contient des informations sur la façon dont les applications peuvent contrôler efficacement les transactions.</span><span class="sxs-lookup"><span data-stu-id="968d3-105">This guide describes the locking and row versioning mechanisms the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] uses to ensure the physical integrity of each transaction and provides information on how applications can control transactions efficiently.</span></span>  
  
<span data-ttu-id="968d3-106">**S’applique à**: [!INCLUDE[ssVersion2005](../includes/ssversion2005-md.md)] jusqu’à [!INCLUDE[ssCurrent](../includes/sscurrent-md.md)] , sauf indication contraire.</span><span class="sxs-lookup"><span data-stu-id="968d3-106">**Applies to**: [!INCLUDE[ssVersion2005](../includes/ssversion2005-md.md)] through [!INCLUDE[ssCurrent](../includes/sscurrent-md.md)] unless noted otherwise.</span></span>  
  
##  <a name="in-this-guide"></a><a name="Top"></a><span data-ttu-id="968d3-107">Dans ce guide</span><span class="sxs-lookup"><span data-stu-id="968d3-107">In This Guide</span></span>  

 [<span data-ttu-id="968d3-108">Notions de base des transactions</span><span class="sxs-lookup"><span data-stu-id="968d3-108">Transaction Basics</span></span>](#Basics)  
  
 [<span data-ttu-id="968d3-109">Notions de base sur le verrouillage et le contrôle de version de ligne</span><span class="sxs-lookup"><span data-stu-id="968d3-109">Locking and Row Versioning Basics</span></span>](#Lock_Basics)  
  
 [<span data-ttu-id="968d3-110">Verrouillage dans le Moteur de base de données</span><span class="sxs-lookup"><span data-stu-id="968d3-110">Locking in the Database Engine</span></span>](#Lock_Engine)  
  
 [<span data-ttu-id="968d3-111">Niveaux d'isolation basés sur le contrôle de version de ligne dans le moteur de base de données</span><span class="sxs-lookup"><span data-stu-id="968d3-111">Row Versioning-based Isolation Levels in the Database Engine</span></span>](#Row_versioning)  
  
 [<span data-ttu-id="968d3-112">Personnalisation du verrouillage d’un index</span><span class="sxs-lookup"><span data-stu-id="968d3-112">Customizing Locking for an Index</span></span>](#Customize)  
  
 [<span data-ttu-id="968d3-113">Informations sur les transactions avancées</span><span class="sxs-lookup"><span data-stu-id="968d3-113">Advanced Transaction Information</span></span>](#Advanced)  
  
##  <a name="transaction-basics"></a><a name="Basics"></a> <span data-ttu-id="968d3-114">Principes de base sur les transactions</span><span class="sxs-lookup"><span data-stu-id="968d3-114">Transaction Basics</span></span>  

 <span data-ttu-id="968d3-115">Une transaction est une suite d'opérations effectuées comme une seule unité logique de travail.</span><span class="sxs-lookup"><span data-stu-id="968d3-115">A transaction is a sequence of operations performed as a single logical unit of work.</span></span> <span data-ttu-id="968d3-116">Une unité logique de travail doit posséder quatre propriétés appelées propriétés ACID (Atomicité, Cohérence, Isolation et Durabilité), pour être considérée comme une transaction :</span><span class="sxs-lookup"><span data-stu-id="968d3-116">A logical unit of work must exhibit four properties, called the atomicity, consistency, isolation, and durability (ACID) properties, to qualify as a transaction.</span></span>  
  
 <span data-ttu-id="968d3-117">Atomicité</span><span class="sxs-lookup"><span data-stu-id="968d3-117">Atomicity</span></span>  
 <span data-ttu-id="968d3-118">Une transaction doit être une unité de travail indivisible ; soit toutes les modifications de données sont effectuées, soit aucune ne l'est.</span><span class="sxs-lookup"><span data-stu-id="968d3-118">A transaction must be an atomic unit of work; either all of its data modifications are performed, or none of them are performed.</span></span>  
  
 <span data-ttu-id="968d3-119">Cohérence</span><span class="sxs-lookup"><span data-stu-id="968d3-119">Consistency</span></span>  
 <span data-ttu-id="968d3-120">Lorsqu'elle est terminée, une transaction doit laisser les données dans un état cohérent.</span><span class="sxs-lookup"><span data-stu-id="968d3-120">When completed, a transaction must leave all data in a consistent state.</span></span> <span data-ttu-id="968d3-121">Dans une base de données relationnelle, toutes les règles doivent être appliquées aux modifications apportées par la transaction, afin de conserver l'intégrité de toutes les données.</span><span class="sxs-lookup"><span data-stu-id="968d3-121">In a relational database, all rules must be applied to the transaction's modifications to maintain all data integrity.</span></span> <span data-ttu-id="968d3-122">Toutes les structures de données internes, comme les index B-tree ou les listes à chaînage double, doivent être cohérentes à la fin de la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-122">All internal data structures, such as B-tree indexes or doubly-linked lists, must be correct at the end of the transaction.</span></span>  
  
 <span data-ttu-id="968d3-123">Isolation</span><span class="sxs-lookup"><span data-stu-id="968d3-123">Isolation</span></span>  
 <span data-ttu-id="968d3-124">Les modifications effectuées par des transactions concurrentes doivent être isolées transaction par transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-124">Modifications made by concurrent transactions must be isolated from the modifications made by any other concurrent transactions.</span></span> <span data-ttu-id="968d3-125">Une transaction reconnaît les données dans l'état où elles se trouvaient avant d'être modifiées par une transaction simultanée, ou les reconnaît une fois que la deuxième transaction est terminée, mais ne reconnaît jamais un état intermédiaire.</span><span class="sxs-lookup"><span data-stu-id="968d3-125">A transaction either recognizes data in the state it was in before another concurrent transaction modified it, or it recognizes the data after the second transaction has completed, but it does not recognize an intermediate state.</span></span> <span data-ttu-id="968d3-126">Cette propriété est nommée mise en série, car elle permet de recharger les données de départ et de répéter une suite de transactions dont le résultat sur les données sera identique à celui des transactions d'origine.</span><span class="sxs-lookup"><span data-stu-id="968d3-126">This is referred to as serializability because it results in the ability to reload the starting data and replay a series of transactions to end up with the data in the same state it was in after the original transactions were performed.</span></span>  
  
 <span data-ttu-id="968d3-127">Durabilité</span><span class="sxs-lookup"><span data-stu-id="968d3-127">Durability</span></span>  
 <span data-ttu-id="968d3-128">Lorsqu'une transaction durable est terminée, ses effets sur le système sont permanents.</span><span class="sxs-lookup"><span data-stu-id="968d3-128">After a fully durable transaction has completed, its effects are permanently in place in the system.</span></span> <span data-ttu-id="968d3-129">Les modifications sont conservées même en cas de défaillance du système.</span><span class="sxs-lookup"><span data-stu-id="968d3-129">The modifications persist even in the event of a system failure.</span></span> [!INCLUDE[ssSQL14](../includes/sssql14-md.md)] <span data-ttu-id="968d3-130">et versions ultérieures permettent les transactions durables retardées.</span><span class="sxs-lookup"><span data-stu-id="968d3-130">and later enable delayed durable transactions.</span></span> <span data-ttu-id="968d3-131">Les transactions durables retardées sont validées avant de consigner l'enregistrement du journal des transactions sur le disque.</span><span class="sxs-lookup"><span data-stu-id="968d3-131">Delayed durable transactions commit before the transaction log record is persisted to disk.</span></span> <span data-ttu-id="968d3-132">Pour plus d’informations sur la durabilité des transactions retardées, consultez la rubrique [Durabilité des transactions](../relational-databases/logs/control-transaction-durability.md).</span><span class="sxs-lookup"><span data-stu-id="968d3-132">For more information on delayed transaction durability see the topic [Transaction Durability](../relational-databases/logs/control-transaction-durability.md).</span></span>  
  
 <span data-ttu-id="968d3-133">Les programmeurs SQL doivent concevoir des transactions dont les points de début et de fin permettent de maintenir la cohérence logique des données.</span><span class="sxs-lookup"><span data-stu-id="968d3-133">SQL programmers are responsible for starting and ending transactions at points that enforce the logical consistency of the data.</span></span> <span data-ttu-id="968d3-134">La séquence de modifications des données qu'ils définissent doivent laisser les données dans un état cohérent par rapport aux règles d'entreprise définies par leur société.</span><span class="sxs-lookup"><span data-stu-id="968d3-134">The programmer must define the sequence of data modifications that leave the data in a consistent state relative to the organization's business rules.</span></span> <span data-ttu-id="968d3-135">Ces instructions de modification des données doivent par conséquent être contenues dans une seule transaction pour que le [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] puisse garantir l'intégrité physique de la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-135">The programmer includes these modification statements in a single transaction so that the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] can enforce the physical integrity of the transaction.</span></span>  
  
 <span data-ttu-id="968d3-136">Un système de base de données d'entreprise, par exemple une instance de [!INCLUDE[ssDE](../includes/ssde-md.md)], se doit de fournir des mécanismes permettant de garantir l'intégrité physique de chaque transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-136">It is the responsibility of an enterprise database system, such as an instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)], to provide mechanisms ensuring the physical integrity of each transaction.</span></span> <span data-ttu-id="968d3-137">Le [!INCLUDE[ssDE](../includes/ssde-md.md)] fournit les éléments suivants :</span><span class="sxs-lookup"><span data-stu-id="968d3-137">The [!INCLUDE[ssDE](../includes/ssde-md.md)] provides:</span></span>  
  
-   <span data-ttu-id="968d3-138">Des fonctionnalités de verrouillage permettant d'assurer l'isolement des transactions.</span><span class="sxs-lookup"><span data-stu-id="968d3-138">Locking facilities that preserve transaction isolation.</span></span>  
  
-   <span data-ttu-id="968d3-139">Des fonctionnalités de consignation assurent la durabilité des transactions.</span><span class="sxs-lookup"><span data-stu-id="968d3-139">Logging facilities ensure transaction durability.</span></span> <span data-ttu-id="968d3-140">Pour les transactions durables, l'enregistrement du journal est renforcé sur le disque avant les validations des transactions.</span><span class="sxs-lookup"><span data-stu-id="968d3-140">For fully durable transactions the log record is hardened to disk before the transactions commits.</span></span> <span data-ttu-id="968d3-141">Ainsi, en cas de défaillance du matériel serveur, du système d’exploitation ou de l’instance du [!INCLUDE[ssDE](../includes/ssde-md.md)] lui-même, l’instance utilise au redémarrage les journaux des transactions pour restaurer automatiquement toutes les transactions incomplètes jusqu’au moment de la défaillance du système.</span><span class="sxs-lookup"><span data-stu-id="968d3-141">Thus, even if the server hardware, operating system, or the instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] itself fails, the instance uses the transaction logs upon restart to automatically roll back any uncompleted transactions to the point of the system failure.</span></span> <span data-ttu-id="968d3-142">Les transactions durables retardées sont validées avant de renforcer l'enregistrement du journal des transactions sur le disque.</span><span class="sxs-lookup"><span data-stu-id="968d3-142">Delayed durable transactions commit before the transaction log record is hardened to disk.</span></span> <span data-ttu-id="968d3-143">Ces transactions peuvent être perdues en cas de défaillance du système avant que l'enregistrement du journal ne soit renforcé sur le disque.</span><span class="sxs-lookup"><span data-stu-id="968d3-143">Such transactions may be lost if there is a system failure before the log record is hardened to disk.</span></span> <span data-ttu-id="968d3-144">Pour plus d’informations sur la durabilité des transactions retardées, consultez la rubrique [Durabilité des transactions](../relational-databases/logs/control-transaction-durability.md).</span><span class="sxs-lookup"><span data-stu-id="968d3-144">For more information on delayed transaction durability see the topic [Transaction Durability](../relational-databases/logs/control-transaction-durability.md).</span></span>  
  
-   <span data-ttu-id="968d3-145">Des fonctionnalités de gestion des transactions qui assurent l'atomicité et la cohérence des transactions.</span><span class="sxs-lookup"><span data-stu-id="968d3-145">Transaction management features that enforce transaction atomicity and consistency.</span></span> <span data-ttu-id="968d3-146">Lorsqu'une transaction a débuté, elle doit se dérouler correctement jusqu'à la fin (validée), sans quoi l'instance du [!INCLUDE[ssDE](../includes/ssde-md.md)] annule toutes les modifications effectuées sur les données depuis le début de la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-146">After a transaction has started, it must be successfully completed (committed), or the [!INCLUDE[ssDE](../includes/ssde-md.md)] undoes all of the data modifications made since the transaction started.</span></span> <span data-ttu-id="968d3-147">Cette opération est appelée restauration d'une transaction, car elle retourne les données telles qu'elles étaient avant ces modifications.</span><span class="sxs-lookup"><span data-stu-id="968d3-147">This operation is referred to as rolling back a transaction because it returns the data to the state it was prior to those changes.</span></span>  
  
### <a name="controlling-transactions"></a><span data-ttu-id="968d3-148">Contrôle des transactions</span><span class="sxs-lookup"><span data-stu-id="968d3-148">Controlling Transactions</span></span>  

 <span data-ttu-id="968d3-149">Le contrôle des transactions par les applications consiste principalement à spécifier des points de début et de fin de chaque transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-149">Applications control transactions mainly by specifying when a transaction starts and ends.</span></span> <span data-ttu-id="968d3-150">La spécification est effectuée à l'aide des instructions [!INCLUDE[tsql](../includes/tsql-md.md)] ou des fonctions d'API de base de données.</span><span class="sxs-lookup"><span data-stu-id="968d3-150">This can be specified by using either [!INCLUDE[tsql](../includes/tsql-md.md)] statements or database application programming interface (API) functions.</span></span> <span data-ttu-id="968d3-151">Le système doit aussi être capable de gérer les erreurs interrompant une transaction avant sa fin normale.</span><span class="sxs-lookup"><span data-stu-id="968d3-151">The system must also be able to correctly handle errors that terminate a transaction before it completes.</span></span> <span data-ttu-id="968d3-152">Pour plus d’informations, consultez [instructions de Transaction &#40;&#41;Transact-SQL ](/sql/t-sql/language-elements/transactions-transact-sql), [transactions dans ODBC](https://technet.microsoft.com/library/ms131281.aspx) et [transactions dans SQL Server Native Client (OleDb)](https://msdn.microsoft.com/library/ms130918.aspx).</span><span class="sxs-lookup"><span data-stu-id="968d3-152">For more information, see [Transaction Statements &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/transactions-transact-sql), [Transactions in ODBC](https://technet.microsoft.com/library/ms131281.aspx) and [Transactions in SQL Server Native Client (OLEDB)](https://msdn.microsoft.com/library/ms130918.aspx).</span></span>  
  
 <span data-ttu-id="968d3-153">Par défaut, les transactions sont gérées au niveau de la connexion.</span><span class="sxs-lookup"><span data-stu-id="968d3-153">By default, transactions are managed at the connection level.</span></span> <span data-ttu-id="968d3-154">Lorsqu'une transaction est démarrée lors d'une connexion, toutes les instructions [!INCLUDE[tsql](../includes/tsql-md.md)] exécutées lors de cette connexion font partie de la transaction jusqu'à la fin de celle-ci.</span><span class="sxs-lookup"><span data-stu-id="968d3-154">When a transaction is started on a connection, all [!INCLUDE[tsql](../includes/tsql-md.md)] statements executed on that connection are part of the transaction until the transaction ends.</span></span> <span data-ttu-id="968d3-155">Toutefois, dans une session MARS (Multiple Active Result Set), une transaction [!INCLUDE[tsql](../includes/tsql-md.md)] explicite ou implicite devient une transaction dont l'étendue est définie par traitement gérée au niveau du lot.</span><span class="sxs-lookup"><span data-stu-id="968d3-155">However, under a multiple active result set (MARS) session, a [!INCLUDE[tsql](../includes/tsql-md.md)] explicit or implicit transaction becomes a batch-scoped transaction that is managed at the batch level.</span></span> <span data-ttu-id="968d3-156">À la fin du traitement, si une transaction dont l'étendue est définie par traitement n'est pas validée ou restaurée, elle est automatiquement restaurée par [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="968d3-156">When the batch completes, if the batch-scoped transaction is not committed or rolled back, it is automatically rolled back by [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="968d3-157">Pour plus d’informations, consultez [mars (Multiple Active Result Sets) dans SQL Server](https://msdn.microsoft.com/library/ms345109(v=SQL.90).aspx).</span><span class="sxs-lookup"><span data-stu-id="968d3-157">For more information, see [Multiple Active Result Sets (MARS) in SQL Server](https://msdn.microsoft.com/library/ms345109(v=SQL.90).aspx).</span></span>  
  
#### <a name="starting-transactions"></a><span data-ttu-id="968d3-158">Démarrage des transactions</span><span class="sxs-lookup"><span data-stu-id="968d3-158">Starting Transactions</span></span>  

 <span data-ttu-id="968d3-159">À l'aide des fonctions API et des instructions [!INCLUDE[tsql](../includes/tsql-md.md)], vous pouvez démarrer des transactions en mode explicite, implicite ou validation automatique dans les instances du [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="968d3-159">Using API functions and [!INCLUDE[tsql](../includes/tsql-md.md)] statements, you can start transactions in an instance of the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] as explicit, autocommit, or implicit transactions.</span></span>  
  
 <span data-ttu-id="968d3-160">**Transactions explicites**</span><span class="sxs-lookup"><span data-stu-id="968d3-160">**Explicit Transactions**</span></span>  
 <span data-ttu-id="968d3-161">Une transaction est explicite si vous définissez le début et la fin de la transaction de manière explicite à l’aide d’une fonction API ou en exécutant les instructions [!INCLUDE[tsql](../includes/tsql-md.md)] BEGIN TRANSACTION, COMMIT TRANSACTION, COMMIT WORK, ROLLBACK TRANSACTION ou ROLLBACK WORK[!INCLUDE[tsql](../includes/tsql-md.md)].</span><span class="sxs-lookup"><span data-stu-id="968d3-161">An explicit transaction is one in which you explicitly define both the start and end of the transaction through an API function or by issuing the [!INCLUDE[tsql](../includes/tsql-md.md)] BEGIN TRANSACTION, COMMIT TRANSACTION, COMMIT WORK, ROLLBACK TRANSACTION, or ROLLBACK WORK [!INCLUDE[tsql](../includes/tsql-md.md)] statements.</span></span> <span data-ttu-id="968d3-162">À la fin de la transaction, la connexion revient au mode de transaction sélectionné avant le début de la transaction, c'est-à-dire implicite ou autocommit.</span><span class="sxs-lookup"><span data-stu-id="968d3-162">When the transaction ends, the connection returns to the transaction mode it was in before the explicit transaction was started, either implicit or autocommit mode.</span></span>  
  
 <span data-ttu-id="968d3-163">Vous pouvez utiliser toutes les instructions [!INCLUDE[tsql](../includes/tsql-md.md)] dans une transaction explicite, à l'exception des instructions suivantes :</span><span class="sxs-lookup"><span data-stu-id="968d3-163">You can use all [!INCLUDE[tsql](../includes/tsql-md.md)] statements in an explicit transaction, except for the following statements:</span></span>  
  
||||  
|-|-|-|  
|<span data-ttu-id="968d3-164">ALTER DATABASE</span><span class="sxs-lookup"><span data-stu-id="968d3-164">ALTER DATABASE</span></span>|<span data-ttu-id="968d3-165">CREATE DATABASE</span><span class="sxs-lookup"><span data-stu-id="968d3-165">CREATE DATABASE</span></span>|<span data-ttu-id="968d3-166">DROP FULLTEXT INDEX</span><span class="sxs-lookup"><span data-stu-id="968d3-166">DROP FULLTEXT INDEX</span></span>|  
|<span data-ttu-id="968d3-167">ALTER FULLTEXT CATALOG</span><span class="sxs-lookup"><span data-stu-id="968d3-167">ALTER FULLTEXT CATALOG</span></span>|<span data-ttu-id="968d3-168">CREATE FULLTEXT CATALOG</span><span class="sxs-lookup"><span data-stu-id="968d3-168">CREATE FULLTEXT CATALOG</span></span>|<span data-ttu-id="968d3-169">RECONFIGURE</span><span class="sxs-lookup"><span data-stu-id="968d3-169">RECONFIGURE</span></span>|  
|<span data-ttu-id="968d3-170">ALTER FULLTEXT INDEX</span><span class="sxs-lookup"><span data-stu-id="968d3-170">ALTER FULLTEXT INDEX</span></span>|<span data-ttu-id="968d3-171">CREATE FULLTEXT INDEX</span><span class="sxs-lookup"><span data-stu-id="968d3-171">CREATE FULLTEXT INDEX</span></span>|<span data-ttu-id="968d3-172">RESTORE</span><span class="sxs-lookup"><span data-stu-id="968d3-172">RESTORE</span></span>|  
|<span data-ttu-id="968d3-173">BACKUP</span><span class="sxs-lookup"><span data-stu-id="968d3-173">BACKUP</span></span>|<span data-ttu-id="968d3-174">DROP DATABASE</span><span class="sxs-lookup"><span data-stu-id="968d3-174">DROP DATABASE</span></span>|<span data-ttu-id="968d3-175">Procédures stockées système de recherche en texte intégral</span><span class="sxs-lookup"><span data-stu-id="968d3-175">Full-text system stored procedures</span></span>|  
|<span data-ttu-id="968d3-176">CREATE DATABASE</span><span class="sxs-lookup"><span data-stu-id="968d3-176">CREATE DATABASE</span></span>|<span data-ttu-id="968d3-177">DROP FULLTEXT CATALOG</span><span class="sxs-lookup"><span data-stu-id="968d3-177">DROP FULLTEXT CATALOG</span></span>|<span data-ttu-id="968d3-178">Option sp_dboption pour définir les options de base de données, ou une des procédures système qui modifient la base de données master à l'intérieur de transactions explicites ou implicites.</span><span class="sxs-lookup"><span data-stu-id="968d3-178">sp_dboption to set database options or any system procedure that modifies the master database inside explicit or implicit transactions.</span></span>|  
  
> [!NOTE]  
>  <span data-ttu-id="968d3-179">UPDATE STATISTICS peut être utilisée à l'intérieur d'une transaction explicite.</span><span class="sxs-lookup"><span data-stu-id="968d3-179">UPDATE STATISTICS can be used inside an explicit transaction.</span></span> <span data-ttu-id="968d3-180">Toutefois, UPDATE STATISTICS est validée indépendamment de la transaction qui la contient et ne peut pas être restaurée.</span><span class="sxs-lookup"><span data-stu-id="968d3-180">However, UPDATE STATISTICS commits independently of the enclosing transaction and cannot be rolled back.</span></span>  
  
 <span data-ttu-id="968d3-181">**Transactions en mode de validation automatique**</span><span class="sxs-lookup"><span data-stu-id="968d3-181">**Autocommit Transactions**</span></span>  
 <span data-ttu-id="968d3-182">Le mode de validation automatique (autocommit) est le mode de gestion par défaut des transactions du moteur de base de données SQL Server.</span><span class="sxs-lookup"><span data-stu-id="968d3-182">Autocommit mode is the default transaction management mode of the SQL Server Database Engine.</span></span> <span data-ttu-id="968d3-183">Chaque instruction Transact-SQL est validée ou restaurée dès qu'elle se termine.</span><span class="sxs-lookup"><span data-stu-id="968d3-183">Every Transact-SQL statement is committed or rolled back when it completes.</span></span> <span data-ttu-id="968d3-184">Lorsqu'une instruction est exécutée avec succès, elle est validée ; si une erreur se produit, elle est restaurée.</span><span class="sxs-lookup"><span data-stu-id="968d3-184">If a statement completes successfully, it is committed; if it encounters any error, it is rolled back.</span></span> <span data-ttu-id="968d3-185">Une connexion à une instance du moteur de base de données fonctionne par défaut en mode de validation automatique si les modes explicite ou implicite n'ont pas été spécifiés pour une transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-185">A connection to an instance of the Database Engine operates in autocommit mode whenever this default mode has not been overridden by either explicit or implicit transactions.</span></span> <span data-ttu-id="968d3-186">Le mode autocommit est également le mode par défaut pour ADO, OLE DB, ODBC et DB-Library.</span><span class="sxs-lookup"><span data-stu-id="968d3-186">Autocommit mode is also the default mode for ADO, OLE DB, ODBC, and DB-Library.</span></span>  
  
 <span data-ttu-id="968d3-187">**Transactions implicites**</span><span class="sxs-lookup"><span data-stu-id="968d3-187">**Implicit Transactions**</span></span>  
 <span data-ttu-id="968d3-188">Lorsqu'une connexion fonctionne en mode de transaction implicite, l'instance du moteur de base de données démarre automatiquement une nouvelle transaction après la validation ou la restauration de la transaction en cours.</span><span class="sxs-lookup"><span data-stu-id="968d3-188">When a connection is operating in implicit transaction mode, the instance of the Database Engine automatically starts a new transaction after the current transaction is committed or rolled back.</span></span> <span data-ttu-id="968d3-189">Vous n'avez pas à définir le début d'une transaction, il vous suffit de valider ou de restaurer chaque transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-189">You do nothing to delineate the start of a transaction; you only commit or roll back each transaction.</span></span> <span data-ttu-id="968d3-190">Le mode de transaction implicite génère une succession continue de transactions.</span><span class="sxs-lookup"><span data-stu-id="968d3-190">Implicit transaction mode generates a continuous chain of transactions.</span></span> <span data-ttu-id="968d3-191">Activez le mode de transaction implicite en utilisant une fonction d'API ou l'instruction [!INCLUDE[tsql](../includes/tsql-md.md)] SET IMPLICIT_TRANSACTIONS ON.</span><span class="sxs-lookup"><span data-stu-id="968d3-191">Set implicit transaction mode on through either an API function or the [!INCLUDE[tsql](../includes/tsql-md.md)] SET IMPLICIT_TRANSACTIONS ON statement.</span></span>  
  
 <span data-ttu-id="968d3-192">Lorsque le mode de transaction implicite est activé pour une connexion, l'instance de [!INCLUDE[ssDE](../includes/ssde-md.md)] démarre automatiquement une transaction lorsqu'il exécute pour la première fois l'une des instructions suivantes :</span><span class="sxs-lookup"><span data-stu-id="968d3-192">After implicit transaction mode has been set on for a connection, the instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] automatically starts a transaction when it first executes any of these statements:</span></span>  
  
||||  
|-|-|-|  
|<span data-ttu-id="968d3-193">ALTER TABLE</span><span class="sxs-lookup"><span data-stu-id="968d3-193">ALTER TABLE</span></span>|<span data-ttu-id="968d3-194">FETCH</span><span class="sxs-lookup"><span data-stu-id="968d3-194">FETCH</span></span>|<span data-ttu-id="968d3-195">REVOKE</span><span class="sxs-lookup"><span data-stu-id="968d3-195">REVOKE</span></span>|  
|<span data-ttu-id="968d3-196">CREATE</span><span class="sxs-lookup"><span data-stu-id="968d3-196">CREATE</span></span>|<span data-ttu-id="968d3-197">GRANT</span><span class="sxs-lookup"><span data-stu-id="968d3-197">GRANT</span></span>|<span data-ttu-id="968d3-198">SELECT</span><span class="sxs-lookup"><span data-stu-id="968d3-198">SELECT</span></span>|  
|<span data-ttu-id="968d3-199">Suppression</span><span class="sxs-lookup"><span data-stu-id="968d3-199">DELETE</span></span>|<span data-ttu-id="968d3-200">INSERT</span><span class="sxs-lookup"><span data-stu-id="968d3-200">INSERT</span></span>|<span data-ttu-id="968d3-201">TRUNCATE TABLE</span><span class="sxs-lookup"><span data-stu-id="968d3-201">TRUNCATE TABLE</span></span>|  
|<span data-ttu-id="968d3-202">DROP</span><span class="sxs-lookup"><span data-stu-id="968d3-202">DROP</span></span>|<span data-ttu-id="968d3-203">OPEN</span><span class="sxs-lookup"><span data-stu-id="968d3-203">OPEN</span></span>|<span data-ttu-id="968d3-204">UPDATE</span><span class="sxs-lookup"><span data-stu-id="968d3-204">UPDATE</span></span>|  
  
 <span data-ttu-id="968d3-205">**Transactions délimitées au traitement**</span><span class="sxs-lookup"><span data-stu-id="968d3-205">**Batch-scoped Transactions**</span></span>  
 <span data-ttu-id="968d3-206">Uniquement applicable aux ensembles de résultats MARS (Multiple Active Result Sets), une transaction [!INCLUDE[tsql](../includes/tsql-md.md)] explicite ou implicite qui démarre sous une session MARS devient une transaction dont l'étendue est définie par traitement.</span><span class="sxs-lookup"><span data-stu-id="968d3-206">Applicable only to multiple active result sets (MARS), a [!INCLUDE[tsql](../includes/tsql-md.md)] explicit or implicit transaction that starts under a MARS session becomes a batch-scoped transaction.</span></span> <span data-ttu-id="968d3-207">Une transaction dont l'étendue est définie par traitement qui n'est pas validée ou restaurée à la fin du traitement est automatiquement restaurée par [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="968d3-207">A batch-scoped transaction that is not committed or rolled back when a batch completes is automatically rolled back by [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span>  
  
 <span data-ttu-id="968d3-208">**Transactions distribuées**</span><span class="sxs-lookup"><span data-stu-id="968d3-208">**Distributed Transactions**</span></span>  
 <span data-ttu-id="968d3-209">Les transactions distribuées sont réparties sur plusieurs serveurs nommés gestionnaires de ressources.</span><span class="sxs-lookup"><span data-stu-id="968d3-209">Distributed transactions span two or more servers known as resource managers.</span></span> <span data-ttu-id="968d3-210">La gestion de la transaction doit être coordonnée entre les gestionnaires de ressources par un composant du serveur nommé gestionnaire de transactions.</span><span class="sxs-lookup"><span data-stu-id="968d3-210">The management of the transaction must be coordinated between the resource managers by a server component called a transaction manager.</span></span> <span data-ttu-id="968d3-211">Chaque instance du [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] peut être utilisée comme gestionnaire de ressources dans les transactions distribuées coordonnées par un gestionnaire de transactions tel que MS DTC ([!INCLUDE[msCoName](../includes/msconame-md.md)] Distributed Transaction Coordinator), ou tout autre gestionnaire de transactions prenant en charge les spécifications Open Group XA pour le traitement des transactions distribuées.</span><span class="sxs-lookup"><span data-stu-id="968d3-211">Each instance of the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] can operate as a resource manager in distributed transactions coordinated by transaction managers, such as [!INCLUDE[msCoName](../includes/msconame-md.md)] Distributed Transaction Coordinator (MS DTC), or other transaction managers that support the Open Group XA specification for distributed transaction processing.</span></span> <span data-ttu-id="968d3-212">Pour plus d'informations, consultez la documentation MS DTC.</span><span class="sxs-lookup"><span data-stu-id="968d3-212">For more information, see the MS DTC documentation.</span></span>  
  
 <span data-ttu-id="968d3-213">Une transaction exécutée sur une seule instance du [!INCLUDE[ssDE](../includes/ssde-md.md)], mais utilisant plusieurs bases de données, est en réalité une transaction distribuée.</span><span class="sxs-lookup"><span data-stu-id="968d3-213">A transaction within a single instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] that spans two or more databases is actually a distributed transaction.</span></span> <span data-ttu-id="968d3-214">Cette instance gère la transaction distribuée de manière interne ; elle apparaît comme une transaction locale pour l'utilisateur.</span><span class="sxs-lookup"><span data-stu-id="968d3-214">The instance manages the distributed transaction internally; to the user, it operates as a local transaction.</span></span>  
  
 <span data-ttu-id="968d3-215">Dans une application, une transaction distribuée est gérée de manière comparable à une transaction locale.</span><span class="sxs-lookup"><span data-stu-id="968d3-215">At the application, a distributed transaction is managed much the same as a local transaction.</span></span> <span data-ttu-id="968d3-216">À la fin de la transaction, l'application requiert que la transaction soit validée ou restaurée.</span><span class="sxs-lookup"><span data-stu-id="968d3-216">At the end of the transaction, the application requests the transaction to be either committed or rolled back.</span></span> <span data-ttu-id="968d3-217">La validation d'une transaction distribuée doit être gérée de façon particulière par le gestionnaire de transaction pour minimiser les risques qu'une défaillance du réseau entraîne la validation de la transaction par certains gestionnaires de ressources, alors qu'elle sera restaurée par d'autres.</span><span class="sxs-lookup"><span data-stu-id="968d3-217">A distributed commit must be managed differently by the transaction manager to minimize the risk that a network failure may result in some resource managers successfully committing while others roll back the transaction.</span></span> <span data-ttu-id="968d3-218">Pour cela, le processus de validation est géré en deux phases, une phase de préparation et une phase de validation, d'où son nom de validation à deux phases (2PC).</span><span class="sxs-lookup"><span data-stu-id="968d3-218">This is achieved by managing the commit process in two phases (the prepare phase and the commit phase), which is known as a two-phase commit (2PC).</span></span>  
  
 <span data-ttu-id="968d3-219">Phase de préparation</span><span class="sxs-lookup"><span data-stu-id="968d3-219">Prepare phase</span></span>  
 <span data-ttu-id="968d3-220">Lorsque le gestionnaire de transactions reçoit une requête de validation, il envoie une commande de préparation à tous les gestionnaires de ressources concernés par la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-220">When the transaction manager receives a commit request, it sends a prepare command to all of the resource managers involved in the transaction.</span></span> <span data-ttu-id="968d3-221">Chaque gestionnaire de ressources effectue alors toutes les opérations nécessaires à l'enregistrement de la transaction, et tous les tampons contenant les images du journal de la transaction sont vidés sur le disque.</span><span class="sxs-lookup"><span data-stu-id="968d3-221">Each resource manager then does everything required to make the transaction durable, and all buffers holding log images for the transaction are flushed to disk.</span></span> <span data-ttu-id="968d3-222">Lorsque chaque gestionnaire de ressources a terminé la phase de préparation, il retourne un message de succès ou d'échec au gestionnaire de transactions.</span><span class="sxs-lookup"><span data-stu-id="968d3-222">As each resource manager completes the prepare phase, it returns success or failure of the prepare to the transaction manager.</span></span> [!INCLUDE[ssSQL14](../includes/sssql14-md.md)] <span data-ttu-id="968d3-223">a introduit la durabilité des transactions retardées.</span><span class="sxs-lookup"><span data-stu-id="968d3-223">introduced delayed transaction durability.</span></span> <span data-ttu-id="968d3-224">Les transactions durables retardées sont validées avant de vider les images de journal pour la transaction sur le disque.</span><span class="sxs-lookup"><span data-stu-id="968d3-224">Delayed durable transactions commit before log images for the transaction are flushed to disk.</span></span> <span data-ttu-id="968d3-225">Pour plus d’informations sur la durabilité des transactions retardées, consultez la rubrique [Durabilité des transactions](../relational-databases/logs/control-transaction-durability.md).</span><span class="sxs-lookup"><span data-stu-id="968d3-225">For more information on delayed transaction durability see the topic [Transaction Durability](../relational-databases/logs/control-transaction-durability.md).</span></span>  
  
 <span data-ttu-id="968d3-226">Phase de validation</span><span class="sxs-lookup"><span data-stu-id="968d3-226">Commit phase</span></span>  
 <span data-ttu-id="968d3-227">Si le gestionnaire de transactions reçoit des messages de préparation réussie de tous les gestionnaires de ressources, il envoie une commande de validation à chacun d'entre eux.</span><span class="sxs-lookup"><span data-stu-id="968d3-227">If the transaction manager receives successful prepares from all of the resource managers, it sends commit commands to each resource manager.</span></span> <span data-ttu-id="968d3-228">Les gestionnaires de ressources peuvent alors effectuer la validation.</span><span class="sxs-lookup"><span data-stu-id="968d3-228">The resource managers can then complete the commit.</span></span> <span data-ttu-id="968d3-229">Si tous les gestionnaires de ressources signalent le succès de la validation, le gestionnaire de transactions envoie alors une notification de succès à l'application.</span><span class="sxs-lookup"><span data-stu-id="968d3-229">If all of the resource managers report a successful commit, the transaction manager then sends a success notification to the application.</span></span> <span data-ttu-id="968d3-230">Si l'un des gestionnaires de ressources indique un échec de la préparation, le gestionnaire de transactions envoie une commande de restauration à chaque gestionnaire de ressources et notifie l'échec de la validation à l'application.</span><span class="sxs-lookup"><span data-stu-id="968d3-230">If any resource manager reported a failure to prepare, the transaction manager sends a rollback command to each resource manager and indicates the failure of the commit to the application.</span></span>  
  
 <span data-ttu-id="968d3-231">Les applications du [!INCLUDE[ssDE](../includes/ssde-md.md)] peuvent gérer les transactions distribuées à l'aide de [!INCLUDE[tsql](../includes/tsql-md.md)] ou de l'API de base de données.</span><span class="sxs-lookup"><span data-stu-id="968d3-231">[!INCLUDE[ssDE](../includes/ssde-md.md)] applications can manage distributed transactions either through [!INCLUDE[tsql](../includes/tsql-md.md)] or the database API.</span></span> <span data-ttu-id="968d3-232">Pour plus d’informations, consultez [BEGIN DISTRIBUTED TRANSACTION &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/begin-distributed-transaction-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="968d3-232">For more information, see [BEGIN DISTRIBUTED TRANSACTION &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/begin-distributed-transaction-transact-sql).</span></span>  
  
#### <a name="ending-transactions"></a><span data-ttu-id="968d3-233">Fin des transactions</span><span class="sxs-lookup"><span data-stu-id="968d3-233">Ending Transactions</span></span>  

 <span data-ttu-id="968d3-234">Terminez les transactions avec une instruction COMMIT ou ROLLBACK, ou au moyen d'une fonction API correspondante.</span><span class="sxs-lookup"><span data-stu-id="968d3-234">You can end transactions with either a COMMIT or ROLLBACK statement, or through a corresponding API function.</span></span>  
  
 <span data-ttu-id="968d3-235">COMMIT</span><span class="sxs-lookup"><span data-stu-id="968d3-235">COMMIT</span></span>  
 <span data-ttu-id="968d3-236">Si une transaction est réussie, validez-la.</span><span class="sxs-lookup"><span data-stu-id="968d3-236">If a transaction is successful, commit it.</span></span> <span data-ttu-id="968d3-237">L'instruction COMMIT garantit que toutes les modifications effectuées sur la base de données au cours de la transaction sont permanentes.</span><span class="sxs-lookup"><span data-stu-id="968d3-237">A COMMIT statement guarantees all of the transaction's modifications are made a permanent part of the database.</span></span> <span data-ttu-id="968d3-238">Cette instruction libère également les ressources, telles que les verrous, qui ont été utilisées par la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-238">A COMMIT also frees resources, such as locks, used by the transaction.</span></span>  
  
 <span data-ttu-id="968d3-239">ROLLBACK</span><span class="sxs-lookup"><span data-stu-id="968d3-239">ROLLBACK</span></span>  
 <span data-ttu-id="968d3-240">Si une erreur se produit pendant une transaction ou si l'utilisateur décide de l'abandonner, restaurez-la.</span><span class="sxs-lookup"><span data-stu-id="968d3-240">If an error occurs in a transaction, or if the user decides to cancel the transaction, then roll the transaction back.</span></span> <span data-ttu-id="968d3-241">Une instruction ROLLBACK annule toutes les modifications effectuées par la transaction en rétablissant les données dans l'état où elles étaient avant le début de celle-ci.</span><span class="sxs-lookup"><span data-stu-id="968d3-241">A ROLLBACK statement backs out all modifications made in the transaction by returning the data to the state it was in at the start of the transaction.</span></span> <span data-ttu-id="968d3-242">Cette instruction libère également les ressources bloquées par la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-242">A ROLLBACK also frees resources held by the transaction.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="968d3-243">Dans le cas des  connexions prenant en charge les ensembles de résultats MARS (Multiple Active Result Sets), une transaction explicite démarrée par le biais d'une fonction API ne peut pas être validée alors que des demandes sont en attente d'exécution.</span><span class="sxs-lookup"><span data-stu-id="968d3-243">Under connections enabled to support multiple active result sets (MARS), an explicit transaction started through an API function cannot be committed while there are pending requests for execution.</span></span> <span data-ttu-id="968d3-244">Toute tentative de validation d'une transaction de ce type entraîne une erreur si des opérations sont toujours en attente.</span><span class="sxs-lookup"><span data-stu-id="968d3-244">Any attempt to commit this type of  transaction while there are outstanding operations running will result in an error.</span></span>  
  
#### <a name="errors-during-transaction-processing"></a><span data-ttu-id="968d3-245">Erreurs de traitement au cours d'une transaction</span><span class="sxs-lookup"><span data-stu-id="968d3-245">Errors During Transaction Processing</span></span>  

 <span data-ttu-id="968d3-246">Si une erreur entrave le bon déroulement d'une transaction, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] la restaure automatiquement et libère toutes les ressources bloquées par la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-246">If an error prevents the successful completion of a transaction, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] automatically rolls back the transaction and frees all resources held by the transaction.</span></span> <span data-ttu-id="968d3-247">Si la connexion réseau du client à une instance du [!INCLUDE[ssDE](../includes/ssde-md.md)] est interrompue, toutes les transactions en cours associées à cette connexion sont restaurées au moment de la notification de l'instance de l'interruption.</span><span class="sxs-lookup"><span data-stu-id="968d3-247">If the client's network connection to an instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] is broken, any outstanding transactions for the connection are rolled back when the network notifies the instance of the break.</span></span> <span data-ttu-id="968d3-248">En cas de défaillance de l'application cliente et de panne ou de redémarrage de l'ordinateur client, la connexion est interrompue. L'instance du [!INCLUDE[ssDE](../includes/ssde-md.md)] restaure toutes les transactions en cours au moment de la notification de la panne par le réseau.</span><span class="sxs-lookup"><span data-stu-id="968d3-248">If the client application fails or if the client computer goes down or is restarted, this also breaks the connection, and the instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] rolls back any outstanding connections when the network notifies it of the break.</span></span> <span data-ttu-id="968d3-249">Si le client se déconnecte de l'application, toutes les transactions en cours sont restaurées.</span><span class="sxs-lookup"><span data-stu-id="968d3-249">If the client logs off the application, any outstanding transactions are rolled back.</span></span>  
  
 <span data-ttu-id="968d3-250">Si une instruction génère une erreur d'exécution (comme une violation de contrainte) dans un traitement, la réaction par défaut du [!INCLUDE[ssDE](../includes/ssde-md.md)] est de restaurer seulement l'instruction ayant généré l'erreur.</span><span class="sxs-lookup"><span data-stu-id="968d3-250">If a run-time statement error (such as a constraint violation) occurs in a batch, the default behavior in the [!INCLUDE[ssDE](../includes/ssde-md.md)] is to roll back only the statement that generated the error.</span></span> <span data-ttu-id="968d3-251">Vous pouvez modifier ce comportement à l'aide de l'instruction SET XACT_ABORT.</span><span class="sxs-lookup"><span data-stu-id="968d3-251">You can change this behavior using the SET XACT_ABORT statement.</span></span> <span data-ttu-id="968d3-252">Après l'exécution de SET XACT_ABORT ON, toute erreur d'exécution causée par une instruction déclenche automatiquement la restauration de la transaction en cours.</span><span class="sxs-lookup"><span data-stu-id="968d3-252">After SET XACT_ABORT ON is executed, any run-time statement error causes an automatic rollback of the current transaction.</span></span> <span data-ttu-id="968d3-253">Les erreurs de compilation, comme les erreurs de syntaxe, ne sont pas affectées par l'option SET XACT_ABORT.</span><span class="sxs-lookup"><span data-stu-id="968d3-253">Compile errors, such as syntax errors, are not affected by SET XACT_ABORT.</span></span> <span data-ttu-id="968d3-254">Pour plus d’informations, consultez [SET XACT_ABORT &#40;Transact-SQL&#41;](/sql/t-sql/statements/set-xact-abort-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="968d3-254">For more information, see [SET XACT_ABORT &#40;Transact-SQL&#41;](/sql/t-sql/statements/set-xact-abort-transact-sql).</span></span>  
  
 <span data-ttu-id="968d3-255">Quand une erreur se produit, l'action corrective (COMMIT ou ROLLBACK) doit être incluse dans le code de l'application.</span><span class="sxs-lookup"><span data-stu-id="968d3-255">When errors occur, corrective action (COMMIT or ROLLBACK) should be included in application code.</span></span> <span data-ttu-id="968d3-256">L’un des outils efficaces pour gérer les erreurs, y compris ceux qui se trouvent dans les transactions, est le [!INCLUDE[tsql](../includes/tsql-md.md)] bloc try... CATCH.</span><span class="sxs-lookup"><span data-stu-id="968d3-256">One effective tool for handling errors, including those in transactions, is the [!INCLUDE[tsql](../includes/tsql-md.md)] TRY...CATCH construct.</span></span> <span data-ttu-id="968d3-257">Pour plus d’informations et d’exemples portant sur les transactions, consultez [TRY...CATCH &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/try-catch-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="968d3-257">For more information with examples that include transactions, see [TRY...CATCH &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/try-catch-transact-sql).</span></span> <span data-ttu-id="968d3-258">À partir de [!INCLUDE[ssSQL11](../includes/sssql11-md.md)] , vous pouvez utiliser l’instruction throw pour lever une exception et transférer l’exécution à un bloc catch d’une instruction try... CATCH.</span><span class="sxs-lookup"><span data-stu-id="968d3-258">Beginning with [!INCLUDE[ssSQL11](../includes/sssql11-md.md)], you can use the THROW statement to raise an exception and transfers execution to a CATCH block of a TRY...CATCH construct.</span></span> <span data-ttu-id="968d3-259">Pour plus d’informations, consultez [THROW &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/throw-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="968d3-259">For more information, see [THROW &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/throw-transact-sql).</span></span>  
  
##### <a name="compile-and-run-time-errors-in-autocommit-mode"></a><span data-ttu-id="968d3-260">Erreurs de compilation et d'exécution en mode de validation automatique</span><span class="sxs-lookup"><span data-stu-id="968d3-260">Compile and Run-time Errors in Autocommit mode</span></span>  

 <span data-ttu-id="968d3-261">En mode de validation automatique, il peut arriver qu'une instance du [!INCLUDE[ssDE](../includes/ssde-md.md)] semble restaurer un lot entier au lieu d'une instruction SQL unique.</span><span class="sxs-lookup"><span data-stu-id="968d3-261">In autocommit mode, it sometimes appears as if an instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] has rolled back an entire batch instead of just one SQL statement.</span></span> <span data-ttu-id="968d3-262">Ceci se produit en cas d'erreur de compilation et non en cas d'erreur d'exécution.</span><span class="sxs-lookup"><span data-stu-id="968d3-262">This happens if the error encountered is a compile error, not a run-time error.</span></span> <span data-ttu-id="968d3-263">Une erreur de compilation empêche le [!INCLUDE[ssDE](../includes/ssde-md.md)] de créer un plan d'exécution, de telle sorte qu'aucune instruction du traitement n'est exécutée.</span><span class="sxs-lookup"><span data-stu-id="968d3-263">A compile error prevents the [!INCLUDE[ssDE](../includes/ssde-md.md)] from building an execution plan, so nothing in the batch is executed.</span></span> <span data-ttu-id="968d3-264">Bien qu'il semble que toutes les instructions précédant celle qui a produit l'erreur soient restaurées, en réalité l'erreur rend impossible l'exécution de toutes les instructions du lot.</span><span class="sxs-lookup"><span data-stu-id="968d3-264">Although it appears that all of the statements before the one generating the error were rolled back, the error prevented anything in the batch from being executed.</span></span> <span data-ttu-id="968d3-265">Dans l'exemple qui suit, une erreur de compilation empêche l'exécution de toutes les instructions `INSERT` du troisième lot.</span><span class="sxs-lookup"><span data-stu-id="968d3-265">In the following example, none of the `INSERT` statements in the third batch are executed because of a compile error.</span></span> <span data-ttu-id="968d3-266">Les deux premières instructions `INSERT` semblent avoir été restaurées alors qu'elles n'ont en fait jamais été exécutées.</span><span class="sxs-lookup"><span data-stu-id="968d3-266">It appears that the first two `INSERT` statements are rolled back when they are never executed.</span></span>  
  
```sql
CREATE TABLE TestBatch (Cola INT PRIMARY KEY, Colb CHAR(3));  
GO  
INSERT INTO TestBatch VALUES (1, 'aaa');  
INSERT INTO TestBatch VALUES (2, 'bbb');  
INSERT INTO TestBatch VALUSE (3, 'ccc');  -- Syntax error.  
GO  
SELECT * FROM TestBatch;  -- Returns no rows.  
GO  
```  
  
 <span data-ttu-id="968d3-267">Dans l'exemple ci-dessous, la troisième instruction `INSERT` génère une erreur d'exécution causée par une clé primaire en double.</span><span class="sxs-lookup"><span data-stu-id="968d3-267">In the following example, the third `INSERT` statement generates a run-time duplicate primary key error.</span></span> <span data-ttu-id="968d3-268">Les deux premières instructions `INSERT` étant correctes et validées, elles ne sont pas restaurées après l'erreur d'exécution.</span><span class="sxs-lookup"><span data-stu-id="968d3-268">The first two `INSERT` statements are successful and committed, so they remain after the run-time error.</span></span>  
  
```sql  
CREATE TABLE TestBatch (Cola INT PRIMARY KEY, Colb CHAR(3));  
GO  
INSERT INTO TestBatch VALUES (1, 'aaa');  
INSERT INTO TestBatch VALUES (2, 'bbb');  
INSERT INTO TestBatch VALUES (1, 'ccc');  -- Duplicate key error.  
GO  
SELECT * FROM TestBatch;  -- Returns rows 1 and 2.  
GO  
```  
  
 <span data-ttu-id="968d3-269">Le [!INCLUDE[ssDE](../includes/ssde-md.md)] introduit la résolution de nom différée, dans laquelle la résolution des noms d’objet est effectuée au moment de l’exécution seulement.</span><span class="sxs-lookup"><span data-stu-id="968d3-269">The [!INCLUDE[ssDE](../includes/ssde-md.md)] uses deferred name resolution, in which object names are not resolved until execution time.</span></span> <span data-ttu-id="968d3-270">Dans l'exemple suivant, les deux premières instructions `INSERT` sont exécutées et validées, et ces deux lignes restent dans la table `TestBatch`, même une fois que la référence à une table inexistante dans la troisième instruction `INSERT` a généré une erreur d'exécution.</span><span class="sxs-lookup"><span data-stu-id="968d3-270">In the following example, the first two `INSERT` statements are executed and committed, and those two rows remain in the `TestBatch` table after the third `INSERT` statement generates a run-time error by referring to a table that does not exist.</span></span>  
  
```sql
CREATE TABLE TestBatch (Cola INT PRIMARY KEY, Colb CHAR(3));  
GO  
INSERT INTO TestBatch VALUES (1, 'aaa');  
INSERT INTO TestBatch VALUES (2, 'bbb');  
INSERT INTO TestBch VALUES (3, 'ccc');  -- Table name error.  
GO  
SELECT * FROM TestBatch;  -- Returns rows 1 and 2.  
GO  
```  
  
 <span data-ttu-id="968d3-271">![Icône de flèche utilisée avec le lien retour au début](media/uparrow16x16.gif "Icône de flèche utilisée avec le lien Retour en haut") [dans ce guide](#Top)</span><span class="sxs-lookup"><span data-stu-id="968d3-271">![Arrow icon used with Back to Top link](media/uparrow16x16.gif "Arrow icon used with Back to Top link") [In This Guide](#Top)</span></span>  
  
##  <a name="locking-and-row-versioning-basics"></a><a name="Lock_Basics"></a> <span data-ttu-id="968d3-272">Principes de base sur le verrouillage et le contrôle de version de ligne</span><span class="sxs-lookup"><span data-stu-id="968d3-272">Locking and Row Versioning Basics</span></span>  

 <span data-ttu-id="968d3-273">Le [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] utilise les mécanismes suivants pour garantir l'intégrité des transactions et gérer la cohérence des bases de données lorsque plusieurs utilisateurs accèdent simultanément aux données :</span><span class="sxs-lookup"><span data-stu-id="968d3-273">The [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] uses the following mechanisms to ensure the integrity of transactions and maintain the consistency of databases when multiple users are accessing data at the same time:</span></span>  
  
-   <span data-ttu-id="968d3-274">Verrouillage</span><span class="sxs-lookup"><span data-stu-id="968d3-274">Locking</span></span>  
  
     <span data-ttu-id="968d3-275">Chaque transaction demande des verrous de différents types sur les ressources dont elle dépend, telles que les lignes, les pages ou les tables.</span><span class="sxs-lookup"><span data-stu-id="968d3-275">Each transaction requests locks of different types on the resources, such as rows, pages, or tables, on which the transaction is dependent.</span></span> <span data-ttu-id="968d3-276">Les verrous demandés empêchent les autres transactions d'apporter aux ressources des modifications susceptibles de nuire à la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-276">The locks block other transactions from modifying the resources in a way that would cause problems for the transaction requesting the lock.</span></span> <span data-ttu-id="968d3-277">Chaque transaction libère ses verrous lorsqu'elle ne dépend plus des ressources verrouillées.</span><span class="sxs-lookup"><span data-stu-id="968d3-277">Each transaction frees its locks when it no longer has a dependency on the locked resources.</span></span>  
  
-   <span data-ttu-id="968d3-278">Contrôle de version de ligne</span><span class="sxs-lookup"><span data-stu-id="968d3-278">Row versioning</span></span>  
  
     <span data-ttu-id="968d3-279">Lorsqu'un niveau d'isolement basé sur le contrôle de version de ligne est activé, le [!INCLUDE[ssDE](../includes/ssde-md.md)] gère les versions de chaque ligne modifiée.</span><span class="sxs-lookup"><span data-stu-id="968d3-279">When a row versioning-based isolation level is enabled, the [!INCLUDE[ssDE](../includes/ssde-md.md)] maintains versions of each row that is modified.</span></span> <span data-ttu-id="968d3-280">Les applications peuvent, au lieu de protéger toutes les lectures avec des verrous, spécifier qu'une transaction utilise les versions de ligne pour consulter les données telles qu'elles existaient à son démarrage ou à l'exécution de la requête.</span><span class="sxs-lookup"><span data-stu-id="968d3-280">Applications can specify that a transaction use the row versions to view data as it existed at the start of the transaction or query instead of protecting all reads with locks.</span></span> <span data-ttu-id="968d3-281">L'utilisation du contrôle de version de ligne réduit sensiblement le risque qu'une opération de lecture bloque les autres transactions.</span><span class="sxs-lookup"><span data-stu-id="968d3-281">By using row versioning, the chance that a read operation will block other transactions is greatly reduced.</span></span>  
  
 <span data-ttu-id="968d3-282">Le verrouillage et le contrôle de version de ligne empêchent les utilisateurs de lire les données non validées et plusieurs utilisateurs de modifier simultanément les mêmes données.</span><span class="sxs-lookup"><span data-stu-id="968d3-282">Locking and row versioning prevent users from reading uncommitted data and prevent multiple users from attempting to change the same data at the same time.</span></span> <span data-ttu-id="968d3-283">Sans le verrouillage ou le contrôle de version de ligne, les requêtes exécutées sur ces données pourraient produire des résultats inattendus en retournant des données qui ne sont pas encore validées dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="968d3-283">Without locking or row versioning, queries executed against that data could produce unexpected results by returning data that has not yet been committed in the database.</span></span>  
  
 <span data-ttu-id="968d3-284">Les applications peuvent choisir les niveaux d'isolement de transaction, qui définissent le niveau de protection d'une transaction contre les modifications apportées par les autres transactions.</span><span class="sxs-lookup"><span data-stu-id="968d3-284">Applications can choose transaction isolation levels, which define the level of protection for the transaction from modifications made by other transactions.</span></span> <span data-ttu-id="968d3-285">Vous pouvez spécifier des indicateurs de table pour des instructions [!INCLUDE[tsql](../includes/tsql-md.md)] spécifiques en fonction des besoins de l'application.</span><span class="sxs-lookup"><span data-stu-id="968d3-285">Table-level hints can be specified for individual [!INCLUDE[tsql](../includes/tsql-md.md)] statements to further tailor behavior to fit the requirements of the application.</span></span>  
  
### <a name="managing-concurrent-data-access"></a><span data-ttu-id="968d3-286">Gestion de l'accès concurrentiel aux données</span><span class="sxs-lookup"><span data-stu-id="968d3-286">Managing Concurrent Data Access</span></span>  

 <span data-ttu-id="968d3-287">Lorsque plusieurs utilisateurs accèdent à une ressource en même temps, on parle d'accès concurrentiel.</span><span class="sxs-lookup"><span data-stu-id="968d3-287">Users who access a resource at the same time are said to be accessing the resource concurrently.</span></span> <span data-ttu-id="968d3-288">L'accès concurrentiel aux données requiert certains mécanismes permettant de contrer les effets négatifs de la modification d'une ressource déjà en cours d'utilisation.</span><span class="sxs-lookup"><span data-stu-id="968d3-288">Concurrent data access requires mechanisms to prevent adverse effects when multiple users try to modify resources that other users are actively using.</span></span>  
  
#### <a name="concurrency-effects"></a><span data-ttu-id="968d3-289">Effet des accès concurrentiels</span><span class="sxs-lookup"><span data-stu-id="968d3-289">Concurrency Effects</span></span>  

 <span data-ttu-id="968d3-290">Les utilisateurs qui modifient des données peuvent interférer avec d'autres utilisateurs en train de lire ou de modifier les mêmes données en même temps.</span><span class="sxs-lookup"><span data-stu-id="968d3-290">Users modifying data can affect other users who are reading or modifying the same data at the same time.</span></span> <span data-ttu-id="968d3-291">On dit que ces utilisateurs accèdent aux données de manière concurrentielle.</span><span class="sxs-lookup"><span data-stu-id="968d3-291">These users are said to be accessing the data concurrently.</span></span> <span data-ttu-id="968d3-292">Si un système de stockage de données est dépourvu de contrôle des accès concurrentiels, les utilisateurs peuvent constater les effets secondaires suivants :</span><span class="sxs-lookup"><span data-stu-id="968d3-292">If a data storage system has no concurrency control, users could see the following side effects:</span></span>  
  
-   <span data-ttu-id="968d3-293">Mises à jour perdues</span><span class="sxs-lookup"><span data-stu-id="968d3-293">Lost updates</span></span>  
  
     <span data-ttu-id="968d3-294">Les mises à jour perdues se produisent lorsque deux transactions ou plus sélectionnent la même ligne, puis la mettent à jour en fonction de la valeur qui s'y trouvait à l'origine.</span><span class="sxs-lookup"><span data-stu-id="968d3-294">Lost updates occur when two or more transactions select the same row and then update the row based on the value originally selected.</span></span> <span data-ttu-id="968d3-295">Aucune transaction n'a connaissance des autres transactions.</span><span class="sxs-lookup"><span data-stu-id="968d3-295">Each transaction is unaware of the other transactions.</span></span> <span data-ttu-id="968d3-296">La dernière mise à jour écrase les mises à jour effectuées par les autres transactions, ce qui entraîne une perte de données.</span><span class="sxs-lookup"><span data-stu-id="968d3-296">The last update overwrites updates made by the other transactions, which results in lost data.</span></span>  
  
     <span data-ttu-id="968d3-297">Exemple : deux éditeurs font une copie électronique du même document.</span><span class="sxs-lookup"><span data-stu-id="968d3-297">For example, two editors make an electronic copy of the same document.</span></span> <span data-ttu-id="968d3-298">Chaque éditeur modifie son document et l'enregistre ensuite, en écrasant le document original.</span><span class="sxs-lookup"><span data-stu-id="968d3-298">Each editor changes the copy independently and then saves the changed copy thereby overwriting the original document.</span></span> <span data-ttu-id="968d3-299">Le dernier éditeur à avoir enregistré le document écrase les modifications effectuées par l'autre éditeur.</span><span class="sxs-lookup"><span data-stu-id="968d3-299">The editor who saves the changed copy last overwrites the changes made by the other editor.</span></span> <span data-ttu-id="968d3-300">Le problème pourrait être évité en empêchant un éditeur d'accéder au fichier tant que l'autre éditeur n'a pas terminé et validé la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-300">This problem could be avoided if one editor could not access the file until the other editor had finished and committed the transaction.</span></span>  
  
-   <span data-ttu-id="968d3-301">Dépendance non validée (lecture erronée)</span><span class="sxs-lookup"><span data-stu-id="968d3-301">Uncommitted dependency (dirty read)</span></span>  
  
     <span data-ttu-id="968d3-302">Une dépendance non validée se produit lorsqu'une deuxième transaction sélectionne une ligne qui est actuellement mise à jour par une autre transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-302">Uncommitted dependency occurs when a second transaction selects a row that is being updated by another transaction.</span></span> <span data-ttu-id="968d3-303">La deuxième transaction lit les données qui n'ont pas encore été validées et qui peuvent être modifiées par la transaction de mise à jour de la ligne.</span><span class="sxs-lookup"><span data-stu-id="968d3-303">The second transaction is reading data that has not been committed yet and may be changed by the transaction updating the row.</span></span>  
  
     <span data-ttu-id="968d3-304">Supposons par exemple qu'un éditeur effectue des modifications dans un document électronique.</span><span class="sxs-lookup"><span data-stu-id="968d3-304">For example, an editor is making changes to an electronic document.</span></span> <span data-ttu-id="968d3-305">Pendant les modifications, un second éditeur fait une copie du document comprenant toutes les modifications effectuées jusqu'alors et distribue ce dernier aux destinataires concernés.</span><span class="sxs-lookup"><span data-stu-id="968d3-305">During the changes, a second editor takes a copy of the document that includes all the changes made so far, and distributes the document to the intended audience.</span></span> <span data-ttu-id="968d3-306">Le premier éditeur décide alors que les modifications effectuées sont incorrectes, les supprime et enregistre le document.</span><span class="sxs-lookup"><span data-stu-id="968d3-306">The first editor then decides the changes made so far are wrong and removes the edits and saves the document.</span></span> <span data-ttu-id="968d3-307">Le document qui a été distribué comprend donc des modifications qui n'existent plus et devraient être traitées comme si elles n'avaient jamais existé.</span><span class="sxs-lookup"><span data-stu-id="968d3-307">The distributed document contains edits that no longer exist and should be treated as if they never existed.</span></span> <span data-ttu-id="968d3-308">Le problème pourrait être évité en interdisant la lecture du document modifié tant que le premier éditeur n'a pas effectué l'enregistrement final des modifications et validé la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-308">This problem could be avoided if no one could read the changed document until the first editor does the final save of modifications and commits the transaction.</span></span>  
  
-   <span data-ttu-id="968d3-309">Analyse incohérente (lecture non reproductible)</span><span class="sxs-lookup"><span data-stu-id="968d3-309">Inconsistent analysis (nonrepeatable read)</span></span>  
  
     <span data-ttu-id="968d3-310">Une analyse incohérente se produit lorsqu'une deuxième transaction accède à la même ligne plusieurs fois et lit différentes données à chaque fois.</span><span class="sxs-lookup"><span data-stu-id="968d3-310">Inconsistent analysis occurs when a second transaction accesses the same row several times and reads different data each time.</span></span> <span data-ttu-id="968d3-311">Une analyse incohérente est similaire à une dépendance non validée en ce sens qu'une autre transaction change les données qu'une deuxième transaction est en train de lire.</span><span class="sxs-lookup"><span data-stu-id="968d3-311">Inconsistent analysis is similar to uncommitted dependency in that another transaction is changing the data that a second transaction is reading.</span></span> <span data-ttu-id="968d3-312">Cependant, dans une analyse incohérente, les données lues par la deuxième transaction sont validées par la transaction qui a effectué la modification.</span><span class="sxs-lookup"><span data-stu-id="968d3-312">However, in inconsistent analysis, the data read by the second transaction was committed by the transaction that made the change.</span></span> <span data-ttu-id="968d3-313">En outre, une analyse incohérente implique plusieurs lectures (deux ou plus) de la même ligne dont les informations sont systématiquement modifiées par une autre transaction, d'où l'expression de lecture non renouvelable.</span><span class="sxs-lookup"><span data-stu-id="968d3-313">Also, inconsistent analysis involves multiple reads (two or more) of the same row, and each time the information is changed by another transaction; thus, the term nonrepeatable read.</span></span>  
  
     <span data-ttu-id="968d3-314">Par exemple, un éditeur relit le même document deux fois, mais l'auteur réécrit le document entre les relectures.</span><span class="sxs-lookup"><span data-stu-id="968d3-314">For example, an editor reads the same document twice, but between each reading the writer rewrites the document.</span></span> <span data-ttu-id="968d3-315">Lorsque l'éditeur relit le document pour la seconde fois, le document a changé.</span><span class="sxs-lookup"><span data-stu-id="968d3-315">When the editor reads the document for the second time, it has changed.</span></span> <span data-ttu-id="968d3-316">La relecture initiale n'est donc pas renouvelable.</span><span class="sxs-lookup"><span data-stu-id="968d3-316">The original read was not repeatable.</span></span> <span data-ttu-id="968d3-317">Ce problème pourrait être évité si l'auteur ne pouvait pas modifier le document tant que l'éditeur n'a pas terminé la dernière lecture.</span><span class="sxs-lookup"><span data-stu-id="968d3-317">This problem could be avoided if the writer could not change the document until the editor has finished reading it for the last time.</span></span>  
  
-   <span data-ttu-id="968d3-318">Lectures fantômes.</span><span class="sxs-lookup"><span data-stu-id="968d3-318">Phantom reads</span></span>  
  
     <span data-ttu-id="968d3-319">Une lecture fantôme est une situation qui se produit lorsque deux requêtes identiques sont exécutées et que la collection de lignes retournée par la deuxième requête est différente.</span><span class="sxs-lookup"><span data-stu-id="968d3-319">A phantom read is a situation that occurs when two identical queries are executed and the collection of rows returned by the second query is different.</span></span> <span data-ttu-id="968d3-320">L'exemple suivant montre comment cela peut arriver.</span><span class="sxs-lookup"><span data-stu-id="968d3-320">The example below shows how this may occur.</span></span> <span data-ttu-id="968d3-321">Supposons que les deux transactions ci-dessous s'exécutent en même temps.</span><span class="sxs-lookup"><span data-stu-id="968d3-321">Assume the two transactions below are executing at the same time.</span></span> <span data-ttu-id="968d3-322">Les deux instructions SELECT dans la première transaction peuvent retourner des résultats différents parce que l'instruction INSERT dans la deuxième transaction modifie les données utilisées par les deux transactions.</span><span class="sxs-lookup"><span data-stu-id="968d3-322">The two SELECT statements in the first transaction may return different results because the INSERT statement in the second transaction changes the data used by both.</span></span>  
  
    ```sql  
    --Transaction 1  
    BEGIN TRAN;  
    SELECT ID FROM dbo.employee  
    WHERE ID > 5 and ID < 10;  
    --The INSERT statement from the second transaction occurs here.  
    SELECT ID FROM dbo.employee  
    WHERE ID > 5 and ID < 10;  
    COMMIT;  
    ```  
  
    ```sql  
    --Transaction 2  
    BEGIN TRAN;  
    INSERT INTO dbo.employee  
       SET name = 'New' WHERE ID = 5;  
    COMMIT;   
    ```  
  
-   <span data-ttu-id="968d3-323">Lectures manquantes et en double provoquées par des mises à jour de ligne</span><span class="sxs-lookup"><span data-stu-id="968d3-323">Missing and double reads caused by row updates</span></span>  
  
    -   <span data-ttu-id="968d3-324">Manquer une ligne mise à jour ou consulter une ligne mise à jour plusieurs fois</span><span class="sxs-lookup"><span data-stu-id="968d3-324">Missing a updated row or seeing an updated row multiple times</span></span>  
  
         <span data-ttu-id="968d3-325">Les transactions qui s'exécutent au niveau READ UNCOMMITTED ne génèrent pas de verrous partagés pour empêcher d'autres transactions de modifier des données lues par la transaction en cours.</span><span class="sxs-lookup"><span data-stu-id="968d3-325">Transactions that are running at the READ UNCOMMITTED level do not issue shared locks to prevent other transactions from modifying data read by the current transaction.</span></span> <span data-ttu-id="968d3-326">Les transactions qui s'exécutent au niveau READ COMMITTED génèrent des verrous partagés, mais les verrous de ligne ou de page sont libérés une fois la ligne lue.</span><span class="sxs-lookup"><span data-stu-id="968d3-326">Transactions that are running at the READ COMMITTED level do issue shared locks, but the row or page locks are released after the row is read.</span></span> <span data-ttu-id="968d3-327">Dans les deux cas, lorsque vous analysez un index, si un autre utilisateur modifie la colonne de clé d'index de la ligne pendant votre lecture, la ligne peut apparaître de nouveau si la modification apportée à la clé a déplacé la ligne à une position située en aval de votre analyse.</span><span class="sxs-lookup"><span data-stu-id="968d3-327">In either case, when you are scanning an index, if another user changes the index key column of the row during your read, the row might appear again if the key change moved the row to a position ahead of your scan.</span></span> <span data-ttu-id="968d3-328">De même, la ligne peut ne pas apparaître si la modification apportée à la clé a déplacé la ligne à une position dans l'index que vous aviez déjà lue.</span><span class="sxs-lookup"><span data-stu-id="968d3-328">Similarly, the row might not appear if the key change moved the row to a position in the index that you had already read.</span></span> <span data-ttu-id="968d3-329">Pour éviter cela, utilisez l'indicateur SERIALIZABLE ou HOLDLOCK ou le contrôle de version de ligne.</span><span class="sxs-lookup"><span data-stu-id="968d3-329">To avoid this, use the SERIALIZABLE or HOLDLOCK hint, or row versioning.</span></span> <span data-ttu-id="968d3-330">Pour plus d’informations, consultez [Indicateurs de table &#40;Transact-SQL&#41;](/sql/t-sql/queries/hints-transact-sql-table).</span><span class="sxs-lookup"><span data-stu-id="968d3-330">For more information, see [Table Hints &#40;Transact-SQL&#41;](/sql/t-sql/queries/hints-transact-sql-table).</span></span>  
  
    -   <span data-ttu-id="968d3-331">Manquer une ou plusieurs lignes qui n'étaient pas la cible de la mise à jour</span><span class="sxs-lookup"><span data-stu-id="968d3-331">Missing one or more rows that were not the target of update</span></span>  
  
         <span data-ttu-id="968d3-332">Lorsque vous utilisez READ UNCOMMITTED, si votre requête lit des lignes à l'aide d'une analyse d'ordre d'allocation (à l'aide de pages IAM), vous risquez de manquer des lignes si une autre transaction provoque un fractionnement de page.</span><span class="sxs-lookup"><span data-stu-id="968d3-332">When you are using READ UNCOMMITTED, if your query reads rows using an allocation order scan (using IAM pages), you might miss rows if another transaction is causing a page split.</span></span> <span data-ttu-id="968d3-333">Cela ne peut pas se produire lorsque vous utilisez la lecture validée car un verrou de table est maintenu pendant un fractionnement de page et ne se produit pas si la table n'a pas d'index cluster, car les mises à jour ne provoquent pas de fractionnements de page.</span><span class="sxs-lookup"><span data-stu-id="968d3-333">This cannot occur when you are using read committed because a table lock is held during a page split and does not happen if the table does not have a clustered index, because updates do not cause page splits.</span></span>  
  
#### <a name="types-of-concurrency"></a><span data-ttu-id="968d3-334">Types de concurrence</span><span class="sxs-lookup"><span data-stu-id="968d3-334">Types of Concurrency</span></span>  

 <span data-ttu-id="968d3-335">Lorsque plusieurs personnes tentent de modifier des données dans une base de données en même temps, il convient d'implémenter un système de contrôle de manière à ce que les modifications apportées par une personne n'en pénalisent pas une autre.</span><span class="sxs-lookup"><span data-stu-id="968d3-335">When many people attempt to modify data in a database at the same time, a system of controls must be implemented so that modifications made by one person do not adversely affect those of another person.</span></span> <span data-ttu-id="968d3-336">Ce système s'appelle le contrôle de concurrence.</span><span class="sxs-lookup"><span data-stu-id="968d3-336">This is called concurrency control.</span></span>  
  
 <span data-ttu-id="968d3-337">La théorie du contrôle de concurrence repose sur deux méthodes de classification :</span><span class="sxs-lookup"><span data-stu-id="968d3-337">Concurrency control theory has two classifications for the methods of instituting concurrency control:</span></span>  
  
-   <span data-ttu-id="968d3-338">Contrôle de concurrence pessimiste</span><span class="sxs-lookup"><span data-stu-id="968d3-338">Pessimistic concurrency control</span></span>  
  
     <span data-ttu-id="968d3-339">Un système de verrouillage empêche les utilisateurs de modifier des données d'une manière qui affecterait les autres utilisateurs.</span><span class="sxs-lookup"><span data-stu-id="968d3-339">A system of locks prevents users from modifying data in a way that affects other users.</span></span> <span data-ttu-id="968d3-340">Lorsqu'un utilisateur a effectué une action qui applique un verrouillage, les autres utilisateurs ne peuvent plus effectuer d'actions qui entreraient en conflit avec ce verrouillage tant que celui-ci n'est pas libéré par le propriétaire.</span><span class="sxs-lookup"><span data-stu-id="968d3-340">After a user performs an action that causes a lock to be applied, other users cannot perform actions that would conflict with the lock until the owner releases it.</span></span> <span data-ttu-id="968d3-341">Cette méthode s'appelle le contrôle pessimiste car elle est principalement utilisée dans les environnements où les données sont très sollicitées et où le coût de protection des données par verrouillage est inférieur au coût de restauration des transactions en cas de contentions de concurrence.</span><span class="sxs-lookup"><span data-stu-id="968d3-341">This is called pessimistic control because it is mainly used in environments where there is high contention for data, where the cost of protecting data with locks is less than the cost of rolling back transactions if concurrency conflicts occur.</span></span>  
  
-   <span data-ttu-id="968d3-342">Contrôle de concurrence optimiste</span><span class="sxs-lookup"><span data-stu-id="968d3-342">Optimistic concurrency control</span></span>  
  
     <span data-ttu-id="968d3-343">Dans le cas du contrôle de concurrence optimiste, les utilisateurs ne verrouillent pas les données quand ils les lisent.</span><span class="sxs-lookup"><span data-stu-id="968d3-343">In optimistic concurrency control, users do not lock data when they read it.</span></span> <span data-ttu-id="968d3-344">Lors d'une mise à jour, le système vérifie si un autre utilisateur a modifié les données après leur lecture.</span><span class="sxs-lookup"><span data-stu-id="968d3-344">When a user updates data, the system checks to see if another user changed the data after it was read.</span></span> <span data-ttu-id="968d3-345">Si tel est le cas, une erreur est générée.</span><span class="sxs-lookup"><span data-stu-id="968d3-345">If another user updated the data, an error is raised.</span></span> <span data-ttu-id="968d3-346">Généralement, l'utilisateur recevant l'erreur restaure la transaction et recommence.</span><span class="sxs-lookup"><span data-stu-id="968d3-346">Typically, the user receiving the error rolls back the transaction and starts over.</span></span> <span data-ttu-id="968d3-347">Cette méthode s'appelle le contrôle optimiste car elle est principalement utilisée dans les environnements où les données sont peu demandées et où le coût de la restauration occasionnelle d'une transaction est inférieur au coût du verrouillage des données lors de la lecture.</span><span class="sxs-lookup"><span data-stu-id="968d3-347">This is called optimistic because it is mainly used in environments where there is low contention for data, and where the cost of occasionally rolling back a transaction is lower than the cost of locking data when read.</span></span>  
  
 [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] <span data-ttu-id="968d3-348">prend en charge plusieurs niveaux de contrôle de concurrence.</span><span class="sxs-lookup"><span data-stu-id="968d3-348">supports a range of concurrency control.</span></span> <span data-ttu-id="968d3-349">Les utilisateurs spécifient le type de contrôle de concurrence lorsqu'ils choisissent les niveaux d'isolement des transactions pour les connexions et les options de concurrence sur les curseurs.</span><span class="sxs-lookup"><span data-stu-id="968d3-349">Users specify the type of concurrency control by selecting transaction isolation levels for connections or concurrency options on cursors.</span></span> <span data-ttu-id="968d3-350">Ces attributs peuvent être définis à l'aide des instructions [!INCLUDE[tsql](../includes/tsql-md.md)] ou des propriétés et attributs des API de base de données telles que ADO, ADO.NET, OLE DB et ODBC.</span><span class="sxs-lookup"><span data-stu-id="968d3-350">These attributes can be defined using [!INCLUDE[tsql](../includes/tsql-md.md)] statements, or through the properties and attributes of database application programming interfaces (APIs) such as ADO, ADO.NET, OLE DB, and ODBC.</span></span>  
  
#### <a name="isolation-levels-in-the-database-engine"></a><span data-ttu-id="968d3-351">Niveaux d'isolement du moteur de base de données</span><span class="sxs-lookup"><span data-stu-id="968d3-351">Isolation Levels in the Database Engine</span></span>  

 <span data-ttu-id="968d3-352">Les transactions spécifient un niveau d'isolement. Ce niveau définit le degré d'isolement d'une transaction par rapport aux modifications de ressource ou de données apportées par d'autres transactions.</span><span class="sxs-lookup"><span data-stu-id="968d3-352">Transactions specify an isolation level that defines the degree to which one transaction must be isolated from resource or data modifications made by other transactions.</span></span> <span data-ttu-id="968d3-353">Les niveaux d'isolation déterminent les effets secondaires de la concurrence (lectures incorrectes, lectures fantômes) qui sont autorisés.</span><span class="sxs-lookup"><span data-stu-id="968d3-353">Isolation levels are described in terms of which concurrency side-effects, such as dirty reads or phantom reads, are allowed.</span></span>  
  
 <span data-ttu-id="968d3-354">Le niveau d'isolation d'une transaction régit les éléments suivants :</span><span class="sxs-lookup"><span data-stu-id="968d3-354">Transaction isolation levels control:</span></span>  
  
-   <span data-ttu-id="968d3-355">l'acquisition de verrous lors de la lecture de données, et le type de verrous nécessaires ;</span><span class="sxs-lookup"><span data-stu-id="968d3-355">Whether locks are taken when data is read, and what type of locks are requested.</span></span>  
  
-   <span data-ttu-id="968d3-356">la durée de vie des verrous de lecture ;</span><span class="sxs-lookup"><span data-stu-id="968d3-356">How long the read locks are held.</span></span>  
  
-   <span data-ttu-id="968d3-357">la réaction d'une opération de lecture qui fait référence à des lignes modifiées par une autre transaction :</span><span class="sxs-lookup"><span data-stu-id="968d3-357">Whether a read operation referencing rows modified by another transaction:</span></span>  
  
    -   <span data-ttu-id="968d3-358">blocage jusqu'à ce que le verrou exclusif sur la ligne soit levé,</span><span class="sxs-lookup"><span data-stu-id="968d3-358">Blocks until the exclusive lock on the row is freed.</span></span>  
  
    -   <span data-ttu-id="968d3-359">récupération de la version validée de la ligne telle qu'elle était au début de l'instruction ou de la transaction,</span><span class="sxs-lookup"><span data-stu-id="968d3-359">Retrieves the committed version of the row that existed at the time the statement or transaction started.</span></span>  
  
    -   <span data-ttu-id="968d3-360">lecture de la modification des données non validées.</span><span class="sxs-lookup"><span data-stu-id="968d3-360">Reads the uncommitted data modification.</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="968d3-361">Le choix d'un niveau d'isolation n'a aucune influence sur les verrous acquis pour protéger les modifications de données.</span><span class="sxs-lookup"><span data-stu-id="968d3-361">Choosing a transaction isolation level does not affect the locks acquired to protect data modifications.</span></span> <span data-ttu-id="968d3-362">Une transaction acquiert toujours un verrou exclusif sur les données qu'elle modifie et garde celui-ci jusqu'à ce qu'elle ait terminé son travail, indépendamment du niveau d'isolation défini pour elle.</span><span class="sxs-lookup"><span data-stu-id="968d3-362">A transaction always gets an exclusive lock on any data it modifies, and holds that lock until the transaction completes, regardless of the isolation level set for that transaction.</span></span> <span data-ttu-id="968d3-363">Dans le cas des opérations de lecture, le niveau d'isolation d'une transaction définit principalement son niveau de protection contre les effets des modifications apportées par les autres transactions.</span><span class="sxs-lookup"><span data-stu-id="968d3-363">For read operations, transaction isolation levels primarily define the level of protection from the effects of modifications made by other transactions.</span></span>  
  
 <span data-ttu-id="968d3-364">Plus le niveau d'isolation est faible, plus le nombre de personnes susceptibles d'accéder aux données en même temps est élevé, et plus les effets secondaires de la concurrence (lectures incorrectes, mises à jour perdues) sont nombreux.</span><span class="sxs-lookup"><span data-stu-id="968d3-364">A lower isolation level increases the ability of many users to access data at the same time, but increases the number of concurrency effects (such as dirty reads or lost updates) users might encounter.</span></span> <span data-ttu-id="968d3-365">Inversement, plus le niveau d'isolation est élevé, plus le nombre de types d'effets secondaires de la concurrence qu'un utilisateur est susceptible de rencontrer est réduit. Cependant, la quantité de ressources système nécessaires et la probabilité d'un blocage mutuel de transactions sont plus élevées.</span><span class="sxs-lookup"><span data-stu-id="968d3-365">Conversely, a higher isolation level reduces the types of concurrency effects that users may encounter, but requires more system resources and increases the chances that one transaction will block another.</span></span> <span data-ttu-id="968d3-366">Le choix du niveau d'isolation adéquat dépend d'une mise en équilibre de l'espace réservé et des exigences en matière d'intégrité des données de l'application.</span><span class="sxs-lookup"><span data-stu-id="968d3-366">Choosing the appropriate isolation level depends on balancing the data integrity requirements of the application against the overhead of each isolation level.</span></span> <span data-ttu-id="968d3-367">Le niveau le plus élevé, sérialisable, garantit qu'une transaction récupère exactement les mêmes données à chaque fois qu'elle répète une opération de lecture, mais en utilisant un niveau de verrouillage susceptible de gêner les autres utilisateurs dans les systèmes multi-utilisateurs.</span><span class="sxs-lookup"><span data-stu-id="968d3-367">The highest isolation level, serializable, guarantees that a transaction will retrieve exactly the same data every time it repeats a read operation, but it does this by performing a level of locking that is likely to impact other users in multi-user systems.</span></span> <span data-ttu-id="968d3-368">Le niveau le plus bas, lecture non validée, permet la récupération de données qui ont été modifiées mais non validées par d'autres transactions.</span><span class="sxs-lookup"><span data-stu-id="968d3-368">The lowest isolation level, read uncommitted, may retrieve data that has been modified but not committed by other transactions.</span></span> <span data-ttu-id="968d3-369">Ce niveau permet l'apparition de tous les effets secondaires de la concurrence, mais la charge du système est réduite puisqu'il n'y a ni verrouillage de lecture, ni contrôle de version de ligne.</span><span class="sxs-lookup"><span data-stu-id="968d3-369">All of the concurrency side effects can happen in read uncommitted, but there is no read locking or versioning, so overhead is minimized.</span></span>  
  
##### <a name="database-engine-isolation-levels"></a><span data-ttu-id="968d3-370">Niveaux d'isolation du moteur de base de données</span><span class="sxs-lookup"><span data-stu-id="968d3-370">Database Engine Isolation Levels</span></span>  

 <span data-ttu-id="968d3-371">La norme ISO définit les niveaux d'isolation suivants, tous pris en charge par le [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] :</span><span class="sxs-lookup"><span data-stu-id="968d3-371">The ISO standard defines the following isolation levels, all of which are supported by the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)]:</span></span>  
  
|<span data-ttu-id="968d3-372">Niveau d’isolation</span><span class="sxs-lookup"><span data-stu-id="968d3-372">Isolation Level</span></span>|<span data-ttu-id="968d3-373">Définition</span><span class="sxs-lookup"><span data-stu-id="968d3-373">Definition</span></span>|  
|---------------------|----------------|  
|<span data-ttu-id="968d3-374">Lecture non validée</span><span class="sxs-lookup"><span data-stu-id="968d3-374">Read uncommitted</span></span>|<span data-ttu-id="968d3-375">Le niveau d'isolement le plus bas et suffisant pour s'assurer que les données physiquement corrompues ne sont pas lues.</span><span class="sxs-lookup"><span data-stu-id="968d3-375">The lowest isolation level where transactions are isolated only enough to ensure that physically corrupt data is not read.</span></span> <span data-ttu-id="968d3-376">À ce niveau, les lectures de modifications sont autorisées. Ainsi, une transaction peut afficher les modifications qui ne sont pas encore validées apportées par d'autres transactions.</span><span class="sxs-lookup"><span data-stu-id="968d3-376">In this level, dirty reads are allowed, so one transaction may see not-yet-committed changes made by other transactions.</span></span>|  
|<span data-ttu-id="968d3-377">Lecture validée</span><span class="sxs-lookup"><span data-stu-id="968d3-377">Read committed</span></span>|<span data-ttu-id="968d3-378">Permet à une transaction de lire des données lues auparavant (non modifiées) par une autre transaction, sans attendre la fin de la première transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-378">Allows a transaction to read data previously read (not modified) by another transaction without waiting for the first transaction to complete.</span></span> <span data-ttu-id="968d3-379">Le [!INCLUDE[ssDE](../includes/ssde-md.md)] conserve les verrous d'écriture (acquis sur les données sélectionnées) jusqu'à la fin de la transaction, mais les verrous le lecture sont libérés dès que l'opération SELECT est terminée.</span><span class="sxs-lookup"><span data-stu-id="968d3-379">The [!INCLUDE[ssDE](../includes/ssde-md.md)] keeps write locks (acquired on selected data) until the end of the transaction, but read locks are released as soon as the SELECT operation is performed.</span></span> <span data-ttu-id="968d3-380">C'est le niveau par défaut du [!INCLUDE[ssDE](../includes/ssde-md.md)].</span><span class="sxs-lookup"><span data-stu-id="968d3-380">This is the [!INCLUDE[ssDE](../includes/ssde-md.md)] default level.</span></span>|  
|<span data-ttu-id="968d3-381">Lecture renouvelable</span><span class="sxs-lookup"><span data-stu-id="968d3-381">Repeatable read</span></span>|<span data-ttu-id="968d3-382">Le [!INCLUDE[ssDE](../includes/ssde-md.md)] conserve les verrous de lecture et d'écriture acquis sur les données sélectionnées jusqu'à la fin de la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-382">The [!INCLUDE[ssDE](../includes/ssde-md.md)] keeps read and write locks that are acquired on selected data until the end of the transaction.</span></span> <span data-ttu-id="968d3-383">Cependant, étant donné que les verrous d'étendus ne sont pas gérés, des lectures fantômes peuvent se produire.</span><span class="sxs-lookup"><span data-stu-id="968d3-383">However, because range-locks are not managed, phantom reads can occur.</span></span>|  
|<span data-ttu-id="968d3-384">Sérialisable</span><span class="sxs-lookup"><span data-stu-id="968d3-384">Serializable</span></span>|<span data-ttu-id="968d3-385">Niveau le plus élevé, dans lequel les transactions sont totalement isolées les unes des autres.</span><span class="sxs-lookup"><span data-stu-id="968d3-385">The highest level where transactions are completely isolated from one another.</span></span> <span data-ttu-id="968d3-386">Le [!INCLUDE[ssDE](../includes/ssde-md.md)] conserve les verrous de lecture et d'écriture acquis sur les données sélectionnées de façon à les libérer à la fin de la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-386">The [!INCLUDE[ssDE](../includes/ssde-md.md)] keeps read and write locks acquired on selected data to be released at the end of the transaction.</span></span> <span data-ttu-id="968d3-387">Les verrous d'étendues sont acquis lorsqu'une opération SELECT utilise une clause WHERE, plus particulièrement pour éviter les lectures fantômes.</span><span class="sxs-lookup"><span data-stu-id="968d3-387">Range-locks are acquired when a SELECT operation uses a ranged WHERE clause, especially to avoid phantom reads.</span></span><br /><br /> <span data-ttu-id="968d3-388">**Remarque :** Les opérations DDL et les transactions sur les tables répliquées peuvent échouer lorsque le niveau d’isolation sérialisable est demandé.</span><span class="sxs-lookup"><span data-stu-id="968d3-388">**Note:** DDL operations and transactions on replicated tables may fail when serializable isolation level is requested.</span></span> <span data-ttu-id="968d3-389">Cela est dû au fait que les requêtes de réplication utilisent des indicateurs qui peuvent être incompatibles avec le niveau d'isolation sérialisable.</span><span class="sxs-lookup"><span data-stu-id="968d3-389">This is because replication queries use hints that may be incompatible with serializable isolation level.</span></span>|  
  
 [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] <span data-ttu-id="968d3-390">prend également en charge deux niveaux d'isolement de la transaction supplémentaires qui utilisent le contrôle de version de ligne.</span><span class="sxs-lookup"><span data-stu-id="968d3-390">also supports two additional transaction isolation levels that use row versioning.</span></span> <span data-ttu-id="968d3-391">Le premier est une implémentation de l'isolement read committed, et le deuxième est un niveau d'isolement, l'instantané.</span><span class="sxs-lookup"><span data-stu-id="968d3-391">One is an implementation of read committed isolation, and one is a transaction isolation level, snapshot.</span></span>  
  
|<span data-ttu-id="968d3-392">Niveau d'isolement basé sur le contrôle de version de ligne</span><span class="sxs-lookup"><span data-stu-id="968d3-392">Row Versioning Isolation Level</span></span>|<span data-ttu-id="968d3-393">Définition</span><span class="sxs-lookup"><span data-stu-id="968d3-393">Definition</span></span>|  
|------------------------------------|----------------|  
|<span data-ttu-id="968d3-394">Instantané read committed</span><span class="sxs-lookup"><span data-stu-id="968d3-394">Read Committed Snapshot</span></span>|<span data-ttu-id="968d3-395">Lorsque l'option de base de données READ_COMMITTED_SNAPSHOT a la valeur ON, le niveau d'isolation read committed utilise le contrôle de version de ligne pour procurer une lecture cohérente au niveau des instructions.</span><span class="sxs-lookup"><span data-stu-id="968d3-395">When the READ_COMMITTED_SNAPSHOT database option is set ON, read committed isolation uses row versioning to provide statement-level read consistency.</span></span> <span data-ttu-id="968d3-396">Les opérations de lecture ont besoin uniquement de verrous de table SCH-S, et pas de verrous de page ni de ligne.</span><span class="sxs-lookup"><span data-stu-id="968d3-396">Read operations require only SCH-S table level locks and no page or row locks.</span></span> <span data-ttu-id="968d3-397">À savoir, le moteur de base de données utilise le contrôle de version de ligne pour présenter à chaque instruction un instantané cohérent des données (du point de vue transactionnel) telles qu'elles étaient au début de l'instruction.</span><span class="sxs-lookup"><span data-stu-id="968d3-397">That is, the Database Engine uses row versioning to present each statement with a transactionally consistent snapshot of the data as it existed at the start of the statement.</span></span> <span data-ttu-id="968d3-398">Les verrous ne sont pas utilisés pour protéger les données des mises à jour par d'autres transactions.</span><span class="sxs-lookup"><span data-stu-id="968d3-398">Locks are not used to protect the data from updates by other transactions.</span></span> <span data-ttu-id="968d3-399">Une fonction définie par l'utilisateur peut retourner des données qui ont été validées après l'heure de début de l'instruction contenant cette fonction.</span><span class="sxs-lookup"><span data-stu-id="968d3-399">A user-defined function can return data that was committed after the time the statement containing the UDF began.</span></span><br /><br /> <span data-ttu-id="968d3-400">Si l'option de base de données READ_COMMITTED_SNAPSHOT a la valeur OFF (valeur par défaut), l'isolement read committed utilise des verrous partagés pour empêcher d'autres transactions de modifier des lignes pendant que la transaction active exécute une opération de lecture.</span><span class="sxs-lookup"><span data-stu-id="968d3-400">When the READ_COMMITTED_SNAPSHOT database option is set OFF, which is the default setting, read committed isolation uses shared locks to prevent other transactions from modifying rows while the current transaction is running a read operation.</span></span> <span data-ttu-id="968d3-401">Les verrous partagés empêchent également l'instruction de lire des lignes modifiées par d'autres transactions, tant que celles-ci ne sont pas terminées.</span><span class="sxs-lookup"><span data-stu-id="968d3-401">The shared locks also block the statement from reading rows modified by other transactions until the other transaction is completed.</span></span> <span data-ttu-id="968d3-402">Les deux variantes sont conformes à la définition de l'isolation read committed de l'ISO.</span><span class="sxs-lookup"><span data-stu-id="968d3-402">Both implementations meet the ISO definition of read committed isolation.</span></span>|  
|<span data-ttu-id="968d3-403">Instantané</span><span class="sxs-lookup"><span data-stu-id="968d3-403">Snapshot</span></span>|<span data-ttu-id="968d3-404">Le niveau d'isolation d'instantané utilise le contrôle de version de ligne pour assurer la cohérence des lectures au niveau de la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-404">The snapshot isolation level uses row versioning to provide transaction-level read consistency.</span></span> <span data-ttu-id="968d3-405">Les opérations de lecture ont besoin uniquement de verrous de table SCH-S, et pas de verrous de page ni de ligne.</span><span class="sxs-lookup"><span data-stu-id="968d3-405">Read operations acquire no page or row locks; only SCH-S table locks are acquired.</span></span> <span data-ttu-id="968d3-406">Lorsque l'opération de lecture lit des lignes modifiées par une autre transaction, elle récupère la version de la ligne du début de la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-406">When reading rows modified by another transaction, they retrieve the version of the row that existed when the transaction started.</span></span> <span data-ttu-id="968d3-407">Vous pouvez utiliser l'isolation d'instantané pour une base de données uniquement lorsque la valeur ON est attribuée à l'option de base de données ALLOW_SNAPSHOT_ISOLATION.</span><span class="sxs-lookup"><span data-stu-id="968d3-407">You can only use Snapshot isolation against a database when the ALLOW_SNAPSHOT_ISOLATION database option is set ON.</span></span> <span data-ttu-id="968d3-408">Par défaut, cette option est désactivée (OFF) pour les bases de données utilisateur.</span><span class="sxs-lookup"><span data-stu-id="968d3-408">By default, this option is set OFF for user databases.</span></span><br /><br /> <span data-ttu-id="968d3-409">**Remarque :** [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] ne prend pas en charge le contrôle de version des métadonnées.</span><span class="sxs-lookup"><span data-stu-id="968d3-409">**Note:**  [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] does not support versioning of metadata.</span></span> <span data-ttu-id="968d3-410">Pour cette raison, il existe des restrictions sur les opérations DDL pouvant être effectuées dans une transaction explicite exécutée avec le niveau d'isolement d'instantané.</span><span class="sxs-lookup"><span data-stu-id="968d3-410">For this reason, there are restrictions on what DDL operations can be performed in an explicit transaction that is running under snapshot isolation.</span></span> <span data-ttu-id="968d3-411">Les instructions DDL suivantes ne sont pas autorisées en isolement d’instantanée après une instruction BEGIN TRANSACTION : ALTER TABLE, CREATE INDEX, CREATE XML INDEX, ALTER INDEX, DROP INDEX, DBCC REINDEX, ALTER PARTITION FUNCTION, ALTER PARTITION SCHEME ou toute instruction DDL CLR (Common Language Runtime).</span><span class="sxs-lookup"><span data-stu-id="968d3-411">The following DDL statements are not permitted under snapshot isolation after a BEGIN TRANSACTION statement: ALTER TABLE, CREATE INDEX, CREATE XML INDEX, ALTER INDEX, DROP INDEX, DBCC REINDEX, ALTER PARTITION FUNCTION, ALTER PARTITION SCHEME, or any common language runtime (CLR) DDL statement.</span></span> <span data-ttu-id="968d3-412">Ces instructions sont autorisées quand vous utilisez l’isolement d’instantané au sein de transactions implicites.</span><span class="sxs-lookup"><span data-stu-id="968d3-412">These statements are permitted when you are using snapshot isolation within implicit transactions.</span></span> <span data-ttu-id="968d3-413">Par définition, une transaction implicite est une instruction unique qui permet d'appliquer la sémantique de l'isolation d'instantané, même avec des instructions DDL.</span><span class="sxs-lookup"><span data-stu-id="968d3-413">An implicit transaction, by definition, is a single statement that makes it possible to enforce the semantics of snapshot isolation, even with DDL statements.</span></span> <span data-ttu-id="968d3-414">Tout manquement à ce principe peut provoquer l'erreur 3961 : « La transaction d'isolation d'instantané a échoué dans la base de données '%.\*ls' car l'objet auquel l'instruction a eu accès a été modifié par une instruction DDL dans une autre transaction simultanée depuis le début de cette transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-414">Violations of this principle can cause error 3961: "Snapshot isolation transaction failed in database '%.\*ls' because the object accessed by the statement has been modified by a DDL statement in another concurrent transaction since the start of this transaction.</span></span> <span data-ttu-id="968d3-415">Cela est interdit, car les métadonnées sont dépourvues de version.</span><span class="sxs-lookup"><span data-stu-id="968d3-415">It is not allowed because the metadata is not versioned.</span></span> <span data-ttu-id="968d3-416">Une mise à jour simultanée des métadonnées peut provoquer des incohérences si elle est associée à une isolation d'instantané. »</span><span class="sxs-lookup"><span data-stu-id="968d3-416">A concurrent update to metadata could lead to inconsistency if mixed with snapshot isolation."</span></span>|  
  
 <span data-ttu-id="968d3-417">Le tableau suivant répertorie les effets secondaires de la concurrence provoqués par les différents niveaux d'isolation.</span><span class="sxs-lookup"><span data-stu-id="968d3-417">The following table shows the concurrency side effects enabled by the different isolation levels.</span></span>  
  
|<span data-ttu-id="968d3-418">Niveau d'isolation</span><span class="sxs-lookup"><span data-stu-id="968d3-418">Isolation level</span></span>|<span data-ttu-id="968d3-419">Lecture incorrecte</span><span class="sxs-lookup"><span data-stu-id="968d3-419">Dirty read</span></span>|<span data-ttu-id="968d3-420">Lecture non renouvelable</span><span class="sxs-lookup"><span data-stu-id="968d3-420">Nonrepeatable read</span></span>|<span data-ttu-id="968d3-421">Fantôme</span><span class="sxs-lookup"><span data-stu-id="968d3-421">Phantom</span></span>|  
|---------------------|----------------|------------------------|-------------|  
|<span data-ttu-id="968d3-422">**Lecture non validée**</span><span class="sxs-lookup"><span data-stu-id="968d3-422">**Read uncommitted**</span></span>|<span data-ttu-id="968d3-423">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-423">Yes</span></span>|<span data-ttu-id="968d3-424">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-424">Yes</span></span>|<span data-ttu-id="968d3-425">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-425">Yes</span></span>|  
|<span data-ttu-id="968d3-426">**Lecture validée**</span><span class="sxs-lookup"><span data-stu-id="968d3-426">**Read committed**</span></span>|<span data-ttu-id="968d3-427">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-427">No</span></span>|<span data-ttu-id="968d3-428">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-428">Yes</span></span>|<span data-ttu-id="968d3-429">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-429">Yes</span></span>|  
|<span data-ttu-id="968d3-430">**Lecture renouvelée**</span><span class="sxs-lookup"><span data-stu-id="968d3-430">**Repeatable read**</span></span>|<span data-ttu-id="968d3-431">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-431">No</span></span>|<span data-ttu-id="968d3-432">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-432">No</span></span>|<span data-ttu-id="968d3-433">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-433">Yes</span></span>|  
|<span data-ttu-id="968d3-434">**Instantané**</span><span class="sxs-lookup"><span data-stu-id="968d3-434">**Snapshot**</span></span>|<span data-ttu-id="968d3-435">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-435">No</span></span>|<span data-ttu-id="968d3-436">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-436">No</span></span>|<span data-ttu-id="968d3-437">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-437">No</span></span>|  
|<span data-ttu-id="968d3-438">**Sérialisable**</span><span class="sxs-lookup"><span data-stu-id="968d3-438">**Serializable**</span></span>|<span data-ttu-id="968d3-439">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-439">No</span></span>|<span data-ttu-id="968d3-440">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-440">No</span></span>|<span data-ttu-id="968d3-441">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-441">No</span></span>|  
  
 <span data-ttu-id="968d3-442">Pour plus d’informations sur les types spécifiques de verrouillage ou de contrôle de version de ligne contrôlés par chaque niveau d’isolation de la transaction, consultez [SET TRANSACTION ISOLATION LEVEL &#40;Transact-SQL&#41;](/sql/t-sql/statements/set-transaction-isolation-level-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="968d3-442">For more information about the specific types of locking or row versioning controlled by each transaction isolation level, see [SET TRANSACTION ISOLATION LEVEL &#40;Transact-SQL&#41;](/sql/t-sql/statements/set-transaction-isolation-level-transact-sql).</span></span>  
  
 <span data-ttu-id="968d3-443">Les niveaux d'isolement des transactions peuvent être définis à l'aide de [!INCLUDE[tsql](../includes/tsql-md.md)] ou d'une API de base de données.</span><span class="sxs-lookup"><span data-stu-id="968d3-443">Transaction isolation levels can be set using [!INCLUDE[tsql](../includes/tsql-md.md)] or through a database API.</span></span>  
  
 [!INCLUDE[tsql](../includes/tsql-md.md)]  
 <span data-ttu-id="968d3-444">Les scripts [!INCLUDE[tsql](../includes/tsql-md.md)] utilisent l'instruction SET TRANSACTION ISOLATION LEVEL.</span><span class="sxs-lookup"><span data-stu-id="968d3-444">[!INCLUDE[tsql](../includes/tsql-md.md)] scripts use the SET TRANSACTION ISOLATION LEVEL statement.</span></span>  
  
 <span data-ttu-id="968d3-445">ADO</span><span class="sxs-lookup"><span data-stu-id="968d3-445">ADO</span></span>  
 <span data-ttu-id="968d3-446">Les applications ADO attribuent à la propriété `IsolationLevel` de l’objet **Connection** la valeur adXactReadUncommitted, adXactReadCommitted, adXactRepeatableRead ou adXactReadSerializable.</span><span class="sxs-lookup"><span data-stu-id="968d3-446">ADO applications set the `IsolationLevel` property of the **Connection** object to adXactReadUncommitted, adXactReadCommitted, adXactRepeatableRead, or adXactReadSerializable.</span></span>  
  
 <span data-ttu-id="968d3-447">ADO.NET</span><span class="sxs-lookup"><span data-stu-id="968d3-447">ADO.NET</span></span>  
 <span data-ttu-id="968d3-448">Les applications ADO.NET qui utilisent l’espace de noms managé `System.Data.SqlClient` peuvent appeler la méthode `SqlConnection.BeginTransaction` et attribuer à l’option *IsolationLevel* la valeur Unspecified, Chaos, ReadUncommitted, ReadCommitted, RepeatableRead, Serializable et Snapshot.</span><span class="sxs-lookup"><span data-stu-id="968d3-448">ADO.NET applications using the `System.Data.SqlClient` managed namespace can call the `SqlConnection.BeginTransaction` method and set the *IsolationLevel* option to Unspecified, Chaos, ReadUncommitted, ReadCommitted, RepeatableRead, Serializable, and Snapshot.</span></span>  
  
 <span data-ttu-id="968d3-449">OLE DB</span><span class="sxs-lookup"><span data-stu-id="968d3-449">OLE DB</span></span>  
 <span data-ttu-id="968d3-450">Au début d’une transaction, les applications qui utilisent OLE DB appellent `ITransactionLocal::StartTransaction` avec la valeur ISOLATIONLEVEL_READUNCOMMITTED, ISOLATIONLEVEL_READCOMMITTED, ISOLATIONLEVEL_REPEATABLEREAD, ISOLATIONLEVEL_SNAPSHOT ou ISOLATIONLEVEL_SERIALIZABLE attribuée au paramètre *isoLevel*.</span><span class="sxs-lookup"><span data-stu-id="968d3-450">When starting a transaction, applications using OLE DB call `ITransactionLocal::StartTransaction` with *isoLevel* set to ISOLATIONLEVEL_READUNCOMMITTED, ISOLATIONLEVEL_READCOMMITTED, ISOLATIONLEVEL_REPEATABLEREAD, ISOLATIONLEVEL_SNAPSHOT, or ISOLATIONLEVEL_SERIALIZABLE.</span></span>  
  
 <span data-ttu-id="968d3-451">Lorsque vous spécifiez le niveau d'isolement d'une transaction en mode « autocommit », les applications OLE DB peuvent attribuer aux niveaux DBPROP_SESS_AUTOCOMMITISOLEVELS de la propriété DBPROPSET_SESSION la valeur DBPROPVAL_TI_CHAOS, DBPROPVAL_TI_READUNCOMMITTED, DBPROPVAL_TI_BROWSE, DBPROPVAL_TI_CURSORSTABILITY, DBPROPVAL_TI_READCOMMITTED, DBPROPVAL_TI_REPEATABLEREAD, DBPROPVAL_TI_SERIALIZABLE, DBPROPVAL_TI_ISOLATED ou DBPROPVAL_TI_SNAPSHOT.</span><span class="sxs-lookup"><span data-stu-id="968d3-451">When specifying the transaction isolation level in autocommit mode, OLE DB applications can set the DBPROPSET_SESSION property DBPROP_SESS_AUTOCOMMITISOLEVELS to DBPROPVAL_TI_CHAOS, DBPROPVAL_TI_READUNCOMMITTED, DBPROPVAL_TI_BROWSE, DBPROPVAL_TI_CURSORSTABILITY, DBPROPVAL_TI_READCOMMITTED, DBPROPVAL_TI_REPEATABLEREAD, DBPROPVAL_TI_SERIALIZABLE, DBPROPVAL_TI_ISOLATED, or DBPROPVAL_TI_SNAPSHOT.</span></span>  
  
 <span data-ttu-id="968d3-452">ODBC</span><span class="sxs-lookup"><span data-stu-id="968d3-452">ODBC</span></span>  
 <span data-ttu-id="968d3-453">Les applications ODBC appellent `SQLSetConnectAttr` avec la valeur SQL_ATTR_TXN_ISOLATION pour le paramètre *Attribute* et la valeur SQL_TXN_READ_UNCOMMITTED, SQL_TXN_READ_COMMITTED, SQL_TXN_REPEATABLE_READ ou SQL_TXN_SERIALIZABLE pour le paramètre *ValuePtr*.</span><span class="sxs-lookup"><span data-stu-id="968d3-453">ODBC applications call `SQLSetConnectAttr` with *Attribute* set to SQL_ATTR_TXN_ISOLATION and *ValuePtr* set to SQL_TXN_READ_UNCOMMITTED, SQL_TXN_READ_COMMITTED, SQL_TXN_REPEATABLE_READ, or SQL_TXN_SERIALIZABLE.</span></span>  
  
 <span data-ttu-id="968d3-454">Pour les transactions d’instantanés, les applications appellent `SQLSetConnectAttr` avec la valeur SQL_COPT_SS_TXN_ISOLATION pour le paramètre Attribute et la valeur SQL_TXN_SS_SNAPSHOT pour le paramètre ValuePtr.</span><span class="sxs-lookup"><span data-stu-id="968d3-454">For snapshot transactions, applications call `SQLSetConnectAttr` with Attribute set to SQL_COPT_SS_TXN_ISOLATION and ValuePtr set to SQL_TXN_SS_SNAPSHOT.</span></span> <span data-ttu-id="968d3-455">Une transaction d'instantané peut être extraite à l'aide de SQL_COPT_SS_TXN_ISOLATION ou de SQL_ATTR_TXN_ISOLATION.</span><span class="sxs-lookup"><span data-stu-id="968d3-455">A snapshot transaction can be retrieved using either SQL_COPT_SS_TXN_ISOLATION or SQL_ATTR_TXN_ISOLATION.</span></span>  
  
 <span data-ttu-id="968d3-456">![Icône de flèche utilisée avec le lien retour au début](media/uparrow16x16.gif "Icône de flèche utilisée avec le lien Retour en haut") [dans ce guide](#Top)</span><span class="sxs-lookup"><span data-stu-id="968d3-456">![Arrow icon used with Back to Top link](media/uparrow16x16.gif "Arrow icon used with Back to Top link") [In This Guide](#Top)</span></span>  
  
##  <a name="locking-in-the-database-engine"></a><a name="Lock_Engine"></a> <span data-ttu-id="968d3-457">Verrouillage du moteur de base de données</span><span class="sxs-lookup"><span data-stu-id="968d3-457">Locking in the Database Engine</span></span>  

 <span data-ttu-id="968d3-458">Le verrouillage est un mécanisme utilisé par le [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] pour synchroniser l'accès simultané de plusieurs utilisateurs à la même donnée.</span><span class="sxs-lookup"><span data-stu-id="968d3-458">Locking is a mechanism used by the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] to synchronize access by multiple users to the same piece of data at the same time.</span></span>  
  
 <span data-ttu-id="968d3-459">Avant qu'une transaction acquière une dépendance sur l'état actuel d'un élément de données, par exemple par sa lecture ou la modification d'une donnée, elle doit se protéger des effets d'une autre transaction qui modifie la même donnée.</span><span class="sxs-lookup"><span data-stu-id="968d3-459">Before a transaction acquires a dependency on the current state of a piece of data, such as by reading or modifying the data, it must protect itself from the effects of another transaction modifying the same data.</span></span> <span data-ttu-id="968d3-460">Pour ce faire, la transaction demande un verrou sur l'élément de données.</span><span class="sxs-lookup"><span data-stu-id="968d3-460">The transaction does this by requesting a lock on the piece of data.</span></span> <span data-ttu-id="968d3-461">Le verrou possède plusieurs modes, par exemple partagé ou exclusif.</span><span class="sxs-lookup"><span data-stu-id="968d3-461">Locks have different modes, such as shared or exclusive.</span></span> <span data-ttu-id="968d3-462">Le mode de verrouillage définit le niveau de dépendance de la transaction sur les données.</span><span class="sxs-lookup"><span data-stu-id="968d3-462">The lock mode defines the level of dependency the transaction has on the data.</span></span> <span data-ttu-id="968d3-463">Aucune transaction ne peut obtenir un verrou qui entrerait en conflit avec le mode d'un verrou déjà accordé sur ces données à une autre transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-463">No transaction can be granted a lock that would conflict with the mode of a lock already granted on that data to another transaction.</span></span> <span data-ttu-id="968d3-464">Si une transaction demande un mode de verrouillage qui est en conflit avec un verrou déjà accordé aux mêmes données, l'instance du [!INCLUDE[ssDE](../includes/ssde-md.md)] suspend la transaction concernée jusqu'à ce que le premier verrou soit libéré.</span><span class="sxs-lookup"><span data-stu-id="968d3-464">If a transaction requests a lock mode that conflicts with a lock that has already been granted on the same data, the instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] will pause the requesting transaction until the first lock is released.</span></span>  
  
 <span data-ttu-id="968d3-465">Lorsqu'une transaction modifie une donnée, elle conserve le verrou qui protège la modification jusqu'à la fin de la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-465">When a transaction modifies a piece of data, it holds the lock protecting the modification until the end of the transaction.</span></span> <span data-ttu-id="968d3-466">La durée pendant laquelle une transaction conserve le verrou acquis pour protéger les opérations de lecture dépend de la configuration du niveau d'isolement de la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-466">How long a transaction holds the locks acquired to protect read operations depends on the transaction isolation level setting.</span></span> <span data-ttu-id="968d3-467">Tous les verrous conservés par une transaction sont libérés lorsque cette dernière est terminée (validée ou restaurée).</span><span class="sxs-lookup"><span data-stu-id="968d3-467">All locks held by a transaction are released when the transaction completes (either commits or rolls back).</span></span>  
  
 <span data-ttu-id="968d3-468">En général, les applications ne demandent pas de verrous directement.</span><span class="sxs-lookup"><span data-stu-id="968d3-468">Applications do not typically request locks directly.</span></span> <span data-ttu-id="968d3-469">Les verrous sont gérés en interne par une partie du [!INCLUDE[ssDE](../includes/ssde-md.md)], nommée gestionnaire de verrous.</span><span class="sxs-lookup"><span data-stu-id="968d3-469">Locks are managed internally by a part of the [!INCLUDE[ssDE](../includes/ssde-md.md)] called the lock manager.</span></span> <span data-ttu-id="968d3-470">Lorsqu'une instance du [!INCLUDE[ssDE](../includes/ssde-md.md)] traite une instruction [!INCLUDE[tsql](../includes/tsql-md.md)], le processeur de requêtes du [!INCLUDE[ssDE](../includes/ssde-md.md)] détermine les ressources qui doivent être accédées.</span><span class="sxs-lookup"><span data-stu-id="968d3-470">When an instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] processes a [!INCLUDE[tsql](../includes/tsql-md.md)] statement, the [!INCLUDE[ssDE](../includes/ssde-md.md)] query processor determines which resources are to be accessed.</span></span> <span data-ttu-id="968d3-471">Le processeur de requêtes détermine les types de verrou nécessaires pour protéger chaque ressource, en fonction du type d'accès et de la configuration du niveau d'isolement de la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-471">The query processor determines what types of locks are required to protect each resource based on the type of access and the transaction isolation level setting.</span></span> <span data-ttu-id="968d3-472">Le processeur de requêtes demande ensuite les verrous appropriés auprès du gestionnaire de verrous.</span><span class="sxs-lookup"><span data-stu-id="968d3-472">The query processor then requests the appropriate locks from the lock manager.</span></span> <span data-ttu-id="968d3-473">Le gestionnaire de verrous accorde les verrous s'il n'existe aucun verrou en conflit détenu par d'autres transactions.</span><span class="sxs-lookup"><span data-stu-id="968d3-473">The lock manager grants the locks if there are no conflicting locks held by other transactions.</span></span>  
  
### <a name="lock-granularity-and-hierarchies"></a><span data-ttu-id="968d3-474">Granularité et hiérarchie des verrous</span><span class="sxs-lookup"><span data-stu-id="968d3-474">Lock Granularity and Hierarchies</span></span>  

 <span data-ttu-id="968d3-475">Le [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] possède un verrouillage multigranulaire qui permet à différents types de ressources d'être verrouillés par une transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-475">The [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] has multigranular locking that allows different types of resources to be locked by a transaction.</span></span> <span data-ttu-id="968d3-476">Pour minimiser le coût du verrouillage, le [!INCLUDE[ssDE](../includes/ssde-md.md)] verrouille automatiquement les ressources au niveau approprié pour la tâche.</span><span class="sxs-lookup"><span data-stu-id="968d3-476">To minimize the cost of locking, the [!INCLUDE[ssDE](../includes/ssde-md.md)] locks resources automatically at a level appropriate to the task.</span></span> <span data-ttu-id="968d3-477">Le verrouillage à un faible niveau de granularité (tel que les lignes) augmente la simultanéité d'accès, mais à un coût plus élevé, puisqu'un grand nombre de verrous doit être maintenu si de nombreuses lignes sont verrouillées.</span><span class="sxs-lookup"><span data-stu-id="968d3-477">Locking at a smaller granularity, such as rows, increases concurrency but has a higher overhead because more locks must be held if many rows are locked.</span></span> <span data-ttu-id="968d3-478">Le verrouillage à un niveau de granularité élevé (tel que les tables) est coûteux en termes de simultanéité d'accès, car le verrouillage d'une table entière empêche les autres transactions d'accéder à d'autres parties de la table.</span><span class="sxs-lookup"><span data-stu-id="968d3-478">Locking at a larger granularity, such as tables, are expensive in terms of concurrency because locking an entire table restricts access to any part of the table by other transactions.</span></span> <span data-ttu-id="968d3-479">Cependant, son coût est moindre puisque les verrous sont peu nombreux.</span><span class="sxs-lookup"><span data-stu-id="968d3-479">However, it has a lower overhead because fewer locks are being maintained.</span></span>  
  
 <span data-ttu-id="968d3-480">Le [!INCLUDE[ssDE](../includes/ssde-md.md)] doit souvent acquérir des verrous à plusieurs niveaux de granularité pour protéger intégralement une ressource.</span><span class="sxs-lookup"><span data-stu-id="968d3-480">The [!INCLUDE[ssDE](../includes/ssde-md.md)] often has to acquire locks at multiple levels of granularity to fully protect a resource.</span></span> <span data-ttu-id="968d3-481">Ce groupe de verrous à plusieurs niveaux de granularité est appelé « hiérarchie des verrous ».</span><span class="sxs-lookup"><span data-stu-id="968d3-481">This group of locks at multiple levels of granularity is called a lock hierarchy.</span></span> <span data-ttu-id="968d3-482">Par exemple, pour protéger complètement la lecture d'un index, une instance du [!INCLUDE[ssDE](../includes/ssde-md.md)] devra peut-être acquérir des verrous partagés sur les lignes et des verrous partagés Intent sur les pages et la table.</span><span class="sxs-lookup"><span data-stu-id="968d3-482">For example, to fully protect a read of an index, an instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] may have to acquire share locks on rows and intent share locks on the pages and table.</span></span>  
  
 <span data-ttu-id="968d3-483">Le tableau suivant répertorie les ressources que le [!INCLUDE[ssDE](../includes/ssde-md.md)] peut verrouiller.</span><span class="sxs-lookup"><span data-stu-id="968d3-483">The following table shows the resources that the [!INCLUDE[ssDE](../includes/ssde-md.md)] can lock.</span></span>  
  
|<span data-ttu-id="968d3-484">Ressource</span><span class="sxs-lookup"><span data-stu-id="968d3-484">Resource</span></span>|<span data-ttu-id="968d3-485">Description</span><span class="sxs-lookup"><span data-stu-id="968d3-485">Description</span></span>|  
|--------------|-----------------|  
|<span data-ttu-id="968d3-486">RID</span><span class="sxs-lookup"><span data-stu-id="968d3-486">RID</span></span>|<span data-ttu-id="968d3-487">Identificateur de ligne utilisé pour verrouiller une seule ligne dans un segment de mémoire.</span><span class="sxs-lookup"><span data-stu-id="968d3-487">A row identifier used to lock a single row within a heap.</span></span>|  
|<span data-ttu-id="968d3-488">KEY</span><span class="sxs-lookup"><span data-stu-id="968d3-488">KEY</span></span>|<span data-ttu-id="968d3-489">Verrou de ligne dans un index utilisé pour protéger des groupes de clés dans les transactions susceptibles d'être sérialisées.</span><span class="sxs-lookup"><span data-stu-id="968d3-489">A row lock within an index used to protect key ranges in serializable transactions.</span></span>|  
|<span data-ttu-id="968d3-490">PAGE</span><span class="sxs-lookup"><span data-stu-id="968d3-490">PAGE</span></span>|<span data-ttu-id="968d3-491">Page de 8 kilo-octets (Ko) dans une base de données, par exemple des pages de données ou d'index.</span><span class="sxs-lookup"><span data-stu-id="968d3-491">An 8-kilobyte (KB) page in a database, such as data or index pages.</span></span>|  
|<span data-ttu-id="968d3-492">EXTENT</span><span class="sxs-lookup"><span data-stu-id="968d3-492">EXTENT</span></span>|<span data-ttu-id="968d3-493">Groupe contigu de huit pages, par exemple des pages de données ou d'index.</span><span class="sxs-lookup"><span data-stu-id="968d3-493">A contiguous group of eight pages, such as data or index pages.</span></span>|  
|<span data-ttu-id="968d3-494">HoBT</span><span class="sxs-lookup"><span data-stu-id="968d3-494">HoBT</span></span>|<span data-ttu-id="968d3-495">Segment de mémoire ou arbre B (B-tree).</span><span class="sxs-lookup"><span data-stu-id="968d3-495">A heap or B-tree.</span></span> <span data-ttu-id="968d3-496">Verrou protégeant un arbre B (B-tree) (index) ou les pages de données de segment de mémoire d'une table ne possédant pas d'index cluster.</span><span class="sxs-lookup"><span data-stu-id="968d3-496">A lock protecting a B-tree (index) or the heap data pages in a table that does not have a clustered index.</span></span>|  
|<span data-ttu-id="968d3-497">TABLE</span><span class="sxs-lookup"><span data-stu-id="968d3-497">TABLE</span></span>|<span data-ttu-id="968d3-498">Table complète comprenant tous les index et toutes les données.</span><span class="sxs-lookup"><span data-stu-id="968d3-498">The entire table, including all data and indexes.</span></span>|  
|<span data-ttu-id="968d3-499">FILE</span><span class="sxs-lookup"><span data-stu-id="968d3-499">FILE</span></span>|<span data-ttu-id="968d3-500">Fichier de base de données.</span><span class="sxs-lookup"><span data-stu-id="968d3-500">A database file.</span></span>|  
|<span data-ttu-id="968d3-501">APPLICATION</span><span class="sxs-lookup"><span data-stu-id="968d3-501">APPLICATION</span></span>|<span data-ttu-id="968d3-502">Ressource spécifiée par une application.</span><span class="sxs-lookup"><span data-stu-id="968d3-502">An application-specified resource.</span></span>|  
|<span data-ttu-id="968d3-503">METADATA</span><span class="sxs-lookup"><span data-stu-id="968d3-503">METADATA</span></span>|<span data-ttu-id="968d3-504">Verrous des métadonnées.</span><span class="sxs-lookup"><span data-stu-id="968d3-504">Metadata locks.</span></span>|  
|<span data-ttu-id="968d3-505">ALLOCATION_UNIT</span><span class="sxs-lookup"><span data-stu-id="968d3-505">ALLOCATION_UNIT</span></span>|<span data-ttu-id="968d3-506">Unité d'allocation.</span><span class="sxs-lookup"><span data-stu-id="968d3-506">An allocation unit.</span></span>|  
|<span data-ttu-id="968d3-507">DATABASE</span><span class="sxs-lookup"><span data-stu-id="968d3-507">DATABASE</span></span>|<span data-ttu-id="968d3-508">Base de données complète.</span><span class="sxs-lookup"><span data-stu-id="968d3-508">The entire database.</span></span>|  
  
> [!NOTE]  
>  <span data-ttu-id="968d3-509">Les verrous HoBT et TABLE peuvent être affectés par l’option LOCK_ESCALATION de l’instruction [ALTER TABLE](/sql/t-sql/statements/alter-table-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="968d3-509">HoBT and TABLE locks can be affected by the LOCK_ESCALATION option of [ALTER TABLE](/sql/t-sql/statements/alter-table-transact-sql).</span></span>  
  
### <a name="lock-modes"></a><span data-ttu-id="968d3-510">Modes de verrouillage</span><span class="sxs-lookup"><span data-stu-id="968d3-510">Lock Modes</span></span>  

 <span data-ttu-id="968d3-511">Le [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] verrouille les ressources en utilisant différents modes de verrouillage qui déterminent le mode d'accès aux ressources par des transactions simultanées.</span><span class="sxs-lookup"><span data-stu-id="968d3-511">The [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] locks resources using different lock modes that determine how the resources can be accessed by concurrent transactions.</span></span>  
  
 <span data-ttu-id="968d3-512">Le tableau suivant illustre les modes de verrouillage des ressources utilisés par le [!INCLUDE[ssDE](../includes/ssde-md.md)].</span><span class="sxs-lookup"><span data-stu-id="968d3-512">The following table shows the resource lock modes that the [!INCLUDE[ssDE](../includes/ssde-md.md)] uses.</span></span>  
  
|<span data-ttu-id="968d3-513">Mode de verrouillage</span><span class="sxs-lookup"><span data-stu-id="968d3-513">Lock mode</span></span>|<span data-ttu-id="968d3-514">Description</span><span class="sxs-lookup"><span data-stu-id="968d3-514">Description</span></span>|  
|---------------|-----------------|  
|<span data-ttu-id="968d3-515">Partagé (S)</span><span class="sxs-lookup"><span data-stu-id="968d3-515">Shared (S)</span></span>|<span data-ttu-id="968d3-516">Utilisé pour les opérations de lecture qui n'effectuent aucune modification ou mise à jour des données, par exemple une instruction SELECT.</span><span class="sxs-lookup"><span data-stu-id="968d3-516">Used for read operations that do not change or update data, such as a SELECT statement.</span></span>|  
|<span data-ttu-id="968d3-517">Mise à jour (U)</span><span class="sxs-lookup"><span data-stu-id="968d3-517">Update (U)</span></span>|<span data-ttu-id="968d3-518">Utilisé pour les ressources pouvant être mises à jour.</span><span class="sxs-lookup"><span data-stu-id="968d3-518">Used on resources that can be updated.</span></span> <span data-ttu-id="968d3-519">Empêche une forme de blocage courante qui se produit lorsque plusieurs sessions lisent, verrouillent et mettent à jour des ressources ultérieurement.</span><span class="sxs-lookup"><span data-stu-id="968d3-519">Prevents a common form of deadlock that occurs when multiple sessions are reading, locking, and potentially updating resources later.</span></span>|  
|<span data-ttu-id="968d3-520">Exclusif (X)</span><span class="sxs-lookup"><span data-stu-id="968d3-520">Exclusive (X)</span></span>|<span data-ttu-id="968d3-521">Utilisé par les opérations de modification de données, telles que INSERT, UPDATE ou DELETE.</span><span class="sxs-lookup"><span data-stu-id="968d3-521">Used for data-modification operations, such as INSERT, UPDATE, or DELETE.</span></span> <span data-ttu-id="968d3-522">Empêche des mises à jour multiples sur la même ressource au même moment.</span><span class="sxs-lookup"><span data-stu-id="968d3-522">Ensures that multiple updates cannot be made to the same resource at the same time.</span></span>|  
|<span data-ttu-id="968d3-523">Intentionnel</span><span class="sxs-lookup"><span data-stu-id="968d3-523">Intent</span></span>|<span data-ttu-id="968d3-524">Permet d'établir une hiérarchie de verrouillage.</span><span class="sxs-lookup"><span data-stu-id="968d3-524">Used to establish a lock hierarchy.</span></span> <span data-ttu-id="968d3-525">Les types de verrouillage intentionnels sont les suivants : les verrous de partage intentionnel (IS), d'exclusion intentionnelle (IX) et de partage intentionnel exclusif (SIX).</span><span class="sxs-lookup"><span data-stu-id="968d3-525">The types of intent locks are: intent shared (IS), intent exclusive (IX), and shared with intent exclusive (SIX).</span></span>|  
|<span data-ttu-id="968d3-526">schéma</span><span class="sxs-lookup"><span data-stu-id="968d3-526">Schema</span></span>|<span data-ttu-id="968d3-527">Utilisé lors de l'exécution d'une opération associée au schéma d'une table.</span><span class="sxs-lookup"><span data-stu-id="968d3-527">Used when an operation dependent on the schema of a table is executing.</span></span> <span data-ttu-id="968d3-528">Les types de verrouillage de schéma sont les suivant : la stabilité du schéma (Sch-S) et la modification du schéma (Sch-M).</span><span class="sxs-lookup"><span data-stu-id="968d3-528">The types of schema locks are: schema modification (Sch-M) and schema stability (Sch-S).</span></span>|  
|<span data-ttu-id="968d3-529">Mise à jour en bloc (BU)</span><span class="sxs-lookup"><span data-stu-id="968d3-529">Bulk Update (BU)</span></span>|<span data-ttu-id="968d3-530">Utilisé lors de la copie en bloc de données dans une table avec l’indicateur **TABLOCK** spécifié.</span><span class="sxs-lookup"><span data-stu-id="968d3-530">Used when bulk copying data into a table and the **TABLOCK** hint is specified.</span></span>|  
|<span data-ttu-id="968d3-531">Verrou de clé</span><span class="sxs-lookup"><span data-stu-id="968d3-531">Key-range</span></span>|<span data-ttu-id="968d3-532">Protège la plage de lignes lue par une requête lorsque le niveau d'isolation des transactions SERIALIZABLE est utilisé.</span><span class="sxs-lookup"><span data-stu-id="968d3-532">Protects the range of rows read by a query when using the serializable transaction isolation level.</span></span> <span data-ttu-id="968d3-533">Garantit qu'aucune autre transaction ne peut insérer des lignes susceptibles de répondre aux requêtes de la transaction sérialisable si ces dernières étaient réexécutées.</span><span class="sxs-lookup"><span data-stu-id="968d3-533">Ensures that other transactions cannot insert rows that would qualify for the queries of the serializable transaction if the queries were run again.</span></span>|  
  
#### <a name="shared-locks"></a><span data-ttu-id="968d3-534">Verrous partagés</span><span class="sxs-lookup"><span data-stu-id="968d3-534">Shared Locks</span></span>  

 <span data-ttu-id="968d3-535">Les verrous partagés (S) permettent à des transactions simultanées de lire (SELECT) une ressource dans des conditions de contrôle d'accès concurrentiel pessimiste.</span><span class="sxs-lookup"><span data-stu-id="968d3-535">Shared (S) locks allow concurrent transactions to read (SELECT) a resource under pessimistic concurrency control.</span></span> <span data-ttu-id="968d3-536">Aucune autre transaction ne peut modifier les données de la ressource tant que des verrous partagés (S) existent sur la ressource.</span><span class="sxs-lookup"><span data-stu-id="968d3-536">No other transactions can modify the data while shared (S) locks exist on the resource.</span></span> <span data-ttu-id="968d3-537">Les verrous partagés (S) sur une ressource sont enlevés dès que l'opération de lecture est terminée, à moins que le niveau d'isolation de la transaction soit de type lecture renouvelable ou plus élevé, ou qu'un indicateur de verrouillage conserve les verrous partagés (S) pendant toute la durée de la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-537">Shared (S) locks on a resource are released as soon as the read operation completes, unless the transaction isolation level is set to repeatable read or higher, or a locking hint is used to retain the shared (S) locks for the duration of the transaction.</span></span>  
  
#### <a name="update-locks"></a><span data-ttu-id="968d3-538">Verrous de mise à jour</span><span class="sxs-lookup"><span data-stu-id="968d3-538">Update Locks</span></span>  

 <span data-ttu-id="968d3-539">Les verrous de mise à jour (U) empêchent une forme fréquente de blocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-539">Update (U) locks prevent a common form of deadlock.</span></span> <span data-ttu-id="968d3-540">Une transaction isolée avec le niveau sérialisable ou de lecture renouvelable lit les données en obtenant un verrou partagé (S) sur la ressource (page ou ligne), puis modifie ces données, ce qui nécessite une conversion du verrou en mode exclusif (X).</span><span class="sxs-lookup"><span data-stu-id="968d3-540">In a repeatable read or serializable transaction, the transaction reads data, acquiring a shared (S) lock on the resource (page or row), and then modifies the data, which requires lock conversion to an exclusive (X) lock.</span></span> <span data-ttu-id="968d3-541">Si deux transactions acquièrent des verrous partagés sur une ressource et tentent ensuite de mettre à jour des données de manière simultanée, une transaction tente de convertir le verrou en verrou exclusif (X).</span><span class="sxs-lookup"><span data-stu-id="968d3-541">If two transactions acquire shared-mode locks on a resource and then attempt to update data concurrently, one transaction attempts the lock conversion to an exclusive (X) lock.</span></span> <span data-ttu-id="968d3-542">La conversion du verrou partagé au mode de verrou exclusif reste en attente, car le verrou exclusif de la première transaction n'est pas compatible avec le verrou partagé de l'autre transaction. Une attente de verrouillage se produit alors.</span><span class="sxs-lookup"><span data-stu-id="968d3-542">The shared-mode-to-exclusive lock conversion must wait because the exclusive lock for one transaction is not compatible with the shared-mode lock of the other transaction; a lock wait occurs.</span></span> <span data-ttu-id="968d3-543">La deuxième transaction impliquée essaie d'acquérir un verrou exclusif (X) pour sa mise à jour.</span><span class="sxs-lookup"><span data-stu-id="968d3-543">The second transaction attempts to acquire an exclusive (X) lock for its update.</span></span> <span data-ttu-id="968d3-544">Puisque les deux transactions effectuant la conversion en verrous exclusifs (X) attendent que l'autre transaction libère son verrou partagé, un blocage se produit.</span><span class="sxs-lookup"><span data-stu-id="968d3-544">Because both transactions are converting to exclusive (X) locks, and they are each waiting for the other transaction to release its shared-mode lock, a deadlock occurs.</span></span>  
  
 <span data-ttu-id="968d3-545">Les verrous de mise à jour (U) permettent de résoudre les problèmes de blocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-545">To avoid this potential deadlock problem, update (U) locks are used.</span></span> <span data-ttu-id="968d3-546">Une seule transaction à la fois peut obtenir un verrou de mise à jour (U) pour une ressource.</span><span class="sxs-lookup"><span data-stu-id="968d3-546">Only one transaction can obtain an update (U) lock to a resource at a time.</span></span> <span data-ttu-id="968d3-547">Si une transaction modifie une ressource, le verrou de mise à jour (U) est converti en verrou exclusif (X).</span><span class="sxs-lookup"><span data-stu-id="968d3-547">If a transaction modifies a resource, the update (U) lock is converted to an exclusive (X) lock.</span></span>  
  
#### <a name="exclusive-locks"></a><span data-ttu-id="968d3-548">Verrous exclusifs</span><span class="sxs-lookup"><span data-stu-id="968d3-548">Exclusive Locks</span></span>  

 <span data-ttu-id="968d3-549">Les verrous exclusifs (X) empêchent l'accès à une ressource par des transactions simultanées.</span><span class="sxs-lookup"><span data-stu-id="968d3-549">Exclusive (X) locks prevent access to a resource by concurrent transactions.</span></span> <span data-ttu-id="968d3-550">Un verrou exclusif (X) empêche toute autre transaction de modifier les données ; les opérations de lecture ne peuvent avoir lieu qu'avec l'indicateur NOLOCK ou le niveau d'isolation « lecture non validée ».</span><span class="sxs-lookup"><span data-stu-id="968d3-550">With an exclusive (X) lock, no other transactions can modify data; read operations can take place only with the use of the NOLOCK hint or read uncommitted isolation level.</span></span>  
  
 <span data-ttu-id="968d3-551">Les instructions qui modifient les données telles que INSERT, UPDATE et DELETE combinent des opérations de modification et de lecture.</span><span class="sxs-lookup"><span data-stu-id="968d3-551">Data modification statements, such as INSERT, UPDATE, and DELETE combine both modification and read operations.</span></span> <span data-ttu-id="968d3-552">Elles commencent par les opérations de lecture pour obtenir les données, puis elles effectuent les opérations de modification.</span><span class="sxs-lookup"><span data-stu-id="968d3-552">The statement first performs read operations to acquire data before performing the required modification operations.</span></span> <span data-ttu-id="968d3-553">Par conséquent, les instructions qui modifient les données demandent généralement à la fois des verrous partagés et des verrous exclusifs.</span><span class="sxs-lookup"><span data-stu-id="968d3-553">Data modification statements, therefore, typically request both shared locks and exclusive locks.</span></span> <span data-ttu-id="968d3-554">Ainsi, une instruction UPDATE peut modifier les lignes d'une table en fonction d'une jointure avec une autre table.</span><span class="sxs-lookup"><span data-stu-id="968d3-554">For example, an UPDATE statement might modify rows in one table based on a join with another table.</span></span> <span data-ttu-id="968d3-555">Dans ce cas, l'instruction UPDATE demande des verrous partagés sur les lignes lues dans la table jointe en plus des verrous exclusifs sur les lignes mises à jour.</span><span class="sxs-lookup"><span data-stu-id="968d3-555">In this case, the UPDATE statement requests shared locks on the rows read in the join table in addition to requesting exclusive locks on the updated rows.</span></span>  
  
#### <a name="intent-locks"></a><span data-ttu-id="968d3-556">Verrous intentionnels</span><span class="sxs-lookup"><span data-stu-id="968d3-556">Intent Locks</span></span>  

 <span data-ttu-id="968d3-557">Le [!INCLUDE[ssDE](../includes/ssde-md.md)] utilise des verrous intentionnels pour protéger le placement de verrous partagés (S) ou exclusifs (X) sur une ressource hiérarchiquement inférieure.</span><span class="sxs-lookup"><span data-stu-id="968d3-557">The [!INCLUDE[ssDE](../includes/ssde-md.md)] uses intent locks to protect placing a shared (S) lock or exclusive (X) lock on a resource lower in the lock hierarchy.</span></span> <span data-ttu-id="968d3-558">Les verrous intentionnels sont appelés ainsi parce qu'ils sont obtenus avant un verrou de niveau inférieur et signalent par conséquent l'intention de placer des verrous à un niveau inférieur.</span><span class="sxs-lookup"><span data-stu-id="968d3-558">Intent locks are named intent locks because they are acquired before a lock at the lower level, and therefore signal intent to place locks at a lower level.</span></span>  
  
 <span data-ttu-id="968d3-559">Les verrous intentionnels ont deux fonctions :</span><span class="sxs-lookup"><span data-stu-id="968d3-559">Intent locks serve two purposes:</span></span>  
  
-   <span data-ttu-id="968d3-560">Empêcher les autres transactions de modifier la ressource de niveau supérieur de façon à invalider le verrou au niveau inférieur.</span><span class="sxs-lookup"><span data-stu-id="968d3-560">To prevent other transactions from modifying the higher-level resource in a way that would invalidate the lock at the lower level.</span></span>  
  
-   <span data-ttu-id="968d3-561">Améliorer l’efficacité du [!INCLUDE[ssDE](../includes/ssde-md.md)] en matière de détection de conflits de verrous au plus haut niveau de granularité.</span><span class="sxs-lookup"><span data-stu-id="968d3-561">To improve the efficiency of the [!INCLUDE[ssDE](../includes/ssde-md.md)] in detecting lock conflicts at the higher level of granularity.</span></span>  
  
 <span data-ttu-id="968d3-562">Par exemple, un verrou de partage intentionnel est demandé au niveau table avant une demande de verrous partagés (S) sur les pages ou les lignes de cette table.</span><span class="sxs-lookup"><span data-stu-id="968d3-562">For example, a shared intent lock is requested at the table level before shared (S) locks are requested on pages or rows within that table.</span></span> <span data-ttu-id="968d3-563">Un verrou intentionnel placé au niveau de la table empêche une autre transaction d'acquérir un verrou exclusif (X) sur la table contenant cette page.</span><span class="sxs-lookup"><span data-stu-id="968d3-563">Setting an intent lock at the table level prevents another transaction from subsequently acquiring an exclusive (X) lock on the table containing that page.</span></span> <span data-ttu-id="968d3-564">Les verrous intentionnels améliorent les performances, car le [!INCLUDE[ssDE](../includes/ssde-md.md)] n’examine les verrous intentionnels qu’au niveau des tables afin de déterminer si une transaction peut acquérir un verrou en toute sécurité sur chaque table.</span><span class="sxs-lookup"><span data-stu-id="968d3-564">Intent locks improve performance because the [!INCLUDE[ssDE](../includes/ssde-md.md)] examines intent locks only at the table level to determine if a transaction can safely acquire a lock on that table.</span></span> <span data-ttu-id="968d3-565">Cela supprime la nécessité d'examiner chaque verrou de ligne ou page pour déterminer si une transaction peut verrouiller la table entière.</span><span class="sxs-lookup"><span data-stu-id="968d3-565">This removes the requirement to examine every row or page lock on the table to determine if a transaction can lock the entire table.</span></span>  
  
 <span data-ttu-id="968d3-566">Les verrous intentionnels comprennent les verrous de partage intentionnel (IS), d'exclusion intentionnelle (IX), et de partage intentionnel exclusif (SIX).</span><span class="sxs-lookup"><span data-stu-id="968d3-566">Intent locks include intent shared (IS), intent exclusive (IX), and shared with intent exclusive (SIX).</span></span>  
  
|<span data-ttu-id="968d3-567">Mode de verrouillage</span><span class="sxs-lookup"><span data-stu-id="968d3-567">Lock mode</span></span>|<span data-ttu-id="968d3-568">Description</span><span class="sxs-lookup"><span data-stu-id="968d3-568">Description</span></span>|  
|---------------|-----------------|  
|<span data-ttu-id="968d3-569">Intent partagé (IS)</span><span class="sxs-lookup"><span data-stu-id="968d3-569">Intent shared (IS)</span></span>|<span data-ttu-id="968d3-570">Protège les verrous partagés demandés ou acquis sur certaines ressources (mais pas toutes) de niveau inférieur dans la hiérarchie.</span><span class="sxs-lookup"><span data-stu-id="968d3-570">Protects requested or acquired shared locks on some (but not all) resources lower in the hierarchy.</span></span>|  
|<span data-ttu-id="968d3-571">Intent exclusif (IX)</span><span class="sxs-lookup"><span data-stu-id="968d3-571">Intent exclusive (IX)</span></span>|<span data-ttu-id="968d3-572">Protège les verrous exclusifs demandés ou acquis sur certaines ressources (mais pas toutes) de niveau inférieur dans la hiérarchie.</span><span class="sxs-lookup"><span data-stu-id="968d3-572">Protects requested or acquired exclusive locks on some (but not all) resources lower in the hierarchy.</span></span> <span data-ttu-id="968d3-573">IX est un sur-ensemble du mode IS qui protège également les demandes de verrou partagé sur des ressources de niveau inférieur.</span><span class="sxs-lookup"><span data-stu-id="968d3-573">IX is a superset of IS, and it also protects requesting shared locks on lower level resources.</span></span>|  
|<span data-ttu-id="968d3-574">Partagé avec intent exclusif (SIX)</span><span class="sxs-lookup"><span data-stu-id="968d3-574">Shared with intent exclusive (SIX)</span></span>|<span data-ttu-id="968d3-575">Protège les verrous partagés (S) demandés ou acquis sur toutes les ressources de niveau inférieur dans la hiérarchie et les verrous d'exclusion intentionnelle sur certaines ressources de niveau inférieur (mais pas toutes).</span><span class="sxs-lookup"><span data-stu-id="968d3-575">Protects requested or acquired shared locks on all resources lower in the hierarchy and intent exclusive locks on some (but not all) of the lower level resources.</span></span> <span data-ttu-id="968d3-576">Les lectures simultanées sur les ressources de niveau supérieur sont autorisées.</span><span class="sxs-lookup"><span data-stu-id="968d3-576">Concurrent IS locks at the top-level resource are allowed.</span></span> <span data-ttu-id="968d3-577">Par exemple, l'obtention d'un verrou SIX sur une table permet également d'obtenir des verrous d'exclusion intentionnelle sur les pages modifiées et des verrous exclusifs sur les lignes modifiées.</span><span class="sxs-lookup"><span data-stu-id="968d3-577">For example, acquiring a SIX lock on a table also acquires intent exclusive locks on the pages being modified and exclusive locks on the modified rows.</span></span> <span data-ttu-id="968d3-578">Il ne peut y avoir qu'un seul verrou SIX par ressource à la fois pour empêcher la mise à jour des ressources par une autre transaction, bien que cette dernière peut lire les ressources inférieures dans la hiérarchie en obtenant des verrous IS au niveau des tables.</span><span class="sxs-lookup"><span data-stu-id="968d3-578">There can be only one SIX lock per resource at one time, preventing updates to the resource made by other transactions, although other transactions can read resources lower in the hierarchy by obtaining IS locks at the table level.</span></span>|  
|<span data-ttu-id="968d3-579">Mise à jour intentionnelle (IU)</span><span class="sxs-lookup"><span data-stu-id="968d3-579">Intent update (IU)</span></span>|<span data-ttu-id="968d3-580">Protège les verrous de mise à jour demandés ou acquis sur toutes les ressources de niveau inférieur dans la hiérarchie.</span><span class="sxs-lookup"><span data-stu-id="968d3-580">Protects requested or acquired update locks on all resources lower in the hierarchy.</span></span> <span data-ttu-id="968d3-581">Les verrous IU sont utilisés uniquement sur les ressources de page.</span><span class="sxs-lookup"><span data-stu-id="968d3-581">IU locks are used only on page resources.</span></span> <span data-ttu-id="968d3-582">Les verrous IU sont convertis en verrous IX si une opération de mise à jour a lieu.</span><span class="sxs-lookup"><span data-stu-id="968d3-582">IU locks are converted to IX locks if an update operation takes place.</span></span>|  
|<span data-ttu-id="968d3-583">Mise à jour intentionnelle partagée (SIU)</span><span class="sxs-lookup"><span data-stu-id="968d3-583">Shared intent update (SIU)</span></span>|<span data-ttu-id="968d3-584">Combinaison de verrous S et IU résultant de l'acquisition séparée de ces verrous et de leur gestion simultanée.</span><span class="sxs-lookup"><span data-stu-id="968d3-584">A combination of S and IU locks, as a result of acquiring these locks separately and simultaneously holding both locks.</span></span> <span data-ttu-id="968d3-585">Par exemple, une transaction peut exécuter une requête avec l'indicateur PAGLOCK, puis une opération de mise à jour.</span><span class="sxs-lookup"><span data-stu-id="968d3-585">For example, a transaction executes a query with the PAGLOCK hint and then executes an update operation.</span></span> <span data-ttu-id="968d3-586">La requête contenant l'indicateur PAGLOCK obtient le verrou S et l'opération de mise à jour obtient le verrou IU.</span><span class="sxs-lookup"><span data-stu-id="968d3-586">The query with the PAGLOCK hint acquires the S lock, and the update operation acquires the IU lock.</span></span>|  
|<span data-ttu-id="968d3-587">Mise à jour intentionnelle exclusive (UIX)</span><span class="sxs-lookup"><span data-stu-id="968d3-587">Update intent exclusive (UIX)</span></span>|<span data-ttu-id="968d3-588">Combinaison de verrous U et IX résultant de l'acquisition séparée de ces verrous et de leur gestion simultanée.</span><span class="sxs-lookup"><span data-stu-id="968d3-588">A combination of U and IX locks, as a result of acquiring these locks separately and simultaneously holding both locks.</span></span>|  
  
#### <a name="schema-locks"></a><span data-ttu-id="968d3-589">Verrous de schéma</span><span class="sxs-lookup"><span data-stu-id="968d3-589">Schema Locks</span></span>  

 <span data-ttu-id="968d3-590">Le [!INCLUDE[ssDE](../includes/ssde-md.md)] utilise les verrous de modification de schémas (Sch-M) quand une opération de langage de définition de données (DDL, Data Definition Language) est effectuée sur une table (ajout d’une colonne ou suppression d’une table, par exemple).</span><span class="sxs-lookup"><span data-stu-id="968d3-590">The [!INCLUDE[ssDE](../includes/ssde-md.md)] uses schema modification (Sch-M) locks during a table data definition language (DDL) operation, such as adding a column or dropping a table.</span></span> <span data-ttu-id="968d3-591">Pendant le temps de sa détention, le verrou Sch-M empêche les accès simultanés à la table.</span><span class="sxs-lookup"><span data-stu-id="968d3-591">During the time that it is held, the Sch-M lock prevents concurrent access to the table.</span></span> <span data-ttu-id="968d3-592">Cela signifie que le verrou Sch-M bloque toutes les opérations externes jusqu'à ce que le verrou soit libéré.</span><span class="sxs-lookup"><span data-stu-id="968d3-592">This means the Sch-M lock blocks all outside operations until the lock is released.</span></span>  
  
 <span data-ttu-id="968d3-593">Certaines opérations DML(langage de manipulation de données), comme la troncation de table, utilisent les verrous SCH-M pour empêcher l'accès aux tables affectées par des opérations simultanées.</span><span class="sxs-lookup"><span data-stu-id="968d3-593">Some data manipulation language (DML) operations, such as table truncation, use Sch-M locks to prevent access to affected tables by concurrent operations.</span></span>  
  
 <span data-ttu-id="968d3-594">Le [!INCLUDE[ssDE](../includes/ssde-md.md)] utilise les verrous de stabilité de schéma (Sch-S) lors de la compilation et l’exécution des requêtes.</span><span class="sxs-lookup"><span data-stu-id="968d3-594">The [!INCLUDE[ssDE](../includes/ssde-md.md)] uses schema stability (Sch-S) locks when compiling and executing queries.</span></span> <span data-ttu-id="968d3-595">Les verrous Sch-S ne bloquent aucun verrou transactionnel, verrous exclusifs (X) y compris.</span><span class="sxs-lookup"><span data-stu-id="968d3-595">Sch-S locks do not block any transactional locks, including exclusive (X) locks.</span></span> <span data-ttu-id="968d3-596">Par conséquent, les autres transactions, y compris celles avec des verrous exclusifs (X) sur une table, continuent à s'exécuter pendant la compilation d'une requête.</span><span class="sxs-lookup"><span data-stu-id="968d3-596">Therefore, other transactions, including those with X locks on a table, continue to run while a query is being compiled.</span></span> <span data-ttu-id="968d3-597">Toutefois, les opérations DDL simultanées, ainsi que les opérations DML simultanées qui définissent des verrous Sch-M, ne peuvent pas être exécutées sur la table.</span><span class="sxs-lookup"><span data-stu-id="968d3-597">However, concurrent DDL operations, and concurrent DML operations that acquire Sch-M locks, cannot be performed on the table.</span></span>  
  
#### <a name="bulk-update-locks"></a><span data-ttu-id="968d3-598">Verrous de mise à jour en bloc (BU)</span><span class="sxs-lookup"><span data-stu-id="968d3-598">Bulk Update Locks</span></span>  

 <span data-ttu-id="968d3-599">Les verrous BU permettent à plusieurs threads de charger simultanément en masse des données dans la même table tout en empêchant les processus qui n'effectuent pas de chargement de données en masse d'accéder à cette table.</span><span class="sxs-lookup"><span data-stu-id="968d3-599">Bulk update (BU) locks allow multiple threads to bulk load data concurrently into the same table while preventing other processes that are not bulk loading data from accessing the table.</span></span> <span data-ttu-id="968d3-600">Le [!INCLUDE[ssDE](../includes/ssde-md.md)] utilise des verrous BU lorsque les deux conditions suivantes sont vraies.</span><span class="sxs-lookup"><span data-stu-id="968d3-600">The [!INCLUDE[ssDE](../includes/ssde-md.md)] uses bulk update (BU) locks when both of the following conditions are true.</span></span>  
  
-   <span data-ttu-id="968d3-601">Vous utilisez l'instruction Transact-SQL BULK INSERT, ou la fonction OPENROWSET(BULK), ou vous utilisez une des commandes d'API Bulk Insert, telles que .NET SqlBulkCopy, les API OLEDB Fast Load, ou les API ODBC Bulk Copy pour copier en bloc des données dans une table.</span><span class="sxs-lookup"><span data-stu-id="968d3-601">You use the Transact-SQL BULK INSERT statement, or the OPENROWSET(BULK) function, or you use one of the Bulk Insert API commands such as .NET SqlBulkCopy, OLEDB Fast Load APIs, or the ODBC Bulk Copy APIs to bulk copy data into a table.</span></span>  
  
-   <span data-ttu-id="968d3-602">L’indicateur **TABLOCK** est spécifié ou l’option de table **table lock on bulk load** est définie à l’aide de **sp_tableoption**.</span><span class="sxs-lookup"><span data-stu-id="968d3-602">The **TABLOCK** hint is specified or the **table lock on bulk load** table option is set using **sp_tableoption**.</span></span>  
  
> [!TIP]  
>  <span data-ttu-id="968d3-603">Contrairement à l’instruction BULK INSERT, qui maintient un verrou de mise à jour en bloc moins restrictif, INSERT INTO...SELECT avec l’indicateur TABLOCK maintient un verrou exclusif (X) sur la table.</span><span class="sxs-lookup"><span data-stu-id="968d3-603">Unlike the BULK INSERT statement, which holds a less restrictive Bulk Update lock, INSERT INTO...SELECT with the TABLOCK hint holds an exclusive (X) lock on the table.</span></span> <span data-ttu-id="968d3-604">Cela signifie que vous ne pouvez pas insérer de lignes à l'aide d'opérations d'insertion parallèles.</span><span class="sxs-lookup"><span data-stu-id="968d3-604">This means that you cannot insert rows using parallel insert operations.</span></span>  
  
#### <a name="key-range-locks"></a><span data-ttu-id="968d3-605">Verrous de clés</span><span class="sxs-lookup"><span data-stu-id="968d3-605">Key-Range Locks</span></span>  

 <span data-ttu-id="968d3-606">Les verrous d'étendues de clés protègent une plage de lignes implicitement incluses dans un jeu d'enregistrements lu par une instruction [!INCLUDE[tsql](../includes/tsql-md.md)] lors de l'utilisation du niveau d'isolement des transactions sérialisable.</span><span class="sxs-lookup"><span data-stu-id="968d3-606">Key-range locks protect a range of rows implicitly included in a record set being read by a [!INCLUDE[tsql](../includes/tsql-md.md)] statement while using the serializable transaction isolation level.</span></span> <span data-ttu-id="968d3-607">Le verrouillage d'étendues de clés empêche les lectures fantômes.</span><span class="sxs-lookup"><span data-stu-id="968d3-607">Key-range locking prevents phantom reads.</span></span> <span data-ttu-id="968d3-608">Les verrous d'étendues de clés couvrent des enregistrements individuels et les étendues entre les enregistrements, empêchant les insertions ou les suppressions fantômes dans un ensemble d'enregistrements auquel accède une transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-608">By protecting the ranges of keys between rows, it also prevents phantom insertions or deletions into a record set accessed by a transaction.</span></span>  
  
### <a name="lock-compatibility"></a><span data-ttu-id="968d3-609">Compatibilité de verrouillage</span><span class="sxs-lookup"><span data-stu-id="968d3-609">Lock Compatibility</span></span>  

 <span data-ttu-id="968d3-610">La compatibilité de verrouillage détermine si plusieurs transactions peuvent simultanément acquérir des verrous sur la même ressource.</span><span class="sxs-lookup"><span data-stu-id="968d3-610">Lock compatibility controls whether multiple transactions can acquire locks on the same resource at the same time.</span></span> <span data-ttu-id="968d3-611">Si une ressource est déjà verrouillée par une autre transaction, une demande de nouveau verrou ne peut être accordée que si le mode du verrou demandé est compatible avec celui du verrou existant.</span><span class="sxs-lookup"><span data-stu-id="968d3-611">If a resource is already locked by another transaction, a new lock request can be granted only if the mode of the requested lock is compatible with the mode of the existing lock.</span></span> <span data-ttu-id="968d3-612">Si le mode du verrou demandé n'est pas compatible avec le verrou existant, la transaction qui demande le nouveau verrou attend que le verrou existant soit libéré ou que l'intervalle de délai de verrouillage ait expiré.</span><span class="sxs-lookup"><span data-stu-id="968d3-612">If the mode of the requested lock is not compatible with the existing lock, the transaction requesting the new lock waits for the existing lock to be released or for the lock timeout interval to expire.</span></span> <span data-ttu-id="968d3-613">Par exemple, aucun mode de verrou n'est compatible avec les verrous exclusifs.</span><span class="sxs-lookup"><span data-stu-id="968d3-613">For example, no lock modes are compatible with exclusive locks.</span></span> <span data-ttu-id="968d3-614">Lorsqu'un verrou exclusif (X) est posé, aucune autre transaction ne peut acquérir un verrou de quelque sorte que ce soit (partagé, mise à jour, exclusif) sur cette ressource tant que le verrou exclusif (X) n'a pas été libéré.</span><span class="sxs-lookup"><span data-stu-id="968d3-614">While an exclusive (X) lock is held, no other transaction can acquire a lock of any kind (shared, update, or exclusive) on that resource until the exclusive (X) lock is released.</span></span> <span data-ttu-id="968d3-615">Inversement, si un verrou partagé (S) a été appliqué à une ressource, les autres transactions peuvent aussi acquérir un verrou partagé ou de mise à jour (U) sur cet élément, même si la première transaction n'est pas terminée.</span><span class="sxs-lookup"><span data-stu-id="968d3-615">Alternatively, if a shared (S) lock has been applied to a resource, other transactions can also acquire a shared lock or an update (U) lock on that item even if the first transaction has not completed.</span></span> <span data-ttu-id="968d3-616">Toutefois, les autres transactions ne peuvent pas acquérir un verrou exclusif tant que le verrou partagé n'a pas été libéré.</span><span class="sxs-lookup"><span data-stu-id="968d3-616">However, other transactions cannot acquire an exclusive lock until the shared lock has been released.</span></span>  
  
 <span data-ttu-id="968d3-617">Le tableau suivant décrit la compatibilité des modes de verrou les plus courants.</span><span class="sxs-lookup"><span data-stu-id="968d3-617">The following table shows the compatibility of the most commonly encountered lock modes.</span></span>  
  
||<span data-ttu-id="968d3-618">Mode accordé existant</span><span class="sxs-lookup"><span data-stu-id="968d3-618">Existing granted mode</span></span>||||||  
|------|---------------------------|------|------|------|------|------|  
|<span data-ttu-id="968d3-619">**Mode requis**</span><span class="sxs-lookup"><span data-stu-id="968d3-619">**Requested mode**</span></span>|<span data-ttu-id="968d3-620">**IS**</span><span class="sxs-lookup"><span data-stu-id="968d3-620">**IS**</span></span>|<span data-ttu-id="968d3-621">**S**</span><span class="sxs-lookup"><span data-stu-id="968d3-621">**S**</span></span>|<span data-ttu-id="968d3-622">**U**</span><span class="sxs-lookup"><span data-stu-id="968d3-622">**U**</span></span>|<span data-ttu-id="968d3-623">**IX**</span><span class="sxs-lookup"><span data-stu-id="968d3-623">**IX**</span></span>|<span data-ttu-id="968d3-624">**SIX**</span><span class="sxs-lookup"><span data-stu-id="968d3-624">**SIX**</span></span>|<span data-ttu-id="968d3-625">**X**</span><span class="sxs-lookup"><span data-stu-id="968d3-625">**X**</span></span>|  
|<span data-ttu-id="968d3-626">**Intent partagé (IS)**</span><span class="sxs-lookup"><span data-stu-id="968d3-626">**Intent shared (IS)**</span></span>|<span data-ttu-id="968d3-627">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-627">Yes</span></span>|<span data-ttu-id="968d3-628">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-628">Yes</span></span>|<span data-ttu-id="968d3-629">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-629">Yes</span></span>|<span data-ttu-id="968d3-630">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-630">Yes</span></span>|<span data-ttu-id="968d3-631">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-631">Yes</span></span>|<span data-ttu-id="968d3-632">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-632">No</span></span>|  
|<span data-ttu-id="968d3-633">**Partagé (S)**</span><span class="sxs-lookup"><span data-stu-id="968d3-633">**Shared (S)**</span></span>|<span data-ttu-id="968d3-634">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-634">Yes</span></span>|<span data-ttu-id="968d3-635">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-635">Yes</span></span>|<span data-ttu-id="968d3-636">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-636">Yes</span></span>|<span data-ttu-id="968d3-637">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-637">No</span></span>|<span data-ttu-id="968d3-638">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-638">No</span></span>|<span data-ttu-id="968d3-639">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-639">No</span></span>|  
|<span data-ttu-id="968d3-640">**Mise à jour (U)**</span><span class="sxs-lookup"><span data-stu-id="968d3-640">**Update (U)**</span></span>|<span data-ttu-id="968d3-641">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-641">Yes</span></span>|<span data-ttu-id="968d3-642">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-642">Yes</span></span>|<span data-ttu-id="968d3-643">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-643">No</span></span>|<span data-ttu-id="968d3-644">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-644">No</span></span>|<span data-ttu-id="968d3-645">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-645">No</span></span>|<span data-ttu-id="968d3-646">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-646">No</span></span>|  
|<span data-ttu-id="968d3-647">**Intent exclusif (IX)**</span><span class="sxs-lookup"><span data-stu-id="968d3-647">**Intent exclusive (IX)**</span></span>|<span data-ttu-id="968d3-648">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-648">Yes</span></span>|<span data-ttu-id="968d3-649">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-649">No</span></span>|<span data-ttu-id="968d3-650">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-650">No</span></span>|<span data-ttu-id="968d3-651">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-651">Yes</span></span>|<span data-ttu-id="968d3-652">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-652">No</span></span>|<span data-ttu-id="968d3-653">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-653">No</span></span>|  
|<span data-ttu-id="968d3-654">**Partagé avec intent exclusif (SIX)**</span><span class="sxs-lookup"><span data-stu-id="968d3-654">**Shared with intent exclusive (SIX)**</span></span>|<span data-ttu-id="968d3-655">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-655">Yes</span></span>|<span data-ttu-id="968d3-656">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-656">No</span></span>|<span data-ttu-id="968d3-657">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-657">No</span></span>|<span data-ttu-id="968d3-658">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-658">No</span></span>|<span data-ttu-id="968d3-659">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-659">No</span></span>|<span data-ttu-id="968d3-660">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-660">No</span></span>|  
|<span data-ttu-id="968d3-661">**Exclusif (X)**</span><span class="sxs-lookup"><span data-stu-id="968d3-661">**Exclusive (X)**</span></span>|<span data-ttu-id="968d3-662">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-662">No</span></span>|<span data-ttu-id="968d3-663">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-663">No</span></span>|<span data-ttu-id="968d3-664">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-664">No</span></span>|<span data-ttu-id="968d3-665">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-665">No</span></span>|<span data-ttu-id="968d3-666">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-666">No</span></span>|<span data-ttu-id="968d3-667">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-667">No</span></span>|  
  
> [!NOTE]  
>  <span data-ttu-id="968d3-668">Un verrou intent exclusif (IX) est compatible avec un mode de verrouillage IX car IX signifie l'intention de mettre à jour uniquement certaines lignes et non pas toutes les lignes.</span><span class="sxs-lookup"><span data-stu-id="968d3-668">An intent exclusive (IX) lock is compatible with an IX lock mode because IX means the intention is to update only some of the rows rather than all of them.</span></span> <span data-ttu-id="968d3-669">Les autres transactions qui essaient de lire ou de mettre à jour certaines lignes sont aussi autorisées si elles ne mettent pas à jour les lignes en cours de mise à jour par les autres transactions.</span><span class="sxs-lookup"><span data-stu-id="968d3-669">Other transactions that attempt to read or update some of the rows are also permitted as long as they are not the same rows being updated by other transactions.</span></span> <span data-ttu-id="968d3-670">De plus, si deux transactions essaient de mettre à jour la même ligne, un verrou IX sera accordé aux deux transactions au niveau de la table et de la page.</span><span class="sxs-lookup"><span data-stu-id="968d3-670">Further, if two transactions attempt to update the same row, both transactions will be granted an IX lock at table and page level.</span></span> <span data-ttu-id="968d3-671">Toutefois, un verrou X sera accordé à une transaction au niveau de la ligne.</span><span class="sxs-lookup"><span data-stu-id="968d3-671">However, one transaction will be granted an X lock at row level.</span></span> <span data-ttu-id="968d3-672">L'autre transaction doit attendre jusqu'à ce que le verrouillage au niveau de la ligne soit supprimé.</span><span class="sxs-lookup"><span data-stu-id="968d3-672">The other transaction must wait until the row-level lock is removed.</span></span>  
  
 <span data-ttu-id="968d3-673">Utilisez le tableau suivant pour déterminer la compatibilité de tous les modes de verrou disponibles dans [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="968d3-673">Use the following table to determine the compatibility of all the lock modes available in [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span>  
  
 <span data-ttu-id="968d3-674">![Diagramme affichant la matrice de compatibilité des verrous](media/lockconflicttable.gif "Diagramme affichant la matrice de compatibilité des verrous")</span><span class="sxs-lookup"><span data-stu-id="968d3-674">![Diagram showing lock compatibility matrix](media/lockconflicttable.gif "Diagram showing lock compatibility matrix")</span></span>  
  
### <a name="key-range-locking"></a><span data-ttu-id="968d3-675">Verrouillage d'étendues de clés</span><span class="sxs-lookup"><span data-stu-id="968d3-675">Key-Range Locking</span></span>  

 <span data-ttu-id="968d3-676">Les verrous d'étendues de clés protègent une plage de lignes implicitement incluses dans un jeu d'enregistrements lu par une instruction [!INCLUDE[tsql](../includes/tsql-md.md)] lors de l'utilisation du niveau d'isolement des transactions sérialisable.</span><span class="sxs-lookup"><span data-stu-id="968d3-676">Key-range locks protect a range of rows implicitly included in a record set being read by a [!INCLUDE[tsql](../includes/tsql-md.md)] statement while using the serializable transaction isolation level.</span></span> <span data-ttu-id="968d3-677">Le niveau d'isolement sérialisable exige que toute requête exécutée pendant une transaction obtienne le même jeu de lignes à chaque exécution lors de la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-677">The serializable isolation level requires that any query executed during a transaction must obtain the same set of rows every time it is executed during the transaction.</span></span> <span data-ttu-id="968d3-678">Un verrou d'étendues de clés protège cette exigence en empêchant d'autres transactions d'insérer de nouvelles lignes dont les clés sont comprises dans la plage des clés lues par la transaction sérialisable.</span><span class="sxs-lookup"><span data-stu-id="968d3-678">A key range lock protects this requirement by preventing other transactions from inserting new rows whose keys would fall in the range of keys read by the serializable transaction.</span></span>  
  
 <span data-ttu-id="968d3-679">Le verrouillage d'étendues de clés empêche les lectures fantômes.</span><span class="sxs-lookup"><span data-stu-id="968d3-679">Key-range locking prevents phantom reads.</span></span> <span data-ttu-id="968d3-680">La protection des étendues de clés entre les lignes permet également d'empêcher les insertions fantômes dans un jeu d'enregistrements auquel une transaction accède.</span><span class="sxs-lookup"><span data-stu-id="968d3-680">By protecting the ranges of keys between rows, it also prevents phantom insertions into a set of records accessed by a transaction.</span></span>  
  
 <span data-ttu-id="968d3-681">Un verrou d'étendues de clés est placé sur un index, spécifiant une valeur de clé de début et de fin.</span><span class="sxs-lookup"><span data-stu-id="968d3-681">A key-range lock is placed on an index, specifying a beginning and ending key value.</span></span> <span data-ttu-id="968d3-682">Ce verrou bloque toute tentative d'insertion, de mise à jour ou de suppression de ligne possédant une valeur de clé comprise dans cette étendue, car ces opérations doivent d'abord acquérir un verrou sur l'index.</span><span class="sxs-lookup"><span data-stu-id="968d3-682">This lock blocks any attempt to insert, update, or delete any row with a key value that falls in the range because those operations would first have to acquire a lock on the index.</span></span> <span data-ttu-id="968d3-683">Par exemple, une transaction sérialisable peut émettre une instruction SELECT qui lit toutes les lignes dont les valeurs de clés sont comprises entre **'** AAA **'** et **'** CZZ **'**.</span><span class="sxs-lookup"><span data-stu-id="968d3-683">For example, a serializable transaction could issue a SELECT statement that reads all rows whose key values are between **'** AAA **'** and **'** CZZ **'**.</span></span> <span data-ttu-id="968d3-684">Un verrou de groupes de clés sur les valeurs de clés comprises entre **'** AAA **'** et **'** CZZ **'** empêche les autres transactions d’insérer des lignes possédant des valeurs de clés comprises dans ce groupe, telles que **'** ADG **'** , **'** BBD **'** ou **'** CAL **'** .</span><span class="sxs-lookup"><span data-stu-id="968d3-684">A key-range lock on the key values in the range from **'** AAA **'** to **'** CZZ **'** prevents other transactions from inserting rows with key values anywhere in that range, such as **'** ADG **'**, **'** BBD **'**, or **'** CAL **'**.</span></span>  
  
#### <a name="key-range-lock-modes"></a><span data-ttu-id="968d3-685">Modes de verrouillage d'étendues de clés</span><span class="sxs-lookup"><span data-stu-id="968d3-685">Key-Range Lock Modes</span></span>  

 <span data-ttu-id="968d3-686">Les verrous d'étendues de clés comprennent un composant étendue et un composant ligne, au format étendue-ligne :</span><span class="sxs-lookup"><span data-stu-id="968d3-686">Key-range locks include both a range and a row component specified in range-row format:</span></span>  
  
-   <span data-ttu-id="968d3-687">L'étendue représente le mode de verrouillage protégeant l'étendue entre deux entrées d'index successives.</span><span class="sxs-lookup"><span data-stu-id="968d3-687">Range represents the lock mode protecting the range between two consecutive index entries.</span></span>  
  
-   <span data-ttu-id="968d3-688">La ligne représente le mode de verrouillage protégeant l'entrée de l'index.</span><span class="sxs-lookup"><span data-stu-id="968d3-688">Row represents the lock mode protecting the index entry.</span></span>  
  
-   <span data-ttu-id="968d3-689">Le mode représente la combinaison de modes de verrouillage utilisée.</span><span class="sxs-lookup"><span data-stu-id="968d3-689">Mode represents the combined lock mode used.</span></span> <span data-ttu-id="968d3-690">Les modes de verrouillage d'étendues de clés comportent deux parties.</span><span class="sxs-lookup"><span data-stu-id="968d3-690">Key-range lock modes consist of two parts.</span></span> <span data-ttu-id="968d3-691">La première représente le type de verrou utilisé pour verrouiller l’étendue d’index (Range*T*) et la deuxième représente le type de verrou utilisé pour verrouiller une clé spécifique (*K*).</span><span class="sxs-lookup"><span data-stu-id="968d3-691">The first represents the type of lock used to lock the index range (Range*T*) and the second represents the lock type used to lock a specific key (*K*).</span></span> <span data-ttu-id="968d3-692">Les deux parties sont reliées par un tiret (-), par exemple Range*T*-*K*.</span><span class="sxs-lookup"><span data-stu-id="968d3-692">The two parts are connected with a hyphen (-), such as Range*T*-*K*.</span></span>  
  
    |<span data-ttu-id="968d3-693">Plage</span><span class="sxs-lookup"><span data-stu-id="968d3-693">Range</span></span>|<span data-ttu-id="968d3-694">Ligne</span><span class="sxs-lookup"><span data-stu-id="968d3-694">Row</span></span>|<span data-ttu-id="968d3-695">Mode</span><span class="sxs-lookup"><span data-stu-id="968d3-695">Mode</span></span>|<span data-ttu-id="968d3-696">Description</span><span class="sxs-lookup"><span data-stu-id="968d3-696">Description</span></span>|  
    |-----------|---------|----------|-----------------|  
    |<span data-ttu-id="968d3-697">RangeS</span><span class="sxs-lookup"><span data-stu-id="968d3-697">RangeS</span></span>|<span data-ttu-id="968d3-698">S</span><span class="sxs-lookup"><span data-stu-id="968d3-698">S</span></span>|<span data-ttu-id="968d3-699">RangeS-S</span><span class="sxs-lookup"><span data-stu-id="968d3-699">RangeS-S</span></span>|<span data-ttu-id="968d3-700">Verrou de ressource partagé, étendue partagée ; analyse de plage sérialisable.</span><span class="sxs-lookup"><span data-stu-id="968d3-700">Shared range, shared resource lock; serializable range scan.</span></span>|  
    |<span data-ttu-id="968d3-701">RangeS</span><span class="sxs-lookup"><span data-stu-id="968d3-701">RangeS</span></span>|<span data-ttu-id="968d3-702">U</span><span class="sxs-lookup"><span data-stu-id="968d3-702">U</span></span>|<span data-ttu-id="968d3-703">RangeS-U</span><span class="sxs-lookup"><span data-stu-id="968d3-703">RangeS-U</span></span>|<span data-ttu-id="968d3-704">Verrou de mise à jour de ressource, étendue partagée ; analyse d'étendue sérialisable.</span><span class="sxs-lookup"><span data-stu-id="968d3-704">Shared range, update resource lock; serializable update scan.</span></span>|  
    |<span data-ttu-id="968d3-705">RangeI</span><span class="sxs-lookup"><span data-stu-id="968d3-705">RangeI</span></span>|<span data-ttu-id="968d3-706">Null</span><span class="sxs-lookup"><span data-stu-id="968d3-706">Null</span></span>|<span data-ttu-id="968d3-707">RangeI-N</span><span class="sxs-lookup"><span data-stu-id="968d3-707">RangeI-N</span></span>|<span data-ttu-id="968d3-708">Verrou de ressource NULL, étendue d'insertion ; utilisé pour tester les étendues avant l'insertion d'une nouvelle clé dans un index.</span><span class="sxs-lookup"><span data-stu-id="968d3-708">Insert range, null resource lock; used to test ranges before inserting a new key into an index.</span></span>|  
    |<span data-ttu-id="968d3-709">RangeX</span><span class="sxs-lookup"><span data-stu-id="968d3-709">RangeX</span></span>|<span data-ttu-id="968d3-710">X</span><span class="sxs-lookup"><span data-stu-id="968d3-710">X</span></span>|<span data-ttu-id="968d3-711">RangeX-X</span><span class="sxs-lookup"><span data-stu-id="968d3-711">RangeX-X</span></span>|<span data-ttu-id="968d3-712">Verrou de ressource exclusif, étendue exclusive ; utilisé lors de la mise à jour d'une clé dans une étendue.</span><span class="sxs-lookup"><span data-stu-id="968d3-712">Exclusive range, exclusive resource lock; used when updating a key in a range.</span></span>|  
  
> [!NOTE]  
>  <span data-ttu-id="968d3-713">Le mode interne de verrouillage Null est compatible avec tous les autres modes de verrouillage.</span><span class="sxs-lookup"><span data-stu-id="968d3-713">The internal Null lock mode is compatible with all other lock modes.</span></span>  
  
 <span data-ttu-id="968d3-714">Les modes de verrouillage d'étendues de clés possèdent un tableau de compatibilité qui indique quels verrous sont compatibles avec les autres verrous obtenus sur les clés et étendues se chevauchant.</span><span class="sxs-lookup"><span data-stu-id="968d3-714">Key-range lock modes have a compatibility matrix that shows which locks are compatible with other locks obtained on overlapping keys and ranges.</span></span>  
  
||<span data-ttu-id="968d3-715">Mode accordé existant</span><span class="sxs-lookup"><span data-stu-id="968d3-715">Existing granted mode</span></span>|||||||  
|------|---------------------------|------|------|------|------|------|------|  
|<span data-ttu-id="968d3-716">**Mode requis**</span><span class="sxs-lookup"><span data-stu-id="968d3-716">**Requested mode**</span></span>|<span data-ttu-id="968d3-717">**S**</span><span class="sxs-lookup"><span data-stu-id="968d3-717">**S**</span></span>|<span data-ttu-id="968d3-718">**U**</span><span class="sxs-lookup"><span data-stu-id="968d3-718">**U**</span></span>|<span data-ttu-id="968d3-719">**X**</span><span class="sxs-lookup"><span data-stu-id="968d3-719">**X**</span></span>|<span data-ttu-id="968d3-720">**RangeS-S**</span><span class="sxs-lookup"><span data-stu-id="968d3-720">**RangeS-S**</span></span>|<span data-ttu-id="968d3-721">**RangeS-U**</span><span class="sxs-lookup"><span data-stu-id="968d3-721">**RangeS-U**</span></span>|<span data-ttu-id="968d3-722">**RangeI-N**</span><span class="sxs-lookup"><span data-stu-id="968d3-722">**RangeI-N**</span></span>|<span data-ttu-id="968d3-723">**RangeX-X**</span><span class="sxs-lookup"><span data-stu-id="968d3-723">**RangeX-X**</span></span>|  
|<span data-ttu-id="968d3-724">**Partagé (S)**</span><span class="sxs-lookup"><span data-stu-id="968d3-724">**Shared (S)**</span></span>|<span data-ttu-id="968d3-725">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-725">Yes</span></span>|<span data-ttu-id="968d3-726">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-726">Yes</span></span>|<span data-ttu-id="968d3-727">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-727">No</span></span>|<span data-ttu-id="968d3-728">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-728">Yes</span></span>|<span data-ttu-id="968d3-729">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-729">Yes</span></span>|<span data-ttu-id="968d3-730">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-730">Yes</span></span>|<span data-ttu-id="968d3-731">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-731">No</span></span>|  
|<span data-ttu-id="968d3-732">**Mise à jour (U)**</span><span class="sxs-lookup"><span data-stu-id="968d3-732">**Update (U)**</span></span>|<span data-ttu-id="968d3-733">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-733">Yes</span></span>|<span data-ttu-id="968d3-734">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-734">No</span></span>|<span data-ttu-id="968d3-735">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-735">No</span></span>|<span data-ttu-id="968d3-736">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-736">Yes</span></span>|<span data-ttu-id="968d3-737">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-737">No</span></span>|<span data-ttu-id="968d3-738">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-738">Yes</span></span>|<span data-ttu-id="968d3-739">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-739">No</span></span>|  
|<span data-ttu-id="968d3-740">**Exclusif (X)**</span><span class="sxs-lookup"><span data-stu-id="968d3-740">**Exclusive (X)**</span></span>|<span data-ttu-id="968d3-741">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-741">No</span></span>|<span data-ttu-id="968d3-742">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-742">No</span></span>|<span data-ttu-id="968d3-743">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-743">No</span></span>|<span data-ttu-id="968d3-744">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-744">No</span></span>|<span data-ttu-id="968d3-745">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-745">No</span></span>|<span data-ttu-id="968d3-746">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-746">Yes</span></span>|<span data-ttu-id="968d3-747">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-747">No</span></span>|  
|<span data-ttu-id="968d3-748">**RangeS-S**</span><span class="sxs-lookup"><span data-stu-id="968d3-748">**RangeS-S**</span></span>|<span data-ttu-id="968d3-749">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-749">Yes</span></span>|<span data-ttu-id="968d3-750">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-750">Yes</span></span>|<span data-ttu-id="968d3-751">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-751">No</span></span>|<span data-ttu-id="968d3-752">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-752">Yes</span></span>|<span data-ttu-id="968d3-753">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-753">Yes</span></span>|<span data-ttu-id="968d3-754">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-754">No</span></span>|<span data-ttu-id="968d3-755">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-755">No</span></span>|  
|<span data-ttu-id="968d3-756">**RangeS-U**</span><span class="sxs-lookup"><span data-stu-id="968d3-756">**RangeS-U**</span></span>|<span data-ttu-id="968d3-757">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-757">Yes</span></span>|<span data-ttu-id="968d3-758">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-758">No</span></span>|<span data-ttu-id="968d3-759">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-759">No</span></span>|<span data-ttu-id="968d3-760">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-760">Yes</span></span>|<span data-ttu-id="968d3-761">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-761">No</span></span>|<span data-ttu-id="968d3-762">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-762">No</span></span>|<span data-ttu-id="968d3-763">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-763">No</span></span>|  
|<span data-ttu-id="968d3-764">**RangeI-N**</span><span class="sxs-lookup"><span data-stu-id="968d3-764">**RangeI-N**</span></span>|<span data-ttu-id="968d3-765">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-765">Yes</span></span>|<span data-ttu-id="968d3-766">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-766">Yes</span></span>|<span data-ttu-id="968d3-767">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-767">Yes</span></span>|<span data-ttu-id="968d3-768">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-768">No</span></span>|<span data-ttu-id="968d3-769">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-769">No</span></span>|<span data-ttu-id="968d3-770">Oui</span><span class="sxs-lookup"><span data-stu-id="968d3-770">Yes</span></span>|<span data-ttu-id="968d3-771">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-771">No</span></span>|  
|<span data-ttu-id="968d3-772">**RangeX-X**</span><span class="sxs-lookup"><span data-stu-id="968d3-772">**RangeX-X**</span></span>|<span data-ttu-id="968d3-773">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-773">No</span></span>|<span data-ttu-id="968d3-774">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-774">No</span></span>|<span data-ttu-id="968d3-775">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-775">No</span></span>|<span data-ttu-id="968d3-776">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-776">No</span></span>|<span data-ttu-id="968d3-777">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-777">No</span></span>|<span data-ttu-id="968d3-778">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-778">No</span></span>|<span data-ttu-id="968d3-779">Non</span><span class="sxs-lookup"><span data-stu-id="968d3-779">No</span></span>|  
  
#### <a name="conversion-locks"></a><span data-ttu-id="968d3-780">Verrous de conversion</span><span class="sxs-lookup"><span data-stu-id="968d3-780">Conversion Locks</span></span>  

 <span data-ttu-id="968d3-781">Les verrous de conversion sont créés lorsqu'un verrou d'étendue de clés chevauche un autre verrou.</span><span class="sxs-lookup"><span data-stu-id="968d3-781">Conversion locks are created when a key-range lock overlaps another lock.</span></span>  
  
|<span data-ttu-id="968d3-782">Verrou 1</span><span class="sxs-lookup"><span data-stu-id="968d3-782">Lock 1</span></span>|<span data-ttu-id="968d3-783">Verrou 2</span><span class="sxs-lookup"><span data-stu-id="968d3-783">Lock 2</span></span>|<span data-ttu-id="968d3-784">Verrou de conversion</span><span class="sxs-lookup"><span data-stu-id="968d3-784">Conversion lock</span></span>|  
|------------|------------|---------------------|  
|<span data-ttu-id="968d3-785">S</span><span class="sxs-lookup"><span data-stu-id="968d3-785">S</span></span>|<span data-ttu-id="968d3-786">RangeI-N</span><span class="sxs-lookup"><span data-stu-id="968d3-786">RangeI-N</span></span>|<span data-ttu-id="968d3-787">RangeI-S</span><span class="sxs-lookup"><span data-stu-id="968d3-787">RangeI-S</span></span>|  
|<span data-ttu-id="968d3-788">U</span><span class="sxs-lookup"><span data-stu-id="968d3-788">U</span></span>|<span data-ttu-id="968d3-789">RangeI-N</span><span class="sxs-lookup"><span data-stu-id="968d3-789">RangeI-N</span></span>|<span data-ttu-id="968d3-790">RangeI-U</span><span class="sxs-lookup"><span data-stu-id="968d3-790">RangeI-U</span></span>|  
|<span data-ttu-id="968d3-791">X</span><span class="sxs-lookup"><span data-stu-id="968d3-791">X</span></span>|<span data-ttu-id="968d3-792">RangeI-N</span><span class="sxs-lookup"><span data-stu-id="968d3-792">RangeI-N</span></span>|<span data-ttu-id="968d3-793">RangeI-X</span><span class="sxs-lookup"><span data-stu-id="968d3-793">RangeI-X</span></span>|  
|<span data-ttu-id="968d3-794">RangeI-N</span><span class="sxs-lookup"><span data-stu-id="968d3-794">RangeI-N</span></span>|<span data-ttu-id="968d3-795">RangeS-S</span><span class="sxs-lookup"><span data-stu-id="968d3-795">RangeS-S</span></span>|<span data-ttu-id="968d3-796">RangeX-S</span><span class="sxs-lookup"><span data-stu-id="968d3-796">RangeX-S</span></span>|  
|<span data-ttu-id="968d3-797">RangeI-N</span><span class="sxs-lookup"><span data-stu-id="968d3-797">RangeI-N</span></span>|<span data-ttu-id="968d3-798">RangeS-U</span><span class="sxs-lookup"><span data-stu-id="968d3-798">RangeS-U</span></span>|<span data-ttu-id="968d3-799">RangeX-U</span><span class="sxs-lookup"><span data-stu-id="968d3-799">RangeX-U</span></span>|  
  
 <span data-ttu-id="968d3-800">Les verrous de conversion peuvent être observés pendant une courte période dans différentes circonstances complexes, parfois lors de l'exécution de processus concurrents.</span><span class="sxs-lookup"><span data-stu-id="968d3-800">Conversion locks can be observed for a short period of time under different complex circumstances, sometimes while running concurrent processes.</span></span>  
  
#### <a name="serializable-range-scan-singleton-fetch-delete-and-insert"></a><span data-ttu-id="968d3-801">Analyse d'étendue sérialisable, extraction singleton, suppression et insertion</span><span class="sxs-lookup"><span data-stu-id="968d3-801">Serializable Range Scan, Singleton Fetch, Delete, and Insert</span></span>  

 <span data-ttu-id="968d3-802">Le verrouillage d'étendues de clés permet la sérialisation des opérations suivantes :</span><span class="sxs-lookup"><span data-stu-id="968d3-802">Key-range locking ensures that the following operations are serializable:</span></span>  
  
-   <span data-ttu-id="968d3-803">Requête d'analyse d'étendue</span><span class="sxs-lookup"><span data-stu-id="968d3-803">Range scan query</span></span>  
  
-   <span data-ttu-id="968d3-804">Extraction singleton de ligne inexistante</span><span class="sxs-lookup"><span data-stu-id="968d3-804">Singleton fetch of nonexistent row</span></span>  
  
-   <span data-ttu-id="968d3-805">Opération de suppression</span><span class="sxs-lookup"><span data-stu-id="968d3-805">Delete operation</span></span>  
  
-   <span data-ttu-id="968d3-806">Opération d'insertion</span><span class="sxs-lookup"><span data-stu-id="968d3-806">Insert operation</span></span>  
  
 <span data-ttu-id="968d3-807">Les conditions suivantes doivent être satisfaites pour qu'un verrouillage d'étendues de clés puisse se produire :</span><span class="sxs-lookup"><span data-stu-id="968d3-807">Before key-range locking can occur, the following conditions must be satisfied:</span></span>  
  
-   <span data-ttu-id="968d3-808">Le niveau d'isolement de la transaction doit être défini sur SERIALIZABLE.</span><span class="sxs-lookup"><span data-stu-id="968d3-808">The transaction-isolation level must be set to SERIALIZABLE.</span></span>  
  
-   <span data-ttu-id="968d3-809">Le processeur de requêtes doit utiliser un index pour implémenter le prédicat de filtre de l'étendue.</span><span class="sxs-lookup"><span data-stu-id="968d3-809">The query processor must use an index to implement the range filter predicate.</span></span> <span data-ttu-id="968d3-810">Par exemple, la clause WHERE dans une instruction SELECT peut établir une condition d’étendue avec le prédicat suivant : ColonneX BETWEEN N **’** AAA **’** AND N **’** CZZ **’** .</span><span class="sxs-lookup"><span data-stu-id="968d3-810">For example, the WHERE clause in a SELECT statement could establish a range condition with this predicate: ColumnX BETWEEN N **'** AAA **'** AND N **'** CZZ **'**.</span></span> <span data-ttu-id="968d3-811">Un verrou de groupes de clés ne peut être acquis que si **ColumnX** est couvert par une clé d’index.</span><span class="sxs-lookup"><span data-stu-id="968d3-811">A key-range lock can only be acquired if **ColumnX** is covered by an index key.</span></span>  
  
#### <a name="examples"></a><span data-ttu-id="968d3-812">Exemples</span><span class="sxs-lookup"><span data-stu-id="968d3-812">Examples</span></span>  

 <span data-ttu-id="968d3-813">La table et l'index suivants sont utilisés comme base pour les exemples de verrouillage d'étendues de clés ci-dessous.</span><span class="sxs-lookup"><span data-stu-id="968d3-813">The following table and index are used as a basis for the key-range locking examples that follow.</span></span>  
  
 <span data-ttu-id="968d3-814">![Table de base de données avec illustration de l'arbre B (B-tree) de l'index](media/btree4.gif "Table de base de données avec illustration de l'arbre B (B-tree) de l'index")</span><span class="sxs-lookup"><span data-stu-id="968d3-814">![Database table with index b-tree illustration](media/btree4.gif "Database table with index b-tree illustration")</span></span>  
  
##### <a name="range-scan-query"></a><span data-ttu-id="968d3-815">Requête d'analyse d'étendue</span><span class="sxs-lookup"><span data-stu-id="968d3-815">Range Scan Query</span></span>  

 <span data-ttu-id="968d3-816">Pour qu'une requête d'analyse d'étendue soit sérialisable, cette requête doit retourner les mêmes résultats chaque fois qu'elle est exécutée dans la même transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-816">To ensure a range scan query is serializable, the same query should return the same results each time it is executed within the same transaction.</span></span> <span data-ttu-id="968d3-817">De nouvelles lignes ne doivent pas être insérées dans la requête d'analyse d'étendue par d'autres transactions, sinon celles-ci deviennent des insertions fantômes.</span><span class="sxs-lookup"><span data-stu-id="968d3-817">New rows must not be inserted within the range scan query by other transactions; otherwise, these become phantom inserts.</span></span> <span data-ttu-id="968d3-818">Par exemple, la requête suivante utilise la table et l'index de l'illustration précédente :</span><span class="sxs-lookup"><span data-stu-id="968d3-818">For example, the following query uses the table and index in the previous illustration:</span></span>  
  
```sql  
SELECT name  
    FROM mytable  
    WHERE name BETWEEN 'A' AND 'C';  
```  
  
 <span data-ttu-id="968d3-819">Les verrous d'étendues de clés sont placés sur les entrées d'index correspondant à l'étendue de lignes de données dans laquelle name se trouve entre Adam et Dale, empêchant l'insertion ou la suppression de nouvelles lignes correspondant à la requête précédente.</span><span class="sxs-lookup"><span data-stu-id="968d3-819">Key-range locks are placed on the index entries corresponding to the range of data rows where the name is between the values Adam and Dale, preventing new rows qualifying in the previous query from being added or deleted.</span></span> <span data-ttu-id="968d3-820">Bien que le premier nom de l'étendue soit Adam, le verrou d'étendues de clés du mode RangeS-S sur cette entrée d'index veille à ce qu'aucun nouveau nom commençant par la lettre A ne soit ajouté avant Adam, comme Abigail.</span><span class="sxs-lookup"><span data-stu-id="968d3-820">Although the first name in this range is Adam, the RangeS-S mode key-range lock on this index entry ensures that no new names beginning with the letter A can be added before Adam, such as Abigail.</span></span> <span data-ttu-id="968d3-821">De manière similaire, le verrou d'étendues de clés RangeS-S sur l'entrée d'index pour Dale fait en sorte qu'aucun nom commençant par C ne puisse être ajouté après Carlos, comme Clive.</span><span class="sxs-lookup"><span data-stu-id="968d3-821">Similarly, the RangeS-S key-range lock on the index entry for Dale ensures that no new names beginning with the letter C can be added after Carlos, such as Clive.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="968d3-822">Le nombre de verrous RangeS-S maintenus est *n*+1, où *n* est le nombre de lignes répondant aux critères de la requête.</span><span class="sxs-lookup"><span data-stu-id="968d3-822">The number of RangeS-S locks held is *n*+1, where *n* is the number of rows that satisfy the query.</span></span>  
  
##### <a name="singleton-fetch-of-nonexistent-data"></a><span data-ttu-id="968d3-823">Extraction d'un singleton de données non existantes</span><span class="sxs-lookup"><span data-stu-id="968d3-823">Singleton Fetch of Nonexistent Data</span></span>  

 <span data-ttu-id="968d3-824">Si une requête à l'intérieur d'une transaction tente de sélectionner une ligne qui n'existe pas, l'exécution de la requête plus loin dans la même transaction doit retourner le même résultat.</span><span class="sxs-lookup"><span data-stu-id="968d3-824">If a query within a transaction attempts to select a row that does not exist, issuing the query at a later point within the same transaction has to return the same result.</span></span> <span data-ttu-id="968d3-825">Aucune autre transaction ne peut être autorisée à insérer cette ligne inexistante.</span><span class="sxs-lookup"><span data-stu-id="968d3-825">No other transaction can be allowed to insert that nonexistent row.</span></span> <span data-ttu-id="968d3-826">Supposons par exemple la requête suivante :</span><span class="sxs-lookup"><span data-stu-id="968d3-826">For example, given this query:</span></span>  
  
```sql 
SELECT name  
    FROM mytable  
    WHERE name = 'Bill';  
```  
  
 <span data-ttu-id="968d3-827">Un verrou d'étendues de clés est placé sur l'entrée d'index correspondant à l'étendue de noms se trouvant entre `Ben` et `Bing`, car le nom `Bill` serait inséré entre ces deux entrées d'index adjacentes.</span><span class="sxs-lookup"><span data-stu-id="968d3-827">A key-range lock is placed on the index entry corresponding to the name range from `Ben` to `Bing` because the name `Bill` would be inserted between these two adjacent index entries.</span></span> <span data-ttu-id="968d3-828">Le verrou d'étendues de clés du mode RangeS-S est placé sur l'entrée d'index `Bing`.</span><span class="sxs-lookup"><span data-stu-id="968d3-828">The RangeS-S mode key-range lock is placed on the index entry `Bing`.</span></span> <span data-ttu-id="968d3-829">Ceci empêche toute autre transaction d'insérer des valeurs, telles que `Bill`, entre les entrées d'index `Ben` et `Bing`.</span><span class="sxs-lookup"><span data-stu-id="968d3-829">This prevents any other transaction from inserting values, such as `Bill`, between the index entries `Ben` and `Bing`.</span></span>  
  
##### <a name="delete-operation"></a><span data-ttu-id="968d3-830">Opération de suppression</span><span class="sxs-lookup"><span data-stu-id="968d3-830">Delete Operation</span></span>  

 <span data-ttu-id="968d3-831">Lors de la suppression d'une valeur dans une transaction, l'étendue dans laquelle la valeur se trouve ne doit pas nécessairement être verrouillée pendant toute la durée de la transaction effectuant l'opération de suppression.</span><span class="sxs-lookup"><span data-stu-id="968d3-831">When deleting a value within a transaction, the range the value falls into does not have to be locked for the duration of the transaction performing the delete operation.</span></span> <span data-ttu-id="968d3-832">Le verrouillage de la valeur de clé supprimée jusqu'à la fin de la transaction est suffisant pour assurer la sérialisation.</span><span class="sxs-lookup"><span data-stu-id="968d3-832">Locking the deleted key value until the end of the transaction is sufficient to maintain serializability.</span></span> <span data-ttu-id="968d3-833">Par exemple, pour l'instruction DELETE suivante :</span><span class="sxs-lookup"><span data-stu-id="968d3-833">For example, given this DELETE statement:</span></span>  
  
```sql  
DELETE mytable  
    WHERE name = 'Bob';  
```  
  
 <span data-ttu-id="968d3-834">Un verrou exclusif (X) est placé sur l'entrée d'index correspondant au nom `Bob`.</span><span class="sxs-lookup"><span data-stu-id="968d3-834">An exclusive (X) lock is placed on the index entry corresponding to the name `Bob`.</span></span> <span data-ttu-id="968d3-835">Les autres transactions peuvent insérer ou supprimer des valeurs avant ou après la valeur effacée `Bob`.</span><span class="sxs-lookup"><span data-stu-id="968d3-835">Other transactions can insert or delete values before or after the deleted value `Bob`.</span></span> <span data-ttu-id="968d3-836">Toutefois, toute transaction tentant de lire, insérer ou supprimer la valeur `Bob` sera bloquée jusqu'à ce que la transaction effectuant la suppression soit validée ou restaurée.</span><span class="sxs-lookup"><span data-stu-id="968d3-836">However, any transaction that attempts to read, insert, or delete the value `Bob` will be blocked until the deleting transaction either commits or rolls back.</span></span>  
  
 <span data-ttu-id="968d3-837">La suppression d'étendues peut être exécutée à l'aide de trois modes de verrouillage de base : verrouillage de ligne, de page ou de table.</span><span class="sxs-lookup"><span data-stu-id="968d3-837">Range delete can be executed using three basic lock modes: row, page, or table lock.</span></span> <span data-ttu-id="968d3-838">La stratégie de verrouillage de ligne, de page ou de table est décidée par l'optimiseur de requête, ou peut être spécifiée par l'utilisateur par l'intermédiaire d'options d'optimiseur telles que ROWLOCK, PAGLOCK ou TABLOCK.</span><span class="sxs-lookup"><span data-stu-id="968d3-838">The row, page, or table locking strategy is decided by query optimizer or can be specified by the user through optimizer hints such as ROWLOCK, PAGLOCK, or TABLOCK.</span></span> <span data-ttu-id="968d3-839">Lorsque l'option PAGLOCK ou TABLOCK est utilisée, le [!INCLUDE[ssDE](../includes/ssde-md.md)] désalloue immédiatement une page d'index page si toutes les lignes qu'elle contient sont supprimées.</span><span class="sxs-lookup"><span data-stu-id="968d3-839">When PAGLOCK or TABLOCK is used, the [!INCLUDE[ssDE](../includes/ssde-md.md)] immediately deallocates an index page if all rows are deleted from this page.</span></span> <span data-ttu-id="968d3-840">En revanche, lorsque l'option ROWLOCK est utilisée, toutes les lignes supprimées sont uniquement marquées en tant que telles ; elles sont effectivement retirées de la page d'index ultérieurement, à l'aide d'une tâche d'arrière-plan.</span><span class="sxs-lookup"><span data-stu-id="968d3-840">In contrast, when ROWLOCK is used, all deleted rows are marked only as deleted; they are removed from the index page later using a background task.</span></span>  
  
##### <a name="insert-operation"></a><span data-ttu-id="968d3-841">Opération d'insertion</span><span class="sxs-lookup"><span data-stu-id="968d3-841">Insert Operation</span></span>  

 <span data-ttu-id="968d3-842">Lors de l'insertion d'une valeur à l'intérieur d'une transaction, l'étendue dans laquelle la valeur se trouve ne doit pas nécessairement être verrouillée pendant la durée de l'opération effectuant l'opération d'insertion.</span><span class="sxs-lookup"><span data-stu-id="968d3-842">When inserting a value within a transaction, the range the value falls into does not have to be locked for the duration of the transaction performing the insert operation.</span></span> <span data-ttu-id="968d3-843">Le verrouillage de la valeur de clé jusqu'à la fin de la transaction suffit pour assurer la sérialisation.</span><span class="sxs-lookup"><span data-stu-id="968d3-843">Locking the inserted key value until the end of the transaction is sufficient to maintain serializability.</span></span> <span data-ttu-id="968d3-844">Par exemple, étant donné l'instruction INSERT suivante :</span><span class="sxs-lookup"><span data-stu-id="968d3-844">For example, given this INSERT statement:</span></span>  
  
```sql  
INSERT mytable VALUES ('Dan');  
```  
  
 <span data-ttu-id="968d3-845">Le verrou d'étendues de clés du mode RangeI-N est placé sur l'entrée d'index correspondant au nom David pour le test de l'étendue.</span><span class="sxs-lookup"><span data-stu-id="968d3-845">The RangeI-N mode key-range lock is placed on the index entry corresponding to the name David to test the range.</span></span> <span data-ttu-id="968d3-846">Si le verrou est accordé, la valeur `Dan` est insérée et un verrou exclusif (X) est placé sur la valeur `Dan`.</span><span class="sxs-lookup"><span data-stu-id="968d3-846">If the lock is granted, `Dan` is inserted and an exclusive (X) lock is placed on the value `Dan`.</span></span> <span data-ttu-id="968d3-847">Le verrou d'étendues de clés du mode RangeI-N est uniquement nécessaire pour le test de l'étendue et n'est pas maintenu pendant la durée de la transaction effectuant l'opération d'insertion.</span><span class="sxs-lookup"><span data-stu-id="968d3-847">The RangeI-N mode key-range lock is necessary only to test the range and is not held for the duration of the transaction performing the insert operation.</span></span> <span data-ttu-id="968d3-848">D'autres transactions peuvent insérer ou supprimer des valeurs avant ou après la valeur `Dan` insérée.</span><span class="sxs-lookup"><span data-stu-id="968d3-848">Other transactions can insert or delete values before or after the inserted value `Dan`.</span></span> <span data-ttu-id="968d3-849">Toutefois, toute transaction essayant de lire, écrire ou supprimer la valeur `Dan` est verrouillée jusqu'à ce que la transaction d'insertion soit validée ou restaurée.</span><span class="sxs-lookup"><span data-stu-id="968d3-849">However, any transaction attempting to read, insert, or delete the value `Dan` will be locked until the inserting transaction either commits or rolls back.</span></span>  
  
### <a name="dynamic-locking"></a><span data-ttu-id="968d3-850">Verrouillage dynamique</span><span class="sxs-lookup"><span data-stu-id="968d3-850">Dynamic Locking</span></span>  

 <span data-ttu-id="968d3-851">L'utilisation de verrous de bas niveau, comme les verrous de ligne, augmente la concurrence car elle diminue la probabilité d'avoir deux transactions qui demandent des verrous sur les mêmes données en même temps.</span><span class="sxs-lookup"><span data-stu-id="968d3-851">Using low-level locks, such as row locks, increases concurrency by decreasing the probability that two transactions will request locks on the same piece of data at the same time.</span></span> <span data-ttu-id="968d3-852">L'utilisation de verrous de bas niveau augmente également le nombre de verrous et les ressources nécessaires à leur gestion.</span><span class="sxs-lookup"><span data-stu-id="968d3-852">Using low-level locks also increases the number of locks and the resources needed to manage them.</span></span> <span data-ttu-id="968d3-853">Les verrous de table ou de page de haut niveau réduisent la charge mais au détriment de la concurrence.</span><span class="sxs-lookup"><span data-stu-id="968d3-853">Using high-level table or page locks lowers overhead, but at the expense of lowering concurrency.</span></span>  
  
 <span data-ttu-id="968d3-854">![Diagramme affichant le coût par rapport à la granularité](media/lockcht.gif "Diagramme affichant le coût par rapport à la granularité")</span><span class="sxs-lookup"><span data-stu-id="968d3-854">![Diagram showing cost versus granularity](media/lockcht.gif "Diagram showing cost versus granularity")</span></span>  
  
 <span data-ttu-id="968d3-855">Le [!INCLUDE[msCoName](../includes/msconame-md.md)] [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] utilise une stratégie de verrouillage dynamique pour déterminer les verrous les plus rentables.</span><span class="sxs-lookup"><span data-stu-id="968d3-855">The [!INCLUDE[msCoName](../includes/msconame-md.md)] [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] uses a dynamic locking strategy to determine the most cost-effective locks.</span></span> <span data-ttu-id="968d3-856">Lorsqu'une requête est exécutée, le [!INCLUDE[ssDE](../includes/ssde-md.md)] détermine automatiquement les verrous les plus appropriés sur la base des caractéristiques du schéma et de la requête.</span><span class="sxs-lookup"><span data-stu-id="968d3-856">The [!INCLUDE[ssDE](../includes/ssde-md.md)] automatically determines what locks are most appropriate when the query is executed, based on the characteristics of the schema and query.</span></span> <span data-ttu-id="968d3-857">Par exemple, pour réduire l'utilisation des verrous, l'optimiseur peut choisir d'utiliser des verrous de niveau page dans un index lors de l'analyse de l'index.</span><span class="sxs-lookup"><span data-stu-id="968d3-857">For example, to reduce the overhead of locking, the optimizer may choose page-level locks in an index when performing an index scan.</span></span>  
  
 <span data-ttu-id="968d3-858">Le verrouillage dynamique offre les avantages suivants :</span><span class="sxs-lookup"><span data-stu-id="968d3-858">Dynamic locking has the following advantages:</span></span>  
  
-   <span data-ttu-id="968d3-859">Administration de bases de données simplifiée.</span><span class="sxs-lookup"><span data-stu-id="968d3-859">Simplified database administration.</span></span> <span data-ttu-id="968d3-860">Les administrateurs de la base de données ne doivent pas ajuster les seuils d'escalade des verrous.</span><span class="sxs-lookup"><span data-stu-id="968d3-860">Database administrators do not have to adjust lock escalation thresholds.</span></span>  
  
-   <span data-ttu-id="968d3-861">Performances améliorées.</span><span class="sxs-lookup"><span data-stu-id="968d3-861">Increased performance.</span></span> <span data-ttu-id="968d3-862">Le [!INCLUDE[ssDE](../includes/ssde-md.md)] réduit la charge sur le système en utilisant les verrous appropriés pour la tâche.</span><span class="sxs-lookup"><span data-stu-id="968d3-862">The [!INCLUDE[ssDE](../includes/ssde-md.md)] minimizes system overhead by using locks appropriate to the task.</span></span>  
  
-   <span data-ttu-id="968d3-863">Les développeurs d'applications peuvent se concentrer sur le développement.</span><span class="sxs-lookup"><span data-stu-id="968d3-863">Application developers can concentrate on development.</span></span> <span data-ttu-id="968d3-864">Le [!INCLUDE[ssDE](../includes/ssde-md.md)] adapte le verrouillage automatiquement.</span><span class="sxs-lookup"><span data-stu-id="968d3-864">The [!INCLUDE[ssDE](../includes/ssde-md.md)] adjusts locking automatically.</span></span>  
  
 <span data-ttu-id="968d3-865">Dans [!INCLUDE[ssKatmai](../includes/sskatmai-md.md)] et les versions ultérieures, le comportement de l’escalade de verrous a changé avec l’introduction de l’option LOCK_ESCALATION.</span><span class="sxs-lookup"><span data-stu-id="968d3-865">In [!INCLUDE[ssKatmai](../includes/sskatmai-md.md)] and later versions, the behavior of lock escalation has changed with the introduction of the LOCK_ESCALATION option.</span></span> <span data-ttu-id="968d3-866">Pour plus d’informations, consultez l’option LOCK_ESCALATION de l' [instruction ALTER TABLE](/sql/t-sql/statements/alter-table-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="968d3-866">For more information, see the LOCK_ESCALATION option of [ALTER TABLE](/sql/t-sql/statements/alter-table-transact-sql).</span></span>  
  
### <a name="deadlocking"></a><span data-ttu-id="968d3-867">Interblocage</span><span class="sxs-lookup"><span data-stu-id="968d3-867">Deadlocking</span></span>  

 <span data-ttu-id="968d3-868">Un interblocage se produit lorsque deux tâches ou plus se bloquent mutuellement de façon permanente. Dans ce cas, chaque tâche place un verrou sur une ressource que la ou les autres tâches essaient de verrouiller.</span><span class="sxs-lookup"><span data-stu-id="968d3-868">A deadlock occurs when two or more tasks permanently block each other by each task having a lock on a resource which the other tasks are trying to lock.</span></span> <span data-ttu-id="968d3-869">Par exemple :</span><span class="sxs-lookup"><span data-stu-id="968d3-869">For example:</span></span>  
  
-   <span data-ttu-id="968d3-870">La transaction A obtient un verrou partagé sur la ligne 1.</span><span class="sxs-lookup"><span data-stu-id="968d3-870">Transaction A acquires a share lock on row 1.</span></span>  
  
-   <span data-ttu-id="968d3-871">La transaction B obtient un verrou partagé sur la ligne 2.</span><span class="sxs-lookup"><span data-stu-id="968d3-871">Transaction B acquires a share lock on row 2.</span></span>  
  
-   <span data-ttu-id="968d3-872">La transaction A demande un verrou exclusif sur la ligne 2, mais elle est bloquée jusqu'à la fin de la transaction B qui libérera le verrou partagé sur la ligne 2.</span><span class="sxs-lookup"><span data-stu-id="968d3-872">Transaction A now requests an exclusive lock on row 2, and is blocked until transaction B finishes and releases the share lock it has on row 2.</span></span>  
  
-   <span data-ttu-id="968d3-873">La transaction B demande un verrou exclusif sur la ligne 1, mais elle est bloquée jusqu'à la fin de la transaction A qui libérera le verrou partagé sur la ligne 1.</span><span class="sxs-lookup"><span data-stu-id="968d3-873">Transaction B now requests an exclusive lock on row 1, and is blocked until transaction A finishes and releases the share lock it has on row 1.</span></span>  
  
 <span data-ttu-id="968d3-874">La transaction A ne peut pas se terminer tant que la transaction B n'est pas terminée, mais la transaction B est bloquée par la transaction A. Il s’agit d’une dépendance cyclique : La transaction A est dépendante de la transaction B, mais celle-ci ne peut pas s’exécuter, car elle est dépendante de la transaction A.</span><span class="sxs-lookup"><span data-stu-id="968d3-874">Transaction A cannot complete until transaction B completes, but transaction B is blocked by transaction A. This condition is also called a cyclic dependency: Transaction A has a dependency on transaction B, and transaction B closes the circle by having a dependency on transaction A.</span></span>  
  
 <span data-ttu-id="968d3-875">Les deux transactions en interblocage attendent indéfiniment que la situation soit débloquée par un processus externe.</span><span class="sxs-lookup"><span data-stu-id="968d3-875">Both transactions in a deadlock will wait forever unless the deadlock is broken by an external process.</span></span> <span data-ttu-id="968d3-876">Le moniteur d’interblocage du [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] recherche périodiquement les tâches d’interblocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-876">The [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] deadlock monitor periodically checks for tasks that are in a deadlock.</span></span> <span data-ttu-id="968d3-877">S'il détecte une situation de dépendance cyclique, il désigne une des tâches comme victime et met fin à sa transaction avec un message d'erreur.</span><span class="sxs-lookup"><span data-stu-id="968d3-877">If the monitor detects a cyclic dependency, it chooses one of the tasks as a victim and terminates its transaction with an error.</span></span> <span data-ttu-id="968d3-878">Cela permet à l'autre tâche de terminer sa transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-878">This allows the other task to complete its transaction.</span></span> <span data-ttu-id="968d3-879">L'application qui exécutait la transaction abandonnée peut effectuer une nouvelle tentative qui réussit en général une fois que l'autre transaction est terminée.</span><span class="sxs-lookup"><span data-stu-id="968d3-879">The application with the transaction that terminated with an error can retry the transaction, which usually completes after the other deadlocked transaction has finished.</span></span>  
  
 <span data-ttu-id="968d3-880">L'interblocage est souvent confondu avec le blocage ordinaire.</span><span class="sxs-lookup"><span data-stu-id="968d3-880">Deadlocking is often confused with normal blocking.</span></span> <span data-ttu-id="968d3-881">Lorsqu'une transaction demande un verrou sur une ressource verrouillée par une autre transaction, elle attend que le verrou soit libéré.</span><span class="sxs-lookup"><span data-stu-id="968d3-881">When a transaction requests a lock on a resource locked by another transaction, the requesting transaction waits until the lock is released.</span></span> <span data-ttu-id="968d3-882">Par défaut, les transactions [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] n'ont pas de délai d'expiration, à moins que LOCK_TIMEOUT ne soit activé.</span><span class="sxs-lookup"><span data-stu-id="968d3-882">By default, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] transactions do not time out, unless LOCK_TIMEOUT is set.</span></span> <span data-ttu-id="968d3-883">La transaction qui demande le verrou est bloquée, mais pas indéfiniment puisqu'elle n'a rien fait pour bloquer la transaction détenant le verrou.</span><span class="sxs-lookup"><span data-stu-id="968d3-883">The requesting transaction is blocked, not deadlocked, because the requesting transaction has not done anything to block the transaction owning the lock.</span></span> <span data-ttu-id="968d3-884">La transaction qui détient le verrou va finir par se terminer et libérer le verrou ; l'autre transaction pourra alors obtenir son verrou et s'exécuter normalement.</span><span class="sxs-lookup"><span data-stu-id="968d3-884">Eventually, the owning transaction will complete and release the lock, and then the requesting transaction will be granted the lock and proceed.</span></span>  
  
 <span data-ttu-id="968d3-885">Les interblocages sont parfois appelés « étreintes fatales ».</span><span class="sxs-lookup"><span data-stu-id="968d3-885">Deadlocks are sometimes called a deadly embrace.</span></span>  
  
 <span data-ttu-id="968d3-886">Une situation d'interblocage peut se produire sur tout système multithread, pas uniquement sur les systèmes de gestion de bases de données relationnelles. Elle peut également concerner des ressources autres que les verrous sur les objets de base de données.</span><span class="sxs-lookup"><span data-stu-id="968d3-886">Deadlock is a condition that can occur on any system with multiple threads, not just on a relational database management system, and can occur for resources other than locks on database objects.</span></span> <span data-ttu-id="968d3-887">Par exemple, un thread dans un système multithread peut acquérir une ou plusieurs ressources (par exemple, des blocs de mémoire).</span><span class="sxs-lookup"><span data-stu-id="968d3-887">For example, a thread in a multithreaded operating system might acquire one or more resources, such as blocks of memory.</span></span> <span data-ttu-id="968d3-888">Si la ressource acquise appartient actuellement à une autre thread, la première thread devra éventuellement attendre que le thread propriétaire libère la ressource cible.</span><span class="sxs-lookup"><span data-stu-id="968d3-888">If the resource being acquired is currently owned by another thread, the first thread may have to wait for the owning thread to release the target resource.</span></span> <span data-ttu-id="968d3-889">le thread en attente a une dépendance sur le thread propriétaire de cette ressource particulière.</span><span class="sxs-lookup"><span data-stu-id="968d3-889">The waiting thread is said to have a dependency on the owning thread for that particular resource.</span></span> <span data-ttu-id="968d3-890">Dans une instance du [!INCLUDE[ssDE](../includes/ssde-md.md)], les sessions peuvent se bloquer lors de l’acquisition de ressources autres que des objets de base de données, notamment des blocs de mémoire ou des threads.</span><span class="sxs-lookup"><span data-stu-id="968d3-890">In an instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)], sessions can deadlock when acquiring nondatabase resources, such as memory or threads.</span></span>  
  
 <span data-ttu-id="968d3-891">![Diagramme montrant le blocage de la transaction](media/dedlck1.gif "Diagramme montrant le blocage de la transaction")</span><span class="sxs-lookup"><span data-stu-id="968d3-891">![Diagram showing transaction deadlock](media/dedlck1.gif "Diagram showing transaction deadlock")</span></span>  
  
 <span data-ttu-id="968d3-892">Dans l’illustration, la transaction T1 est dépendante de la transaction T2 pour la ressource de verrou de table **Part**.</span><span class="sxs-lookup"><span data-stu-id="968d3-892">In the illustration, transaction T1 has a dependency on transaction T2 for the **Part** table lock resource.</span></span> <span data-ttu-id="968d3-893">De même, la transaction T2 est dépendante de T1 pour la ressource de verrou de table **Supplier**.</span><span class="sxs-lookup"><span data-stu-id="968d3-893">Similarly, transaction T2 has a dependency on transaction T1 for the **Supplier** table lock resource.</span></span> <span data-ttu-id="968d3-894">Comme ces dépendances forment un cycle, il y a interblocage entre les transactions T1 et T2.</span><span class="sxs-lookup"><span data-stu-id="968d3-894">Because these dependencies form a cycle, there is a deadlock between transactions T1 and T2.</span></span>  
  
 <span data-ttu-id="968d3-895">Des interblocages peuvent également se produire lorsqu'une table est partitionnée et que le paramètre LOCK_ESCALATION de TABLE ALTER a la valeur AUTO.</span><span class="sxs-lookup"><span data-stu-id="968d3-895">Deadlocks can also occur when a table is partitioned and the LOCK_ESCALATION setting of ALTER TABLE is set to AUTO.</span></span> <span data-ttu-id="968d3-896">Lorsque LOCK_ESCALATION a la valeur AUTO, la concurrence augmente en permettant au [!INCLUDE[ssDE](../includes/ssde-md.md)] de verrouiller des partitions de table au niveau de HOBt au lieu du niveau table.</span><span class="sxs-lookup"><span data-stu-id="968d3-896">When LOCK_ESCALATION is set to AUTO, concurrency increases by allowing the [!INCLUDE[ssDE](../includes/ssde-md.md)] to lock table partitions at the HoBT level instead of at the TABLE level.</span></span> <span data-ttu-id="968d3-897">Toutefois, lorsque des transactions distinctes maintiennent des verrous de partition dans une table et souhaitent un verrou sur l'autre partition de transactions, cela provoque un interblocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-897">However, when separate transactions hold partition locks in a table and want a lock somewhere on the other transactions partition, this causes a deadlock.</span></span> <span data-ttu-id="968d3-898">Ce type d'interblocage peut être évité en affectant à LOCK_ESCALATION la valeur TABLE, bien que ce paramètre réduise la concurrence en forçant les mises à jour volumineuses d'une partition à attendre un verrou de table.</span><span class="sxs-lookup"><span data-stu-id="968d3-898">This type of deadlock can be avoided by setting LOCK_ESCALATION to TABLE; although this setting will reduce concurrency by forcing large updates to a partition to wait for a table lock.</span></span>  
  
#### <a name="detecting-and-ending-deadlocks"></a><span data-ttu-id="968d3-899">Détection et fin des blocages</span><span class="sxs-lookup"><span data-stu-id="968d3-899">Detecting and Ending Deadlocks</span></span>  

 <span data-ttu-id="968d3-900">Un interblocage se produit lorsque deux tâches ou plus se bloquent mutuellement de façon permanente. Dans ce cas, chaque tâche place un verrou sur une ressource que la ou les autres tâches essaient de verrouiller.</span><span class="sxs-lookup"><span data-stu-id="968d3-900">A deadlock occurs when two or more tasks permanently block each other by each task having a lock on a resource which the other tasks are trying to lock.</span></span> <span data-ttu-id="968d3-901">Le graphique suivant présente un aperçu d'un état de blocage où :</span><span class="sxs-lookup"><span data-stu-id="968d3-901">The following graph presents a high level view of a deadlock state where:</span></span>  
  
-   <span data-ttu-id="968d3-902">La tâche T1 a placé un verrou sur la ressource R1 (indiquée par la flèche reliant R1 à T1) et a demandé un verrou sur la ressource R2 (indiquée par la flèche reliant T1 à R2).</span><span class="sxs-lookup"><span data-stu-id="968d3-902">Task T1 has a lock on resource R1 (indicated by the arrow from R1 to T1) and has requested a lock on resource R2 (indicated by the arrow from T1 to R2).</span></span>  
  
-   <span data-ttu-id="968d3-903">La tâche T2 a placé un verrou sur la ressource R2 (indiquée par la flèche reliant R2 à T2) et a demandé un verrou sur la ressource R1 (indiquée par la flèche reliant T2 à R1).</span><span class="sxs-lookup"><span data-stu-id="968d3-903">Task T2 has a lock on resource R2 (indicated by the arrow from R2 to T2) and has requested a lock on resource R1 (indicated by the arrow from T2 to R1).</span></span>  
  
-   <span data-ttu-id="968d3-904">Dans la mesure où aucune des deux tâches ne peut continuer tant qu'il n'y a pas de ressource disponible et que ni l'une ni l'autre des ressources ne peut être libérée avant la poursuite d'une tâche, un état de blocage se produit.</span><span class="sxs-lookup"><span data-stu-id="968d3-904">Because neither task can continue until a resource is available and neither resource can be released until a task continues, a deadlock state exists.</span></span>  
  
 <span data-ttu-id="968d3-905">![Diagramme montrant des tâches dans un état de blocage](media/task-deadlock-state.gif "Diagramme montrant des tâches dans un état de blocage")</span><span class="sxs-lookup"><span data-stu-id="968d3-905">![Diagram showing tasks in a deadlock state](media/task-deadlock-state.gif "Diagram showing tasks in a deadlock state")</span></span>  
  
 <span data-ttu-id="968d3-906">Le [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] détecte automatiquement les cycles de blocage dans [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="968d3-906">The [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] automatically detects deadlock cycles within [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="968d3-907">Le [!INCLUDE[ssDE](../includes/ssde-md.md)] choisit l'une des sessions comme victime et la transaction en cours se termine par une erreur, ce qui met fin à la situation de blocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-907">The [!INCLUDE[ssDE](../includes/ssde-md.md)] chooses one of the sessions as a deadlock victim and the current transaction is terminated with an error to break the deadlock.</span></span>  
  
##### <a name="resources-that-can-deadlock"></a><span data-ttu-id="968d3-908">Ressources susceptibles de se bloquer</span><span class="sxs-lookup"><span data-stu-id="968d3-908">Resources That Can Deadlock</span></span>  

 <span data-ttu-id="968d3-909">Chaque session utilisateur peut avoir une ou plusieurs tâches en cours d'exécution, chacune de ces tâches pouvant obtenir ou être en attente d'obtention de diverses ressources.</span><span class="sxs-lookup"><span data-stu-id="968d3-909">Each user session might have one or more tasks running on its behalf where each task might acquire or wait to acquire a variety of resources.</span></span> <span data-ttu-id="968d3-910">Les types de ressources susceptibles de provoquer un blocage sont les suivants :</span><span class="sxs-lookup"><span data-stu-id="968d3-910">The following types of resources can cause blocking that could result in a deadlock.</span></span>  
  
-   <span data-ttu-id="968d3-911">**Verrous**.</span><span class="sxs-lookup"><span data-stu-id="968d3-911">**Locks**.</span></span> <span data-ttu-id="968d3-912">L'attente d'obtention de verrous sur des ressources, telles qu'objets, pages, lignes, métadonnées et applications peut provoquer un blocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-912">Waiting to acquire locks on resources, such as objects, pages, rows, metadata, and applications can cause deadlock.</span></span> <span data-ttu-id="968d3-913">Par exemple, la transaction T1 a un verrou partagé (S) sur la ligne r1 et elle attend d'obtenir un verrou exclusif (X) sur r2.</span><span class="sxs-lookup"><span data-stu-id="968d3-913">For example, transaction T1 has a shared (S) lock on row r1 and is waiting to get an exclusive (X) lock on r2.</span></span> <span data-ttu-id="968d3-914">La transaction T2 a un verrou partagé (S) sur r2 et elle attend d'obtenir un verrou exclusif (X) sur la ligne r1.</span><span class="sxs-lookup"><span data-stu-id="968d3-914">Transaction T2 has a shared (S) lock on r2 and is waiting to get an exclusive (X) lock on row r1.</span></span> <span data-ttu-id="968d3-915">Il en résulte un cycle de verrouillage où T1 et T2 attendent l'une de l'autre la libération des ressources que chacune a verrouillées.</span><span class="sxs-lookup"><span data-stu-id="968d3-915">This results in a lock cycle in which T1 and T2 wait for each other to release the locked resources.</span></span>  
  
-   <span data-ttu-id="968d3-916">**Threads de travail**.</span><span class="sxs-lookup"><span data-stu-id="968d3-916">**Worker threads**.</span></span> <span data-ttu-id="968d3-917">Une tâche en attente d'un thread de travail disponible peut provoquer un blocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-917">A queued task waiting for an available worker thread can cause deadlock.</span></span> <span data-ttu-id="968d3-918">Si la tâche en file d'attente est propriétaire des ressources qui bloquent tous les threads de travail, un blocage en résulte.</span><span class="sxs-lookup"><span data-stu-id="968d3-918">If the queued task owns resources that are blocking all worker threads, a deadlock will result.</span></span> <span data-ttu-id="968d3-919">Par exemple, la session S1 démarre une transaction et obtient un verrou partagé (S) sur la ligne r1 pour ensuite se mettre en veille.</span><span class="sxs-lookup"><span data-stu-id="968d3-919">For example, session S1 starts a transaction and acquires a shared (S) lock on row r1 and then goes to sleep.</span></span> <span data-ttu-id="968d3-920">Les sessions actives en cours d'exécution sur tous les threads de travail disponibles essaient d'obtenir des verrous exclusifs (X) sur la ligne r1.</span><span class="sxs-lookup"><span data-stu-id="968d3-920">Active sessions running on all available worker threads are trying to acquire exclusive (X) locks on row r1.</span></span> <span data-ttu-id="968d3-921">Étant donné que la session S1 ne peut pas obtenir de thread de travail, elle ne peut pas valider la transaction et libère le verrou au niveau sur la ligne r1.</span><span class="sxs-lookup"><span data-stu-id="968d3-921">Because session S1 cannot acquire a worker thread, it cannot commit the transaction and release the lock on row r1.</span></span> <span data-ttu-id="968d3-922">Cela produit un blocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-922">This results in a deadlock.</span></span>  
  
-   <span data-ttu-id="968d3-923">**Mémoire**.</span><span class="sxs-lookup"><span data-stu-id="968d3-923">**Memory**.</span></span> <span data-ttu-id="968d3-924">Lorsque des demandes concurrentes sont en attente d'allocation de mémoire qui ne peut être satisfaite faute de mémoire suffisante, un blocage peut se produire.</span><span class="sxs-lookup"><span data-stu-id="968d3-924">When concurrent requests are waiting for memory grants that cannot be satisfied with the available memory, a deadlock can occur.</span></span> <span data-ttu-id="968d3-925">Par exemple, deux demandes concurrentes, Q1 et Q2, qui s'exécutant en tant que fonctions définies par l'utilisateur, obtiennent respectivement 10 Mo et 20 Mo de mémoire.</span><span class="sxs-lookup"><span data-stu-id="968d3-925">For example, two concurrent queries, Q1 and Q2, execute as user-defined functions that acquire 10MB and 20MB of memory respectively.</span></span> <span data-ttu-id="968d3-926">Si chaque requête nécessite 30 Mo et que la quantité de mémoire disponible est de 20 Mo, Q1 et Q2 doivent attendre que chacune libère la mémoire, ce qui entraîne un blocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-926">If each query needs 30MB and the total available memory is 20MB, then Q1 and Q2 must wait for each other to release memory, and this results in a deadlock.</span></span>  
  
-   <span data-ttu-id="968d3-927">**Ressources liées à l’exécution de requêtes parallèles**. Les threads de coordination, production ou consommation associées à un port d’échange peuvent se bloquer mutuellement et provoquer un interblocage qui se produit généralement lors de l’introduction d’au moins un autre processus étranger à la requête parallèle.</span><span class="sxs-lookup"><span data-stu-id="968d3-927">**Parallel query execution-related resources** Coordinator, producer, or consumer threads associated with an exchange port may block each other causing a deadlock usually when including at least one other process that is not a part of the parallel query.</span></span> <span data-ttu-id="968d3-928">De même, quand commence l'exécution d'une requête parallèle, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] détermine le degré de parallélisme, ou le nombre de threads de travail, en fonction de la charge de travail en cours.</span><span class="sxs-lookup"><span data-stu-id="968d3-928">Also, when a parallel query starts execution, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] determines the degree of parallelism, or the number of worker threads, based upon the current workload.</span></span> <span data-ttu-id="968d3-929">Si la charge de travail change de façon inattendue, par exemple si de nouvelles requêtes commencent à s'exécuter sur le serveur ou que le système se trouve à court de threads de travail, il peut s'ensuivre un blocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-929">If the system workload unexpectedly changes, for example, where new queries start running on the server or the system runs out of worker threads, then a deadlock could occur.</span></span>  
  
-   <span data-ttu-id="968d3-930">**Ressources MARS (Multiple Active Result Sets)** .</span><span class="sxs-lookup"><span data-stu-id="968d3-930">**Multiple Active Result Sets (MARS) resources**.</span></span> <span data-ttu-id="968d3-931">Ces ressources servent à contrôler l'entrelacement de plusieurs demandes actives sous MARS.</span><span class="sxs-lookup"><span data-stu-id="968d3-931">These resources are used to control interleaving of multiple active requests under MARS.</span></span> <span data-ttu-id="968d3-932">Pour plus d’informations, consultez [mars (Multiple Active Result Sets) dans SQL Server](https://msdn.microsoft.com/library/ms345109(v=SQL.90).aspx).</span><span class="sxs-lookup"><span data-stu-id="968d3-932">For more information, see [Multiple Active Result Sets (MARS) in SQL Server](https://msdn.microsoft.com/library/ms345109(v=SQL.90).aspx).</span></span>  
  
    -   <span data-ttu-id="968d3-933">**Ressource utilisateur**.</span><span class="sxs-lookup"><span data-stu-id="968d3-933">**User resource**.</span></span> <span data-ttu-id="968d3-934">Lorsqu'un thread est en attente d'une ressource potentiellement contrôlée par une application d'utilisateur, la ressource est considérée comme étant une ressource externe ou utilisateur et est traitée comme un verrou.</span><span class="sxs-lookup"><span data-stu-id="968d3-934">When a thread is waiting for a resource that is potentially controlled by a user application, the resource is considered to be an external or user resource and is treated like a lock.</span></span>  
  
    -   <span data-ttu-id="968d3-935">**Exclusion mutuelle de session**.</span><span class="sxs-lookup"><span data-stu-id="968d3-935">**Session mutex**.</span></span> <span data-ttu-id="968d3-936">Les tâches exécutées au cours d'une session sont entrelacées, ce qui signifie que seule une tâche peut s'exécuter à un moment donné dans le cadre de la session.</span><span class="sxs-lookup"><span data-stu-id="968d3-936">The tasks running in one session are interleaved, meaning that only one task can run under the session at a given time.</span></span> <span data-ttu-id="968d3-937">Avant de pouvoir s'exécuter, la tâche doit disposer d'un accès exclusif à l'exclusion mutuelle de la session.</span><span class="sxs-lookup"><span data-stu-id="968d3-937">Before the task can run, it must have exclusive access to the session mutex.</span></span>  
  
    -   <span data-ttu-id="968d3-938">**Exclusion mutuelle de transaction**.</span><span class="sxs-lookup"><span data-stu-id="968d3-938">**Transaction mutex**.</span></span> <span data-ttu-id="968d3-939">Toutes les tâches qui s'exécutent lors d'une transaction sont entrelacées, ce qui signifie que seule une tâche peut s'exécuter à un moment donné dans le cadre de la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-939">All tasks running in one transaction are interleaved, meaning that only one task can run under the transaction at a given time.</span></span> <span data-ttu-id="968d3-940">Avant de pouvoir s'exécuter, la tâche doit disposer d'un accès exclusif à l'exclusion mutuelle de la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-940">Before the task can run, it must have exclusive access to the transaction mutex.</span></span>  
  
     <span data-ttu-id="968d3-941">Pour pouvoir s'exécuter sous MARS, une tâche doit obtenir l'exclusion mutuelle de session.</span><span class="sxs-lookup"><span data-stu-id="968d3-941">In order for a task to run under MARS, it must acquire the session mutex.</span></span> <span data-ttu-id="968d3-942">Si la tâche s'exécute dans le cadre d'une transaction, elle doit obtenir l'exclusion mutuelle de transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-942">If the task is running under a transaction, it must then acquire the transaction mutex.</span></span> <span data-ttu-id="968d3-943">Vous serez ainsi assuré qu'il n'y a qu'une seule tâche active à la fois pour une session et une transaction données.</span><span class="sxs-lookup"><span data-stu-id="968d3-943">This guarantees that only one task is active at one time in a given session and a given transaction.</span></span> <span data-ttu-id="968d3-944">Dès lors que les exclusions mutuelles requises ont été acquises, la tâche peut s'exécuter.</span><span class="sxs-lookup"><span data-stu-id="968d3-944">Once the required mutexes have been acquired, the task can execute.</span></span> <span data-ttu-id="968d3-945">Quand la tâche est terminée ou qu'elle aboutit au milieu de la demande, elle libère l'exclusion mutuelle de transaction avant l'exclusion mutuelle de session, c'est-à-dire dans l'ordre inverse de leur acquisition.</span><span class="sxs-lookup"><span data-stu-id="968d3-945">When the task finishes, or yields in the middle of the request, it will first release transaction mutex followed by the session mutex in reverse order of acquisition.</span></span> <span data-ttu-id="968d3-946">Cependant, des blocages peuvent se produire avec ces ressources.</span><span class="sxs-lookup"><span data-stu-id="968d3-946">However, deadlocks can occur with these resources.</span></span> <span data-ttu-id="968d3-947">Dans l'exemple de code suivant, deux tâches, la demande d'utilisateur U1 et la demande d'utilisateur U2, s'exécutent lors d'une même session.</span><span class="sxs-lookup"><span data-stu-id="968d3-947">In the following code example, two tasks, user request U1 and user request U2, are running in the same session.</span></span>  
  
    ```  
    U1:    Rs1=Command1.Execute("insert sometable EXEC usp_someproc");  
    U2:    Rs2=Command2.Execute("select colA from sometable");  
    ```  
  
     <span data-ttu-id="968d3-948">La procédure stockée qui s'exécute à partir de la demande d'utilisateur U1 a obtenu l'exclusion mutuelle de session.</span><span class="sxs-lookup"><span data-stu-id="968d3-948">The stored procedure executing from user request U1 has acquired the session mutex.</span></span> <span data-ttu-id="968d3-949">Si son exécution se prolonge, le [!INCLUDE[ssDE](../includes/ssde-md.md)] considère que la procédure stockée attend une entrée de données de la part de l'utilisateur.</span><span class="sxs-lookup"><span data-stu-id="968d3-949">If the stored procedure takes a long time to execute, it is assumed by the [!INCLUDE[ssDE](../includes/ssde-md.md)] that the stored procedure is waiting for input from the user.</span></span> <span data-ttu-id="968d3-950">La demande d'utilisateur U2 attend l'exclusion mutuelle de session alors que l'utilisateur attend le jeu de résultats d'U2, et U1 attend une ressource utilisateur.</span><span class="sxs-lookup"><span data-stu-id="968d3-950">User request U2 is waiting for the session mutex while the user is waiting for the result set from U2, and U1 is waiting for a user resource.</span></span> <span data-ttu-id="968d3-951">Il s'agit d'un état de blocage logiquement illustré ainsi :</span><span class="sxs-lookup"><span data-stu-id="968d3-951">This is deadlock state logically illustrated as:</span></span>  
  
 <span data-ttu-id="968d3-952">![Diagramme logique montrant le blocage de processus utilisateur.](media/udb9-logicflowexamplec.gif "Diagramme logique montrant le blocage de processus utilisateur.")</span><span class="sxs-lookup"><span data-stu-id="968d3-952">![Logic diagram showing user process deadlock.](media/udb9-logicflowexamplec.gif "Logic diagram showing user process deadlock.")</span></span>  
  
##### <a name="deadlock-detection"></a><span data-ttu-id="968d3-953">Détection de blocage</span><span class="sxs-lookup"><span data-stu-id="968d3-953">Deadlock Detection</span></span>  

 <span data-ttu-id="968d3-954">Toutes les ressources énumérées dans la section précédente sont visées par le dispositif de détection de blocage du [!INCLUDE[ssDE](../includes/ssde-md.md)].</span><span class="sxs-lookup"><span data-stu-id="968d3-954">All of the resources listed in the section above participate in the [!INCLUDE[ssDE](../includes/ssde-md.md)] deadlock detection scheme.</span></span> <span data-ttu-id="968d3-955">La détection de blocage est mise en œuvre par un thread de contrôle des verrous qui lance périodiquement une recherche sur toutes les tâches d'une instance du [!INCLUDE[ssDE](../includes/ssde-md.md)].</span><span class="sxs-lookup"><span data-stu-id="968d3-955">Deadlock detection is performed by a lock monitor thread that periodically initiates a search through all of the tasks in an instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)].</span></span> <span data-ttu-id="968d3-956">Le processus de recherche présente les caractéristiques suivantes :</span><span class="sxs-lookup"><span data-stu-id="968d3-956">The following points describe the search process:</span></span>  
  
-   <span data-ttu-id="968d3-957">L'intervalle par défaut est de 5 secondes.</span><span class="sxs-lookup"><span data-stu-id="968d3-957">The default interval is 5 seconds.</span></span>  
  
-   <span data-ttu-id="968d3-958">Si le thread de contrôle des verrous détecte des blocages, de 5 secondes, l'intervalle de détection de blocage pourra descendre jusqu'à 100 millisecondes, en fonction de la fréquence des blocages.</span><span class="sxs-lookup"><span data-stu-id="968d3-958">If the lock monitor thread finds deadlocks, the deadlock detection interval will drop from 5 seconds to as low as 100 milliseconds depending on the frequency of deadlocks.</span></span>  
  
-   <span data-ttu-id="968d3-959">Si le thread de contrôle des verrous ne détecte plus de blocages, le [!INCLUDE[ssDE](../includes/ssde-md.md)] refera passer l'intervalle de recherche à 5 secondes.</span><span class="sxs-lookup"><span data-stu-id="968d3-959">If the lock monitor thread stops finding deadlocks, the [!INCLUDE[ssDE](../includes/ssde-md.md)] increases the intervals between searches to 5 seconds.</span></span>  
  
-   <span data-ttu-id="968d3-960">Si un blocage vient d'être détecté, les prochains threads qui doivent attendre un verrou sont supposés entrer dans le cycle de blocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-960">If a deadlock has just been detected, it is assumed that the next threads that must wait for a lock are entering the deadlock cycle.</span></span> <span data-ttu-id="968d3-961">Les deux premières attentes de verrous postérieures à une détection de blocage déclencheront immédiatement une recherche de blocage sans attendre le prochain intervalle de détection de blocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-961">The first couple of lock waits after a deadlock has been detected will immediately trigger a deadlock search rather than wait for the next deadlock detection interval.</span></span> <span data-ttu-id="968d3-962">Par exemple, si l'intervalle courant est de 5 secondes et qu'un blocage vient d'être détecté, la prochaine attente de verrou lancera immédiatement le détecteur de blocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-962">For example, if the current interval is 5 seconds, and a deadlock was just detected, the next lock wait will kick off the deadlock detector immediately.</span></span> <span data-ttu-id="968d3-963">Si cette attente de verrou est impliquée dans un blocage, celui-ci sera détecté sur le champ et non lors de la prochaine recherche de blocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-963">If this lock wait is part of a deadlock, it will be detected right away rather than during next deadlock search.</span></span>  
  
 <span data-ttu-id="968d3-964">En règle générale, le [!INCLUDE[ssDE](../includes/ssde-md.md)] n'opère qu'une détection de blocage périodique.</span><span class="sxs-lookup"><span data-stu-id="968d3-964">The [!INCLUDE[ssDE](../includes/ssde-md.md)] typically performs periodic deadlock detection only.</span></span> <span data-ttu-id="968d3-965">Puisque le nombre de blocages rencontrés dans le système est généralement faible, la détection de blocages périodique permet de réduire l'intendance des détections de blocage dans le système.</span><span class="sxs-lookup"><span data-stu-id="968d3-965">Because the number of deadlocks encountered in the system is usually small, periodic deadlock detection helps to reduce the overhead of deadlock detection in the system.</span></span>  
  
 <span data-ttu-id="968d3-966">Lorsque le contrôleur de verrous initialise une recherche de blocage pour une thread particulière, il identifie la ressource sur laquelle le thread est en attente.</span><span class="sxs-lookup"><span data-stu-id="968d3-966">When the lock monitor initiates deadlock search for a particular thread, it identifies the resource on which the thread is waiting.</span></span> <span data-ttu-id="968d3-967">Il recherche ensuite le ou les propriétaires de la ressource concernée et continue la recherche de façon récursive, jusqu'à ce qu'il trouve un cycle.</span><span class="sxs-lookup"><span data-stu-id="968d3-967">The lock monitor then finds the owner(s) for that particular resource and recursively continues the deadlock search for those threads until it finds a cycle.</span></span> <span data-ttu-id="968d3-968">Un cycle identifié de cette manière forme un blocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-968">A cycle identified in this manner forms a deadlock.</span></span>  
  
 <span data-ttu-id="968d3-969">Dès lors qu'un blocage est détecté, le [!INCLUDE[ssDE](../includes/ssde-md.md)] met fin à un blocage en choisissant l'un des threads comme victime.</span><span class="sxs-lookup"><span data-stu-id="968d3-969">After a deadlock is detected, the [!INCLUDE[ssDE](../includes/ssde-md.md)] ends a deadlock by choosing one of the threads as a deadlock victim.</span></span> <span data-ttu-id="968d3-970">Le [!INCLUDE[ssDE](../includes/ssde-md.md)] met fin au traitement en cours d'exécution pour le thread, annule la transaction de la victime, puis retourne une erreur 1205 à l'application.</span><span class="sxs-lookup"><span data-stu-id="968d3-970">The [!INCLUDE[ssDE](../includes/ssde-md.md)] terminates the current batch being executed for the thread, rolls back the transaction of the deadlock victim, and returns a 1205 error to the application.</span></span> <span data-ttu-id="968d3-971">L'annulation de la transaction de la victime du blocage a pour effet de libérer tous les verrous détenus par la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-971">Rolling back the transaction for the deadlock victim releases all locks held by the transaction.</span></span> <span data-ttu-id="968d3-972">Cela permet aux transactions des autres threads de se débloquer et de continuer.</span><span class="sxs-lookup"><span data-stu-id="968d3-972">This allows the transactions of the other threads to become unblocked and continue.</span></span> <span data-ttu-id="968d3-973">L'erreur de victime de blocage 1205 enregistre des informations sur les threads et les ressources impliqués dans un blocage dans le journal des erreurs.</span><span class="sxs-lookup"><span data-stu-id="968d3-973">The 1205 deadlock victim error records information about the threads and resources involved in a deadlock in the error log.</span></span>  
  
 <span data-ttu-id="968d3-974">Par défaut, le [!INCLUDE[ssDE](../includes/ssde-md.md)] choisit comme victime du blocage la session qui exécute la transaction dont l'annulation est la moins coûteuse.</span><span class="sxs-lookup"><span data-stu-id="968d3-974">By default, the [!INCLUDE[ssDE](../includes/ssde-md.md)] chooses as the deadlock victim the session running the transaction that is least expensive to roll back.</span></span> <span data-ttu-id="968d3-975">Un utilisateur peut également spécifier la priorité des sessions dans une situation de blocage au moyen de l'instruction SET DEADLOCK_PRIORITY.</span><span class="sxs-lookup"><span data-stu-id="968d3-975">Alternatively, a user can specify the priority of sessions in a deadlock situation using the SET DEADLOCK_PRIORITY statement.</span></span> <span data-ttu-id="968d3-976">DEADLOCK_PRIORITY accepte les valeurs LOW, NORMAL ou HIGH, voire toute valeur entière comprise entre -10 et 10.</span><span class="sxs-lookup"><span data-stu-id="968d3-976">DEADLOCK_PRIORITY can be set to LOW, NORMAL, or HIGH, or alternatively can be set to any integer value in the range (-10 to 10).</span></span> <span data-ttu-id="968d3-977">La valeur par défaut de la priorité de blocage est NORMAL.</span><span class="sxs-lookup"><span data-stu-id="968d3-977">The deadlock priority defaults to NORMAL.</span></span> <span data-ttu-id="968d3-978">Si deux sessions ont des priorités de blocage différentes, c'est la session qui a la priorité la plus basse qui est choisie comme victime.</span><span class="sxs-lookup"><span data-stu-id="968d3-978">If two sessions have different deadlock priorities, the session with the lower priority is chosen as the deadlock victim.</span></span> <span data-ttu-id="968d3-979">Si les deux sessions ont la même priorité de blocage, c'est celle dont la transaction est la moins coûteuse à annuler qui est choisie.</span><span class="sxs-lookup"><span data-stu-id="968d3-979">If both sessions have the same deadlock priority, the session with the transaction that is least expensive to roll back is chosen.</span></span> <span data-ttu-id="968d3-980">Si les sessions impliquées dans le cycle de blocage présentent une priorité de blocage et un coût identiques, la victime est choisie de façon aléatoire.</span><span class="sxs-lookup"><span data-stu-id="968d3-980">If sessions involved in the deadlock cycle have the same deadlock priority and the same cost, a victim is chosen randomly.</span></span>  
  
 <span data-ttu-id="968d3-981">Lorsque les fonctionnalités CLR sont utilisées, le moniteur de blocage détecte automatiquement le blocage des ressources de synchronisation (moniteurs, verrou de lecture/écriture et jointure de thread) qui font l'objet d'accès à l'intérieur des procédures gérées.</span><span class="sxs-lookup"><span data-stu-id="968d3-981">When working with CLR, the deadlock monitor automatically detects deadlock for synchronization resources (monitors, reader/writer lock and thread join) accessed inside managed procedures.</span></span> <span data-ttu-id="968d3-982">Toutefois, le blocage est résolu par la levée d'une exception dans la procédure qui a été sélectionnée comme victime du blocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-982">However, the deadlock is resolved by throwing an exception in the procedure that was selected to be the deadlock victim.</span></span> <span data-ttu-id="968d3-983">Il est important de comprendre que l'exception ne libère pas automatiquement les ressources actuellement détenues par la victime ; les ressources doivent être libérées explicitement.</span><span class="sxs-lookup"><span data-stu-id="968d3-983">It is important to understand that the exception does not automatically release resources currently owned by the victim; the resources must be explicitly released.</span></span> <span data-ttu-id="968d3-984">Conformément au comportement des exceptions, l'exception utilisée pour identifier une victime de blocage peut être interceptée et annulée.</span><span class="sxs-lookup"><span data-stu-id="968d3-984">Consistent with exception behavior, the exception used to identify a deadlock victim can be caught and dismissed.</span></span>  
  
##### <a name="deadlock-information-tools"></a><span data-ttu-id="968d3-985">Outils d'information sur les blocages</span><span class="sxs-lookup"><span data-stu-id="968d3-985">Deadlock Information Tools</span></span>  

 <span data-ttu-id="968d3-986">Pour afficher les informations sur le blocage, le [!INCLUDE[ssDE](../includes/ssde-md.md)] fournit des outils de surveillance sous la forme de deux indicateurs de trace, ainsi que l'événement Deadlock Graph dans [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)].</span><span class="sxs-lookup"><span data-stu-id="968d3-986">To view deadlock information, the [!INCLUDE[ssDE](../includes/ssde-md.md)] provides monitoring tools in the form of two trace flags, and the deadlock graph event in [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)].</span></span>  
  
###### <a name="trace-flag-1204-and-trace-flag-1222"></a><span data-ttu-id="968d3-987">Indicateur de trace 1204 et indicateur de trace 1222</span><span class="sxs-lookup"><span data-stu-id="968d3-987">Trace Flag 1204 and Trace Flag 1222</span></span>  

 <span data-ttu-id="968d3-988">En cas de situation de blocage, l'indicateur de trace 1204 et l'indicateur de trace 1222 retournent des informations qui sont recueillies dans le journal des erreurs [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="968d3-988">When deadlocks occur, trace flag 1204 and trace flag 1222 return information that is captured in the [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] error log.</span></span> <span data-ttu-id="968d3-989">L'indicateur de trace 1024 signale les informations de blocage mises en forme par chaque nœud impliqué dans le blocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-989">Trace flag 1204 reports deadlock information formatted by each node involved in the deadlock.</span></span> <span data-ttu-id="968d3-990">L'indicateur de trace 1222 met en forme les informations de blocage, en commençant par les processus et en poursuivant avec les ressources.</span><span class="sxs-lookup"><span data-stu-id="968d3-990">Trace flag 1222 formats deadlock information, first by processes and then by resources.</span></span> <span data-ttu-id="968d3-991">Il est possible d'activer deux indicateurs de trace pour obtenir deux représentations du même événement de blocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-991">It is possible to enable both trace flags to obtain two representations of the same deadlock event.</span></span>  
  
 <span data-ttu-id="968d3-992">En dehors de la définition des propriétés des indicateurs de trace 1204 et 1222, le tableau suivant contient également les ressemblances et les différences.</span><span class="sxs-lookup"><span data-stu-id="968d3-992">In addition to defining the properties of trace flag 1204 and 1222, the following table also shows the similarities and differences.</span></span>  
  
|<span data-ttu-id="968d3-993">Propriété</span><span class="sxs-lookup"><span data-stu-id="968d3-993">Property</span></span>|<span data-ttu-id="968d3-994">Indicateur de trace 1204 et indicateur de trace 1222</span><span class="sxs-lookup"><span data-stu-id="968d3-994">Trace Flag 1204 and Trace Flag 1222</span></span>|<span data-ttu-id="968d3-995">Indicateur de trace 1204 uniquement</span><span class="sxs-lookup"><span data-stu-id="968d3-995">Trace Flag 1204 only</span></span>|<span data-ttu-id="968d3-996">Indicateur de trace 1222 uniquement</span><span class="sxs-lookup"><span data-stu-id="968d3-996">Trace Flag 1222 only</span></span>|  
|--------------|-----------------------------------------|--------------------------|--------------------------|  
|<span data-ttu-id="968d3-997">Format de sortie</span><span class="sxs-lookup"><span data-stu-id="968d3-997">Output format</span></span>|<span data-ttu-id="968d3-998">La sortie est capturée dans le journal des erreurs de [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="968d3-998">Output is captured in the [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] error log.</span></span>|<span data-ttu-id="968d3-999">Les nœuds impliqués dans le blocage sont privilégiés.</span><span class="sxs-lookup"><span data-stu-id="968d3-999">Focused on the nodes involved in the deadlock.</span></span> <span data-ttu-id="968d3-1000">Chaque nœud dispose d'une section dédiée, tandis que la section finale décrit la victime du blocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-1000">Each node has a dedicated section, and the final section describes the deadlock victim.</span></span>|<span data-ttu-id="968d3-1001">Retourne des informations dans un format de type XML, mais non conforme au schéma XSD (XML Schema Definition).</span><span class="sxs-lookup"><span data-stu-id="968d3-1001">Returns information in an XML-like format that does not conform to an XML Schema Definition (XSD) schema.</span></span> <span data-ttu-id="968d3-1002">Le format possède trois sections principales.</span><span class="sxs-lookup"><span data-stu-id="968d3-1002">The format has three major sections.</span></span> <span data-ttu-id="968d3-1003">La première déclare la victime du blocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-1003">The first section declares the deadlock victim.</span></span> <span data-ttu-id="968d3-1004">La deuxième décrit chaque processus impliqué dans le blocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-1004">The second section describes each process involved in the deadlock.</span></span> <span data-ttu-id="968d3-1005">La troisième décrit les ressources synonymes des nœuds de l'indicateur de trace 1204.</span><span class="sxs-lookup"><span data-stu-id="968d3-1005">The third section describes the resources that are synonymous with nodes in trace flag 1204.</span></span>|  
|<span data-ttu-id="968d3-1006">Identification d'attributs</span><span class="sxs-lookup"><span data-stu-id="968d3-1006">Identifying attributes</span></span>|<span data-ttu-id="968d3-1007">**SPID : \<x> ECID : \<x> .**</span><span class="sxs-lookup"><span data-stu-id="968d3-1007">**SPID:\<x> ECID:\<x>.**</span></span> <span data-ttu-id="968d3-1008">Identifie le thread de l'ID du processus système en cas de traitements parallèles.</span><span class="sxs-lookup"><span data-stu-id="968d3-1008">Identifies the system process ID thread in cases of parallel processes.</span></span> <span data-ttu-id="968d3-1009">L’entrée `SPID:<x> ECID:0` , où \<x> est remplacé par la valeur SPID, représente le thread principal.</span><span class="sxs-lookup"><span data-stu-id="968d3-1009">The entry `SPID:<x> ECID:0`, where \<x> is replaced by the SPID value, represents the main thread.</span></span> <span data-ttu-id="968d3-1010">L’entrée `SPID:<x> ECID:<y>` , où \<x> est remplacé par la valeur SPID et \<y> est supérieure à 0, représente les sous-threads du même SPID.</span><span class="sxs-lookup"><span data-stu-id="968d3-1010">The entry `SPID:<x> ECID:<y>`, where \<x> is replaced by the SPID value and \<y> is greater than 0, represents the sub-threads for the same SPID.</span></span><br /><br /> <span data-ttu-id="968d3-1011">**BatchID** (**sbid** pour l’indicateur de trace 1222).</span><span class="sxs-lookup"><span data-stu-id="968d3-1011">**BatchID** (**sbid** for trace flag 1222).</span></span> <span data-ttu-id="968d3-1012">Identifie le traitement à partir duquel l'exécution du code demande ou détient un verrou.</span><span class="sxs-lookup"><span data-stu-id="968d3-1012">Identifies the batch from which code execution is requesting or holding a lock.</span></span> <span data-ttu-id="968d3-1013">Lorsque MARS (Multiple Active Result Sets) est désactivé, la valeur BatchID est 0.</span><span class="sxs-lookup"><span data-stu-id="968d3-1013">When Multiple Active Result Sets (MARS) is disabled, the BatchID value is 0.</span></span> <span data-ttu-id="968d3-1014">Quand MARS est activé, la valeur des lots actifs est 1 pour *n*.</span><span class="sxs-lookup"><span data-stu-id="968d3-1014">When MARS is enabled, the value for active batches is 1 to *n*.</span></span> <span data-ttu-id="968d3-1015">Si la session ne comporte pas de traitements actifs, BatchID a pour valeur 0.</span><span class="sxs-lookup"><span data-stu-id="968d3-1015">If there are no active batches in the session, BatchID is 0.</span></span><br /><br /> <span data-ttu-id="968d3-1016">**Mode**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1016">**Mode**.</span></span> <span data-ttu-id="968d3-1017">Spécifie, pour une ressource particulière, le type de verrou demandé, accordé ou attendu par un thread.</span><span class="sxs-lookup"><span data-stu-id="968d3-1017">Specifies the type of lock for a particular resource that is requested, granted, or waited on by a thread.</span></span> <span data-ttu-id="968d3-1018">Les différents modes sont IS (intent partagé), S (partagé), U (mise à jour), IX (intent exclusif), SIX (partagé avec intent exclusif) et X (exclusif).</span><span class="sxs-lookup"><span data-stu-id="968d3-1018">Mode can be IS (Intent Shared), S (Shared), U (Update), IX (Intent Exclusive), SIX (Shared with Intent Exclusive), and X (Exclusive).</span></span><br /><br /> <span data-ttu-id="968d3-1019">**Line #** (**line** pour l’indicateur de trace 1222).</span><span class="sxs-lookup"><span data-stu-id="968d3-1019">**Line #** (**line** for trace flag 1222).</span></span> <span data-ttu-id="968d3-1020">Indique le numéro de ligne du traitement qui était en cours d'exécution lorsque le blocage s'est produit.</span><span class="sxs-lookup"><span data-stu-id="968d3-1020">Lists the line number in the current batch of statements that was being executed when the deadlock occurred.</span></span><br /><br /> <span data-ttu-id="968d3-1021">**Input Buf** (**inputbuf** pour l’indicateur de trace 1222).</span><span class="sxs-lookup"><span data-stu-id="968d3-1021">**Input Buf** (**inputbuf** for trace flag 1222).</span></span> <span data-ttu-id="968d3-1022">Dresse la liste de toutes les instructions du traitement en cours.</span><span class="sxs-lookup"><span data-stu-id="968d3-1022">Lists all the statements in the current batch.</span></span>|<span data-ttu-id="968d3-1023">**Node**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1023">**Node**.</span></span> <span data-ttu-id="968d3-1024">Il s'agit du numéro d'entrée dans la chaîne de blocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-1024">Represents the entry number in the deadlock chain.</span></span><br /><br /> <span data-ttu-id="968d3-1025">**Lists**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1025">**Lists**.</span></span> <span data-ttu-id="968d3-1026">Le propriétaire du verrou peut faire partie des listes suivantes :</span><span class="sxs-lookup"><span data-stu-id="968d3-1026">The lock owner can be part of these lists:</span></span><br /><br /> <span data-ttu-id="968d3-1027">**Grant List**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1027">**Grant List**.</span></span> <span data-ttu-id="968d3-1028">Énumère les propriétaires actuels de la ressource.</span><span class="sxs-lookup"><span data-stu-id="968d3-1028">Enumerates the current owners of the resource.</span></span><br /><br /> <span data-ttu-id="968d3-1029">**Convert List**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1029">**Convert List**.</span></span> <span data-ttu-id="968d3-1030">Énumère les propriétaires en cours qui essaient de convertir leurs verrous vers un niveau supérieur.</span><span class="sxs-lookup"><span data-stu-id="968d3-1030">Enumerates the current owners that are trying to convert their locks to a higher level.</span></span><br /><br /> <span data-ttu-id="968d3-1031">**Wait List**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1031">**Wait List**.</span></span> <span data-ttu-id="968d3-1032">Énumère les nouvelles demandes de verrou en cours pour la ressource.</span><span class="sxs-lookup"><span data-stu-id="968d3-1032">Enumerates current new lock requests for the resource.</span></span><br /><br /> <span data-ttu-id="968d3-1033">**Statement Type**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1033">**Statement Type**.</span></span> <span data-ttu-id="968d3-1034">Décrit le type d'instructions DML (SELECT, INSERT, UPDATE ou DELETE) sur lesquelles les threads disposent d'autorisations.</span><span class="sxs-lookup"><span data-stu-id="968d3-1034">Describes the type of DML statement (SELECT, INSERT, UPDATE, or DELETE) on which the threads have permissions.</span></span><br /><br /> <span data-ttu-id="968d3-1035">**Victim Resource Owner**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1035">**Victim Resource Owner**.</span></span> <span data-ttu-id="968d3-1036">Spécifie le thread choisi comme victime par [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] pour rompre le cycle de blocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-1036">Specifies the participating thread that [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] chooses as the victim to break the deadlock cycle.</span></span> <span data-ttu-id="968d3-1037">Il est alors mis fin au thread choisi et à tous les sous-threads existants.</span><span class="sxs-lookup"><span data-stu-id="968d3-1037">The chosen thread and all existing sub-threads are terminated.</span></span><br /><br /> <span data-ttu-id="968d3-1038">**Next Branch**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1038">**Next Branch**.</span></span> <span data-ttu-id="968d3-1039">Représente les deux sous-threads (ou plus) du même SPID qui participent au cycle de blocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-1039">Represents the two or more sub-threads from the same SPID that are involved in the deadlock cycle.</span></span>|<span data-ttu-id="968d3-1040">**deadlock victim**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1040">**deadlock victim**.</span></span> <span data-ttu-id="968d3-1041">Représente l’adresse de mémoire physique de la tâche (consultez [sys.dm_os_tasks &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-os-tasks-transact-sql)) qui a été sélectionnée comme victime de l’interblocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-1041">Represents the physical memory address of the task (see [sys.dm_os_tasks &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-os-tasks-transact-sql)) that was selected as a deadlock victim.</span></span> <span data-ttu-id="968d3-1042">Elle est égale à 0 (zéro) en cas de non résolution du blocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-1042">It may be 0 (zero) in the case of an unresolved deadlock.</span></span> <span data-ttu-id="968d3-1043">Une tâche en cours d'annulation ne peut pas être choisie comme victime de blocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-1043">A task that is rolling back cannot be chosen as a deadlock victim.</span></span><br /><br /> <span data-ttu-id="968d3-1044">**executionstack**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1044">**executionstack**.</span></span> <span data-ttu-id="968d3-1045">Représente le code [!INCLUDE[tsql](../includes/tsql-md.md)] en cours d'exécution lorsque le blocage se produit.</span><span class="sxs-lookup"><span data-stu-id="968d3-1045">Represents [!INCLUDE[tsql](../includes/tsql-md.md)] code that is being executed at the time the deadlock occurs.</span></span><br /><br /> <span data-ttu-id="968d3-1046">**priority**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1046">**priority**.</span></span> <span data-ttu-id="968d3-1047">Représente la priorité de blocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-1047">Represents deadlock priority.</span></span> <span data-ttu-id="968d3-1048">Dans certains cas, le [!INCLUDE[ssDE](../includes/ssde-md.md)] peut choisir de modifier la priorité de blocage pendant un bref laps de temps afin de favoriser la concurrence.</span><span class="sxs-lookup"><span data-stu-id="968d3-1048">In certain cases, the [!INCLUDE[ssDE](../includes/ssde-md.md)] may opt to alter the deadlock priority for a short duration to achieve better concurrency.</span></span><br /><br /> <span data-ttu-id="968d3-1049">**logused**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1049">**logused**.</span></span> <span data-ttu-id="968d3-1050">Espace journal utilisé par la tâche.</span><span class="sxs-lookup"><span data-stu-id="968d3-1050">Log space used by the task.</span></span><br /><br /> <span data-ttu-id="968d3-1051">**owner id**. ID de la transaction qui contrôle la demande.</span><span class="sxs-lookup"><span data-stu-id="968d3-1051">**owner id**. The ID of the transaction that has control of the request.</span></span><br /><br /> <span data-ttu-id="968d3-1052">**status**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1052">**status**.</span></span> <span data-ttu-id="968d3-1053">État de la tâche.</span><span class="sxs-lookup"><span data-stu-id="968d3-1053">State of the task.</span></span> <span data-ttu-id="968d3-1054">Il prend l'une des valeurs suivantes :</span><span class="sxs-lookup"><span data-stu-id="968d3-1054">It is one of the following values:</span></span><br /><br /> <span data-ttu-id="968d3-1055">>> **pending**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1055">>> **pending**.</span></span> <span data-ttu-id="968d3-1056">En attente d'un thread de travail.</span><span class="sxs-lookup"><span data-stu-id="968d3-1056">Waiting for a worker thread.</span></span><br /><br /> <span data-ttu-id="968d3-1057">>> **runnable**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1057">>> **runnable**.</span></span> <span data-ttu-id="968d3-1058">Prêt à s'exécuter, mais en attente d'un quantum.</span><span class="sxs-lookup"><span data-stu-id="968d3-1058">Ready to run but waiting for a quantum.</span></span><br /><br /> <span data-ttu-id="968d3-1059">>> **running**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1059">>> **running**.</span></span> <span data-ttu-id="968d3-1060">En cours d'exécution sur le planificateur.</span><span class="sxs-lookup"><span data-stu-id="968d3-1060">Currently running on the scheduler.</span></span><br /><br /> <span data-ttu-id="968d3-1061">>> **suspended**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1061">>> **suspended**.</span></span> <span data-ttu-id="968d3-1062">L'exécution est suspendue.</span><span class="sxs-lookup"><span data-stu-id="968d3-1062">Execution is suspended.</span></span><br /><br /> <span data-ttu-id="968d3-1063">>> **done**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1063">>> **done**.</span></span> <span data-ttu-id="968d3-1064">La tâche est achevée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1064">Task has completed.</span></span><br /><br /> <span data-ttu-id="968d3-1065">>> **spinloop**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1065">>> **spinloop**.</span></span> <span data-ttu-id="968d3-1066">En attente de libération d'un spinlock.</span><span class="sxs-lookup"><span data-stu-id="968d3-1066">Waiting for a spinlock to become free.</span></span><br /><br /> <span data-ttu-id="968d3-1067">**waitresource**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1067">**waitresource**.</span></span> <span data-ttu-id="968d3-1068">Ressource convoitée par la tâche.</span><span class="sxs-lookup"><span data-stu-id="968d3-1068">The resource needed by the task.</span></span><br /><br /> <span data-ttu-id="968d3-1069">**waittime**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1069">**waittime**.</span></span> <span data-ttu-id="968d3-1070">Délai d'attente de la ressource en millisecondes.</span><span class="sxs-lookup"><span data-stu-id="968d3-1070">Time in milliseconds waiting for the resource.</span></span><br /><br /> <span data-ttu-id="968d3-1071">**schedulerid**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1071">**schedulerid**.</span></span> <span data-ttu-id="968d3-1072">Planificateur associé à cette tâche.</span><span class="sxs-lookup"><span data-stu-id="968d3-1072">Scheduler associated with this task.</span></span> <span data-ttu-id="968d3-1073">Consultez [sys.dm_os_schedulers &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-os-schedulers-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="968d3-1073">See [sys.dm_os_schedulers &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-os-schedulers-transact-sql).</span></span><br /><br /> <span data-ttu-id="968d3-1074">**hostname**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1074">**hostname**.</span></span> <span data-ttu-id="968d3-1075">Nom de la station de travail.</span><span class="sxs-lookup"><span data-stu-id="968d3-1075">The name of the workstation.</span></span><br /><br /> <span data-ttu-id="968d3-1076">**isolationlevel**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1076">**isolationlevel**.</span></span> <span data-ttu-id="968d3-1077">Niveau d'isolement des transactions en cours.</span><span class="sxs-lookup"><span data-stu-id="968d3-1077">The current transaction isolation level.</span></span><br /><br /> <span data-ttu-id="968d3-1078">**Xactid**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1078">**Xactid**.</span></span> <span data-ttu-id="968d3-1079">ID de la transaction qui contrôle la demande.</span><span class="sxs-lookup"><span data-stu-id="968d3-1079">The ID of the transaction that has control of the request.</span></span><br /><br /> <span data-ttu-id="968d3-1080">**currentdb**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1080">**currentdb**.</span></span> <span data-ttu-id="968d3-1081">ID de la base de données.</span><span class="sxs-lookup"><span data-stu-id="968d3-1081">The ID of the database.</span></span><br /><br /> <span data-ttu-id="968d3-1082">**lastbatchstarted**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1082">**lastbatchstarted**.</span></span> <span data-ttu-id="968d3-1083">Dernière fois qu'un processus client a démarré une exécution de traitement.</span><span class="sxs-lookup"><span data-stu-id="968d3-1083">The last time a client process started batch execution.</span></span><br /><br /> <span data-ttu-id="968d3-1084">**lastbatchcompleted**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1084">**lastbatchcompleted**.</span></span> <span data-ttu-id="968d3-1085">Dernière fois qu'un processus client a terminé une exécution de traitement.</span><span class="sxs-lookup"><span data-stu-id="968d3-1085">The last time a client process completed batch execution.</span></span><br /><br /> <span data-ttu-id="968d3-1086">**clientoption1 et clientoption2**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1086">**clientoption1 and clientoption2**.</span></span> <span data-ttu-id="968d3-1087">Options définies pour cette connexion cliente.</span><span class="sxs-lookup"><span data-stu-id="968d3-1087">Set options on this client connection.</span></span> <span data-ttu-id="968d3-1088">Il s'agit d'un masque de bits qui contient des informations sur les options habituellement contrôlées par les instructions SET, telles que SET NOCOUNT et SET XACTABORT.</span><span class="sxs-lookup"><span data-stu-id="968d3-1088">This is a bitmask that includes information about options usually controlled by SET statements such as SET NOCOUNT and SET XACTABORT.</span></span><br /><br /> <span data-ttu-id="968d3-1089">**associatedObjectId**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1089">**associatedObjectId**.</span></span> <span data-ttu-id="968d3-1090">Représente l'ID HoBT (Heap or B-tree, segment de mémoire ou arborescence binaire).</span><span class="sxs-lookup"><span data-stu-id="968d3-1090">Represents the HoBT (heap or b-tree) ID.</span></span>|  
|<span data-ttu-id="968d3-1091">Attributs des ressources</span><span class="sxs-lookup"><span data-stu-id="968d3-1091">Resource attributes</span></span>|<span data-ttu-id="968d3-1092">**RID**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1092">**RID**.</span></span> <span data-ttu-id="968d3-1093">Identifie la ligne d'une table pour laquelle un verrou est détenu ou demandé.</span><span class="sxs-lookup"><span data-stu-id="968d3-1093">Identifies the single row within a table on which a lock is held or requested.</span></span> <span data-ttu-id="968d3-1094">RID est représenté comme RID : *db_id:file_id:page_no:row_no*.</span><span class="sxs-lookup"><span data-stu-id="968d3-1094">RID is represented as RID: *db_id:file_id:page_no:row_no*.</span></span> <span data-ttu-id="968d3-1095">Par exemple : `RID: 6:1:20789:0`.</span><span class="sxs-lookup"><span data-stu-id="968d3-1095">For example, `RID: 6:1:20789:0`.</span></span><br /><br /> <span data-ttu-id="968d3-1096">**OBJECT**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1096">**OBJECT**.</span></span> <span data-ttu-id="968d3-1097">Identifie la table pour laquelle un verrou est détenu ou demandé.</span><span class="sxs-lookup"><span data-stu-id="968d3-1097">Identifies the table on which a lock is held or requested.</span></span> <span data-ttu-id="968d3-1098">OBJECT est représenté comme OBJECT : *db_id:object_id*.</span><span class="sxs-lookup"><span data-stu-id="968d3-1098">OBJECT is represented as OBJECT: *db_id:object_id*.</span></span> <span data-ttu-id="968d3-1099">Par exemple : `TAB: 6:2009058193`.</span><span class="sxs-lookup"><span data-stu-id="968d3-1099">For example, `TAB: 6:2009058193`.</span></span><br /><br /> <span data-ttu-id="968d3-1100">**KEY**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1100">**KEY**.</span></span> <span data-ttu-id="968d3-1101">Identifie la plage de clés d'un index pour laquelle un verrou est détenu ou demandé.</span><span class="sxs-lookup"><span data-stu-id="968d3-1101">Identifies the key range within an index on which a lock is held or requested.</span></span> <span data-ttu-id="968d3-1102">KEY est représenté comme KEY : *db_id:hobt_id* (*valeur de hachage de la clé d’index*).</span><span class="sxs-lookup"><span data-stu-id="968d3-1102">KEY is represented as KEY: *db_id:hobt_id* (*index key hash value*).</span></span> <span data-ttu-id="968d3-1103">Par exemple : `KEY: 6:72057594057457664 (350007a4d329)`.</span><span class="sxs-lookup"><span data-stu-id="968d3-1103">For example, `KEY: 6:72057594057457664 (350007a4d329)`.</span></span><br /><br /> <span data-ttu-id="968d3-1104">**PAG**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1104">**PAG**.</span></span> <span data-ttu-id="968d3-1105">Identifie la ressource de page pour laquelle un verrou est détenu ou demandé.</span><span class="sxs-lookup"><span data-stu-id="968d3-1105">Identifies the page resource on which a lock is held or requested.</span></span> <span data-ttu-id="968d3-1106">PAG est représenté comme PAG : *db_id:file_id:page_no*.</span><span class="sxs-lookup"><span data-stu-id="968d3-1106">PAG is represented as PAG: *db_id:file_id:page_no*.</span></span> <span data-ttu-id="968d3-1107">Par exemple : `PAG: 6:1:20789`.</span><span class="sxs-lookup"><span data-stu-id="968d3-1107">For example, `PAG: 6:1:20789`.</span></span><br /><br /> <span data-ttu-id="968d3-1108">**EXT**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1108">**EXT**.</span></span> <span data-ttu-id="968d3-1109">Identifie la structure d'extension.</span><span class="sxs-lookup"><span data-stu-id="968d3-1109">Identifies the extent structure.</span></span> <span data-ttu-id="968d3-1110">EXT est représenté comme EXT : *db_id:file_id:extent_no*.</span><span class="sxs-lookup"><span data-stu-id="968d3-1110">EXT is represented as EXT: *db_id:file_id:extent_no*.</span></span> <span data-ttu-id="968d3-1111">Par exemple : `EXT: 6:1:9`.</span><span class="sxs-lookup"><span data-stu-id="968d3-1111">For example, `EXT: 6:1:9`.</span></span><br /><br /> <span data-ttu-id="968d3-1112">**DB**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1112">**DB**.</span></span> <span data-ttu-id="968d3-1113">Identifie le verrou de base de données.</span><span class="sxs-lookup"><span data-stu-id="968d3-1113">Identifies the database lock.</span></span> <span data-ttu-id="968d3-1114">**DB est représenté de l’une des manières suivantes :**</span><span class="sxs-lookup"><span data-stu-id="968d3-1114">**DB is represented in one of the following ways:**</span></span><br /><br /> <span data-ttu-id="968d3-1115">DB : *db_id*</span><span class="sxs-lookup"><span data-stu-id="968d3-1115">DB: *db_id*</span></span><br /><br /> <span data-ttu-id="968d3-1116">DB : *db_id*[BULK-OP-DB], qui identifie le verrou de base de données pris par la base de données de sauvegarde.</span><span class="sxs-lookup"><span data-stu-id="968d3-1116">DB: *db_id*[BULK-OP-DB], which identifies the database lock taken by the backup database.</span></span><br /><br /> <span data-ttu-id="968d3-1117">DB : *db_id*[BULK-OP-LOG], qui identifie le verrou pris par le journal de sauvegarde pour cette base de données spécifique.</span><span class="sxs-lookup"><span data-stu-id="968d3-1117">DB: *db_id*[BULK-OP-LOG], which identifies the lock taken by the backup log for that particular database.</span></span><br /><br /> <span data-ttu-id="968d3-1118">**APP**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1118">**APP**.</span></span> <span data-ttu-id="968d3-1119">Identifie le verrou pris par une ressource d'application.</span><span class="sxs-lookup"><span data-stu-id="968d3-1119">Identifies the lock taken by an application resource.</span></span> <span data-ttu-id="968d3-1120">APP est représenté comme APP : *lock_resource*.</span><span class="sxs-lookup"><span data-stu-id="968d3-1120">APP is represented as APP: *lock_resource*.</span></span> <span data-ttu-id="968d3-1121">Par exemple : `APP: Formf370f478`.</span><span class="sxs-lookup"><span data-stu-id="968d3-1121">For example, `APP: Formf370f478`.</span></span><br /><br /> <span data-ttu-id="968d3-1122">**METADATA**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1122">**METADATA**.</span></span> <span data-ttu-id="968d3-1123">Représente les ressources de métadonnées impliquées dans un blocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-1123">Represents metadata resources involved in a deadlock.</span></span> <span data-ttu-id="968d3-1124">Comme METADATA possède de nombreuses sous-ressources, la valeur retournée dépend de la sous-ressource bloquée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1124">Because METADATA has many subresources, the value returned depends upon the subresource that has deadlocked.</span></span> <span data-ttu-id="968d3-1125">Par exemple, les MÉTADONNÉEs. USER_TYPE retourne `user_type_id =` \<*integer_value*> .</span><span class="sxs-lookup"><span data-stu-id="968d3-1125">For example, METADATA.USER_TYPE returns `user_type_id =` \<*integer_value*>.</span></span> <span data-ttu-id="968d3-1126">Pour plus d’informations sur les ressources et sous-ressources METADATA, consultez [sys.dm_tran_locks &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-locks-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="968d3-1126">For more information about METADATA resources and subresources, see [sys.dm_tran_locks &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-locks-transact-sql).</span></span><br /><br /> <span data-ttu-id="968d3-1127">**HOBT**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1127">**HOBT**.</span></span> <span data-ttu-id="968d3-1128">Représente un segment de mémoire ou d'arbre B (B-Tree) impliqué dans un blocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-1128">Represents a heap or b-tree involved in a deadlock.</span></span>|<span data-ttu-id="968d3-1129">Non exclusif à cet indicateur de trace.</span><span class="sxs-lookup"><span data-stu-id="968d3-1129">None exclusive to this trace flag.</span></span>|<span data-ttu-id="968d3-1130">Non exclusif à cet indicateur de trace.</span><span class="sxs-lookup"><span data-stu-id="968d3-1130">None exclusive to this trace flag.</span></span>|  
  
###### <a name="trace-flag-1204-example"></a><span data-ttu-id="968d3-1131">Exemple d'indicateur de trace 1204</span><span class="sxs-lookup"><span data-stu-id="968d3-1131">Trace Flag 1204 Example</span></span>  

 <span data-ttu-id="968d3-1132">L'exemple suivant illustre la sortie obtenue quand l'indicateur de trace 1204 est activé.</span><span class="sxs-lookup"><span data-stu-id="968d3-1132">The following example shows the output when trace flag 1204 is turned on.</span></span> <span data-ttu-id="968d3-1133">Dans ce cas, la table du nœud 1 est un segment de mémoire sans index et la table du nœud 2 est un segment de mémoire avec un index non-cluster.</span><span class="sxs-lookup"><span data-stu-id="968d3-1133">In this case, the table in Node 1 is a heap with no indexes, and the table in Node 2 is a heap with a nonclustered index.</span></span> <span data-ttu-id="968d3-1134">La clé d'index du nœud 2 est en cours de mise à jour lorsque le blocage se produit.</span><span class="sxs-lookup"><span data-stu-id="968d3-1134">The index key in Node 2 is being updated when the deadlock occurs.</span></span>  
  
```  
Deadlock encountered .... Printing deadlock information  
Wait-for graph  
  
Node:1  
  
RID: 6:1:20789:0               CleanCnt:3 Mode:X Flags: 0x2  
 Grant List 0:  
   Owner:0x0315D6A0 Mode: X          
     Flg:0x0 Ref:0 Life:02000000 SPID:55 ECID:0 XactLockInfo: 0x04D9E27C  
   SPID: 55 ECID: 0 Statement Type: UPDATE Line #: 6  
   Input Buf: Language Event:   
BEGIN TRANSACTION  
   EXEC usp_p2  
 Requested By:   
   ResType:LockOwner Stype:'OR'Xdes:0x03A3DAD0   
     Mode: U SPID:54 BatchID:0 ECID:0 TaskProxy:(0x04976374) Value:0x315d200 Cost:(0/868)  
  
Node:2  
  
KEY: 6:72057594057457664 (350007a4d329) CleanCnt:2 Mode:X Flags: 0x0  
 Grant List 0:  
   Owner:0x0315D140 Mode: X          
     Flg:0x0 Ref:0 Life:02000000 SPID:54 ECID:0 XactLockInfo: 0x03A3DAF4  
   SPID: 54 ECID: 0 Statement Type: UPDATE Line #: 6  
   Input Buf: Language Event:   
     BEGIN TRANSACTION  
       EXEC usp_p1  
 Requested By:   
   ResType:LockOwner Stype:'OR'Xdes:0x04D9E258   
     Mode: U SPID:55 BatchID:0 ECID:0 TaskProxy:(0x0475E374) Value:0x315d4a0 Cost:(0/380)  
  
Victim Resource Owner:  
 ResType:LockOwner Stype:'OR'Xdes:0x04D9E258   
     Mode: U SPID:55 BatchID:0 ECID:0 TaskProxy:(0x0475E374) Value:0x315d4a0 Cost:(0/380)  
```  
  
###### <a name="trace-flag-1222-example"></a><span data-ttu-id="968d3-1135">Exemple d'indicateur de trace 1222</span><span class="sxs-lookup"><span data-stu-id="968d3-1135">Trace Flag 1222 Example</span></span>  

 <span data-ttu-id="968d3-1136">L'exemple suivant illustre la sortie obtenue quand l'indicateur de trace 1222 est activé.</span><span class="sxs-lookup"><span data-stu-id="968d3-1136">The following example shows the output when trace flag 1222 is turned on.</span></span> <span data-ttu-id="968d3-1137">Dans ce cas, une table est un segment de mémoire sans index et l'autre table un segment de mémoire avec un index non-cluster.</span><span class="sxs-lookup"><span data-stu-id="968d3-1137">In this case, one table is a heap with no indexes, and the other table is a heap with a nonclustered index.</span></span> <span data-ttu-id="968d3-1138">Dans la seconde table, la clé d'index est en cours de mise à jour lorsque le blocage se produit.</span><span class="sxs-lookup"><span data-stu-id="968d3-1138">In the second table, the index key is being updated when the deadlock occurs.</span></span>  
  
```  
deadlock-list  
 deadlock victim=process689978  
  process-list  
   process id=process6891f8 taskpriority=0 logused=868   
   waitresource=RID: 6:1:20789:0 waittime=1359 ownerId=310444   
   transactionname=user_transaction   
   lasttranstarted=2005-09-05T11:22:42.733 XDES=0x3a3dad0   
   lockMode=U schedulerid=1 kpid=1952 status=suspended spid=54   
   sbid=0 ecid=0 priority=0 transcount=2   
   lastbatchstarted=2005-09-05T11:22:42.733   
   lastbatchcompleted=2005-09-05T11:22:42.733   
   clientapp=Microsoft SQL Server Management Studio - Query   
   hostname=TEST_SERVER hostpid=2216 loginname=DOMAIN\user   
   isolationlevel=read committed (2) xactid=310444 currentdb=6   
   lockTimeout=4294967295 clientoption1=671090784 clientoption2=390200  
    executionStack  
     frame procname=AdventureWorks2012.dbo.usp_p1 line=6 stmtstart=202   
     sqlhandle=0x0300060013e6446b027cbb00c69600000100000000000000  
     UPDATE T2 SET COL1 = 3 WHERE COL1 = 1;       
     frame procname=adhoc line=3 stmtstart=44   
     sqlhandle=0x01000600856aa70f503b8104000000000000000000000000  
     EXEC usp_p1       
    inputbuf  
      BEGIN TRANSACTION  
       EXEC usp_p1  
   process id=process689978 taskpriority=0 logused=380   
   waitresource=KEY: 6:72057594057457664 (350007a4d329)     
   waittime=5015 ownerId=310462 transactionname=user_transaction   
   lasttranstarted=2005-09-05T11:22:44.077 XDES=0x4d9e258 lockMode=U   
   schedulerid=1 kpid=3024 status=suspended spid=55 sbid=0 ecid=0   
   priority=0 transcount=2 lastbatchstarted=2005-09-05T11:22:44.077   
   lastbatchcompleted=2005-09-05T11:22:44.077   
   clientapp=Microsoft SQL Server Management Studio - Query   
   hostname=TEST_SERVER hostpid=2216 loginname=DOMAIN\user   
   isolationlevel=read committed (2) xactid=310462 currentdb=6   
   lockTimeout=4294967295 clientoption1=671090784 clientoption2=390200  
    executionStack  
     frame procname=AdventureWorks2012.dbo.usp_p2 line=6 stmtstart=200   
     sqlhandle=0x030006004c0a396c027cbb00c69600000100000000000000  
     UPDATE T1 SET COL1 = 4 WHERE COL1 = 1;       
     frame procname=adhoc line=3 stmtstart=44   
     sqlhandle=0x01000600d688e709b85f8904000000000000000000000000  
     EXEC usp_p2       
    inputbuf  
      BEGIN TRANSACTION  
        EXEC usp_p2      
  resource-list  
   ridlock fileid=1 pageid=20789 dbid=6 objectname=AdventureWorks2012.dbo.T2   
   id=lock3136940 mode=X associatedObjectId=72057594057392128  
    owner-list  
     owner id=process689978 mode=X  
    waiter-list  
     waiter id=process6891f8 mode=U requestType=wait  
   keylock hobtid=72057594057457664 dbid=6 objectname=AdventureWorks2012.dbo.T1   
   indexname=nci_T1_COL1 id=lock3136fc0 mode=X   
   associatedObjectId=72057594057457664  
    owner-list  
     owner id=process6891f8 mode=X  
    waiter-list  
     waiter id=process689978 mode=U requestType=wait  
```  
  
###### <a name="profiler-deadlock-graph-event"></a><span data-ttu-id="968d3-1139">Evénement Deadlock Graph de SQL Profiler</span><span class="sxs-lookup"><span data-stu-id="968d3-1139">Profiler Deadlock Graph Event</span></span>  

 <span data-ttu-id="968d3-1140">Il s'agit d'un événement propre au [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)] qui présente une description graphique des tâches et des ressources impliquées dans un blocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-1140">This is an event in [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)] that presents a graphical depiction of the tasks and resources involved in a deadlock.</span></span> <span data-ttu-id="968d3-1141">L'exemple suivant illustre la sortie obtenue à partir de [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)] quand l'événement Deadlock Graph est activé.</span><span class="sxs-lookup"><span data-stu-id="968d3-1141">The following example shows the output from [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)] when the deadlock graph event is turned on.</span></span>  
  
 <span data-ttu-id="968d3-1142">![Diagramme de flux logique montrant le blocage de processus utilisateur.](media/udb9-profilerdeadlockgraphc.gif "Diagramme de flux logique montrant le blocage de processus utilisateur.")</span><span class="sxs-lookup"><span data-stu-id="968d3-1142">![Logic flow diagram showing user process deadlock.](media/udb9-profilerdeadlockgraphc.gif "Logic flow diagram showing user process deadlock.")</span></span>  
  
 <span data-ttu-id="968d3-1143">Pour plus d’informations sur l’exécution du [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)] graphique de blocage, consultez [enregistrer les graphiques d’interblocage &#40;SQL Server Profiler&#41;](../relational-databases/performance/save-deadlock-graphs-sql-server-profiler.md).</span><span class="sxs-lookup"><span data-stu-id="968d3-1143">For more information about running the [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)] deadlock graph, see [Save Deadlock Graphs &#40;SQL Server Profiler&#41;](../relational-databases/performance/save-deadlock-graphs-sql-server-profiler.md).</span></span>  
  
#### <a name="handling-deadlocks"></a><span data-ttu-id="968d3-1144">Gestion des blocages</span><span class="sxs-lookup"><span data-stu-id="968d3-1144">Handling Deadlocks</span></span>  

 <span data-ttu-id="968d3-1145">Quand une instance du [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] choisit une transaction comme victime d’un interblocage, elle met fin au lot en cours, annule la transaction, puis retourne le message d’erreur 1205 à l’application.</span><span class="sxs-lookup"><span data-stu-id="968d3-1145">When an instance of the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] chooses a transaction as a deadlock victim, it terminates the current batch, rolls back the transaction, and returns error message 1205 to the application.</span></span>  
  
 `Your transaction (process ID #52) was deadlocked on {lock | communication buffer | thread} resources with another process and has been chosen as the deadlock victim. Rerun your transaction.`  
  
 <span data-ttu-id="968d3-1146">Dans la mesure où toute application soumettant des requêtes [!INCLUDE[tsql](../includes/tsql-md.md)] peut être choisie comme victime de blocage, les applications doivent intégrer un gestionnaire d'erreurs capable d'intercepter le message d'erreur 1205.</span><span class="sxs-lookup"><span data-stu-id="968d3-1146">Because any application submitting [!INCLUDE[tsql](../includes/tsql-md.md)] queries can be chosen as the deadlock victim, applications should have an error handler that can trap error message 1205.</span></span> <span data-ttu-id="968d3-1147">Si une application n'intercepte pas cette erreur, elle peut continuer en ignorant que sa transaction a été annulée, et des erreurs peuvent se produire.</span><span class="sxs-lookup"><span data-stu-id="968d3-1147">If an application does not trap the error, the application can proceed unaware that its transaction has been rolled back and errors can occur.</span></span>  
  
 <span data-ttu-id="968d3-1148">L'implémentation d'un gestionnaire d'erreurs capable d'intercepter le message d'erreur 1205 permet à une application de gérer les situations de blocage et de réagir en conséquence, par exemple en re-soumettant automatiquement la requête impliquée dans le blocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-1148">Implementing an error handler that traps error message 1205 allows an application to handle the deadlock situation and take remedial action (for example, automatically resubmitting the query that was involved in the deadlock).</span></span> <span data-ttu-id="968d3-1149">Cette nouvelle soumission automatique rend la gestion du blocage entièrement transparente pour l'utilisateur.</span><span class="sxs-lookup"><span data-stu-id="968d3-1149">By resubmitting the query automatically, the user does not need to know that a deadlock occurred.</span></span>  
  
 <span data-ttu-id="968d3-1150">L'application doit marquer un bref temps d'arrêt avant de soumettre à nouveau la requête.</span><span class="sxs-lookup"><span data-stu-id="968d3-1150">The application should pause briefly before resubmitting its query.</span></span> <span data-ttu-id="968d3-1151">Cela permet à l'autre transaction impliquée dans le blocage d'aboutir et de libérer ses verrous qui faisaient partie du cycle de blocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-1151">This gives the other transaction involved in the deadlock a chance to complete and release its locks that formed part of the deadlock cycle.</span></span> <span data-ttu-id="968d3-1152">Les risques qu'un blocage se reproduise au moment où la requête de nouveau soumise demande ses verrous sont ainsi réduits.</span><span class="sxs-lookup"><span data-stu-id="968d3-1152">This minimizes the likelihood of the deadlock reoccurring when the resubmitted query requests its locks.</span></span>  
  
#### <a name="minimizing-deadlocks"></a><span data-ttu-id="968d3-1153">Réduction des blocages</span><span class="sxs-lookup"><span data-stu-id="968d3-1153">Minimizing Deadlocks</span></span>  

 <span data-ttu-id="968d3-1154">Même si les interblocages ne peuvent pas être totalement évités, le respect de certaines conventions de codage peut minimiser le risque d'en générer.</span><span class="sxs-lookup"><span data-stu-id="968d3-1154">Although deadlocks cannot be completely avoided, following certain coding conventions can minimize the chance of generating a deadlock.</span></span> <span data-ttu-id="968d3-1155">La réduction des blocages peut augmenter le débit des transactions et réduire la charge du système, car il y a moins de transactions :</span><span class="sxs-lookup"><span data-stu-id="968d3-1155">Minimizing deadlocks can increase transaction throughput and reduce system overhead because fewer transactions are:</span></span>  
  
-   <span data-ttu-id="968d3-1156">restaurées, en annulant ce qui a été accompli par la transaction ;</span><span class="sxs-lookup"><span data-stu-id="968d3-1156">Rolled back, undoing all the work performed by the transaction.</span></span>  
  
-   <span data-ttu-id="968d3-1157">resoumises par les applications, car ces transactions ont été restaurées lors du blocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-1157">Resubmitted by applications because they were rolled back when deadlocked.</span></span>  
  
 <span data-ttu-id="968d3-1158">Pour réduire le nombre de blocages :</span><span class="sxs-lookup"><span data-stu-id="968d3-1158">To help minimize deadlocks:</span></span>  
  
-   <span data-ttu-id="968d3-1159">Accédez aux objets dans le même ordre.</span><span class="sxs-lookup"><span data-stu-id="968d3-1159">Access objects in the same order.</span></span>  
  
-   <span data-ttu-id="968d3-1160">Évitez les interactions utilisateur dans les transactions.</span><span class="sxs-lookup"><span data-stu-id="968d3-1160">Avoid user interaction in transactions.</span></span>  
  
-   <span data-ttu-id="968d3-1161">Créez des transactions courtes dans le même traitement.</span><span class="sxs-lookup"><span data-stu-id="968d3-1161">Keep transactions short and in one batch.</span></span>  
  
-   <span data-ttu-id="968d3-1162">Utilisez un niveau d'isolement plus faible.</span><span class="sxs-lookup"><span data-stu-id="968d3-1162">Use a lower isolation level.</span></span>  
  
-   <span data-ttu-id="968d3-1163">Utilisez un niveau d'isolement basé sur le contrôle de version de ligne.</span><span class="sxs-lookup"><span data-stu-id="968d3-1163">Use a row versioning-based isolation level.</span></span>  
  
    -   <span data-ttu-id="968d3-1164">Affectez à l'option de base de données READ_COMMITTED_SNAPSHOT la valeur ON pour activer les transactions read-committed afin d'utiliser le contrôle de version de ligne.</span><span class="sxs-lookup"><span data-stu-id="968d3-1164">Set READ_COMMITTED_SNAPSHOT database option ON to enable read-committed transactions to use row versioning.</span></span>  
  
    -   <span data-ttu-id="968d3-1165">Utilisez un isolement d'instantané.</span><span class="sxs-lookup"><span data-stu-id="968d3-1165">Use snapshot isolation.</span></span>  
  
-   <span data-ttu-id="968d3-1166">Utilisez des connexions liées.</span><span class="sxs-lookup"><span data-stu-id="968d3-1166">Use bound connections.</span></span>  
  
##### <a name="access-objects-in-the-same-order"></a><span data-ttu-id="968d3-1167">Accès aux objets dans le même ordre</span><span class="sxs-lookup"><span data-stu-id="968d3-1167">Access Objects in the Same Order</span></span>  

 <span data-ttu-id="968d3-1168">Si toutes les transactions concurrentes accèdent aux objets dans le même ordre, le risque de blocage diminue.</span><span class="sxs-lookup"><span data-stu-id="968d3-1168">If all concurrent transactions access objects in the same order, deadlocks are less likely to occur.</span></span> <span data-ttu-id="968d3-1169">Par exemple, si deux transactions concurrentes obtiennent un verrou sur la table **Supplier**, puis sur la table **Part**, l’une des transactions est bloquée sur la table **Supplier** jusqu’à ce que l’autre transaction se termine.</span><span class="sxs-lookup"><span data-stu-id="968d3-1169">For example, if two concurrent transactions obtain a lock on the **Supplier** table and then on the **Part** table, one transaction is blocked on the **Supplier** table until the other transaction is completed.</span></span> <span data-ttu-id="968d3-1170">Après la validation ou la restauration de la première transaction, la seconde continue et aucun blocage ne se produit.</span><span class="sxs-lookup"><span data-stu-id="968d3-1170">After the first transaction commits or rolls back, the second continues, and a deadlock does not occur.</span></span> <span data-ttu-id="968d3-1171">L'utilisation de procédures stockées pour toutes les modifications de données peut standardiser l'ordre d'accès aux objets.</span><span class="sxs-lookup"><span data-stu-id="968d3-1171">Using stored procedures for all data modifications can standardize the order of accessing objects.</span></span>  
  
 <span data-ttu-id="968d3-1172">![Diagramme indiquant comment éviter l'utilisation du blocage](media/dedlck2.gif "Diagramme indiquant comment éviter l'utilisation du blocage")</span><span class="sxs-lookup"><span data-stu-id="968d3-1172">![Diagram showing deadlock avoidance](media/dedlck2.gif "Diagram showing deadlock avoidance")</span></span>  
  
##### <a name="avoid-user-interaction-in-transactions"></a><span data-ttu-id="968d3-1173">Aucune interaction utilisateur dans les transactions</span><span class="sxs-lookup"><span data-stu-id="968d3-1173">Avoid User Interaction in Transactions</span></span>  

 <span data-ttu-id="968d3-1174">Évitez d'écrire des transactions comprenant une interaction utilisateur, car la vitesse d'exécution des traitements sans intervention de l'utilisateur est beaucoup plus rapide que la vitesse à laquelle un utilisateur doit répondre manuellement aux requêtes telles que la demande d'un paramètre requis par une application.</span><span class="sxs-lookup"><span data-stu-id="968d3-1174">Avoid writing transactions that include user interaction, because the speed of batches running without user intervention is much faster than the speed at which a user must manually respond to queries, such as replying to a prompt for a parameter requested by an application.</span></span> <span data-ttu-id="968d3-1175">Par exemple, si une transaction attend une entrée de la part de l'utilisateur, et si ce dernier va déjeuner ou rentre chez lui pour le week-end, l'utilisateur empêche la transaction de se terminer.</span><span class="sxs-lookup"><span data-stu-id="968d3-1175">For example, if a transaction is waiting for user input and the user goes to lunch or even home for the weekend, the user delays the transaction from completing.</span></span> <span data-ttu-id="968d3-1176">Ceci dégrade les performances du système, car tous les verrous détenus par la transaction ne sont libérés qu'une fois la transaction validée ou restaurée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1176">This degrades system throughput because any locks held by the transaction are released only when the transaction is committed or rolled back.</span></span> <span data-ttu-id="968d3-1177">Même si une situation de blocage ne se produit pas, toutes les autres transactions en attente de la même ressource sont bloquées, en attente de la fin de la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1177">Even if a deadlock situation does not arise, other transactions accessing the same resources are blocked while waiting for the transaction to complete.</span></span>  
  
##### <a name="keep-transactions-short-and-in-one-batch"></a><span data-ttu-id="968d3-1178">Transactions courtes dans un seul traitement</span><span class="sxs-lookup"><span data-stu-id="968d3-1178">Keep Transactions Short and in One Batch</span></span>  

 <span data-ttu-id="968d3-1179">Un blocage se produit souvent lorsque plusieurs transactions longues sont exécutées de manière concurrente dans la même base de données.</span><span class="sxs-lookup"><span data-stu-id="968d3-1179">A deadlock typically occurs when several long-running transactions execute concurrently in the same database.</span></span> <span data-ttu-id="968d3-1180">Plus la transaction est longue, plus la durée de détention du verrou exclusif ou de mise à jour est importante, ce qui bloque les autres activités et peut entraîner une situation de blocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-1180">The longer the transaction, the longer the exclusive or update locks are held, blocking other activity and leading to possible deadlock situations.</span></span>  
  
 <span data-ttu-id="968d3-1181">La création de transactions courtes dans un seul traitement limite les allers-retours sur le réseau en réduisant les délais potentiels d'achèvement de la transaction et de suppression des verrous.</span><span class="sxs-lookup"><span data-stu-id="968d3-1181">Keeping transactions in one batch minimizes network roundtrips during a transaction, reducing possible delays in completing the transaction and releasing locks.</span></span>  
  
##### <a name="use-a-lower-isolation-level"></a><span data-ttu-id="968d3-1182">Niveau d'isolement faible</span><span class="sxs-lookup"><span data-stu-id="968d3-1182">Use a Lower Isolation Level</span></span>  

 <span data-ttu-id="968d3-1183">Déterminez si une transaction peut être exécutée à un niveau d'isolement faible.</span><span class="sxs-lookup"><span data-stu-id="968d3-1183">Determine whether a transaction can run at a lower isolation level.</span></span> <span data-ttu-id="968d3-1184">L'implémentation de la lecture validée (read committed) permet à une transaction de lire des données lues auparavant (non modifiées) par une autre transaction, sans attendre la fin de la première transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1184">Implementing read committed allows a transaction to read data previously read (not modified) by another transaction without waiting for the first transaction to complete.</span></span> <span data-ttu-id="968d3-1185">L'utilisation d'un niveau d'isolement faible (comme la lecture validée, par exemple) permet de conserver les verrous partagés pendant une durée inférieure à celle d'un niveau d'isolement supérieur (comme le niveau sérialisable)</span><span class="sxs-lookup"><span data-stu-id="968d3-1185">Using a lower isolation level, such as read committed, holds shared locks for a shorter duration than a higher isolation level, such as serializable.</span></span> <span data-ttu-id="968d3-1186">et réduit ainsi la contention de verrouillage.</span><span class="sxs-lookup"><span data-stu-id="968d3-1186">This reduces locking contention.</span></span>  
  
##### <a name="use-a-row-versioning-based-isolation-level"></a><span data-ttu-id="968d3-1187">Niveau d'isolement basé sur le contrôle de version de ligne</span><span class="sxs-lookup"><span data-stu-id="968d3-1187">Use a Row Versioning-based Isolation Level</span></span>  

 <span data-ttu-id="968d3-1188">Lorsque l'option de base de données READ_COMMITTED_SNAPSHOT a la valeur ON, une transaction qui s'exécute sous un niveau d'isolement read committed utilise le contrôle de version de ligne plutôt que les verrous partagés lors des opérations de lecture.</span><span class="sxs-lookup"><span data-stu-id="968d3-1188">When the READ_COMMITTED_SNAPSHOT database option is set ON, a transaction running under read committed isolation level uses row versioning rather than shared locks during read operations.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="968d3-1189">Certaines applications se basent sur le comportement de verrouillage et de blocage de l'isolement de lecture validée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1189">Some applications rely upon locking and blocking behavior of read committed isolation.</span></span> <span data-ttu-id="968d3-1190">Avec ces applications, certaines modifications sont nécessaires pour pouvoir activer cette option.</span><span class="sxs-lookup"><span data-stu-id="968d3-1190">For these applications, some change is required before this option can be enabled.</span></span>  
  
 <span data-ttu-id="968d3-1191">L'isolement d'instantané utilise également le contrôle de version de ligne, qui n'emploie pas de verrous partagés pendant les opérations de lecture.</span><span class="sxs-lookup"><span data-stu-id="968d3-1191">Snapshot isolation also uses row versioning, which does not use shared locks during read operations.</span></span> <span data-ttu-id="968d3-1192">Pour qu'une transaction puisse s'exécuter sous un isolement d'instantané, l'option de base de données ALLOW_SNAPSHOT_ISOLATION doit avoir la valeur ON.</span><span class="sxs-lookup"><span data-stu-id="968d3-1192">Before a transaction can run under snapshot isolation, the ALLOW_SNAPSHOT_ISOLATION database option must be set ON.</span></span>  
  
 <span data-ttu-id="968d3-1193">Implémentez ces niveaux d'isolement pour minimiser les blocages pouvant survenir entre les opérations de lecture et d'écriture.</span><span class="sxs-lookup"><span data-stu-id="968d3-1193">Implement these isolation levels to minimize deadlocks that can occur between read and write operations.</span></span>  
  
##### <a name="use-bound-connections"></a><span data-ttu-id="968d3-1194">Connexions liées</span><span class="sxs-lookup"><span data-stu-id="968d3-1194">Use Bound Connections</span></span>  

 <span data-ttu-id="968d3-1195">En utilisant des connexions liées, deux connexions ou plus ouvertes par la même application peuvent coopérer entre elles.</span><span class="sxs-lookup"><span data-stu-id="968d3-1195">Using bound connections, two or more connections opened by the same application can cooperate with each other.</span></span> <span data-ttu-id="968d3-1196">Tout verrou acquis par la connexion secondaire apparaît comme s'il avait été posé par la connexion primaire et vice-versa.</span><span class="sxs-lookup"><span data-stu-id="968d3-1196">Any locks acquired by the secondary connections are held as if they were acquired by the primary connection, and vice versa.</span></span> <span data-ttu-id="968d3-1197">Ils ne se bloquent donc pas réciproquement.</span><span class="sxs-lookup"><span data-stu-id="968d3-1197">Therefore they do not block each other.</span></span>  
  
### <a name="lock-partitioning"></a><span data-ttu-id="968d3-1198">Partitionnement de verrous</span><span class="sxs-lookup"><span data-stu-id="968d3-1198">Lock Partitioning</span></span>  

 <span data-ttu-id="968d3-1199">Pour les gros systèmes informatiques, des verrous sur des objets souvent référencés peuvent affaiblir les performances, car l'acquisition et la libération des verrous provoque une contention sur les ressources des verrous internes.</span><span class="sxs-lookup"><span data-stu-id="968d3-1199">For large computer systems, locks on frequently referenced objects can become a performance bottleneck as acquiring and releasing locks place contention on internal locking resources.</span></span> <span data-ttu-id="968d3-1200">Le partitionnement de verrous améliore les performances du verrouillage en fractionnant une ressource de verrou en plusieurs.</span><span class="sxs-lookup"><span data-stu-id="968d3-1200">Lock partitioning enhances locking performance by splitting a single lock resource into multiple lock resources.</span></span> <span data-ttu-id="968d3-1201">Cette fonctionnalité n'est disponible que pour les systèmes dotés d'au moins 16 UC ; elle est activée automatiquement et ne peut pas être désactivée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1201">This feature is only available for systems with 16 or more CPUs, and is automatically enabled and cannot be disabled.</span></span> <span data-ttu-id="968d3-1202">Seuls les verrous d'objets peuvent être partitionnés. Les verrous d'objets dotés d'un sous-type ne sont pas partitionnés.</span><span class="sxs-lookup"><span data-stu-id="968d3-1202">Only object locks can be partitioned.Object locks that have a subtype are not partitioned.</span></span> <span data-ttu-id="968d3-1203">Pour plus d’informations, consultez [sys.dm_tran_locks &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-locks-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="968d3-1203">For more information, see [sys.dm_tran_locks &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-locks-transact-sql).</span></span>  
  
#### <a name="understanding-lock-partitioning"></a><span data-ttu-id="968d3-1204">Présentation du partitionnement de verrous</span><span class="sxs-lookup"><span data-stu-id="968d3-1204">Understanding Lock Partitioning</span></span>  

 <span data-ttu-id="968d3-1205">Les opérations de verrouillage accèdent à plusieurs ressources partagées, dont deux sont optimisées par le partitionnement de verrous :</span><span class="sxs-lookup"><span data-stu-id="968d3-1205">Locking tasks access several shared resources, two of which are optimized by lock partitioning:</span></span>  
  
-   <span data-ttu-id="968d3-1206">**Verrouillage tournant**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1206">**Spinlock**.</span></span> <span data-ttu-id="968d3-1207">Contrôle l'accès à une ressource de verrou, par exemple une ligne ou une table.</span><span class="sxs-lookup"><span data-stu-id="968d3-1207">This controls access to a lock resource, such as a row or a table.</span></span>  
  
     <span data-ttu-id="968d3-1208">Sans partitionnement de verrous, un verrouillage spinlock gère toutes les demandes de verrouillage pour une seule ressource de verrou.</span><span class="sxs-lookup"><span data-stu-id="968d3-1208">Without lock partitioning, one spinlock manages all lock requests for a single lock resource.</span></span> <span data-ttu-id="968d3-1209">Sur des systèmes qui connaissent une activité intense, une contention peut se produire pendant que les demandes de verrouillage attendent que le verrouillage spinlock devienne disponible.</span><span class="sxs-lookup"><span data-stu-id="968d3-1209">On systems that experience a large volume of activity, contention can occur as lock requests wait for the spinlock to become available.</span></span> <span data-ttu-id="968d3-1210">Dans ce cas, l'acquisition de verrous peut causer un goulet d'étranglement et détériorer les performances.</span><span class="sxs-lookup"><span data-stu-id="968d3-1210">Under this situation, acquiring locks can become a bottleneck and can negatively impact performance.</span></span>  
  
     <span data-ttu-id="968d3-1211">Pour réduire la contention sur une ressource de verrou, le partitionnement de verrous fractionne une ressource de verrou en plusieurs ressources, afin de répartir la charge sur plusieurs verrouillages spinlock.</span><span class="sxs-lookup"><span data-stu-id="968d3-1211">To reduce contention on a single lock resource, lock partitioning splits a single lock resource into multiple lock resources to distribute the load across multiple spinlocks.</span></span>  
  
-   <span data-ttu-id="968d3-1212">**Mémoire**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1212">**Memory**.</span></span> <span data-ttu-id="968d3-1213">Permet de stocker les structures des ressources de verrous.</span><span class="sxs-lookup"><span data-stu-id="968d3-1213">This is used to store the lock resource structures.</span></span>  
  
     <span data-ttu-id="968d3-1214">Une fois le verrouillage spinlock acquis, les structures des verrous sont stockées dans la mémoire, puis utilisées et éventuellement modifiées.</span><span class="sxs-lookup"><span data-stu-id="968d3-1214">Once the spinlock is acquired, lock structures are stored in memory and then accessed and possibly modified.</span></span> <span data-ttu-id="968d3-1215">La répartition de l'accès aux verrous entre plusieurs ressources permet d'éliminer la nécessité de transférer des blocs de mémoire entre les UC, ce qui améliore les performances.</span><span class="sxs-lookup"><span data-stu-id="968d3-1215">Distributing lock access across multiple resources helps to eliminate the need to transfer memory blocks between CPUs, which will help to improve performance.</span></span>  
  
#### <a name="implementing-and-monitoring-lock-partitioning"></a><span data-ttu-id="968d3-1216">Mise en œuvre et surveillance du partitionnement de verrous</span><span class="sxs-lookup"><span data-stu-id="968d3-1216">Implementing and Monitoring Lock Partitioning</span></span>  

 <span data-ttu-id="968d3-1217">Le partitionnement de verrous est activé par défaut pour les systèmes comportant 16 UC ou plus.</span><span class="sxs-lookup"><span data-stu-id="968d3-1217">Lock partitioning is turned on by default for systems with 16 or more CPUs.</span></span> <span data-ttu-id="968d3-1218">Quand il est activé, un message d'informations est inscrit dans le journal des erreurs de [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="968d3-1218">When lock partitioning is enabled, an informational message is recorded in the [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] error log.</span></span>  
  
 <span data-ttu-id="968d3-1219">Lors de l'acquisition de verrous sur une ressource partitionnée :</span><span class="sxs-lookup"><span data-stu-id="968d3-1219">When acquiring locks on a partitioned resource:</span></span>  
  
-   <span data-ttu-id="968d3-1220">Seuls les modes de verrouillage NL, SCH-S, IS, IU et IX sont acquis sur une seule partition.</span><span class="sxs-lookup"><span data-stu-id="968d3-1220">Only NL, SCH-S, IS, IU, and IX lock modes are acquired on a single partition.</span></span>  
  
-   <span data-ttu-id="968d3-1221">Les verrous partagés (S), exclusifs (X) et autres dans les modes autres que NL, SCH-S, IS, IU et IX doivent être acquis sur toutes les partitions à partir de la partition ID 0, et ensuite dans l'ordre selon l'ID.</span><span class="sxs-lookup"><span data-stu-id="968d3-1221">Shared (S), exclusive (X), and other locks in modes other than NL, SCH-S, IS, IU, and IX must be acquired on all partitions starting with partition ID 0 and following in partition ID order.</span></span> <span data-ttu-id="968d3-1222">Ces verrous situés sur une ressource partitionnée utiliseront plus de mémoire que des verrous dans le même mode sur une ressource non partitionnée, puisque chaque partition constitue en fait un verrou distinct.</span><span class="sxs-lookup"><span data-stu-id="968d3-1222">These locks on a partitioned resource will use more memory than locks in the same mode on a non-partitioned resource since each partition is effectively a separate lock.</span></span> <span data-ttu-id="968d3-1223">La quantité de mémoire en plus est déterminée par le nombre de partitions.</span><span class="sxs-lookup"><span data-stu-id="968d3-1223">The memory increase is determined by the number of partitions.</span></span> <span data-ttu-id="968d3-1224">Les compteurs de verrous [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] de l'Analyseur de performances Windows affiche des informations sur la mémoire utilisée par les verrous partitionnés et non partitionnés.</span><span class="sxs-lookup"><span data-stu-id="968d3-1224">The [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] lock counters in the Windows Performance Monitor will display information about memory used by partitioned and non-partitioned locks.</span></span>  
  
 <span data-ttu-id="968d3-1225">Une transaction est affectée à une partition au début de la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1225">A transaction is assigned to a partition when the transaction starts.</span></span> <span data-ttu-id="968d3-1226">Pour la transaction, toutes les demandes de verrou qui peuvent être partitionnés utilisent la partition attribuée à cette transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1226">For the transaction, all lock requests that can be partitioned use the partition assigned to that transaction.</span></span> <span data-ttu-id="968d3-1227">Avec cette méthode, l'accès aux ressources de verrous du même objet par différentes transactions est réparti sur plusieurs partitions.</span><span class="sxs-lookup"><span data-stu-id="968d3-1227">By this method, access to lock resources of the same object by different transactions is distributed across different partitions.</span></span>  
  
 <span data-ttu-id="968d3-1228">La colonne resource_lock_partition de la vue de gestion dynamique sys.dm_tran_locks fournit l'ID de partition pour une ressource de verrou partitionnée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1228">The resource_lock_partition column in the sys.dm_tran_locks Dynamic Management View provides the lock partition ID for a lock partitioned resource.</span></span> <span data-ttu-id="968d3-1229">Pour plus d’informations, consultez [sys.dm_tran_locks &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-locks-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="968d3-1229">For more information, see [sys.dm_tran_locks &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-locks-transact-sql).</span></span>  
  
 <span data-ttu-id="968d3-1230">Sous l'événement Locks dans [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)], la colonne BigintData1 fournit l'ID de partition d'une ressource de verrou partitionnée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1230">Under the Locks event in [!INCLUDE[ssSqlProfiler](../includes/sssqlprofiler-md.md)], the BigintData1 column provides the lock partition ID for a lock partitioned resource.</span></span>  
  
#### <a name="working-with-lock-partitioning"></a><span data-ttu-id="968d3-1231">Utilisation du partitionnement de verrous</span><span class="sxs-lookup"><span data-stu-id="968d3-1231">Working with Lock Partitioning</span></span>  

 <span data-ttu-id="968d3-1232">Les exemples de code suivants illustrent le partitionnement de verrous :</span><span class="sxs-lookup"><span data-stu-id="968d3-1232">The following code examples illustrate lock partitioning.</span></span> <span data-ttu-id="968d3-1233">dans ces exemples, deux transactions sont exécutées dans deux sessions différentes pour montrer le comportement du partitionnement de verrous sur un système informatique doté de 16 UC.</span><span class="sxs-lookup"><span data-stu-id="968d3-1233">In the examples, two transactions are executed in two different sessions in order to show lock partitioning behavior on a computer system with 16 CPUs.</span></span>  
  
 <span data-ttu-id="968d3-1234">Ces instructions [!INCLUDE[tsql](../includes/tsql-md.md)] créent des objets de test logiques qui sont utilisés dans les exemples qui suivent.</span><span class="sxs-lookup"><span data-stu-id="968d3-1234">These [!INCLUDE[tsql](../includes/tsql-md.md)] statements create test objects that are used in the examples that follow.</span></span>  
  
```sql  
-- Create a test table.  
CREATE TABLE TestTable  
    (col1        int);  
GO  
  
-- Create a clustered index on the table.  
CREATE CLUSTERED INDEX ci_TestTable   
    ON TestTable (col1);  
GO  
  
-- Populate the table.  
INSERT INTO TestTable VALUES (1);  
GO  
```  
  
##### <a name="example-a"></a><span data-ttu-id="968d3-1235">Exemple A</span><span class="sxs-lookup"><span data-stu-id="968d3-1235">Example A</span></span>  

 <span data-ttu-id="968d3-1236">Session 1 :</span><span class="sxs-lookup"><span data-stu-id="968d3-1236">Session 1:</span></span>  
  
 <span data-ttu-id="968d3-1237">Une instruction `SELECT` est exécutée sous une transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1237">A `SELECT` statement is executed under a transaction.</span></span> <span data-ttu-id="968d3-1238">À cause de l'indicateur de verrou `HOLDLOCK`, cette instruction va acquérir et conserver un verrou IS (Intent Shared) sur la table (pour cette illustration, les verrous de ligne et de page sont ignorés).</span><span class="sxs-lookup"><span data-stu-id="968d3-1238">Because of the `HOLDLOCK` lock hint, this statement will acquire and retain an Intent shared (IS) lock on the table (for this illustration, row and page locks are ignored).</span></span> <span data-ttu-id="968d3-1239">Le verrou IS sera acquis uniquement sur la partition attribuée à la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1239">The IS lock will be acquired only on the partition assigned to the transaction.</span></span> <span data-ttu-id="968d3-1240">Pour cet exemple, il est supposé que le verrou IS est acquis sur l'ID de partition 7.</span><span class="sxs-lookup"><span data-stu-id="968d3-1240">For this example, it is assumed that the IS lock is acquired on partition ID 7.</span></span>  
  
```sql  
-- Start a transaction.  
BEGIN TRANSACTION  
    -- This SELECT statement will acquire an IS lock on the table.  
    SELECT col1  
        FROM TestTable  
        WITH (HOLDLOCK);  
```  
  
 <span data-ttu-id="968d3-1241">Session 2 :</span><span class="sxs-lookup"><span data-stu-id="968d3-1241">Session 2:</span></span>  
  
 <span data-ttu-id="968d3-1242">Une transaction a démarré et l'instruction `SELECT` qui s'exécute sous cette transaction va acquérir et conserver un verrou partagé (S) sur la table.</span><span class="sxs-lookup"><span data-stu-id="968d3-1242">A transaction is started, and the `SELECT` statement running under this transaction will acquire and retain a shared (S) lock on the table.</span></span> <span data-ttu-id="968d3-1243">Le verrou S sera acquis sur toutes les partitions, ce qui aboutit à plusieurs verrous de table, un pour chaque partition.</span><span class="sxs-lookup"><span data-stu-id="968d3-1243">The S lock will be acquired on all partitions which results in multiple table locks, one for each partition.</span></span> <span data-ttu-id="968d3-1244">Par exemple, sur un système à 16 UC, 16 verrous S seront créés sur les ID de partition de 0 à 15.</span><span class="sxs-lookup"><span data-stu-id="968d3-1244">For example, on a 16-cpu system, 16 S locks will be issued across lock partition IDs 0-15.</span></span> <span data-ttu-id="968d3-1245">Comme le verrou S est compatible avec le verrou IS qui se trouve sur la partition ID 7 du fait de la transaction de la session 1, il n'y a pas de blocages entre les transactions.</span><span class="sxs-lookup"><span data-stu-id="968d3-1245">Because the S lock is compatible with the IS lock being held on partition ID 7 by the transaction in session 1, there is no blocking between transactions.</span></span>  
  
```sql  
BEGIN TRANSACTION  
    SELECT col1  
        FROM TestTable  
        WITH (TABLOCK, HOLDLOCK);  
```  
  
 <span data-ttu-id="968d3-1246">Session 1 :</span><span class="sxs-lookup"><span data-stu-id="968d3-1246">Session 1:</span></span>  
  
 <span data-ttu-id="968d3-1247">L'instruction `SELECT` suivante est exécutée sous la transaction qui est encore active sous la session 1.</span><span class="sxs-lookup"><span data-stu-id="968d3-1247">The following `SELECT` statement is executed under the transaction that is still active under session 1.</span></span> <span data-ttu-id="968d3-1248">En raison de l'indicateur de verrou de table exclusif (X), la transaction va essayer d'acquérir un verrou exclusif X sur la table.</span><span class="sxs-lookup"><span data-stu-id="968d3-1248">Because of the exclusive (X) table lock hint, the transaction will attempt to acquire an X lock on the table.</span></span> <span data-ttu-id="968d3-1249">Toutefois, le verrou S qui est maintenu par la transaction de la session 2 bloquera le verrou X au niveau de la partition ID 0.</span><span class="sxs-lookup"><span data-stu-id="968d3-1249">However, the S lock that is being held by the transaction in session 2 will block the X lock at partition ID 0.</span></span>  
  
```sql  
SELECT col1  
    FROM TestTable  
    WITH (TABLOCKX);  
```  
  
##### <a name="example-b"></a><span data-ttu-id="968d3-1250">Exemple B</span><span class="sxs-lookup"><span data-stu-id="968d3-1250">Example B</span></span>  

 <span data-ttu-id="968d3-1251">Session 1 :</span><span class="sxs-lookup"><span data-stu-id="968d3-1251">Session 1:</span></span>  
  
 <span data-ttu-id="968d3-1252">Une instruction `SELECT` est exécutée sous une transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1252">A `SELECT` statement is executed under a transaction.</span></span> <span data-ttu-id="968d3-1253">À cause de l'indicateur de verrou `HOLDLOCK`, cette instruction va acquérir et conserver un verrou IS (Intent Shared) sur la table (pour cette illustration, les verrous de ligne et de page sont ignorés).</span><span class="sxs-lookup"><span data-stu-id="968d3-1253">Because of the `HOLDLOCK` lock hint, this statement will acquire and retain an Intent shared (IS) lock on the table (for this illustration, row and page locks are ignored).</span></span> <span data-ttu-id="968d3-1254">Le verrou IS sera acquis uniquement sur la partition attribuée à la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1254">The IS lock will be acquired only on the partition assigned to the transaction.</span></span> <span data-ttu-id="968d3-1255">Pour cet exemple, on suppose que le verrou IS est acquis sur la partition ID 6.</span><span class="sxs-lookup"><span data-stu-id="968d3-1255">For this example, it is assumed that the IS lock is acquired on partition ID 6.</span></span>  
  
```sql  
-- Start a transaction.  
BEGIN TRANSACTION  
    -- This SELECT statement will acquire an IS lock on the table.  
    SELECT col1  
        FROM TestTable  
        WITH (HOLDLOCK);  
```  
  
 <span data-ttu-id="968d3-1256">Session 2 :</span><span class="sxs-lookup"><span data-stu-id="968d3-1256">Session 2:</span></span>  
  
 <span data-ttu-id="968d3-1257">Une instruction `SELECT` est exécutée sous une transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1257">A `SELECT` statement is executed under a transaction.</span></span> <span data-ttu-id="968d3-1258">En raison de l'indicateur de verrou `TABLOCKX`, la transaction essaie d'acquérir un verrou exclusif (X) sur la table.</span><span class="sxs-lookup"><span data-stu-id="968d3-1258">Because of the `TABLOCKX` lock hint, the transaction tries to acquire an exclusive (X) lock on the table.</span></span> <span data-ttu-id="968d3-1259">Souvenez-vous que le verrou X doit être acquis sur toutes les partitions à partir de la partition ID 0.</span><span class="sxs-lookup"><span data-stu-id="968d3-1259">Remember that the X lock must be acquired on all partitions starting with partition ID 0.</span></span> <span data-ttu-id="968d3-1260">Le verrou X sera acquis sur toutes les partitions, de l'ID 0 à 5, mais il sera bloqué par le verrou IS acquis sur la partition ID 6.</span><span class="sxs-lookup"><span data-stu-id="968d3-1260">The X lock will be acquired on all partitions IDs 0-5 but will be blocked by the IS lock that is acquired on partition ID 6.</span></span>  
  
 <span data-ttu-id="968d3-1261">Sur les ID de partition de 7 à 15 que le verrou X n'a pas encore atteint, d'autres transactions peuvent continuer d'acquérir des verrous.</span><span class="sxs-lookup"><span data-stu-id="968d3-1261">On partition IDs 7-15 that the X lock has not yet reached, other transactions can continue to acquire locks.</span></span>  
  
```sql  
BEGIN TRANSACTION  
    SELECT col1  
        FROM TestTable  
        WITH (TABLOCKX, HOLDLOCK);  
```  
  
 <span data-ttu-id="968d3-1262">![Icône de flèche utilisée avec le lien retour au début](media/uparrow16x16.gif "Icône de flèche utilisée avec le lien Retour en haut") [dans ce guide](#Top)</span><span class="sxs-lookup"><span data-stu-id="968d3-1262">![Arrow icon used with Back to Top link](media/uparrow16x16.gif "Arrow icon used with Back to Top link") [In This Guide](#Top)</span></span>  
  
##  <a name="row-versioning-based-isolation-levels-in-the-database-engine"></a><a name="Row_versioning"></a><span data-ttu-id="968d3-1263">Niveaux d’isolement basés sur le contrôle de version de ligne dans le Moteur de base de données</span><span class="sxs-lookup"><span data-stu-id="968d3-1263">Row Versioning-based Isolation Levels in the Database Engine</span></span>  

 <span data-ttu-id="968d3-1264">À partir de SQL Server 2005, le moteur de base de données introduit une implémentation d'un niveau d'isolement de la transaction existant, read committed, qui fournit un instantané au niveau des instructions basé sur le contrôle de version de ligne.</span><span class="sxs-lookup"><span data-stu-id="968d3-1264">Starting with SQL Server 2005, the Database Engine offers an implementation of an existing transaction isolation level, read committed, that provides a statement level snapshot using row versioning.</span></span> <span data-ttu-id="968d3-1265">Le moteur de base de données SQL Server offre également un niveau d'isolement de la transaction, instantané, qui fournit un instantané au niveau des transactions basé sur le contrôle de version de ligne.</span><span class="sxs-lookup"><span data-stu-id="968d3-1265">SQL Server Database Engine also offers a transaction isolation level, snapshot, that provides a transaction level snapshot also using row versioning.</span></span>  
  
 <span data-ttu-id="968d3-1266">Le contrôle de version de ligne est une infrastructure générale de [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] qui appelle un mécanisme de copie sur écriture lorsqu'une ligne est modifiée ou supprimée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1266">Row versioning is a general framework in [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] that invokes a copy-on-write mechanism when a row is modified or deleted.</span></span> <span data-ttu-id="968d3-1267">Il exige que l'ancienne version de la ligne soit disponible pendant l'exécution de la transaction pour les transactions qui nécessitent un état antérieur cohérent d'un point de vue transactionnel.</span><span class="sxs-lookup"><span data-stu-id="968d3-1267">This requires that while the transaction is running, the old version of the row must be available for transactions that require an earlier transactionally consistent state.</span></span> <span data-ttu-id="968d3-1268">Le contrôle de version de ligne est utilisé pour la prise en charge des fonctionnalités suivantes :</span><span class="sxs-lookup"><span data-stu-id="968d3-1268">Row versioning is used to do the following:</span></span>  
  
-   <span data-ttu-id="968d3-1269">Génération des tables **insérées** et **supprimées** dans les déclencheurs.</span><span class="sxs-lookup"><span data-stu-id="968d3-1269">Build the **inserted** and **deleted** tables in triggers.</span></span> <span data-ttu-id="968d3-1270">Toutes les lignes modifiées par le déclencheur reçoivent une version,</span><span class="sxs-lookup"><span data-stu-id="968d3-1270">Any rows modified by the trigger are versioned.</span></span> <span data-ttu-id="968d3-1271">y compris celles modifiées par l'instruction qui a lancé le déclencheur, de même que toute modification de données effectuée par le déclencheur.</span><span class="sxs-lookup"><span data-stu-id="968d3-1271">This includes the rows modified by the statement that launched the trigger, as well as any data modifications made by the trigger.</span></span>  
  
-   <span data-ttu-id="968d3-1272">Prise en charge des ensembles de résultats actifs multiples (MARS, Multiple Active Result Sets).</span><span class="sxs-lookup"><span data-stu-id="968d3-1272">Support Multiple Active Result Sets (MARS).</span></span> <span data-ttu-id="968d3-1273">Si une session MARS publie une instruction de modification de données (par exemple, INSERT, UPDATE ou DELETE) à un moment où il y a un ensemble de résultats actif, les lignes concernées par l'instruction de modification sont avec version.</span><span class="sxs-lookup"><span data-stu-id="968d3-1273">If a MARS session issues a data modification statement (such as INSERT, UPDATE, or DELETE) at a time there is an active result set, the rows affected by the modification statement are versioned.</span></span>  
  
-   <span data-ttu-id="968d3-1274">Prise en charge des opérations d'index qui spécifient l'option ONLINE.</span><span class="sxs-lookup"><span data-stu-id="968d3-1274">Support index operations that specify the ONLINE option.</span></span>  
  
-   <span data-ttu-id="968d3-1275">Prise en charge des niveaux d'isolement des transactions basés sur le contrôle de version de ligne :</span><span class="sxs-lookup"><span data-stu-id="968d3-1275">Support row versioning-based transaction isolation levels:</span></span>  
  
    -   <span data-ttu-id="968d3-1276">Une nouvelle implémentation du niveau d'isolement read committed qui utilise le contrôle de version de ligne pour assurer la cohérence de la lecture au niveau de l'instruction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1276">A new implementation of read committed isolation level that uses row versioning to provide statement-level read consistency.</span></span>  
  
    -   <span data-ttu-id="968d3-1277">Un nouveau niveau d'isolement, l'instantané, pour assurer la cohérence de la lecture au niveau de la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1277">A new isolation level, snapshot, to provide transaction-level read consistency.</span></span>  
  
 <span data-ttu-id="968d3-1278">La base de données `tempdb` doit avoir suffisamment d’espace pour contenir la banque des versions.</span><span class="sxs-lookup"><span data-stu-id="968d3-1278">The `tempdb` database must have enough space for the version store.</span></span> <span data-ttu-id="968d3-1279">Quand la base de données `tempdb` est pleine, les opérations de mise à jour ne génèrent plus de versions et continuent d’aboutir, mais les opérations de lecture risquent d’échouer en raison de l’absence d’une version de ligne particulière requise.</span><span class="sxs-lookup"><span data-stu-id="968d3-1279">When `tempdb` is full, update operations will stop generating versions and continue to succeed, but read operations might fail because a particular row version that is needed no longer exists.</span></span> <span data-ttu-id="968d3-1280">Ceci a des conséquences sur les opérations comme les déclencheurs, MARS et l'indexation en ligne.</span><span class="sxs-lookup"><span data-stu-id="968d3-1280">This affects operations like triggers, MARS, and online indexing.</span></span>  
  
 <span data-ttu-id="968d3-1281">L'utilisation du contrôle de version de ligne pour les transactions read committed et les transactions d'instantanés se fait en deux étapes :</span><span class="sxs-lookup"><span data-stu-id="968d3-1281">Using row versioning for read-committed and snapshot transactions is a two-step process:</span></span>  
  
1.  <span data-ttu-id="968d3-1282">Activez (ON) l'option de base de données READ_COMMITTED_SNAPSHOT et/ou l'option ALLOW_SNAPSHOT_ISOLATION.</span><span class="sxs-lookup"><span data-stu-id="968d3-1282">Set either or both the READ_COMMITTED_SNAPSHOT and ALLOW_SNAPSHOT_ISOLATION database options ON.</span></span>  
  
2.  <span data-ttu-id="968d3-1283">Définissez le niveau d'isolement des transactions approprié dans une application :</span><span class="sxs-lookup"><span data-stu-id="968d3-1283">Set the appropriate transaction isolation level in an application:</span></span>  
  
    -   <span data-ttu-id="968d3-1284">Lorsque l'option READ_COMMITTED_SNAPSHOT est activée (ON), les transactions qui définissent le niveau d'isolement read committed utilisent le contrôle de version de ligne.</span><span class="sxs-lookup"><span data-stu-id="968d3-1284">When the READ_COMMITTED_SNAPSHOT database option is ON, transactions setting the read committed isolation level use row versioning.</span></span>  
  
    -   <span data-ttu-id="968d3-1285">Lorsque l'option de base de données ALLOW_SNAPSHOT_ISOLATION est activée (ON), les transactions peuvent définir le niveau d'isolement d'instantané.</span><span class="sxs-lookup"><span data-stu-id="968d3-1285">When the ALLOW_SNAPSHOT_ISOLATION database option is ON, transactions can set the snapshot isolation level.</span></span>  
  
 <span data-ttu-id="968d3-1286">Lorsque l'option de base de données READ_COMMITTED_SNAPSHOT ou ALLOW_SNAPSHOT_ISOLATION est activée, le [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] affecte un numéro de séquence de transaction (XSN) à chaque transaction qui manipule des données à l'aide du contrôle de version de ligne.</span><span class="sxs-lookup"><span data-stu-id="968d3-1286">When either READ_COMMITTED_SNAPSHOT or ALLOW_SNAPSHOT_ISOLATION database option is set ON, the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] assigns a transaction sequence number (XSN) to each transaction that manipulates data using row versioning.</span></span> <span data-ttu-id="968d3-1287">Les transactions démarrent au moment où une instruction BEGIN TRANSACTION est exécutée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1287">Transactions start at the time a BEGIN TRANSACTION statement is executed.</span></span> <span data-ttu-id="968d3-1288">En revanche, le numéro de séquence de la transaction commence à la première opération de lecture ou d'écriture suivant l'instruction BEGIN TRANSACTION.</span><span class="sxs-lookup"><span data-stu-id="968d3-1288">However, the transaction sequence number starts with the first read or write operation after the BEGIN TRANSACTION statement.</span></span> <span data-ttu-id="968d3-1289">Ce numéro augmente de 1 à chaque fois qu'il est attribué.</span><span class="sxs-lookup"><span data-stu-id="968d3-1289">The transaction sequence number is incremented by one each time it is assigned.</span></span>  
  
 <span data-ttu-id="968d3-1290">Lorsqu'une seule des deux options de base de données (READ_COMMITTED_SNAPSHOT et ALLOW_SNAPSHOT_ISOLATION) est activée, des copies logiques (versions) sont maintenues pour toutes les modifications de données effectuées dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="968d3-1290">When either the READ_COMMITTED_SNAPSHOT or ALLOW_SNAPSHOT_ISOLATION database options are ON, logical copies (versions) are maintained for all data modifications performed in the database.</span></span> <span data-ttu-id="968d3-1291">Chaque fois qu’une ligne est modifiée par une transaction, l’instance du [!INCLUDE[ssDE](../includes/ssde-md.md)] enregistre une version de l’image précédemment validée de la ligne dans `tempdb`.</span><span class="sxs-lookup"><span data-stu-id="968d3-1291">Every time a row is modified by a specific transaction, the instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] stores a version of the previously committed image of the row in `tempdb`.</span></span> <span data-ttu-id="968d3-1292">Chaque version porte le numéro de séquence de la transaction responsable de la modification.</span><span class="sxs-lookup"><span data-stu-id="968d3-1292">Each version is marked with the transaction sequence number of the transaction that made the change.</span></span> <span data-ttu-id="968d3-1293">Les versions des lignes modifiées sont enchaînées au moyen d'une liste de liens.</span><span class="sxs-lookup"><span data-stu-id="968d3-1293">The versions of modified rows are chained using a link list.</span></span> <span data-ttu-id="968d3-1294">La valeur de ligne la plus récente est toujours stockée dans la base de données active et enchaînée aux lignes avec contrôle de version stockées dans `tempdb`.</span><span class="sxs-lookup"><span data-stu-id="968d3-1294">The newest row value is always stored in the current database and chained to the versioned rows stored in `tempdb`.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="968d3-1295">Dans le cas de la modification d’objets LOB, seul le fragment modifié est copié dans la banque des versions dans `tempdb`.</span><span class="sxs-lookup"><span data-stu-id="968d3-1295">For modification of large objects (LOBs), only the changed fragment is copied to the version store in `tempdb`.</span></span>  
  
 <span data-ttu-id="968d3-1296">Les versions de lignes sont conservées suffisamment longtemps pour satisfaire aux besoins des transactions qui s'exécutent sous le régime d'isolement « contrôle de version de ligne ».</span><span class="sxs-lookup"><span data-stu-id="968d3-1296">Row versions are held long enough to satisfy the requirements of transactions running under row versioning-based isolation levels.</span></span> <span data-ttu-id="968d3-1297">Le [!INCLUDE[ssDE](../includes/ssde-md.md)] recherche le plus ancien numéro de séquence de transaction et supprime de façon périodique toutes les versions de lignes dont le numéro de séquence de transaction est inférieur à celui-ci.</span><span class="sxs-lookup"><span data-stu-id="968d3-1297">The [!INCLUDE[ssDE](../includes/ssde-md.md)] tracks the earliest useful transaction sequence number and periodically deletes all row versions stamped with transaction sequence numbers that are lower than the earliest useful sequence number.</span></span>  
  
 <span data-ttu-id="968d3-1298">Lorsque les deux options de base de données sont désactivées, seules les lignes modifiées par des déclencheurs ou des sessions MARS, ou lues par des opérations d'index ONLINE, sont avec version.</span><span class="sxs-lookup"><span data-stu-id="968d3-1298">When both database options are set to OFF, only rows modified by triggers or MARS sessions, or read by ONLINE index operations, are versioned.</span></span> <span data-ttu-id="968d3-1299">Ces versions de lignes sont libérées lorsqu'elles ne sont plus nécessaires.</span><span class="sxs-lookup"><span data-stu-id="968d3-1299">Those row versions are released when no longer needed.</span></span> <span data-ttu-id="968d3-1300">Un thread d'arrière-plan supprime périodiquement les versions de lignes dépassées.</span><span class="sxs-lookup"><span data-stu-id="968d3-1300">A background thread periodically executes to remove stale row versions.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="968d3-1301">Pour les transactions de courte durée, il arrive qu’une version d’une ligne modifiée soit mise en cache dans le pool de mémoires tampons sans être écrite dans les fichiers de la base de données `tempdb` sur le disque.</span><span class="sxs-lookup"><span data-stu-id="968d3-1301">For short-running transactions, a version of a modified row may get cached in the buffer pool without getting written into the disk files of the `tempdb` database.</span></span> <span data-ttu-id="968d3-1302">Si cette ligne avec version n'est plus nécessaire, elle est simplement supprimée du pool de mémoires tampons, ce qui lui évite de générer du trafic E/S.</span><span class="sxs-lookup"><span data-stu-id="968d3-1302">If the need for the versioned row is short-lived, it will simply get dropped from the buffer pool and may not necessarily incur I/O overhead.</span></span>  
  
### <a name="behavior-when-reading-data"></a><span data-ttu-id="968d3-1303">Comportement lors de la lecture de données</span><span class="sxs-lookup"><span data-stu-id="968d3-1303">Behavior When Reading Data</span></span>  

 <span data-ttu-id="968d3-1304">Lorsque des transactions s'exécutant sous le régime d'isolement « contrôle de version de ligne », les opérations de lecture n'acquièrent pas de verrous partagés sur les données lues, et par conséquent ne bloquent pas les transactions qui modifient des données.</span><span class="sxs-lookup"><span data-stu-id="968d3-1304">When transactions running under row versioning-based isolation read data, the read operations do not acquire shared (S) locks on the data being read, and therefore do not block transactions that are modifying data.</span></span> <span data-ttu-id="968d3-1305">De plus, la charge liée au verrouillage des ressources est minimisée en raison de la réduction du nombre de verrous acquis.</span><span class="sxs-lookup"><span data-stu-id="968d3-1305">Also, the overhead of locking resources is minimized as the number of locks acquired is reduced.</span></span> <span data-ttu-id="968d3-1306">L'isolement read committed avec contrôle de version de ligne et l'isolement d'instantané sont conçus pour garantir la cohérence des données avec version au niveau de l'instruction ou de la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1306">Read committed isolation using row versioning and snapshot isolation are designed to provide statement-level or transaction-level read consistencies of versioned data.</span></span>  
  
 <span data-ttu-id="968d3-1307">Toutes les requêtes, y compris les transactions qui s'exécutent sous les niveaux d'isolement basés sur le contrôle de version de ligne, acquièrent des verrous de stabilité du schéma (Sch-S) au cours de la compilation et de l'exécution.</span><span class="sxs-lookup"><span data-stu-id="968d3-1307">All queries, including transactions running under row versioning-based isolation levels, acquire Sch-S (schema stability) locks during compilation and execution.</span></span> <span data-ttu-id="968d3-1308">Par conséquent, les requêtes sont bloquées lorsqu'une transaction simultanée détient un verrou de modification du schéma (Sch-M) sur la table.</span><span class="sxs-lookup"><span data-stu-id="968d3-1308">Because of this, queries are blocked when a concurrent transaction holds a Sch-M (schema modification) lock on the table.</span></span> <span data-ttu-id="968d3-1309">Par exemple, une opération DDL (Data Definition Language) acquiert un verrou Sch-M avant de modifier les informations de schéma de la table.</span><span class="sxs-lookup"><span data-stu-id="968d3-1309">For example, a data definition language (DDL) operation acquires a Sch-M lock before it modifies the schema information of the table.</span></span> <span data-ttu-id="968d3-1310">Les transactions de type requête, y compris celles qui s'exécutent sous un niveau d'isolement basé sur le contrôle de version de ligne, sont bloquées lors d'une tentative visant à acquérir un verrou Sch-S.</span><span class="sxs-lookup"><span data-stu-id="968d3-1310">Query transactions, including those running under a row versioning-based isolation level, are blocked when attempting to acquire a Sch-S lock.</span></span> <span data-ttu-id="968d3-1311">Inversement, une requête qui détient un verrou Sch-S bloque une transaction simultanée qui tente d'acquérir un verrou Sch-M.</span><span class="sxs-lookup"><span data-stu-id="968d3-1311">Conversely, a query holding a Sch-S lock blocks a concurrent transaction that attempts to acquire a Sch-M lock.</span></span>  
  
 <span data-ttu-id="968d3-1312">Lorsqu'une transaction avec niveau d'isolement d'instantané est lancée, l'instance de [!INCLUDE[ssDE](../includes/ssde-md.md)] enregistre toutes les transactions en cours.</span><span class="sxs-lookup"><span data-stu-id="968d3-1312">When a transaction using the snapshot isolation level starts, the instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)] records all of the currently active transactions.</span></span> <span data-ttu-id="968d3-1313">Lorsque la transaction lit une ligne qui a une chaîne de versions, le [!INCLUDE[ssDE](../includes/ssde-md.md)] remonte la chaîne et récupère la ligne dont le numéro de séquence de transaction :</span><span class="sxs-lookup"><span data-stu-id="968d3-1313">When the snapshot transaction reads a row that has a version chain, the [!INCLUDE[ssDE](../includes/ssde-md.md)] follows the chain and retrieves the row where the transaction sequence number is:</span></span>  
  
-   <span data-ttu-id="968d3-1314">se rapproche le plus, sans le dépasser, du numéro de séquence de la transaction qui lit la ligne ;</span><span class="sxs-lookup"><span data-stu-id="968d3-1314">Closest to but lower than the sequence number of the snapshot transaction reading the row.</span></span>  
  
-   <span data-ttu-id="968d3-1315">ne figure pas dans la liste de transactions actives au moment de la création de la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1315">Not in the list of the transactions active when the snapshot transaction started.</span></span>  
  
 <span data-ttu-id="968d3-1316">Les opérations de lecture effectuées par une transaction d'instantané récupèrent la dernière version de chaque ligne validée au début de la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1316">Read operations performed by a snapshot transaction retrieve the last version of each row that had been committed at the time the snapshot transaction started.</span></span> <span data-ttu-id="968d3-1317">Ceci permet de disposer d'un instantané cohérent de manière transactionnelle des données présentes au début de la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1317">This provides a transactionally consistent snapshot of the data as it existed at the start of the transaction.</span></span>  
  
 <span data-ttu-id="968d3-1318">Les transactions « read committed » avec contrôle de version de ligne fonctionnement pratiquement de la même manière.</span><span class="sxs-lookup"><span data-stu-id="968d3-1318">Read-committed transactions using row versioning operate in much the same way.</span></span> <span data-ttu-id="968d3-1319">La différence est que ces transactions n'utilisent pas leurs propres numéros de séquence lors du choix des versions de lignes.</span><span class="sxs-lookup"><span data-stu-id="968d3-1319">The difference is that the read-committed transaction does not use its own transaction sequence number when choosing row versions.</span></span> <span data-ttu-id="968d3-1320">Chaque fois qu'une instruction est lancée, la transaction lit le dernier numéro de séquence émis pour cette instance du [!INCLUDE[ssDE](../includes/ssde-md.md)].</span><span class="sxs-lookup"><span data-stu-id="968d3-1320">Each time a statement is started, the read-committed transaction reads the latest transaction sequence number issued for that instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)].</span></span> <span data-ttu-id="968d3-1321">C'est ce numéro qui servira à sélectionner les bonnes versions de lignes pour cette instruction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1321">This is the transaction sequence number used to select the correct row versions for that statement.</span></span> <span data-ttu-id="968d3-1322">Ceci permet aux transactions read committed de voir un instantané des données telles qu'elles existaient au début de chaque instruction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1322">This allows read-committed transactions to see a snapshot of the data as it exists at the start of each statement.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="968d3-1323">Même si les transactions read commited utilisant le contrôle de version de ligne fournissent une vue cohérente d'un point de vue transactionnel des données au niveau d'une instruction, les versions de ligne générées ou accédées par ce type de transaction sont conservées jusqu'à la fin de la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1323">Even though read-committed transactions using row versioning provides a transactionally consistent view of the data at a statement level, row versions generated or accessed by this type of transaction are maintained until the transaction completes.</span></span>  
  
### <a name="behavior-when-modifying-data"></a><span data-ttu-id="968d3-1324">Comportement lors de la modification de données</span><span class="sxs-lookup"><span data-stu-id="968d3-1324">Behavior When Modifying Data</span></span>  

 <span data-ttu-id="968d3-1325">Dans une transaction read committed avec contrôle de version de ligne, le choix des lignes à mettre à jour se fait au moyen d'une analyse bloquante. Au cours de celle-ci, un verrou de mise à jour (U) est acquis sur la ligne de données au fur et à mesure que les valeurs de données sont lues.</span><span class="sxs-lookup"><span data-stu-id="968d3-1325">In a read-committed transaction using row versioning, the selection of rows to update is done using a blocking scan where an update (U) lock is taken on the data row as data values are read.</span></span> <span data-ttu-id="968d3-1326">La même chose se produit avec une transaction read committed qui n'utilise pas le contrôle de version de ligne.</span><span class="sxs-lookup"><span data-stu-id="968d3-1326">This is the same as a read-committed transaction that does not use row versioning.</span></span> <span data-ttu-id="968d3-1327">Si la ligne de données ne répond pas aux critères de mise à jour, le verrou de mise à jour est déplacé sur la ligne suivante, qui est analysée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1327">If the data row does not meet the update criteria, the update lock is released on that row and the next row is locked and scanned.</span></span>  
  
 <span data-ttu-id="968d3-1328">Les transactions s'exécutant avec isolement d'instantané adoptent une approche optimiste en matière de modification de données car elles ne verrouillent les lignes que lorsque les données qui s'y trouvent doivent être modifiées.</span><span class="sxs-lookup"><span data-stu-id="968d3-1328">Transactions running under snapshot isolation take an optimistic approach to data modification by acquiring locks on data before performing the modification only to enforce constraints.</span></span> <span data-ttu-id="968d3-1329">Sinon, les verrous ne sont pas placés sur les données tant que celles-ci doivent être modifiées.</span><span class="sxs-lookup"><span data-stu-id="968d3-1329">Otherwise, locks are not acquired on data until the data is to be modified.</span></span> <span data-ttu-id="968d3-1330">Lorsqu'une ligne de données répond aux critères de mise à jour, la transaction vérifie que la ligne n'a pas été modifiée par une transaction concomitante validée après elle.</span><span class="sxs-lookup"><span data-stu-id="968d3-1330">When a data row meets the update criteria, the snapshot transaction verifies that the data row has not been modified by a concurrent transaction that committed after the snapshot transaction began.</span></span> <span data-ttu-id="968d3-1331">Si la ligne de données a été modifiée en dehors de la transaction, un conflit de mise à jour se produit et la transaction est arrêtée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1331">If the data row has been modified outside of the snapshot transaction, an update conflict occurs and the snapshot transaction is terminated.</span></span> <span data-ttu-id="968d3-1332">Le conflit de mise à jour est géré par le [!INCLUDE[ssDE](../includes/ssde-md.md)]. Il n'y a aucun moyen de désactiver la détection des conflits de mise à jour.</span><span class="sxs-lookup"><span data-stu-id="968d3-1332">The update conflict is handled by the [!INCLUDE[ssDE](../includes/ssde-md.md)] and there is no way to disable the update conflict detection.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="968d3-1333">Les opérations de mise à jour s'exécutant avec isolement d'instantané s'exécutent en interne sous le régime d'isolement read committed lorsque la transaction accède à un des éléments suivants :</span><span class="sxs-lookup"><span data-stu-id="968d3-1333">Update operations running under snapshot isolation internally execute under read committed isolation when the snapshot transaction accesses any of the following:</span></span>  
>   
>  <span data-ttu-id="968d3-1334">une table avec contrainte FOREIGN KEY ;</span><span class="sxs-lookup"><span data-stu-id="968d3-1334">A table with a FOREIGN KEY constraint.</span></span>  
>   
>  <span data-ttu-id="968d3-1335">une table à laquelle la contrainte FOREIGN KEY d'une autre table fait référence ;</span><span class="sxs-lookup"><span data-stu-id="968d3-1335">A table that is referenced in the FOREIGN KEY constraint of another table.</span></span>  
>   
>  <span data-ttu-id="968d3-1336">une vue indexée faisant référence à plusieurs tables.</span><span class="sxs-lookup"><span data-stu-id="968d3-1336">An indexed view referencing more than one table.</span></span>  
>   
>  <span data-ttu-id="968d3-1337">Cependant, même sous ces conditions, l'opération de mise à jour continue à vérifier que les données n'ont pas été modifiées par une autre transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1337">However, even under these conditions the update operation will continue to verify that the data has not been modified by another transaction.</span></span> <span data-ttu-id="968d3-1338">Si c'est le cas, il y a conflit de mise à jour et la transaction est arrêtée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1338">If data has been modified by another transaction, the snapshot transaction encounters an update conflict and is terminated.</span></span>  
  
### <a name="behavior-in-summary"></a><span data-ttu-id="968d3-1339">Synthèse des comportements</span><span class="sxs-lookup"><span data-stu-id="968d3-1339">Behavior in Summary</span></span>  

 <span data-ttu-id="968d3-1340">Le tableau suivant synthétise les différences entre l'isolement d'instantané et l'isolement read committed avec contrôle de version de ligne :</span><span class="sxs-lookup"><span data-stu-id="968d3-1340">The following table summarizes the differences between snapshot isolation and read committed isolation using row versioning.</span></span>  
  
|<span data-ttu-id="968d3-1341">Propriété</span><span class="sxs-lookup"><span data-stu-id="968d3-1341">Property</span></span>|<span data-ttu-id="968d3-1342">Niveau d'isolement READ COMMITED utilisant le contrôle de version de ligne</span><span class="sxs-lookup"><span data-stu-id="968d3-1342">Read-committed isolation level using row versioning</span></span>|<span data-ttu-id="968d3-1343">Niveau d'isolement d'instantané</span><span class="sxs-lookup"><span data-stu-id="968d3-1343">Snapshot isolation level</span></span>|  
|--------------|----------------------------------------------------------|------------------------------|  
|<span data-ttu-id="968d3-1344">L'option de base de données doit être activée (ON) pour assurer la prise en charge nécessaire.</span><span class="sxs-lookup"><span data-stu-id="968d3-1344">The database option that must be set to ON to enable the required support.</span></span>|<span data-ttu-id="968d3-1345">READ_COMMITTED_SNAPSHOT</span><span class="sxs-lookup"><span data-stu-id="968d3-1345">READ_COMMITTED_SNAPSHOT</span></span>|<span data-ttu-id="968d3-1346">ALLOW_SNAPSHOT_ISOLATION</span><span class="sxs-lookup"><span data-stu-id="968d3-1346">ALLOW_SNAPSHOT_ISOLATION</span></span>|  
|<span data-ttu-id="968d3-1347">Manière dont une session demande le type spécifique de contrôle de version de ligne.</span><span class="sxs-lookup"><span data-stu-id="968d3-1347">How a session requests the specific type of row versioning.</span></span>|<span data-ttu-id="968d3-1348">Utilisez le niveau d'isolement par défaut (read-committed) ou exécutez l'instruction SET TRANSACTION ISOLATION LEVEL pour spécifier le niveau d'isolement READ COMMITTED.</span><span class="sxs-lookup"><span data-stu-id="968d3-1348">Use the default read-committed isolation level, or run the SET TRANSACTION ISOLATION LEVEL statement to specify the READ COMMITTED isolation level.</span></span> <span data-ttu-id="968d3-1349">Ceci peut se faire après le début de la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1349">This can be done after the transaction starts.</span></span>|<span data-ttu-id="968d3-1350">Requiert l'exécution de l'instruction SET TRANSACTION ISOLATION LEVEL pour spécifier le niveau d'isolement SNAPSHOT avant le début de la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1350">Requires the execution of SET TRANSACTION ISOLATION LEVEL to specify the SNAPSHOT isolation level before the start of the transaction.</span></span>|  
|<span data-ttu-id="968d3-1351">La version des données lue par les instructions.</span><span class="sxs-lookup"><span data-stu-id="968d3-1351">The version of data read by statements.</span></span>|<span data-ttu-id="968d3-1352">Toutes les données qui ont été validées avant le début de chaque instruction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1352">All data that was committed before the start of each statement.</span></span>|<span data-ttu-id="968d3-1353">Toutes les données qui ont été validées avant le début de chaque transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1353">All data that was committed before the start of each transaction.</span></span>|  
|<span data-ttu-id="968d3-1354">Manière dont les mises à jour sont gérées.</span><span class="sxs-lookup"><span data-stu-id="968d3-1354">How updates are handled.</span></span>|<span data-ttu-id="968d3-1355">Passe des versions de lignes aux données réelles pour sélectionner les lignes à mettre à jour et utilise des verrous de mise à jour sur les lignes sélectionnées.</span><span class="sxs-lookup"><span data-stu-id="968d3-1355">Reverts from row versions to actual data to select rows to update and uses update locks on the data rows selected.</span></span> <span data-ttu-id="968d3-1356">Acquiert des verrous exclusifs sur les lignes à modifier réellement.</span><span class="sxs-lookup"><span data-stu-id="968d3-1356">Acquires exclusive locks on actual data rows to be modified.</span></span> <span data-ttu-id="968d3-1357">Pas de détection de conflit de mise à jour.</span><span class="sxs-lookup"><span data-stu-id="968d3-1357">No update conflict detection.</span></span>|<span data-ttu-id="968d3-1358">Utilise les versions de lignes pour sélectionner les lignes à mettre à jour.</span><span class="sxs-lookup"><span data-stu-id="968d3-1358">Uses row versions to select rows to update.</span></span> <span data-ttu-id="968d3-1359">Essaie d'acquérir un verrou exclusif sur les lignes à modifier réellement et, si les données ont été modifiées par une autre transaction, génère un conflit de mise à jour qui entraîne l'arrêt de la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1359">Tries to acquire an exclusive lock on the actual data row to be modified, and if the data has been modified by another transaction, an update conflict occurs and the snapshot transaction is terminated.</span></span>|  
|<span data-ttu-id="968d3-1360">Détection d'un conflit de mise à jour.</span><span class="sxs-lookup"><span data-stu-id="968d3-1360">Update conflict detection.</span></span>|<span data-ttu-id="968d3-1361">Aucun.</span><span class="sxs-lookup"><span data-stu-id="968d3-1361">None.</span></span>|<span data-ttu-id="968d3-1362">Prise en charge intégrée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1362">Integrated support.</span></span> <span data-ttu-id="968d3-1363">Ne peut être désactivée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1363">Cannot be disabled.</span></span>|  
  
### <a name="row-versioning-resource-usage"></a><span data-ttu-id="968d3-1364">Utilisation de la ressource de contrôle de version de ligne</span><span class="sxs-lookup"><span data-stu-id="968d3-1364">Row Versioning Resource Usage</span></span>  

 <span data-ttu-id="968d3-1365">L'infrastructure de contrôle de version de ligne prend en charge les fonctionnalités suivantes dans [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] :</span><span class="sxs-lookup"><span data-stu-id="968d3-1365">The row versioning framework supports the following features available in [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)]:</span></span>  
  
-   <span data-ttu-id="968d3-1366">Déclencheurs</span><span class="sxs-lookup"><span data-stu-id="968d3-1366">Triggers</span></span>  
  
-   <span data-ttu-id="968d3-1367">MARS (Multiple Active Results Sets)</span><span class="sxs-lookup"><span data-stu-id="968d3-1367">Multiple Active Results Sets (MARS)</span></span>  
  
-   <span data-ttu-id="968d3-1368">Indexation en ligne</span><span class="sxs-lookup"><span data-stu-id="968d3-1368">Online indexing</span></span>  
  
 <span data-ttu-id="968d3-1369">La structure de contrôle de version de ligne prend également en charge les niveaux d'isolement des transactions basé sur le contrôle de version de ligne, qui sont désactivés par défaut :</span><span class="sxs-lookup"><span data-stu-id="968d3-1369">The row versioning framework also supports the following row versioning-based transaction isolation levels, which by default are not enabled:</span></span>  
  
-   <span data-ttu-id="968d3-1370">Lorsque l'option de base de données READ_COMMITTED_SNAPSHOT est activée (ON), les transactions READ_COMMITTED permettent une lecture cohérente au niveau des instructions grâce au contrôle de version de ligne.</span><span class="sxs-lookup"><span data-stu-id="968d3-1370">When the READ_COMMITTED_SNAPSHOT database option is ON, READ_COMMITTED transactions provide statement-level read consistency using row versioning.</span></span>  
  
-   <span data-ttu-id="968d3-1371">Lorsque l'option de base de données ALLOW_SNAPSHOT_ISOLATION est activée (ON), les transactions SNAPSHOT permettent une lecture cohérente au niveau des transactions grâce au contrôle de version de ligne.</span><span class="sxs-lookup"><span data-stu-id="968d3-1371">When the ALLOW_SNAPSHOT_ISOLATION database option is ON, SNAPSHOT transactions provide transaction-level read consistency using row versioning.</span></span>  
  
 <span data-ttu-id="968d3-1372">Les niveaux d'isolement basé sur le contrôle de version de ligne réduisent le nombre de verrous obtenus par la transaction en supprimant l'utilisation des verrous partagés dans les opérations de lecture.</span><span class="sxs-lookup"><span data-stu-id="968d3-1372">Row versioning-based isolation levels reduce the number of locks acquired by transaction by eliminating the use of shared locks on read operations.</span></span> <span data-ttu-id="968d3-1373">Les performances système sont ainsi accrues et les ressources nécessaires à la gestion des verrous diminuées.</span><span class="sxs-lookup"><span data-stu-id="968d3-1373">This increases system performance by reducing the resources used to manage locks.</span></span> <span data-ttu-id="968d3-1374">La réduction des blocages d'une transaction par des verrous obtenus par d'autres transactions permet également d'augmenter les performances.</span><span class="sxs-lookup"><span data-stu-id="968d3-1374">Performance is also increased by reducing the number of times a transaction is blocked by locks acquired by other transactions.</span></span>  
  
 <span data-ttu-id="968d3-1375">Les niveaux d'isolement basé sur le contrôle de version de ligne augmentent les ressources nécessaires pour la modification de données.</span><span class="sxs-lookup"><span data-stu-id="968d3-1375">Row versioning-based isolation levels increase the resources needed by data modifications.</span></span> <span data-ttu-id="968d3-1376">L'activation de ces options induit automatiquement le contrôle de version de toutes les modifications apportées aux données de la base de données.</span><span class="sxs-lookup"><span data-stu-id="968d3-1376">Enabling these options causes all data modifications for the database to be versioned.</span></span> <span data-ttu-id="968d3-1377">Une copie des données avant modification est stockée dans tempdb, même s'il n'existe aucune transaction active utilisant l'isolement basé sur le contrôle de version de ligne.</span><span class="sxs-lookup"><span data-stu-id="968d3-1377">A copy of the data before modification is stored in tempdb even when there are no active transactions using row versioning-based isolation.</span></span> <span data-ttu-id="968d3-1378">Les données modifiées contiennent un pointeur vers les données de version stockées dans tempdb.</span><span class="sxs-lookup"><span data-stu-id="968d3-1378">The data after modification includes a pointer to the versioned data stored in tempdb.</span></span> <span data-ttu-id="968d3-1379">En ce qui concerne les objets volumineux, seule la partie de l'objet ayant été modifiée est copiée dans tempdb.</span><span class="sxs-lookup"><span data-stu-id="968d3-1379">For large objects, only part of the object that changed is copied to tempdb.</span></span>  
  
#### <a name="space-used-in-tempdb"></a><span data-ttu-id="968d3-1380">Espace occupé dans tempdb</span><span class="sxs-lookup"><span data-stu-id="968d3-1380">Space Used in tempdb</span></span>  

 <span data-ttu-id="968d3-1381">Pour toute instance du [!INCLUDE[ssDE](../includes/ssde-md.md)], tempdb doit disposer d’un espace suffisant pour conserver les versions de ligne générées pour chaque base de données dans l’instance.</span><span class="sxs-lookup"><span data-stu-id="968d3-1381">For each instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)], tempdb must have enough space to hold the row versions generated for every database in the instance.</span></span> <span data-ttu-id="968d3-1382">L'administrateur de base de données doit s'assurer que tempdb dispose de suffisamment d'espace pour la prise en charge de la banque des versions.</span><span class="sxs-lookup"><span data-stu-id="968d3-1382">The database administrator must ensure that tempdb has ample space to support the version store.</span></span> <span data-ttu-id="968d3-1383">tempdb intègre deux banques des versions :</span><span class="sxs-lookup"><span data-stu-id="968d3-1383">There are two version stores in tempdb:</span></span>  
  
-   <span data-ttu-id="968d3-1384">la banque des versions de construction d'index en ligne, utilisée pour les constructions d'index en ligne dans l'ensemble des bases de données ;</span><span class="sxs-lookup"><span data-stu-id="968d3-1384">The online index build version store is used for online index builds in all databases.</span></span>  
  
-   <span data-ttu-id="968d3-1385">la banque des versions commune, utilisée pour toutes les autres opérations de modification des données dans l'ensemble des bases de données.</span><span class="sxs-lookup"><span data-stu-id="968d3-1385">The common version store is used for all other data modification operations in all databases.</span></span>  
  
 <span data-ttu-id="968d3-1386">Les versions de ligne doivent être stockées pour toute la durée au cours de laquelle une transaction active doit être accessible.</span><span class="sxs-lookup"><span data-stu-id="968d3-1386">Row versions must be stored for as long as an active transaction needs to access it.</span></span> <span data-ttu-id="968d3-1387">Chaque minute, un thread d'arrière-plan supprime les versions de ligne qui ne sont plus nécessaires et libère de l'espace dans tempdb.</span><span class="sxs-lookup"><span data-stu-id="968d3-1387">Once every minute, a background thread removes row versions that are no longer needed and frees up the version space in tempdb.</span></span> <span data-ttu-id="968d3-1388">Une transaction longue empêche la libération d'espace dans une banque des versions si l'une des conditions suivantes est remplie :</span><span class="sxs-lookup"><span data-stu-id="968d3-1388">A long-running transaction prevents space in the version store from being released if it meets any of the following conditions:</span></span>  
  
-   <span data-ttu-id="968d3-1389">elle utilise l'isolement basé sur le contrôle de version de ligne ;</span><span class="sxs-lookup"><span data-stu-id="968d3-1389">It uses row versioning-based isolation.</span></span>  
  
-   <span data-ttu-id="968d3-1390">elle utilise des déclencheurs, des jeux MARS ou des opérations de construction d'index en ligne ;</span><span class="sxs-lookup"><span data-stu-id="968d3-1390">It uses triggers, MARS, or online index build operations.</span></span>  
  
-   <span data-ttu-id="968d3-1391">elle génère des versions de ligne.</span><span class="sxs-lookup"><span data-stu-id="968d3-1391">It generates row versions.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="968d3-1392">Quand un déclencheur est appelé au sein d'une transaction, les versions de ligne créées par le déclencheur sont conservées jusqu'à la fin de la transaction, même si les versions de ligne ne sont plus nécessaires après l'exécution du déclencheur.</span><span class="sxs-lookup"><span data-stu-id="968d3-1392">When a trigger is invoked inside a transaction, the row versions created by the trigger are maintained until the end of the transaction, even though the row versions are no longer needed after the trigger completes.</span></span> <span data-ttu-id="968d3-1393">Ce point s'applique aussi aux transactions à lecture validée qui utilisent le contrôle de version de ligne.</span><span class="sxs-lookup"><span data-stu-id="968d3-1393">This also applies to read-committed transactions that use row versioning.</span></span> <span data-ttu-id="968d3-1394">Dans ce type de transaction, une vue cohérente sur le plan transactionnel de la base de données n'est nécessaire que pour chaque instruction de la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1394">With this type of transaction, a transactionally consistent view of the database is needed only for each statement in the transaction.</span></span> <span data-ttu-id="968d3-1395">Cela signifie que les versions de ligne créées pour une instruction de la transaction ne sont plus nécessaires une fois l'instruction exécutée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1395">This means that the row versions created for a statement in the transaction are no longer needed after the statement completes.</span></span> <span data-ttu-id="968d3-1396">Cependant, les versions de ligne créées par chaque instruction de la transaction sont conservées jusqu'à la fin de la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1396">However, row versions created by each statement in the transaction are maintained until the transaction completes.</span></span>  
  
 <span data-ttu-id="968d3-1397">Quand tempdb n’a plus d’espace, le [!INCLUDE[ssDE](../includes/ssde-md.md)] force la réduction des banques des versions.</span><span class="sxs-lookup"><span data-stu-id="968d3-1397">When tempdb runs out of space, the [!INCLUDE[ssDE](../includes/ssde-md.md)] forces the version stores to shrink.</span></span> <span data-ttu-id="968d3-1398">Lors de ce processus de réduction, les transactions les plus longues n'ayant pas encore généré de versions de ligne sont marquées comme victimes.</span><span class="sxs-lookup"><span data-stu-id="968d3-1398">During the shrink process, the longest running transactions that have not yet generated row versions are marked as victims.</span></span> <span data-ttu-id="968d3-1399">Le message 3967 est inscrit dans le journal d'erreurs pour chaque transaction victime.</span><span class="sxs-lookup"><span data-stu-id="968d3-1399">A message 3967 is generated in the error log for each victim transaction.</span></span> <span data-ttu-id="968d3-1400">Toute transaction marquée comme victime ne peut plus lire les versions de ligne de la banque des versions.</span><span class="sxs-lookup"><span data-stu-id="968d3-1400">If a transaction is marked as a victim, it can no longer read the row versions in the version store.</span></span> <span data-ttu-id="968d3-1401">En cas de tentative de lecture des versions de ligne, le message 3966 est généré et la transaction est restaurée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1401">When it attempts to read row versions, message 3966 is generated and the transaction is rolled back.</span></span> <span data-ttu-id="968d3-1402">En cas de réussite du processus de réduction, l'espace est disponible dans tempdb.</span><span class="sxs-lookup"><span data-stu-id="968d3-1402">If the shrinking process succeeds, space becomes available in tempdb.</span></span> <span data-ttu-id="968d3-1403">Dans le cas contraire, l'espace de tempdb devient insuffisant, avec les conséquences suivantes :</span><span class="sxs-lookup"><span data-stu-id="968d3-1403">Otherwise, tempdb runs out of space and the following occurs:</span></span>  
  
-   <span data-ttu-id="968d3-1404">L'exécution des opérations d'écriture se poursuit, mais sans génération de versions.</span><span class="sxs-lookup"><span data-stu-id="968d3-1404">Write operations continue to execute but do not generate versions.</span></span> <span data-ttu-id="968d3-1405">Un message d'information (3959) apparaît dans le journal d'erreurs. La transaction d'écriture des données n'en est pas affectée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1405">An information message (3959) appears in the error log, but the transaction that writes data is not affected.</span></span>  
  
-   <span data-ttu-id="968d3-1406">Les transactions qui tentent d'accéder aux versions de ligne n'ayant pas été générées à cause d'une restauration complète dans tempdb se terminent sur l'erreur 3958.</span><span class="sxs-lookup"><span data-stu-id="968d3-1406">Transactions that attempt to access row versions that were not generated because of a tempdb full rollback terminate with an error 3958.</span></span>  
  
#### <a name="space-used-in-data-rows"></a><span data-ttu-id="968d3-1407">Espace occupé dans les lignes de données</span><span class="sxs-lookup"><span data-stu-id="968d3-1407">Space Used in Data Rows</span></span>  

 <span data-ttu-id="968d3-1408">Chaque ligne de base de données peut, à des fins d'informations sur le contrôle de version de ligne, utiliser un maximum de 14 octets en fin de ligne.</span><span class="sxs-lookup"><span data-stu-id="968d3-1408">Each database row may use up to 14 bytes at the end of the row for row versioning information.</span></span> <span data-ttu-id="968d3-1409">Les informations sur le contrôle de version de ligne contiennent le numéro de séquence de la transaction ayant validé la version et le pointeur vers la ligne avec version.</span><span class="sxs-lookup"><span data-stu-id="968d3-1409">The row versioning information contains the transaction sequence number of the transaction that committed the version and the pointer to the versioned row.</span></span> <span data-ttu-id="968d3-1410">Ces 14 octets sont ajoutés lors de la première modification de la ligne ou lors de l'insertion d'une nouvelle ligne, pour autant que l'une des conditions suivantes soit remplie :</span><span class="sxs-lookup"><span data-stu-id="968d3-1410">These 14 bytes are added the first time the row is modified, or when a new row is inserted, under any of these conditions:</span></span>  
  
-   <span data-ttu-id="968d3-1411">l'option READ_COMMITTED_SNAPSHOT ou ALLOW_SNAPSHOT_ISOLATION est activée (ON) ;</span><span class="sxs-lookup"><span data-stu-id="968d3-1411">READ_COMMITTED_SNAPSHOT or ALLOW_SNAPSHOT_ISOLATION options are ON.</span></span>  
  
-   <span data-ttu-id="968d3-1412">la table comporte un déclencheur ;</span><span class="sxs-lookup"><span data-stu-id="968d3-1412">The table has a trigger.</span></span>  
  
-   <span data-ttu-id="968d3-1413">des jeux MARS (Multiple Active Results Sets) sont en cours d'utilisation ;</span><span class="sxs-lookup"><span data-stu-id="968d3-1413">Multiple Active Results Sets (MARS) is being used.</span></span>  
  
-   <span data-ttu-id="968d3-1414">des opérations de construction d'index en ligne sont en cours d'exécution dans la table.</span><span class="sxs-lookup"><span data-stu-id="968d3-1414">Online index build operations are currently running on the table.</span></span>  
  
 <span data-ttu-id="968d3-1415">Ces 14 octets sont supprimés de la ligne de base de données lors de la première modification de la ligne, pour autant que toutes les conditions suivantes soient remplies :</span><span class="sxs-lookup"><span data-stu-id="968d3-1415">These 14 bytes are removed from the database row the first time the row is modified under all of these conditions:</span></span>  
  
-   <span data-ttu-id="968d3-1416">les options READ_COMMITTED_SNAPSHOT et ALLOW_SNAPSHOT_ISOLATION sont désactivées (OFF) ;</span><span class="sxs-lookup"><span data-stu-id="968d3-1416">READ_COMMITTED_SNAPSHOT and ALLOW_SNAPSHOT_ISOLATION options are OFF.</span></span>  
  
-   <span data-ttu-id="968d3-1417">le déclencheur n'existe plus dans la table ;</span><span class="sxs-lookup"><span data-stu-id="968d3-1417">The trigger no longer exists on the table.</span></span>  
  
-   <span data-ttu-id="968d3-1418">les jeux MARS ne sont pas en cours d'utilisation ;</span><span class="sxs-lookup"><span data-stu-id="968d3-1418">MARS is not being used.</span></span>  
  
-   <span data-ttu-id="968d3-1419">aucune opération de construction d'index en ligne n'est en cours d'exécution.</span><span class="sxs-lookup"><span data-stu-id="968d3-1419">Online index build operations are not currently running.</span></span>  
  
 <span data-ttu-id="968d3-1420">En cas d'utilisation de l'une des fonctionnalités de contrôle de version de ligne, vous devrez peut-être allouer un espace disque suffisant pour permettre les 14 octets nécessaires par ligne de base de données.</span><span class="sxs-lookup"><span data-stu-id="968d3-1420">If you use any of the row versioning features, you might need to allocate additional disk space for the database to accommodate the 14 bytes per database row.</span></span> <span data-ttu-id="968d3-1421">L'ajout d'informations sur le contrôle de version de ligne peut entraîner le fractionnement des pages d'index ou l'allocation d'une nouvelle page de données en cas d'insuffisance d'espace disponible sur la page actuelle.</span><span class="sxs-lookup"><span data-stu-id="968d3-1421">Adding the row versioning information can cause index page splits or the allocation of a new data page if there is not enough space available on the current page.</span></span> <span data-ttu-id="968d3-1422">Par exemple, si la longueur de ligne moyenne est de 100 octets, les 14 octets supplémentaires peuvent provoquer une augmentation de 14 pour cent de la table existante.</span><span class="sxs-lookup"><span data-stu-id="968d3-1422">For example, if the average row length is 100 bytes, the additional 14 bytes cause an existing table to grow up to 14 percent.</span></span>  
  
 <span data-ttu-id="968d3-1423">La réduction du [facteur de remplissage](../relational-databases/indexes/specify-fill-factor-for-an-index.md) peut permettre d’empêcher ou de réduire la fragmentation des pages d’index.</span><span class="sxs-lookup"><span data-stu-id="968d3-1423">Decreasing the [fill factor](../relational-databases/indexes/specify-fill-factor-for-an-index.md) might help to prevent or decrease fragmentation of index pages.</span></span> <span data-ttu-id="968d3-1424">Pour afficher les informations de fragmentation des données et des index d’une table ou d’une vue, vous pouvez utiliser [DBCC SHOWCONTIG](/sql/t-sql/database-console-commands/dbcc-showcontig-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="968d3-1424">To view fragmentation information for the data and indexes of a table or view, you can use [DBCC SHOWCONTIG](/sql/t-sql/database-console-commands/dbcc-showcontig-transact-sql).</span></span>  
  
#### <a name="space-used-in-large-objects"></a><span data-ttu-id="968d3-1425">Espace occupé dans les objets volumineux</span><span class="sxs-lookup"><span data-stu-id="968d3-1425">Space Used in Large Objects</span></span>  

 <span data-ttu-id="968d3-1426">Le [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] prend en charge six types de données pouvant contenir des chaînes volumineuses d’une longueur de 2 gigaoctets (Go) au maximum : `nvarchar(max)`, `varchar(max)`, `varbinary(max)`, `ntext`, `text` et `image`.</span><span class="sxs-lookup"><span data-stu-id="968d3-1426">The [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] supports six data types that can hold large strings up to 2 gigabytes (GB) in length: `nvarchar(max)`, `varchar(max)`, `varbinary(max)`, `ntext`, `text`, and `image`.</span></span> <span data-ttu-id="968d3-1427">Les chaînes volumineuses stockées à l'aide de ces types de données sont stockées dans une série de fragments de données associés à la ligne de données.</span><span class="sxs-lookup"><span data-stu-id="968d3-1427">Large strings stored using these data types are stored in a series of data fragments that are linked to the data row.</span></span> <span data-ttu-id="968d3-1428">Les informations sur le contrôle de version de ligne sont stockées dans chaque fragment utilisé pour le stockage des chaînes volumineuses.</span><span class="sxs-lookup"><span data-stu-id="968d3-1428">Row versioning information is stored in each fragment used to store these large strings.</span></span> <span data-ttu-id="968d3-1429">Les fragments de données sont un ensemble de pages dédiées aux objets volumineux d'une table.</span><span class="sxs-lookup"><span data-stu-id="968d3-1429">Data fragments are a collection of pages dedicated to large objects in a table.</span></span>  
  
 <span data-ttu-id="968d3-1430">Lorsque des valeurs importantes sont ajoutées dans une base de données, elles sont allouées avec un maximum de 8 040 octets de données par fragment.</span><span class="sxs-lookup"><span data-stu-id="968d3-1430">As new large values are added to a database, they are allocated using a maximum of 8040 bytes of data per fragment.</span></span> <span data-ttu-id="968d3-1431">Les versions antérieures du [!INCLUDE[ssDE](../includes/ssde-md.md)] pouvaient stocker jusqu’à 8 080 octets de données `ntext`, `text` ou `image` par fragment.</span><span class="sxs-lookup"><span data-stu-id="968d3-1431">Earlier versions of the [!INCLUDE[ssDE](../includes/ssde-md.md)] stored up to 8080 bytes of `ntext`, `text`, or `image` data per fragment.</span></span>  
  
 <span data-ttu-id="968d3-1432">Les données des objets volumineux (LOB) `ntext`, `text` et `image` existants ne sont pas mises à jour pour libérer de l'espace pour les informations sur le contrôle de version de ligne lorsqu'une base de données est mise à niveau vers [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] à partir d'une version antérieure de [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="968d3-1432">Existing `ntext`, `text`, and `image` large object (LOB) data is not updated to make space for the row versioning information when a database is upgraded to [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] from an earlier version of [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="968d3-1433">Cependant, lors de leur première modification, les données LOB sont mises à niveau de manière dynamique pour permettre le stockage des informations sur le contrôle de version,</span><span class="sxs-lookup"><span data-stu-id="968d3-1433">However, the first time the LOB data is modified, it is dynamically upgraded to enable storage of versioning information.</span></span> <span data-ttu-id="968d3-1434">même si des versions de lignes sont générées.</span><span class="sxs-lookup"><span data-stu-id="968d3-1434">This will happen even if row versions are not generated.</span></span> <span data-ttu-id="968d3-1435">Une fois la mise à niveau des données LOB terminée, le nombre maximum d'octets stockés par fragment passe de 8 080 à 8 040.</span><span class="sxs-lookup"><span data-stu-id="968d3-1435">After the LOB data is upgraded, the maximum number of bytes stored per fragment is reduced from 8080 bytes to 8040 bytes.</span></span> <span data-ttu-id="968d3-1436">Le processus de mise à niveau équivaut à supprimer la valeur LOB et à réinsérer la même valeur.</span><span class="sxs-lookup"><span data-stu-id="968d3-1436">The upgrade process is equivalent to deleting the LOB value and reinserting the same value.</span></span> <span data-ttu-id="968d3-1437">Les données LOB sont mises à niveau même en cas de modification d'un seul octet.</span><span class="sxs-lookup"><span data-stu-id="968d3-1437">The LOB data is upgraded even if only one byte is modified.</span></span> <span data-ttu-id="968d3-1438">Cette opération est unique pour chaque colonne `ntext`, `text` ou `image` Chaque opération peut néanmoins générer une quantité importante d'allocations de pages et d'activité E/S selon la taille des données LOB,</span><span class="sxs-lookup"><span data-stu-id="968d3-1438">This is a one-time operation for each `ntext`, `text`, or `image` column, but each operation may generate a large amount of page allocations and I/O activity depending upon the size of the LOB data.</span></span> <span data-ttu-id="968d3-1439">ainsi qu'une activité importante d'écriture dans le journal si la modification doit être écrite en entier dans le journal.</span><span class="sxs-lookup"><span data-stu-id="968d3-1439">It may also generate a large amount of logging activity if the modification is fully logged.</span></span> <span data-ttu-id="968d3-1440">Les opérations WRITETEXT et UPDATETEXT sont écrites dans le journal de façon minimale si le mode de récupération de la base de données n'est pas défini sur FULL.</span><span class="sxs-lookup"><span data-stu-id="968d3-1440">WRITETEXT and UPDATETEXT operations are minimally logged if database recovery mode is not set to FULL.</span></span>  
  
 <span data-ttu-id="968d3-1441">Les types de données `nvarchar(max)`, `varchar(max)` et `varbinary(max)` ne sont pas disponibles dans les versions antérieures de [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="968d3-1441">The `nvarchar(max)`, `varchar(max)`, and `varbinary(max)` data types are not available in earlier versions of [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="968d3-1442">Vous ne rencontrerez pas conséquent aucun problème de mise à niveau.</span><span class="sxs-lookup"><span data-stu-id="968d3-1442">Therefore, they have no upgrade issues.</span></span>  
  
 <span data-ttu-id="968d3-1443">Un espace disque suffisant doit être alloué pour satisfaire à cette exigence.</span><span class="sxs-lookup"><span data-stu-id="968d3-1443">Enough disk space should be allocated to accommodate this requirement.</span></span>  
  
#### <a name="monitoring-row-versioning-and-the-version-store"></a><span data-ttu-id="968d3-1444">Contrôle du contrôle de version de ligne et du magasin de versions</span><span class="sxs-lookup"><span data-stu-id="968d3-1444">Monitoring Row Versioning and the Version Store</span></span>  

 <span data-ttu-id="968d3-1445">[!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] fournit des outils pour le contrôle du contrôle de version de ligne, du magasin de versions et des processus d'isolement d'instantané : les vues DMV (Dynamic Management Views) et les compteurs de performances dans le Moniteur système Windows.</span><span class="sxs-lookup"><span data-stu-id="968d3-1445">For monitoring row versioning, version store, and snapshot isolation processes for performance and problems, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] provides tools in the form of Dynamic Management Views (DMVs) and performance counters in Windows System Monitor.</span></span>  
  
##### <a name="dmvs"></a><span data-ttu-id="968d3-1446">Vues DMV</span><span class="sxs-lookup"><span data-stu-id="968d3-1446">DMVs</span></span>  

 <span data-ttu-id="968d3-1447">Les vues DMV suivantes fournissent des informations sur l'état système actuel de tempdb et du magasin de versions, ainsi que sur les transactions utilisant le contrôle de version de ligne.</span><span class="sxs-lookup"><span data-stu-id="968d3-1447">The following DMVs provide information about the current system state of tempdb and the version store, as well as transactions using row versioning.</span></span>  
  
 <span data-ttu-id="968d3-1448">sys.dm_db_file_space_usage.</span><span class="sxs-lookup"><span data-stu-id="968d3-1448">sys.dm_db_file_space_usage.</span></span> <span data-ttu-id="968d3-1449">Retourne des informations sur l'utilisation de l'espace pour chaque fichier de la base de données.</span><span class="sxs-lookup"><span data-stu-id="968d3-1449">Returns space usage information for each file in the database.</span></span> <span data-ttu-id="968d3-1450">Pour plus d’informations, consultez [sys.dm_db_file_space_usage &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-file-space-usage-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="968d3-1450">For more information, see [sys.dm_db_file_space_usage &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-file-space-usage-transact-sql).</span></span>  
  
 <span data-ttu-id="968d3-1451">sys.dm_db_session_space_usage.</span><span class="sxs-lookup"><span data-stu-id="968d3-1451">sys.dm_db_session_space_usage.</span></span> <span data-ttu-id="968d3-1452">Renvoie les activités d'allocation ou de désallocation des pages par session de la base de données.</span><span class="sxs-lookup"><span data-stu-id="968d3-1452">Returns page allocation and deallocation activity by session for the database.</span></span> <span data-ttu-id="968d3-1453">Pour plus d’informations, consultez [sys.dm_db_session_space_usage &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-session-space-usage-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="968d3-1453">For more information, see [sys.dm_db_session_space_usage &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-session-space-usage-transact-sql).</span></span>  
  
 <span data-ttu-id="968d3-1454">sys.dm_db_task_space_usage.</span><span class="sxs-lookup"><span data-stu-id="968d3-1454">sys.dm_db_task_space_usage.</span></span> <span data-ttu-id="968d3-1455">Renvoie l'activité d'allocation/désallocation des pages par tâche pour la base de données.</span><span class="sxs-lookup"><span data-stu-id="968d3-1455">Returns page allocation and deallocation activity by task for the database.</span></span> <span data-ttu-id="968d3-1456">Pour plus d’informations, consultez [sys.dm_db_task_space_usage &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-task-space-usage-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="968d3-1456">For more information, see [sys.dm_db_task_space_usage &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-task-space-usage-transact-sql).</span></span>  
  
 <span data-ttu-id="968d3-1457">sys.dm_tran_top_version_generators.</span><span class="sxs-lookup"><span data-stu-id="968d3-1457">sys.dm_tran_top_version_generators.</span></span> <span data-ttu-id="968d3-1458">Renvoie une table virtuelle pour les objets générant la majorité des versions d'un magasin de versions.</span><span class="sxs-lookup"><span data-stu-id="968d3-1458">Returns a virtual table for the objects producing the most versions in the version store.</span></span> <span data-ttu-id="968d3-1459">Agrégation des 256 premières longueurs d'enregistrement selon database_id et rowset_id.</span><span class="sxs-lookup"><span data-stu-id="968d3-1459">It groups the top 256 aggregated record lengths by database_id and rowset_id.</span></span> <span data-ttu-id="968d3-1460">Utilisez cette fonction pour rechercher les clients les plus volumineux de la banque de versions.</span><span class="sxs-lookup"><span data-stu-id="968d3-1460">Use this function to find the largest consumers of the version store.</span></span> <span data-ttu-id="968d3-1461">Pour plus d’informations, consultez [sys.dm_tran_top_version_generators &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-top-version-generators-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="968d3-1461">For more information, see [sys.dm_tran_top_version_generators &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-top-version-generators-transact-sql).</span></span>  
  
 <span data-ttu-id="968d3-1462">sys.dm_tran_version_store.</span><span class="sxs-lookup"><span data-stu-id="968d3-1462">sys.dm_tran_version_store.</span></span> <span data-ttu-id="968d3-1463">Renvoie une table virtuelle qui affiche tous les enregistrements de version du magasin de versions commun.</span><span class="sxs-lookup"><span data-stu-id="968d3-1463">Returns a virtual table that displays all version records in the common version store.</span></span> <span data-ttu-id="968d3-1464">Pour plus d’informations, consultez [sys.dm_tran_version_store &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-version-store-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="968d3-1464">For more information, see [sys.dm_tran_version_store &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-version-store-transact-sql).</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="968d3-1465">sys.dm_tran_top_version_generators et sys.dm_tran_version_store sont des fonctions potentiellement très compliquées à exécuter dans la mesure où elles interrogent toutes deux le magasin de versions entier, qui peut s'avérer très volumineux.</span><span class="sxs-lookup"><span data-stu-id="968d3-1465">sys.dm_tran_top_version_generators and sys.dm_tran_version_store are potentially very expensive functions to run, since both query the entire version store, which could be very large.</span></span>  
  
 <span data-ttu-id="968d3-1466">sys.dm_tran_active_snapshot_database_transactions.</span><span class="sxs-lookup"><span data-stu-id="968d3-1466">sys.dm_tran_active_snapshot_database_transactions.</span></span> <span data-ttu-id="968d3-1467">Retourne une table virtuelle pour toutes les transactions actives dans l'ensemble des bases de données d'une instance de [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] utilisant le contrôle de version de ligne.</span><span class="sxs-lookup"><span data-stu-id="968d3-1467">Returns a virtual table for all active transactions in all databases within the [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] instance that use row versioning.</span></span> <span data-ttu-id="968d3-1468">Les transactions système n'apparaissent pas dans cette vue DMV.</span><span class="sxs-lookup"><span data-stu-id="968d3-1468">System transactions do not appear in this DMV.</span></span> <span data-ttu-id="968d3-1469">Pour plus d’informations, consultez [sys.dm_tran_active_snapshot_database_transactions &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-active-snapshot-database-transactions-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="968d3-1469">For more information, see [sys.dm_tran_active_snapshot_database_transactions &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-active-snapshot-database-transactions-transact-sql).</span></span>  
  
 <span data-ttu-id="968d3-1470">sys.dm_tran_transactions_snapshot.</span><span class="sxs-lookup"><span data-stu-id="968d3-1470">sys.dm_tran_transactions_snapshot.</span></span> <span data-ttu-id="968d3-1471">Renvoie une table virtuelle qui affiche les instantanés pris par chaque transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1471">Returns a virtual table that displays snapshots taken by each transaction.</span></span> <span data-ttu-id="968d3-1472">L'instantané contient le numéro de séquence des transactions actives utilisant le contrôle de version de ligne.</span><span class="sxs-lookup"><span data-stu-id="968d3-1472">The snapshot contains the sequence number of the active transactions that use row versioning.</span></span> <span data-ttu-id="968d3-1473">Pour plus d’informations, consultez [sys.dm_tran_transactions_snapshot &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-transactions-snapshot-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="968d3-1473">For more information, see [sys.dm_tran_transactions_snapshot &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-transactions-snapshot-transact-sql).</span></span>  
  
 <span data-ttu-id="968d3-1474">sys.dm_tran_current_transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1474">sys.dm_tran_current_transaction.</span></span> <span data-ttu-id="968d3-1475">Renvoie une ligne unique affichant des informations sur l'état du contrôle de version de ligne pour la transaction de la session en cours.</span><span class="sxs-lookup"><span data-stu-id="968d3-1475">Returns a single row that displays row versioning-related state information of the transaction in the current session.</span></span> <span data-ttu-id="968d3-1476">Pour plus d’informations, consultez [sys.dm_tran_current_transaction &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-current-transaction-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="968d3-1476">For more information, see [sys.dm_tran_current_transaction &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-current-transaction-transact-sql).</span></span>  
  
 <span data-ttu-id="968d3-1477">sys.dm_tran_current_snapshot.</span><span class="sxs-lookup"><span data-stu-id="968d3-1477">sys.dm_tran_current_snapshot.</span></span> <span data-ttu-id="968d3-1478">Retourne une table virtuelle affichant toutes les transactions actives au début de la transaction d'isolement d'instantané.</span><span class="sxs-lookup"><span data-stu-id="968d3-1478">Returns a virtual table that displays all active transactions at the time the current snapshot isolation transaction starts.</span></span> <span data-ttu-id="968d3-1479">Si la transaction actuelle utilise l'isolement d'instantané, cette fonction ne retourne aucune ligne.</span><span class="sxs-lookup"><span data-stu-id="968d3-1479">If the current transaction is using snapshot isolation, this function returns no rows.</span></span> <span data-ttu-id="968d3-1480">sys.dm_tran_current_snapshot est similaire à sys.dm_tran_transactions_snapshot, mis à part qu’elle retourne uniquement les transactions actives pour l’instantané actuel.</span><span class="sxs-lookup"><span data-stu-id="968d3-1480">sys.dm_tran_current_snapshot is similar to sys.dm_tran_transactions_snapshot, except that it returns only the active transactions for the current snapshot.</span></span> <span data-ttu-id="968d3-1481">Pour plus d’informations, consultez [sys.dm_tran_current_snapshot &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-current-snapshot-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="968d3-1481">For more information, see [sys.dm_tran_current_snapshot &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-current-snapshot-transact-sql).</span></span>  
  
##### <a name="performance-counters"></a><span data-ttu-id="968d3-1482">Compteurs de performance</span><span class="sxs-lookup"><span data-stu-id="968d3-1482">Performance Counters</span></span>  

 <span data-ttu-id="968d3-1483">Les compteurs de performance de [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] fournissent des informations sur les performances système affectées par les processus de [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="968d3-1483">[!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] performance counters provide information about the system performance impacted by [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] processes.</span></span> <span data-ttu-id="968d3-1484">Les compteurs de performances suivants contrôlent tempdb et le magasin de versions, ainsi que les transactions utilisant le contrôle de version de ligne.</span><span class="sxs-lookup"><span data-stu-id="968d3-1484">The following performance counters monitor tempdb and the version store, as well as transactions using row versioning.</span></span> <span data-ttu-id="968d3-1485">Les compteurs de performances se trouvent dans l'objet de performances SQLServer:Transactions.</span><span class="sxs-lookup"><span data-stu-id="968d3-1485">The performance counters are contained in the SQLServer:Transactions performance object.</span></span>  
  
 <span data-ttu-id="968d3-1486">**Espace disponible dans tempdb (Ko)** .</span><span class="sxs-lookup"><span data-stu-id="968d3-1486">**Free Space in tempdb (KB)**.</span></span> <span data-ttu-id="968d3-1487">Contrôle la quantité, en kilooctets (Ko), d'espace libre dans la base de données tempdb.</span><span class="sxs-lookup"><span data-stu-id="968d3-1487">Monitors the amount, in kilobytes (KB), of free space in the tempdb database.</span></span> <span data-ttu-id="968d3-1488">tempdb doit disposer d'un espace libre suffisant pour gérer le magasin de versions prenant en charge l'isolement d'instantané.</span><span class="sxs-lookup"><span data-stu-id="968d3-1488">There must be enough free space in tempdb to handle the version store that supports snapshot isolation.</span></span>  
  
 <span data-ttu-id="968d3-1489">La formule ci-dessous vous donne une estimation grossière de la taille du magasin de versions.</span><span class="sxs-lookup"><span data-stu-id="968d3-1489">The following formula provides a rough estimate of the size of the version store.</span></span> <span data-ttu-id="968d3-1490">Pour estimer la taille du magasin de versions en ce qui concerne les transactions longues, il peut s'avérer utile de contrôler les taux de génération et de nettoyage.</span><span class="sxs-lookup"><span data-stu-id="968d3-1490">For long-running transactions, it may be useful to monitor the generation and cleanup rate to estimate the maximum size of the version store.</span></span>  
  
 <span data-ttu-id="968d3-1491">[taille de la banque des versions commune] = 2 \* [données de la banque des versions générées par minute] \* [délai d’exécution le plus long (en minutes) de la transaction]</span><span class="sxs-lookup"><span data-stu-id="968d3-1491">[size of common version store] = 2 \* [version store data generated per minute] \* [longest running time (minutes) of the transaction]</span></span>  
  
 <span data-ttu-id="968d3-1492">Le délai le plus long d'exécution de transaction ne doit pas inclure les constructions d'un index en ligne.</span><span class="sxs-lookup"><span data-stu-id="968d3-1492">The longest running time of transactions should not include online index builds.</span></span> <span data-ttu-id="968d3-1493">Étant donné que ces dernières opérations peuvent prendre un certain temps pour les tables volumineuses, elles utilisent un autre magasin de versions.</span><span class="sxs-lookup"><span data-stu-id="968d3-1493">Because these operations may take a long time on very large tables, online index builds use a separate version store.</span></span> <span data-ttu-id="968d3-1494">La taille approximative du magasin de versions utilisé pour les constructions d'un index en ligne équivaut à la quantité de données modifiées dans la table, y compris tous les index, pendant toute la durée d'activité de la construction de l'index en ligne.</span><span class="sxs-lookup"><span data-stu-id="968d3-1494">The approximate size of the online index build version store equals the amount of data modified in the table, including all indexes, while the online index build is active.</span></span>  
  
 <span data-ttu-id="968d3-1495">**Taille de la banque des versions (Ko)** .</span><span class="sxs-lookup"><span data-stu-id="968d3-1495">**Version Store Size (KB)**.</span></span> <span data-ttu-id="968d3-1496">Contrôle la taille en Ko de tous les magasins de versions.</span><span class="sxs-lookup"><span data-stu-id="968d3-1496">Monitors the size in KB of all version stores.</span></span> <span data-ttu-id="968d3-1497">Cette information permet de déterminer la quantité d'espace nécessaire dans la base de données tempdb pour le magasin de versions.</span><span class="sxs-lookup"><span data-stu-id="968d3-1497">This information helps determine the amount of space needed in the tempdb database for the version store.</span></span> <span data-ttu-id="968d3-1498">Le contrôle de ce compteur sur une période de temps fournit une estimation utile de l'espace supplémentaire requis pour tempdb.</span><span class="sxs-lookup"><span data-stu-id="968d3-1498">Monitoring this counter over a period of time provides a useful estimate of additional space needed for tempdb.</span></span>  
  
 <span data-ttu-id="968d3-1499">`Version Generation rate (KB/s)`.</span><span class="sxs-lookup"><span data-stu-id="968d3-1499">`Version Generation rate (KB/s)`.</span></span> <span data-ttu-id="968d3-1500">Contrôle le taux de génération de version en Ko par seconde pour tous les magasins de versions.</span><span class="sxs-lookup"><span data-stu-id="968d3-1500">Monitors the version generation rate in KB per second in all version stores.</span></span>  
  
 <span data-ttu-id="968d3-1501">`Version Cleanup rate (KB/s)`.</span><span class="sxs-lookup"><span data-stu-id="968d3-1501">`Version Cleanup rate (KB/s)`.</span></span> <span data-ttu-id="968d3-1502">Contrôle le taux de nettoyage de version en Ko par seconde pour tous les magasins de versions.</span><span class="sxs-lookup"><span data-stu-id="968d3-1502">Monitors the version cleanup rate in KB per second in all version stores.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="968d3-1503">Les informations obtenues à l'aide des compteurs Taux de génération de version (Ko/s) et Taux de nettoyage de version (Ko/s) permettent de prévoir l'espace nécessaire pour tempdb.</span><span class="sxs-lookup"><span data-stu-id="968d3-1503">Information from Version Generation rate (KB/s) and Version Cleanup rate (KB/s) can be used to predict tempdb space requirements.</span></span>  
  
 <span data-ttu-id="968d3-1504">**Nombre d’unités dans la banque des versions**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1504">**Version Store unit count**.</span></span> <span data-ttu-id="968d3-1505">Contrôle le nombre d'unités dans le magasin de versions.</span><span class="sxs-lookup"><span data-stu-id="968d3-1505">Monitors the count of version store units.</span></span>  
  
 <span data-ttu-id="968d3-1506">**Création d’unité dans la banque des versions**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1506">**Version Store unit creation**.</span></span> <span data-ttu-id="968d3-1507">Contrôle le nombre total d'unités créées dans le magasin de versions pour le stockage des versions de lignes depuis le démarrage de l'instance.</span><span class="sxs-lookup"><span data-stu-id="968d3-1507">Monitors the total number of version store units created to store row versions since the instance was started.</span></span>  
  
 <span data-ttu-id="968d3-1508">**Troncation d’unité dans la banque des versions**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1508">**Version Store unit truncation**.</span></span> <span data-ttu-id="968d3-1509">Contrôle le nombre total d'unités tronquées dans le magasin de versions depuis le démarrage de l'instance.</span><span class="sxs-lookup"><span data-stu-id="968d3-1509">Monitors the total number of version store units truncated since the instance was started.</span></span> <span data-ttu-id="968d3-1510">Une unité de magasin de versions est tronquée lorsque [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] spécifie qu'aucune des lignes de versions stockées dans l'unité du magasin de versions n'est requise pour l'exécution des transactions actives.</span><span class="sxs-lookup"><span data-stu-id="968d3-1510">A version store unit is truncated when [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] determines that none of the version rows stored in the version store unit are needed to run active transactions.</span></span>  
  
 <span data-ttu-id="968d3-1511">**Proportion de conflits de mise à jour**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1511">**Update conflict ratio**.</span></span> <span data-ttu-id="968d3-1512">Contrôle la proportion de transactions d'instantanés de mise à jour présentant des conflits de mise à jour par rapport au nombre total de transactions d'instantanés de mise à jour.</span><span class="sxs-lookup"><span data-stu-id="968d3-1512">Monitors the ratio of update snapshot transaction that have update conflicts to the total number of update snapshot transactions.</span></span>  
  
 <span data-ttu-id="968d3-1513">**Délai le plus long d’exécution de transaction**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1513">**Longest Transaction Running Time**.</span></span> <span data-ttu-id="968d3-1514">Contrôle le délai le plus long (en secondes) d'exécution de toute transaction utilisant le contrôle de version de ligne.</span><span class="sxs-lookup"><span data-stu-id="968d3-1514">Monitors the longest running time in seconds of any transaction using row versioning.</span></span> <span data-ttu-id="968d3-1515">Ce compteur permet de déterminer si l'exécution de l'une des transactions est trop longue.</span><span class="sxs-lookup"><span data-stu-id="968d3-1515">This can be used to determine if any transaction is running for an unreasonable amount of time.</span></span>  
  
 <span data-ttu-id="968d3-1516">**Transactions**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1516">**Transactions**.</span></span> <span data-ttu-id="968d3-1517">Contrôle le nombre total de transactions actives.</span><span class="sxs-lookup"><span data-stu-id="968d3-1517">Monitors the total number of active transactions.</span></span> <span data-ttu-id="968d3-1518">Les transactions système ne sont pas prises en compte.</span><span class="sxs-lookup"><span data-stu-id="968d3-1518">This does not include system transactions.</span></span>  
  
 <span data-ttu-id="968d3-1519">`Snapshot Transactions`.</span><span class="sxs-lookup"><span data-stu-id="968d3-1519">`Snapshot Transactions`.</span></span> <span data-ttu-id="968d3-1520">Contrôle le nombre total de transactions d'instantanés actives.</span><span class="sxs-lookup"><span data-stu-id="968d3-1520">Monitors the total number of active snapshot transactions.</span></span>  
  
 <span data-ttu-id="968d3-1521">`Update Snapshot Transactions`.</span><span class="sxs-lookup"><span data-stu-id="968d3-1521">`Update Snapshot Transactions`.</span></span> <span data-ttu-id="968d3-1522">Contrôle le nombre total de transactions d'instantanés effectuant des opérations de mise à jour.</span><span class="sxs-lookup"><span data-stu-id="968d3-1522">Monitors the total number of active snapshot transactions that perform update operations.</span></span>  
  
 <span data-ttu-id="968d3-1523">`NonSnapshot Version Transactions`.</span><span class="sxs-lookup"><span data-stu-id="968d3-1523">`NonSnapshot Version Transactions`.</span></span> <span data-ttu-id="968d3-1524">Contrôle le nombre total de transactions actives non liées à des instantanés générant des enregistrements de versions.</span><span class="sxs-lookup"><span data-stu-id="968d3-1524">Monitors the total number of active non-snapshot transactions that generate version records.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="968d3-1525">La somme des compteurs Transactions d'instantanés de mise à jour et Transactions de versions non liées à des instantanés représente le nombre total de transactions participant à la génération d'une version.</span><span class="sxs-lookup"><span data-stu-id="968d3-1525">The sum of Update Snapshot Transactions and NonSnapshot Version Transactions represents the total number of transactions that participate in version generation.</span></span> <span data-ttu-id="968d3-1526">La différence entre les compteurs Transactions d'instantanés et Transactions d'instantanés de mise à jour indique le nombre de transactions d'instantanés en lecture seule.</span><span class="sxs-lookup"><span data-stu-id="968d3-1526">The difference of Snapshot Transactions and Update Snapshot Transactions reports the number of read-only snapshot transactions.</span></span>  
  
### <a name="row-versioning-based-isolation-level-example"></a><span data-ttu-id="968d3-1527">Exemple de niveau d'isolement basé sur le contrôle de version de ligne</span><span class="sxs-lookup"><span data-stu-id="968d3-1527">Row Versioning-based Isolation Level Example</span></span>  

 <span data-ttu-id="968d3-1528">Les exemples ci-dessous illustrent les différences de comportement entre les transactions d'isolement d'instantané et les transactions validées en écriture qui utilisent le contrôle de version de ligne.</span><span class="sxs-lookup"><span data-stu-id="968d3-1528">The following examples show the differences in behavior between snapshot isolation transactions and read-committed transactions that use row versioning.</span></span>  
  
#### <a name="a-working-with-snapshot-isolation"></a><span data-ttu-id="968d3-1529">R.</span><span class="sxs-lookup"><span data-stu-id="968d3-1529">A.</span></span> <span data-ttu-id="968d3-1530">Utilisation du niveau d'isolement d'instantané</span><span class="sxs-lookup"><span data-stu-id="968d3-1530">Working with snapshot isolation</span></span>  

 <span data-ttu-id="968d3-1531">Dans cet exemple, une transaction exécutée sous isolement d'instantané lit des données qui sont ensuite modifiées par une autre transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1531">In this example, a transaction running under snapshot isolation reads data that is then modified by another transaction.</span></span> <span data-ttu-id="968d3-1532">La transaction d'instantané ne bloque pas l'opération de mise à jour exécutée par l'autre transaction et continue de lire les données à partir de la ligne avec version, en ignorant la modification apportée aux données.</span><span class="sxs-lookup"><span data-stu-id="968d3-1532">The snapshot transaction does not block the update operation executed by the other transaction, and it continues to read data from the versioned row, ignoring the data modification.</span></span> <span data-ttu-id="968d3-1533">Toutefois, lorsque la transaction d'instantané tente de modifier des données qui ont déjà été modifiées par l'autre transaction, la transaction d'instantané génère une erreur et est terminée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1533">However, when the snapshot transaction attempts to modify the data that has already been modified by the other transaction, the snapshot transaction generates an error and is terminated.</span></span>  
  
 <span data-ttu-id="968d3-1534">Sur la session 1 :</span><span class="sxs-lookup"><span data-stu-id="968d3-1534">On session 1:</span></span>  
  
```sql  
USE AdventureWorks2012;  -- Or the 2008 or 2008R2 version of the AdventureWorks database.  
GO  
  
-- Enable snapshot isolation on the database.  
ALTER DATABASE AdventureWorks2012  
    SET ALLOW_SNAPSHOT_ISOLATION ON;  
GO  
  
-- Start a snapshot transaction  
SET TRANSACTION ISOLATION LEVEL SNAPSHOT;  
GO  
  
BEGIN TRANSACTION;  
    -- This SELECT statement will return  
    -- 48 vacation hours for the employee.  
    SELECT BusinessEntityID, VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
```  
  
 <span data-ttu-id="968d3-1535">Sur la session 2 :</span><span class="sxs-lookup"><span data-stu-id="968d3-1535">On session 2:</span></span>  
  
```sql  
USE AdventureWorks2012;  
GO  
  
-- Start a transaction.  
BEGIN TRANSACTION;  
    -- Subtract a vacation day from employee 4.  
    -- Update is not blocked by session 1 since  
    -- under snapshot isolation shared locks are  
    -- not requested.  
    UPDATE HumanResources.Employee  
        SET VacationHours = VacationHours - 8  
        WHERE BusinessEntityID = 4;  
  
    -- Verify that the employee now has 40 vacation hours.  
    SELECT VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
```  
  
 <span data-ttu-id="968d3-1536">Sur la session 1 :</span><span class="sxs-lookup"><span data-stu-id="968d3-1536">On session 1:</span></span>  
  
```sql  
    -- Reissue the SELECT statement - this shows  
    -- the employee having 48 vacation hours.  The  
    -- snapshot transaction is still reading data from  
    -- the versioned row.  
    SELECT BusinessEntityID, VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
```  
  
 <span data-ttu-id="968d3-1537">Sur la session 2 :</span><span class="sxs-lookup"><span data-stu-id="968d3-1537">On session 2:</span></span>  
  
```sql  
-- Commit the transaction; this commits the data  
-- modification.  
COMMIT TRANSACTION;  
GO  
```  
  
 <span data-ttu-id="968d3-1538">Sur la session 1 :</span><span class="sxs-lookup"><span data-stu-id="968d3-1538">On session 1:</span></span>  
  
```sql  
    -- Reissue the SELECT statement - this still   
    -- shows the employee having 48 vacation hours  
    -- even after the other transaction has committed  
    -- the data modification.  
    SELECT BusinessEntityID, VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
  
    -- Because the data has been modified outside of the  
    -- snapshot transaction, any further data changes to   
    -- that data by the snapshot transaction will cause   
    -- the snapshot transaction to fail. This statement   
    -- will generate a 3960 error and the transaction will   
    -- terminate.  
    UPDATE HumanResources.Employee  
        SET SickLeaveHours = SickLeaveHours - 8  
        WHERE BusinessEntityID = 4;  
  
-- Undo the changes to the database from session 1.   
-- This will not undo the change from session 2.  
ROLLBACK TRANSACTION  
GO  
```  
  
#### <a name="b-working-with-read-committed-using-row-versioning"></a><span data-ttu-id="968d3-1539">B.</span><span class="sxs-lookup"><span data-stu-id="968d3-1539">B.</span></span> <span data-ttu-id="968d3-1540">Utilisation d'une transaction validée en lecture à l'aide du contrôle de version de ligne</span><span class="sxs-lookup"><span data-stu-id="968d3-1540">Working with read-committed using row versioning</span></span>  

 <span data-ttu-id="968d3-1541">Dans cet exemple, une transaction validée en lecture à l'aide du contrôle de version de ligne est exécutée en même temps qu'une autre transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1541">In this example, a read-committed transaction using row versioning runs concurrently with another transaction.</span></span> <span data-ttu-id="968d3-1542">La transaction validée en lecture se comporte différemment de la transaction d'instantané.</span><span class="sxs-lookup"><span data-stu-id="968d3-1542">The read-committed transaction behaves differently than a snapshot transaction.</span></span> <span data-ttu-id="968d3-1543">À l'instar d'une transaction d'instantané, la transaction validée en lecture lit les lignes avec version même après la modification des données effectuée par l'autre transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1543">Like a snapshot transaction, the read-committed transaction will read versioned rows even after the other transaction has modified data.</span></span> <span data-ttu-id="968d3-1544">Toutefois, contrairement à une transaction d'instantané, la transaction validée en lecture :</span><span class="sxs-lookup"><span data-stu-id="968d3-1544">However, unlike a snapshot transaction, the read-committed transaction will:</span></span>  
  
-   <span data-ttu-id="968d3-1545">lit les données modifiées une fois que l'autre transaction a validé les modifications de données ;</span><span class="sxs-lookup"><span data-stu-id="968d3-1545">Read the modified data after the other transaction commits the data changes.</span></span>  
  
-   <span data-ttu-id="968d3-1546">peut mettre à jour les données modifiées par l'autre transaction, alors que cette opération n'est pas possible avec la transaction d'instantané.</span><span class="sxs-lookup"><span data-stu-id="968d3-1546">Be able to update the data modified by the other transaction where the snapshot transaction could not.</span></span>  
  
 <span data-ttu-id="968d3-1547">Sur la session 1 :</span><span class="sxs-lookup"><span data-stu-id="968d3-1547">On session 1:</span></span>  
  
```sql  
USE AdventureWorks2012;  -- Or any earlier version of the AdventureWorks database.  
GO  
  
-- Enable READ_COMMITTED_SNAPSHOT on the database.  
-- For this statement to succeed, this session  
-- must be the only connection to the AdventureWorks2012  
-- database.  
ALTER DATABASE AdventureWorks2012  
    SET READ_COMMITTED_SNAPSHOT ON;  
GO  
  
-- Start a read-committed transaction  
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;  
GO  
  
BEGIN TRANSACTION;  
    -- This SELECT statement will return  
    -- 48 vacation hours for the employee.  
    SELECT BusinessEntityID, VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
  
```  
  
 <span data-ttu-id="968d3-1548">Sur la session 2 :</span><span class="sxs-lookup"><span data-stu-id="968d3-1548">On session 2:</span></span>  
  
```sql  
USE AdventureWorks2012;  
GO  
  
-- Start a transaction.  
BEGIN TRANSACTION;  
    -- Subtract a vacation day from employee 4.  
    -- Update is not blocked by session 1 since  
    -- under read-committed using row versioning shared locks are  
    -- not requested.  
    UPDATE HumanResources.Employee  
        SET VacationHours = VacationHours - 8  
        WHERE BusinessEntityID = 4;  
  
    -- Verify that the employee now has 40 vacation hours.  
    SELECT VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
  
```  
  
 <span data-ttu-id="968d3-1549">Sur la session 1 :</span><span class="sxs-lookup"><span data-stu-id="968d3-1549">On session 1:</span></span>  
  
```sql  
    -- Reissue the SELECT statement - this still shows  
    -- the employee having 48 vacation hours.  The  
    -- read-committed transaction is still reading data   
    -- from the versioned row and the other transaction   
    -- has not committed the data changes yet.  
    SELECT BusinessEntityID, VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
  
```  
  
 <span data-ttu-id="968d3-1550">Sur la session 2 :</span><span class="sxs-lookup"><span data-stu-id="968d3-1550">On session 2:</span></span>  
  
```sql  
-- Commit the transaction.  
COMMIT TRANSACTION;  
GO  
  
```  
  
 <span data-ttu-id="968d3-1551">Sur la session 1 :</span><span class="sxs-lookup"><span data-stu-id="968d3-1551">On session 1:</span></span>  
  
```sql  
    -- Reissue the SELECT statement which now shows the   
    -- employee having 40 vacation hours.  Being   
    -- read-committed, this transaction is reading the   
    -- committed data. This is different from snapshot  
    -- isolation which reads from the versioned row.  
    SELECT BusinessEntityID, VacationHours  
        FROM HumanResources.Employee  
        WHERE BusinessEntityID = 4;  
  
    -- This statement, which caused the snapshot transaction   
    -- to fail, will succeed with read-committed using row versioning.  
    UPDATE HumanResources.Employee  
        SET SickLeaveHours = SickLeaveHours - 8  
        WHERE BusinessEntityID = 4;  
  
-- Undo the changes to the database from session 1.   
-- This will not undo the change from session 2.  
ROLLBACK TRANSACTION;  
GO  
```  
  
### <a name="enabling-row-versioning-based-isolation-levels"></a><span data-ttu-id="968d3-1552">Activation des niveaux d'isolement selon le contrôle de version de ligne</span><span class="sxs-lookup"><span data-stu-id="968d3-1552">Enabling Row Versioning-Based Isolation Levels</span></span>  

 <span data-ttu-id="968d3-1553">Les administrateurs de bases de données déterminent les paramètres de contrôle de version de ligne définis au niveau de la base de données à l'aide des options de base de données READ_COMMITTED_SNAPSHOT et ALLOW_SNAPSHOT_ISOLATION de l'instruction ALTER DATABASE.</span><span class="sxs-lookup"><span data-stu-id="968d3-1553">Database administrators control the database-level settings for row versioning by using the READ_COMMITTED_SNAPSHOT and ALLOW_SNAPSHOT_ISOLATION database options in the ALTER DATABASE statement.</span></span>  
  
 <span data-ttu-id="968d3-1554">Lorsque l'option de base de données READ_COMMITTED_SNAPSHOT est activée (ON), les mécanismes de prise en charge de l'option sont immédiatement activés.</span><span class="sxs-lookup"><span data-stu-id="968d3-1554">When the READ_COMMITTED_SNAPSHOT database option is set ON, the mechanisms used to support the option are activated immediately.</span></span> <span data-ttu-id="968d3-1555">Lors du paramétrage de l'option READ_COMMITTED_SNAPSHOT, seule la connexion exécutant la commande ALTER DATABASE est autorisée dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="968d3-1555">When setting the READ_COMMITTED_SNAPSHOT option, only the connection executing the ALTER DATABASE command is allowed in the database.</span></span> <span data-ttu-id="968d3-1556">La base de données ne peut contenir aucune autre connexion ouverte avant la fin de l'exécution de la commande ALTER DATABASE.</span><span class="sxs-lookup"><span data-stu-id="968d3-1556">There must be no other open connection in the database until ALTER DATABASE is complete.</span></span> <span data-ttu-id="968d3-1557">Il n'est pas nécessaire que la base de données soit en mode mono-utilisateur.</span><span class="sxs-lookup"><span data-stu-id="968d3-1557">The database does not have to be in single-user mode.</span></span>  
  
 <span data-ttu-id="968d3-1558">L'instruction [!INCLUDE[tsql](../includes/tsql-md.md)] suivante permet la prise en charge de l'option READ_COMMITTED_SNAPSHOT :</span><span class="sxs-lookup"><span data-stu-id="968d3-1558">The following [!INCLUDE[tsql](../includes/tsql-md.md)] statement enables READ_COMMITTED_SNAPSHOT:</span></span>  
  
```sql  
ALTER DATABASE AdventureWorks2012  
    SET READ_COMMITTED_SNAPSHOT ON;  
```  
  
 <span data-ttu-id="968d3-1559">Lorsque l'option de base de données ALLOW_SNAPSHOT_ISOLATION est activée (ON), l'instance du [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] ne génère le contrôle de version de ligne pour les données modifiées que lorsque l'exécution de toutes les transactions actives modifiant les données de la base de données est terminée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1559">When the ALLOW_SNAPSHOT_ISOLATION database option is set ON, the instance of the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] does not generate row versions for modified data until all active transactions that have modified data in the database complete.</span></span> <span data-ttu-id="968d3-1560">En cas de transactions de modification actives, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] affecte à l'option l'état PENDING_ON.</span><span class="sxs-lookup"><span data-stu-id="968d3-1560">If there are active modification transactions, [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] sets the state of the option to PENDING_ON.</span></span> <span data-ttu-id="968d3-1561">Une fois l'exécution des transactions de modification terminées, l'état de l'option passe sur ON.</span><span class="sxs-lookup"><span data-stu-id="968d3-1561">After all of the modification transactions complete, the state of the option is changed to ON.</span></span> <span data-ttu-id="968d3-1562">Les utilisateurs ne peuvent lancer une transaction d'instantané que quand l'option a la valeur ON.</span><span class="sxs-lookup"><span data-stu-id="968d3-1562">Users cannot start a snapshot transaction in that database until the option is fully ON.</span></span> <span data-ttu-id="968d3-1563">La base de données passe par l'état PENDING_OFF lorsque son administrateur affecte à l'option ALLOW_SNAPSHOT_ISOLATION la valeur OFF.</span><span class="sxs-lookup"><span data-stu-id="968d3-1563">The database passes through a PENDING_OFF state when the database administrator sets the ALLOW_SNAPSHOT_ISOLATION option to OFF.</span></span>  
  
 <span data-ttu-id="968d3-1564">L'instruction [!INCLUDE[tsql](../includes/tsql-md.md)] suivante permet la prise en charge de l'option ALLOW_SNAPSHOT_ISOLATION :</span><span class="sxs-lookup"><span data-stu-id="968d3-1564">The following [!INCLUDE[tsql](../includes/tsql-md.md)] statement will enable ALLOW_SNAPSHOT_ISOLATION:</span></span>  
  
```sql  
ALTER DATABASE AdventureWorks2012  
    SET ALLOW_SNAPSHOT_ISOLATION ON;  
```  
  
 <span data-ttu-id="968d3-1565">Le tableau suivant répertorie et décrit les différents états de l'option ALLOW_SNAPSHOT_ISOLATION.</span><span class="sxs-lookup"><span data-stu-id="968d3-1565">The following table lists and describes the states of the ALLOW_SNAPSHOT_ISOLATION option.</span></span> <span data-ttu-id="968d3-1566">L'utilisation de la commande ALTER DATABASE avec l'option ALLOW_SNAPSHOT_ISOLATION ne bloque pas les utilisateurs qui sont en cours d'accès aux données de la base de données.</span><span class="sxs-lookup"><span data-stu-id="968d3-1566">Using ALTER DATABASE with the ALLOW_SNAPSHOT_ISOLATION option does not block users who are currently accessing the database data.</span></span>  
  
|<span data-ttu-id="968d3-1567">État de l'infrastructure d'isolement d'instantané pour la base de données actuelle</span><span class="sxs-lookup"><span data-stu-id="968d3-1567">State of snapshot isolation framework for current database</span></span>|<span data-ttu-id="968d3-1568">Description</span><span class="sxs-lookup"><span data-stu-id="968d3-1568">Description</span></span>|  
|----------------------------------------------------------------|-----------------|  
|<span data-ttu-id="968d3-1569">OFF</span><span class="sxs-lookup"><span data-stu-id="968d3-1569">OFF</span></span>|<span data-ttu-id="968d3-1570">La prise en charge des transactions d'isolement d'instantané n'est pas activée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1570">The support for snapshot isolation transactions is not activated.</span></span> <span data-ttu-id="968d3-1571">Aucune transaction d'isolement d'instantané n'est autorisée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1571">No snapshot isolation transactions are allowed.</span></span>|  
|<span data-ttu-id="968d3-1572">PENDING_ON</span><span class="sxs-lookup"><span data-stu-id="968d3-1572">PENDING_ON</span></span>|<span data-ttu-id="968d3-1573">La prise en charge des transactions d'isolement d'instantané est en état de transition (de OFF à ON).</span><span class="sxs-lookup"><span data-stu-id="968d3-1573">The support for snapshot isolation transactions is in transition state (from OFF to ON).</span></span> <span data-ttu-id="968d3-1574">L'exécution de toutes les transactions ouvertes doit être terminée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1574">Open transactions must complete.</span></span><br /><br /> <span data-ttu-id="968d3-1575">Aucune transaction d'isolement d'instantané n'est autorisée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1575">No snapshot isolation transactions are allowed.</span></span>|  
|<span data-ttu-id="968d3-1576">ACTIVÉ</span><span class="sxs-lookup"><span data-stu-id="968d3-1576">ON</span></span>|<span data-ttu-id="968d3-1577">La prise en charge des transactions d'isolement d'instantané est activée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1577">The support for snapshot isolation transactions is activated.</span></span><br /><br /> <span data-ttu-id="968d3-1578">Les transactions d'isolement d'instantané sont autorisées.</span><span class="sxs-lookup"><span data-stu-id="968d3-1578">Snapshot transactions are allowed.</span></span>|  
|<span data-ttu-id="968d3-1579">PENDING_OFF</span><span class="sxs-lookup"><span data-stu-id="968d3-1579">PENDING_OFF</span></span>|<span data-ttu-id="968d3-1580">La prise en charge des transactions d'isolement d'instantané est en état de transition (de ON à OFF).</span><span class="sxs-lookup"><span data-stu-id="968d3-1580">The support for snapshot isolation transactions is in transition state (from ON to OFF).</span></span><br /><br /> <span data-ttu-id="968d3-1581">Les transactions d'instantané lancées dès ce moment ne peuvent accéder à la base de données.</span><span class="sxs-lookup"><span data-stu-id="968d3-1581">Snapshot transactions started after this time cannot access this database.</span></span> <span data-ttu-id="968d3-1582">Les transactions de mise à jour assument la responsabilité du versioning dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="968d3-1582">Update transactions still pay the cost of versioning in this database.</span></span> <span data-ttu-id="968d3-1583">Les transactions d'instantané existantes peuvent toujours accéder à la base de données sans aucun problème.</span><span class="sxs-lookup"><span data-stu-id="968d3-1583">Existing snapshot transactions can still access this database without a problem.</span></span> <span data-ttu-id="968d3-1584">L'état PENDING_OFF ne passe sur OFF qu'à la fin de l'exécution de toutes les transactions d'instantané activées lorsque l'état d'isolement d'instantané de la base de données correspondait à ON.</span><span class="sxs-lookup"><span data-stu-id="968d3-1584">The state PENDING_OFF does not become OFF until all snapshot transactions that were active when the database snapshot isolation state was ON finish.</span></span>|  
  
 <span data-ttu-id="968d3-1585">Utilisez l'affichage catalogue sys.databases pour déterminer l'état des deux options de contrôle de version de ligne de la base de données.</span><span class="sxs-lookup"><span data-stu-id="968d3-1585">Use the sys.databases catalog view to determine the state of both row versioning database options.</span></span>  
  
 <span data-ttu-id="968d3-1586">Toutes les mises à jour des tables utilisateur et de certaines tables système stocku dans les tables de données master et msdb génère le contrôle de version de ligne.</span><span class="sxs-lookup"><span data-stu-id="968d3-1586">All updates to user tables and some system tables stored in master and msdb generate row versions.</span></span>  
  
 <span data-ttu-id="968d3-1587">L'option ALLOW_SNAPSHOT_ISOLATION est automatiquement activée (ON) dans les bases de données master et msdb. Elle ne peut être désactivée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1587">The ALLOW_SNAPSHOT_ISOLATION option is automatically set ON in the master and msdb databases, and cannot be disabled.</span></span>  
  
 <span data-ttu-id="968d3-1588">Les bases de données master, tempdb et msdb ne permettent pas aux utilisateurs d'affecter à l'option READ_COMMITED_SNAPSHOT la valeur ON.</span><span class="sxs-lookup"><span data-stu-id="968d3-1588">Users cannot set the READ_COMMITTED_SNAPSHOT option ON in master, tempdb, or msdb.</span></span>  
  
### <a name="using-row-versioning-based-isolation-levels"></a><span data-ttu-id="968d3-1589">Utilisation de niveaux d'isolement basés sur le contrôle de version de ligne</span><span class="sxs-lookup"><span data-stu-id="968d3-1589">Using Row Versioning-based Isolation Levels</span></span>  

 <span data-ttu-id="968d3-1590">L'infrastructure de contrôle de version de ligne est toujours activée dans [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] et est utilisée par plusieurs fonctionnalités.</span><span class="sxs-lookup"><span data-stu-id="968d3-1590">The row versioning framework is always enabled in [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], and is used by multiple features.</span></span> <span data-ttu-id="968d3-1591">En plus de fournir des niveaux d'isolement basés sur le contrôle de version de ligne, elle permet la prise en charge des modifications apportées aux déclencheurs et aux sessions MARS (Multiple Active Result Sets), ainsi que la prise en charge des lectures de données pour les opérations d'index ONLINE.</span><span class="sxs-lookup"><span data-stu-id="968d3-1591">Besides providing row versioning-based isolation levels, it is used to support modifications made in triggers and multiple active result sets (MARS) sessions, and to support data reads for ONLINE index operations.</span></span>  
  
 <span data-ttu-id="968d3-1592">Les niveaux d'isolement basés sur le contrôle de version de ligne sont activés au niveau de la base de données.</span><span class="sxs-lookup"><span data-stu-id="968d3-1592">Row versioning-based isolation levels are enabled at the database level.</span></span> <span data-ttu-id="968d3-1593">Toute application accédant à des objets de bases de données activées peut exécuter des requêtes en utilisant les niveaux d'isolement suivants :</span><span class="sxs-lookup"><span data-stu-id="968d3-1593">Any application accessing objects from enabled databases can run queries using the following isolation levels:</span></span>  
  
-   <span data-ttu-id="968d3-1594">READCOMMITTED (lu-validé) avec utilisation du contrôle de version de ligne par l'activation de l'option de base de données `READ_COMMITTED_SNAPSHOT` (valeur `ON`) comme illustré dans l'exemple de code suivant :</span><span class="sxs-lookup"><span data-stu-id="968d3-1594">Read-committed that uses row versioning by setting the `READ_COMMITTED_SNAPSHOT` database option to `ON` as shown in the following code example:</span></span>  
  
    ```sql  
    ALTER DATABASE AdventureWorks2012  
        SET READ_COMMITTED_SNAPSHOT ON;  
    ```  
  
     <span data-ttu-id="968d3-1595">Lorsque l'option READ_COMMITTED_SNAPSHOT est activée pour la base de données, toutes les requêtes s'exécutant sous le niveau d'isolement READCOMMITTED utilisent le contrôle de version de ligne, ce qui signifie que les opérations de lecture ne bloquent pas les opérations de mise à jour.</span><span class="sxs-lookup"><span data-stu-id="968d3-1595">When the database is enabled for READ_COMMITTED_SNAPSHOT, all queries running under the read committed isolation level use row versioning, which means that read operations do not block update operations.</span></span>  
  
-   <span data-ttu-id="968d3-1596">Niveau d'isolement d'instantané en définissant l'option de base de données `ALLOW_SNAPSHOT_ISOLATION` avec la valeur `ON` comme illustré dans l'exemple de code suivant :</span><span class="sxs-lookup"><span data-stu-id="968d3-1596">Snapshot isolation by setting the `ALLOW_SNAPSHOT_ISOLATION` database option to `ON` as shown in the following code example:</span></span>  
  
    ```sql  
    ALTER DATABASE AdventureWorks2012  
        SET ALLOW_SNAPSHOT_ISOLATION ON;  
    ```  
  
     <span data-ttu-id="968d3-1597">Une transaction s'exécutant sous le niveau d'isolement d'instantané (SNAPSHOT) peut accéder aux tables de la base de données qui ont été activées pour les instantanés.</span><span class="sxs-lookup"><span data-stu-id="968d3-1597">A transaction running under snapshot isolation can access tables in the database that have been enabled for snapshot.</span></span> <span data-ttu-id="968d3-1598">Pour accéder aux tables qui n'ont pas été activées pour les instantanés, le niveau d'isolement doit être modifié.</span><span class="sxs-lookup"><span data-stu-id="968d3-1598">To access tables that have not been enabled for snapshot, the isolation level must be changed.</span></span> <span data-ttu-id="968d3-1599">Ainsi, dans l'exemple de code suivant, une instruction `SELECT` exécutée dans le cadre d'une transaction d'instantané joint deux tables.</span><span class="sxs-lookup"><span data-stu-id="968d3-1599">For example, the following code example shows a `SELECT` statement that joins two tables while running under a snapshot transaction.</span></span> <span data-ttu-id="968d3-1600">Une table appartient à une base de données dans laquelle le niveau d'isolement d'instantané (SNAPSHOT) n'est pas activé.</span><span class="sxs-lookup"><span data-stu-id="968d3-1600">One table belongs to a database in which snapshot isolation is not enabled.</span></span> <span data-ttu-id="968d3-1601">Lorsque l'instruction `SELECT` s'exécute sous le niveau d'isolement d'instantané, elle échoue.</span><span class="sxs-lookup"><span data-stu-id="968d3-1601">When the `SELECT` statement runs under snapshot isolation, it fails to execute successfully.</span></span>  
  
    ```sql  
    SET TRANSACTION ISOLATION LEVEL SNAPSHOT;  
    BEGIN TRAN  
        SELECT t1.col5, t2.col5  
            FROM Table1 as t1  
            INNER JOIN SecondDB.dbo.Table2 as t2  
                ON t1.col1 = t2.col2;  
    ```  
  
     <span data-ttu-id="968d3-1602">Dans l'exemple de code suivant, la même instruction `SELECT` a été modifiée pour faire passer le niveau d'isolation de la transaction à READCOMMITTED (lu-validé).</span><span class="sxs-lookup"><span data-stu-id="968d3-1602">The following code example shows the same `SELECT` statement that has been modified to change the transaction isolation level to read-committed.</span></span> <span data-ttu-id="968d3-1603">Grâce à cette modification, l'exécution de l'instruction `SELECT` aboutit.</span><span class="sxs-lookup"><span data-stu-id="968d3-1603">Because of this change, the `SELECT` statement executes successfully.</span></span>  
  
    ```sql  
    SET TRANSACTION ISOLATION LEVEL SNAPSHOT;  
    BEGIN TRAN  
        SELECT t1.col5, t2.col5  
            FROM Table1 as t1  
            WITH (READCOMMITTED)  
            INNER JOIN SecondDB.dbo.Table2 as t2  
                ON t1.col1 = t2.col2;  
    ```  
  
#### <a name="limitations-of-transactions-using-row-versioning-based-isolation-levels"></a><span data-ttu-id="968d3-1604">Limites liées aux transactions utilisant les niveaux d'isolement basés sur le contrôle de version de ligne</span><span class="sxs-lookup"><span data-stu-id="968d3-1604">Limitations of Transactions Using Row Versioning-based Isolation Levels</span></span>  

 <span data-ttu-id="968d3-1605">Tenez compte des limites suivantes lors de l'utilisation des niveaux d'isolement basés sur le contrôle de version de ligne :</span><span class="sxs-lookup"><span data-stu-id="968d3-1605">Consider the following limitations when working with row versioning-based isolation levels:</span></span>  
  
-   <span data-ttu-id="968d3-1606">READ_COMMITTED_SNAPSHOT ne peut pas être activé dans les bases de données tempdb, msdb et master.</span><span class="sxs-lookup"><span data-stu-id="968d3-1606">READ_COMMITTED_SNAPSHOT cannot be enabled in tempdb, msdb, or master.</span></span>  
  
-   <span data-ttu-id="968d3-1607">Les tables temporaires globales sont stockées dans tempdb.</span><span class="sxs-lookup"><span data-stu-id="968d3-1607">Global temp tables are stored in tempdb.</span></span> <span data-ttu-id="968d3-1608">Si une transaction d'instantané implique l'accès à des tables temporaires globales, vous devez effectuer l'une des opérations suivantes :</span><span class="sxs-lookup"><span data-stu-id="968d3-1608">When accessing global temp tables inside a snapshot transaction, one of the following must happen:</span></span>  
  
    -   <span data-ttu-id="968d3-1609">Définir l'option de base de données ALLOW_SNAPSHOT_ISOLATION sur ON (activé) dans tempdb.</span><span class="sxs-lookup"><span data-stu-id="968d3-1609">Set the ALLOW_SNAPSHOT_ISOLATION database option ON in tempdb.</span></span>  
  
    -   <span data-ttu-id="968d3-1610">Utilisez un indicateur d'isolement afin de modifier le niveau d'isolement pour l'instruction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1610">Use an isolation hint to change the isolation level for the statement.</span></span>  
  
-   <span data-ttu-id="968d3-1611">Les transactions d'instantané échouent dans les cas suivants :</span><span class="sxs-lookup"><span data-stu-id="968d3-1611">Snapshot transactions fail when:</span></span>  
  
    -   <span data-ttu-id="968d3-1612">Une base de données est passée en lecture seule après que la transaction d'instantané ait démarré, mais avant que celle-ci ait accédé à la base de données.</span><span class="sxs-lookup"><span data-stu-id="968d3-1612">A database is made read-only after the snapshot transaction starts, but before the snapshot transaction accesses the database.</span></span>  
  
    -   <span data-ttu-id="968d3-1613">S'il y a eu accès à des objets de plusieurs bases de données, l'état d'une base de données a été modifié au point qu'une récupération de base de données a eu lieu après que la transaction d'instantané ait démarré, mais avant que celle-ci ait accédé à la base de données.</span><span class="sxs-lookup"><span data-stu-id="968d3-1613">If accessing objects from multiple databases, a database state was changed in such a way that database recovery occurred after a snapshot transaction starts, but before the snapshot transaction accesses the database.</span></span> <span data-ttu-id="968d3-1614">Par exemple, la base de données a été définie sur OFFLINE puis sur ONLINE, la base de données s'est fermée automatiquement puis rouverte, ou elle s'est détachée puis rattachée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1614">For example: the database was set to OFFLINE and then to ONLINE, database autoclose and open, or database detach and attach.</span></span>  
  
-   <span data-ttu-id="968d3-1615">Les transactions distribuées, notamment les requêtes dans les bases de données partitionnées distribuées, ne sont pas prises en charge sous le niveau d'isolement d'instantané.</span><span class="sxs-lookup"><span data-stu-id="968d3-1615">Distributed transactions, including queries in distributed partitioned databases, are not supported under snapshot isolation.</span></span>  
  
-   [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] <span data-ttu-id="968d3-1616">ne conserve pas plusieurs versions des métadonnées système.</span><span class="sxs-lookup"><span data-stu-id="968d3-1616">does not keep multiple versions of system metadata.</span></span> <span data-ttu-id="968d3-1617">Les instructions DDL (Data Definition Language) portant sur des tables et autres objets de base de données (index, vues, types de données, procédures stockées et fonctions CLR (Common Language Runtime)) modifient les métadonnées.</span><span class="sxs-lookup"><span data-stu-id="968d3-1617">Data definition language (DDL) statements on tables and other database objects (indexes, views, data types, stored procedures, and common language runtime functions) change metadata.</span></span> <span data-ttu-id="968d3-1618">Si une instruction DDL modifie un objet, toute référence simultanée à l'objet sous le niveau d'isolement d'instantané entraînera l'échec de la transaction d'instantané.</span><span class="sxs-lookup"><span data-stu-id="968d3-1618">If a DDL statement modifies an object, any concurrent reference to the object under snapshot isolation causes the snapshot transaction to fail.</span></span> <span data-ttu-id="968d3-1619">Les transactions READCOMMITTED (lu-validé) ne présentent pas cette limitation lorsque l'option de base de données READ_COMMITTED_SNAPSHOT est activée (valeur ON).</span><span class="sxs-lookup"><span data-stu-id="968d3-1619">Read-committed transactions do not have this limitation when the READ_COMMITTED_SNAPSHOT database option is ON.</span></span>  
  
     <span data-ttu-id="968d3-1620">Supposons, par exemple, qu'un administrateur de base de données exécute l'instruction `ALTER INDEX` suivante.</span><span class="sxs-lookup"><span data-stu-id="968d3-1620">For example, a database administrator executes the following `ALTER INDEX` statement.</span></span>  
  
    ```sql  
    USE AdventureWorks2012;  
    GO  
    ALTER INDEX AK_Employee_LoginID  
        ON HumanResources.Employee REBUILD;  
    GO  
    ```  
  
     <span data-ttu-id="968d3-1621">Toute transaction d'instantané qui est active au moment de l'exécution de l'instruction `ALTER INDEX` recevra une erreur si elle tente de faire référence à la table `HumanResources.Employee` après l'exécution de l'instruction `ALTER INDEX`.</span><span class="sxs-lookup"><span data-stu-id="968d3-1621">Any snapshot transaction that is active when the `ALTER INDEX` statement is executed receives an error if it attempts to reference the `HumanResources.Employee` table after the `ALTER INDEX` statement is executed.</span></span> <span data-ttu-id="968d3-1622">Les transactions READCOMMITTED (lu-validé) utilisant le contrôle de version de ligne ne sont pas affectées.</span><span class="sxs-lookup"><span data-stu-id="968d3-1622">Read-committed transactions using row versioning are not affected.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="968d3-1623">Les opérations BULK INSERT peuvent entraîner des modifications au niveau des métadonnées de la table cible (par exemple, lors de la désactivation des vérifications de contraintes).</span><span class="sxs-lookup"><span data-stu-id="968d3-1623">BULK INSERT operations may cause changes to target table metadata (for example, when disabling constraint checks).</span></span> <span data-ttu-id="968d3-1624">Dans ce cas, les transactions simultanées d'isolement d'instantané qui accèdent à des tables faisant l'objet d'insertion en bloc échouent.</span><span class="sxs-lookup"><span data-stu-id="968d3-1624">When this happens, concurrent snapshot isolation transactions accessing bulk inserted tables fail.</span></span>  
  
 <span data-ttu-id="968d3-1625">![Icône de flèche utilisée avec le lien retour au début](media/uparrow16x16.gif "Icône de flèche utilisée avec le lien Retour en haut") [dans ce guide](#Top)</span><span class="sxs-lookup"><span data-stu-id="968d3-1625">![Arrow icon used with Back to Top link](media/uparrow16x16.gif "Arrow icon used with Back to Top link") [In This Guide](#Top)</span></span>  
  
## <a name="customizing-locking-and-row-versioning"></a><span data-ttu-id="968d3-1626">Personnalisation du verrouillage et du contrôle de version de ligne</span><span class="sxs-lookup"><span data-stu-id="968d3-1626">Customizing Locking and Row Versioning</span></span>  
  
### <a name="customizing-the-lock-time-out"></a><span data-ttu-id="968d3-1627">Personnalisation du délai d'attente de verrouillage</span><span class="sxs-lookup"><span data-stu-id="968d3-1627">Customizing the Lock Time-Out</span></span>  

 <span data-ttu-id="968d3-1628">Quand une instance du [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] [!INCLUDE[msCoName](../includes/msconame-md.md)] ne peut pas accorder un verrou à une transaction, car une autre transaction a déjà un verrou en conflit dans la ressource, la première transaction se bloque, dans l’attente de la libération du verrou existant.</span><span class="sxs-lookup"><span data-stu-id="968d3-1628">When an instance of the [!INCLUDE[msCoName](../includes/msconame-md.md)] [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] cannot grant a lock to a transaction because another transaction already owns a conflicting lock on the resource, the first transaction becomes blocked waiting for the existing lock to be released.</span></span> <span data-ttu-id="968d3-1629">Par défaut, il n'existe pas de délai d'expiration obligatoire et aucun moyen de tester si une ressource est déjà verrouillée avant de la verrouiller, excepté par une tentative d'accès aux données (avec un risque de blocage infini).</span><span class="sxs-lookup"><span data-stu-id="968d3-1629">By default, there is no mandatory time-out period and no way to test whether a resource is locked before locking it, except to attempt to access the data (and potentially get blocked indefinitely).</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="968d3-1630">Dans [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], utilisez la vue de gestion dynamique **sys.dm_os_waiting_tasks** pour déterminer si un processus est bloqué et identifier l’auteur du blocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-1630">In [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], use the **sys.dm_os_waiting_tasks** dynamic management view to determine whether a process is being blocked and who is blocking it.</span></span> <span data-ttu-id="968d3-1631">Dans les versions antérieures de [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], utilisez la procédure stockée système **sp_who**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1631">In earlier versions of [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], use the **sp_who** system stored procedure.</span></span>  
  
 <span data-ttu-id="968d3-1632">Le paramètre LOCK_TIMEOUT permet à une application de définir la durée maximale pendant laquelle une instruction reste en attente sur une ressource bloquée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1632">The LOCK_TIMEOUT setting allows an application to set a maximum time that a statement waits on a blocked resource.</span></span> <span data-ttu-id="968d3-1633">Si l'attente d'une instruction dépasse la valeur du paramètre LOCK_TIMEOUT, l'instruction bloquée est automatiquement annulée, et le message d'erreur 1222 (`Lock request time-out period exceeded`) retourné à l'application.</span><span class="sxs-lookup"><span data-stu-id="968d3-1633">When a statement has waited longer than the LOCK_TIMEOUT setting, the blocked statement is canceled automatically, and error message 1222 (`Lock request time-out period exceeded`) is returned to the application.</span></span> <span data-ttu-id="968d3-1634">Toute transaction contenant la commande n'est toutefois pas restaurée ou annulée par [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="968d3-1634">Any transaction containing the statement, however, is not rolled back or canceled by [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="968d3-1635">L'application doit donc posséder un gestionnaire d'erreurs capable d'intercepter le message d'erreur 1222.</span><span class="sxs-lookup"><span data-stu-id="968d3-1635">Therefore, the application must have an error handler that can trap error message 1222.</span></span> <span data-ttu-id="968d3-1636">Si une application ne gère pas cette erreur, elle peut continuer en ignorant que l'une des instructions de la transaction a été annulée. Des erreurs peuvent se produire lorsque les instructions ultérieures dans la transaction dépendent de l'instruction qui n'a jamais été exécutée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1636">If an application does not trap the error, the application can proceed unaware that an individual statement within a transaction has been canceled, and errors can occur because statements later in the transaction might depend on the statement that was never executed.</span></span>  
  
 <span data-ttu-id="968d3-1637">L'implémentation d'un gestionnaire d'erreurs qui intercepte le message d'erreur 1222 permet à une application de prendre les mesures conséquentes au délai d'expiration, par exemple soumettre à nouveau l'instruction qui été bloquée ou restaurer toute la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1637">Implementing an error handler that traps error message 1222 allows an application to handle the time-out situation and take remedial action, such as: automatically resubmitting the statement that was blocked or rolling back the entire transaction.</span></span>  
  
 <span data-ttu-id="968d3-1638">Pour déterminer le paramètre de LOCK_TIMEOUT actuel, exécutez la @LOCK_TIMEOUT fonction @ :</span><span class="sxs-lookup"><span data-stu-id="968d3-1638">To determine the current LOCK_TIMEOUT setting, execute the @@LOCK_TIMEOUT function:</span></span>  
  
```sql  
SELECT @@lock_timeout;  
GO  
```  
  
### <a name="customizing-transaction-isolation-level"></a><span data-ttu-id="968d3-1639">Personnalisation du niveau d'isolation des transactions</span><span class="sxs-lookup"><span data-stu-id="968d3-1639">Customizing Transaction Isolation Level</span></span>  

 <span data-ttu-id="968d3-1640">READ COMMITTED est le niveau d’isolation par défaut pour le [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] [!INCLUDE[msCoName](../includes/msconame-md.md)].</span><span class="sxs-lookup"><span data-stu-id="968d3-1640">READ COMMITTED is the default isolation level for the [!INCLUDE[msCoName](../includes/msconame-md.md)] [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)].</span></span> <span data-ttu-id="968d3-1641">Si une application doit fonctionner à un niveau d'isolation différent, elle peut le définir selon plusieurs méthodes :</span><span class="sxs-lookup"><span data-stu-id="968d3-1641">If an application must operate at a different isolation level, it can use the following methods to set the isolation level:</span></span>  
  
-   <span data-ttu-id="968d3-1642">Exécuter l’instruction [SET TRANSACTION ISOLATION LEVEL](/sql/t-sql/statements/set-transaction-isolation-level-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="968d3-1642">Run the [SET TRANSACTION ISOLATION LEVEL](/sql/t-sql/statements/set-transaction-isolation-level-transact-sql) statement.</span></span>  
  
-   <span data-ttu-id="968d3-1643">Les applications ADO.NET utilisant l’espace de noms managé System.Data.SqlClient peuvent indiquer une option *IsolationLevel* via la méthode SqlConnection.BeginTransaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1643">ADO.NET applications that use the System.Data.SqlClient managed namespace can specify an *IsolationLevel* option by using the SqlConnection.BeginTransaction method.</span></span>  
  
-   <span data-ttu-id="968d3-1644">Les applications qui utilisent ADO peuvent définir la propriété `Autocommit Isolation Levels`.</span><span class="sxs-lookup"><span data-stu-id="968d3-1644">Applications that use ADO can set the `Autocommit Isolation Levels` property.</span></span>  
  
-   <span data-ttu-id="968d3-1645">Lors du lancement d’une transaction, les applications utilisant OLE DB peuvent appeler ITransactionLocal::StartTransaction avec le paramètre *isoLevel* défini sur le niveau d’isolation de la transaction souhaité.</span><span class="sxs-lookup"><span data-stu-id="968d3-1645">When starting a transaction, applications using OLE DB can call ITransactionLocal::StartTransaction with *isoLevel* set to the desired transaction isolation level.</span></span> <span data-ttu-id="968d3-1646">Lorsque vous spécifiez le niveau d'isolation en mode de validation automatique, les applications utilisant OLE DB peuvent affecter à la propriété DBPROP_SESS_AUTOCOMMITISOLEVELS de DBPROPSET_SESSION la valeur de niveau d'isolation de la transaction souhaitée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1646">When specifying the isolation level in autocommit mode, applications that use OLE DB can set the DBPROPSET_SESSION property DBPROP_SESS_AUTOCOMMITISOLEVELS to the desired transaction isolation level.</span></span>  
  
-   <span data-ttu-id="968d3-1647">Les applications qui utilisent ODBC peuvent définir l’attribut SQL_COPT_SS_TXN_ISOLATION à l’aide de SQLSetConnectAttr.</span><span class="sxs-lookup"><span data-stu-id="968d3-1647">Applications that use ODBC can set the SQL_COPT_SS_TXN_ISOLATION attribute by using SQLSetConnectAttr.</span></span>  
  
 <span data-ttu-id="968d3-1648">Lorsque le niveau d'isolation est spécifié, le verrouillage s'applique à ce niveau d'isolation, à toutes les requêtes et instructions DML de la session [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="968d3-1648">When the isolation level is specified, the locking behavior for all queries and data manipulation language (DML) statements in the [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] session operates at that isolation level.</span></span> <span data-ttu-id="968d3-1649">Le niveau d'isolation reste en vigueur jusqu'à la fin de la session ou jusqu'à ce qu'il soit modifié.</span><span class="sxs-lookup"><span data-stu-id="968d3-1649">The isolation level remains in effect until the session terminates or until the isolation level is set to another level.</span></span>  
  
 <span data-ttu-id="968d3-1650">L'exemple suivant montre comment définir le niveau d'isolation `SERIALIZABLE` :</span><span class="sxs-lookup"><span data-stu-id="968d3-1650">The following example sets the `SERIALIZABLE` isolation level:</span></span>  
  
```sql  
USE AdventureWorks2012;  
GO  
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;  
GO  
BEGIN TRANSACTION;  
SELECT BusinessEntityID  
    FROM HumanResources.Employee;  
GO  
```  
  
 <span data-ttu-id="968d3-1651">Le niveau d'isolation peut être remplacé si nécessaire pour des requêtes ou des instructions DML individuelles, en spécifiant un indicateur de niveau table.</span><span class="sxs-lookup"><span data-stu-id="968d3-1651">The isolation level can be overridden for individual query or DML statements, if necessary, by specifying a table-level hint.</span></span> <span data-ttu-id="968d3-1652">Un indicateur de niveau table n'affecte pas les autres instructions de la session.</span><span class="sxs-lookup"><span data-stu-id="968d3-1652">Specifying a table-level hint does not affect other statements in the session.</span></span> <span data-ttu-id="968d3-1653">Il est recommandé de n'utiliser les indicateurs de niveau table pour modifier le comportement par défaut qu'en cas d'absolue nécessité.</span><span class="sxs-lookup"><span data-stu-id="968d3-1653">We recommend that table-level hints be used to change the default behavior only when absolutely necessary.</span></span>  
  
 <span data-ttu-id="968d3-1654">Le [!INCLUDE[ssDE](../includes/ssde-md.md)] peut être obligé d’acquérir des verrous lors de la lecture de métadonnées même si le niveau d’isolation est tel que les verrous partagés ne sont pas nécessaires pendant la lecture des données.</span><span class="sxs-lookup"><span data-stu-id="968d3-1654">The [!INCLUDE[ssDE](../includes/ssde-md.md)] might have to acquire locks when reading metadata even when the isolation level is set to a level where share locks are not requested when reading data.</span></span> <span data-ttu-id="968d3-1655">Par exemple, une transaction qui s'exécute au niveau d'isolation READ UNCOMMITTED n'acquiert pas de verrous partagés pendant la lecture de données, mais elle peut en demander quelquefois lors de la lecture d'un affichage catalogue système.</span><span class="sxs-lookup"><span data-stu-id="968d3-1655">For example, a transaction running at the read-uncommitted isolation level does not acquire share locks when reading data, but might sometime request locks when reading a system catalog view.</span></span> <span data-ttu-id="968d3-1656">Autrement dit, une transaction de lecture non validée peut provoquer un blocage si elle interroge une table pendant qu'une transaction modifie simultanément les données de cette table.</span><span class="sxs-lookup"><span data-stu-id="968d3-1656">This means it is possible for a read uncommitted transaction to cause blocking when querying a table when a concurrent transaction is modifying the metadata of that table.</span></span>  
  
 <span data-ttu-id="968d3-1657">Pour déterminer le niveau d'isolation des transactions en cours, utilisez l'instruction `DBCC USEROPTIONS` comme dans l'exemple qui suit.</span><span class="sxs-lookup"><span data-stu-id="968d3-1657">To determine the transaction isolation level currently set, use the `DBCC USEROPTIONS` statement as shown in the following example.</span></span> <span data-ttu-id="968d3-1658">Le jeu de résultats peut être différent sur votre système.</span><span class="sxs-lookup"><span data-stu-id="968d3-1658">The result set may vary from the result set on your system.</span></span>  
  
```sql  
USE AdventureWorks2012;  
GO  
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;  
GO  
DBCC USEROPTIONS;  
GO  
```  
  
 [!INCLUDE[ssResult](../includes/ssresult-md.md)]  
  
 `Set Option                   Value`  
  
 `---------------------------- -------------------------------------------`  
  
 `textsize                     2147483647`  
  
 `language                     us_english`  
  
 `dateformat                   mdy`  
  
 `datefirst                    7`  
  
 `...                          ...`  
  
 `Isolation level              repeatable read`  
  
 ``  
  
 `(14 row(s) affected)`  
  
 ``  
  
 `DBCC execution completed. If DBCC printed error messages, contact your system administrator.`  
  
### <a name="locking-hints"></a><span data-ttu-id="968d3-1659">Indicateurs de verrouillage</span><span class="sxs-lookup"><span data-stu-id="968d3-1659">Locking Hints</span></span>  

 <span data-ttu-id="968d3-1660">Il est possible de spécifier des indicateurs de verrouillage pour des références de table individuelles dans les instructions SELECT, INSERT, UPDATE et DELETE.</span><span class="sxs-lookup"><span data-stu-id="968d3-1660">Locking hints can be specified for individual table references in the SELECT, INSERT, UPDATE, and DELETE statements.</span></span> <span data-ttu-id="968d3-1661">Ces indicateurs déterminent le type de verrouillage ou de contrôle de version de ligne qu’utilise l’instance du [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] pour les données de la table.</span><span class="sxs-lookup"><span data-stu-id="968d3-1661">The hints specify the type of locking or row versioning the instance of the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] uses for the table data.</span></span> <span data-ttu-id="968d3-1662">Les indicateurs de verrouillage au niveau des tables peuvent être utilisés pour un contrôle plus fin des types de verrous acquis sur un objet.</span><span class="sxs-lookup"><span data-stu-id="968d3-1662">Table-level locking hints can be used when a finer control of the types of locks acquired on an object is required.</span></span> <span data-ttu-id="968d3-1663">Ces options de verrouillage remplacent le niveau d'isolement courant de la transaction pour la session.</span><span class="sxs-lookup"><span data-stu-id="968d3-1663">These locking hints override the current transaction isolation level for the session.</span></span>  
  
 <span data-ttu-id="968d3-1664">Pour plus d’informations sur les indicateurs de verrouillage spécifiques et leurs comportements, consultez [Indicateurs de table &#40;Transact-SQL&#41;](/sql/t-sql/queries/hints-transact-sql-table).</span><span class="sxs-lookup"><span data-stu-id="968d3-1664">For more information about the specific locking hints and their behaviors, see [Table Hints &#40;Transact-SQL&#41;](/sql/t-sql/queries/hints-transact-sql-table).</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="968d3-1665">L'optimiseur de requête du [!INCLUDE[ssDE](../includes/ssde-md.md)] choisit presque toujours le niveau de verrouillage correct.</span><span class="sxs-lookup"><span data-stu-id="968d3-1665">The [!INCLUDE[ssDE](../includes/ssde-md.md)] query optimizer almost always chooses the correct locking level.</span></span> <span data-ttu-id="968d3-1666">Nous vous recommandons d'utiliser les indicateurs de verrouillage au niveau des tables à la place du verrouillage par défaut seulement lorsque cela est nécessaire.</span><span class="sxs-lookup"><span data-stu-id="968d3-1666">We recommend that table-level locking hints be used to change the default locking behavior only when necessary.</span></span> <span data-ttu-id="968d3-1667">La désactivation d'un niveau de verrouillage peut affecter défavorablement la concurrence d'accès.</span><span class="sxs-lookup"><span data-stu-id="968d3-1667">Disallowing a locking level can adversely affect concurrency.</span></span>  
  
 <span data-ttu-id="968d3-1668">Il se peut que le [!INCLUDE[ssDE](../includes/ssde-md.md)] doive obtenir des verrous lors de la lecture de métadonnées, même lors du traitement d'une sélection avec un indicateur de verrouillage qui empêche les demandes de verrous de partage lors de la lecture de données.</span><span class="sxs-lookup"><span data-stu-id="968d3-1668">The [!INCLUDE[ssDE](../includes/ssde-md.md)] might have to acquire locks when reading metadata, even when processing a select with a locking hint that prevents requests for share locks when reading data.</span></span> <span data-ttu-id="968d3-1669">Par exemple, une instruction SELECT qui utilise le verrou NOLOCK n'obtient pas de verrous de partage lors de la lecture de données, mais elle peut occasionnellement demander des verrous lorsqu'elle lit un affichage catalogue système.</span><span class="sxs-lookup"><span data-stu-id="968d3-1669">For example, a SELECT using the NOLOCK hint does not acquire share locks when reading data, but might sometime request locks when reading a system catalog view.</span></span> <span data-ttu-id="968d3-1670">Cela signifie qu'il est possible qu'une instruction SELECT utilisant NOLOCK soit bloquée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1670">This means it is possible for a SELECT statement using NOLOCK to be blocked.</span></span>  
  
 <span data-ttu-id="968d3-1671">Comme l'illustre l'exemple suivant, si le niveau d'isolement d'une transaction est `SERIALIZABLE` et que l'indicateur de verrouillage `NOLOCK` au niveau des tables est utilisé avec l'instruction `SELECT`, les verrous de clé habituellement utilisés pour préserver des transactions sérialisables ne sont pas appliqués.</span><span class="sxs-lookup"><span data-stu-id="968d3-1671">As shown in the following example, if the transaction isolation level is set to `SERIALIZABLE`, and the table-level locking hint `NOLOCK` is used with the `SELECT` statement, key-range locks typically used to maintain serializable transactions are not taken.</span></span>  
  
```sql  
USE AdventureWorks2012;  
GO  
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;  
GO  
BEGIN TRANSACTION;  
GO  
SELECT JobTitle  
    FROM HumanResources.Employee WITH (NOLOCK);  
GO  
  
-- Get information about the locks held by   
-- the transaction.  
SELECT    
        resource_type,   
        resource_subtype,   
        request_mode  
    FROM sys.dm_tran_locks  
    WHERE request_session_id = @@spid;  
  
-- End the transaction.  
ROLLBACK;  
GO  
```  
  
 <span data-ttu-id="968d3-1672">Le seul verrou appliqué faisant référence à `HumanResources.Employee` est le verrou de stabilité de schéma (Sch-S).</span><span class="sxs-lookup"><span data-stu-id="968d3-1672">The only lock taken that references `HumanResources.Employee` is a schema stability (Sch-S) lock.</span></span> <span data-ttu-id="968d3-1673">Dans ce cas, la possibilité de sérialisation n'est plus garantie.</span><span class="sxs-lookup"><span data-stu-id="968d3-1673">In this case, serializability is no longer guaranteed.</span></span>  
  
 <span data-ttu-id="968d3-1674">Dans [!INCLUDE[ssCurrent](../includes/sscurrent-md.md)], l'option LOCK_ESCALATION de l'instruction ALTER TABLE peut défavoriser des verrous de table et activer des verrous HoBT sur des tables partitionnées.</span><span class="sxs-lookup"><span data-stu-id="968d3-1674">In [!INCLUDE[ssCurrent](../includes/sscurrent-md.md)], the LOCK_ESCALATION option of ALTER TABLE can disfavor table locks, and enable HoBT locks on partitioned tables.</span></span> <span data-ttu-id="968d3-1675">Cette option n'est pas un indicateur de verrouillage, mais elle peut servir à réduire l'escalade de verrous.</span><span class="sxs-lookup"><span data-stu-id="968d3-1675">This option is not a locking hint, but can but used to reduce lock escalation.</span></span> <span data-ttu-id="968d3-1676">Pour plus d’informations, consultez [ALTER TABLE &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-table-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="968d3-1676">For more information, see [ALTER TABLE &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-table-transact-sql).</span></span>  
  
###  <a name="customizing-locking-for-an-index"></a><a name="Customize"></a> <span data-ttu-id="968d3-1677">Personnalisation du verrouillage pour un index</span><span class="sxs-lookup"><span data-stu-id="968d3-1677">Customizing Locking for an Index</span></span>  

 <span data-ttu-id="968d3-1678">Dans la plupart des cas, le [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] utilise une stratégie de verrouillage dynamique qui choisit automatiquement la granularité de verrouillage la plus appropriée pour les requêtes.</span><span class="sxs-lookup"><span data-stu-id="968d3-1678">The [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] uses a dynamic locking strategy that automatically chooses the best locking granularity for queries in most cases.</span></span> <span data-ttu-id="968d3-1679">Nous vous recommandons de ne pas remplacer les niveaux de verrouillage par défaut, pour lesquels le verrouillage de page et de ligne est activé, sauf si les modèles d'accès à la table ou à l'index sont bien assimilés et cohérents et s'il existe une contention de ressources à résoudre.</span><span class="sxs-lookup"><span data-stu-id="968d3-1679">We recommend that you do not override the default locking levels, which have page and row locking on, unless table or index access patterns are well understood and consistent, and there is a resource contention problem to solve.</span></span> <span data-ttu-id="968d3-1680">Le remplacement d’un niveau de verrouillage peut affecter considérablement les accès simultanés à une table ou un index.</span><span class="sxs-lookup"><span data-stu-id="968d3-1680">Overriding a locking level can significantly impede concurrent access to a table or index.</span></span> <span data-ttu-id="968d3-1681">Par exemple, la spécification de verrous de niveau table uniquement sur une table de grande taille à laquelle les utilisateurs accèdent fréquemment peut provoquer des goulets d’étranglement, car les utilisateurs doivent attendre que le verrou de niveau table soit libéré avant de pouvoir accéder à la table.</span><span class="sxs-lookup"><span data-stu-id="968d3-1681">For example, specifying only table-level locks on a large table that users access heavily can cause bottlenecks because users must wait for the table-level lock to be released before accessing the table.</span></span>  
  
 <span data-ttu-id="968d3-1682">Il existe quelques cas où l'interdiction du verrouillage de page ou de ligne peut être avantageuse, à condition que les modèles d'accès soient bien assimilés et cohérents.</span><span class="sxs-lookup"><span data-stu-id="968d3-1682">There are a few cases where disallowing page or row locking can be beneficial, if the access patterns are well understood and consistent.</span></span> <span data-ttu-id="968d3-1683">Par exemple, une application de base de données utilise une table de recherche mise à jour chaque semaine via un processus par lot.</span><span class="sxs-lookup"><span data-stu-id="968d3-1683">For example, a database application uses a lookup table that is updated weekly in a batch process.</span></span> <span data-ttu-id="968d3-1684">Les lecteurs simultanés accèdent à la table avec un verrou partagé (S) et la mise à jour par lot hebdomadaire accède à la table avec un verrou exclusif (X).</span><span class="sxs-lookup"><span data-stu-id="968d3-1684">Concurrent readers access the table with a shared (S) lock and the weekly batch update accesses the table with an exclusive (X) lock.</span></span> <span data-ttu-id="968d3-1685">La désactivation du verrouillage de page et de ligne sur la table réduit la charge de traitement liée au verrouillage tout au long de la semaine en permettant aux lecteurs d'accéder simultanément à la table via des verrous de table partagés.</span><span class="sxs-lookup"><span data-stu-id="968d3-1685">Turning off page and row locking on the table reduces the locking overhead throughout the week by allowing readers to concurrently access the table through shared table locks.</span></span> <span data-ttu-id="968d3-1686">Lorsque le programme de traitement par lot s'exécute, il peut effectuer la mise à jour efficacement, car il obtient un verrou de table exclusif.</span><span class="sxs-lookup"><span data-stu-id="968d3-1686">When the batch job runs, it can complete the update efficiently because it obtains an exclusive table lock.</span></span>  
  
 <span data-ttu-id="968d3-1687">La désactivation du verrouillage de page et de ligne peut parfois être acceptable, car la mise à jour par lot hebdomadaire empêche les lecteurs simultanés d'accéder à la table pendant l'exécution de la mise à jour.</span><span class="sxs-lookup"><span data-stu-id="968d3-1687">Turning off page and row locking might or might not be acceptable because the weekly batch update will block the concurrent readers from accessing the table while the update runs.</span></span> <span data-ttu-id="968d3-1688">Si le programme de traitement par lot modifie seulement quelques lignes ou pages, vous pouvez changer le niveau de verrouillage afin d'autoriser le verrouillage de ligne ou de page ; cela permet à la table d'être lue sans blocage dans d'autres sessions.</span><span class="sxs-lookup"><span data-stu-id="968d3-1688">If the batch job only changes a few rows or pages, you can change the locking level to allow row or page level locking, which will enable other sessions to read from the table without blocking.</span></span> <span data-ttu-id="968d3-1689">Si le programme de traitement par lot doit effectuer un grand nombre de mises à jour, l'obtention d'un verrou exclusif sur la table peut représenter la meilleure solution pour garantir l'efficacité et la totalité de son exécution.</span><span class="sxs-lookup"><span data-stu-id="968d3-1689">If the batch job has a large number of updates, obtaining an exclusive lock on the table may be the best way to ensure the batch job finishes efficiently.</span></span>  
  
 <span data-ttu-id="968d3-1690">Parfois, un blocage se produit dans les circonstances suivantes : deux opérations simultanées acquièrent des verrous de ligne sur la même table, puis se bloquent, car elles doivent toutes les deux verrouiller la page.</span><span class="sxs-lookup"><span data-stu-id="968d3-1690">Occasionally a deadlock occurs when two concurrent operations acquire row locks on the same table and then block because they both need to lock the page.</span></span> <span data-ttu-id="968d3-1691">L'interdiction des verrous de ligne force l'une des opérations à attendre, ce qui évite le blocage.</span><span class="sxs-lookup"><span data-stu-id="968d3-1691">Disallowing row locks forces one of the operations to wait, avoiding the deadlock.</span></span>  
  
 <span data-ttu-id="968d3-1692">La granularité de verrouillage utilisée pour un index peut être définie via les instructions CREATE INDEX et ALTER INDEX.</span><span class="sxs-lookup"><span data-stu-id="968d3-1692">The granularity of locking used on an index can be set using the CREATE INDEX and ALTER INDEX statements.</span></span> <span data-ttu-id="968d3-1693">Les paramètres de verrouillage s'appliquent à la fois aux pages d'index et aux pages de table.</span><span class="sxs-lookup"><span data-stu-id="968d3-1693">The lock settings apply to both the index pages and the table pages.</span></span> <span data-ttu-id="968d3-1694">De plus, les instructions CREATE TABLE et ALTER TABLE peuvent être utilisées pour définir la granularité de verrouillage sur les contraintes PRIMARY KEY et UNIQUE.</span><span class="sxs-lookup"><span data-stu-id="968d3-1694">In addition, the CREATE TABLE and ALTER TABLE statements can be used to set locking granularity on PRIMARY KEY and UNIQUE constraints.</span></span> <span data-ttu-id="968d3-1695">À des fins de compatibilité descendante, la procédure stockée système **sp_indexoption** peut également définir la granularité.</span><span class="sxs-lookup"><span data-stu-id="968d3-1695">For backwards compatibility, the **sp_indexoption** system stored procedure can also set the granularity.</span></span> <span data-ttu-id="968d3-1696">Pour afficher l'option de verrouillage en cours pour un index donné, utilisez la fonction INDEXPROPERTY.</span><span class="sxs-lookup"><span data-stu-id="968d3-1696">To display the current locking option for a given index, use the INDEXPROPERTY function.</span></span> <span data-ttu-id="968d3-1697">Les verrous au niveau des pages, des lignes, ou une combinaison de ces derniers peuvent être refusés pour un index donné.</span><span class="sxs-lookup"><span data-stu-id="968d3-1697">Page-level locks, row-level locks, or a combination of page-level and row-level locks can be disallowed for a given index.</span></span>  
  
|<span data-ttu-id="968d3-1698">Verrous refusés</span><span class="sxs-lookup"><span data-stu-id="968d3-1698">Disallowed locks</span></span>|<span data-ttu-id="968d3-1699">Accès à l'index par</span><span class="sxs-lookup"><span data-stu-id="968d3-1699">Index accessed by</span></span>|  
|----------------------|-----------------------|  
|<span data-ttu-id="968d3-1700">Niveau page</span><span class="sxs-lookup"><span data-stu-id="968d3-1700">Page level</span></span>|<span data-ttu-id="968d3-1701">Verrous au niveau des lignes et des tables</span><span class="sxs-lookup"><span data-stu-id="968d3-1701">Row-level and table-level locks</span></span>|  
|<span data-ttu-id="968d3-1702">Niveau ligne</span><span class="sxs-lookup"><span data-stu-id="968d3-1702">Row level</span></span>|<span data-ttu-id="968d3-1703">Verrous au niveau des pages et des tables</span><span class="sxs-lookup"><span data-stu-id="968d3-1703">Page-level and table-level locks</span></span>|  
|<span data-ttu-id="968d3-1704">Niveau page et niveau ligne</span><span class="sxs-lookup"><span data-stu-id="968d3-1704">Page level and row level</span></span>|<span data-ttu-id="968d3-1705">Verrous au niveau des tables</span><span class="sxs-lookup"><span data-stu-id="968d3-1705">Table-level locks</span></span>|  
  
 <span data-ttu-id="968d3-1706">![Icône de flèche utilisée avec le lien retour au début](media/uparrow16x16.gif "Icône de flèche utilisée avec le lien Retour en haut") [dans ce guide](#Top)</span><span class="sxs-lookup"><span data-stu-id="968d3-1706">![Arrow icon used with Back to Top link](media/uparrow16x16.gif "Arrow icon used with Back to Top link") [In This Guide](#Top)</span></span>  
  
##  <a name="advanced-transaction-information"></a><a name="Advanced"></a> <span data-ttu-id="968d3-1707">Informations sur les transactions avancées</span><span class="sxs-lookup"><span data-stu-id="968d3-1707">Advanced Transaction Information</span></span>  
  
### <a name="nesting-transactions"></a><span data-ttu-id="968d3-1708">Transactions imbriquées</span><span class="sxs-lookup"><span data-stu-id="968d3-1708">Nesting Transactions</span></span>  

 <span data-ttu-id="968d3-1709">Les transactions explicites peuvent être imbriquées.</span><span class="sxs-lookup"><span data-stu-id="968d3-1709">Explicit transactions can be nested.</span></span> <span data-ttu-id="968d3-1710">Cette fonctionnalité est avant tout destinée à la prise en charge des transactions dans les procédures stockées appelées par un processus faisant partie d'une transaction, ou par des processus ne disposant pas de transaction active.</span><span class="sxs-lookup"><span data-stu-id="968d3-1710">This is primarily intended to support transactions in stored procedures that can be called either from a process already in a transaction or from processes that have no active transaction.</span></span>  
  
 <span data-ttu-id="968d3-1711">L'exemple suivant illustre cette utilisation des transactions imbriquées.</span><span class="sxs-lookup"><span data-stu-id="968d3-1711">The following example shows the intended use of nested transactions.</span></span> <span data-ttu-id="968d3-1712">La procédure `TransProc` applique sa transaction quel que soit le mode de transaction du processus qui l'exécute.</span><span class="sxs-lookup"><span data-stu-id="968d3-1712">The procedure `TransProc` enforces its transaction regardless of the transaction mode of any process that executes it.</span></span> <span data-ttu-id="968d3-1713">Si `TransProc` est appelée alors qu'une transaction est active, la transaction imbriquée dans `TransProc` est en grande partie ignorée, et les instructions INSERT qu'elle contient sont validées ou restaurées en fonction de la dernière action effectuée dans la transaction la plus externe.</span><span class="sxs-lookup"><span data-stu-id="968d3-1713">If `TransProc` is called when a transaction is active, the nested transaction in `TransProc` is largely ignored, and its INSERT statements are committed or rolled back based on the final action taken for the outer transaction.</span></span> <span data-ttu-id="968d3-1714">Si `TransProc` est exécutée par un processus pour lequel aucune transaction n'est en cours, l'instruction COMMIT TRANSACTION qui se trouve à la fin de la procédure déclenche la validation effective des instructions INSERT.</span><span class="sxs-lookup"><span data-stu-id="968d3-1714">If `TransProc` is executed by a process that does not have an outstanding transaction, the COMMIT TRANSACTION at the end of the procedure effectively commits the INSERT statements.</span></span>  
  
```sql  
SET QUOTED_IDENTIFIER OFF;  
GO  
SET NOCOUNT OFF;  
GO  
CREATE TABLE TestTrans(Cola INT PRIMARY KEY,  
               Colb CHAR(3) NOT NULL);  
GO  
CREATE PROCEDURE TransProc @PriKey INT, @CharCol CHAR(3) AS  
BEGIN TRANSACTION InProc  
INSERT INTO TestTrans VALUES (@PriKey, @CharCol)  
INSERT INTO TestTrans VALUES (@PriKey + 1, @CharCol)  
COMMIT TRANSACTION InProc;  
GO  
/* Start a transaction and execute TransProc. */  
BEGIN TRANSACTION OutOfProc;  
GO  
EXEC TransProc 1, 'aaa';  
GO  
/* Roll back the outer transaction, this will  
   roll back TransProc's nested transaction. */  
ROLLBACK TRANSACTION OutOfProc;  
GO  
EXECUTE TransProc 3,'bbb';  
GO  
/* The following SELECT statement shows only rows 3 and 4 are   
   still in the table. This indicates that the commit  
   of the inner transaction from the first EXECUTE statement of  
   TransProc was overridden by the subsequent rollback. */  
SELECT * FROM TestTrans;  
GO  
```  
  
 <span data-ttu-id="968d3-1715">La validation des transactions internes est ignorée par le [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="968d3-1715">Committing inner transactions is ignored by the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)].</span></span> <span data-ttu-id="968d3-1716">La transaction est validée ou restaurée en fonction de l'action prise à la fin de la transaction la plus externe.</span><span class="sxs-lookup"><span data-stu-id="968d3-1716">The transaction is either committed or rolled back based on the action taken at the end of the outermost transaction.</span></span> <span data-ttu-id="968d3-1717">Si la transaction externe est validée, les transactions imbriquées dans celle-ci le sont aussi.</span><span class="sxs-lookup"><span data-stu-id="968d3-1717">If the outer transaction is committed, the inner nested transactions are also committed.</span></span> <span data-ttu-id="968d3-1718">Si la transaction externe est restaurée, toutes les transactions internes le sont aussi, qu'elles aient été validées individuellement ou non.</span><span class="sxs-lookup"><span data-stu-id="968d3-1718">If the outer transaction is rolled back, then all inner transactions are also rolled back, regardless of whether or not the inner transactions were individually committed.</span></span>  
  
 <span data-ttu-id="968d3-1719">Chaque appel à COMMIT TRANSACTION ou COMMIT WORK s'applique à la dernière instruction BEGIN TRANSACTION exécutée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1719">Each call to COMMIT TRANSACTION or COMMIT WORK applies to the last executed BEGIN TRANSACTION.</span></span> <span data-ttu-id="968d3-1720">Si les instructions BEGIN TRANSACTION sont imbriquées, une instruction COMMIT s'applique uniquement à la dernière transaction imbriquée, qui est la transaction la plus interne.</span><span class="sxs-lookup"><span data-stu-id="968d3-1720">If the BEGIN TRANSACTION statements are nested, then a COMMIT statement applies only to the last nested transaction, which is the innermost transaction.</span></span> <span data-ttu-id="968d3-1721">Même si une instruction COMMIT TRANSACTION *transaction_name* dans une transaction imbriquée fait référence au nom de transaction de la transaction externe, la validation s’applique uniquement à la transaction la plus profonde.</span><span class="sxs-lookup"><span data-stu-id="968d3-1721">Even if a COMMIT TRANSACTION *transaction_name* statement within a nested transaction refers to the transaction name of the outer transaction, the commit applies only to the innermost transaction.</span></span>  
  
 <span data-ttu-id="968d3-1722">Il n’est pas légal que le paramètre *transaction_name* d’une instruction ROLLBACK TRANSACTION fasse référence aux transactions internes d’un ensemble de transactions imbriquées nommées.</span><span class="sxs-lookup"><span data-stu-id="968d3-1722">It is not legal for the *transaction_name* parameter of a ROLLBACK TRANSACTION statement to refer to the inner transactions of a set of named nested transactions.</span></span> <span data-ttu-id="968d3-1723">*transaction_name* ne peut faire référence qu’au nom de la transaction la plus extérieure.</span><span class="sxs-lookup"><span data-stu-id="968d3-1723">*transaction_name* can refer only to the transaction name of the outermost transaction.</span></span> <span data-ttu-id="968d3-1724">Si une instruction ROLLBACK TRANSACTION *transaction_name* utilisant le nom de la transaction externe est exécutée à n’importe quel niveau d’un ensemble de transactions imbriquées, toutes les transactions imbriquées sont restaurées.</span><span class="sxs-lookup"><span data-stu-id="968d3-1724">If a ROLLBACK TRANSACTION *transaction_name* statement using the name of the outer transaction is executed at any level of a set of nested transactions, all of the nested transactions are rolled back.</span></span> <span data-ttu-id="968d3-1725">Si une instruction ROLLBACK WORK ou ROLLBACK TRANSACTION sans paramètre *transaction_name* est exécutée à n’importe quel niveau d’un ensemble de transactions imbriquées, elle restaure toutes les transactions imbriquées, y compris la transaction la plus externe.</span><span class="sxs-lookup"><span data-stu-id="968d3-1725">If a ROLLBACK WORK or ROLLBACK TRANSACTION statement without a *transaction_name* parameter is executed at any level of a set of nested transaction, it rolls back all of the nested transactions, including the outermost transaction.</span></span>  
  
 <span data-ttu-id="968d3-1726">La @TRANCOUNT fonction @ enregistre le niveau d’imbrication de la transaction actuelle.</span><span class="sxs-lookup"><span data-stu-id="968d3-1726">The @@TRANCOUNT function records the current transaction nesting level.</span></span> <span data-ttu-id="968d3-1727">Chaque BEGIN TRANSACTION instruction incrémente @ @TRANCOUNT d’une unité.</span><span class="sxs-lookup"><span data-stu-id="968d3-1727">Each BEGIN TRANSACTION statement increments @@TRANCOUNT by one.</span></span> <span data-ttu-id="968d3-1728">Chaque instruction COMMIT TRANSACTION ou COMMIT WORK décrémente @ @TRANCOUNT d’une unité.</span><span class="sxs-lookup"><span data-stu-id="968d3-1728">Each COMMIT TRANSACTION or COMMIT WORK statement decrements @@TRANCOUNT by one.</span></span> <span data-ttu-id="968d3-1729">Une instruction ROLLBACK WORK ou ROLLBACK TRANSACTION qui n’a pas de nom de transaction restaure toutes les transactions imbriquées et décrémente @ @TRANCOUNT à 0.</span><span class="sxs-lookup"><span data-stu-id="968d3-1729">A ROLLBACK WORK or a ROLLBACK TRANSACTION statement that does not have a transaction name rolls back all nested transactions and decrements @@TRANCOUNT to 0.</span></span> <span data-ttu-id="968d3-1730">Une TRANSACTION ROLLBACK qui utilise le nom de la transaction la plus à l’extérieur dans un ensemble de transactions imbriquées restaure toutes les transactions imbriquées et décrémente @ @TRANCOUNT à 0.</span><span class="sxs-lookup"><span data-stu-id="968d3-1730">A ROLLBACK TRANSACTION that uses the transaction name of the outermost transaction in a set of nested transactions rolls back all of the nested transactions and decrements @@TRANCOUNT to 0.</span></span> <span data-ttu-id="968d3-1731">Lorsque vous ne savez pas si vous êtes déjà dans une transaction, sélectionnez @ @TRANCOUNT pour déterminer s’il s’agit d’une ou de plusieurs.</span><span class="sxs-lookup"><span data-stu-id="968d3-1731">When you are unsure if you are already in a transaction, SELECT @@TRANCOUNT to determine if it is 1 or more.</span></span> <span data-ttu-id="968d3-1732">Si @ @TRANCOUNT est égal à 0, cela indique que vous n’êtes pas dans une transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1732">If @@TRANCOUNT is 0, you are not in a transaction.</span></span>  
  
### <a name="using-bound-sessions"></a><span data-ttu-id="968d3-1733">Utilisation de sessions associées</span><span class="sxs-lookup"><span data-stu-id="968d3-1733">Using Bound Sessions</span></span>  

 <span data-ttu-id="968d3-1734">Les sessions associées facilitent la coordination des actions entre plusieurs sessions exécutées sur le même serveur.</span><span class="sxs-lookup"><span data-stu-id="968d3-1734">Bound sessions ease the coordination of actions across multiple sessions on the same server.</span></span> <span data-ttu-id="968d3-1735">Les sessions associées permettent à plusieurs sessions de partager la même transaction et les mêmes verrous. Elles peuvent opérer sur les mêmes données sans conflits de verrous.</span><span class="sxs-lookup"><span data-stu-id="968d3-1735">Bound sessions allow two or more sessions to share the same transaction and locks, and can work on the same data without lock conflicts.</span></span> <span data-ttu-id="968d3-1736">Les sessions associées peuvent être créées à partir de plusieurs sessions de la même application ou à partir de sessions distinctes de plusieurs applications.</span><span class="sxs-lookup"><span data-stu-id="968d3-1736">Bound sessions can be created from multiple sessions within the same application or from multiple applications with separate sessions.</span></span>  
  
 <span data-ttu-id="968d3-1737">Pour participer à une session liée, une session appelle **sp_getbindtoken** ou **Srv_getbindtoken** (via Open Data Services) pour obtenir un jeton de liaison.</span><span class="sxs-lookup"><span data-stu-id="968d3-1737">To participate in a bound session, a session calls **sp_getbindtoken** or **srv_getbindtoken** (through Open Data Services) to get a bind token.</span></span> <span data-ttu-id="968d3-1738">Un jeton d'association est une chaîne de caractères qui identifie de manière unique chaque transaction associée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1738">A bind token is a character string that uniquely identifies each bound transaction.</span></span> <span data-ttu-id="968d3-1739">Le jeton d'association est ensuite transmis aux autres sessions à associer à la session en cours.</span><span class="sxs-lookup"><span data-stu-id="968d3-1739">The bind token is then sent to the other sessions to be bound with the current session.</span></span> <span data-ttu-id="968d3-1740">Les autres sessions se lient à la transaction en appelant **sp_bindsession** avec le jeton de liaison reçu de la première session.</span><span class="sxs-lookup"><span data-stu-id="968d3-1740">The other sessions bind to the transaction by calling **sp_bindsession**, using the bind token received from the first session.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="968d3-1741">Une session doit avoir une transaction utilisateur active pour que **sp_getbindtoken** ou **srv_getbindtoken** aboutisse.</span><span class="sxs-lookup"><span data-stu-id="968d3-1741">A session must have an active user transaction in order for **sp_getbindtoken** or **srv_getbindtoken** to succeed.</span></span>  
  
 <span data-ttu-id="968d3-1742">Les jetons d'association doivent être transmis par le code de l'application qui crée la première session au code des applications qui lient leurs sessions à la première.</span><span class="sxs-lookup"><span data-stu-id="968d3-1742">Bind tokens must be transmitted from the application code that makes the first session to the application code that subsequently binds their sessions to the first session.</span></span> <span data-ttu-id="968d3-1743">Il n'existe aucune instruction [!INCLUDE[tsql](../includes/tsql-md.md)] ni fonction d'API qui permette à une application d'obtenir le jeton d'association pour une transaction démarrée par un autre processus.</span><span class="sxs-lookup"><span data-stu-id="968d3-1743">There is no [!INCLUDE[tsql](../includes/tsql-md.md)] statement or API function that an application can use to get the bind token for a transaction started by another process.</span></span> <span data-ttu-id="968d3-1744">Les méthodes suivantes peuvent être utilisées pour transmettre un jeton d'association :</span><span class="sxs-lookup"><span data-stu-id="968d3-1744">Some of the methods that can be used to transmit a bind token include the following:</span></span>  
  
-   <span data-ttu-id="968d3-1745">Si toutes les sessions sont ouvertes à partir du même processus d'application, les jetons d'association peuvent être stockés en mémoire globale ou passés comme paramètres à des fonctions.</span><span class="sxs-lookup"><span data-stu-id="968d3-1745">If the sessions are all initiated from the same application process, bind tokens can be stored in global memory or passed into functions as a parameter.</span></span>  
  
-   <span data-ttu-id="968d3-1746">Si les sessions sont créées à partir de processus d'application différents, les jetons d'association peuvent être transmis à l'aide d'un système de communication entre processus (IPC), comme l'appel de procédure distante (RPC) ou l'échange dynamique de données (DDE).</span><span class="sxs-lookup"><span data-stu-id="968d3-1746">If the sessions are made from separate application processes, bind tokens can be transmitted using interprocess communication (IPC), such as a remote procedure call (RPC) or dynamic data exchange (DDE).</span></span>  
  
-   <span data-ttu-id="968d3-1747">Les jetons d'association peuvent être stockés dans une instance de [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] dans une table qui peut être lue par les processus voulant s'associer à la première session.</span><span class="sxs-lookup"><span data-stu-id="968d3-1747">Bind tokens can be stored in a table in an instance of the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] that can be read by processes wanting to bind to the first session.</span></span>  
  
 <span data-ttu-id="968d3-1748">Dans un ensemble de sessions associées, une seule session peut être active à la fois.</span><span class="sxs-lookup"><span data-stu-id="968d3-1748">Only one session in a set of bound sessions can be active at any time.</span></span> <span data-ttu-id="968d3-1749">Si une session exécute une instruction sur l'instance ou si elle attend des résultats de l'instance, aucune des autres sessions associées ne peut accéder à l'instance tant que la session active n'a pas terminé ou annulé l'exécution de l'instruction en cours.</span><span class="sxs-lookup"><span data-stu-id="968d3-1749">If one session is executing a statement on the instance or has results pending from the instance, no other session bound to it can access the instance until the current session finishes processing or cancels the current statement.</span></span> <span data-ttu-id="968d3-1750">Si l'instance est occupée à traiter une instruction provenant d'une autre des sessions associée, un message d'erreur s'affiche pour indiquer que l'espace de transaction est utilisé et que la session doit renouveler la tentative ultérieurement.</span><span class="sxs-lookup"><span data-stu-id="968d3-1750">If the instance is busy processing a statement from another of the bound sessions, an error occurs indicating that the transaction space is in use and the session should retry later.</span></span>  
  
 <span data-ttu-id="968d3-1751">Chacune des sessions associées conserve son niveau d'isolation propre.</span><span class="sxs-lookup"><span data-stu-id="968d3-1751">When you bind sessions, each session retains its isolation level setting.</span></span> <span data-ttu-id="968d3-1752">Si vous utilisez SET TRANSACTION ISOLATION LEVEL pour changer le niveau d'isolation d'une session, cela n'affecte pas celui des autres sessions associées.</span><span class="sxs-lookup"><span data-stu-id="968d3-1752">Using SET TRANSACTION ISOLATION LEVEL to change the isolation level setting of one session does not affect the setting of any other session bound to it.</span></span>  
  
#### <a name="types-of-bound-sessions"></a><span data-ttu-id="968d3-1753">Types de sessions associées</span><span class="sxs-lookup"><span data-stu-id="968d3-1753">Types of Bound Sessions</span></span>  

 <span data-ttu-id="968d3-1754">Les sessions associées peuvent être locales ou distribuées.</span><span class="sxs-lookup"><span data-stu-id="968d3-1754">The two types of bound sessions are local and distributed.</span></span>  
  
-   <span data-ttu-id="968d3-1755">Sessions associées locales</span><span class="sxs-lookup"><span data-stu-id="968d3-1755">Local bound session</span></span>  
  
     <span data-ttu-id="968d3-1756">Les sessions associées locales peuvent partager l'espace de transaction d'une transaction unique dans une seule instance du [!INCLUDE[ssDE](../includes/ssde-md.md)].</span><span class="sxs-lookup"><span data-stu-id="968d3-1756">Allows bound sessions to share the transaction space of a single transaction in a single instance of the [!INCLUDE[ssDE](../includes/ssde-md.md)].</span></span>  
  
-   <span data-ttu-id="968d3-1757">Sessions associées distribuées</span><span class="sxs-lookup"><span data-stu-id="968d3-1757">Distributed bound session</span></span>  
  
     <span data-ttu-id="968d3-1758">Les sessions associées distribuées peuvent partager la même transaction entre plusieurs instances jusqu'à ce que la transaction complète soit validée ou annulée à l'aide de [!INCLUDE[msCoName](../includes/msconame-md.md)] Distributed Transaction Coordinator (MS DTC).</span><span class="sxs-lookup"><span data-stu-id="968d3-1758">Allows bound sessions to share the same transaction across two or more instances until the entire transaction is either committed or rolled back by using [!INCLUDE[msCoName](../includes/msconame-md.md)] Distributed Transaction Coordinator (MS DTC).</span></span>  
  
 <span data-ttu-id="968d3-1759">Les sessions associées distribuées ne sont pas identifiées par la chaîne de caractères d'un jeton de liaison, mais par des numéros d'identification de transaction distribuée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1759">Distributed bound sessions are not identified by a character string bind token; they are identified by distributed transaction identification numbers.</span></span> <span data-ttu-id="968d3-1760">Si une session associée est impliquée dans une transaction locale et exécute un appel de procédure distante (RPC) sur un serveur distant avec SET REMOTE_PROC_TRANSACTIONS ON, la transaction associée locale est automatiquement promue au rang de transaction associée distribuée par MS DTC et une session MS DTC est lancée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1760">If a bound session is involved in a local transaction and executes an RPC on a remote server with SET REMOTE_PROC_TRANSACTIONS ON, the local bound transaction is automatically promoted to a distributed bound transaction by MS DTC and an MS DTC session is started.</span></span>  
  
#### <a name="when-to-use-bound-sessions"></a><span data-ttu-id="968d3-1761">Utilisation des sessions associées</span><span class="sxs-lookup"><span data-stu-id="968d3-1761">When to Use Bound Sessions</span></span>  

 <span data-ttu-id="968d3-1762">Dans les versions précédentes de [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], les sessions associées étaient principalement utilisées pour développer des procédures stockées étendues devant exécuter des instructions [!INCLUDE[tsql](../includes/tsql-md.md)] pour le processus qui les appelle.</span><span class="sxs-lookup"><span data-stu-id="968d3-1762">In earlier versions of [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)], bound sessions were primarily used in developing extended stored procedures that must execute [!INCLUDE[tsql](../includes/tsql-md.md)] statements on behalf of the process that calls them.</span></span> <span data-ttu-id="968d3-1763">Le passage par le processus appelant d'un jeton d'association comme paramètre de la procédure stockée permet à celle-ci d'accéder à l'espace de transaction du processus appelant, et d'intégrer ainsi la procédure stockée étendue à ce dernier.</span><span class="sxs-lookup"><span data-stu-id="968d3-1763">Having the calling process pass in a bind token as one parameter of the extended stored procedure allows the procedure to join the transaction space of the calling process, thereby integrating the extended stored procedure with the calling process.</span></span>  
  
 <span data-ttu-id="968d3-1764">Dans le [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)], les procédures stockées écrites à l'aide de CLR sont supérieures aux procédures stockées étendues en termes de sécurité, d'évolutivité et de stabilité.</span><span class="sxs-lookup"><span data-stu-id="968d3-1764">In the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)], stored procedures written using CLR are more secure, scalable, and stable than extended stored procedures.</span></span> <span data-ttu-id="968d3-1765">Les procédures stockées CLR utilisent l’objet **SqlContext** pour joindre le contexte de la session appelante, et non **sp_bindsession**.</span><span class="sxs-lookup"><span data-stu-id="968d3-1765">CLR-stored procedures use the **SqlContext** object to join the context of the calling session, not **sp_bindsession**.</span></span>  
  
 <span data-ttu-id="968d3-1766">Les sessions associées peuvent être utilisées pour développer des applications à trois niveaux où la logique de gestion est incluse dans des programmes distincts qui peuvent travailler en coopération sur une seule transaction commerciale.</span><span class="sxs-lookup"><span data-stu-id="968d3-1766">Bound sessions can be used to develop three-tier applications in which business logic is incorporated into separate programs that work cooperatively on a single business transaction.</span></span> <span data-ttu-id="968d3-1767">Ces programmes doivent être codés de manière à coordonner soigneusement leur accès à une base de données.</span><span class="sxs-lookup"><span data-stu-id="968d3-1767">These programs must be coded to carefully coordinate their access to a database.</span></span> <span data-ttu-id="968d3-1768">Comme les deux sessions partagent les mêmes verrous, les deux programmes ne doivent pas essayer de modifier simultanément les mêmes données.</span><span class="sxs-lookup"><span data-stu-id="968d3-1768">Because the two sessions share the same locks, the two programs must not try to modify the same data at the same time.</span></span> <span data-ttu-id="968d3-1769">A tout moment, une seule session peut participer à la transaction ; aucune exécution en parallèle n'est possible.</span><span class="sxs-lookup"><span data-stu-id="968d3-1769">At any point in time, only one session can be doing work as part of the transaction; there can be no parallel execution.</span></span> <span data-ttu-id="968d3-1770">La transaction ne peut passer d'une session à l'autre que lors de points d'interruption bien définis, notamment lorsque l'exécution de toutes les instructions DML est terminée et que les résultats correspondants ont été extraits.</span><span class="sxs-lookup"><span data-stu-id="968d3-1770">The transaction can only be switched between sessions at well-defined yield points, such as when all DML statements have completed and their results have been retrieved.</span></span>  
  
### <a name="coding-efficient-transactions"></a><span data-ttu-id="968d3-1771">Écriture de transactions performantes</span><span class="sxs-lookup"><span data-stu-id="968d3-1771">Coding Efficient Transactions</span></span>  

 <span data-ttu-id="968d3-1772">Il est important de réduire la durée des transactions au minimum.</span><span class="sxs-lookup"><span data-stu-id="968d3-1772">It is important to keep transactions as short as possible.</span></span> <span data-ttu-id="968d3-1773">Au démarrage d'une transaction, le SGBD, autrement dit le système de gestion de base de données, doit utiliser de nombreuses ressources pour toute la durée de la transaction afin de préserver les propriétés ACID (atomicité, cohérence, isolement et durabilité) de la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1773">When a transaction is started, a database management system (DBMS) must hold many resources until the end of the transaction to protect the atomicity, consistency, isolation, and durability (ACID) properties of the transaction.</span></span> <span data-ttu-id="968d3-1774">En cas de modification des données, les lignes modifiées doivent être protégées par des verrous exclusifs qui empêchent les autres transactions de lire ces lignes, et ces verrous doivent être maintenus jusqu'à ce que la transaction soit validée ou restaurée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1774">If data is modified, the modified rows must be protected with exclusive locks that prevent any other transaction from reading the rows, and exclusive locks must be held until the transaction is committed or rolled back.</span></span> <span data-ttu-id="968d3-1775">En fonction des paramètres de niveau d'isolement des transactions, les instructions SELECT peuvent activer des verrous qui doivent être maintenus jusqu'à la restauration ou la validation de la transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1775">Depending on transaction isolation level settings, SELECT statements may acquire locks that must be held until the transaction is committed or rolled back.</span></span> <span data-ttu-id="968d3-1776">Dans le cas de systèmes comprenant de nombreux utilisateurs, les transactions doivent être aussi courtes que possible afin de limiter la contention des ressources par les verrous pour des connexions concurrentes.</span><span class="sxs-lookup"><span data-stu-id="968d3-1776">Especially in systems with many users, transactions must be kept as short as possible to reduce locking contention for resources between concurrent connections.</span></span> <span data-ttu-id="968d3-1777">Des transactions longues et peu performantes peuvent ne pas poser de problème pour un nombre réduit d'utilisateurs, mais elles sont inacceptables dans le cas d'un système comprenant plusieurs milliers d'utilisateurs.</span><span class="sxs-lookup"><span data-stu-id="968d3-1777">Long-running, inefficient transactions may not be a problem with small numbers of users, but they are intolerable in a system with thousands of users.</span></span> <span data-ttu-id="968d3-1778">À partir de [!INCLUDE[ssSQL14](../includes/sssql14-md.md)], [!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] prend en charge les transactions durables retardées.</span><span class="sxs-lookup"><span data-stu-id="968d3-1778">Beginning with [!INCLUDE[ssSQL14](../includes/sssql14-md.md)][!INCLUDE[ssNoVersion](../includes/ssnoversion-md.md)] supports delayed durable transactions.</span></span> <span data-ttu-id="968d3-1779">Les transactions durables retardées ne garantissent pas la durabilité.</span><span class="sxs-lookup"><span data-stu-id="968d3-1779">Delayed durable transactions do not guarantee durability.</span></span> <span data-ttu-id="968d3-1780">Consultez la rubrique [Durabilité des transactions](../relational-databases/logs/control-transaction-durability.md) pour plus d’informations.</span><span class="sxs-lookup"><span data-stu-id="968d3-1780">See the topic [Transaction Durability](../relational-databases/logs/control-transaction-durability.md) for more information.</span></span>  
  
#### <a name="coding-guidelines"></a><span data-ttu-id="968d3-1781">Directives de codage</span><span class="sxs-lookup"><span data-stu-id="968d3-1781">Coding Guidelines</span></span>  

 <span data-ttu-id="968d3-1782">Vous trouverez ci-dessous des directives vous permettant de coder des transactions performantes :</span><span class="sxs-lookup"><span data-stu-id="968d3-1782">These are guidelines for coding efficient transactions:</span></span>  
  
-   <span data-ttu-id="968d3-1783">Évitez l'entrée de données par l'utilisateur au cours d'une transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1783">Do not require input from users during a transaction.</span></span>  
  
     <span data-ttu-id="968d3-1784">Effectuez toutes les entrées de données par l'utilisateur avant le début d'une transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1784">Get all required input from users before a transaction is started.</span></span> <span data-ttu-id="968d3-1785">Si d'autres données doivent être entrées par l'utilisateur au cours d'une transaction, restaurez la transaction en cours et redémarrez-la après l'entrée des données.</span><span class="sxs-lookup"><span data-stu-id="968d3-1785">If additional user input is required during a transaction, roll back the current transaction and restart the transaction after the user input is supplied.</span></span> <span data-ttu-id="968d3-1786">Même si les utilisateurs répondent immédiatement, le temps de réaction d'un être humain est incomparablement plus lent que la vitesse d'un ordinateur.</span><span class="sxs-lookup"><span data-stu-id="968d3-1786">Even if users respond immediately, human reaction times are vastly slower than computer speeds.</span></span> <span data-ttu-id="968d3-1787">Toutes les ressources utilisées par la transaction sont verrouillées pendant un temps extrêmement long, ce qui peut entraîner des problèmes de blocage du système.</span><span class="sxs-lookup"><span data-stu-id="968d3-1787">All resources held by the transaction are held for an extremely long time, which has the potential to cause blocking problems.</span></span> <span data-ttu-id="968d3-1788">Si les utilisateurs ne répondent pas, la transaction reste active et verrouille les ressources critiques jusqu'à ce qu'ils répondent, ce qui peut prendre plusieurs minutes, voire des heures.</span><span class="sxs-lookup"><span data-stu-id="968d3-1788">If users do not respond, the transaction remains active, locking critical resources until they respond, which may not happen for several minutes or even hours.</span></span>  
  
-   <span data-ttu-id="968d3-1789">Si possible, n'ouvrez pas une transaction alors que vous êtes en train de consulter des données.</span><span class="sxs-lookup"><span data-stu-id="968d3-1789">Do not open a transaction while browsing through data, if at all possible.</span></span>  
  
     <span data-ttu-id="968d3-1790">Ne démarrez pas de transaction avant que l'analyse préliminaire des données soit terminée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1790">Transactions should not be started until all preliminary data analysis has been completed.</span></span>  
  
-   <span data-ttu-id="968d3-1791">Limitez la durée de la transaction autant que possible.</span><span class="sxs-lookup"><span data-stu-id="968d3-1791">Keep the transaction as short as possible.</span></span>  
  
     <span data-ttu-id="968d3-1792">Lorsque vous connaissez les modifications effectuées, démarrez une transaction, exécutez les instructions de modification, puis validez-les ou restaurez-les immédiatement.</span><span class="sxs-lookup"><span data-stu-id="968d3-1792">After you know the modifications that have to be made, start a transaction, execute the modification statements, and then immediately commit or roll back.</span></span> <span data-ttu-id="968d3-1793">N'ouvrez pas la transaction tant que ce n'est pas nécessaire.</span><span class="sxs-lookup"><span data-stu-id="968d3-1793">Do not open the transaction before it is required.</span></span>  
  
-   <span data-ttu-id="968d3-1794">Pour réduire les blocages, envisagez d'utiliser un niveau d'isolement basé sur le contrôle de version de ligne pour les requêtes en lecture seule.</span><span class="sxs-lookup"><span data-stu-id="968d3-1794">To reduce blocking, consider using a row versioning-based isolation level for read-only queries.</span></span>  
  
-   <span data-ttu-id="968d3-1795">Utilisez avec discernement les niveaux d'isolement de transaction inférieurs.</span><span class="sxs-lookup"><span data-stu-id="968d3-1795">Make intelligent use of lower transaction isolation levels.</span></span>  
  
     <span data-ttu-id="968d3-1796">De nombreuses applications peuvent être facilement codées pour utiliser le niveau d'isolement de lecture validée.</span><span class="sxs-lookup"><span data-stu-id="968d3-1796">Many applications can be readily coded to use a read-committed transaction isolation level.</span></span> <span data-ttu-id="968d3-1797">Toutes les transactions ne nécessitent pas l'utilisation d'un niveau d'isolement de transaction sérialisable.</span><span class="sxs-lookup"><span data-stu-id="968d3-1797">Not all transactions require the serializable transaction isolation level.</span></span>  
  
-   <span data-ttu-id="968d3-1798">Utilisez les options de concurrence d'accès des curseurs les plus faibles, telles que les options de concurrence d'accès optimistes.</span><span class="sxs-lookup"><span data-stu-id="968d3-1798">Make intelligent use of lower cursor concurrency options, such as optimistic concurrency options.</span></span>  
  
     <span data-ttu-id="968d3-1799">Dans un système pour lequel la probabilité de modifications concurrentes est faible, le temps supplémentaire nécessaire pour traiter une erreur causée par la modification de vos données par un autre utilisateur après que vous les ayez lues peut être inférieur à celui qu'entraîne le verrouillage systématique des lignes au moment de leur lecture.</span><span class="sxs-lookup"><span data-stu-id="968d3-1799">In a system with a low probability of concurrent updates, the overhead of dealing with an occasional "somebody else changed your data after you read it" error can be much lower than the overhead of always locking rows as they are read.</span></span>  
  
-   <span data-ttu-id="968d3-1800">Limitez autant que possible le volume de données auxquelles accède votre transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1800">Access the least amount of data possible while in a transaction.</span></span>  
  
     <span data-ttu-id="968d3-1801">Le nombre de lignes verrouillées est ainsi limité, ce qui limite également la contention des transactions.</span><span class="sxs-lookup"><span data-stu-id="968d3-1801">This lessens the number of locked rows, thereby reducing contention between transactions.</span></span>  
  
#### <a name="avoiding-concurrency-and-resource-problems"></a><span data-ttu-id="968d3-1802">Prévention des problèmes de concurrence et de ressources</span><span class="sxs-lookup"><span data-stu-id="968d3-1802">Avoiding Concurrency and Resource Problems</span></span>  

 <span data-ttu-id="968d3-1803">Pour prévenir les problèmes de concurrence et de ressources, soyez minutieux dans la gestion des transactions implicites.</span><span class="sxs-lookup"><span data-stu-id="968d3-1803">To prevent concurrency and resource problems, manage implicit transactions carefully.</span></span> <span data-ttu-id="968d3-1804">Dans les transactions implicites, l'instruction [!INCLUDE[tsql](../includes/tsql-md.md)] qui suit une instruction COMMIT ou ROLLBACK démarre automatiquement une nouvelle transaction.</span><span class="sxs-lookup"><span data-stu-id="968d3-1804">When using implicit transactions, the next [!INCLUDE[tsql](../includes/tsql-md.md)] statement after COMMIT or ROLLBACK automatically starts a new transaction.</span></span> <span data-ttu-id="968d3-1805">Une nouvelle transaction risque ainsi d'être ouverte alors que l'application consulte des données, ou qu'elle attend une entrée de données par l'utilisateur.</span><span class="sxs-lookup"><span data-stu-id="968d3-1805">This can cause a new transaction to be opened while the application browses through data, or even when it requires input from the user.</span></span> <span data-ttu-id="968d3-1806">Après avoir terminé la dernière transaction nécessaire à la protection des modifications, désactivez les transactions implicites jusqu'à ce qu'une transaction doive à nouveau protéger les modifications de données.</span><span class="sxs-lookup"><span data-stu-id="968d3-1806">After completing the last transaction required to protect data modifications, turn off implicit transactions until a transaction is once again required to protect data modifications.</span></span> <span data-ttu-id="968d3-1807">Cette procédure permet à [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] d'utiliser le mode autocommit lorsque l'application consulte des données ou attend une entrée de données par l'utilisateur.</span><span class="sxs-lookup"><span data-stu-id="968d3-1807">This process lets the [!INCLUDE[ssDEnoversion](../includes/ssdenoversion-md.md)] use autocommit mode while the application is browsing data and getting input from the user.</span></span>  
  
 <span data-ttu-id="968d3-1808">De plus, quand le niveau d’isolation d’instantané est activé, même si une nouvelle transaction ne contient pas de verrous, une exécution longue empêche la suppression des anciennes versions dans `tempdb`.</span><span class="sxs-lookup"><span data-stu-id="968d3-1808">In addition, when the snapshot isolation level is enabled, although a new transaction will not hold locks, a long-running transaction will prevent the old versions from being removed from `tempdb`.</span></span>  
  
### <a name="managing-long-running-transactions"></a><span data-ttu-id="968d3-1809">Gestion des transactions de longue durée</span><span class="sxs-lookup"><span data-stu-id="968d3-1809">Managing Long-Running Transactions</span></span>  

 <span data-ttu-id="968d3-1810">Une *transaction longue* est une transaction active qui n’a pas été validée ou restaurée à temps.</span><span class="sxs-lookup"><span data-stu-id="968d3-1810">A *long-running transaction* is an active transaction that has not been committed or roll backed the transaction in a timely manner.</span></span> <span data-ttu-id="968d3-1811">Par exemple, si le début et la fin d'une transaction sont contrôlés par l'utilisateur, une raison classique de l'existence d'une transaction de longue durée est qu'un utilisateur a commencé une transaction puis est parti alors que la transaction attend une réponse de l'utilisateur.</span><span class="sxs-lookup"><span data-stu-id="968d3-1811">For example, if the beginning and end of a transaction is controlled by the user, a typical cause of a long-running transaction is a user starting a transaction and then leaving while the transaction waits for a response from the user.</span></span>  
  
 <span data-ttu-id="968d3-1812">Une transaction longue peut entraîner de graves problèmes pour une base de données, comme suit :</span><span class="sxs-lookup"><span data-stu-id="968d3-1812">A long running transaction can cause serious problems for a database, as follows:</span></span>  
  
-   <span data-ttu-id="968d3-1813">Si une instance de serveur est arrêtée après qu’une transaction active a effectué de nombreuses modifications non validées, la phase de récupération du redémarrage suivant peut prendre beaucoup plus de temps que le délai spécifié par l’option de configuration de serveur **intervalle de récupération** ou par la commande ALTER DATABASE... Définissez TARGET_RECOVERY_TIME option.</span><span class="sxs-lookup"><span data-stu-id="968d3-1813">If a server instance is shut down after an active transaction has performed many uncommitted modifications, the recovery phase of the subsequent restart can take much longer than the time specified by the **recovery interval** server configuration option or by the ALTER DATABASE... SET TARGET_RECOVERY_TIME option.</span></span> <span data-ttu-id="968d3-1814">Ces options contrôlent la fréquence des points de contrôle actifs et indirects, respectivement.</span><span class="sxs-lookup"><span data-stu-id="968d3-1814">These options control the frequency of active and indirect checkpoints, respectively.</span></span> <span data-ttu-id="968d3-1815">Pour plus d’informations sur les types de points de contrôle, consultez [Points de contrôle de base de données &#40;SQL Server&#41;](../relational-databases/logs/database-checkpoints-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="968d3-1815">For more information about the types of checkpoints, see [Database Checkpoints &#40;SQL Server&#41;](../relational-databases/logs/database-checkpoints-sql-server.md).</span></span>  
  
-   <span data-ttu-id="968d3-1816">Plus important, bien qu'une transaction en attente génère très peu d'entrées de journal, elle empêche la troncation du journal et entraîne ainsi sa croissance et son remplissage.</span><span class="sxs-lookup"><span data-stu-id="968d3-1816">More importantly, although a waiting transaction might generate very little log, it holds up log truncation indefinitely, causing the transaction log to grow and possibly fill up.</span></span> <span data-ttu-id="968d3-1817">Si le journal des transactions est rempli, la base de données ne peut plus effectuer de mises à jour.</span><span class="sxs-lookup"><span data-stu-id="968d3-1817">If the transaction log fills up, the database cannot perform any more updates.</span></span> <span data-ttu-id="968d3-1818">Pour plus d’informations, consultez [résoudre les problèmes liés à un journal des transactions complet &#40;SQL Server erreur 9002&#41;](../relational-databases/logs/troubleshoot-a-full-transaction-log-sql-server-error-9002.md)et [au journal des transactions &#40;SQL Server&#41;](../relational-databases/logs/the-transaction-log-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="968d3-1818">For more information, see [Troubleshoot a Full Transaction Log &#40;SQL Server Error 9002&#41;](../relational-databases/logs/troubleshoot-a-full-transaction-log-sql-server-error-9002.md), and [The Transaction Log &#40;SQL Server&#41;](../relational-databases/logs/the-transaction-log-sql-server.md).</span></span>  
  
#### <a name="discovering-long-running-transactions"></a><span data-ttu-id="968d3-1819">Découverte des transactions de longue durée</span><span class="sxs-lookup"><span data-stu-id="968d3-1819">Discovering Long-Running Transactions</span></span>  

 <span data-ttu-id="968d3-1820">Pour rechercher des transactions de longue durée, appliquez une des procédures suivantes :</span><span class="sxs-lookup"><span data-stu-id="968d3-1820">To look for long-running transactions, use one of the following:</span></span>  
  
-   <span data-ttu-id="968d3-1821">**sys.dm_tran_database_transactions**</span><span class="sxs-lookup"><span data-stu-id="968d3-1821">**sys.dm_tran_database_transactions**</span></span>  
  
     <span data-ttu-id="968d3-1822">Cet affichage de gestion dynamique retourne des informations sur les transactions au niveau de la base de données.</span><span class="sxs-lookup"><span data-stu-id="968d3-1822">This dynamic management view returns information about transactions at the database level.</span></span> <span data-ttu-id="968d3-1823">Pour une transaction longue, les colonnes particulièrement intéressantes incluent l’heure du premier enregistrement de journal (**database_transaction_begin_time**), l’état actuel de la transaction (**database_transaction_state**) et le numéro séquentiel dans le journal de l’enregistrement initial dans le journal des transactions (**database_transaction_begin_lsn**).</span><span class="sxs-lookup"><span data-stu-id="968d3-1823">For a long-running transaction, columns of particular interest include the time of the first log record (**database_transaction_begin_time**), the current state of the transaction (**database_transaction_state**), and the log sequence number (LSN) of the begin record in the transaction log (**database_transaction_begin_lsn**).</span></span>  
  
     <span data-ttu-id="968d3-1824">Pour plus d’informations, consultez [sys.dm_tran_database_transactions &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-database-transactions-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="968d3-1824">For more information, see [sys.dm_tran_database_transactions &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-tran-database-transactions-transact-sql).</span></span>  
  
-   <span data-ttu-id="968d3-1825">DBCC OPENTRAN</span><span class="sxs-lookup"><span data-stu-id="968d3-1825">DBCC OPENTRAN</span></span>  
  
     <span data-ttu-id="968d3-1826">Cette instruction vous permet d'identifier l'ID du propriétaire de la transaction et éventuellement de retrouver la source de la transaction pour y mettre fin dans les règles de l'art (la valider au lieu de la restaurer).</span><span class="sxs-lookup"><span data-stu-id="968d3-1826">This statement lets you identify the user ID of the owner of the transaction, so you can potentially track down the source of the transaction for a more orderly termination (committing it rather than rolling it back).</span></span> <span data-ttu-id="968d3-1827">Pour plus d’informations, consultez [DBCC OPENTRAN &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-opentran-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="968d3-1827">For more information, see [DBCC OPENTRAN &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-opentran-transact-sql).</span></span>  
  
#### <a name="stopping-a-transaction"></a><span data-ttu-id="968d3-1828">Arrêt d'une transaction</span><span class="sxs-lookup"><span data-stu-id="968d3-1828">Stopping a Transaction</span></span>  

 <span data-ttu-id="968d3-1829">Vous devrez peut-être utiliser l'instruction KILL.</span><span class="sxs-lookup"><span data-stu-id="968d3-1829">You may have to use the KILL statement.</span></span> <span data-ttu-id="968d3-1830">Utilisez cette instruction avec précaution, particulièrement lorsque des processus critiques sont en cours d'exécution.</span><span class="sxs-lookup"><span data-stu-id="968d3-1830">Use this statement very carefully, however, especially when critical processes are running.</span></span> <span data-ttu-id="968d3-1831">Pour plus d’informations, consultez [KILL &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/kill-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="968d3-1831">For more information, see [KILL &#40;Transact-SQL&#41;](/sql/t-sql/language-elements/kill-transact-sql).</span></span>  
  
 <span data-ttu-id="968d3-1832">![Icône de flèche utilisée avec le lien retour au début](media/uparrow16x16.gif "Icône de flèche utilisée avec le lien Retour en haut") [dans ce guide](#Top)</span><span class="sxs-lookup"><span data-stu-id="968d3-1832">![Arrow icon used with Back to Top link](media/uparrow16x16.gif "Arrow icon used with Back to Top link") [In This Guide](#Top)</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="968d3-1833">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="968d3-1833">See Also</span></span>  

 <span data-ttu-id="968d3-1834">[Isolation des transactions basée sur le contrôle de version de ligne SQL Server 2005](https://msdn.microsoft.com/library/ms345124(v=sql.90).aspx) </span><span class="sxs-lookup"><span data-stu-id="968d3-1834">[SQL Server 2005 Row Versioning-Based Transaction Isolation](https://msdn.microsoft.com/library/ms345124(v=sql.90).aspx) </span></span>  
 <span data-ttu-id="968d3-1835">[Charge du contrôle de version de ligne](https://blogs.msdn.com/b/sqlserverstorageengine/archive/2008/03/30/overhead-of-row-versioning.aspx) </span><span class="sxs-lookup"><span data-stu-id="968d3-1835">[Overhead of Row Versioning](https://blogs.msdn.com/b/sqlserverstorageengine/archive/2008/03/30/overhead-of-row-versioning.aspx) </span></span>  
 [<span data-ttu-id="968d3-1836">Procédure : créer une transaction autonome dans SQL Server 2008</span><span class="sxs-lookup"><span data-stu-id="968d3-1836">How to create an autonomous transaction in SQL Server 2008</span></span>](https://blogs.msdn.com/b/sqlprogrammability/archive/2008/08/22/how-to-create-an-autonomous-transaction-in-sql-server-2008.aspx)  
  
  
