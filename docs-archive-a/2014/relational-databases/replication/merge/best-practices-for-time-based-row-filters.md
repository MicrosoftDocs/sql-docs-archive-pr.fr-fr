---
title: Bonnes pratiques en matière de filtres de lignes basés sur le temps | Microsoft Docs
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: replication
ms.topic: conceptual
helpviewer_keywords:
- best practices
ms.assetid: 773c5c62-fd44-44ab-9c6b-4257dbf8ffdb
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: ccaafe71d4137fd4b31eec412c1e35595861bdd0
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87599952"
---
# <a name="best-practices-for-time-based-row-filters"></a><span data-ttu-id="0cb4b-102">Meilleures pratiques pour les filtres de lignes basés sur le temps</span><span class="sxs-lookup"><span data-stu-id="0cb4b-102">Best Practices for Time-Based Row Filters</span></span>
  <span data-ttu-id="0cb4b-103">Les utilisateurs d'applications ont souvent besoin d'un sous-ensemble de données d'une table basé sur le temps.</span><span class="sxs-lookup"><span data-stu-id="0cb4b-103">Users of applications often require a time-based subset of data from a table.</span></span> <span data-ttu-id="0cb4b-104">Par exemple, un vendeur peut avoir besoin des données sur les commandes passées au cours de la dernière semaine tandis qu'un planificateur d'événements peut avoir besoin des données sur les événements qui auront lieu au cours de la semaine à venir.</span><span class="sxs-lookup"><span data-stu-id="0cb4b-104">For instance, a salesperson might require data for orders in the last week, or an event planner might require data for events in the upcoming week.</span></span> <span data-ttu-id="0cb4b-105">Dans de nombreux cas, pour accomplir cette tâche, les applications utilisent des requêtes qui contiennent la fonction `GETDATE()`.</span><span class="sxs-lookup"><span data-stu-id="0cb4b-105">In many cases, applications use queries containing the `GETDATE()` function to accomplish this.</span></span> <span data-ttu-id="0cb4b-106">Considérons l'instruction de filtre de lignes suivante :</span><span class="sxs-lookup"><span data-stu-id="0cb4b-106">Consider the following row filter statement:</span></span>  
  
```  
WHERE SalesPersonID = CONVERT(INT,HOST_NAME()) AND OrderDate >= (GETDATE()-6)  
```  
  
 <span data-ttu-id="0cb4b-107">Avec un filtre de ce type, il est généralement admis que deux événements se produisent systématiquement à l'exécution de l'Agent de fusion : les lignes qui satisfont aux critères de ce filtre sont répliquées vers les Abonnés, tandis que celles qui n'y satisfont plus sont nettoyées sur ceux-ci.</span><span class="sxs-lookup"><span data-stu-id="0cb4b-107">With a filter of this type, it is usually assumed that two things always occur when the Merge Agent runs: rows that satisfy this filter are replicated to Subscribers; and rows that no longer satisfy this filter are cleaned up at Subscribers.</span></span> <span data-ttu-id="0cb4b-108">(Pour plus d’informations sur le filtrage avec `HOST_NAME()` , consultez [filtres de lignes paramétrables](parameterized-filters-parameterized-row-filters.md).) Toutefois, la réplication de fusion réplique et nettoie uniquement les données qui ont été modifiées depuis la dernière synchronisation, quelle que soit la façon dont vous définissez un filtre de lignes pour ces données.</span><span class="sxs-lookup"><span data-stu-id="0cb4b-108">(For more information about filtering with `HOST_NAME()`, see [Parameterized Row Filters](parameterized-filters-parameterized-row-filters.md).) However, merge replication only replicates and cleans up data that has changed since the last synchronization, regardless of how you define a row filter for that data.</span></span>  
  
 <span data-ttu-id="0cb4b-109">Pour que la réplication de fusion traite une ligne, les données contenues dans celle-ci doivent satisfaire aux critères du filtre de lignes et avoir changé depuis la dernière synchronisation.</span><span class="sxs-lookup"><span data-stu-id="0cb4b-109">For merge replication to process a row, the data in the row must satisfy the row filter, and it must have changed since the last synchronization.</span></span> <span data-ttu-id="0cb4b-110">Dans le cas de la table **SalesOrderHeader** , **OrderDate** est entré lorsqu'une ligne est insérée.</span><span class="sxs-lookup"><span data-stu-id="0cb4b-110">In the case of the **SalesOrderHeader** table, **OrderDate** is entered when a row is inserted.</span></span> <span data-ttu-id="0cb4b-111">Les lignes sont répliquées vers l'Abonné comme prévu car l'insertion constitue une modification de données.</span><span class="sxs-lookup"><span data-stu-id="0cb4b-111">Rows are replicated to the Subscriber as expected because the insert is a data change.</span></span> <span data-ttu-id="0cb4b-112">Toutefois, s'il existe des lignes sur l'Abonné qui ne satisfont plus aux critères de filtre (relatives en l'occurrence aux commandes qui datent de plus de sept jours), elles ne sont supprimées de l'Abonné que si elles ont été mises à jour pour une raison quelconque.</span><span class="sxs-lookup"><span data-stu-id="0cb4b-112">However, if there are rows at the Subscriber that no longer satisfy the filter (they are for orders older than seven days), they are not removed from the Subscriber unless they were updated for some other reason.</span></span>  
  
 <span data-ttu-id="0cb4b-113">Le cas du planificateur d'événements met davantage en lumière le problème lié à ce type de filtrage.</span><span class="sxs-lookup"><span data-stu-id="0cb4b-113">The case of the event planner further highlights the issue with this type of filtering.</span></span> <span data-ttu-id="0cb4b-114">Considérons le filtre suivant pour une table **Events** :</span><span class="sxs-lookup"><span data-stu-id="0cb4b-114">Consider the following filter for an **Events** table:</span></span>  
  
```  
WHERE EventCoordID = CONVERT(INT,HOST_NAME()) AND EventDate <= (GETDATE()+6)  
```  
  
 <span data-ttu-id="0cb4b-115">Dans le cas d'une table qui contient des événements, les insertions peuvent être réalisées largement à l'avance par rapport à la date de l'événement.</span><span class="sxs-lookup"><span data-stu-id="0cb4b-115">For a table that contains events, inserts might be made well ahead of the event date.</span></span> <span data-ttu-id="0cb4b-116">Si l'insertion d'un événement qui doit avoir lieu au cours de la semaine à venir a été réalisée avec un mois d'avance et que la ligne n'a pas été mise à jour pour une raison quelconque, la ligne n'est pas répliquée vers l'Abonné même si elle satisfait aux critères du filtre de lignes.</span><span class="sxs-lookup"><span data-stu-id="0cb4b-116">If the insert for an event in the coming week was made a month ago and the row was not updated for another reason, the row is not replicated to the Subscriber even if it satisfies the row filter.</span></span>  
  
 <span data-ttu-id="0cb4b-117">En outre, suivant la configuration de la publication, la réplication de fusion évalue les filtres à différents moments :</span><span class="sxs-lookup"><span data-stu-id="0cb4b-117">In addition, depending on how the publication is configured, merge replication evaluates filters at different times:</span></span>  
  
-   <span data-ttu-id="0cb4b-118">Si une publication utilise des partitions précalculées (configuration par défaut), les filtres sont évalués lorsqu'une ligne est insérée ou mise à jour.</span><span class="sxs-lookup"><span data-stu-id="0cb4b-118">If a publication uses precomputed partitions (the default), filters are evaluated when a row is inserted or updated.</span></span>  
  
-   <span data-ttu-id="0cb4b-119">Si la publication n'utilise pas de partitions précalculées, les filtres sont évalués à l'exécution de l'Agent de fusion.</span><span class="sxs-lookup"><span data-stu-id="0cb4b-119">If the publication does not use precomputed partitions, filters are evaluated when the Merge Agent runs.</span></span>  
  
 <span data-ttu-id="0cb4b-120">Pour plus d’informations sur les partitions précalculées, consultez [Optimiser les performances des filtres paramétrés avec des partitions précalculées](parameterized-filters-optimize-for-precomputed-partitions.md).</span><span class="sxs-lookup"><span data-stu-id="0cb4b-120">For more information about precomputed partitions, see [Optimize Parameterized Filter Performance with Precomputed Partitions](parameterized-filters-optimize-for-precomputed-partitions.md).</span></span> <span data-ttu-id="0cb4b-121">Le moment auquel le filtre est évalué détermine les données qui satisfont aux critères de ce filtre.</span><span class="sxs-lookup"><span data-stu-id="0cb4b-121">The time at which the filter is evaluated affects what data satisfies the filter.</span></span> <span data-ttu-id="0cb4b-122">Par exemple, si une publication utilise des partitions précalculées et que vous synchronisez les données tous les deux jours, le sous-ensemble de données pour le vendeur peut comprendre des lignes dont l'ancienneté dépasse les deux jours prévus.</span><span class="sxs-lookup"><span data-stu-id="0cb4b-122">For example, if a publication uses precomputed partitions, and you synchronize data every two days, the subset of data for the salesperson could include rows up to two days older than expected.</span></span>  
  
## <a name="recommendations-for-using-time-based-row-filters"></a><span data-ttu-id="0cb4b-123">Recommandations pour l'utilisation de filtres de lignes basés sur le temps</span><span class="sxs-lookup"><span data-stu-id="0cb4b-123">Recommendations for Using Time-Based Row Filters</span></span>  
 <span data-ttu-id="0cb4b-124">La méthode suivante propose une approche fiable et directe du filtrage en fonction du temps :</span><span class="sxs-lookup"><span data-stu-id="0cb4b-124">The following method provides a robust and straightforward approach to filtering based on time:</span></span>  
  
-   <span data-ttu-id="0cb4b-125">Ajoutez une colonne à la table de type de données `bit`.</span><span class="sxs-lookup"><span data-stu-id="0cb4b-125">Add a column to the table of data type `bit`.</span></span> <span data-ttu-id="0cb4b-126">Cette colonne permet d'indiquer si une ligne doit être répliquée.</span><span class="sxs-lookup"><span data-stu-id="0cb4b-126">This column is used to indicate whether a row should be replicated.</span></span>  
  
-   <span data-ttu-id="0cb4b-127">Utilisez un filtre de lignes qui référence la nouvelle colonne plutôt qu'une colonne basée sur le temps.</span><span class="sxs-lookup"><span data-stu-id="0cb4b-127">Use a row filter that references the new column rather than a time-based column.</span></span>  
  
-   <span data-ttu-id="0cb4b-128">Créez un travail de l'Agent SQL Server (ou un travail planifié par le biais d'un autre mécanisme) qui met à jour la colonne avant que ne soit planifiée l'exécution de l'Agent de fusion.</span><span class="sxs-lookup"><span data-stu-id="0cb4b-128">Create a SQL Server Agent job (or a job scheduled through another mechanism) that updates the column before the Merge Agent is scheduled to run.</span></span>  
  
 <span data-ttu-id="0cb4b-129">Cette approche pallie les points faibles de l'utilisation de `GETDATE()` ou d'une autre méthode basée sur le temps et évite d'avoir à déterminer à quel moment les filtres sont évalués pour les partitions.</span><span class="sxs-lookup"><span data-stu-id="0cb4b-129">This approach addresses the shortcomings of using `GETDATE()` or another time-based method and avoids the problem of having to determine when filters are evaluated for partitions.</span></span> <span data-ttu-id="0cb4b-130">Considérons l'exemple suivant d'une table **Events** :</span><span class="sxs-lookup"><span data-stu-id="0cb4b-130">Consider the following example of an **Events** table:</span></span>  
  
|<span data-ttu-id="0cb4b-131">**EventID**</span><span class="sxs-lookup"><span data-stu-id="0cb4b-131">**EventID**</span></span>|<span data-ttu-id="0cb4b-132">**EventName**</span><span class="sxs-lookup"><span data-stu-id="0cb4b-132">**EventName**</span></span>|<span data-ttu-id="0cb4b-133">**EventCoordID**</span><span class="sxs-lookup"><span data-stu-id="0cb4b-133">**EventCoordID**</span></span>|<span data-ttu-id="0cb4b-134">**EventDate**</span><span class="sxs-lookup"><span data-stu-id="0cb4b-134">**EventDate**</span></span>|<span data-ttu-id="0cb4b-135">**Réplication**</span><span class="sxs-lookup"><span data-stu-id="0cb4b-135">**Replicate**</span></span>|  
|-----------------|-------------------|----------------------|-------------------|-------------------|  
|<span data-ttu-id="0cb4b-136">1</span><span class="sxs-lookup"><span data-stu-id="0cb4b-136">1</span></span>|<span data-ttu-id="0cb4b-137">Réception</span><span class="sxs-lookup"><span data-stu-id="0cb4b-137">Reception</span></span>|<span data-ttu-id="0cb4b-138">112</span><span class="sxs-lookup"><span data-stu-id="0cb4b-138">112</span></span>|<span data-ttu-id="0cb4b-139">2006-10-04</span><span class="sxs-lookup"><span data-stu-id="0cb4b-139">2006-10-04</span></span>|<span data-ttu-id="0cb4b-140">1</span><span class="sxs-lookup"><span data-stu-id="0cb4b-140">1</span></span>|  
|<span data-ttu-id="0cb4b-141">2</span><span class="sxs-lookup"><span data-stu-id="0cb4b-141">2</span></span>|<span data-ttu-id="0cb4b-142">Dîner</span><span class="sxs-lookup"><span data-stu-id="0cb4b-142">Dinner</span></span>|<span data-ttu-id="0cb4b-143">112</span><span class="sxs-lookup"><span data-stu-id="0cb4b-143">112</span></span>|<span data-ttu-id="0cb4b-144">2006-10-10</span><span class="sxs-lookup"><span data-stu-id="0cb4b-144">2006-10-10</span></span>|<span data-ttu-id="0cb4b-145">0</span><span class="sxs-lookup"><span data-stu-id="0cb4b-145">0</span></span>|  
|<span data-ttu-id="0cb4b-146">3</span><span class="sxs-lookup"><span data-stu-id="0cb4b-146">3</span></span>|<span data-ttu-id="0cb4b-147">Soirée</span><span class="sxs-lookup"><span data-stu-id="0cb4b-147">Party</span></span>|<span data-ttu-id="0cb4b-148">112</span><span class="sxs-lookup"><span data-stu-id="0cb4b-148">112</span></span>|<span data-ttu-id="0cb4b-149">2006-10-11</span><span class="sxs-lookup"><span data-stu-id="0cb4b-149">2006-10-11</span></span>|<span data-ttu-id="0cb4b-150">0</span><span class="sxs-lookup"><span data-stu-id="0cb4b-150">0</span></span>|  
|<span data-ttu-id="0cb4b-151">4</span><span class="sxs-lookup"><span data-stu-id="0cb4b-151">4</span></span>|<span data-ttu-id="0cb4b-152">Mariage</span><span class="sxs-lookup"><span data-stu-id="0cb4b-152">Wedding</span></span>|<span data-ttu-id="0cb4b-153">112</span><span class="sxs-lookup"><span data-stu-id="0cb4b-153">112</span></span>|<span data-ttu-id="0cb4b-154">2006-10-12</span><span class="sxs-lookup"><span data-stu-id="0cb4b-154">2006-10-12</span></span>|<span data-ttu-id="0cb4b-155">0</span><span class="sxs-lookup"><span data-stu-id="0cb4b-155">0</span></span>|  
  
 <span data-ttu-id="0cb4b-156">Le filtre de lignes de cette table ressemblerait à ceci :</span><span class="sxs-lookup"><span data-stu-id="0cb4b-156">The row filter for this table would then look like this:</span></span>  
  
```  
WHERE EventCoordID = CONVERT(INT,HOST_NAME()) AND Replicate = 1  
```  
  
 <span data-ttu-id="0cb4b-157">Le travail de l'Agent SQL Server pourrait exécuter des instructions [!INCLUDE[tsql](../../../includes/tsql-md.md)] similaires à la suivante avant chaque exécution de l'Agent de fusion :</span><span class="sxs-lookup"><span data-stu-id="0cb4b-157">The SQL Server Agent job could execute [!INCLUDE[tsql](../../../includes/tsql-md.md)] statements similar to the following before each Merge Agent run:</span></span>  
  
```  
UPDATE Events SET Replicate = 0 WHERE Replicate = 1  
GO  
UPDATE Events SET Replicate = 1 WHERE EventDate <= GETDATE()+6  
GO  
```  
  
 <span data-ttu-id="0cb4b-158">La première ligne réinitialise la colonne **Replicate** à **0**, tandis que la seconde lui attribue la valeur **1** pour les événements qui se produiront au cours des sept prochains jours.</span><span class="sxs-lookup"><span data-stu-id="0cb4b-158">The first line resets the **Replicate** column to **0**, and the second line sets the column to **1** for events that occur in the next seven days.</span></span> <span data-ttu-id="0cb4b-159">Si cette instruction [!INCLUDE[tsql](../../../includes/tsql-md.md)] s'exécute le 07/10/2006, la table, une fois mise à jour, présentera l'aspect suivant :</span><span class="sxs-lookup"><span data-stu-id="0cb4b-159">If this [!INCLUDE[tsql](../../../includes/tsql-md.md)] statement runs on 10/07/2006, the table is updated to:</span></span>  
  
|<span data-ttu-id="0cb4b-160">**EventID**</span><span class="sxs-lookup"><span data-stu-id="0cb4b-160">**EventID**</span></span>|<span data-ttu-id="0cb4b-161">**EventName**</span><span class="sxs-lookup"><span data-stu-id="0cb4b-161">**EventName**</span></span>|<span data-ttu-id="0cb4b-162">**EventCoordID**</span><span class="sxs-lookup"><span data-stu-id="0cb4b-162">**EventCoordID**</span></span>|<span data-ttu-id="0cb4b-163">**EventDate**</span><span class="sxs-lookup"><span data-stu-id="0cb4b-163">**EventDate**</span></span>|<span data-ttu-id="0cb4b-164">**Réplication**</span><span class="sxs-lookup"><span data-stu-id="0cb4b-164">**Replicate**</span></span>|  
|-----------------|-------------------|----------------------|-------------------|-------------------|  
|<span data-ttu-id="0cb4b-165">1</span><span class="sxs-lookup"><span data-stu-id="0cb4b-165">1</span></span>|<span data-ttu-id="0cb4b-166">Réception</span><span class="sxs-lookup"><span data-stu-id="0cb4b-166">Reception</span></span>|<span data-ttu-id="0cb4b-167">112</span><span class="sxs-lookup"><span data-stu-id="0cb4b-167">112</span></span>|<span data-ttu-id="0cb4b-168">2006-10-04</span><span class="sxs-lookup"><span data-stu-id="0cb4b-168">2006-10-04</span></span>|<span data-ttu-id="0cb4b-169">0</span><span class="sxs-lookup"><span data-stu-id="0cb4b-169">0</span></span>|  
|<span data-ttu-id="0cb4b-170">2</span><span class="sxs-lookup"><span data-stu-id="0cb4b-170">2</span></span>|<span data-ttu-id="0cb4b-171">Dîner</span><span class="sxs-lookup"><span data-stu-id="0cb4b-171">Dinner</span></span>|<span data-ttu-id="0cb4b-172">112</span><span class="sxs-lookup"><span data-stu-id="0cb4b-172">112</span></span>|<span data-ttu-id="0cb4b-173">2006-10-10</span><span class="sxs-lookup"><span data-stu-id="0cb4b-173">2006-10-10</span></span>|<span data-ttu-id="0cb4b-174">1</span><span class="sxs-lookup"><span data-stu-id="0cb4b-174">1</span></span>|  
|<span data-ttu-id="0cb4b-175">3</span><span class="sxs-lookup"><span data-stu-id="0cb4b-175">3</span></span>|<span data-ttu-id="0cb4b-176">Soirée</span><span class="sxs-lookup"><span data-stu-id="0cb4b-176">Party</span></span>|<span data-ttu-id="0cb4b-177">112</span><span class="sxs-lookup"><span data-stu-id="0cb4b-177">112</span></span>|<span data-ttu-id="0cb4b-178">2006-10-11</span><span class="sxs-lookup"><span data-stu-id="0cb4b-178">2006-10-11</span></span>|<span data-ttu-id="0cb4b-179">1</span><span class="sxs-lookup"><span data-stu-id="0cb4b-179">1</span></span>|  
|<span data-ttu-id="0cb4b-180">4</span><span class="sxs-lookup"><span data-stu-id="0cb4b-180">4</span></span>|<span data-ttu-id="0cb4b-181">Mariage</span><span class="sxs-lookup"><span data-stu-id="0cb4b-181">Wedding</span></span>|<span data-ttu-id="0cb4b-182">112</span><span class="sxs-lookup"><span data-stu-id="0cb4b-182">112</span></span>|<span data-ttu-id="0cb4b-183">2006-10-12</span><span class="sxs-lookup"><span data-stu-id="0cb4b-183">2006-10-12</span></span>|<span data-ttu-id="0cb4b-184">1</span><span class="sxs-lookup"><span data-stu-id="0cb4b-184">1</span></span>|  
  
 <span data-ttu-id="0cb4b-185">Les événements relatifs à la semaine à venir sont désormais signalés comme étant prêts à être répliqués.</span><span class="sxs-lookup"><span data-stu-id="0cb4b-185">The events for the next week are now flagged as being ready to replicate.</span></span> <span data-ttu-id="0cb4b-186">La prochaine fois que l'Agent de fusion s'exécutera pour l'abonnement utilisé par le coordinateur d'événements 112, les lignes 2, 3 et 4 seront téléchargées vers l'Abonné tandis que la ligne 1 sera supprimée de celui-ci.</span><span class="sxs-lookup"><span data-stu-id="0cb4b-186">The next time the Merge Agent runs for the subscription that event coordinator 112 uses, rows 2, 3, and 4 will be downloaded to the Subscriber and row 1 will be removed from the Subscriber.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="0cb4b-187">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="0cb4b-187">See Also</span></span>  
 <span data-ttu-id="0cb4b-188">[GETDATE &#40;Transact-SQL&#41;](/sql/t-sql/functions/getdate-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="0cb4b-188">[GETDATE &#40;Transact-SQL&#41;](/sql/t-sql/functions/getdate-transact-sql) </span></span>  
 <span data-ttu-id="0cb4b-189">[Implémenter des travaux](../../../ssms/agent/implement-jobs.md) </span><span class="sxs-lookup"><span data-stu-id="0cb4b-189">[Implement Jobs](../../../ssms/agent/implement-jobs.md) </span></span>  
 [<span data-ttu-id="0cb4b-190">Filtres de lignes paramétrés</span><span class="sxs-lookup"><span data-stu-id="0cb4b-190">Parameterized Row Filters</span></span>](parameterized-filters-parameterized-row-filters.md)  
  
  
