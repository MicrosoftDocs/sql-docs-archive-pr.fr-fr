---
title: Publication de l’exécution de procédures stockées dans la réplication transactionnelle | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: replication
ms.topic: conceptual
helpviewer_keywords:
- publishing [SQL Server replication], stored procedure execution
- articles [SQL Server replication], stored procedures and
- transactional replication, publishing stored procedure execution
ms.assetid: f4686f6f-c224-4f07-a7cb-92f4dd483158
author: MashaMSFT
ms.author: mathoma
ms.openlocfilehash: 0fb5c40db46772cabcb5d1df19e03aced749e1c6
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87706367"
---
# <a name="publishing-stored-procedure-execution-in-transactional-replication"></a><span data-ttu-id="d5eb5-102">Publication de l'exécution de procédures stockées dans la réplication transactionnelle</span><span class="sxs-lookup"><span data-stu-id="d5eb5-102">Publishing Stored Procedure Execution in Transactional Replication</span></span>
  <span data-ttu-id="d5eb5-103">Si vous avez une ou plusieurs procédures stockées qui s'exécutent sur le serveur de publication et qui affectent des tables publiées, vous pouvez envisager d'inclure ces procédures stockées dans votre publication en tant qu'articles d'exécution de procédure stockée.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-103">If you have one or more stored procedures that execute at the Publisher and affect published tables, consider including those stored procedures in your publication as stored procedure execution articles.</span></span> <span data-ttu-id="d5eb5-104">La définition de la procédure (l'instruction CREATE PROCEDURE) est répliquée vers l'Abonné quand l'abonnement est initialisé ; quand la procédure est exécutée sur le serveur de publication, la réplication exécute la procédure correspondante sur l'Abonné.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-104">The definition of the procedure (the CREATE PROCEDURE statement) is replicated to the Subscriber when the subscription is initialized; when the procedure is executed at the Publisher, replication executes the corresponding procedure at the Subscriber.</span></span> <span data-ttu-id="d5eb5-105">Cela peut apporter des performances significativement meilleures dans les cas où de grosses opérations de traitement sont effectuées, car seule l'exécution de la procédure est répliquée, ce qui élimine la nécessité de répliquer les modifications individuelles pour chaque ligne.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-105">This can provide significantly better performance for cases where large batch operations are performed, because only the procedure execution is replicated, bypassing the need to replicate the individual changes for each row.</span></span> <span data-ttu-id="d5eb5-106">Supposons par exemple que vous créez la procédure stockée suivante dans la base de données de publication :</span><span class="sxs-lookup"><span data-stu-id="d5eb5-106">For example, assume you create the following stored procedure in the publication database:</span></span>  
  
```  
CREATE PROC give_raise AS  
UPDATE EMPLOYEES SET salary = salary * 1.10  
```  
  
 <span data-ttu-id="d5eb5-107">Cette procédure accorde à chacun des 10 000 employés de la société une augmentation de salaire de 10 %.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-107">This procedure gives each of the 10,000 employees in your company a 10 percent pay increase.</span></span> <span data-ttu-id="d5eb5-108">Lorsque vous exécutez cette procédure stockée sur le serveur de publication, le salaire de chaque employé est mis à jour.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-108">When you execute this stored procedure at the Publisher, it updates the salary for each employee.</span></span> <span data-ttu-id="d5eb5-109">Sans la réplication de l'exécution de la procédure stockée, la mise à jour est envoyée aux Abonnés comme une grosse transaction comportant plusieurs étapes :</span><span class="sxs-lookup"><span data-stu-id="d5eb5-109">Without the replication of stored procedure execution, the update would be sent to Subscribers as a large, multi-step transaction:</span></span>  
  
```  
BEGIN TRAN  
UPDATE EMPLOYEES SET salary = salary * 1.10 WHERE PK = 'emp 1'  
UPDATE EMPLOYEES SET salary = salary * 1.10 WHERE PK = 'emp 2'  
```  
  
 <span data-ttu-id="d5eb5-110">Et ceci se répète pour les 10 000 mises à jour.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-110">And this repeats for 10,000 updates.</span></span>  
  
 <span data-ttu-id="d5eb5-111">Avec la réplication de l'exécution de procédure stockée, la réplication envoie seulement la commande pour exécuter la procédure stockée sur l'Abonné, au lieu d'écrire toutes les mises à jour dans la base de données de distribution, puis de les envoyer à l'Abonné via le réseau :</span><span class="sxs-lookup"><span data-stu-id="d5eb5-111">With the replication of stored procedure execution, replication sends only the command to execute the stored procedure at the Subscriber, rather than writing all the updates to the distribution database and then sending them over the network to the Subscriber:</span></span>  
  
```  
EXEC give_raise  
```  
  
> [!IMPORTANT]  
>  <span data-ttu-id="d5eb5-112">La réplication des procédures stockées ne convient pas à toutes les applications.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-112">Stored procedure replication is not appropriate for all applications.</span></span> <span data-ttu-id="d5eb5-113">Si un article est filtré horizontalement, de sorte que les ensembles de lignes soient différents sur l'éditeur et sur l'abonné, l'exécution de la même procédure stockée sur les deux serveurs donne des résultats différents.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-113">If an article is filtered horizontally, so that there are different sets of rows at the Publisher than at the Subscriber, executing the same stored procedure at both returns different results.</span></span> <span data-ttu-id="d5eb5-114">De même, si une mise à jour est basée sur la sous-requête d'une autre table non répliquée, l'exécution de la même procédure stockée  sur le serveur de publication et sur l'Abonné renvoie des résultats différents.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-114">Similarly, if an update is based on a subquery of another, nonreplicated table, executing the same stored procedure at both the Publisher and Subscriber returns different results.</span></span>  
  
 <span data-ttu-id="d5eb5-115">**Pour publier l'exécution d'une procédure stockée**</span><span class="sxs-lookup"><span data-stu-id="d5eb5-115">**To publish the execution of a stored procedure**</span></span>  
  
-   <span data-ttu-id="d5eb5-116">SQL Server Management Studio : [Publier l’exécution d’une procédure stockée dans une publication transactionnelle &#40;SQL Server Management Studio&#41;](../publish/publish-execution-of-stored-procedure-in-transactional-publication.md)</span><span class="sxs-lookup"><span data-stu-id="d5eb5-116">SQL Server Management Studio: [Publish the Execution of a Stored Procedure in a Transactional Publication &#40;SQL Server Management Studio&#41;](../publish/publish-execution-of-stored-procedure-in-transactional-publication.md)</span></span>  
  
-   <span data-ttu-id="d5eb5-117">Programmation Transact-SQL de la réplication : exécutez [sp_addarticle &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-addarticle-transact-sql) et spécifiez la valeur 'serializable proc exec' (recommandé) ou 'proc exec' pour le paramètre **@type**.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-117">Replication Transact-SQL Programming: execute [sp_addarticle &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-addarticle-transact-sql) and specify a value of 'serializable proc exec' (recommended) or 'proc exec' for the parameter **@type**.</span></span> <span data-ttu-id="d5eb5-118">Pour plus d’informations sur la définition d’articles, consultez [Définir un article](../publish/define-an-article.md).</span><span class="sxs-lookup"><span data-stu-id="d5eb5-118">For more information about defining articles, see [Define an Article](../publish/define-an-article.md).</span></span>  
  
## <a name="modifying-the-procedure-at-the-subscriber"></a><span data-ttu-id="d5eb5-119">Modification de la procédure sur l'Abonné</span><span class="sxs-lookup"><span data-stu-id="d5eb5-119">Modifying the Procedure at the Subscriber</span></span>  
 <span data-ttu-id="d5eb5-120">Par défaut, la définition de la procédure stockée sur le serveur de publication est propagée vers chaque Abonné.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-120">By default, the stored procedure definition at the Publisher is propagated to each Subscriber.</span></span> <span data-ttu-id="d5eb5-121">Cependant, vous pouvez aussi modifier la procédure stockée sur l'Abonné.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-121">However, you can also modify the stored procedure at the Subscriber.</span></span> <span data-ttu-id="d5eb5-122">Ceci est utile si vous souhaitez que des logiques différentes soient exécutées sur le serveur de publication et sur l'Abonné.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-122">This is useful if you want different logic to be executed at the Publisher and Subscriber.</span></span> <span data-ttu-id="d5eb5-123">Considérons par exemple la procédure stockée sur le serveur de publication **sp_big_delete**, qui a deux fonctions : elle supprime 1 000 000 de lignes de la table répliquée **big_table1** et met à jour la table non répliquée **big_table2**.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-123">For example, consider **sp_big_delete**, a stored procedure at the Publisher that has two functions: it deletes 1,000,000 rows from the replicated table **big_table1** and updates the nonreplicated table **big_table2**.</span></span> <span data-ttu-id="d5eb5-124">Pour solliciter moins de ressources réseau, vous pouvez transmettre la suppression de ce million de lignes en tant que procédure stockée en publiant **sp_big_delete**.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-124">To reduce the demand on network resources, you should propagate the 1 million row delete as a stored procedure by publishing **sp_big_delete**.</span></span> <span data-ttu-id="d5eb5-125">Sur l'Abonné, vous pouvez modifier **sp_big_delete** afin qu'elle supprime le million de lignes sans effectuer ensuite la mise à jour de **big_table2**.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-125">At the Subscriber, you can modify **sp_big_delete** to delete only the 1 million rows and not perform the subsequent update to **big_table2**.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="d5eb5-126">Par défaut, toutes les modifications effectuées à l'aide de ALTER PROCEDURE sur le serveur de publication sont propagées vers l'Abonné.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-126">By default, any changes made using ALTER PROCEDURE at the Publisher are propagated to the Subscriber.</span></span> <span data-ttu-id="d5eb5-127">Pour éviter cela, désactivez la propagation des modifications de schéma avant d'exécuter ALTER PROCEDURE.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-127">To prevent this, disable the propagation of schema changes before executing ALTER PROCEDURE.</span></span> <span data-ttu-id="d5eb5-128">Pour obtenir des informations sur les modifications de schéma, consultez [Modifier le schéma dans les bases de données de publication](../publish/make-schema-changes-on-publication-databases.md).</span><span class="sxs-lookup"><span data-stu-id="d5eb5-128">For information about schema changes, see [Make Schema Changes on Publication Databases](../publish/make-schema-changes-on-publication-databases.md).</span></span>  
  
## <a name="types-of-stored-procedure-execution-articles"></a><span data-ttu-id="d5eb5-129">Types d'articles d'exécution de procédure stockée</span><span class="sxs-lookup"><span data-stu-id="d5eb5-129">Types of Stored Procedure Execution Articles</span></span>  
 <span data-ttu-id="d5eb5-130">Il existe deux manières de publier l'exécution d'une procédure stockée : article d'exécution de procédure sérialisable et article d'exécution de procédure.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-130">There are two different ways in which the execution of a stored procedure can be published: serializable procedure execution article and procedure execution article.</span></span>  
  
-   <span data-ttu-id="d5eb5-131">L'option sérialisable est recommandée car elle réplique l'exécution de la procédure seulement si la procédure est exécutée dans le contexte d'une transaction sérialisable.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-131">The serializable option is recommended because it replicates the procedure execution only if the procedure is executed within the context of a serializable transaction.</span></span> <span data-ttu-id="d5eb5-132">Si la procédure stockée est exécutée en dehors d'une transaction sérialisable, les modifications apportées aux données dans les tables publiées sont répliquées sous la forme d'une série d'instructions DML.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-132">If the stored procedure is executed from outside a serializable transaction, changes to data in published tables are replicated as a series of DML statements.</span></span> <span data-ttu-id="d5eb5-133">Ceci favorise la mise en cohérence des données côté abonné avec celles côté éditeur</span><span class="sxs-lookup"><span data-stu-id="d5eb5-133">This behavior contributes to making data at the Subscriber consistent with data at the Publisher.</span></span> <span data-ttu-id="d5eb5-134">et s'avère particulièrement utile pour les opérations de traitement, telles que les opérations de nettoyage importantes.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-134">This is especially useful for batch operations, such as large cleanup operations.</span></span>  
  
-   <span data-ttu-id="d5eb5-135">Avec l'option d'exécution de procédure, il est possible que l'exécution de la procédure soit répliquée vers tous les abonnés, indépendamment du fait que des instructions individuelles de la procédure stockée aient réussi ou non.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-135">With the procedure execution option, it is possible that execution could be replicated to all Subscribers regardless of whether individual statements in the stored procedure were successful.</span></span> <span data-ttu-id="d5eb5-136">En outre, étant donné que les modifications apportées aux données par la procédure stockée peuvent émaner de transactions multiples, il se peut que les données des abonnés ne soient pas identiques à celles du serveur de publication.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-136">Furthermore, because changes made to data by the stored procedure can occur within multiple transactions, data at the Subscribers might not be consistent with data at the Publisher.</span></span> <span data-ttu-id="d5eb5-137">Pour traiter ces problèmes, il est requis que les abonnés soient en lecture seule et que vous utilisiez un niveau d'isolement supérieur à la lecture non validée.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-137">To address these issues, it is required that Subscribers are read-only and that you use an isolation level greater than read uncommitted.</span></span> <span data-ttu-id="d5eb5-138">Si vous utilisez une lecture non validée, les modifications apportées aux données dans les tables publiées sont répliquées comme une série d'instructions DML.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-138">If you use read uncommitted, changes to data in published tables are replicated as a series of DML statements.</span></span>  
  
 <span data-ttu-id="d5eb5-139">L'exemple suivant illustre l'intérêt de configurer une réplication de procédures en tant qu'articles de procédures sérialisables.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-139">The following example illustrates why it is recommended that you set up replication of procedures as serializable procedure articles.</span></span>  
  
```  
BEGIN TRANSACTION T1  
SELECT @var = max(col1) FROM tableA  
UPDATE tableA SET col2 = <value>   
   WHERE col1 = @var   
  
BEGIN TRANSACTION T2  
INSERT tableA VALUES <values>  
COMMIT TRANSACTION T2  
```  
  
 <span data-ttu-id="d5eb5-140">Dans l'exemple précédent, il est supposé que l'instruction SELECT de la transaction T1 intervient avant l'instruction INSERT de la transaction T2.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-140">In the previous example, it is assumed that the SELECT in transaction T1 happens before the INSERT in transaction T2.</span></span>  
  
 <span data-ttu-id="d5eb5-141">Si la procédure n'est pas exécutée dans une transaction sérialisable (avec le niveau d'isolement SERIALIZABLE), la transaction T2 sera autorisée à insérer une nouvelle ligne dans la plage de l'instruction SELECT de T1 et sa validation interviendra avant celle de T1.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-141">If the procedure is not executed within a serializable transaction (with isolation level set to SERIALIZABLE), transaction T2 will be allowed to insert a new row within the range of the SELECT statement in T1 and it will commit before T1.</span></span> <span data-ttu-id="d5eb5-142">Cela signifie également qu'elle sera appliquée sur l'abonné avant T1.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-142">This also means that it will be applied at the Subscriber before T1.</span></span> <span data-ttu-id="d5eb5-143">Lorsque T1 est appliquée sur l'abonné, l'instruction SELECT peut, le cas échéant, renvoyer une valeur différente de celle issue de l'application sur l'éditeur et aboutir à un résultat différent de celui de l'instruction UPDATE.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-143">When T1 is applied at the Subscriber, the SELECT can potentially return a different value than at the Publisher and can result in a different outcome from the UPDATE.</span></span>  
  
 <span data-ttu-id="d5eb5-144">Si la procédure est exécutée dans une transaction sérialisable, la transaction T2 ne sera pas autorisée à opérer des insertions dans la plage couverte par l'instruction SELECT de T2.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-144">If the procedure is executed within a serializable transaction, transaction T2 will not be allowed to insert within the range covered by the SELECT statement in T2.</span></span> <span data-ttu-id="d5eb5-145">Elle sera neutralisée jusqu'à la validation de T1, ce qui garantit des résultats similaires sur l'abonné.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-145">It will be blocked until T1 commits ensuring the same results at the Subscriber.</span></span>  
  
 <span data-ttu-id="d5eb5-146">Les verrous sont conservés plus longtemps lorsque vous exécutez la procédure dans une transaction sérialisable et peuvent aboutir à une concurrence d'accès réduite.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-146">Locks will be held longer when you execute the procedure within a serializable transaction and may result in reduced concurrency.</span></span>  
  
## <a name="the-xact_abort-setting"></a><span data-ttu-id="d5eb5-147">Le paramètre XACT_ABORT</span><span class="sxs-lookup"><span data-stu-id="d5eb5-147">The XACT_ABORT Setting</span></span>  
 <span data-ttu-id="d5eb5-148">Lors de la réplication de l'exécution d'une procédure stockée, le paramétrage de la session exécutant la procédure stockée doit spécifier XACT_ABORT ON.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-148">When replicating stored procedure execution, the setting for the session executing the stored procedure should specify XACT_ABORT ON.</span></span> <span data-ttu-id="d5eb5-149">Si XACT_ABORT est défini à OFF et qu'une erreur se produit lors de l'exécution de la procédure sur le serveur de publication, la même erreur se produira sur l'Abonné, provoquant l'échec de l'Agent de distribution.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-149">If XACT_ABORT is set to OFF, and an error occurs during execution of the procedure at the Publisher, the same error will occur at the Subscriber, causing the Distribution Agent to fail.</span></span> <span data-ttu-id="d5eb5-150">Le fait de spécifier XACT_ABORT ON garantit que toute erreur rencontrée lors de l'exécution sur le serveur de publication provoque l'annulation de la totalité de l'exécution, évitant ainsi l'échec de l'Agent de distribution.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-150">Specifying XACT_ABORT ON ensures that any errors encountered during execution at the Publisher cause the entire execution to be rolled back, avoiding the Distribution Agent failure.</span></span> <span data-ttu-id="d5eb5-151">Pour plus d’informations sur la définition de XACT_ABORT, consultez [SET XACT_ABORT &#40;Transact-SQL&#41;](/sql/t-sql/statements/set-xact-abort-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="d5eb5-151">For more information about setting XACT_ABORT, see [SET XACT_ABORT &#40;Transact-SQL&#41;](/sql/t-sql/statements/set-xact-abort-transact-sql).</span></span>  
  
 <span data-ttu-id="d5eb5-152">Si vous devez définir le paramètre XACT_ABORT à OFF, spécifiez le paramètre **-SkipErrors** pour l'Agent de distribution.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-152">If you require a setting of XACT_ABORT OFF, specify the **-SkipErrors** parameter for the Distribution Agent.</span></span> <span data-ttu-id="d5eb5-153">Cela permet à l'agent de continuer l'application des modifications sur l'Abonné même si une erreur est rencontrée.</span><span class="sxs-lookup"><span data-stu-id="d5eb5-153">This allows the agent to continue applying changes at the Subscriber even if an error is encountered.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="d5eb5-154">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="d5eb5-154">See Also</span></span>  
 [<span data-ttu-id="d5eb5-155">Article Options for Transactional Replication</span><span class="sxs-lookup"><span data-stu-id="d5eb5-155">Article Options for Transactional Replication</span></span>](article-options-for-transactional-replication.md)  
  
  
