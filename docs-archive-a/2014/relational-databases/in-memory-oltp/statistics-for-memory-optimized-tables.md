---
title: Statistiques pour les tables optimisées en mémoire | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: in-memory-oltp
ms.topic: conceptual
ms.assetid: e644766d-1d1c-43d7-83ff-8ccfe4f3af9f
author: rothja
ms.author: jroth
ms.openlocfilehash: 0ae09d76c2642e23c56afcdd5ae4e1e468ef5883
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87708355"
---
# <a name="statistics-for-memory-optimized-tables"></a><span data-ttu-id="9d2cf-102">Statistiques pour les tables optimisées en mémoire</span><span class="sxs-lookup"><span data-stu-id="9d2cf-102">Statistics for Memory-Optimized Tables</span></span>
  <span data-ttu-id="9d2cf-103">L'optimiseur de requête utilise des statistiques sur les colonnes dans l'optique de créer des plans de requête qui améliorent les performances des requêtes.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-103">The query optimizer uses statistics about columns to create query plans that improve query performance.</span></span> <span data-ttu-id="9d2cf-104">Les statistiques sont collectées dans les tables de la base de données et stockées dans les métadonnées de la base de données.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-104">Statistics are collected from the tables in the database and stored in the database metadata.</span></span>  
  
 <span data-ttu-id="9d2cf-105">Les statistiques sont créées automatiquement, mais elles peuvent également être créées manuellement.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-105">Statistics are created automatically, but can also be created manually.</span></span> <span data-ttu-id="9d2cf-106">Par exemple, des statistiques sont créées automatiquement pour les colonnes clés d'index lorsque l'index est créé.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-106">For example, statistics are created automatically for index key columns when the index is created.</span></span> <span data-ttu-id="9d2cf-107">Pour plus d'informations sur la création de statistiques, consultez [Statistics](../statistics/statistics.md).</span><span class="sxs-lookup"><span data-stu-id="9d2cf-107">For more information about creating statistics see [Statistics](../statistics/statistics.md).</span></span>  
  
 <span data-ttu-id="9d2cf-108">Les données de table sont généralement modifiées au fil du temps, à mesure que des lignes sont insérées, mises à jour et supprimées.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-108">Table data typically changes over time as rows are inserted, updated, and deleted.</span></span> <span data-ttu-id="9d2cf-109">Cela signifie que les statistiques doivent être mises à jour régulièrement.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-109">This means statistics need to be updated periodically.</span></span> <span data-ttu-id="9d2cf-110">Par défaut, les statistiques sur les tables sur disque sont mises à jour automatiquement lorsque l'optimiseur détermine qu'elles sont obsolètes.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-110">By default, statistics on disk-based tables are updated automatically when the optimizer determines they might be out of date.</span></span>  
  
 <span data-ttu-id="9d2cf-111">Les statistiques sur les tables mémoire optimisées ne sont pas mises à jour par défaut.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-111">Statistics on memory-optimized tables are not updated by default.</span></span> <span data-ttu-id="9d2cf-112">Vous devez les mettre à jour manuellement.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-112">Instead, you need to update them manually.</span></span> <span data-ttu-id="9d2cf-113">Utilisez [update statistics &#40;&#41;Transact-SQL](/sql/t-sql/statements/update-statistics-transact-sql) pour des colonnes, des index ou des tables individuels.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-113">Use [UPDATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/update-statistics-transact-sql) for individual columns, indexes, or tables.</span></span> <span data-ttu-id="9d2cf-114">Utilisez [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) pour mettre à jour les statistiques de toutes les tables utilisateur et internes de la base de données.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-114">Use [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) to update statistics for all user and internal tables in the database.</span></span>  
  
 <span data-ttu-id="9d2cf-115">Lorsque vous utilisez [create statistics &#40;Transact-sql&#41;](/sql/t-sql/statements/create-statistics-transact-sql) ou [UPDATE statistics &#40;&#41;Transact-SQL ](/sql/t-sql/statements/update-statistics-transact-sql), vous devez spécifier la `NORECOMPUTE` désactivation de la mise à jour automatique des statistiques pour les tables optimisées en mémoire.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-115">When using [CREATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-statistics-transact-sql) or [UPDATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/update-statistics-transact-sql), you must specify `NORECOMPUTE` to disable automatic statistics update for memory-optimized tables.</span></span> <span data-ttu-id="9d2cf-116">Pour les tables sur disque, [sp_updatestats &#40;Transact-sql&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) met à jour les statistiques uniquement si la table a été modifiée depuis la dernière [sp_updatestats &#40;transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="9d2cf-116">For disk based tables, [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) only updates statistics if the table has been modified since the last [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql).</span></span> <span data-ttu-id="9d2cf-117">Pour les tables optimisées en mémoire, [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) génère toujours des statistiques mises à jour.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-117">For memory-optimized tables, [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) always generates updated statistics.</span></span> <span data-ttu-id="9d2cf-118">[sp_updatestats &#40;&#41;Transact-SQL](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) est une bonne option pour les tables optimisées en mémoire ; dans le cas contraire, vous devez connaître les tables qui ont des modifications importantes pour pouvoir mettre à jour les statistiques individuellement.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-118">[sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) is a good option for memory-optimized tables; otherwise you need to know which tables have significant changes so you can update statistics individually.</span></span>  
  
 <span data-ttu-id="9d2cf-119">Les statistiques peuvent être générées lors de l'échantillonnage des données ou d'une analyse complète.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-119">Statistics can either be generated by either sampling the data or performing a full scan.</span></span> <span data-ttu-id="9d2cf-120">Les statistiques échantillonnées n'utilisent qu'un échantillon des données de la table pour estimer la distribution des données.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-120">Sampled statistics only use a sample of the table data to estimate the data distribution.</span></span> <span data-ttu-id="9d2cf-121">Les statistiques d'analyse complète analysent la table entière pour déterminer la distribution des données.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-121">Fullscan statistics scan the entire table to determine the data distribution.</span></span> <span data-ttu-id="9d2cf-122">Les statistiques d'analyse complète sont généralement plus précises, mais prennent plus temps pour le calcul.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-122">Fullscan statistics are usually more accurate but take longer to compute.</span></span> <span data-ttu-id="9d2cf-123">Les statistiques échantillonnées sont collectées plus rapidement.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-123">Sampled statistics can be collected faster.</span></span>  
  
 <span data-ttu-id="9d2cf-124">Par défaut, les tables sur disque utilisent des statistiques échantillonnées.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-124">Disk-based tables use sampled statistics by default.</span></span> <span data-ttu-id="9d2cf-125">Les tables mémoire optimisées prennent uniquement en charge les statistiques d'analyse complète.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-125">Memory-optimized tables only support fullscan statistics.</span></span> <span data-ttu-id="9d2cf-126">Lorsque vous utilisez [create statistics &#40;Transact-sql&#41;](/sql/t-sql/statements/create-statistics-transact-sql) ou [UPDATE statistics &#40;&#41;Transact-SQL ](/sql/t-sql/statements/update-statistics-transact-sql), vous devez spécifier l' `FULLSCAN` option pour les tables mémoire optimisées.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-126">When using [CREATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-statistics-transact-sql) or [UPDATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/update-statistics-transact-sql), you must specify the `FULLSCAN` option for memory-optimized tables.</span></span>  
  
 <span data-ttu-id="9d2cf-127">Considérations supplémentaires pour les statistiques sur les tables mémoire optimisées :</span><span class="sxs-lookup"><span data-stu-id="9d2cf-127">Additional considerations for statistics on memory-optimized tables:</span></span>  
  
-   <span data-ttu-id="9d2cf-128">Les index sur les tables mémoire optimisées sont créés avec la table.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-128">Indexes on memory-optimized tables are created with the table.</span></span> <span data-ttu-id="9d2cf-129">Les statistiques sur les colonnes clés d'index sont créées lorsque la table est vide.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-129">The statistics on the index key columns are created when the table is empty.</span></span> <span data-ttu-id="9d2cf-130">Par conséquent, ces statistiques doivent être mises à jour après que les données ont été chargées dans la table.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-130">Therefore, these statistics need to be updated after data is loaded into the table.</span></span>  
  
-   <span data-ttu-id="9d2cf-131">Pour les procédures stockées compilées en mode natif, les plans d'exécution de requêtes dans la procédure sont optimisés lorsque la procédure est compilée.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-131">For natively compiled stored procedures, execution plans for queries in the procedure are optimized when the procedure is compiled.</span></span> <span data-ttu-id="9d2cf-132">Cela se produit uniquement lorsque la procédure est créée et au redémarrage du serveur, et non pas lorsque les statistiques sont mises à jour.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-132">This happens only when the procedure is created and when the server restarts, not when statistics are updated.</span></span> <span data-ttu-id="9d2cf-133">Par conséquent, les tables doivent contenir un jeu représentatif de données et les statistiques doivent être à jour avant de pouvoir créer les procédures.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-133">Therefore, the tables need to contain a representative set of data and statistics need to be up-to-date before the procedures are created.</span></span> <span data-ttu-id="9d2cf-134">(Les procédures stockées compilées en mode natif sont recompilées si la base de données est mise hors connexion, puis remise en ligne, ou en cas de redémarrage du serveur.)</span><span class="sxs-lookup"><span data-stu-id="9d2cf-134">(Natively compiled stored procedures are recompiled if the database is taken offline and brought back online, or if there is a server restart.)</span></span>  
  
## <a name="guidelines-for-statistics-when-deploying-memory-optimized-tables"></a><span data-ttu-id="9d2cf-135">Instructions relatives aux statistiques lors du déploiement de tables mémoire optimisées</span><span class="sxs-lookup"><span data-stu-id="9d2cf-135">Guidelines for Statistics When Deploying Memory-Optimized Tables</span></span>  
 <span data-ttu-id="9d2cf-136">Pour garantir que l'optimiseur de requête dispose de statistiques à jour lorsque vous créez des plans de requête, déployez les tables mémoire optimisées à l'aide de ces cinq étapes :</span><span class="sxs-lookup"><span data-stu-id="9d2cf-136">To ensure that the query optimizer has up-to-date statistics when creating query plans, deploy memory-optimized tables using these five steps:</span></span>  
  
1.  <span data-ttu-id="9d2cf-137">Créez des tables et des index.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-137">Create tables and indexes.</span></span> <span data-ttu-id="9d2cf-138">Les index sont spécifiés inline dans les instructions `CREATE TABLE`.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-138">Indexes are specified inline in the `CREATE TABLE` statements.</span></span>  
  
2.  <span data-ttu-id="9d2cf-139">Chargez des données dans les tables.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-139">Load data into the tables.</span></span>  
  
3.  <span data-ttu-id="9d2cf-140">Mettez à jour les statistiques des tables.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-140">Update statistics on the tables.</span></span>  
  
4.  <span data-ttu-id="9d2cf-141">Créez des procédures stockées qui accèdent aux tables.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-141">Create stored procedures that access the tables.</span></span>  
  
5.  <span data-ttu-id="9d2cf-142">Exécutez la charge de travail, qui peut contenir des procédures stockées [!INCLUDE[tsql](../../../includes/tsql-md.md)] interprétées et compilées en mode natif, ainsi que des traitements ad hoc.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-142">Run the workload, which can contain a mix of natively compiled and interpreted [!INCLUDE[tsql](../../../includes/tsql-md.md)] stored procedures, as well as ad hoc batches.</span></span>  
  
 <span data-ttu-id="9d2cf-143">La création de procédures stockées compilées en mode natif après que vous avez chargé les données et mis à jour les statistiques garantit que l'optimiseur dispose de statistiques pour les tables mémoire optimisées.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-143">Creating natively compiled stored procedures after you load the data and update the statistics ensures that the optimizer has statistics available for the memory-optimized tables.</span></span> <span data-ttu-id="9d2cf-144">De cette façon, les plans de requête sont efficaces lorsque la procédure est compilée.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-144">This will ensure efficient query plans when the procedure is compiled.</span></span>  
  
## <a name="guidelines-for-maintaining-statistics-on-memory-optimized-tables"></a><span data-ttu-id="9d2cf-145">Instructions relatives à la gestion des statistiques de tables mémoire optimisées</span><span class="sxs-lookup"><span data-stu-id="9d2cf-145">Guidelines for Maintaining Statistics on Memory-Optimized Tables</span></span>  
 <span data-ttu-id="9d2cf-146">Pour conserver les statistiques à jour, mettez régulièrement à jour les statistiques de tables mémoire optimisées.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-146">To keep statistics up-to-date, regularly update the statistics on memory-optimized tables.</span></span>  
  
 <span data-ttu-id="9d2cf-147">Si les données sont modifiées fréquemment, mettez à jour les statistiques fréquemment.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-147">If data changes frequently, you should update statistics frequently.</span></span> <span data-ttu-id="9d2cf-148">Par exemple, mettez à jour les statistiques de tables après une mise à jour par lot.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-148">For example, update table statistics after a batch update.</span></span> <span data-ttu-id="9d2cf-149">Après avoir mis à jour les statistiques, supprimez et recréez les procédures stockées compilées en mode natif de façon à ce qu'elles puissent tirer parti des statistiques mises à jour.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-149">After you update statistics, drop and recreate natively compiled stored procedures so they can benefit from the updated statistics.</span></span>  
  
 <span data-ttu-id="9d2cf-150">.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-150">.</span></span>  
  
 <span data-ttu-id="9d2cf-151">Ne mettez pas à jour les statistiques au cours d'une charge importante.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-151">Do not update statistics during peak workload.</span></span>  
  
 <span data-ttu-id="9d2cf-152">Pour mettre à jour les statistiques :</span><span class="sxs-lookup"><span data-stu-id="9d2cf-152">To update statistics:</span></span>  
  
-   <span data-ttu-id="9d2cf-153">Utilisez [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] pour [Create a Maintenance Plan](../maintenance-plans/create-a-maintenance-plan.md) avec une [tâche de mise à jour des statistiques](../maintenance-plans/update-statistics-task-maintenance-plan.md)</span><span class="sxs-lookup"><span data-stu-id="9d2cf-153">Use [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)] to [Create a Maintenance Plan](../maintenance-plans/create-a-maintenance-plan.md) with an [Update Statistic Task](../maintenance-plans/update-statistics-task-maintenance-plan.md)</span></span>  
  
-   <span data-ttu-id="9d2cf-154">Ou mettez à jour les statistiques au moyen d'un script [!INCLUDE[tsql](../../../includes/tsql-md.md)] , tel que l'indique la section suivante.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-154">Or, update statistics through a [!INCLUDE[tsql](../../../includes/tsql-md.md)] script, as discussed below.</span></span>  
  
 <span data-ttu-id="9d2cf-155">Pour mettre à jour les statistiques d'une seule table mémoire optimisée (*myschema*.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-155">To update the statistics for a single memory-optimized table (*myschema*.</span></span> <span data-ttu-id="9d2cf-156">*Mytable*), exécutez le script suivant :</span><span class="sxs-lookup"><span data-stu-id="9d2cf-156">*Mytable*), run the following script:</span></span>  
  
```  
UPDATE STATISTICS myschema.Mytable WITH FULLSCAN, NORECOMPUTE  
```  
  
 <span data-ttu-id="9d2cf-157">Pour mettre à jour les statistiques de toutes les tables mémoire optimisées dans la base de données active, exécutez le script suivant :</span><span class="sxs-lookup"><span data-stu-id="9d2cf-157">To update statistics for all memory-optimized tables in the current database, run the following script:</span></span>  
  
```sql  
DECLARE @sql NVARCHAR(MAX) = N''  
  
SELECT @sql += N'  
   UPDATE STATISTICS ' + quotename(schema_name(schema_id)) + N'.' + quotename(name) + N' WITH FULLSCAN, NORECOMPUTE'  
FROM sys.tables WHERE is_memory_optimized=1  
  
EXEC sp_executesql @sql  
```  
  
 <span data-ttu-id="9d2cf-158">Pour mettre à jour les statistiques de toutes les tables de la base de données, exécutez [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="9d2cf-158">To update statistics for all tables in the database, run [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql).</span></span>  
  
 <span data-ttu-id="9d2cf-159">Les exemples suivants indiquent quand les statistiques sur les tables mémoire optimisées ont été mises à jour pour la dernière fois.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-159">The following sample reports when the statistics on memory-optimized tables were last updated.</span></span> <span data-ttu-id="9d2cf-160">Ces informations peuvent vous aider à décider si vous devez mettre à jour les statistiques.</span><span class="sxs-lookup"><span data-stu-id="9d2cf-160">This information can help you decide if you need to update the statistics.</span></span>  
  
```sql  
select t.object_id, t.name, sp.last_updated as 'stats_last_updated'  
from sys.tables t join sys.stats s on t.object_id=s.object_id cross apply sys.dm_db_stats_properties(t.object_id, s.stats_id) sp  
where t.is_memory_optimized=1  
```  
  
## <a name="see-also"></a><span data-ttu-id="9d2cf-161">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="9d2cf-161">See Also</span></span>  
 [<span data-ttu-id="9d2cf-162">Tables à mémoire optimisée</span><span class="sxs-lookup"><span data-stu-id="9d2cf-162">Memory-Optimized Tables</span></span>](memory-optimized-tables.md)  
  
  
