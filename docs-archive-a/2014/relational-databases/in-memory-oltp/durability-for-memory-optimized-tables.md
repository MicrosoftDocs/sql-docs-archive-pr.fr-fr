---
title: Durabilité pour les tables optimisées en mémoire | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: in-memory-oltp
ms.topic: conceptual
ms.assetid: d304c94d-3ab4-47b0-905d-3c8c2aba9db6
author: CarlRabeler
ms.author: carlrab
ms.openlocfilehash: 1d48d671b23d7b7b17557e7829d6f2522c375acd
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87706512"
---
# <a name="durability-for-memory-optimized-tables"></a><span data-ttu-id="adaaf-102">Durabilité pour les tables optimisées en mémoire</span><span class="sxs-lookup"><span data-stu-id="adaaf-102">Durability for Memory-Optimized Tables</span></span>
  [!INCLUDE[hek_2](../../../includes/hek-2-md.md)] <span data-ttu-id="adaaf-103">fournit la durabilité complète pour les tables optimisées en mémoire.</span><span class="sxs-lookup"><span data-stu-id="adaaf-103">provides full durability for memory-optimized tables.</span></span> <span data-ttu-id="adaaf-104">Lorsqu'une transaction qui a modifié une table optimisée en mémoire est validée, [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] (comme pour les tables sur disque), garantit que les modifications sont permanentes (perdureront au redémarrage d'une base de données), à condition que le stockage sous-jacent soit disponible.</span><span class="sxs-lookup"><span data-stu-id="adaaf-104">When a transaction that changed a memory-optimized table commits, [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] (as it does for disk-based tables), guarantees that the changes are permanent (will survive a database restart), provided the underlying storage is available.</span></span> <span data-ttu-id="adaaf-105">Il existe deux composantes clés de durabilité : l'enregistrement des transactions et la conservation des modifications de données dans un stockage sur disque.</span><span class="sxs-lookup"><span data-stu-id="adaaf-105">There are two key components of durability: transaction logging and persisting data changes to on-disk storage.</span></span>

## <a name="transaction-log"></a><span data-ttu-id="adaaf-106">Journal des transactions</span><span class="sxs-lookup"><span data-stu-id="adaaf-106">Transaction Log</span></span>
 <span data-ttu-id="adaaf-107">Toutes les modifications apportées aux tables sur disque ou aux tables optimisées en mémoire durables sont capturées dans un ou plusieurs enregistrements de journaux des transactions.</span><span class="sxs-lookup"><span data-stu-id="adaaf-107">All changes made to disk-based tables or durable memory-optimized tables are captured in one or more transaction log records.</span></span> <span data-ttu-id="adaaf-108">Lorsqu'une transaction est validée, [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] écrit les enregistrements de journal associés à la transaction sur le disque avant d'indiquer à l'application ou à la session utilisateur que la transaction a été validée.</span><span class="sxs-lookup"><span data-stu-id="adaaf-108">When a transaction commits, [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] writes the log records associated with the transaction to disk before communicating to the application or user session that the transaction has committed.</span></span> <span data-ttu-id="adaaf-109">Cela garantit que les modifications apportées par la transaction sont durables.</span><span class="sxs-lookup"><span data-stu-id="adaaf-109">This guarantees that changes made by the transaction are durable.</span></span> <span data-ttu-id="adaaf-110">Le journal des transactions pour les tables optimisées en mémoire est entièrement intégré au même flux du journal utilisé par les tables sur disque.</span><span class="sxs-lookup"><span data-stu-id="adaaf-110">The transaction log for memory-optimized tables is fully integrated with the same log stream used by disk-based tables.</span></span> <span data-ttu-id="adaaf-111">Cette intégration permet de continuer les opérations de sauvegarde, de récupération et de restauration des journaux des transactions existants sans aucune étape supplémentaire.</span><span class="sxs-lookup"><span data-stu-id="adaaf-111">This integration allows existing transaction log backup, recover, and restore operations to continue to work without requiring any additional steps.</span></span> <span data-ttu-id="adaaf-112">Toutefois, étant donné que [!INCLUDE[hek_2](../../../includes/hek-2-md.md)] augmente le débit des transactions de votre charge de travail de manière significative, vous devez vérifier que le stockage du journal des transactions est correctement configuré pour gérer l'augmentation des E/S requise.</span><span class="sxs-lookup"><span data-stu-id="adaaf-112">However, since [!INCLUDE[hek_2](../../../includes/hek-2-md.md)] can increase transaction throughput of your workload significantly, you need to make sure that transaction log storage is configured appropriately to handle the increased IO requirements.</span></span>

## <a name="data-and-delta-files"></a><span data-ttu-id="adaaf-113">Fichiers de données et fichiers delta</span><span class="sxs-lookup"><span data-stu-id="adaaf-113">Data and Delta Files</span></span>
 <span data-ttu-id="adaaf-114">Les données des tables mémoire optimisées sont stockées en tant que lignes de données de forme libre qui sont liées via un ou plusieurs index en mémoire, en mémoire.</span><span class="sxs-lookup"><span data-stu-id="adaaf-114">The data in memory-optimized tables is stored as free-form data rows that are linked through one or more in-memory indexes, in memory.</span></span> <span data-ttu-id="adaaf-115">Il n'existe aucune structure de page pour les lignes de données, par exemple celles utilisées pour les tables sur disque.</span><span class="sxs-lookup"><span data-stu-id="adaaf-115">There are no page structures for data rows, such as those used for disk-based tables.</span></span> <span data-ttu-id="adaaf-116">Lorsque l'application est prête à valider la transaction, [!INCLUDE[hek_2](../../../includes/hek-2-md.md)] génère les enregistrements de journal pour la transaction.</span><span class="sxs-lookup"><span data-stu-id="adaaf-116">When the application is ready to commit the transaction, the [!INCLUDE[hek_2](../../../includes/hek-2-md.md)] generates the log records for the transaction.</span></span> <span data-ttu-id="adaaf-117">La persistance des tables mémoire optimisées est effectuée avec un jeu de fichiers de données et de fichiers delta à l'aide d'un thread d'arrière-plan.</span><span class="sxs-lookup"><span data-stu-id="adaaf-117">The persistence of memory-optimized tables is done with a set of data and delta files using a background thread.</span></span> <span data-ttu-id="adaaf-118">Les fichiers de données et les fichiers delta se trouvent dans un ou plusieurs conteneurs (utilisant le même mécanisme que celui utilisé pour les données FILESTREAM).</span><span class="sxs-lookup"><span data-stu-id="adaaf-118">The data and delta files are located in one or more containers (using the same mechanism used for FILESTREAM data).</span></span> <span data-ttu-id="adaaf-119">Ces conteneurs sont mappés à un nouveau type de groupe de fichiers, appelé groupe de fichiers mémoire optimisé.</span><span class="sxs-lookup"><span data-stu-id="adaaf-119">These containers are mapped to a new type of filegroup, called a memory-optimized filegroup.</span></span>

 <span data-ttu-id="adaaf-120">Les données sont écrites dans ces fichiers et générées de façon séquentielle stricte, ce qui réduit la latence sur le disque pour les supports rotatifs.</span><span class="sxs-lookup"><span data-stu-id="adaaf-120">Data is written to these files in a strictly sequential fashion, which minimizes disk latency for spinning media.</span></span> <span data-ttu-id="adaaf-121">Utilisez plusieurs conteneurs sur différents disques pour distribuer l'activité d'E/S.</span><span class="sxs-lookup"><span data-stu-id="adaaf-121">You can use multiple containers on different disks to distribute the I/O activity.</span></span> <span data-ttu-id="adaaf-122">L'utilisation de fichiers de données et de fichiers delta dans plusieurs conteneurs sur différents disques améliore les performances de récupération, lorsque les données sont lues en mémoire à partir de ces fichiers.</span><span class="sxs-lookup"><span data-stu-id="adaaf-122">Data and delta files in multiple containers on different disks will increase recovery performance when data is read from the data and delta files on disk, into memory.</span></span>

 <span data-ttu-id="adaaf-123">Une application n'accède pas directement aux fichiers de données et aux fichiers delta.</span><span class="sxs-lookup"><span data-stu-id="adaaf-123">An application does not directly access data and delta files.</span></span> <span data-ttu-id="adaaf-124">Toutes les opérations de lecture et d'écriture de données utilisent des données en mémoire.</span><span class="sxs-lookup"><span data-stu-id="adaaf-124">All data reads and writes use in-memory data.</span></span>

### <a name="the-data-file"></a><span data-ttu-id="adaaf-125">Fichier de données</span><span class="sxs-lookup"><span data-stu-id="adaaf-125">The Data File</span></span>
 <span data-ttu-id="adaaf-126">Un fichier de données contient des lignes provenant d'une ou de plusieurs tables mémoire optimisées qui ont été insérées par plusieurs transactions dans le cadre d'opérations INSERT ou UPDATE.</span><span class="sxs-lookup"><span data-stu-id="adaaf-126">A data file contains rows from one or more memory-optimized tables that were inserted by multiple transactions as part of INSERT or UPDATE operations.</span></span> <span data-ttu-id="adaaf-127">Par exemple, une ligne peut provenir de la table mémoire optimisée t1 et la ligne suivante de la table mémoire optimisée t2.</span><span class="sxs-lookup"><span data-stu-id="adaaf-127">For example, one row can be from memory-optimized table T1 and the next row can be from memory-optimized table T2.</span></span> <span data-ttu-id="adaaf-128">Les lignes sont ajoutées au fichier de données dans l'ordre des transactions du journal des transactions, ce qui permet un accès séquentiel aux données.</span><span class="sxs-lookup"><span data-stu-id="adaaf-128">The rows are appended to the data file in the order of transactions in the transaction log, making data access sequential.</span></span> <span data-ttu-id="adaaf-129">Ceci permet un meilleur ordre de grandeur pour le débit des E/S, par rapport à des E/S aléatoires.</span><span class="sxs-lookup"><span data-stu-id="adaaf-129">This enables an order of magnitude better I/O throughput compared to random I/O.</span></span> <span data-ttu-id="adaaf-130">Chaque fichier de données a une taille d'environ 128 Mo pour les ordinateurs avec une capacité de mémoire supérieure à 16 Go, et à 16 Mo pour les ordinateurs avec une capacité de mémoire inférieure ou égale à 16 Go.</span><span class="sxs-lookup"><span data-stu-id="adaaf-130">Each data file is sized approximately to 128MB for computers with memory greater than 16GB, and 16MB for computers with less than or equal to 16GB.</span></span> <span data-ttu-id="adaaf-131">Une fois que le fichier de données est plein, les lignes insérées par les nouvelles transactions sont stockées dans un autre fichier de données.</span><span class="sxs-lookup"><span data-stu-id="adaaf-131">Once the data file is full, the rows inserted by new transactions are stored in another data file.</span></span> <span data-ttu-id="adaaf-132">Au fil du temps, les lignes provenant de tables mémoire optimisées durables sont stockées dans un ou plusieurs fichiers de données et chaque fichier de données contient des lignes provenant d'une plage disjointe mais contigüe de transactions.</span><span class="sxs-lookup"><span data-stu-id="adaaf-132">Over time, the rows from durable memory-optimized tables are stored in one of more data files and each data file containing rows from a disjoint but contiguous range of transactions.</span></span> <span data-ttu-id="adaaf-133">Par exemple, un fichier de données dont l'horodateur de validation de transaction est dans une plage de (100, 200) contient toutes les lignes insérées par les transactions dont l'horodateur de validation est supérieur à 100 et inférieur ou égal à 200.</span><span class="sxs-lookup"><span data-stu-id="adaaf-133">For example a data file with transaction commit timestamp in the range of (100, 200) has all the rows inserted by transactions that have commit timestamp greater than 100 and less than or equal to 200.</span></span> <span data-ttu-id="adaaf-134">L'horodateur de validation est un nombre à croissance monotone attribué à une transaction lorsqu'elle est prête pour la validation.</span><span class="sxs-lookup"><span data-stu-id="adaaf-134">The commit timestamp is a monotonically increasing number assigned to a transaction when it is ready to commit.</span></span> <span data-ttu-id="adaaf-135">Chaque transaction a un horodateur de validation unique.</span><span class="sxs-lookup"><span data-stu-id="adaaf-135">Each transaction has a unique commit timestamp.</span></span>

 <span data-ttu-id="adaaf-136">Lorsqu'une ligne est supprimée ou mise à jour, elle n'est pas supprimée ou modifiée sur place dans le fichier de données, mais les lignes supprimées sont suivies dans un autre type de fichier : le fichier delta.</span><span class="sxs-lookup"><span data-stu-id="adaaf-136">When a row is deleted or updated, the row is not removed or changed in-place in the data file but the deleted rows are tracked in another type of file: the delta file.</span></span> <span data-ttu-id="adaaf-137">Les opérations de mise à jour sont traitées comme un tuple d'opérations de suppression et d'insertion pour chaque ligne.</span><span class="sxs-lookup"><span data-stu-id="adaaf-137">Update operations are processed as a tuple of delete and insert operations for each row.</span></span> <span data-ttu-id="adaaf-138">Cela supprime les E/S aléatoires dans le fichier de données.</span><span class="sxs-lookup"><span data-stu-id="adaaf-138">This eliminates random IO on the data file.</span></span>

### <a name="the-delta-file"></a><span data-ttu-id="adaaf-139">Fichier delta</span><span class="sxs-lookup"><span data-stu-id="adaaf-139">The Delta File</span></span>
 <span data-ttu-id="adaaf-140">Chaque fichier de données est couplé à un fichier delta ayant la même plage de transactions et effectue le suivi des lignes supprimées insérées par les transactions dans cette plage.</span><span class="sxs-lookup"><span data-stu-id="adaaf-140">Each data file is paired with a delta file that has the same transaction range and tracks the deleted rows inserted by transactions in the transaction range.</span></span> <span data-ttu-id="adaaf-141">Ces données et ce fichier delta sont appelés « paire de fichiers de point de contrôle » (CFP, Checkpoint File Pair). Il s'agit de l'unité d'allocation et de désallocation, ainsi que de l'unité pour les opérations de fusion.</span><span class="sxs-lookup"><span data-stu-id="adaaf-141">This data and delta file is referred to as a Checkpoint File Pair (CFP) and it is the unit of allocation and deallocation as well as the unit for Merge operations.</span></span> <span data-ttu-id="adaaf-142">Par exemple, un fichier delta correspondant à la plage de transaction (100, 200) enregistre les lignes supprimées qui avaient été insérées par les transactions de la plage (100, 200).</span><span class="sxs-lookup"><span data-stu-id="adaaf-142">For example, a delta file corresponding to transaction range (100, 200) will store deleted rows that were inserted by transactions in the range (100, 200).</span></span> <span data-ttu-id="adaaf-143">Comme pour les fichiers de données, le fichier delta est accessible de manière séquentielle.</span><span class="sxs-lookup"><span data-stu-id="adaaf-143">Like data files, the delta file is accessed sequentially.</span></span>

 <span data-ttu-id="adaaf-144">Lorsqu'une ligne est supprimée, elle n'est pas supprimée du fichier de données mais une référence à la ligne est ajoutée au fichier delta associé à la plage de transaction où la ligne de données a été insérée.</span><span class="sxs-lookup"><span data-stu-id="adaaf-144">When a row is deleted, the row is not removed from the data file but a reference to the row is appended to the delta file associated with the transaction range where this data row was inserted.</span></span> <span data-ttu-id="adaaf-145">Étant donné que la ligne à supprimer existe déjà dans le fichier de données, le fichier delta stocke uniquement les informations de référence sur `{inserting_tx_id, row_id, deleting_tx_id }` et suit l'ordre des opérations de suppression ou de mise à jour d'origine du journal des transactions.</span><span class="sxs-lookup"><span data-stu-id="adaaf-145">Since the row to be deleted already exists in the data file, the delta file only stores the reference information `{inserting_tx_id, row_id, deleting_tx_id }` and it follows the transactional log order of the originating delete or update operations.</span></span>

## <a name="populating-data-and-delta-files"></a><span data-ttu-id="adaaf-146">Remplissage des fichiers de données et des fichiers delta</span><span class="sxs-lookup"><span data-stu-id="adaaf-146">Populating Data and Delta Files</span></span>
 <span data-ttu-id="adaaf-147">Les fichiers de données et delta sont remplis par un thread d'arrière-plan appelé point de contrôle hors connexion.</span><span class="sxs-lookup"><span data-stu-id="adaaf-147">Data and delta file are populated by a background thread called offline checkpoint.</span></span> <span data-ttu-id="adaaf-148">Ce thread lit les enregistrements du journal des transactions générés par les transactions validées sur les tables mémoire optimisées et ajoute des informations concernant les lignes insérées et supprimées dans les fichiers de données et delta appropriés.</span><span class="sxs-lookup"><span data-stu-id="adaaf-148">This thread reads the transaction log records generated by committed transactions on memory-optimized tables and appends information about the inserted and deleted rows into appropriate data and delta files.</span></span> <span data-ttu-id="adaaf-149">Contrairement aux tables sur disque où les pages de données/index sont vidées avec des E/S aléatoires lorsque le point de contrôle est effectué, la persistance de la table optimisée en mémoire est une opération en arrière-plan continue.</span><span class="sxs-lookup"><span data-stu-id="adaaf-149">Unlike disk-based tables where data/index pages are flushed with random I/O when checkpoint is done, the persistence of memory-optimized table is continuous background operation.</span></span> <span data-ttu-id="adaaf-150">Plusieurs fichiers delta sont accédés car une transaction peut supprimer ou mettre à jour toute ligne ayant été insérée par une transaction précédente.</span><span class="sxs-lookup"><span data-stu-id="adaaf-150">Multiple delta files are accessed because a transaction can delete or update any row that was inserted by any previous transaction.</span></span> <span data-ttu-id="adaaf-151">Les informations de suppression sont toujours ajoutées à la fin du fichier delta.</span><span class="sxs-lookup"><span data-stu-id="adaaf-151">Deletion information is always appended at the end of the delta file.</span></span> <span data-ttu-id="adaaf-152">Par exemple, une transaction avec un horodateur de validation de 600 insère une nouvelle ligne et supprime les lignes insérées par les transactions ayant un horodateur de validation de 150, 250 et 450, comme le montre l'illustration ci-après.</span><span class="sxs-lookup"><span data-stu-id="adaaf-152">For example, a transaction with a commit timestamp of 600 inserts one new row and deletes rows inserted by transactions with a commit timestamp of 150, 250 and 450 as shown in the picture below.</span></span> <span data-ttu-id="adaaf-153">Les quatre opérations d'E/S de fichier (trois pour les lignes supprimées et une pour les nouvelles lignes insérées) sont des opérations Append-Only sur les fichiers de données et delta correspondants.</span><span class="sxs-lookup"><span data-stu-id="adaaf-153">All 4 file I/O operations (three for deleted rows and 1 for the newly inserted rows), are append-only operations to the corresponding delta and data files.</span></span>

 <span data-ttu-id="adaaf-154">![Lecture des enregistrements de journal pour les tables à mémoire optimisée.](../../database-engine/media/read-logs-hekaton.gif "Lecture des enregistrements de journal pour les tables à mémoire optimisée.")</span><span class="sxs-lookup"><span data-stu-id="adaaf-154">![Read log records for memory-optimized tables.](../../database-engine/media/read-logs-hekaton.gif "Read log records for memory-optimized tables.")</span></span>

## <a name="accessing-data-and-delta-files"></a><span data-ttu-id="adaaf-155">Accès aux fichiers de données et aux fichiers delta</span><span class="sxs-lookup"><span data-stu-id="adaaf-155">Accessing Data and Delta Files</span></span>
 <span data-ttu-id="adaaf-156">Les paires de fichiers de données et delta sont accessibles dans les cas suivants.</span><span class="sxs-lookup"><span data-stu-id="adaaf-156">Data and delta file pairs are accessed when the following occurs.</span></span>

 <span data-ttu-id="adaaf-157">Thread de point de contrôle hors connexion ce thread ajoute les insertions et les suppressions aux lignes de données à mémoire optimisée, aux paires de fichiers de données et Delta correspondantes.</span><span class="sxs-lookup"><span data-stu-id="adaaf-157">Offline checkpoint thread This thread appends inserts and deletes to memory-optimized data rows, to the corresponding data and delta file pairs.</span></span>

 <span data-ttu-id="adaaf-158">Opération MERGE l’opération fusionne une ou plusieurs paires de fichiers de données et Delta et crée une paire de fichiers de données et Delta.</span><span class="sxs-lookup"><span data-stu-id="adaaf-158">Merge operation The operation merges one or more data and delta file pairs and creates a new data and delta file pair.</span></span>

 <span data-ttu-id="adaaf-159">Pendant la récupération après incident [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] , lorsque est redémarré ou que la base de données est remise en ligne, les données optimisées en mémoire sont alimentées à l’aide des paires de fichiers de données et Delta.</span><span class="sxs-lookup"><span data-stu-id="adaaf-159">During crash recovery When [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] is restarted or the database is brought back online, the memory-optimized data is populated using the data and delta file pairs.</span></span> <span data-ttu-id="adaaf-160">Le fichier delta filtre les lignes supprimées lors de la lecture des lignes à partir du fichier de données correspondant.</span><span class="sxs-lookup"><span data-stu-id="adaaf-160">The delta file acts as a filter for the deleted rows when reading the rows from the corresponding data file.</span></span> <span data-ttu-id="adaaf-161">Dans la mesure où chaque paire de fichier de données et de fichier delta est indépendante, ces fichiers sont chargés en parallèle pour réduire le temps de chargement en mémoire des données.</span><span class="sxs-lookup"><span data-stu-id="adaaf-161">Because each data and delta file pair is independent, these files are loaded in parallel to reduce the time taken to populate data into memory.</span></span> <span data-ttu-id="adaaf-162">Une fois que les données ont été chargées en mémoire, le moteur OLTP en mémoire applique les enregistrements du journal des transactions non encore couverts par les fichiers de point de contrôle afin que les données optimisées en mémoire soient complètes.</span><span class="sxs-lookup"><span data-stu-id="adaaf-162">Once the data has been loaded into memory, the In-Memory OLTP engine applies the active transaction log records not yet covered by the checkpoint files so that the memory-optimized data is complete.</span></span>

 <span data-ttu-id="adaaf-163">Pendant l’opération de restauration, les fichiers de point de contrôle de l’OLTP en mémoire sont créés à partir de la sauvegarde de la base de données, puis une ou plusieurs sauvegardes du journal des transactions sont appliquées.</span><span class="sxs-lookup"><span data-stu-id="adaaf-163">During restore operation The In-Memory OLTP checkpoint files are created from the database backup, and then one or more transaction log backups are applied.</span></span> <span data-ttu-id="adaaf-164">Comme pour la récupération sur incident, le moteur OLTP en mémoire charge les données en mémoire en parallèle pour minimiser l'impact sur le temps de récupération.</span><span class="sxs-lookup"><span data-stu-id="adaaf-164">As with crash recovery, the In-Memory OLTP engine loads data into memory in parallel, to minimize the impact on recovery time.</span></span>

## <a name="merging-data-and-delta-files"></a><span data-ttu-id="adaaf-165">Fusion de fichiers de données et de fichiers delta</span><span class="sxs-lookup"><span data-stu-id="adaaf-165">Merging Data and Delta Files</span></span>
 <span data-ttu-id="adaaf-166">Les données des tables mémoire optimisées sont stockées dans une ou plusieurs paires de fichiers de données et delta (également appelées une paire de fichiers de point de contrôle, ou CFP).</span><span class="sxs-lookup"><span data-stu-id="adaaf-166">The data for memory optimized tables is stored in one or more data and delta file pairs (also called a checkpoint file pair, or CFP).</span></span> <span data-ttu-id="adaaf-167">Les fichiers de données stockent les lignes insérées et les fichiers delta référencent les lignes supprimées.</span><span class="sxs-lookup"><span data-stu-id="adaaf-167">Data files store inserted rows and delta files reference deleted rows.</span></span> <span data-ttu-id="adaaf-168">Pendant l'exécution d'une charge de travail OLTP, lorsque les opérations DML mettent à jour, insèrent et suppriment des lignes, de nouvelles paires de fichiers de point de contrôle sont créées pour rendre les nouvelles lignes persistantes, et la référence aux lignes supprimées est ajoutée aux fichiers delta.</span><span class="sxs-lookup"><span data-stu-id="adaaf-168">During the execution of an OLTP workload, as the DML operations update, insert, and delete rows, new CFPs are created to persist the new rows, and the reference to the deleted rows is appended to delta files.</span></span>

 <span data-ttu-id="adaaf-169">Les métadonnées de toutes les paires de fichiers de point de contrôle précédemment fermées et actuellement actives sont enregistrées dans une structure de tableau interne appelée tableau de stockage.</span><span class="sxs-lookup"><span data-stu-id="adaaf-169">The metadata of all previously-closed and currently active CFPs is stored in an internal array structure referred to as the storage array.</span></span> <span data-ttu-id="adaaf-170">Il s'agit d'un tableau de taille définie (8 192 entrées) de paires de fichiers de point de contrôle.</span><span class="sxs-lookup"><span data-stu-id="adaaf-170">It is a finitely sized (8,192 entries) array of CFPs.</span></span> <span data-ttu-id="adaaf-171">Les entrées du tableau de stockage sont triées par la plage de transaction.</span><span class="sxs-lookup"><span data-stu-id="adaaf-171">The entries in the storage array are ordered by transaction range.</span></span> <span data-ttu-id="adaaf-172">Les paires de fichiers de point de contrôle dans le tableau de stockage (et la fin du journal) représentent la totalité de l'état sur disque requis pour extraire une base de données avec des tables mémoire optimisées.</span><span class="sxs-lookup"><span data-stu-id="adaaf-172">The CFPs in the storage array (along with the tail of the log) represent all the on-disk state required to recover a database with memory-optimized tables.</span></span>

 <span data-ttu-id="adaaf-173">Au fil du temps, avec les opérations DML, le nombre de paires de fichiers de point de contrôle augmente et le tableau de stockage atteint sa capacité, ce qui introduit les problèmes suivants :</span><span class="sxs-lookup"><span data-stu-id="adaaf-173">Over time, with DML operations, the number of CFPs grow causing the storage array to reach capacity, which introduces the following challenges:</span></span>

-   <span data-ttu-id="adaaf-174">Lignes supprimées.</span><span class="sxs-lookup"><span data-stu-id="adaaf-174">Deleted rows.</span></span>  <span data-ttu-id="adaaf-175">Les lignes supprimées restent dans le fichier de données mais sont marquées comme supprimées dans le fichier delta correspondant.</span><span class="sxs-lookup"><span data-stu-id="adaaf-175">Deleted rows remain in the data file but are marked as deleted in the corresponding delta file.</span></span> <span data-ttu-id="adaaf-176">Ces lignes ne sont plus nécessaires et seront supprimées du stockage.</span><span class="sxs-lookup"><span data-stu-id="adaaf-176">These rows are no longer needed and will be removed from the storage.</span></span> <span data-ttu-id="adaaf-177">Si les lignes supprimées n'étaient pas supprimées des CFPs, elles utiliseraient inutilement de l'espace et ralentiraient le temps de récupération.</span><span class="sxs-lookup"><span data-stu-id="adaaf-177">If deleted rows were not removed from CFPs, they would use space unnecessarily and make recovery time slower.</span></span>

-   <span data-ttu-id="adaaf-178">Tableau de stockage complet.</span><span class="sxs-lookup"><span data-stu-id="adaaf-178">Storage array full.</span></span> <span data-ttu-id="adaaf-179">Lorsque 8 000 entrées dans le tableau de stockage sont allouées (192 entrées du tableau sont réservées pour la concurrence des fusions existantes ou pour vous permettre d'effectuer des fusions manuelles), aucune nouvelle transaction DML ne peut être exécutée sur les tables mémoire optimisées durables.</span><span class="sxs-lookup"><span data-stu-id="adaaf-179">When there 8,000 entries in the storage array are allocated (192 entries in the array are reserved for existing merges to compete or to allow you to do manual merges), no new DML transactions can be executed on durable memory-optimized tables.</span></span> <span data-ttu-id="adaaf-180">Seules les opérations de point de contrôle et de fusion peuvent consommer les entrées restantes.</span><span class="sxs-lookup"><span data-stu-id="adaaf-180">Only checkpoint and merge operations are allowed to consume the remaining entries.</span></span> <span data-ttu-id="adaaf-181">Cela garantit que les transactions DML ne remplissent pas le tableau et que certaines entrées du tableau sont réservées pour fusionner les fichiers existants et libérer l'espace du tableau.</span><span class="sxs-lookup"><span data-stu-id="adaaf-181">This ensures that DML transactions do not fill the array and that some entries in the array are reserved to merge existing files and to reclaim space in the array.</span></span>

-   <span data-ttu-id="adaaf-182">Traitement de manipulation du tableau de stockage.</span><span class="sxs-lookup"><span data-stu-id="adaaf-182">Storage array manipulation overhead.</span></span> <span data-ttu-id="adaaf-183">Les processus internes recherchent le tableau de stockage pour les opérations telles que la recherche de fichier delta pour ajouter des informations sur une ligne supprimée.</span><span class="sxs-lookup"><span data-stu-id="adaaf-183">Internal processes search the storage array for operations such as finding the delta file to append information about a deleted row.</span></span> <span data-ttu-id="adaaf-184">Le coût de ces opérations augmente avec le nombre d'entrées.</span><span class="sxs-lookup"><span data-stu-id="adaaf-184">The cost of these operations increases with the number of entries.</span></span>

 <span data-ttu-id="adaaf-185">Pour éviter ces inefficacités, les paires de fichiers de point de contrôle fermées plus anciennes sont fusionnées, en fonction d'une stratégie de fusion décrite ci-dessous, de sorte que le tableau de stockage est condensé pour représenter le même jeu de données, avec un nombre réduit d'appels aux paires de fichiers de point de contrôle.</span><span class="sxs-lookup"><span data-stu-id="adaaf-185">To help prevent these inefficiencies, the older closed CFPs are merged, based on a merge policy described below, so the storage array is compacted to represent the same set of data, with a reduced number of CFPs.</span></span>

 <span data-ttu-id="adaaf-186">La taille totale en mémoire des tables durables dans une base de données ne doit pas dépasser 250 Go.</span><span class="sxs-lookup"><span data-stu-id="adaaf-186">The total in-memory size of all durable tables in a database should not exceed 250 GB.</span></span> <span data-ttu-id="adaaf-187">Les tables durables qui utilisent jusqu'à 250 Go de mémoire (en supposant des opérations d'insertion, de suppression et de mise à jour) auront besoin d'un espace de stockage moyen de 500 Go.</span><span class="sxs-lookup"><span data-stu-id="adaaf-187">Durable tables that use up to 250 GB of memory will, assuming insert, delete, and update operations, require on average 500 GB of storage space.</span></span> <span data-ttu-id="adaaf-188">4 000 paires de fichiers de données et de fichiers delta dans le groupe de fichiers mémoire optimisé sont nécessaires pour prendre en charge les 500 Go d'espace de stockage.</span><span class="sxs-lookup"><span data-stu-id="adaaf-188">4,000 data and delta file pairs in the memory-optimized file group are required to support the 500 GB of storage space.</span></span>

 <span data-ttu-id="adaaf-189">Les pics à court terme d'activité dans la base de données peuvent entraîner un décalage des opérations de point de contrôle et de fusion, qui augmentera le nombre de paires de fichiers de données et delta nécessaires.</span><span class="sxs-lookup"><span data-stu-id="adaaf-189">Short-term surges in database activity may cause checkpoint and merge operations lag, which will increase the number of required data and delta file pairs.</span></span> <span data-ttu-id="adaaf-190">Pour gérer les pics à court terme d'activité dans la base de données, le système de stockage peut allouer jusqu'à 8 000 paires de fichiers de données et delta pour au plus un total de 1 To de stockage.</span><span class="sxs-lookup"><span data-stu-id="adaaf-190">To accommodate short-term surges spikes in database activity, the storage system can allocate up to 8,000 data and delta file pairs up to a total of 1TB of storage.</span></span> <span data-ttu-id="adaaf-191">Lorsque cette limite est atteinte, aucune nouvelle transaction n'est autorisée sur la base de données tant que les opérations de point de contrôle n'ont pas rattrapé leur retard.</span><span class="sxs-lookup"><span data-stu-id="adaaf-191">When that limit is reached, there will be no new transactions allowed on the database until checkpoint operations catch up.</span></span> <span data-ttu-id="adaaf-192">Si la taille des tables durables en mémoire dépasse 250 Go pendant de longues périodes, il est possible d'atteindre la limite de 8 000 paires de fichiers.</span><span class="sxs-lookup"><span data-stu-id="adaaf-192">If the size of durable tables in memory exceeds 250GB for long periods of time, there is a chance of reaching the 8,000 file pair limit.</span></span>

 <span data-ttu-id="adaaf-193">L'opération de fusion prend comme entrée une ou plusieurs paires de fichiers de point de contrôle fermées adjacentes (appelées source de fusion) à partir d'une stratégie de fusion définie en interne, et produit une paire de fichiers de point de contrôle résultante, appelée la cible de fusion.</span><span class="sxs-lookup"><span data-stu-id="adaaf-193">The merge operation takes as input one or more adjacent closed CFPs (called merge source) based on an internally defined merge policy, and produces one resultant CFP, called the merge target.</span></span> <span data-ttu-id="adaaf-194">Les entrées dans chaque fichier delta des paires de fichiers de point de contrôle sources sont utilisées pour filtrer les lignes à partir du fichier de données correspondant pour supprimer des lignes de données qui ne sont pas nécessaires.</span><span class="sxs-lookup"><span data-stu-id="adaaf-194">The entries in each delta file of the source CFPs are used to filter rows from the corresponding data file to remove the data rows that are not needed.</span></span> <span data-ttu-id="adaaf-195">Les lignes restantes dans les paires de fichiers de point de contrôle sources sont consolidées dans une paire de fichiers de point de contrôle cible.</span><span class="sxs-lookup"><span data-stu-id="adaaf-195">The remaining rows in the source CFPs are consolidated into one target CFP.</span></span> <span data-ttu-id="adaaf-196">Après la fusion, la paire de fichiers de point de contrôle résultante (cible de fusion) remplace les paires de fichiers de point de contrôle sources (sources de fusion).</span><span class="sxs-lookup"><span data-stu-id="adaaf-196">After the merge is complete, the resultant merge-target CFP replaces the source CFPs (merge sources).</span></span> <span data-ttu-id="adaaf-197">Les paires de fichiers de point de contrôle sources de fusion passent par une phase de transition avant d'être supprimées du stockage.</span><span class="sxs-lookup"><span data-stu-id="adaaf-197">The merge-source CFPs go through a transition phase before they are removed from storage.</span></span>

 <span data-ttu-id="adaaf-198">Dans l'exemple ci-dessous, le groupe de fichiers de la table mémoire optimisée contient quatre paires de fichiers de données et delta ayant l'horodateur 500 et contenant des données issues de transactions précédentes.</span><span class="sxs-lookup"><span data-stu-id="adaaf-198">In the example below, the memory-optimized table file group has four data and delta file pairs at timestamp 500 containing data from previous transactions.</span></span> <span data-ttu-id="adaaf-199">Par exemple, les lignes du premier fichier de données correspondent aux transactions avec un horodateur supérieur à 100 et inférieur ou égal à 200 ; alternativement représenté comme (100, 200].</span><span class="sxs-lookup"><span data-stu-id="adaaf-199">For example, the rows in the first data file correspond to transactions with timestamp greater than 100 and less than or equal to 200; alternatively represented as (100, 200].</span></span> <span data-ttu-id="adaaf-200">Le deuxième et le troisième fichiers de données affichent un taux de remplissage inférieur à 50 % après prise en compte des lignes marquées comme supprimées.</span><span class="sxs-lookup"><span data-stu-id="adaaf-200">The second and third data files are shown to be less than 50 percent full after accounting for the rows marked as deleted.</span></span> <span data-ttu-id="adaaf-201">L'opération de fusion associe ces deux paires de fichiers de point de contrôle et crée une paire de fichiers de point de contrôle contenant des transactions avec un horodateur supérieur à 200 et inférieur ou égal à 400, qui est la plage combinée de ces deux paires de fichiers de point de contrôle.</span><span class="sxs-lookup"><span data-stu-id="adaaf-201">The merge operation combines these two CFPs and creates a new CFP containing transactions with timestamp greater than 200 and less than or equal to 400, which is the combined range of these two CFPs.</span></span> <span data-ttu-id="adaaf-202">Vous voyez une autre paire de fichiers de point de contrôle avec une plage (500, 600] et un fichier delta non vide pour la plage de transactions (200, 400] indique que l'opération de fusion peut être effectuée en même temps que l'activité transactionnelle comprenant la suppression de plus de lignes des paires de fichiers de point de contrôle source.</span><span class="sxs-lookup"><span data-stu-id="adaaf-202">You see another CFP with range (500, 600] and non-empty delta file for transaction range (200, 400] shows that merge operation can be done concurrently with transactional activity including deleting more rows from the source CFPs.</span></span>

 <span data-ttu-id="adaaf-203">![Le diagramme présente le groupe de fichiers de table à mémoire optimisée](../../database-engine/media/storagediagram-hekaton.png "Le diagramme présente le groupe de fichiers de table à mémoire optimisée")</span><span class="sxs-lookup"><span data-stu-id="adaaf-203">![Diagram shows memory optimized table file group](../../database-engine/media/storagediagram-hekaton.png "Diagram shows memory optimized table file group")</span></span>

 <span data-ttu-id="adaaf-204">Un thread d'arrière-plan évalue toutes les paires de fichiers de point de contrôle fermées à l'aide d'une stratégie de fusion, puis initie une ou plusieurs demandes de fusion pour les paires de fichiers de point de contrôle qualifiées.</span><span class="sxs-lookup"><span data-stu-id="adaaf-204">A background thread evaluates all closed CFPs using a merge policy and then initiates one or more merge requests for the qualifying CFPs.</span></span> <span data-ttu-id="adaaf-205">Ces demandes de fusion sont traitées par le thread de point de contrôle hors connexion.</span><span class="sxs-lookup"><span data-stu-id="adaaf-205">These merge requests are processed by the offline checkpoint thread.</span></span> <span data-ttu-id="adaaf-206">L'évaluation de la stratégie de fusion est effectuée périodiquement et lorsqu'un point de contrôle est fermé.</span><span class="sxs-lookup"><span data-stu-id="adaaf-206">The evaluation of merge policy is done periodically and also when a checkpoint is closed.</span></span>

### <a name="sssql14-merge-policy"></a>[!INCLUDE[ssSQL14](../../../includes/sssql14-md.md)] <span data-ttu-id="adaaf-207">Stratégie de fusion</span><span class="sxs-lookup"><span data-stu-id="adaaf-207">Merge Policy</span></span>
 [!INCLUDE[ssSQL14](../../../includes/sssql14-md.md)] <span data-ttu-id="adaaf-208">implémente la stratégie de fusion suivante :</span><span class="sxs-lookup"><span data-stu-id="adaaf-208">implements the following merge policy:</span></span>

-   <span data-ttu-id="adaaf-209">Une fusion est planifiée si 2 ou plus paires de fichiers de point de contrôle peuvent être consolidées, après avoir tenu compte des lignes supprimées, de sorte que les lignes résultantes puissent tenir dans une paire de fichiers de point de contrôle de taille idéale.</span><span class="sxs-lookup"><span data-stu-id="adaaf-209">A merge is scheduled if 2 or more consecutive CFPs can be consolidated, after accounting for deleted rows, such that the resultant rows can fit into 1 CFP of ideal size.</span></span> <span data-ttu-id="adaaf-210">La taille idéale d'une paire de fichiers de point de contrôle est déterminée comme suit :</span><span class="sxs-lookup"><span data-stu-id="adaaf-210">The ideal size of CFP is determined as follows:</span></span>

    -   <span data-ttu-id="adaaf-211">Si un ordinateur a 16 Go de mémoire ou moins, le fichier de données a une taille de 16 Mo et le fichier delta a une taille de 1 Mo.</span><span class="sxs-lookup"><span data-stu-id="adaaf-211">If a computer has less than or equal to 16GB of memory, the data file is 16MB and delta file is 1MB.</span></span>

    -   <span data-ttu-id="adaaf-212">Si un ordinateur a plus de 16 Go de mémoire, le fichier de données a une taille de 128 Mo et le fichier delta a une taille de 16 Mo.</span><span class="sxs-lookup"><span data-stu-id="adaaf-212">If a computer has greater than 16GB of memory, the data file is 128MB and delta file is 16MB.</span></span>

-   <span data-ttu-id="adaaf-213">Une seule paire de fichiers de point de contrôle peut être fusionnée automatiquement si le fichier de données dépasse 256 Mo et plus de la moitié des lignes sont supprimées.</span><span class="sxs-lookup"><span data-stu-id="adaaf-213">A single CFP can be self-merged if the data file exceeds 256 MB and more than half of the rows are deleted.</span></span> <span data-ttu-id="adaaf-214">Un fichier de données peut atteindre une taille de 128 Mo si, par exemple, une seule transaction ou plusieurs transactions simultanées insèrent ou mettent à jour un grand nombre de données, forçant le fichier de données à dépasser sa taille idéale car une transaction ne peut pas couvrir plusieurs paires de fichiers de point de contrôle.</span><span class="sxs-lookup"><span data-stu-id="adaaf-214">A data file can grow larger than 128MB if, for example, a single transaction or multiple concurrent transactions inserts or updates large amount of data, forcing the data file to grow beyond its ideal size because a transaction cannot span multiple CFPs.</span></span>

 <span data-ttu-id="adaaf-215">Voici des exemples qui montrent les paires de fichiers de point de contrôle qui seront fusionnées dans le cadre de la stratégie de fusion :</span><span class="sxs-lookup"><span data-stu-id="adaaf-215">Here are some examples that show the CFPs that will be merged under the merge policy:</span></span>

|<span data-ttu-id="adaaf-216">Paires de fichiers sources de point de contrôle adjacentes (% de remplissage)</span><span class="sxs-lookup"><span data-stu-id="adaaf-216">Adjacent CFPs Source Files (% full)</span></span>|<span data-ttu-id="adaaf-217">Sélection pour la fusion</span><span class="sxs-lookup"><span data-stu-id="adaaf-217">Merge Selection</span></span>|
|-------------------------------------------|---------------------|
|<span data-ttu-id="adaaf-218">CFP0 (30%), CFP1 (50%), CFP2 (50%), CFP3 (90%)</span><span class="sxs-lookup"><span data-stu-id="adaaf-218">CFP0 (30%), CFP1 (50%), CFP2 (50%), CFP3 (90%)</span></span>|<span data-ttu-id="adaaf-219">(CFP0, CFP1)</span><span class="sxs-lookup"><span data-stu-id="adaaf-219">(CFP0, CFP1)</span></span><br /><br /> <span data-ttu-id="adaaf-220">CFP2 n'est pas choisi car le fichier de données résultant sera supérieur à 100 % de la taille idéale.</span><span class="sxs-lookup"><span data-stu-id="adaaf-220">CFP2 is not chosen as it will make resultant data file greater than 100% of the ideal size.</span></span>|
|<span data-ttu-id="adaaf-221">CFP0 (30%), CFP1 (20%), CFP2 (50%), CFP3 (10%)</span><span class="sxs-lookup"><span data-stu-id="adaaf-221">CFP0 (30%), CFP1 (20%), CFP2 (50%), CFP3 (10%)</span></span>|<span data-ttu-id="adaaf-222">(CFP0, CFP1, CFP2).</span><span class="sxs-lookup"><span data-stu-id="adaaf-222">(CFP0, CFP1, CFP2).</span></span> <span data-ttu-id="adaaf-223">Les fichiers sont sélectionnés à partir de la gauche.</span><span class="sxs-lookup"><span data-stu-id="adaaf-223">Files are chosen starting from left.</span></span><br /><br /> <span data-ttu-id="adaaf-224">CTP3 n'est pas choisi car le fichier de données résultant sera supérieur à 100 % de la taille idéale.</span><span class="sxs-lookup"><span data-stu-id="adaaf-224">CTP3 is not chosen as it will make resultant data file greater than 100% of the ideal size.</span></span>|
|<span data-ttu-id="adaaf-225">CFP0 (80%), CFP1 (30%), CFP2 (10%), CFP3 (40%)</span><span class="sxs-lookup"><span data-stu-id="adaaf-225">CFP0 (80%), CFP1 (30%), CFP2 (10%), CFP3 (40%)</span></span>|<span data-ttu-id="adaaf-226">(CFP1, CFP2, CFP3).</span><span class="sxs-lookup"><span data-stu-id="adaaf-226">(CFP1, CFP2, CFP3).</span></span> <span data-ttu-id="adaaf-227">Les fichiers sont sélectionnés à partir de la gauche.</span><span class="sxs-lookup"><span data-stu-id="adaaf-227">Files are chosen starting from left.</span></span><br /><br /> <span data-ttu-id="adaaf-228">CFP0 est ignoré car si associé à CFP1, le fichier de données résultant sera supérieur à 100 % de la taille idéale.</span><span class="sxs-lookup"><span data-stu-id="adaaf-228">CFP0 is skipped because if combined with CFP1, the resultant data file will be greater than 100% of the ideal size.</span></span>|

 <span data-ttu-id="adaaf-229">Toutes les paires de fichiers de point de contrôle avec de l'espace disponible ne sont pas qualifiées pour la fusion.</span><span class="sxs-lookup"><span data-stu-id="adaaf-229">Not all CFPs with available space qualify for merge.</span></span> <span data-ttu-id="adaaf-230">Par exemple, si deux paires de fichiers de point de contrôle adjacentes sont complètes à 60 %, elles ne seront pas qualifiées pour la fusion et chacune des paires aura 40 % de stockage inutilisé.</span><span class="sxs-lookup"><span data-stu-id="adaaf-230">For example, if two adjacent CFPs are 60% full, they will not qualify for merge and each of these CFPs will have 40% storage unused.</span></span> <span data-ttu-id="adaaf-231">Dans le pire des cas, toutes les paires de fichiers de point de contrôle seront complètes à 50%, soit une utilisation du stockage de seulement 50 %.</span><span class="sxs-lookup"><span data-stu-id="adaaf-231">In the worst case, all CFPs will be 50% full, a storage utilization of only 50%.</span></span> <span data-ttu-id="adaaf-232">Alors que les lignes supprimées peuvent exister dans le stockage car les paires de fichiers de contrôle ne sont pas qualifiées pour la fusion, les lignes supprimées peuvent déjà avoir été supprimées de la mémoire par le garbage collection en mémoire.</span><span class="sxs-lookup"><span data-stu-id="adaaf-232">While the deleted rows may exist in storage because the CFPs don't qualify for merge, the deleted rows may have already been removed from memory by in-memory garbage collection.</span></span> <span data-ttu-id="adaaf-233">La gestion du stockage et de la mémoire est indépendante du garbage collection.</span><span class="sxs-lookup"><span data-stu-id="adaaf-233">The management of storage and the memory is independent from garbage collection.</span></span> <span data-ttu-id="adaaf-234">Le stockage pris par des paires de fichiers de point de contrôle actives (certaines paires de fichiers de point de contrôle n'ont pas été mises à jour) peut être jusqu'à 2 fois supérieur à la taille des tables durables en mémoire.</span><span class="sxs-lookup"><span data-stu-id="adaaf-234">Storage taken by active CFPs (not all CFPs are being updated) can be up to 2 times larger than the size of durable tables in memory.</span></span>

 <span data-ttu-id="adaaf-235">Si nécessaire, une fusion manuelle peut être effectuée explicitement en appelant [sys. sp_xtp_merge_checkpoint_files &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sys-sp-xtp-merge-checkpoint-files-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="adaaf-235">If needed, a manual merge can be explicitly performed by calling [sys.sp_xtp_merge_checkpoint_files &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sys-sp-xtp-merge-checkpoint-files-transact-sql).</span></span>

### <a name="life-cycle-of-a-cfp"></a><span data-ttu-id="adaaf-236">Cycle de vie d'une paire de fichiers de point de contrôle</span><span class="sxs-lookup"><span data-stu-id="adaaf-236">Life Cycle of a CFP</span></span>
 <span data-ttu-id="adaaf-237">Les paires de fichiers de point de contrôle traversent plusieurs états avant de pouvoir être libérées.</span><span class="sxs-lookup"><span data-stu-id="adaaf-237">CPFs transition through several states before they can be deallocated.</span></span> <span data-ttu-id="adaaf-238">À tout moment, les paires de fichiers de point de contrôle sont dans l'une des phases suivantes : PRECREATED, UNDER CONSTRUCTION, ACTIVE, MERGE TARGET, MERGED SOURCE, REQUIRED FOR BACKUP/HA, IN TRANSITION TO TOMBSTONE, et TOMBSTONE.</span><span class="sxs-lookup"><span data-stu-id="adaaf-238">At any given time, the CFPs are in one of the following phases: PRECREATED, UNDER CONSTRUCTION, ACTIVE, MERGE TARGET, MERGED SOURCE, REQUIRED FOR BACKUP/HA, IN TRANSITION TO TOMBSTONE, and TOMBSTONE.</span></span> <span data-ttu-id="adaaf-239">Pour obtenir une description de ces phases, consultez [sys.dm_db_xtp_checkpoint_files &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-xtp-checkpoint-files-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="adaaf-239">For a description of these phases, see [sys.dm_db_xtp_checkpoint_files &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-xtp-checkpoint-files-transact-sql).</span></span>

 <span data-ttu-id="adaaf-240">Après prise en compte du stockage occupé par les paires de fichiers de point de contrôle selon leurs états, le stockage global pris par les tables mémoire optimisées peut être bien plus grand que 2 fois la taille des tables en mémoire.</span><span class="sxs-lookup"><span data-stu-id="adaaf-240">After accounting for the storage taken by CFPs in various states, the overall storage taken by durable memory-optimized tables can be much larger than 2 times the size of the tables in memory.</span></span> <span data-ttu-id="adaaf-241">La DMV [sys. dm_db_xtp_checkpoint_files &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-xtp-checkpoint-files-transact-sql) peut être interrogée pour répertorier toutes les paires dans le groupe de fichiers mémoire optimisé, y compris leur phase.</span><span class="sxs-lookup"><span data-stu-id="adaaf-241">The DMV [sys.dm_db_xtp_checkpoint_files &#40;Transact-SQL&#41;](/sql/relational-databases/system-dynamic-management-views/sys-dm-db-xtp-checkpoint-files-transact-sql) can be queried to list all the CFPs in the memory-optimized filegroup, including their phase.</span></span> <span data-ttu-id="adaaf-242">Les paires de fichiers de point de contrôle qui passent de l'état MERGE SOURCE à l'état TOMBSTONE et l'opération de garbage collection peuvent occuper jusqu'à cinq points de contrôle, et chaque point est suivi d'une sauvegarde du journal des transactions, si la base de données est configurée selon un mode de restauration complète ou de récupération utilisant les journaux de transactions.</span><span class="sxs-lookup"><span data-stu-id="adaaf-242">Transitioning CFPs from MERGE SOURCE state to TOMBSTONE and ultimately garbage collection can take up five checkpoints, with each checkpoint followed by a transaction log backup, if the database is configured for full or bulk-logged recovery model.</span></span>

 <span data-ttu-id="adaaf-243">Forcez manuellement le point de contrôle, puis la sauvegarde de fichier journal pour accélérer l'opération de garbage collection, mais cela ajoutera 5 paires de fichiers de point de contrôle vides (5 paires de fichiers de données/delta avec chacune une taille de fichier de données de 128 Mo).</span><span class="sxs-lookup"><span data-stu-id="adaaf-243">You can manually force the checkpoint followed by log backup to expedite the garbage collection but then this will add 5 empty CFPs (5 data/delta file pairs with data file of size 128MB each).</span></span> <span data-ttu-id="adaaf-244">Dans les scénarios de production, les points de contrôle automatiques et les sauvegardes de fichier journal effectuées dans le cadre de la stratégie de sauvegarde basculent sans problème les paires de fichiers de point de contrôle vers ces phases sans aucune intervention manuelle.</span><span class="sxs-lookup"><span data-stu-id="adaaf-244">In production scenarios, the automatic checkpoints and log backups taken as part of backup strategy will seamlessly transition CFPs through these phases without requiring any manual intervention.</span></span> <span data-ttu-id="adaaf-245">L'impact du processus de garbage collection est le suivant : les bases de données avec des tables mémoire optimisées peuvent avoir une plus grande taille de stockage comparée à leur taille en mémoire.</span><span class="sxs-lookup"><span data-stu-id="adaaf-245">The impact of the garbage collection process is that databases with memory-optimized tables may have a larger storage size compared to its size in memory.</span></span> <span data-ttu-id="adaaf-246">Il n'est pas rare que les paires de fichiers de point de contrôle soient jusqu'à quatre fois plus volumineuses que les tables mémoire optimisées durables en mémoire.</span><span class="sxs-lookup"><span data-stu-id="adaaf-246">It is not uncommon for CFPs to be up to four times the size of the durable memory-optimized tables in memory.</span></span>

## <a name="see-also"></a><span data-ttu-id="adaaf-247">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="adaaf-247">See Also</span></span>
 [<span data-ttu-id="adaaf-248">Création et gestion du stockage des objets à mémoire optimisée</span><span class="sxs-lookup"><span data-stu-id="adaaf-248">Creating and Managing Storage for Memory-Optimized Objects</span></span>](creating-and-managing-storage-for-memory-optimized-objects.md)


