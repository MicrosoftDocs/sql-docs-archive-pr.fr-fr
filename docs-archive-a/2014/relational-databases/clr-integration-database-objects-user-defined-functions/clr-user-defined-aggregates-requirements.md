---
title: Configuration requise pour les agrégats CLR définis par l’utilisateur | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: clr
ms.topic: reference
helpviewer_keywords:
- aggregate functions [CLR integration]
- user-defined types [CLR integration], user-defined aggregates
- CREATE AGGREGATE statement
- SqlUserDefinedAggregate attribute
- aggregate methods [CLR integration]
- assemblies [CLR integration], user-defined aggregate functions
- custom aggregates [CLR integration]
- user-defined functions [CLR integration]
- UDTs [CLR integration], user-defined aggregates
ms.assetid: dbf9eb5a-bd99-42f7-b275-556d0def045d
author: rothja
ms.author: jroth
ms.openlocfilehash: 8123f8324d43212007857dbb596a4fc61872bd2e
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87610685"
---
# <a name="requirements-for-clr-user-defined-aggregates"></a><span data-ttu-id="a5808-102">Conditions requises pour les agrégats CLR définis par l'utilisateur</span><span class="sxs-lookup"><span data-stu-id="a5808-102">Requirements for CLR User-Defined Aggregates</span></span>
  <span data-ttu-id="a5808-103">Un type dans un assembly CLR (Common Language Runtime) peut être enregistré comme une fonction d'agrégation définie par l'utilisateur, tant qu'il implémente le contrat d'agrégation requis.</span><span class="sxs-lookup"><span data-stu-id="a5808-103">A type in a common language runtime (CLR) assembly can be registered as a user-defined aggregate function, as long as it implements the required aggregation contract.</span></span> <span data-ttu-id="a5808-104">Ce contrat se compose de l'attribut `SqlUserDefinedAggregate` et des méthodes du contrat d'agrégation.</span><span class="sxs-lookup"><span data-stu-id="a5808-104">This contract consists of the `SqlUserDefinedAggregate` attribute and the aggregation contract methods.</span></span> <span data-ttu-id="a5808-105">Le contrat d'agrégation inclut le mécanisme permettant d'enregistrer l'état intermédiaire de l'agrégation, ainsi que le mécanisme permettant d'accumuler de nouvelles valeurs, lequel est composé de quatre méthodes : `Init`, `Accumulate`, `Merge` et `Terminate`.</span><span class="sxs-lookup"><span data-stu-id="a5808-105">The aggregation contract includes the mechanism to save the intermediate state of the aggregation, and the mechanism to accumulate new values, which consists of four methods: `Init`, `Accumulate`, `Merge`, and `Terminate`.</span></span> <span data-ttu-id="a5808-106">Une fois ces conditions satisfaites, vous pourrez tirer pleinement parti des agrégats définis par l’utilisateur dans [!INCLUDE[msCoName](../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="a5808-106">When you have met these requirements, you will be able to take full advantage of user-defined aggregates in [!INCLUDE[msCoName](../../includes/msconame-md.md)] [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="a5808-107">Les sections suivantes de cette rubrique fournissent des détails supplémentaires sur la façon de créer et d'utiliser les agrégats définis par l'utilisateur.</span><span class="sxs-lookup"><span data-stu-id="a5808-107">The following sections of this topic provide additional details about how to create and work with user-defined aggregates.</span></span> <span data-ttu-id="a5808-108">Pour obtenir un exemple, consultez [appel de fonctions d’agrégation CLR définies par l’utilisateur](clr-user-defined-aggregate-invoking-functions.md).</span><span class="sxs-lookup"><span data-stu-id="a5808-108">For an example, see [Invoking CLR User-Defined Aggregate Functions](clr-user-defined-aggregate-invoking-functions.md).</span></span>  
  
## <a name="sqluserdefinedaggregate"></a><span data-ttu-id="a5808-109">SqlUserDefinedAggregate</span><span class="sxs-lookup"><span data-stu-id="a5808-109">SqlUserDefinedAggregate</span></span>  
 <span data-ttu-id="a5808-110">Pour plus d’informations, consultez [SqlUserDefinedAggregateAttribute](https://go.microsoft.com/fwlink/?LinkId=124626).</span><span class="sxs-lookup"><span data-stu-id="a5808-110">For more information, see [SqlUserDefinedAggregateAttribute](https://go.microsoft.com/fwlink/?LinkId=124626).</span></span>  
  
## <a name="aggregation-methods"></a><span data-ttu-id="a5808-111">Méthodes d'agrégation</span><span class="sxs-lookup"><span data-stu-id="a5808-111">Aggregation Methods</span></span>  
 <span data-ttu-id="a5808-112">La classe inscrite comme agrégat défini par l'utilisateur doit prendre en charge les méthodes d'instance suivantes.</span><span class="sxs-lookup"><span data-stu-id="a5808-112">The class registered as a user-defined aggregate should support the following instance methods.</span></span> <span data-ttu-id="a5808-113">Ce sont les méthodes que le processeur de requêtes utilise pour calculer l'agrégation :</span><span class="sxs-lookup"><span data-stu-id="a5808-113">These are the methods that the query processor uses to compute the aggregation:</span></span>  
  
|<span data-ttu-id="a5808-114">Méthode</span><span class="sxs-lookup"><span data-stu-id="a5808-114">Method</span></span>|<span data-ttu-id="a5808-115">Syntaxe</span><span class="sxs-lookup"><span data-stu-id="a5808-115">Syntax</span></span>|<span data-ttu-id="a5808-116">Description</span><span class="sxs-lookup"><span data-stu-id="a5808-116">Description</span></span>|  
|------------|------------|-----------------|  
|`Init`|<span data-ttu-id="a5808-117">public void init ();</span><span class="sxs-lookup"><span data-stu-id="a5808-117">public void Init();</span></span>|<span data-ttu-id="a5808-118">Le processeur de requêtes utilise cette méthode pour initialiser le calcul de l'agrégation.</span><span class="sxs-lookup"><span data-stu-id="a5808-118">The query processor uses this method to initialize the computation of the aggregation.</span></span> <span data-ttu-id="a5808-119">Cette méthode est appelée une fois pour chaque groupe dont le processeur de requêtes effectue l'agrégation.</span><span class="sxs-lookup"><span data-stu-id="a5808-119">This method is invoked once for each group that the query processor is aggregating.</span></span> <span data-ttu-id="a5808-120">Le processeur de requêtes peut choisir de réutiliser la même instance de la classe d'agrégation pour calculer des agrégats de plusieurs groupes.</span><span class="sxs-lookup"><span data-stu-id="a5808-120">The query processor may choose to reuse the same instance of the aggregate class for computing aggregates of multiple groups.</span></span> <span data-ttu-id="a5808-121">La méthode `Init` doit effectuer tout nettoyage nécessaire à partir des utilisations précédentes de cette instance et lui permettre de redémarrer un nouveau calcul d'agrégation.</span><span class="sxs-lookup"><span data-stu-id="a5808-121">The `Init` method should perform any clean-up as necessary from previous uses of this instance, and enable it to re-start a new aggregate computation.</span></span>|  
|`Accumulate`|<span data-ttu-id="a5808-122">public void Accumulate (valeur de type d’entrée [, valeur de type d’entrée,...]);</span><span class="sxs-lookup"><span data-stu-id="a5808-122">public void Accumulate ( input-type value[, input-type value, ...]);</span></span>|<span data-ttu-id="a5808-123">Un ou plusieurs paramètres représentant les paramètres de la fonction.</span><span class="sxs-lookup"><span data-stu-id="a5808-123">One or more parameters representing the parameters of the function.</span></span> <span data-ttu-id="a5808-124">*INPUT_TYPE* doit être le type de données managées [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] équivalent au [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] type de données natif spécifié par *input_sqltype* dans l' `CREATE AGGREGATE` instruction.</span><span class="sxs-lookup"><span data-stu-id="a5808-124">*input_type* should be the managed [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] data type equivalent to the native [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] data type specified by *input_sqltype* in the `CREATE AGGREGATE` statement.</span></span> <span data-ttu-id="a5808-125">Pour plus d’informations, consultez [mappage des données de paramètres CLR](../clr-integration-database-objects-types-net-framework/mapping-clr-parameter-data.md).</span><span class="sxs-lookup"><span data-stu-id="a5808-125">For more information, see [Mapping CLR Parameter Data](../clr-integration-database-objects-types-net-framework/mapping-clr-parameter-data.md).</span></span><br /><br /> <span data-ttu-id="a5808-126">Pour les types définis par l'utilisateur (UDT), le type d'entrée est le même que le type UDT.</span><span class="sxs-lookup"><span data-stu-id="a5808-126">For user-defined types (UDTs), the input-type is the same as the UDT type.</span></span> <span data-ttu-id="a5808-127">Le processeur de requêtes utilise cette méthode pour accumuler les valeurs d'agrégation.</span><span class="sxs-lookup"><span data-stu-id="a5808-127">The query processor uses this method to accumulate the aggregate values.</span></span> <span data-ttu-id="a5808-128">La méthode est appelée une fois pour chaque valeur dans le groupe qui fait l'objet de l'agrégation.</span><span class="sxs-lookup"><span data-stu-id="a5808-128">This is invoked once for each value in the group that is being aggregated.</span></span> <span data-ttu-id="a5808-129">Le processeur de requêtes l'appelle uniquement après avoir appelé la méthode `Init` sur l'instance donnée de la classe d'agrégation.</span><span class="sxs-lookup"><span data-stu-id="a5808-129">The query processor always calls this only after calling the `Init` method on the given instance of the aggregate-class.</span></span> <span data-ttu-id="a5808-130">L'implémentation de cette méthode doit mettre à jour l'état de l'instance pour refléter l'accumulation de la valeur d'argument qui est passée.</span><span class="sxs-lookup"><span data-stu-id="a5808-130">The implementation of this method should update the state of the instance to reflect the accumulation of the argument value being passed in.</span></span>|  
|`Merge`|<span data-ttu-id="a5808-131">public void Merge (valeur udagg_class);</span><span class="sxs-lookup"><span data-stu-id="a5808-131">public void Merge( udagg_class value);</span></span>|<span data-ttu-id="a5808-132">Cette méthode peut être utilisée pour fusionner une autre instance de cette classe d'agrégation avec l'instance actuelle.</span><span class="sxs-lookup"><span data-stu-id="a5808-132">This method can be used to merge another instance of this aggregate class with the current instance.</span></span> <span data-ttu-id="a5808-133">Le processeur de requêtes utilise cette méthode pour fusionner plusieurs calculs partiels d'une agrégation.</span><span class="sxs-lookup"><span data-stu-id="a5808-133">The query processor uses this method to merge multiple partial computations of an aggregation.</span></span>|  
|`Terminate`|<span data-ttu-id="a5808-134">public return_type Terminate ();</span><span class="sxs-lookup"><span data-stu-id="a5808-134">public return_type Terminate();</span></span>|<span data-ttu-id="a5808-135">Cette méthode termine le calcul d'agrégation et retourne le résultat de l'agrégation.</span><span class="sxs-lookup"><span data-stu-id="a5808-135">This method completes the aggregate computation and returns the result of the aggregation.</span></span> <span data-ttu-id="a5808-136">Le *return_type* doit être un [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] type de données managé qui est l’équivalent managé de *return_sqltype* spécifié dans l' `CREATE AGGREGATE` instruction.</span><span class="sxs-lookup"><span data-stu-id="a5808-136">The *return_type* should be a managed [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] data type that is the managed equivalent of *return_sqltype* specified in the `CREATE AGGREGATE` statement.</span></span> <span data-ttu-id="a5808-137">Le *return_type* peut également être un type défini par l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="a5808-137">The *return_type* can also be a user-defined type.</span></span>|  
  
### <a name="table-valued-parameters"></a><span data-ttu-id="a5808-138">Paramètres table</span><span class="sxs-lookup"><span data-stu-id="a5808-138">Table-Valued Parameters</span></span>  
 <span data-ttu-id="a5808-139">Les paramètres table (types de tables définis par l'utilisateur et passés dans une procédure ou une fonction) offrent un moyen efficace pour passer plusieurs lignes de données au serveur.</span><span class="sxs-lookup"><span data-stu-id="a5808-139">Table-valued parameters (TVPs), user-defined table types that are passed into a procedure or function, provide an efficient way to pass multiple rows of data to the server.</span></span> <span data-ttu-id="a5808-140">Ils procurent une fonctionnalité semblable aux tableaux de paramètres, mais offrent une meilleure souplesse et une intégration plus étroite à [!INCLUDE[tsql](../../includes/tsql-md.md)].</span><span class="sxs-lookup"><span data-stu-id="a5808-140">TVPs provide similar functionality to parameter arrays, but offer greater flexibility and closer integration with [!INCLUDE[tsql](../../includes/tsql-md.md)].</span></span> <span data-ttu-id="a5808-141">Ils sont également susceptibles de générer de meilleures performances.</span><span class="sxs-lookup"><span data-stu-id="a5808-141">They also provide the potential for better performance.</span></span> <span data-ttu-id="a5808-142">Les paramètres table aident également à réduire le nombre d'allers-retours au serveur.</span><span class="sxs-lookup"><span data-stu-id="a5808-142">TVPs also help reduce the number of round trips to the server.</span></span> <span data-ttu-id="a5808-143">Au lieu d'envoyer plusieurs demandes au serveur, comme avec une liste de paramètres scalaires, les données peuvent être envoyées au serveur en tant que paramètres table.</span><span class="sxs-lookup"><span data-stu-id="a5808-143">Instead of sending multiple requests to the server, such as with a list of scalar parameters, data can be sent to the server as a TVP.</span></span> <span data-ttu-id="a5808-144">Un type de table défini par l'utilisateur ne peut pas être passé en tant que paramètre table à une fonction ou à une procédure stockée managée s'exécutant dans le processus [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , ni être retourné à partir de ces dernières.</span><span class="sxs-lookup"><span data-stu-id="a5808-144">A user-defined table type cannot be passed as a table-valued parameter to, or be returned from, a managed stored procedure or function executing in the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] process.</span></span> <span data-ttu-id="a5808-145">Également, les paramètres table ne peuvent pas être utilisés dans l'étendue d'une connexion contextuelle.</span><span class="sxs-lookup"><span data-stu-id="a5808-145">Also, TVPs cannot be used within the scope of a context connection.</span></span> <span data-ttu-id="a5808-146">Toutefois, un paramètre table peut être utilisé avec SqlClient dans les procédures stockées managées ou les fonctions qui exécutent dans le processus [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], s'il est utilisé dans une connexion qui n'est pas une connexion contextuelle.</span><span class="sxs-lookup"><span data-stu-id="a5808-146">However, a TVP can be used with SqlClient in managed stored procedures or functions executing in the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] process, if it is used in a connection that is not a context connection.</span></span> <span data-ttu-id="a5808-147">La connexion peut s'effectuer au serveur qui exécute la procédure managée ou la fonction.</span><span class="sxs-lookup"><span data-stu-id="a5808-147">The connection can be to the same server that is executing the managed procedure or function.</span></span> <span data-ttu-id="a5808-148">Pour plus d’informations sur TVP, consultez [utiliser des paramètres Table &#40;Moteur de base de données&#41;](../tables/use-table-valued-parameters-database-engine.md).</span><span class="sxs-lookup"><span data-stu-id="a5808-148">For more information about TVPs, see [Use Table-Valued Parameters &#40;Database Engine&#41;](../tables/use-table-valued-parameters-database-engine.md).</span></span>  
  
## <a name="change-history"></a><span data-ttu-id="a5808-149">Historique des modifications</span><span class="sxs-lookup"><span data-stu-id="a5808-149">Change History</span></span>  
  
|<span data-ttu-id="a5808-150">Mise à jour du contenu</span><span class="sxs-lookup"><span data-stu-id="a5808-150">Updated content</span></span>|  
|---------------------|  
|<span data-ttu-id="a5808-151">Mise à jour de la description de la méthode `Accumulate` qui accepte à présent plusieurs paramètres.</span><span class="sxs-lookup"><span data-stu-id="a5808-151">Updated the description of the `Accumulate` method; it now accepts more than one parameter.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="a5808-152">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="a5808-152">See Also</span></span>  
 <span data-ttu-id="a5808-153">[Types CLR définis par l’utilisateur](../clr-integration-database-objects-user-defined-types/clr-user-defined-types.md) </span><span class="sxs-lookup"><span data-stu-id="a5808-153">[CLR User-Defined Types](../clr-integration-database-objects-user-defined-types/clr-user-defined-types.md) </span></span>  
 [<span data-ttu-id="a5808-154">Appel de fonctions d'agrégation CLR définies par l'utilisateur</span><span class="sxs-lookup"><span data-stu-id="a5808-154">Invoking CLR User-Defined Aggregate Functions</span></span>](clr-user-defined-aggregate-invoking-functions.md)  
  
  
