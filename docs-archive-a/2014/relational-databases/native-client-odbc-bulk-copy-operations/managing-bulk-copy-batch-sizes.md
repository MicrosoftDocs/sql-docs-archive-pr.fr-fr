---
title: Gestion des tailles de lot de copie en bloc | Microsoft Docs
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: native-client
ms.topic: reference
helpviewer_keywords:
- SQL Server Native Client ODBC driver, bulk copy
- ODBC, bulk copy operations
- batches [ODBC]
- bulk copy [ODBC], batch sizes
ms.assetid: 4b24139f-788b-45a6-86dc-ae835435d737
author: rothja
ms.author: jroth
ms.openlocfilehash: 1f24ece176cbb834e4162f9e516ff23013fd256a
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87612304"
---
# <a name="managing-bulk-copy-batch-sizes"></a><span data-ttu-id="9625e-102">Gestion des tailles de lot de copie en bloc</span><span class="sxs-lookup"><span data-stu-id="9625e-102">Managing Bulk Copy Batch Sizes</span></span>
  <span data-ttu-id="9625e-103">L'objectif principal d'un lot dans des opérations de copie en bloc est de définir l'étendue d'une transaction.</span><span class="sxs-lookup"><span data-stu-id="9625e-103">The primary purpose of a batch in bulk copy operations is to define the scope of a transaction.</span></span> <span data-ttu-id="9625e-104">Si aucune taille de lot n'est définie, les fonctions de copie en bloc considèrent une copie en bloc entière comme une transaction.</span><span class="sxs-lookup"><span data-stu-id="9625e-104">If a batch size is not set, then bulk copy functions consider an entire bulk copy to be one transaction.</span></span> <span data-ttu-id="9625e-105">Si une taille de lot est définie, chaque lot constitue alors une transaction validée à la fin de l'exécution de ce lot.</span><span class="sxs-lookup"><span data-stu-id="9625e-105">If a batch size is set, then each batch constitutes a transaction that is committed when the batch finishes.</span></span>  
  
 <span data-ttu-id="9625e-106">Si une copie en bloc est effectuée sans taille de lot et qu'une erreur est détectée, la copie en bloc entière est restaurée.</span><span class="sxs-lookup"><span data-stu-id="9625e-106">If a bulk copy is performed with no batch size specified and an error is encountered, the entire bulk copy is rolled back.</span></span> <span data-ttu-id="9625e-107">La récupération d'une copie en bloc de longue durée peut prendre un certain temps.</span><span class="sxs-lookup"><span data-stu-id="9625e-107">The recovery of a long-running bulk copy can take a long time.</span></span> <span data-ttu-id="9625e-108">Lorsqu'une taille de lot est définie, la copie en bloc considère chaque lot comme une transaction et valide chaque lot.</span><span class="sxs-lookup"><span data-stu-id="9625e-108">When a batch size is set, bulk copy considers each batch a transaction and commits each batch.</span></span> <span data-ttu-id="9625e-109">Si une erreur est détectée, seul le dernier lot en attente doit être restauré.</span><span class="sxs-lookup"><span data-stu-id="9625e-109">If an error is encountered, only the last outstanding batch needs to be rolled back.</span></span>  
  
 <span data-ttu-id="9625e-110">La taille de lot peut également affecter la surcharge de verrouillage.</span><span class="sxs-lookup"><span data-stu-id="9625e-110">The batch size can also affect locking overhead.</span></span> <span data-ttu-id="9625e-111">Lorsque vous effectuez une copie en bloc sur [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] , l’indicateur TABLOCK peut être spécifié à l’aide de [bcp_control](../native-client-odbc-extensions-bulk-copy-functions/bcp-control.md) pour acquérir un verrou de table au lieu de verrous de ligne.</span><span class="sxs-lookup"><span data-stu-id="9625e-111">When performing a bulk copy against [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], the TABLOCK hint can be specified using [bcp_control](../native-client-odbc-extensions-bulk-copy-functions/bcp-control.md) to acquire a table lock instead of row locks.</span></span> <span data-ttu-id="9625e-112">Le verrou de table unique peut être maintenu avec une charge minimale pour une opération de copie en bloc entière.</span><span class="sxs-lookup"><span data-stu-id="9625e-112">The single table lock can be held with minimal overhead for an entire bulk copy operation.</span></span> <span data-ttu-id="9625e-113">Si TABLOCK n'est pas spécifié, les verrous sont maintenus sur des lignes individuelles et la charge liée à la maintenance de tous les verrous pour la durée de la copie en bloc peut ralentir les performances.</span><span class="sxs-lookup"><span data-stu-id="9625e-113">If TABLOCK is not specified then locks are held on individual rows and the overhead of maintaining all the locks for the duration of the bulk copy can slow performance.</span></span> <span data-ttu-id="9625e-114">Les verrous étant uniquement maintenus pour la durée d'une transaction, la spécification d'une taille de lot résout ce problème en générant périodiquement une validation qui libère les verrous actuellement maintenus.</span><span class="sxs-lookup"><span data-stu-id="9625e-114">Because locks are only held for the length of a transaction, specifying a batch size addresses this problem by periodically generating a commit that frees the locks currently held.</span></span>  
  
 <span data-ttu-id="9625e-115">Le nombre de lignes constituant un lot peut avoir des effets significatifs sur les performances lors de la copie en bloc d'un grand nombre de lignes.</span><span class="sxs-lookup"><span data-stu-id="9625e-115">The number of rows making up a batch can have significant performance effects when bulk copying a large number of rows.</span></span> <span data-ttu-id="9625e-116">Les recommandations pour la taille de lot varient selon le type de copie en bloc effectuée.</span><span class="sxs-lookup"><span data-stu-id="9625e-116">The recommendations for batch size depend on the type of bulk copy being performed.</span></span>  
  
-   <span data-ttu-id="9625e-117">Lorsque vous effectuez une copie en bloc vers [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], spécifiez l'indicateur de copie en bloc TABLOCK et définissez une taille de lot importante.</span><span class="sxs-lookup"><span data-stu-id="9625e-117">When bulk copying to [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], specify the TABLOCK bulk copy hint and set a large batch size.</span></span>  
  
-   <span data-ttu-id="9625e-118">Lorsque TABLOCK n'est pas spécifié, limitez les tailles de lot à 1 000 lignes.</span><span class="sxs-lookup"><span data-stu-id="9625e-118">When TABLOCK is not specified, limit batch sizes to less than 1,000 rows.</span></span>  
  
 <span data-ttu-id="9625e-119">Lors d’une copie en bloc à partir d’un fichier de données, la taille de lot est spécifiée en appelant **bcp_control** avec l’option BCPBATCH avant d’appeler [bcp_exec](../native-client-odbc-extensions-bulk-copy-functions/bcp-exec.md).</span><span class="sxs-lookup"><span data-stu-id="9625e-119">When bulk copying in from a data file, the batch size is specified by calling **bcp_control** with the BCPBATCH option before calling [bcp_exec](../native-client-odbc-extensions-bulk-copy-functions/bcp-exec.md).</span></span> <span data-ttu-id="9625e-120">Lors d’une copie en bloc à partir de variables de programme à l’aide d' [bcp_bind](../native-client-odbc-extensions-bulk-copy-functions/bcp-bind.md) et de [bcp_sendrow](../native-client-odbc-extensions-bulk-copy-functions/bcp-sendrow.md), la taille de lot est contrôlée en appelant [bcp_batch](../native-client-odbc-extensions-bulk-copy-functions/bcp-batch.md) après l’appel de [bcp_sendrow](../native-client-odbc-extensions-bulk-copy-functions/bcp-sendrow.md) *x* fois, où *x* est le nombre de lignes dans un lot.</span><span class="sxs-lookup"><span data-stu-id="9625e-120">When bulk copying from program variables using [bcp_bind](../native-client-odbc-extensions-bulk-copy-functions/bcp-bind.md) and [bcp_sendrow](../native-client-odbc-extensions-bulk-copy-functions/bcp-sendrow.md), the batch size is controlled by calling [bcp_batch](../native-client-odbc-extensions-bulk-copy-functions/bcp-batch.md) after calling [bcp_sendrow](../native-client-odbc-extensions-bulk-copy-functions/bcp-sendrow.md) *x* times, where *x* is the number of rows in a batch.</span></span>  
  
 <span data-ttu-id="9625e-121">Outre la spécification de la taille d'une transaction, les lots affectent également le moment où les lignes sont envoyées au serveur via le réseau.</span><span class="sxs-lookup"><span data-stu-id="9625e-121">In addition to specifying the size of a transaction, batches also affect when rows are sent across the network to the server.</span></span> <span data-ttu-id="9625e-122">Les fonctions de copie en bloc mettent généralement en cache les lignes de **bcp_sendrow** jusqu’à ce qu’un paquet réseau soit rempli, puis envoie le paquet complet au serveur.</span><span class="sxs-lookup"><span data-stu-id="9625e-122">Bulk copy functions normally cache the rows from **bcp_sendrow** until a network packet is filled, and then send the full packet to the server.</span></span> <span data-ttu-id="9625e-123">Toutefois, lorsqu’une application appelle **bcp_batch**, le paquet en cours est envoyé au serveur, qu’il ait été rempli ou non.</span><span class="sxs-lookup"><span data-stu-id="9625e-123">When an application calls **bcp_batch**, however, the current packet is sent to the server regardless of whether it has been filled.</span></span> <span data-ttu-id="9625e-124">Le fait d'utiliser une taille de lot très réduite peut ralentir les performances si cela aboutit à l'envoi de nombreux paquets partiellement remplis au serveur.</span><span class="sxs-lookup"><span data-stu-id="9625e-124">Using a very low batch size can slow performance if it results in sending many partially filled packets to the server.</span></span> <span data-ttu-id="9625e-125">Par exemple, l’appel de **bcp_batch** après chaque **bcp_sendrow** entraîne l’envoi de chaque ligne dans un paquet distinct et, à moins que les lignes ne soient très volumineuses, gaspille de l’espace dans chaque paquet.</span><span class="sxs-lookup"><span data-stu-id="9625e-125">For example, calling **bcp_batch** after every **bcp_sendrow** causes each row to be sent in a separate packet and, unless the rows are very large, wastes space in each packet.</span></span> <span data-ttu-id="9625e-126">La taille par défaut des paquets réseau pour SQL Server est de 4 Ko, bien qu’une application puisse modifier la taille en appelant [SQLSetConnectAttr](../native-client-odbc-api/sqlsetconnectattr.md) en spécifiant l’attribut SQL_ATTR_PACKET_SIZE.</span><span class="sxs-lookup"><span data-stu-id="9625e-126">The default size of network packets for SQL Server is 4 KB, although an application can change the size by calling [SQLSetConnectAttr](../native-client-odbc-api/sqlsetconnectattr.md) specifying the SQL_ATTR_PACKET_SIZE attribute.</span></span>  
  
 <span data-ttu-id="9625e-127">Un autre effet secondaire des lots est que chaque lot est considéré comme un jeu de résultats en suspens jusqu’à ce qu’il soit terminé avec **bcp_batch**.</span><span class="sxs-lookup"><span data-stu-id="9625e-127">Another side effect of batches is that each batch is considered an outstanding result set until it is completed with **bcp_batch**.</span></span> <span data-ttu-id="9625e-128">Si d’autres opérations sont tentées sur un handle de connexion alors qu’un lot est en attente, le [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] pilote ODBC native client émet une erreur avec SQLSTATE = "HY000" et une chaîne de message d’erreur :</span><span class="sxs-lookup"><span data-stu-id="9625e-128">If any other operations are attempted on a connection handle while a batch is outstanding, the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client ODBC driver issues an error with SQLState = "HY000" and an error message string of:</span></span>  
  
```  
"[Microsoft][SQL Server Native Client] Connection is busy with  
results for another hstmt."  
```  
  
## <a name="see-also"></a><span data-ttu-id="9625e-129">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="9625e-129">See Also</span></span>  
 <span data-ttu-id="9625e-130">[Exécution d’opérations de copie en bloc &#40;ODBC&#41;](performing-bulk-copy-operations-odbc.md) </span><span class="sxs-lookup"><span data-stu-id="9625e-130">[Performing Bulk Copy Operations &#40;ODBC&#41;](performing-bulk-copy-operations-odbc.md) </span></span>  
 [<span data-ttu-id="9625e-131">Importation et exportation en bloc de données &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="9625e-131">Bulk Import and Export of Data &#40;SQL Server&#41;</span></span>](../import-export/bulk-import-and-export-of-data-sql-server.md)  
  
  
