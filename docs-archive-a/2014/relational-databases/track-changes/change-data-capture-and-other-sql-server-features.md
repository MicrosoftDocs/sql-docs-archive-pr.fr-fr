---
title: Capture de données modifiées et autres fonctionnalités de SQL Server | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
helpviewer_keywords:
- change data capture [SQL Server], other SQL Server features and
ms.assetid: 7dfcb362-1904-4578-8274-da16681a960e
author: rothja
ms.author: jroth
ms.openlocfilehash: acafd5ba49bec92fd4c6b93c4163affaa42ab7f1
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87611641"
---
# <a name="change-data-capture-and-other-sql-server-features"></a><span data-ttu-id="cfaee-102">Capture de données modifiées et autres fonctionnalités de SQL Server</span><span class="sxs-lookup"><span data-stu-id="cfaee-102">Change Data Capture and Other SQL Server Features</span></span>
  <span data-ttu-id="cfaee-103">Cette rubrique décrit comment les fonctionnalités suivantes interagissent avec la capture de données modifiées :</span><span class="sxs-lookup"><span data-stu-id="cfaee-103">This topic describes how the following features interact with change data capture:</span></span>  
  
-   [<span data-ttu-id="cfaee-104">Suivi des modifications</span><span class="sxs-lookup"><span data-stu-id="cfaee-104">Change tracking</span></span>](#ChangeTracking)  
  
-   [<span data-ttu-id="cfaee-105">Mise en miroir de bases de données</span><span class="sxs-lookup"><span data-stu-id="cfaee-105">Database mirroring</span></span>](#DatabaseMirroring)  
  
-   [<span data-ttu-id="cfaee-106">Réplication transactionnelle</span><span class="sxs-lookup"><span data-stu-id="cfaee-106">Transactional replication</span></span>](#TransReplication)  
  
-   [<span data-ttu-id="cfaee-107">Restauration ou attachement d'une base de données activée pour la capture de données modifiées</span><span class="sxs-lookup"><span data-stu-id="cfaee-107">Restoring or Attaching a Database Enabled for Change Data Capture</span></span>](#RestoreOrAttach)  
  
##  <a name="change-tracking"></a><a name="ChangeTracking"></a> <span data-ttu-id="cfaee-108">Suivi des modifications</span><span class="sxs-lookup"><span data-stu-id="cfaee-108">Change Tracking</span></span>  
 <span data-ttu-id="cfaee-109">La capture de données modifiées et le [suivi des modifications](about-change-tracking-sql-server.md) peuvent être activés sur la même base de données.</span><span class="sxs-lookup"><span data-stu-id="cfaee-109">Change data capture and [change tracking](about-change-tracking-sql-server.md) can be enabled on the same database.</span></span> <span data-ttu-id="cfaee-110">Aucune considération particulière ne s'applique.</span><span class="sxs-lookup"><span data-stu-id="cfaee-110">No special considerations are required.</span></span> <span data-ttu-id="cfaee-111">Pour plus d’informations, consultez [Utiliser le suivi des modifications &#40;SQL Server&#41;](work-with-change-tracking-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="cfaee-111">For more information, see [Work with Change Tracking &#40;SQL Server&#41;](work-with-change-tracking-sql-server.md).</span></span>  
  
##  <a name="database-mirroring"></a><a name="DatabaseMirroring"></a> <span data-ttu-id="cfaee-112">Mise en miroir de bases de données</span><span class="sxs-lookup"><span data-stu-id="cfaee-112">Database Mirroring</span></span>  
 <span data-ttu-id="cfaee-113">Une base de données prenant en charge la capture de données modifiées peut être mise en miroir.</span><span class="sxs-lookup"><span data-stu-id="cfaee-113">A database that is enabled for change data capture can be mirrored.</span></span> <span data-ttu-id="cfaee-114">Pour faire en sorte que la capture et le nettoyage s'exécutent automatiquement après un basculement, suivez ces étapes :</span><span class="sxs-lookup"><span data-stu-id="cfaee-114">To ensure that capture and cleanup happen automatically after a failover, follow these steps:</span></span>  
  
1.  <span data-ttu-id="cfaee-115">Vérifiez que [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Agent s'exécute sur la nouvelle instance de serveur principal.</span><span class="sxs-lookup"><span data-stu-id="cfaee-115">Ensure that [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Agent is running on the new principal server instance.</span></span>  
  
2.  <span data-ttu-id="cfaee-116">Créez le travail de capture et le travail de nettoyage sur la nouvelle base de données principale (base de données miroir initiale).</span><span class="sxs-lookup"><span data-stu-id="cfaee-116">Create the capture job and cleanup job on the new principal database (the former mirror database).</span></span> <span data-ttu-id="cfaee-117">Pour créer les travaux, utilisez la procédure stockée [sp_cdc_add_job](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-add-job-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="cfaee-117">To create the jobs, use the [sp_cdc_add_job](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-add-job-transact-sql) stored procedure.</span></span>  
  
 <span data-ttu-id="cfaee-118">Pour consulter la configuration actuelle d’un travail de capture ou de nettoyage, utilisez la procédure stockée [sys.sp_cdc_help_jobs](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-help-jobs-transact-sql) sur la nouvelle instance de serveur principal.</span><span class="sxs-lookup"><span data-stu-id="cfaee-118">To view the current configuration of a cleanup or capture job, use the [sys.sp_cdc_help_jobs](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-help-jobs-transact-sql) stored procedure on the new principal server instance.</span></span> <span data-ttu-id="cfaee-119">Pour une base de données spécifique, le travail de capture est nommé cdc.*nom_base_de_données*_capture, tandis que le travail de nettoyage est nommé cdc.*nom_base_de_données*_cleanup, où *nom_base_de_données* est le nom de la base de données.</span><span class="sxs-lookup"><span data-stu-id="cfaee-119">For a given database, the capture job is named cdc.*database_name*_capture, and the cleanup job is named cdc.*database_name*_cleanup, where *database_name* is the name of the database.</span></span>  
  
 <span data-ttu-id="cfaee-120">Pour modifier la configuration d’un travail, utilisez la procédure stockée [sys.sp_cdc_change_job](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-change-job-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="cfaee-120">To change the configuration of a job, use the [sys.sp_cdc_change_job](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-change-job-transact-sql) stored procedure.</span></span>  
  
 <span data-ttu-id="cfaee-121">Pour plus d’informations sur la mise en miroir des bases de données, consultez [Mise en miroir de bases de données &#40;SQL Server&#41;](../../database-engine/database-mirroring/database-mirroring-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="cfaee-121">For information about database mirroring, see [Database Mirroring &#40;SQL Server&#41;](../../database-engine/database-mirroring/database-mirroring-sql-server.md).</span></span>  
  
##  <a name="transactional-replication"></a><a name="TransReplication"></a><span data-ttu-id="cfaee-122">Réplication transactionnelle</span><span class="sxs-lookup"><span data-stu-id="cfaee-122">Transactional Replication</span></span>  
 <span data-ttu-id="cfaee-123">La capture de données modifiées et la réplication transactionnelle peuvent coexister dans la même base de données, mais le remplissage des tables de modifications est géré différemment lorsque les deux fonctionnalités sont activées.</span><span class="sxs-lookup"><span data-stu-id="cfaee-123">Change data capture and transactional replication can coexist in the same database, but population of the change tables is handled differently when both features are enabled.</span></span> <span data-ttu-id="cfaee-124">La capture de données modifiées et la réplication transactionnelle utilisent toujours la même procédure, [sp_replcmds](/sql/relational-databases/system-stored-procedures/sp-replcmds-transact-sql), pour lire les modifications dans le journal des transactions.</span><span class="sxs-lookup"><span data-stu-id="cfaee-124">Change data capture and transactional replication always use the same procedure, [sp_replcmds](/sql/relational-databases/system-stored-procedures/sp-replcmds-transact-sql), to read changes from the transaction log.</span></span> <span data-ttu-id="cfaee-125">Lorsque la capture de données modifiées est activée seule, un [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] travail de l’agent appelle `sp_replcmds` .</span><span class="sxs-lookup"><span data-stu-id="cfaee-125">When change data capture is enabled on its own, a [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Agent job calls `sp_replcmds`.</span></span> <span data-ttu-id="cfaee-126">Lorsque les deux fonctionnalités sont activées sur la même base de données, l’agent de lecture du journal appelle `sp_replcmds` .</span><span class="sxs-lookup"><span data-stu-id="cfaee-126">When both features are enabled on the same database, the Log Reader Agent calls `sp_replcmds`.</span></span> <span data-ttu-id="cfaee-127">Cet agent remplit à la fois les tables de modifications et les tables de bases de données de distribution.</span><span class="sxs-lookup"><span data-stu-id="cfaee-127">This agent populates both the change tables and the distribution database tables.</span></span> <span data-ttu-id="cfaee-128">Pour plus d’informations, consultez [Replication Log Reader Agent](../replication/agents/replication-log-reader-agent.md).</span><span class="sxs-lookup"><span data-stu-id="cfaee-128">For more information, see [Replication Log Reader Agent](../replication/agents/replication-log-reader-agent.md).</span></span>  
  
 <span data-ttu-id="cfaee-129">Considérez un scénario dans lequel la capture de données modifiées est activée sur la base de données [!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)] , et deux tables sont activées pour la capture.</span><span class="sxs-lookup"><span data-stu-id="cfaee-129">Consider a scenario in which change data capture is enabled on the [!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)] database, and two tables are enabled for capture.</span></span> <span data-ttu-id="cfaee-130">Pour remplir les tables de modifications, le travail de capture appelle `sp_replcmds` .</span><span class="sxs-lookup"><span data-stu-id="cfaee-130">To populate the change tables, the capture job calls `sp_replcmds`.</span></span> <span data-ttu-id="cfaee-131">La base de données est activée pour la réplication transactionnelle, et une publication est créée.</span><span class="sxs-lookup"><span data-stu-id="cfaee-131">The database is enabled for transactional replication, and a publication is created.</span></span> <span data-ttu-id="cfaee-132">Ensuite, l'Agent de lecture du journal est créé pour la base de données et le travail de capture est supprimé.</span><span class="sxs-lookup"><span data-stu-id="cfaee-132">Now, the Log Reader Agent is created for the database and the capture job is deleted.</span></span> <span data-ttu-id="cfaee-133">L'Agent de lecture du journal continue à analyser le journal à partir du dernier numéro séquentiel dans le journal qui été validé dans la table de modifications.</span><span class="sxs-lookup"><span data-stu-id="cfaee-133">The Log Reader Agent continues to scan the log from the last log sequence number that was committed to the change table.</span></span> <span data-ttu-id="cfaee-134">Cela garantit la cohérence des données dans les tables de modifications.</span><span class="sxs-lookup"><span data-stu-id="cfaee-134">This ensures data consistency in the change tables.</span></span> <span data-ttu-id="cfaee-135">Si la réplication transactionnelle est désactivée dans cette base de données, l'Agent de lecture du journal est supprimé et le travail de capture est recréé.</span><span class="sxs-lookup"><span data-stu-id="cfaee-135">If transactional replication is disabled in this database, the Log Reader Agent is removed and the capture job is re-created.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="cfaee-136">Lorsque l'Agent de lecture du journal est utilisé à la fois pour la capture de données modifiées et la réplication transactionnelle, les modifications répliquées sont écrites en premier dans la base de données de distribution.</span><span class="sxs-lookup"><span data-stu-id="cfaee-136">When the Log Reader Agent is used for both change data capture and transactional replication, replicated changes are first written to the distribution database.</span></span> <span data-ttu-id="cfaee-137">Puis, les modifications capturées sont écrites dans les tables de modifications.</span><span class="sxs-lookup"><span data-stu-id="cfaee-137">Then, captured changes are written to the change tables.</span></span> <span data-ttu-id="cfaee-138">Les deux opérations sont validées ensemble.</span><span class="sxs-lookup"><span data-stu-id="cfaee-138">Both operations are committed together.</span></span> <span data-ttu-id="cfaee-139">Si l'écriture dans la base de données de distribution s'effectue avec une latence, la même latence est observée avant l'affichage des modifications dans les tables de modifications.</span><span class="sxs-lookup"><span data-stu-id="cfaee-139">If there is any latency in writing to the distribution database, there will be a corresponding latency before changes appear in the change tables.</span></span>  
  
 <span data-ttu-id="cfaee-140">L'option **proc exec** de réplication transactionnelle n'est pas disponible lorsque la capture de données modifiées est activée.</span><span class="sxs-lookup"><span data-stu-id="cfaee-140">The **proc exec** option of transactional replication is not available when change data capture is enabled.</span></span>  
  
##  <a name="restoring-or-attaching-a-database-enabled-for-change-data-capture"></a><a name="RestoreOrAttach"></a><span data-ttu-id="cfaee-141">Restauration ou attachement d’une base de données activée pour la capture de données modifiées</span><span class="sxs-lookup"><span data-stu-id="cfaee-141">Restoring or Attaching a Database Enabled for Change Data Capture</span></span>  
 [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="cfaee-142">utilise la logique suivante pour déterminer si la capture de données modifiées reste activée après qu'une base de données a été restaurée ou attachée :</span><span class="sxs-lookup"><span data-stu-id="cfaee-142">uses the following logic to determine if change data capture remains enabled after a database is restored or attached:</span></span>  
  
-   <span data-ttu-id="cfaee-143">Si une base de données est restaurée sur le même serveur avec le même nom de base de données, la capture de données modifiées reste activée.</span><span class="sxs-lookup"><span data-stu-id="cfaee-143">If a database is restored to the same server with the same database name, change data capture remains enabled.</span></span>  
  
-   <span data-ttu-id="cfaee-144">Si une base de données est restaurée sur un autre serveur, par défaut, la capture de données modifiées est désactivée et toutes les métadonnées connexes sont supprimées.</span><span class="sxs-lookup"><span data-stu-id="cfaee-144">If a database is restored to another server, by default change data capture is disabled and all related metadata is deleted.</span></span>  
  
     <span data-ttu-id="cfaee-145">Pour conserver la fonction de capture de données modifiées, utilisez l'option `KEEP_CDC` lors de la restauration de la base de données.</span><span class="sxs-lookup"><span data-stu-id="cfaee-145">To retain change data capture, use the `KEEP_CDC` option when restoring the database.</span></span> <span data-ttu-id="cfaee-146">Pour plus d'informations sur cette option, consultez [RESTORE](/sql/t-sql/statements/restore-statements-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="cfaee-146">For more information about this option, see [RESTORE](/sql/t-sql/statements/restore-statements-transact-sql).</span></span>  
  
-   <span data-ttu-id="cfaee-147">Si une base de données est détachée puis attachée au même serveur ou à un autre serveur, la capture de données modifiées reste activée.</span><span class="sxs-lookup"><span data-stu-id="cfaee-147">If a database is detached and attached to the same server or another server, change data capture remains enabled.</span></span>  
  
-   <span data-ttu-id="cfaee-148">Si une base de données est attachée ou restaurée avec l'option `KEEP_CDC` à toute édition autre qu'Enterprise, l'opération est bloquée parce que la capture de données modifiées requiert [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Enterprise.</span><span class="sxs-lookup"><span data-stu-id="cfaee-148">If a database is attached or restored with the `KEEP_CDC` option to any edition other than Enterprise, the operation is blocked because change data capture requires [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Enterprise.</span></span> <span data-ttu-id="cfaee-149">Le message d’erreur 934 est affiché :</span><span class="sxs-lookup"><span data-stu-id="cfaee-149">Error message 934 is displayed:</span></span>  
  
     `SQL Server cannot load database '%.*ls' because change data capture is enabled. The currently installed edition of SQL Server does not support change data capture. Either disable change data capture in the database by using a supported edition of SQL Server, or upgrade the instance to one that supports change data capture.`  
  
 <span data-ttu-id="cfaee-150">Vous pouvez utiliser [sys.sp_cdc_disable_db](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-disable-db-transact-sql) pour supprimer la capture de données modifiées d’une base de données restaurée ou attachée.</span><span class="sxs-lookup"><span data-stu-id="cfaee-150">You can use [sys.sp_cdc_disable_db](/sql/relational-databases/system-stored-procedures/sys-sp-cdc-disable-db-transact-sql) to remove change data capture from a restored or attached database.</span></span>  
  
## <a name="change-data-capture-and-alwayson"></a><span data-ttu-id="cfaee-151">Capture de données modifiées et AlwaysON</span><span class="sxs-lookup"><span data-stu-id="cfaee-151">Change Data Capture and AlwaysON</span></span>  
 <span data-ttu-id="cfaee-152">Lorsque vous utilisez AlwaysON, l'énumération des modifications doit être effectuée sur la réplication secondaire afin de réduire la charge du disque sur le serveur principal.</span><span class="sxs-lookup"><span data-stu-id="cfaee-152">When you use AlwaysON, change enumeration should be done on the Secondary replication to reduce the disk load on the primary.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="cfaee-153">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="cfaee-153">See Also</span></span>  
 [<span data-ttu-id="cfaee-154">Administrer et surveiller la capture de données modifiées &#40;SQL Server&#41;</span><span class="sxs-lookup"><span data-stu-id="cfaee-154">Administer and Monitor Change Data Capture &#40;SQL Server&#41;</span></span>](../track-changes/administer-and-monitor-change-data-capture-sql-server.md)  
  
  
