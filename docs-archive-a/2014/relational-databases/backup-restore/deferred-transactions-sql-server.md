---
title: Transactions différées (SQL Server) | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: backup-restore
ms.topic: conceptual
helpviewer_keywords:
- I/O [SQL Server], database recovery
- restoring pages [SQL Server]
- deferred transactions
- modifying transaction deferred state
ms.assetid: 6fc0f9b6-d3ea-4971-9f27-d0195d1ff718
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 188a0409fbad3f12283adacafbfcb5f176650b72
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87604589"
---
# <a name="deferred-transactions-sql-server"></a><span data-ttu-id="4ff83-102">Transactions différées (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="4ff83-102">Deferred Transactions (SQL Server)</span></span>
  <span data-ttu-id="4ff83-103">Dans [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Enterprise, une transaction endommagée est différée si les données requises par la restauration (annulation) sont hors connexion durant le démarrage de la base de données.</span><span class="sxs-lookup"><span data-stu-id="4ff83-103">In [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Enterprise, a corrupted transaction can become deferred if data required by rollback (undo) is offline during database startup.</span></span> <span data-ttu-id="4ff83-104">Une *transaction différée* est une transaction qui n’est pas validée lorsque la phase de restauration par progression s’achève et dont la restauration ne peut pas être annulée en raison d’une erreur.</span><span class="sxs-lookup"><span data-stu-id="4ff83-104">A *deferred transaction* is a transaction that is uncommitted when the roll forward phase finishes and that has encountered an error that prevents it from being rolled back.</span></span> <span data-ttu-id="4ff83-105">Si la transaction ne peut pas être annulée, elle est différée.</span><span class="sxs-lookup"><span data-stu-id="4ff83-105">Because the transaction cannot be rolled back, it is deferred.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="4ff83-106">Les transactions endommagées sont différées uniquement dans [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Enterprise.</span><span class="sxs-lookup"><span data-stu-id="4ff83-106">Corrupted transactions are deferred only in [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Enterprise.</span></span> <span data-ttu-id="4ff83-107">Pour les autres éditions de [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], une transaction endommagée peut entraîner l'échec du démarrage.</span><span class="sxs-lookup"><span data-stu-id="4ff83-107">In other editions of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], a corrupted transaction causes startup to fail.</span></span>  
  
 <span data-ttu-id="4ff83-108">Généralement, une transaction différée peut se produire si, au cours d'une séquence de restauration de la base de données, une erreur d'E/S a empêché la lecture d'une page requise par la transaction.</span><span class="sxs-lookup"><span data-stu-id="4ff83-108">Generally, a deferred transaction occurs because, while the database was being rolled forward, an I/O error prevented reading a page that was required by the transaction.</span></span> <span data-ttu-id="4ff83-109">Cependant, une erreur au niveau des fichiers peut également engendrer des transactions différées.</span><span class="sxs-lookup"><span data-stu-id="4ff83-109">However, an error at the file level can also cause deferred transactions.</span></span> <span data-ttu-id="4ff83-110">Une transaction différée peut aussi se produire lorsqu'une séquence de restauration partielle s'arrête à un point où l'annulation de la transaction est nécessaire et où une transaction requiert des données hors connexion.</span><span class="sxs-lookup"><span data-stu-id="4ff83-110">A deferred transaction can also occur when a partial restore sequence stops at a point at which transaction rollback is necessary and a transaction requires data that is offline.</span></span>  
  
 <span data-ttu-id="4ff83-111">Les transactions utilisateur en cours d'annulation qui rencontrent une erreur d'E/S provoquent la mise hors connexion de la totalité de la base de données.</span><span class="sxs-lookup"><span data-stu-id="4ff83-111">User transactions that are rolling back and hit an I/O error cause the whole database to go offline.</span></span> <span data-ttu-id="4ff83-112">Lorsque la base de données est remise en ligne, la restauration par progression acquiert de nouveau tous les verrous qu'elle possédait et tente de restaurer toutes les transactions non validées.</span><span class="sxs-lookup"><span data-stu-id="4ff83-112">When the database is brought back online, the redo reacquires all the locks it had and tries to roll back all the uncommitted transactions.</span></span> <span data-ttu-id="4ff83-113">Toutes les données modifiées par une transaction demeurent correctement verrouillées jusqu'à ce que la transaction ait été restaurée.</span><span class="sxs-lookup"><span data-stu-id="4ff83-113">All data modified by a transaction remains appropriately locked until the transaction can roll back.</span></span> <span data-ttu-id="4ff83-114">Les transactions qui ne peuvent pas être restaurées abandonneront leurs verrous une fois l'altération corrigée et la base de données redémarrée ou, après une restauration en ligne, une fois que sont résolues les transactions différées tandis que la base de données est en ligne.</span><span class="sxs-lookup"><span data-stu-id="4ff83-114">Transactions that cannot be rolled back will give up their locks when the corruption is fixed and the database restarted or, after an online restore, when the deferred transactions are resolved while the database remains online.</span></span> <span data-ttu-id="4ff83-115">À ce stade, une transaction différée peut contenir des verrous qui empêchent certaines opérations sur la base de données dans sa globalité.</span><span class="sxs-lookup"><span data-stu-id="4ff83-115">Until that point, a deferred transaction can hold locks that prevent certain operations on the database as a whole.</span></span> <span data-ttu-id="4ff83-116">Par exemple, si une transaction différée contient une instruction CREATE TABLE, aucun utilisateur ne peut créer de table tant que la transaction différée n'a pas été résolue.</span><span class="sxs-lookup"><span data-stu-id="4ff83-116">For example, if a deferred transaction contains a CREATE TABLE instruction, no user can create a table until the deferred transaction has been resolved.</span></span>  
  
 <span data-ttu-id="4ff83-117">Une transaction différée peut aussi se produire lorsqu'une restauration fragmentaire récupère une base de données à un point où une ou plusieurs transactions actives affectent un groupe de fichiers hors connexion et n'ayant pas encore été restaurés.</span><span class="sxs-lookup"><span data-stu-id="4ff83-117">Deferred transaction can also occur because a piecemeal restore recovers a database to a point at which one or more active transactions are affecting a filegroup that has not yet been restored and is offline.</span></span> <span data-ttu-id="4ff83-118">Si les transactions ne peuvent pas être restaurées, elles deviennent différées.</span><span class="sxs-lookup"><span data-stu-id="4ff83-118">Because the transactions cannot be rolled back, they become deferred.</span></span>  
  
 <span data-ttu-id="4ff83-119">Le tableau suivant répertorie les actions qui amènent une base de données à réaliser une récupération et le résultat en cas de problème d'E/S.</span><span class="sxs-lookup"><span data-stu-id="4ff83-119">The following table lists the actions that cause a database to perform recovery and the outcome if an I/O problem occurs.</span></span>  
  
|<span data-ttu-id="4ff83-120">Action</span><span class="sxs-lookup"><span data-stu-id="4ff83-120">Action</span></span>|<span data-ttu-id="4ff83-121">Résolution (en cas de problèmes d'E/S ou de données requises hors connexion)</span><span class="sxs-lookup"><span data-stu-id="4ff83-121">Resolution (if I/O problems occur or required data is offline)</span></span>|  
|------------|-----------------------------------------------------------------------|  
|<span data-ttu-id="4ff83-122">Démarrage du serveur</span><span class="sxs-lookup"><span data-stu-id="4ff83-122">Server start</span></span>|<span data-ttu-id="4ff83-123">transaction différée</span><span class="sxs-lookup"><span data-stu-id="4ff83-123">Deferred transaction</span></span>|  
|<span data-ttu-id="4ff83-124">Restaurer</span><span class="sxs-lookup"><span data-stu-id="4ff83-124">Restore</span></span>|<span data-ttu-id="4ff83-125">transaction différée</span><span class="sxs-lookup"><span data-stu-id="4ff83-125">Deferred transaction</span></span>|  
|<span data-ttu-id="4ff83-126">Joindre</span><span class="sxs-lookup"><span data-stu-id="4ff83-126">Attach</span></span>|<span data-ttu-id="4ff83-127">Échec de l'attachement</span><span class="sxs-lookup"><span data-stu-id="4ff83-127">Attach fails</span></span>|  
|<span data-ttu-id="4ff83-128">Redémarrage automatique</span><span class="sxs-lookup"><span data-stu-id="4ff83-128">Autorestart</span></span>|<span data-ttu-id="4ff83-129">transaction différée</span><span class="sxs-lookup"><span data-stu-id="4ff83-129">Deferred transaction</span></span>|  
|<span data-ttu-id="4ff83-130">Création d'une base de données ou d'un instantané de base de données</span><span class="sxs-lookup"><span data-stu-id="4ff83-130">Create database or database snapshot</span></span>|<span data-ttu-id="4ff83-131">Échec de la création</span><span class="sxs-lookup"><span data-stu-id="4ff83-131">Creation fails</span></span>|  
|<span data-ttu-id="4ff83-132">Restauration par progression sur mise en miroir de bases de données</span><span class="sxs-lookup"><span data-stu-id="4ff83-132">Redo on database mirroring</span></span>|<span data-ttu-id="4ff83-133">transaction différée</span><span class="sxs-lookup"><span data-stu-id="4ff83-133">Deferred transaction</span></span>|  
|<span data-ttu-id="4ff83-134">Groupe de fichiers hors connexion</span><span class="sxs-lookup"><span data-stu-id="4ff83-134">Filegroup is offline</span></span>|<span data-ttu-id="4ff83-135">transaction différée</span><span class="sxs-lookup"><span data-stu-id="4ff83-135">Deferred transaction</span></span>|  
  
## <a name="moving-a-transaction-out-of-the-deferred-state"></a><span data-ttu-id="4ff83-136">Mise d'une transaction hors de l'état DEFERRED</span><span class="sxs-lookup"><span data-stu-id="4ff83-136">Moving a Transaction Out of the DEFERRED State</span></span>  
  
> [!IMPORTANT]  
>  <span data-ttu-id="4ff83-137">Une transaction différée maintient actif le journal des transactions.</span><span class="sxs-lookup"><span data-stu-id="4ff83-137">Deferred transactions keep the transaction log active.</span></span> <span data-ttu-id="4ff83-138">Un fichier journal virtuel qui contient des transactions différées ne peut pas être tronquées tant que ces transactions n'ont pas quitté l'état différé.</span><span class="sxs-lookup"><span data-stu-id="4ff83-138">A virtual log file that contains any deferred transactions cannot be truncated until those transactions are moved out of the deferred state.</span></span> <span data-ttu-id="4ff83-139">Pour plus d’informations sur la troncation de journal, consultez [Journal des transactions &#40;SQL Server&#41;](../logs/the-transaction-log-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="4ff83-139">For more information about log truncation, see [The Transaction Log &#40;SQL Server&#41;](../logs/the-transaction-log-sql-server.md).</span></span>  
  
 <span data-ttu-id="4ff83-140">Pour que la transaction ne soit plus dans un état différé, la base de données doit démarrer correctement sans erreurs d'E/S.</span><span class="sxs-lookup"><span data-stu-id="4ff83-140">To move the transaction out of the deferred state, the database must start cleanly without any I/O errors.</span></span> <span data-ttu-id="4ff83-141">Si des transactions différées existent, vous devez corriger la source des erreurs d'E/S.</span><span class="sxs-lookup"><span data-stu-id="4ff83-141">If deferred transactions exist, you must fix the source of the I/O errors.</span></span> <span data-ttu-id="4ff83-142">Les solutions possibles sont répertoriées ci-dessous dans l'ordre dans lequel elles sont essayées habituellement :</span><span class="sxs-lookup"><span data-stu-id="4ff83-142">The available solutions, listed in the order in which they are typically tried, are as follows:</span></span>  
  
-   <span data-ttu-id="4ff83-143">Redémarrez la base de données.</span><span class="sxs-lookup"><span data-stu-id="4ff83-143">Restart the database.</span></span> <span data-ttu-id="4ff83-144">Si le problème était temporaire, la base de données devrait démarrer sans transactions différées.</span><span class="sxs-lookup"><span data-stu-id="4ff83-144">If the problem was transient, the database should start without deferred transactions.</span></span>  
  
-   <span data-ttu-id="4ff83-145">Si les transactions ont été différées parce qu'un groupe de fichiers se trouvait hors connexion, placez le groupe de fichiers en ligne.</span><span class="sxs-lookup"><span data-stu-id="4ff83-145">If the transactions were deferred because a filegroup was offline, bring the filegroup back online.</span></span>  
  
     <span data-ttu-id="4ff83-146">Pour remettre en ligne un groupe de fichiers hors connexion, utilisez l'instruction [!INCLUDE[tsql](../../includes/tsql-md.md)] suivante :</span><span class="sxs-lookup"><span data-stu-id="4ff83-146">To bring an offline filegroup back online, use the following [!INCLUDE[tsql](../../includes/tsql-md.md)] statement:</span></span>  
  
    ```  
    RESTORE DATABASE database_name FILEGROUP=<filegroup_name>  
    ```  
  
-   <span data-ttu-id="4ff83-147">Restaurez la base de données.</span><span class="sxs-lookup"><span data-stu-id="4ff83-147">Restore the database.</span></span> <span data-ttu-id="4ff83-148">Après une restauration en ligne, toutes les transactions différées sont résolues.</span><span class="sxs-lookup"><span data-stu-id="4ff83-148">After an online restore, any deferred transactions are resolved.</span></span>  
  
     <span data-ttu-id="4ff83-149">En mode de restauration complète ou en mode de récupération utilisant les journaux de transactions, si les transactions différées sont dues à quelques pages endommagées, une restauration de pages en ligne peut éventuellement résoudre les erreurs (là où elle est prise en charge).</span><span class="sxs-lookup"><span data-stu-id="4ff83-149">Under the full or bulk-logged recovery model, if the deferred transactions were caused by only a few corrupted pages, an online page restore might resolve the errors (where supported).</span></span>  
  
-   <span data-ttu-id="4ff83-150">Si vous n'avez plus besoin d'un groupe de fichiers dont l'état hors connexion entraîne des transactions différées, rendez-les obsolètes.</span><span class="sxs-lookup"><span data-stu-id="4ff83-150">If you are no longer require a filegroup whose offline status is causing deferred transactions, make the offline filegroup defunct.</span></span> <span data-ttu-id="4ff83-151">Les transactions qui étaient différées en raison du groupe de fichiers hors connexion quittent l'état différé une fois que le groupe de fichiers est obsolète.</span><span class="sxs-lookup"><span data-stu-id="4ff83-151">Transactions that were deferred because the filegroup was offline are moved out of the deferred state after the filegroup becomes defunct.</span></span>  
  
    > [!IMPORTANT]  
    >  <span data-ttu-id="4ff83-152">Un groupe de fichiers obsolète ne peut jamais être récupéré.</span><span class="sxs-lookup"><span data-stu-id="4ff83-152">A defunct filegroup can never be recovered.</span></span>  
  
     <span data-ttu-id="4ff83-153">Pour plus d’informations, consultez [Supprimer des groupes de fichiers obsolètes &#40;SQL Server&#41;](remove-defunct-filegroups-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="4ff83-153">For more information, see [Remove Defunct Filegroups &#40;SQL Server&#41;](remove-defunct-filegroups-sql-server.md).</span></span>  
  
-   <span data-ttu-id="4ff83-154">Si les transactions ont été différées en raison d'une page erronée et s'il n'existe pas de bonne sauvegarde de la base de données, procédez comme suit pour réparer la base de données :</span><span class="sxs-lookup"><span data-stu-id="4ff83-154">If transactions were deferred because of a bad page and if a good backup of the database does not exist, use the following process to repair the database:</span></span>  
  
    -   <span data-ttu-id="4ff83-155">Commencez par mettre la base de données en mode urgence en exécutant l'instruction [!INCLUDE[tsql](../../includes/tsql-md.md)] suivante :</span><span class="sxs-lookup"><span data-stu-id="4ff83-155">First put the database into emergency mode by executing the following [!INCLUDE[tsql](../../includes/tsql-md.md)] statement:</span></span>  
  
        ```  
        ALTER DATABASE <database_name> SET EMERGENCY  
        ```  
  
         <span data-ttu-id="4ff83-156">Pour plus d’informations sur le mode urgence, consultez [États d’une base de données](../databases/database-states.md).</span><span class="sxs-lookup"><span data-stu-id="4ff83-156">For information about emergency mode, see [Database States](../databases/database-states.md).</span></span>  
  
    -   <span data-ttu-id="4ff83-157">Ensuite, réparez la base de données à l’aide de l’option DBCC REPAIR_ALLOW_DATA_LOSS dans l’une des instructions DBCC suivantes : [DBCC CHECKDB](/sql/t-sql/database-console-commands/dbcc-checkdb-transact-sql), [DBCC CHECKALLOC](/sql/t-sql/database-console-commands/dbcc-checkalloc-transact-sql) ou [DBCC CHECKTABLE](/sql/t-sql/database-console-commands/dbcc-checktable-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="4ff83-157">Then, repair the database by using the DBCC REPAIR_ALLOW_DATA_LOSS option in one of the following DBCC statements: [DBCC CHECKDB](/sql/t-sql/database-console-commands/dbcc-checkdb-transact-sql), [DBCC CHECKALLOC](/sql/t-sql/database-console-commands/dbcc-checkalloc-transact-sql), or [DBCC CHECKTABLE](/sql/t-sql/database-console-commands/dbcc-checktable-transact-sql).</span></span>  
  
         <span data-ttu-id="4ff83-158">Lorsque la commande DBCC rencontre la page erronée, elle la désalloue et répare les éventuelles erreurs associées.</span><span class="sxs-lookup"><span data-stu-id="4ff83-158">When DBCC encounters the bad page, DBCC deallocates it and repairs any related errors.</span></span> <span data-ttu-id="4ff83-159">Cette approche permet de remettre en ligne la base de données dans un état physique cohérent.</span><span class="sxs-lookup"><span data-stu-id="4ff83-159">This approach enables the database to be brought back online in a physically consistent state.</span></span> <span data-ttu-id="4ff83-160">Il se peut néanmoins que d'autres données soient perdues ; c'est pourquoi cette approche ne doit être adoptée qu'en dernier recours.</span><span class="sxs-lookup"><span data-stu-id="4ff83-160">However, additional data might also be lost; therefore, this approach should be used as a last resort.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="4ff83-161"> Voir aussi</span><span class="sxs-lookup"><span data-stu-id="4ff83-161">See Also</span></span>  
 <span data-ttu-id="4ff83-162">[Vue d’ensemble de la restauration et de la récupération &#40;SQL Server&#41;](restore-and-recovery-overview-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="4ff83-162">[Restore and Recovery Overview &#40;SQL Server&#41;](restore-and-recovery-overview-sql-server.md) </span></span>  
 <span data-ttu-id="4ff83-163">[Supprimer des groupes de fichiers obsolètes &#40;SQL Server&#41;](remove-defunct-filegroups-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="4ff83-163">[Remove Defunct Filegroups &#40;SQL Server&#41;](remove-defunct-filegroups-sql-server.md) </span></span>  
 <span data-ttu-id="4ff83-164">[Restaurations de fichiers &#40;mode de récupération complète&#41;](file-restores-full-recovery-model.md) </span><span class="sxs-lookup"><span data-stu-id="4ff83-164">[File Restores &#40;Full Recovery Model&#41;](file-restores-full-recovery-model.md) </span></span>  
 <span data-ttu-id="4ff83-165">[Restaurations de fichiers &#40;mode de récupération simple&#41;](file-restores-simple-recovery-model.md) </span><span class="sxs-lookup"><span data-stu-id="4ff83-165">[File Restores &#40;Simple Recovery Model&#41;](file-restores-simple-recovery-model.md) </span></span>  
 <span data-ttu-id="4ff83-166">[Restaurer des pages &#40;SQL Server&#41;](restore-pages-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="4ff83-166">[Restore Pages &#40;SQL Server&#41;](restore-pages-sql-server.md) </span></span>  
 <span data-ttu-id="4ff83-167">[Restaurations fragmentaires &#40;SQL Server&#41;](piecemeal-restores-sql-server.md) </span><span class="sxs-lookup"><span data-stu-id="4ff83-167">[Piecemeal Restores &#40;SQL Server&#41;](piecemeal-restores-sql-server.md) </span></span>  
 <span data-ttu-id="4ff83-168">[ALTER DATABASE &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="4ff83-168">[ALTER DATABASE &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql) </span></span>  
 [<span data-ttu-id="4ff83-169">RESTORE &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="4ff83-169">RESTORE &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/statements/restore-statements-transact-sql)  
  
  
