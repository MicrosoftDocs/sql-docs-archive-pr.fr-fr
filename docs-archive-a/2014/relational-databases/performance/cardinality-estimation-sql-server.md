---
title: Évaluation de la cardinalité (SQL Server) | Microsoft Docs
ms.custom: ''
ms.date: 11/24/2015
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: performance
ms.topic: conceptual
helpviewer_keywords:
- cardinality estimator
- CE (cardinality estimator)
- estimating cardinality
ms.assetid: baa8a304-5713-4cfe-a699-345e819ce6df
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: aa56127f649d71bfcc8825322f8bf729175d41df
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87614572"
---
# <a name="cardinality-estimation-sql-server"></a><span data-ttu-id="96d56-102">Évaluation de la cardinalité (SQL Server)</span><span class="sxs-lookup"><span data-stu-id="96d56-102">Cardinality Estimation (SQL Server)</span></span>
  <span data-ttu-id="96d56-103">La logique d'estimation de la cardinalité, appelée estimateur de cardinalité, est remodelée dans [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] afin d'améliorer la qualité des plans de requête, et par conséquent, améliorer les performances des requêtes.</span><span class="sxs-lookup"><span data-stu-id="96d56-103">The cardinality estimation logic, called the cardinality estimator, is re-designed in [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] to improve the quality of query plans, and therefore to improve query performance.</span></span> <span data-ttu-id="96d56-104">Le nouvel estimateur de cardinalité incorpore des hypothèses et des algorithmes qui fonctionnent sur les charges de travail OLTP et de stockage de données modernes.</span><span class="sxs-lookup"><span data-stu-id="96d56-104">The new cardinality estimator incorporates assumptions and algorithms that work well on modern OLTP and data warehousing workloads.</span></span> <span data-ttu-id="96d56-105">Il repose sur la recherche détaillée des estimations de cardinalité sur les charges de travail modernes et sur nos connaissances acquises au cours des 15 dernières années sur l'amélioration de l'estimateur de cardinalité SQL Server.</span><span class="sxs-lookup"><span data-stu-id="96d56-105">It is based on in-depth cardinality estimation research on modern workloads, and our learnings over the past 15 years of improving the SQL Server cardinality estimator.</span></span> <span data-ttu-id="96d56-106">Les commentaires des clients indiquent que bien que la plupart des requêtes tirent parti des modifications ou demeurent inchangées, un petit nombre d'entre elles présente des régressions par rapport à l'estimateur de cardinalité précédent.</span><span class="sxs-lookup"><span data-stu-id="96d56-106">Feedback from customers shows that while most queries will benefit from the change or remain unchanged, a small number might show regressions compared to the previous cardinality estimator.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="96d56-107">Les estimations de cardinalité sont une prédiction du nombre de lignes dans le résultat de la requête.</span><span class="sxs-lookup"><span data-stu-id="96d56-107">Cardinality estimates are a prediction of the number of rows in the query result.</span></span> <span data-ttu-id="96d56-108">L'optimiseur de requête utilise ces estimations pour choisir un plan d'exécution de la requête.</span><span class="sxs-lookup"><span data-stu-id="96d56-108">The query optimizer uses these estimates to choose a plan for executing the query.</span></span> <span data-ttu-id="96d56-109">La qualité du plan de requête a un impact direct sur l'amélioration des performances des requêtes.</span><span class="sxs-lookup"><span data-stu-id="96d56-109">The quality of the query plan has a direct impact on improving query performance.</span></span>  
  
## <a name="performance-testing-and-tuning-recommendations"></a><span data-ttu-id="96d56-110">Recommandations pour le test des performances et le paramétrage</span><span class="sxs-lookup"><span data-stu-id="96d56-110">Performance Testing and Tuning Recommendations</span></span>  
 <span data-ttu-id="96d56-111">Le nouvel estimateur de cardinalité est activé pour toutes les nouvelles bases de données créées dans [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)].</span><span class="sxs-lookup"><span data-stu-id="96d56-111">The new cardinality estimator is enabled for all new databases created in [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)].</span></span> <span data-ttu-id="96d56-112">Cependant, la mise à niveau vers [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] n'active pas le nouvel estimateur de cardinalité dans les bases de données existantes.</span><span class="sxs-lookup"><span data-stu-id="96d56-112">However, upgrading to [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] does not enable the new cardinality estimator on existing databases.</span></span>  
  
 <span data-ttu-id="96d56-113">Pour obtenir les meilleures performances des requêtes, utilisez ces recommandations pour tester votre charge de travail avec le nouvel estimateur de cardinalité avant de l'activer sur votre système de production.</span><span class="sxs-lookup"><span data-stu-id="96d56-113">To ensure the best query performance, use these recommendations to test your workload with the new cardinality estimator before enabling it on your production system.</span></span>  
  
1.  <span data-ttu-id="96d56-114">Mettez à niveau toutes les bases de données existantes pour utiliser le nouvel estimateur de la cardinalité.</span><span class="sxs-lookup"><span data-stu-id="96d56-114">Upgrade all existing databases to use the new cardinality estimator.</span></span> <span data-ttu-id="96d56-115">Pour ce faire, utilisez le [niveau de compatibilité ALTER database &#40;&#41;Transact-SQL](/sql/t-sql/statements/alter-database-transact-sql-compatibility-level) pour définir le niveau de compatibilité de la base de données sur 120.</span><span class="sxs-lookup"><span data-stu-id="96d56-115">To do this, use [ALTER DATABASE Compatibility Level &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql-compatibility-level) to set the database compatibility level to 120.</span></span>  
  
2.  <span data-ttu-id="96d56-116">Exécutez votre test de charge de travail avec le nouvel estimateur de cardinalité, puis résolvez les nouveaux problèmes de performances de la même façon que les problèmes de performances.</span><span class="sxs-lookup"><span data-stu-id="96d56-116">Run your test workload with the new cardinality estimator, and then troubleshoot any new performance issues in the same manner you currently troubleshoot performance issues.</span></span>  
  
3.  <span data-ttu-id="96d56-117">Une fois que votre charge de travail s’exécute avec le nouvel estimateur de cardinalité (niveau de compatibilité de la base de données 120, SQL Server 2014) et qu’une requête spécifique a régressé, exécutez la requête avec l’indicateur de trace 9481 pour utiliser la version de l’estimateur de cardinalité fournie dans [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] et les versions ultérieures.</span><span class="sxs-lookup"><span data-stu-id="96d56-117">Once your workload is running with the new cardinality estimator (database compatibility level 120 (SQL Server 2014)), and a specific query has regressed, you can run the query with trace flag 9481 to use the version of the cardinality estimator used in [!INCLUDE[ssSQL11](../../includes/sssql11-md.md)] and earlier.</span></span> <span data-ttu-id="96d56-118">Pour exécuter une requête avec un indicateur de trace, consultez l'article de la Base de connaissances [Activer un plan affectant le comportement de l'optimiseur de requête SQL Server qui peut être contrôlé par des indicateurs de trace différents à un niveau spécifique à une requête](https://support.microsoft.com/kb/2801413).</span><span class="sxs-lookup"><span data-stu-id="96d56-118">To run a query with a trace flag, see the KB article [Enable plan-affecting SQL Server query optimizer behavior that can be controlled by different trace flags on a specific-query level](https://support.microsoft.com/kb/2801413).</span></span>  
  
4.  <span data-ttu-id="96d56-119">Si vous ne pouvez pas modifier toutes les bases de données à la fois pour utiliser le nouvel estimateur de cardinalité, vous pouvez utiliser l’estimateur de cardinalité précédent pour toutes les bases de données en utilisant le [niveau de compatibilité ALTER database &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql-compatibility-level) pour définir le niveau de compatibilité de la base de données sur 110.</span><span class="sxs-lookup"><span data-stu-id="96d56-119">If you cannot change all of the databases at once to use the new cardinality estimator, you can use the former cardinality estimator for all databases by using [ALTER DATABASE Compatibility Level &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql-compatibility-level) to set the database compatibility level to 110.</span></span>  
  
5.  <span data-ttu-id="96d56-120">Si votre charge de travail s’exécute avec le niveau de compatibilité de la base de données 110 et que vous voulez tester ou exécuter une requête spécifique avec le nouvel estimateur de cardinalité, exécutez la requête avec l’indicateur de trace 2312 pour utiliser la version SQL Server 2014 de l’estimateur de cardinalité.</span><span class="sxs-lookup"><span data-stu-id="96d56-120">If your workload is running with database compatibility level 110 and you want to test or run a specific query with the new cardinality estimator, you can run the query with trace flag 2312 to use the SQL Server 2014 version of the cardinality estimator.</span></span>  <span data-ttu-id="96d56-121">Pour exécuter une requête avec un indicateur de trace, consultez l'article de la Base de connaissances [Activer un plan affectant le comportement de l'optimiseur de requête SQL Server qui peut être contrôlé par des indicateurs de trace différents à un niveau spécifique à une requête](https://support.microsoft.com/kb/2801413).</span><span class="sxs-lookup"><span data-stu-id="96d56-121">To run a query with a trace flag, see the KB article [Enable plan-affecting SQL Server query optimizer behavior that can be controlled by different trace flags on a specific-query level](https://support.microsoft.com/kb/2801413).</span></span>  
  
## <a name="new-xevents"></a><span data-ttu-id="96d56-122">Nouveaux XEvents</span><span class="sxs-lookup"><span data-stu-id="96d56-122">New XEvents</span></span>  
 <span data-ttu-id="96d56-123">Il y a deux nouveaux XEvents query_optimizer_estimate_cardinality pour prendre en charge les nouveaux plans de requête.</span><span class="sxs-lookup"><span data-stu-id="96d56-123">There are two new query_optimizer_estimate_cardinality XEvents to support the new query plans.</span></span>  
  
-   <span data-ttu-id="96d56-124">*query_optimizer_estimate_cardinality* se produit lorsque l'optimiseur de requête estime la cardinalité sur une expression relationnelle.</span><span class="sxs-lookup"><span data-stu-id="96d56-124">*query_optimizer_estimate_cardinality* occurs when the query optimizer estimates the cardinality on a relational expression.</span></span>  
  
-   <span data-ttu-id="96d56-125">*query_optimizer_force_both_cardinality_estimation*_behaviors se produit lorsque les deux indicateurs de trace 2312 et 9481 sont activés, tentant de forcer l'ancien et le nouveau comportement d'estimation de cardinalité en même temps.</span><span class="sxs-lookup"><span data-stu-id="96d56-125">*query_optimizer_force_both_cardinality_estimation*_behaviors occurs when both traceflags 2312 and 9481 are enabled, attempting to force both old and new cardinality estimation behavior at the same time.</span></span>  
  
## <a name="examples"></a><span data-ttu-id="96d56-126">Exemples</span><span class="sxs-lookup"><span data-stu-id="96d56-126">Examples</span></span>  
 <span data-ttu-id="96d56-127">Les exemples suivants illustrent certaines des modifications apportées aux nouvelles estimations de cardinalité.</span><span class="sxs-lookup"><span data-stu-id="96d56-127">The following examples show some of the changes in the new cardinality estimates.</span></span> <span data-ttu-id="96d56-128">Le code d'estimation de la cardinalité a été réécrit.</span><span class="sxs-lookup"><span data-stu-id="96d56-128">The code for estimating cardinality has been rewritten.</span></span> <span data-ttu-id="96d56-129">La logique est complexe et il est impossible de fournir une liste exhaustive de toutes les modifications.</span><span class="sxs-lookup"><span data-stu-id="96d56-129">The logic is complex and it is not possible to provide an exhaustive list of all changes.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="96d56-130">Ces exemples sont fournis en tant qu'informations conceptuelles.</span><span class="sxs-lookup"><span data-stu-id="96d56-130">These examples are provided as conceptual information.</span></span> <span data-ttu-id="96d56-131">Aucune action n'est requise de votre part pour modifier la manière dont vous concevez les bases de données et les requêtes.</span><span class="sxs-lookup"><span data-stu-id="96d56-131">No action is required on your part to change the way you design databases and queries.</span></span>  
  
### <a name="example-a-new-cardinality-estimates-use-an-average-cardinality-for-recently-added-ascending-data"></a><span data-ttu-id="96d56-132">Exemple A. Les nouvelles estimations de cardinalité utilisent une cardinalité moyenne pour les données croissantes ajoutées récemment.</span><span class="sxs-lookup"><span data-stu-id="96d56-132">Example A. New cardinality estimates use an average cardinality for recently added ascending data</span></span>  
 <span data-ttu-id="96d56-133">Cet exemple montre comment le nouvel estimateur de cardinalité peut améliorer les estimations de cardinalité pour les données croissantes qui dépassent la valeur maximale dans la table pendant la mise à jour des statistiques la plus récente.</span><span class="sxs-lookup"><span data-stu-id="96d56-133">This example demonstrates how the new cardinality estimator can improve cardinality estimates for ascending data that exceeds the maximum value in the table during the most recent statistics update.</span></span>  
  
```  
SELECT item, category, amount FROM dbo.Sales AS s WHERE Date = '2013-12-19';  
```  
  
 <span data-ttu-id="96d56-134">Dans cet exemple, de nouvelles lignes sont ajoutées à la table Ventes chaque jour, la requête demande les données des ventes qui se sont produites le 19/12/2013, et la dernière mise à jour des statistiques a été effectuée le 18/12/2013.</span><span class="sxs-lookup"><span data-stu-id="96d56-134">In this example, new rows are added to the Sales table each day, the query asks for sales that occurred on 12/19/2013, and statistics were last updated on 12/18/2013.</span></span> <span data-ttu-id="96d56-135">L'estimateur de cardinalité précédent suppose que les valeurs du 19/12/2013 n'existent pas, car la date dépasse la date maximale et les statistiques n'ont pas été mises à jour pour inclure les valeurs du 19/12/2013.</span><span class="sxs-lookup"><span data-stu-id="96d56-135">The previous cardinality estimator assumes the 12/19/2013 values do not exist since the date exceeds the maximum date and statistics have not been updated to include the 12/19/2013 values.</span></span> <span data-ttu-id="96d56-136">Cette situation, appelée problème de clé croissante, se produit lorsque vous chargez des données au cours de la journée, puis exécutez des requêtes sur les données avant de mettre à jour les statistiques.</span><span class="sxs-lookup"><span data-stu-id="96d56-136">This situation, known as the ascending key problem, will occur if you load data during the day, and then run queries against the data before statistics are updated.</span></span>  
  
 <span data-ttu-id="96d56-137">Ce comportement a changé.</span><span class="sxs-lookup"><span data-stu-id="96d56-137">This behavior has changed.</span></span> <span data-ttu-id="96d56-138">Maintenant, même si les statistiques n'ont pas été mises à jour pour les données croissantes les plus récentes ajoutées depuis la dernière mise à jour des statistiques, le nouvel estimateur de cardinalité suppose que les valeurs existent et utilise la cardinalité moyenne de chaque valeur dans la colonne comme estimation de la cardinalité.</span><span class="sxs-lookup"><span data-stu-id="96d56-138">Now, even if statistics have not been updated for the most recent ascending data that is added since the last statistics update, the new cardinality estimator assumes the values exist and uses the average cardinality for each value in the column as the cardinality estimate.</span></span>  
  
### <a name="example-b-new-cardinality-estimates-assume-filtered-predicates-on-the-same-table-have-some-correlation"></a><span data-ttu-id="96d56-139">Exemple B. Les nouvelles estimations de cardinalité supposent que les prédicats filtrés sur la même table ont une certaine corrélation.</span><span class="sxs-lookup"><span data-stu-id="96d56-139">Example B. New cardinality estimates assume filtered predicates on the same table have some correlation</span></span>  
 <span data-ttu-id="96d56-140">Pour cet exemple, supposons que la table Cars contient 1 000 lignes, la colonne Make contient 200 correspondances pour « Honda », la colonne Model contient 50 correspondances pour « Civic » et que tous les modèles Civic sont de marque Honda.</span><span class="sxs-lookup"><span data-stu-id="96d56-140">For this example, assume the table Cars as 1000 rows, Make has 200 matches for 'Honda', Model has 50 matches for 'Civic', and that all of the Civics are Hondas.</span></span> <span data-ttu-id="96d56-141">Par conséquent, 20 % des valeurs de la colonne Make correspondent à « Honda », 5 % des valeurs de la colonne Model correspondent à « Civic » et le nombre réel de Civic honda est 50.</span><span class="sxs-lookup"><span data-stu-id="96d56-141">Therefore, 20% of the values in the Make column are 'Honda', 5% of the values in the Model column are 'Civic', and the actual number of Honda Civics is 50.</span></span> <span data-ttu-id="96d56-142">Les estimations de cardinalité précédentes supposent que les valeurs des colonnes Make et Model sont indépendantes.</span><span class="sxs-lookup"><span data-stu-id="96d56-142">The previous cardinality estimates assume the values in the Make and the Model columns are independent of each other.</span></span> <span data-ttu-id="96d56-143">L’optimiseur de requête précédent estime 10 Honda civiques (. 05 \*. 20 \* 1000 lignes = 10 lignes).</span><span class="sxs-lookup"><span data-stu-id="96d56-143">The previous query optimizer estimates there are 10 Honda Civics (.05 \* .20 \* 1000 rows = 10 rows).</span></span>  
  
```  
SELECT year, purchase_price FROM dbo.Cars WHERE Make = 'Honda' AND Model = 'Civic';  
```  
  
 <span data-ttu-id="96d56-144">Ce comportement a changé.</span><span class="sxs-lookup"><span data-stu-id="96d56-144">This behavior has changed.</span></span> <span data-ttu-id="96d56-145">Maintenant, les nouvelles estimations de cardinalité supposent que les colonnes Make et Model ont une *certaine* corrélation.</span><span class="sxs-lookup"><span data-stu-id="96d56-145">Now, the new cardinality estimates assume the Make and Model columns have *some* correlation.</span></span> <span data-ttu-id="96d56-146">L'optimiseur de requête estime une cardinalité plus élevée en ajoutant un composant exponentiel à l'équation d'estimation.</span><span class="sxs-lookup"><span data-stu-id="96d56-146">The query optimizer estimates a higher cardinality by adding an exponential component to the estimation equation.</span></span> <span data-ttu-id="96d56-147">L’optimiseur de requête estime désormais que 22,36 lignes (0,05 \* SQRT (. 20) \* 1000 lignes = 22,36 lignes) correspondent au prédicat.</span><span class="sxs-lookup"><span data-stu-id="96d56-147">The query optimizer now estimates that 22.36 rows ( .05 \* SQRT(.20) \* 1000 rows = 22.36 rows ) match the predicate.</span></span> <span data-ttu-id="96d56-148">Pour ce scénario et cette distribution de données spécifique, 22,36 lignes est le résultat le proche des 50 lignes réelles qui sera retourné par la requête.</span><span class="sxs-lookup"><span data-stu-id="96d56-148">For this scenario and specific data distribution, 22.36 rows is closer to the actual 50 rows that the query will return.</span></span>  
  
 <span data-ttu-id="96d56-149">Notez que la logique du nouvel estimateur de cardinalité trie les sélectivités de prédicat et augmente l'exposant.</span><span class="sxs-lookup"><span data-stu-id="96d56-149">Note, the new cardinality estimator logic sorts the predicate selectivities and increases the exponent.</span></span> <span data-ttu-id="96d56-150">Par exemple, si les sélectivités de prédicat étaient 0,05,. 20 et 0,25, l’estimation de cardinalité est (. 05 \* SQRT (. 20) \* sqrt (sqrt (. 25))).</span><span class="sxs-lookup"><span data-stu-id="96d56-150">For example, if the predicate selectivities were .05, .20, and .25, the cardinality estimate would be (.05 \* SQRT(.20) \* SQRT(SQRT(.25)) ).</span></span>  
  
### <a name="example-c-new-cardinality-estimates-assume-filtered-predicates-on-different-tables-are-independent"></a><span data-ttu-id="96d56-151">Exemple C. Les nouvelles estimations de cardinalité supposent que les prédicats filtrés sur les tables sont indépendants.</span><span class="sxs-lookup"><span data-stu-id="96d56-151">Example C. New cardinality estimates assume filtered predicates on different tables are independent</span></span>  
 <span data-ttu-id="96d56-152">Pour cet exemple, l'estimateur de cardinalité précédent suppose que les filtres de prédicat s.type et r.date sont corrélés.</span><span class="sxs-lookup"><span data-stu-id="96d56-152">For this example, the previous cardinality estimator assumes that the predicate filters s.type and r.date are correlated.</span></span> <span data-ttu-id="96d56-153">Toutefois, les résultats du test sur les charges de travail modernes indiquent que les filtres de prédicat sur les colonnes de différentes tables ne sont généralement pas corrélés.</span><span class="sxs-lookup"><span data-stu-id="96d56-153">However, test results on modern workloads showed that predicate filters on columns in different tables are usually not correlated with each other.</span></span>  
  
```  
SELECT s.ticket, s.customer, r.store FROM dbo.Sales AS s CROSS JOIN dbo.Returns AS r  
WHERE s.ticket = r.ticket AND s.type = 'toy' AND r.date = '2013-12-19';  
```  
  
 <span data-ttu-id="96d56-154">Ce comportement a changé.</span><span class="sxs-lookup"><span data-stu-id="96d56-154">This behavior has changed.</span></span> <span data-ttu-id="96d56-155">Maintenant, la logique du nouvel estimateur de cardinalité suppose que s.type n'est pas mis en corrélation avec r.date.</span><span class="sxs-lookup"><span data-stu-id="96d56-155">Now, the new cardinality estimator logic assumes that s.type is not correlated with r.date.</span></span> <span data-ttu-id="96d56-156">En pratique, l'hypothèse est que les jouets sont retournés tous les jours et non un seul jour spécifique.</span><span class="sxs-lookup"><span data-stu-id="96d56-156">In practical terms, the assumption is that toys are returned every day and not only on a specific day.</span></span> <span data-ttu-id="96d56-157">Dans ce cas, les nouvelles estimations de cardinalité sont un nombre inférieur aux estimations de cardinalité précédentes.</span><span class="sxs-lookup"><span data-stu-id="96d56-157">In this case, the new cardinality estimates will be a smaller number than the previous cardinality estimates.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="96d56-158">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="96d56-158">See Also</span></span>  
 [<span data-ttu-id="96d56-159">Surveillance et réglage des performances</span><span class="sxs-lookup"><span data-stu-id="96d56-159">Monitor and Tune for Performance</span></span>](monitor-and-tune-for-performance.md)  
  
  
