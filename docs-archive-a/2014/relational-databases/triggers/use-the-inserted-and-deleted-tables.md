---
title: Utiliser les tables inserted et deleted | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
helpviewer_keywords:
- inserted tables
- UPDATE statement [SQL Server], DML triggers
- DELETE statement [SQL Server], DML triggers
- INSTEAD OF triggers
- deleted tables
- INSERT statement [SQL Server], DML triggers
- DML triggers, deleted or inserted tables
ms.assetid: ed84567f-7b91-4b44-b5b2-c400bda4590d
author: rothja
ms.author: jroth
ms.openlocfilehash: facc534177113bd93e56e50fca3ae14c3e6b2cfc
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87613867"
---
# <a name="use-the-inserted-and-deleted-tables"></a><span data-ttu-id="695cd-102">Utiliser les tables inserted et deleted</span><span class="sxs-lookup"><span data-stu-id="695cd-102">Use the inserted and deleted Tables</span></span>
  <span data-ttu-id="695cd-103">Les instructions de déclenchement DML utilisent deux tables spéciales : la table deleted et la table inserted.</span><span class="sxs-lookup"><span data-stu-id="695cd-103">DML trigger statements use two special tables: the deleted table and the inserted tables.</span></span> [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="695cd-104">crée et gère automatiquement ces tables.</span><span class="sxs-lookup"><span data-stu-id="695cd-104">automatically creates and manages these tables.</span></span> <span data-ttu-id="695cd-105">Ces tables temporaires résidant en mémoire servent à tester les effets de certaines modifications de données et à définir des conditions pour les actions de déclencheur DML.</span><span class="sxs-lookup"><span data-stu-id="695cd-105">You can use these temporary, memory-resident tables to test the effects of certain data modifications and to set conditions for DML trigger actions.</span></span> <span data-ttu-id="695cd-106">Vous ne pouvez pas modifier directement les données contenues dans les tables ou effectuer des opérations DDL (Data Definition Language) sur les tables, telles que CREATE INDEX.</span><span class="sxs-lookup"><span data-stu-id="695cd-106">You cannot directly modify the data in the tables or perform data definition language (DDL) operations on the tables, such as CREATE INDEX.</span></span>  
  
 <span data-ttu-id="695cd-107">Dans les déclencheurs DML, les tables inserted et deleted sont principalement utilisées pour exécuter les opérations suivantes :</span><span class="sxs-lookup"><span data-stu-id="695cd-107">In DML triggers, the inserted and deleted tables are primarily used to perform the following:</span></span>  
  
-   <span data-ttu-id="695cd-108">étendre l'intégrité référentielle entre les tables ;</span><span class="sxs-lookup"><span data-stu-id="695cd-108">Extend referential integrity between tables.</span></span>  
  
-   <span data-ttu-id="695cd-109">insérer ou mettre à jour des données dans des tables de base sous-jacentes d'une vue ;</span><span class="sxs-lookup"><span data-stu-id="695cd-109">Insert or update data in base tables underlying a view.</span></span>  
  
-   <span data-ttu-id="695cd-110">déceler la présence d'erreurs et prendre les mesures nécessaires ;</span><span class="sxs-lookup"><span data-stu-id="695cd-110">Test for errors and take action based on the error.</span></span>  
  
-   <span data-ttu-id="695cd-111">détecter la différence entre l'état d'une table avant et après une modification des données, et prendre les mesures nécessaires en fonction de cette différence.</span><span class="sxs-lookup"><span data-stu-id="695cd-111">Find the difference between the state of a table before and after a data modification and take actions based on that difference.</span></span>  
  
 <span data-ttu-id="695cd-112">La table deleted stocke des copies des lignes affectées par les instructions DELETE et UPDATE.</span><span class="sxs-lookup"><span data-stu-id="695cd-112">The deleted table stores copies of the affected rows during DELETE and UPDATE statements.</span></span> <span data-ttu-id="695cd-113">Pendant l'exécution d'une instruction DELETE ou UPDATE, certaines lignes sont supprimées de la table du déclencheur et déplacées vers la table deleted.</span><span class="sxs-lookup"><span data-stu-id="695cd-113">During the execution of a DELETE or UPDATE statement, rows are deleted from the trigger table and transferred to the deleted table.</span></span> <span data-ttu-id="695cd-114">La table deleted et la table du déclencheur n'ont habituellement pas de ligne en commun.</span><span class="sxs-lookup"><span data-stu-id="695cd-114">The deleted table and the trigger table ordinarily have no rows in common.</span></span>  
  
 <span data-ttu-id="695cd-115">La table inserted stocke des copies des lignes affectées par les instructions INSERT et UPDATE.</span><span class="sxs-lookup"><span data-stu-id="695cd-115">The inserted table stores copies of the affected rows during INSERT and UPDATE statements.</span></span> <span data-ttu-id="695cd-116">Pendant une transaction d'insertion ou de mise à jour, de nouvelles lignes sont ajoutées dans la table inserted et dans la table du déclencheur.</span><span class="sxs-lookup"><span data-stu-id="695cd-116">During an insert or update transaction, new rows are added to both the inserted table and the trigger table.</span></span> <span data-ttu-id="695cd-117">Les lignes de la table inserted sont des copies des lignes créées dans la table du déclencheur.</span><span class="sxs-lookup"><span data-stu-id="695cd-117">The rows in the inserted table are copies of the new rows in the trigger table.</span></span>  
  
 <span data-ttu-id="695cd-118">D'un point de vue théorique, une transaction de mise à jour est une opération de suppression suivie d'une opération d'insertion ; les anciennes lignes sont d'abord copiées dans la table deleted, et les nouvelles lignes sont ensuite copiées dans la table du déclencheur et dans la table inserted.</span><span class="sxs-lookup"><span data-stu-id="695cd-118">An update transaction is similar to a delete operation followed by an insert operation; the old rows are copied to the deleted table first, and then the new rows are copied to the trigger table and to the inserted table.</span></span>  
  
 <span data-ttu-id="695cd-119">Pour définir les conditions du déclencheur, utilisez les tables inserted et deleted de façon appropriée, en fonction de l'action qui a activé le déclencheur.</span><span class="sxs-lookup"><span data-stu-id="695cd-119">When you set trigger conditions, use the inserted and deleted tables appropriately for the action that fired the trigger.</span></span> <span data-ttu-id="695cd-120">Bien que vous puissiez, sans provoquer d'erreur, référencer la table deleted pendant le test d'une insertion (INSERT) ou la table inserted pendant le test d'une suppression (DELETE), ces tables de test du déclencheur ne contiendront alors aucune ligne.</span><span class="sxs-lookup"><span data-stu-id="695cd-120">Although referencing the deleted table when testing an INSERT or the inserted table when testing a DELETE does not cause any errors, these trigger test tables do not contain any rows in these cases.</span></span>  
  
> [!NOTE]  
>  <span data-ttu-id="695cd-121">Si les actions du déclencheur dépendent du nombre de lignes affectées par une modification de données, utilisez les tests (comme l’examen de @@ROWCOUNT) pour les modifications de données multilignes (une instruction INSERT, DELETE ou UPDATE basée sur une instruction SELECT), puis effectuez les opérations appropriées.</span><span class="sxs-lookup"><span data-stu-id="695cd-121">If trigger actions depend on the number of rows a data modification effects, use tests (such as an examination of @@ROWCOUNT) for multirow data modifications (an INSERT, DELETE, or UPDATE based on a SELECT statement), and take appropriate actions.</span></span>  
  
 [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)] <span data-ttu-id="695cd-122">n'autorise pas les références aux colonnes de type `text`, `ntext` ou `image` dans les tables inserted et deleted pour les déclencheurs AFTER.</span><span class="sxs-lookup"><span data-stu-id="695cd-122">does not allow for `text`, `ntext`, or `image` column references in the inserted and deleted tables for AFTER triggers.</span></span> <span data-ttu-id="695cd-123">Cependant, ces types de données sont inclus à des fins de compatibilité ascendante uniquement.</span><span class="sxs-lookup"><span data-stu-id="695cd-123">However, these data types are included for backward compatibility purposes only.</span></span> <span data-ttu-id="695cd-124">La méthode de stockage conseillée des données de grandes dimensions consiste à utiliser les types de données `varchar(max)`, `nvarchar(max)` et `varbinary(max)`.</span><span class="sxs-lookup"><span data-stu-id="695cd-124">The preferred storage for large data is to use the `varchar(max)`, `nvarchar(max)`, and `varbinary(max)` data types.</span></span> <span data-ttu-id="695cd-125">Les déclencheurs AFTER et INSTEAD OF prennent en charge les données `varchar(max)`, `nvarchar(max)` et `varbinary(max)` dans les tables inserted et deleted.</span><span class="sxs-lookup"><span data-stu-id="695cd-125">Both AFTER and INSTEAD OF triggers support `varchar(max)`, `nvarchar(max)`, and `varbinary(max)` data in the inserted and deleted tables.</span></span> <span data-ttu-id="695cd-126">Pour plus d’informations, consultez [CREATE TRIGGER &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-trigger-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="695cd-126">For more information, see [CREATE TRIGGER &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-trigger-transact-sql).</span></span>  
  
 <span data-ttu-id="695cd-127">**Exemple de l'utilisation de la table insérée dans un déclencheur pour imposer des règles d'entreprise**</span><span class="sxs-lookup"><span data-stu-id="695cd-127">**An Example of Using the inserted Table in a Trigger to Enforce Business Rules**</span></span>  
  
 <span data-ttu-id="695cd-128">Les contraintes CHECK pouvant référencer uniquement les colonnes sur lesquelles des contraintes de niveau table ou colonne sont définies, toutes les contraintes entre tables (dans ce cas, des règles de gestion) doivent être définies sous la forme de déclencheurs.</span><span class="sxs-lookup"><span data-stu-id="695cd-128">Because CHECK constraints can reference only the columns on which the column-level or table-level constraint is defined, any cross-table constraints (in this case, business rules) must be defined as triggers.</span></span>  
  
 <span data-ttu-id="695cd-129">L'exemple suivant crée un déclencheur DML.</span><span class="sxs-lookup"><span data-stu-id="695cd-129">The following example creates a DML trigger.</span></span> <span data-ttu-id="695cd-130">Ce déclencheur vérifie que les informations de conditions de crédit du fournisseur sont correctes lors d'une tentative d'insertion d'un nouveau bon de commande dans la table `PurchaseOrderHeader` .</span><span class="sxs-lookup"><span data-stu-id="695cd-130">This trigger checks to make sure the credit rating for the vendor is good when an attempt is made to insert a new purchase order into the `PurchaseOrderHeader` table.</span></span> <span data-ttu-id="695cd-131">Pour obtenir les informations de conditions de crédit du fournisseur correspondant à la commande qui vient d'être insérée, la table `Vendor` doit être référencée et jointe à la table inserted.</span><span class="sxs-lookup"><span data-stu-id="695cd-131">To obtain the credit rating of the vendor corresponding to the purchase order that was just inserted, the `Vendor` table must be referenced and joined with the inserted table.</span></span> <span data-ttu-id="695cd-132">Si les conditions de crédit sont trop faibles, un message s'affiche et l'insertion n'a pas lieu.</span><span class="sxs-lookup"><span data-stu-id="695cd-132">If the credit rating is too low, a message is displayed and the insertion does not execute.</span></span> <span data-ttu-id="695cd-133">Notez que cet exemple n'autorise pas les modifications de données de plusieurs lignes.</span><span class="sxs-lookup"><span data-stu-id="695cd-133">Note that this example does not allow for multirow data modifications.</span></span> <span data-ttu-id="695cd-134">Pour plus d’informations, consultez [Créer de déclencheurs DML pour gérer plusieurs lignes de données](../triggers/create-dml-triggers-to-handle-multiple-rows-of-data.md).</span><span class="sxs-lookup"><span data-stu-id="695cd-134">For more information, see [Create DML Triggers to Handle Multiple Rows of Data](../triggers/create-dml-triggers-to-handle-multiple-rows-of-data.md).</span></span>  
  
 [!code-sql[TriggerDDL#CreateTrigger3](../../snippets/tsql/SQL14/tsql/triggerddl/transact-sql/snippet_create_alter_drop_trigger.sql#createtrigger3)]  
  
## <a name="using-the-inserted-and-deleted-tables-in-instead-of-triggers"></a><span data-ttu-id="695cd-135">Utilisation des tables inserted et deleted dans les déclencheurs INSTEAD OF</span><span class="sxs-lookup"><span data-stu-id="695cd-135">Using the inserted and deleted Tables in INSTEAD OF Triggers</span></span>  
 <span data-ttu-id="695cd-136">Les tables inserted et deleted passées aux déclencheurs INSTEAD OF définis sur des tables suivent les mêmes règles que les tables inserted et deleted passées aux déclencheurs AFTER.</span><span class="sxs-lookup"><span data-stu-id="695cd-136">The inserted and deleted tables passed to INSTEAD OF triggers defined on tables follow the same rules as the inserted and deleted tables passed to AFTER triggers.</span></span> <span data-ttu-id="695cd-137">Le format des tables inserted et deleted est le même que celui de la table sur laquelle est défini le déclencheur INSTEAD OF.</span><span class="sxs-lookup"><span data-stu-id="695cd-137">The format of the inserted and deleted tables is the same as the format of the table on which the INSTEAD OF trigger is defined.</span></span> <span data-ttu-id="695cd-138">Chaque colonne des tables inserted et deleted est directement mappée à une colonne de la table de base.</span><span class="sxs-lookup"><span data-stu-id="695cd-138">Each column in the inserted and deleted tables maps directly to a column in the base table.</span></span>  
  
 <span data-ttu-id="695cd-139">Qu'une table possède ou non un déclencheur INSTEAD OF, les règles suivantes qui régissent la fourniture de valeurs pour les colonnes par une instruction INSERT ou UPDATE faisant référence à la table sont les mêmes :</span><span class="sxs-lookup"><span data-stu-id="695cd-139">The following rules regarding when an INSERT or UPDATE statement referencing a table with an INSTEAD OF trigger must supply values for columns are the same as if the table did not have an INSTEAD OF trigger:</span></span>  
  
-   <span data-ttu-id="695cd-140">Aucune valeur ne peut être spécifiée pour une colonne calculée ou de type de données `timestamp`.</span><span class="sxs-lookup"><span data-stu-id="695cd-140">Values cannot be specified for computed columns or columns with a `timestamp` data type.</span></span>  
  
-   <span data-ttu-id="695cd-141">Aucune valeur ne peut être spécifiée pour les colonnes possédant une propriété IDENTITY, à moins que IDENTITY_INSERT ait la valeur ON pour cette table,</span><span class="sxs-lookup"><span data-stu-id="695cd-141">Values cannot be specified for columns with an IDENTITY property, unless IDENTITY_INSERT is ON for that table.</span></span> <span data-ttu-id="695cd-142">auquel cas les instructions INSERT doivent fournir une valeur.</span><span class="sxs-lookup"><span data-stu-id="695cd-142">When IDENTITY_INSERT is ON, INSERT statements must supply a value.</span></span>  
  
-   <span data-ttu-id="695cd-143">Les instructions INSERT doivent fournir des valeurs pour toutes les colonnes NOT NULL pour lesquelles aucune contrainte DEFAULT n'est définie.</span><span class="sxs-lookup"><span data-stu-id="695cd-143">INSERT statements must supply values for all NOT NULL columns that do not have DEFAULT constraints.</span></span>  
  
-   <span data-ttu-id="695cd-144">Les valeurs sont facultatives pour toute colonne acceptant des valeurs NULL ou toute colonne NOT NULL avec valeur par défaut (DEFAULT), sous réserve qu'il ne s'agisse pas d'une colonne calculée, identité ou `timestamp`.</span><span class="sxs-lookup"><span data-stu-id="695cd-144">For any columns except computed, identity, or `timestamp` columns, values are optional for any column that allows nulls, or any NOT NULL column that has a DEFAULT definition.</span></span>  
  
 <span data-ttu-id="695cd-145">Lorsqu'une instruction INSERT, UPDATE ou DELETE fait référence à une vue possédant un déclencheur INSTEAD OF, le [!INCLUDE[ssDE](../../includes/ssde-md.md)] appelle le déclencheur au lieu d'effectuer une opération directe sur une table.</span><span class="sxs-lookup"><span data-stu-id="695cd-145">When an INSERT, UPDATE, or DELETE statement references a view that has an INSTEAD OF trigger, the [!INCLUDE[ssDE](../../includes/ssde-md.md)] calls the trigger instead of taking any direct action against any table.</span></span> <span data-ttu-id="695cd-146">Le déclencheur doit utiliser les informations présentées dans les tables inserted et deleted pour élaborer toute instruction nécessaire à l'implémentation de l'action requise dans les tables de base, même si le format des informations contenues dans les tables inserted et deleted conçues pour la vue diffère de celui des données stockées dans les tables de base.</span><span class="sxs-lookup"><span data-stu-id="695cd-146">The trigger must use the information presented in the inserted and deleted tables to build any statements required to implement the requested action in the base tables, even when the format of the information in the inserted and deleted tables built for the view is different from the format of the data in the base tables.</span></span>  
  
 <span data-ttu-id="695cd-147">Le format des tables inserted et deleted passées à un déclencheur INSTEAD OF défini sur une vue correspond à la liste de sélection de l'instruction SELECT définie pour la vue.</span><span class="sxs-lookup"><span data-stu-id="695cd-147">The format of the inserted and deleted tables passed to an INSTEAD OF trigger defined on a view matches the select list of the SELECT statement defined for the view.</span></span> <span data-ttu-id="695cd-148">Par exemple :</span><span class="sxs-lookup"><span data-stu-id="695cd-148">For example:</span></span>  
  
```  
USE AdventureWorks2012;  
GO  
CREATE VIEW dbo.EmployeeNames (BusinessEntityID, LName, FName)  
AS  
SELECT e.BusinessEntityID, p.LastName, p.FirstName  
FROM HumanResources.Employee AS e   
JOIN Person.Person AS p  
ON e.BusinessEntityID = p.BusinessEntityID;  
```  
  
 <span data-ttu-id="695cd-149">Le jeu de résultats pour cette vue possède trois colonnes : une colonne `int` et deux colonnes `nvarchar`.</span><span class="sxs-lookup"><span data-stu-id="695cd-149">The result set for this view has three columns: an `int` column and two `nvarchar` columns.</span></span> <span data-ttu-id="695cd-150">Les tables inserted et deleted passées à un déclencheur INSTEAD OF défini sur la vue possèdent également une colonne `int` nommée `BusinessEntityID`, une colonne `nvarchar` nommée `LName` et une colonne `nvarchar` nommée `FName`.</span><span class="sxs-lookup"><span data-stu-id="695cd-150">The inserted and deleted tables passed to an INSTEAD OF trigger defined on the view also have an `int` column named `BusinessEntityID`, an `nvarchar` column named `LName`, and an `nvarchar` column named `FName`.</span></span>  
  
 <span data-ttu-id="695cd-151">La liste de sélection d'une vue peut également contenir des expressions qui n'établissent pas de mappage direct à une colonne de table de base unique.</span><span class="sxs-lookup"><span data-stu-id="695cd-151">The select list of a view can also contain expressions that do not directly map to a single base-table column.</span></span> <span data-ttu-id="695cd-152">Certaines expressions de vue, telles que l'invocation d'une constante ou d'une fonction, peuvent ne pas référencer de colonne et être ignorées.</span><span class="sxs-lookup"><span data-stu-id="695cd-152">Some view expressions, such as a constant or function invocation, may not reference any columns and can be ignored.</span></span> <span data-ttu-id="695cd-153">Les expressions complexes peuvent référencer plusieurs colonnes, mais les tables inserted et deleted ne détiennent qu'une seule valeur pour chaque ligne insérée.</span><span class="sxs-lookup"><span data-stu-id="695cd-153">Complex expressions can reference multiple columns, yet the inserted and deleted tables have only one value for each inserted row.</span></span> <span data-ttu-id="695cd-154">Les mêmes considérations s'appliquent aux expressions simples d'une vue si elles font référence à une colonne calculée à laquelle est associée une expression complexe.</span><span class="sxs-lookup"><span data-stu-id="695cd-154">The same issues apply to simple expressions in a view if they reference a computed column that has a complex expression.</span></span> <span data-ttu-id="695cd-155">Un déclencheur INSTEAD OF défini sur la vue doit gérer ces types d'expressions.</span><span class="sxs-lookup"><span data-stu-id="695cd-155">An INSTEAD OF trigger on the view must handle these types of expressions.</span></span>  
  
  
