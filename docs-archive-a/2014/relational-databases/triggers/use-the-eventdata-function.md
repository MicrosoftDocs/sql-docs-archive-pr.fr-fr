---
title: Utiliser la fonction EVENTDATA | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
helpviewer_keywords:
- EVENTDATA function
- DDL triggers, EVENTDATA function
ms.assetid: 675b8320-9c73-4526-bd2f-91ba42c1b604
author: rothja
ms.author: jroth
ms.openlocfilehash: 57fb59a3954fb00ab943944c58cccd352c7270d2
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87613870"
---
# <a name="use-the-eventdata-function"></a><span data-ttu-id="55ac0-102">Utiliser la fonction EVENTDATA</span><span class="sxs-lookup"><span data-stu-id="55ac0-102">Use the EVENTDATA Function</span></span>
  <span data-ttu-id="55ac0-103">Les informations sur un événement qui lance un déclencheur DDL sont capturées à l'aide de la fonction EVENTDATA.</span><span class="sxs-lookup"><span data-stu-id="55ac0-103">Information about an event that fires a DDL trigger is captured by using the EVENTDATA function.</span></span> <span data-ttu-id="55ac0-104">Cette fonction retourne une valeur `xml`.</span><span class="sxs-lookup"><span data-stu-id="55ac0-104">This function returns an `xml` value.</span></span> <span data-ttu-id="55ac0-105">Le schéma XML inclut des informations sur les éléments suivants :</span><span class="sxs-lookup"><span data-stu-id="55ac0-105">The XML schema includes information about the following:</span></span>  
  
-   <span data-ttu-id="55ac0-106">l'heure de l'événement ;</span><span class="sxs-lookup"><span data-stu-id="55ac0-106">The time of the event.</span></span>  
  
-   <span data-ttu-id="55ac0-107">le SPID (System Process ID) de la connexion lorsque le déclencheur s'est exécuté ;</span><span class="sxs-lookup"><span data-stu-id="55ac0-107">The System Process ID (SPID) of the connection when the trigger executed.</span></span>  
  
-   <span data-ttu-id="55ac0-108">le type d'événement qui a lancé le déclencheur.</span><span class="sxs-lookup"><span data-stu-id="55ac0-108">The type of event that fired the trigger.</span></span>  
  
 <span data-ttu-id="55ac0-109">Selon le type d'événement, le schéma inclut ensuite des informations complémentaires, telles que la base de données dans laquelle s'est produit l'événement, l'objet sur lequel il s'est produit et l'instruction [!INCLUDE[tsql](../../includes/tsql-md.md)] de l'événement.</span><span class="sxs-lookup"><span data-stu-id="55ac0-109">Depending on the event type, the schema then includes additional information such as the database in which the event occurred, the object against which the event occurred, and the [!INCLUDE[tsql](../../includes/tsql-md.md)] statement of the event.</span></span> <span data-ttu-id="55ac0-110">Pour plus d'informations, consultez [DDL Triggers](ddl-triggers.md).</span><span class="sxs-lookup"><span data-stu-id="55ac0-110">For more information, see [DDL Triggers](ddl-triggers.md).</span></span>  
  
 <span data-ttu-id="55ac0-111">Par exemple, le déclencheur DDL ci-dessous est créé dans l'exemple de base de données [!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)] :</span><span class="sxs-lookup"><span data-stu-id="55ac0-111">For example, the following DDL trigger is created in the [!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)] sample database:</span></span>  
  
```  
CREATE TRIGGER safety   
ON DATABASE   
FOR CREATE_TABLE   
AS   
    PRINT 'CREATE TABLE Issued.'  
    SELECT EVENTDATA().value('(/EVENT_INSTANCE/TSQLCommand/CommandText)[1]','nvarchar(max)')  
   RAISERROR ('New tables cannot be created in this database.', 16, 1)   
   ROLLBACK  
;  
```  
  
 <span data-ttu-id="55ac0-112">L'instruction `CREATE TABLE` suivante est ensuite exécutée :</span><span class="sxs-lookup"><span data-stu-id="55ac0-112">The following `CREATE TABLE` statement is then run:</span></span>  
  
 `CREATE TABLE NewTable (Column1 int);`  
  
 <span data-ttu-id="55ac0-113">L’instruction `EVENTDATA()` du déclencheur DDL capture le texte de l’instruction `CREATE TABLE` qui n’est pas autorisé.</span><span class="sxs-lookup"><span data-stu-id="55ac0-113">The `EVENTDATA()` statement in the DDL trigger captures the text of the `CREATE TABLE` statement that is not allowed.</span></span> <span data-ttu-id="55ac0-114">Cela est possible en utilisant une instruction XQuery sur les `xml` données générées par EventData et en extrayant l' \<CommandText> élément.</span><span class="sxs-lookup"><span data-stu-id="55ac0-114">This is achieved by using an XQuery statement against the `xml` data that is generated by EVENTDATA and retrieving the \<CommandText> element.</span></span> <span data-ttu-id="55ac0-115">Pour plus d’informations, consultez [Informations de référence sur le langage XQuery &#40;SQL Server&#41;](/sql/xquery/xquery-language-reference-sql-server).</span><span class="sxs-lookup"><span data-stu-id="55ac0-115">For more information, see [XQuery Language Reference &#40;SQL Server&#41;](/sql/xquery/xquery-language-reference-sql-server).</span></span>  
  
> [!CAUTION]  
>  <span data-ttu-id="55ac0-116">EVENTDATA capture les données des événements CREATE_SCHEMA ainsi que l'<élément_de_schéma> de la définition CREATE SCHEMA correspondante, s'il existe.</span><span class="sxs-lookup"><span data-stu-id="55ac0-116">EVENTDATA captures the data of CREATE_SCHEMA events as well as the <schema_element> of the corresponding CREATE SCHEMA definition, if any exists.</span></span> <span data-ttu-id="55ac0-117">En outre, EVENTDATA reconnaît la définition <élément_de_schéma> en tant qu'événement distinct.</span><span class="sxs-lookup"><span data-stu-id="55ac0-117">Additionally, EVENTDATA recognizes the <schema_element> definition as a separate event.</span></span> <span data-ttu-id="55ac0-118">En conséquence, un déclencheur DDL créé à la fois sur un événement CREATE_SCHEMA et sur un événement représenté par l'<élément_de_schéma> de la définition CREATE SCHEMA, peut retourner deux fois les mêmes données d'événement, telles que les données `TSQLCommand`.</span><span class="sxs-lookup"><span data-stu-id="55ac0-118">Therefore, a DDL trigger created on both a CREATE_SCHEMA event, and an event represented by the <schema_element> of the CREATE SCHEMA definition, may return the same event data twice, such as the `TSQLCommand` data.</span></span> <span data-ttu-id="55ac0-119">Par exemple, considérez qu'un déclencheur DDL est créé sur les deux événements CREATE_SCHEMA et CREATE_TABLE et que le traitement suivant est exécuté :</span><span class="sxs-lookup"><span data-stu-id="55ac0-119">For example, consider a DDL trigger that is created on both the CREATE_SCHEMA and CREATE_TABLE events and the following batch is run:</span></span>  
>   
>  `CREATE SCHEMA s`  
>   
>  `CREATE TABLE t1 (col1 int)`  
>   
>  <span data-ttu-id="55ac0-120">Si l'application récupère les données `TSQLCommand` de l'événement CREATE_TABLE, soyez conscient que ces données peuvent apparaître deux fois : une fois lorsque l'événement CREATE_SCHEMA se produit et de nouveau lorsque l'événement CREATE_TABLE a lieu.</span><span class="sxs-lookup"><span data-stu-id="55ac0-120">If the application retrieves the `TSQLCommand` data of the CREATE_TABLE event, be aware that this data may appear two times: once when the CREATE_SCHEMA event occurs, and again when the CREATE_TABLE event occurs.</span></span> <span data-ttu-id="55ac0-121">Évitez de créer des déclencheurs DDL sur les événements CREATE_SCHEMA et sur les textes <élément_de_schéma> de toute définition CREATE SCHEMA correspondante, ou construisez la logique dans votre application de sorte que le même événement ne soit pas traité deux fois.</span><span class="sxs-lookup"><span data-stu-id="55ac0-121">Avoid creating DDL triggers on both the CREATE_SCHEMA events and the <schema_element> texts of any corresponding CREATE SCHEMA definitions, or build logic into your application so that the same event is not processed twice.</span></span>  
  
## <a name="alter-table-and-alter-database-events"></a><span data-ttu-id="55ac0-122">Événements ALTER TABLE et ALTER DATABASE</span><span class="sxs-lookup"><span data-stu-id="55ac0-122">ALTER TABLE and ALTER DATABASE Events</span></span>  
 <span data-ttu-id="55ac0-123">Les données d'événements pour les événements ALTER_TABLE et ALTER_DATABASE incluent également les noms et types d'autres objets affectés par l'instruction DDL et l'action effectuée sur ces objets.</span><span class="sxs-lookup"><span data-stu-id="55ac0-123">The event data for the ALTER_TABLE and ALTER_DATABASE events also includes the names and types of other objects affected by the DDL statement and the action performed on these objects.</span></span> <span data-ttu-id="55ac0-124">Les données d'événements ALTER_TABLE incluent les noms des colonnes, contraintes ou déclencheurs affectés par l'instruction TABLE ALTER et l'action (créer, modifier, supprimer, activer ou désactiver) effectuée sur les objets affectés.</span><span class="sxs-lookup"><span data-stu-id="55ac0-124">The ALTER_TABLE event data includes the names of the columns, constraints, or triggers affected by the ALTER TABLE statement and the action (create, alter, drop, enable, or disable) performed on the affected objects.</span></span> <span data-ttu-id="55ac0-125">Les données d'événements ALTER_DATABASE incluent les noms des fichiers ou groupes de fichiers affectés par l'instruction ALTER DATABASE et l'action (créer, modifier ou supprimer) effectuée sur les objets affectés.</span><span class="sxs-lookup"><span data-stu-id="55ac0-125">The ALTER_DATABASE event data includes the names of any files or filegroups affected by the ALTER DATABASE statement and the action (create, alter, or drop) performed on the affected objects.</span></span>  
  
 <span data-ttu-id="55ac0-126">Par exemple, créez le déclencheur DDL ci-dessous dans l'exemple de base de données AdventureWorks :</span><span class="sxs-lookup"><span data-stu-id="55ac0-126">For example, create the following DDL trigger in the AdventureWorks sample database:</span></span>  
  
```  
CREATE TRIGGER ColumnChanges  
ON DATABASE   
FOR ALTER_TABLE  
AS  
-- Detect whether a column was created/altered/dropped.  
SELECT EVENTDATA().value('(/EVENT_INSTANCE/TSQLCommand/CommandText)[1]', 'nvarchar(max)')  
RAISERROR ('Table schema cannot be modified in this database.', 16, 1);  
ROLLBACK;  
```  
  
 <span data-ttu-id="55ac0-127">Ensuite, exécutez l'instruction ALTER TABLE suivante qui enfreint une contrainte :</span><span class="sxs-lookup"><span data-stu-id="55ac0-127">Then execute the following ALTER TABLE statement that violates a constraint:</span></span>  
  
```  
ALTER TABLE Person.Address ALTER COLUMN ModifiedDate date;   
```  
  
 <span data-ttu-id="55ac0-128">L’instruction EVENTDATA() du déclencheur DDL capture le texte de l’instruction `ALTER TABLE` qui n’est pas autorisé.</span><span class="sxs-lookup"><span data-stu-id="55ac0-128">The EVENTDATA() statement in the DDL trigger captures the text of the `ALTER TABLE` statement that is not permitted.</span></span>  
  
## <a name="example"></a><span data-ttu-id="55ac0-129">Exemple</span><span class="sxs-lookup"><span data-stu-id="55ac0-129">Example</span></span>  
 <span data-ttu-id="55ac0-130">Vous pouvez utiliser la fonction EVENTDATA pour créer un journal des événements.</span><span class="sxs-lookup"><span data-stu-id="55ac0-130">You can use the EVENTDATA function to create a log of events.</span></span> <span data-ttu-id="55ac0-131">Dans l'exemple suivant, une table est créée pour stocker des informations sur l'événement.</span><span class="sxs-lookup"><span data-stu-id="55ac0-131">In the following example, a table is created to store event information.</span></span> <span data-ttu-id="55ac0-132">Un déclencheur DDL est ensuite créé sur la base de données active qui remplit la table avec les informations ci-dessous, chaque fois qu'un événement DDL se produit au niveau de la base de données :</span><span class="sxs-lookup"><span data-stu-id="55ac0-132">A DDL trigger is then created on the current database that populates the table with the following information whenever any database-level DDL event occurs:</span></span>  
  
-   <span data-ttu-id="55ac0-133">l'heure de l'événement (avec la fonction GETDATE) ;</span><span class="sxs-lookup"><span data-stu-id="55ac0-133">The time of the event (using the GETDATE function).</span></span>  
  
-   <span data-ttu-id="55ac0-134">l'utilisateur de la base de données sur la session de qui l'événement s'est produit (avec la fonction CURRENT_USER) ;</span><span class="sxs-lookup"><span data-stu-id="55ac0-134">The database user against whose session the event occurred (using the CURRENT_USER function).</span></span>  
  
-   <span data-ttu-id="55ac0-135">le type de l'événement ;</span><span class="sxs-lookup"><span data-stu-id="55ac0-135">The type of the event.</span></span>  
  
-   <span data-ttu-id="55ac0-136">l'instruction [!INCLUDE[tsql](../../includes/tsql-md.md)] comprenant l'événement.</span><span class="sxs-lookup"><span data-stu-id="55ac0-136">The [!INCLUDE[tsql](../../includes/tsql-md.md)] statement that comprised the event.</span></span>  
  
 <span data-ttu-id="55ac0-137">Là encore, les deux derniers éléments sont capturés en utilisant XQuery sur les données `xml` générées par EVENTDATA.</span><span class="sxs-lookup"><span data-stu-id="55ac0-137">Again, the last two items are captured by using XQuery against the `xml` data that is generated by EVENTDATA.</span></span>  
  
```  
USE AdventureWorks2012;  
GO  
CREATE TABLE ddl_log (PostTime datetime, DB_User nvarchar(100), Event nvarchar(100), TSQL nvarchar(2000));  
GO  
CREATE TRIGGER log   
ON DATABASE   
FOR DDL_DATABASE_LEVEL_EVENTS   
AS  
DECLARE @data XML  
SET @data = EVENTDATA()  
INSERT ddl_log   
   (PostTime, DB_User, Event, TSQL)   
   VALUES   
   (GETDATE(),   
   CONVERT(nvarchar(100), CURRENT_USER),   
   @data.value('(/EVENT_INSTANCE/EventType)[1]', 'nvarchar(100)'),   
   @data.value('(/EVENT_INSTANCE/TSQLCommand)[1]', 'nvarchar(2000)') ) ;  
GO  
--Test the trigger  
CREATE TABLE TestTable (a int)  
DROP TABLE TestTable ;  
GO  
SELECT * FROM ddl_log ;  
GO  
```  
  
> [!NOTE]  
>  <span data-ttu-id="55ac0-138">Pour retourner des données d'événement, nous vous recommandons d'utiliser la méthode XQuery `value()` à la place de la méthode `query()`.</span><span class="sxs-lookup"><span data-stu-id="55ac0-138">To return event data, we recommend that you use the XQuery `value()` method instead of the `query()` method.</span></span> <span data-ttu-id="55ac0-139">La méthode `query()` retourne des instances XML et CR/LF (retour chariot/saut de ligne) à échappement &amp; dans les résultats, alors que la méthode `value()` rend les instances CR/LF invisibles dans le résultat.</span><span class="sxs-lookup"><span data-stu-id="55ac0-139">The `query()` method returns XML and ampersand-escaped carriage return and line-feed (CRLF) instances in the output, while the `value()` method renders CRLF instances invisible in the output.</span></span>  
  
 <span data-ttu-id="55ac0-140">L'exemple de base de données [!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)] fournit un exemple similaire de déclencheur DDL.</span><span class="sxs-lookup"><span data-stu-id="55ac0-140">A similar DDL trigger example is provided with the [!INCLUDE[ssSampleDBobject](../../includes/sssampledbobject-md.md)] sample database.</span></span> <span data-ttu-id="55ac0-141">Pour trouver cet exemple, accédez au dossier des déclencheurs de base de données à l'aide de [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)].</span><span class="sxs-lookup"><span data-stu-id="55ac0-141">To obtain the example, locate the Database Triggers folder by using [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)].</span></span> <span data-ttu-id="55ac0-142">Ce dossier se trouve dans le dossier **Programmabilité** de la base de données [!INCLUDE[ssSampleDBnormal](../../includes/sssampledbnormal-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="55ac0-142">This folder is located under the **Programmability** folder of the [!INCLUDE[ssSampleDBnormal](../../includes/sssampledbnormal-md.md)] database.</span></span> <span data-ttu-id="55ac0-143">Cliquez avec le bouton droit sur **ddlDatabaseTriggerLog** et sélectionnez **Générer un script du déclencheur de la base de données en tant que**.</span><span class="sxs-lookup"><span data-stu-id="55ac0-143">Right-click **ddlDatabaseTriggerLog** and select **Script Database Trigger as**.</span></span> <span data-ttu-id="55ac0-144">Par défaut, le déclencheur DDL **ddlDatabaseTriggerLog** est désactivé.</span><span class="sxs-lookup"><span data-stu-id="55ac0-144">By default, DDL trigger **ddlDatabaseTriggerLog** is disabled.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="55ac0-145">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="55ac0-145">See Also</span></span>  
 <span data-ttu-id="55ac0-146">[Événements DDL](../triggers/ddl-events.md) </span><span class="sxs-lookup"><span data-stu-id="55ac0-146">[DDL Events](../triggers/ddl-events.md) </span></span>  
 [<span data-ttu-id="55ac0-147">Groupes d’événements DDL</span><span class="sxs-lookup"><span data-stu-id="55ac0-147">DDL Event Groups</span></span>](../triggers/ddl-event-groups.md)  
  
  
