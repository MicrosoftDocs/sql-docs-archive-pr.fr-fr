---
title: Déclencheurs de connexion | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: ''
ms.topic: conceptual
f1_keywords:
- logon triggers
- login triggers
helpviewer_keywords:
- triggers [SQL Server], logon
ms.assetid: 2f0ebb2f-de10-482d-9806-1a5de5b312b8
author: rothja
ms.author: jroth
ms.openlocfilehash: cda0be25f07ed2ee283b9707884041e7c6e4692f
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87613873"
---
# <a name="logon-triggers"></a><span data-ttu-id="2ed32-102">Déclencheurs de connexion</span><span class="sxs-lookup"><span data-stu-id="2ed32-102">Logon Triggers</span></span>
  <span data-ttu-id="2ed32-103">Les déclencheurs de connexion lancent des procédures stockées en réponse à un événement LOGON.</span><span class="sxs-lookup"><span data-stu-id="2ed32-103">Logon triggers fire stored procedures in response to a LOGON event.</span></span> <span data-ttu-id="2ed32-104">Cet événement est déclenché lorsqu'une session utilisateur est établie avec une instance de [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="2ed32-104">This event is raised when a user session is established with an instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="2ed32-105">Les déclencheurs de connexion sont activés au terme de la phase d'authentification de connexion mais avant l'établissement de la session utilisateur.</span><span class="sxs-lookup"><span data-stu-id="2ed32-105">Logon triggers fire after the authentication phase of logging in finishes, but before the user session is actually established.</span></span> <span data-ttu-id="2ed32-106">Par conséquent, tous les messages provenant du corps du déclencheur et habituellement destinés à l'utilisateur, (les messages et les messages d'erreur de l'instruction PRINT, par exemple), sont dirigés vers le journal des erreurs [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="2ed32-106">Therefore, all messages originating inside the trigger that would typically reach the user, such as error messages and messages from the PRINT statement, are diverted to the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] error log.</span></span> <span data-ttu-id="2ed32-107">Les déclencheurs de connexion ne sont pas activés si l'authentification échoue.</span><span class="sxs-lookup"><span data-stu-id="2ed32-107">Logon triggers do not fire if authentication fails.</span></span>  
  
 <span data-ttu-id="2ed32-108">Vous pouvez faire appel aux déclencheurs de connexion pour auditer et contrôler les sessions de serveur en effectuant, par exemple, le suivi de l'activité de connexion, en restreignant les connexions à [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)]ou en limitant le nombre des sessions pour une connexion spécifique.</span><span class="sxs-lookup"><span data-stu-id="2ed32-108">You can use logon triggers to audit and control server sessions, such as by tracking login activity, restricting logins to [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], or limiting the number of sessions for a specific login.</span></span> <span data-ttu-id="2ed32-109">Par exemple, dans le code suivant, le déclencheur de connexion refuse une tentative de connexion à [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] initiée par la connexion *login_test* si trois sessions utilisateur ont déjà été créées par cette connexion.</span><span class="sxs-lookup"><span data-stu-id="2ed32-109">For example, in the following code, the logon trigger denies log in attempts to [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] initiated by login *login_test* if there are already three user sessions created by that login.</span></span>  
  
 [!code-sql[TriggerDDL#LogonTrigger1](../../snippets/tsql/SQL14/tsql/triggerddl/transact-sql/snippet_create_alter_drop_trigger.sql#logontrigger1)]  
  
 <span data-ttu-id="2ed32-110">Notez que l’événement LOGON correspond à l’événement de trace SQL AUDIT_LOGIN qui peut être utilisé dans [Notifications d’événements](../service-broker/event-notifications.md).</span><span class="sxs-lookup"><span data-stu-id="2ed32-110">Note that the LOGON event corresponds to the AUDIT_LOGIN SQL Trace event, which can be used in [Event Notifications](../service-broker/event-notifications.md).</span></span> <span data-ttu-id="2ed32-111">La différence principale entre les déclencheurs et les notifications d'événement est que le lancement des déclencheurs est synchronisé avec celui des événements alors que les notifications d'événement sont asynchrones.</span><span class="sxs-lookup"><span data-stu-id="2ed32-111">The primary difference between triggers and event notifications is that triggers are raised synchronously with events, whereas event notifications are asynchronous.</span></span> <span data-ttu-id="2ed32-112">Cela signifie, entre autre, que si vous souhaitez arrêter l'établissement d'une session, vous devez faire appel à un déclencheur de connexion.</span><span class="sxs-lookup"><span data-stu-id="2ed32-112">This means, for example, that if you want to stop a session from being established, you must use a logon trigger.</span></span> <span data-ttu-id="2ed32-113">Une notification d'événement sur un événement AUDIT_LOGIN ne peut pas être utilisée à cette fin.</span><span class="sxs-lookup"><span data-stu-id="2ed32-113">An event notification on an AUDIT_LOGIN event cannot be used for this purpose.</span></span>  
  
## <a name="specifying-first-and-last-trigger"></a><span data-ttu-id="2ed32-114">Spécification du premier et du dernier déclencheurs</span><span class="sxs-lookup"><span data-stu-id="2ed32-114">Specifying First and Last Trigger</span></span>  
 <span data-ttu-id="2ed32-115">Il est possible de définir plusieurs déclencheurs sur l'événement LOGON.</span><span class="sxs-lookup"><span data-stu-id="2ed32-115">Multiple triggers can be defined on the LOGON event.</span></span> <span data-ttu-id="2ed32-116">Ces déclencheurs peuvent être désignés comme le premier ou dernier déclencheur à être activé sur un événement à l’aide de la procédure stockée système [sp_settriggerorder](/sql/relational-databases/system-stored-procedures/sp-settriggerorder-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="2ed32-116">Any one of these triggers can be designated the first or last trigger to be fired on an event by using the [sp_settriggerorder](/sql/relational-databases/system-stored-procedures/sp-settriggerorder-transact-sql) system stored procedure.</span></span> [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] <span data-ttu-id="2ed32-117">ne garantit pas l’ordre d’exécution des déclencheurs restants.</span><span class="sxs-lookup"><span data-stu-id="2ed32-117">does not guarantee the execution order of the remaining triggers.</span></span>  
  
## <a name="managing-transactions"></a><span data-ttu-id="2ed32-118">Gestion des transactions</span><span class="sxs-lookup"><span data-stu-id="2ed32-118">Managing Transactions</span></span>  
 <span data-ttu-id="2ed32-119">Avant que [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] n'exécute un déclencheur de connexion, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] crée une transaction implicite qui est indépendante d'une transaction utilisateur.</span><span class="sxs-lookup"><span data-stu-id="2ed32-119">Before [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] fires a logon trigger, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] creates an implicit transaction that is independent from any user transaction.</span></span> <span data-ttu-id="2ed32-120">Par conséquent, à l'exécution du premier déclencheur de connexion, le nombre de transactions est 1.</span><span class="sxs-lookup"><span data-stu-id="2ed32-120">Therefore, when the first logon trigger starts firing, the transaction count is 1.</span></span> <span data-ttu-id="2ed32-121">Après l'exécution de tous les déclencheurs de connexion, la transaction est validée.</span><span class="sxs-lookup"><span data-stu-id="2ed32-121">After all the logon triggers finish executing, the transaction commits.</span></span> <span data-ttu-id="2ed32-122">En ce qui concerne les autres types de déclencheurs, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] retourne une erreur si l'exécution d'un déclencheur de connexion se termine avec un nombre de transactions de 0.</span><span class="sxs-lookup"><span data-stu-id="2ed32-122">As with other types of triggers, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] returns an error if a logon trigger finishes execution with a transaction count of 0.</span></span> <span data-ttu-id="2ed32-123">L'instruction ROLLBACK TRANSACTION rétablit le nombre de transactions à 0, même si l'instruction est émise au sein d'une transaction imbriquée.</span><span class="sxs-lookup"><span data-stu-id="2ed32-123">The ROLLBACK TRANSACTION statement resets the transaction count to 0, even if the statement is issued inside a nested transaction.</span></span> <span data-ttu-id="2ed32-124">L'instruction COMMIT TRANSACTION peut décrémenter le nombre de transactions jusqu'à 0.</span><span class="sxs-lookup"><span data-stu-id="2ed32-124">COMMIT TRANSACTION might decrement the transaction count to 0.</span></span> <span data-ttu-id="2ed32-125">Par conséquent, il est déconseillé d'émettre des instructions COMMIT TRANSACTION au sein de déclencheurs de connexion.</span><span class="sxs-lookup"><span data-stu-id="2ed32-125">Therefore, we advise against issuing COMMIT TRANSACTION statements inside logon triggers.</span></span>  
  
 <span data-ttu-id="2ed32-126">Tenez compte des points suivants lorsque vous utilisez une instruction ROLLBACK TRANSACTION au sein de déclencheurs de connexion :</span><span class="sxs-lookup"><span data-stu-id="2ed32-126">Consider the following when you are using a ROLLBACK TRANSACTION statement inside logon triggers:</span></span>  
  
-   <span data-ttu-id="2ed32-127">Les modifications de données effectuées jusqu'au point de l'instruction ROLLBACK TRANSACTION sont restaurées.</span><span class="sxs-lookup"><span data-stu-id="2ed32-127">Any data modifications made up to the point of ROLLBACK TRANSACTION are rolled back.</span></span> <span data-ttu-id="2ed32-128">Ces modifications incluent les modifications effectuées par le déclencheur actif et celles effectuées par les déclencheurs précédents qui se sont exécutés sur le même événement.</span><span class="sxs-lookup"><span data-stu-id="2ed32-128">These modifications include those made by the current trigger and those made by previous triggers that executed on the same event.</span></span> <span data-ttu-id="2ed32-129">Les déclencheurs restants pour l'événement spécifique ne sont pas exécutés.</span><span class="sxs-lookup"><span data-stu-id="2ed32-129">Any remaining triggers for the specific event are not executed.</span></span>  
  
-   <span data-ttu-id="2ed32-130">Le déclencheur actif continue d'exécuter les instructions restantes qui suivent l'instruction ROLLBACK.</span><span class="sxs-lookup"><span data-stu-id="2ed32-130">The current trigger continues to execute any remaining statements that appear after the ROLLBACK statement.</span></span> <span data-ttu-id="2ed32-131">Si l'une de ces instructions modifie les données, les modifications ne sont pas annulées.</span><span class="sxs-lookup"><span data-stu-id="2ed32-131">If any of these statements modify data, the modifications are not rolled back.</span></span>  
  
 <span data-ttu-id="2ed32-132">Une session utilisateur n'est pas établie si une des conditions suivantes se produit au cours de l'exécution d'un déclencheur sur un événement LOGON :</span><span class="sxs-lookup"><span data-stu-id="2ed32-132">A user session is not established if any one of the following conditions occur during execution of a trigger on a LOGON event:</span></span>  
  
-   <span data-ttu-id="2ed32-133">La transaction implicite d'origine est restaurée ou échoue.</span><span class="sxs-lookup"><span data-stu-id="2ed32-133">The original implicit transaction is rolled back or fails.</span></span>  
  
-   <span data-ttu-id="2ed32-134">Une erreur dont la gravité est supérieure à 20 est levée dans le corps du déclencheur.</span><span class="sxs-lookup"><span data-stu-id="2ed32-134">An error that has severity greater than 20 is raised inside the trigger body.</span></span>  
  
## <a name="disabling-a-logon-trigger"></a><span data-ttu-id="2ed32-135">Désactivation d'un déclencheur de connexion</span><span class="sxs-lookup"><span data-stu-id="2ed32-135">Disabling a Logon Trigger</span></span>  
 <span data-ttu-id="2ed32-136">Un déclencheur de connexion peut empêcher les connexions au [!INCLUDE[ssDE](../../../includes/ssde-md.md)] pour tous les utilisateurs, notamment les membres du rôle serveur fixe `sysadmin`.</span><span class="sxs-lookup"><span data-stu-id="2ed32-136">A logon trigger can effectively prevent successful connections to the [!INCLUDE[ssDE](../../../includes/ssde-md.md)] for all users, including members of the `sysadmin` fixed server role.</span></span> <span data-ttu-id="2ed32-137">Lorsqu'un déclencheur de connexion empêche les connexions, les membres du rôle serveur fixe `sysadmin` peuvent se connecter à l'aide de la connexion administrateur dédiée, ou en démarrant le [!INCLUDE[ssDE](../../../includes/ssde-md.md)] en mode de configuration minimale (-f).</span><span class="sxs-lookup"><span data-stu-id="2ed32-137">When a logon trigger is preventing connections, members of the `sysadmin` fixed server role can connect by using the dedicated administrator connection, or by starting the [!INCLUDE[ssDE](../../../includes/ssde-md.md)] in minimal configuration mode (-f).</span></span> <span data-ttu-id="2ed32-138">Pour plus d’informations, consultez [Options de démarrage du service moteur de base de données](../../database-engine/configure-windows/database-engine-service-startup-options.md).</span><span class="sxs-lookup"><span data-stu-id="2ed32-138">For more information, see [Database Engine Service Startup Options](../../database-engine/configure-windows/database-engine-service-startup-options.md).</span></span>  
  
## <a name="related-tasks"></a><span data-ttu-id="2ed32-139">Tâches associées</span><span class="sxs-lookup"><span data-stu-id="2ed32-139">Related Tasks</span></span>  
  
|<span data-ttu-id="2ed32-140">Tâche</span><span class="sxs-lookup"><span data-stu-id="2ed32-140">Task</span></span>|<span data-ttu-id="2ed32-141">Rubrique</span><span class="sxs-lookup"><span data-stu-id="2ed32-141">Topic</span></span>|  
|----------|-----------|  
|<span data-ttu-id="2ed32-142">Décrit comment créer des déclencheurs de connexion.</span><span class="sxs-lookup"><span data-stu-id="2ed32-142">Describes how to create logon triggers.</span></span> <span data-ttu-id="2ed32-143">Ces déclencheurs peuvent être créés à partir de n’importe quelle base de données, mais sont inscrits au niveau du serveur et résident dans la base de données **MASTER** .</span><span class="sxs-lookup"><span data-stu-id="2ed32-143">Logon triggers can be created from any database, but are registered at the server level and reside in the **master** database.</span></span>|[<span data-ttu-id="2ed32-144">CREATE TRIGGER &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="2ed32-144">CREATE TRIGGER &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/statements/create-trigger-transact-sql)|  
|<span data-ttu-id="2ed32-145">Décrit comment modifier des déclencheurs de connexion.</span><span class="sxs-lookup"><span data-stu-id="2ed32-145">Describes how to modify logon triggers.</span></span>|[<span data-ttu-id="2ed32-146">ALTER TRIGGER &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="2ed32-146">ALTER TRIGGER &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/statements/alter-trigger-transact-sql)|  
|<span data-ttu-id="2ed32-147">Décrit comment supprimer des déclencheurs de connexion.</span><span class="sxs-lookup"><span data-stu-id="2ed32-147">Describes how to delete logon triggers.</span></span>|[<span data-ttu-id="2ed32-148">DROP TRIGGER &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="2ed32-148">DROP TRIGGER &#40;Transact-SQL&#41;</span></span>](/sql/t-sql/statements/drop-trigger-transact-sql)|  
|<span data-ttu-id="2ed32-149">Décrit comment retourner des informations sur les déclencheurs de connexion.</span><span class="sxs-lookup"><span data-stu-id="2ed32-149">Describes how to return information about logon triggers.</span></span>|[<span data-ttu-id="2ed32-150">sys.server_triggers &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="2ed32-150">sys.server_triggers &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-catalog-views/sys-server-triggers-transact-sql)<br /><br /> [<span data-ttu-id="2ed32-151">sys.server_trigger_events &#40;Transact-SQL&#41;</span><span class="sxs-lookup"><span data-stu-id="2ed32-151">sys.server_trigger_events &#40;Transact-SQL&#41;</span></span>](/sql/relational-databases/system-catalog-views/sys-server-trigger-events-transact-sql)|  
|<span data-ttu-id="2ed32-152">Décrit comment capturer les données d'événement de déclencheur de connexion.</span><span class="sxs-lookup"><span data-stu-id="2ed32-152">Describes how to capture logon trigger event data.</span></span>||  
  
## <a name="see-also"></a><span data-ttu-id="2ed32-153">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="2ed32-153">See Also</span></span>  
 [<span data-ttu-id="2ed32-154">Déclencheurs DDL</span><span class="sxs-lookup"><span data-stu-id="2ed32-154">DDL Triggers</span></span>](../triggers/ddl-triggers.md)  
  
  
