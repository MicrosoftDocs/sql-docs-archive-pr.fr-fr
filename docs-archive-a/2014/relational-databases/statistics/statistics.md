---
title: Statistiques | Microsoft Docs
ms.custom: ''
ms.date: 06/13/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: performance
ms.topic: conceptual
helpviewer_keywords:
- statistical information [SQL Server], query optimization
- query performance [SQL Server], statistics
- query optimization statistics [SQL Server]
- statistical information [SQL Server], database options
- query optimization statistics [SQL Server], about query optimization statistics
- statistical information [SQL Server], guidelines
- statistical information [SQL Server]
- using statistics [SQL Server]
- statistical information [SQL Server], indexes
- index statistics [SQL Server]
- query optimizer [SQL Server], statistics
- statistics [SQL Server]
ms.assetid: b86a88ba-4f7c-4e19-9fbd-2f8bcd3be14a
author: MikeRayMSFT
ms.author: mikeray
ms.openlocfilehash: 0f0950e48245bed53581d2f91b120ab9555aa562
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87613366"
---
# <a name="statistics"></a><span data-ttu-id="af16a-102">Statistiques</span><span class="sxs-lookup"><span data-stu-id="af16a-102">Statistics</span></span>
  <span data-ttu-id="af16a-103">L'optimiseur de requête utilise des statistiques dans l'optique de créer des plans de requête qui améliorent les performances des requêtes.</span><span class="sxs-lookup"><span data-stu-id="af16a-103">The query optimizer uses statistics to create query plans that improve query performance.</span></span> <span data-ttu-id="af16a-104">Pour la plupart des requêtes, l'optimiseur de requête génère déjà les statistiques utiles à un plan de requête de haute qualité ; dans certains cas, vous devez créer des statistiques supplémentaires ou modifier la conception des requêtes pour obtenir des résultats optimaux.</span><span class="sxs-lookup"><span data-stu-id="af16a-104">For most queries, the query optimizer already generates the necessary statistics for a high quality query plan; in a few cases, you need to create additional statistics or modify the query design for best results.</span></span> <span data-ttu-id="af16a-105">Cette rubrique traite des concepts de statistiques et fournit des instructions pour vous permettre d'utiliser efficacement les statistiques d'optimisation de requête.</span><span class="sxs-lookup"><span data-stu-id="af16a-105">This topic discusses statistics concepts and provides guidelines for using query optimization statistics effectively.</span></span>  
  
##  <a name="components-and-concepts"></a><a name="DefinitionQOStatistics"></a> <span data-ttu-id="af16a-106">Composants et concepts</span><span class="sxs-lookup"><span data-stu-id="af16a-106">Components and Concepts</span></span>  
 <span data-ttu-id="af16a-107">Statistiques</span><span class="sxs-lookup"><span data-stu-id="af16a-107">Statistics</span></span>  
 <span data-ttu-id="af16a-108">Les statistiques utilisées dans le cadre de l'optimisation de requête sont des objets qui contiennent des informations statistiques sur la distribution des valeurs dans une ou plusieurs colonnes d'une table ou d'une vue indexée.</span><span class="sxs-lookup"><span data-stu-id="af16a-108">Statistics for query optimization are objects that contain statistical information about the distribution of values in one or more columns of a table or indexed view.</span></span> <span data-ttu-id="af16a-109">L’optimiseur de requête utilise ces statistiques pour estimer la *cardinalité*, ou le nombre de lignes, dans le résultat de la requête.</span><span class="sxs-lookup"><span data-stu-id="af16a-109">The query optimizer uses these statistics to estimate the *cardinality*, or number of rows, in the query result.</span></span> <span data-ttu-id="af16a-110">Ces *estimations de cardinalité* permettent à l’optimiseur de requête de créer un plan de requête de haute qualité.</span><span class="sxs-lookup"><span data-stu-id="af16a-110">These *cardinality estimates* enable the query optimizer to create a high-quality query plan.</span></span> <span data-ttu-id="af16a-111">Par exemple, l'optimiseur de requête peut utiliser des estimations de cardinalité pour choisir l'opérateur de recherche d'index plutôt que l'opérateur d'analyse d'index, plus vorace en ressources, contribuant ainsi à améliorer les performances des requêtes.</span><span class="sxs-lookup"><span data-stu-id="af16a-111">For example, the query optimizer could use cardinality estimates to choose the index seek operator instead of the more resource-intensive index scan operator, and in doing so improve query performance.</span></span>  
  
 <span data-ttu-id="af16a-112">Chaque objet de statistiques est créé dans une liste constituée d'une ou de plusieurs colonnes de table et comprend un histogramme présentant la distribution des valeurs dans la première colonne.</span><span class="sxs-lookup"><span data-stu-id="af16a-112">Each statistics object is created on a list of one or more table columns and includes a histogram displaying the distribution of values in the first column.</span></span> <span data-ttu-id="af16a-113">Les objets de statistiques sur plusieurs colonnes stockent également des informations statistiques sur la corrélation des valeurs entre les colonnes.</span><span class="sxs-lookup"><span data-stu-id="af16a-113">Statistics objects on multiple columns also store statistical information about the correlation of values among the columns.</span></span> <span data-ttu-id="af16a-114">Ces statistiques de corrélation, également appelées *densités*, sont dérivées du nombre de lignes distinctes de valeurs de colonne.</span><span class="sxs-lookup"><span data-stu-id="af16a-114">These correlation statistics, or *densities*, are derived from the number of distinct rows of column values.</span></span> <span data-ttu-id="af16a-115">Pour plus d’informations sur les objets de statistiques, consultez [DBCC SHOW_STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-show-statistics-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="af16a-115">For more information about statistics objects, see [DBCC SHOW_STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-show-statistics-transact-sql).</span></span>  
  
 <span data-ttu-id="af16a-116">Statistiques filtrées</span><span class="sxs-lookup"><span data-stu-id="af16a-116">Filtered Statistics</span></span>  
 <span data-ttu-id="af16a-117">Les statistiques filtrées peuvent améliorer les performances des requêtes qui effectuent des sélections dans des sous-ensembles bien définis de données.</span><span class="sxs-lookup"><span data-stu-id="af16a-117">Filtered statistics can improve query performance for queries that select from well-defined subsets of data.</span></span> <span data-ttu-id="af16a-118">Les statistiques filtrées utilisent un prédicat de filtre pour sélectionner le sous-ensemble de données qui est inclus dans les statistiques.</span><span class="sxs-lookup"><span data-stu-id="af16a-118">Filtered statistics use a filter predicate to select the subset of data that is included in the statistics.</span></span> <span data-ttu-id="af16a-119">Les statistiques filtrées correctement conçues peuvent améliorer le plan d'exécution de requête par rapport aux statistiques de table complète.</span><span class="sxs-lookup"><span data-stu-id="af16a-119">Well-designed filtered statistics can improve the query execution plan compared with full-table statistics.</span></span> <span data-ttu-id="af16a-120">Pour plus d’informations sur le prédicat de filtre, consultez [CREATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-statistics-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="af16a-120">For more information about the filter predicate, see [CREATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-statistics-transact-sql).</span></span> <span data-ttu-id="af16a-121">Pour plus d'informations sur l'opportunité de créer des statistiques filtrées, consultez la section [Quand créer des statistiques](#UpdateStatistics) .</span><span class="sxs-lookup"><span data-stu-id="af16a-121">For more information about when to create filtered statistics, see the [When to Create Statistics](#UpdateStatistics) section in this topic.</span></span> <span data-ttu-id="af16a-122">Pour une étude de cas, consultez l’entrée de blog [Using Filtered Statistics with Partitioned Tables](https://go.microsoft.com/fwlink/?LinkId=178505)sur le site web SQLCAT.</span><span class="sxs-lookup"><span data-stu-id="af16a-122">For a case study, see the blog entry, [Using Filtered Statistics with Partitioned Tables](https://go.microsoft.com/fwlink/?LinkId=178505), on the SQLCAT Web site.</span></span>  
  
 <span data-ttu-id="af16a-123">Options de statisques</span><span class="sxs-lookup"><span data-stu-id="af16a-123">Statistics Options</span></span>  
 <span data-ttu-id="af16a-124">Il existe trois options que vous pouvez définir qui affectent quand et comment les statistiques sont créées et mises à jour.</span><span class="sxs-lookup"><span data-stu-id="af16a-124">There are three options that you can set that affect when and how statistics are created and updated.</span></span> <span data-ttu-id="af16a-125">Ces options sont définies au niveau de la base de données uniquement.</span><span class="sxs-lookup"><span data-stu-id="af16a-125">These options are set at the database level only.</span></span>  
  
 <span data-ttu-id="af16a-126">Option AUTO_CREATE_STATISTICS</span><span class="sxs-lookup"><span data-stu-id="af16a-126">AUTO_CREATE_STATISTICS Option</span></span>  
 <span data-ttu-id="af16a-127">Lorsque l'option de création automatique de statistiques AUTO_CREATE_STATISTICS est activée, l'optimiseur de requête crée des statistiques sur les colonnes individuelles du prédicat de requête, le cas échéant, pour améliorer les estimations de cardinalité pour le plan de requête.</span><span class="sxs-lookup"><span data-stu-id="af16a-127">When the automatic create statistics option, AUTO_CREATE_STATISTICS, is on, the query optimizer creates statistics on individual columns in the query predicate, as necessary, to improve cardinality estimates for the query plan.</span></span> <span data-ttu-id="af16a-128">Ces statistiques de colonne unique sont créées sur les colonnes où ne figure pas déjà un histogramme au niveau d'un objet de statistiques existant.</span><span class="sxs-lookup"><span data-stu-id="af16a-128">These single-column statistics are created on columns that do not already have a histogram in an existing statistics object.</span></span> <span data-ttu-id="af16a-129">L'option AUTO_CREATE_STATISTICS ne détermine pas si les statistiques sont créées pour des index.</span><span class="sxs-lookup"><span data-stu-id="af16a-129">The AUTO_CREATE_STATISTICS option does not determine whether statistics get created for indexes.</span></span> <span data-ttu-id="af16a-130">De même, cette option ne génère pas de statistiques filtrées.</span><span class="sxs-lookup"><span data-stu-id="af16a-130">This option also does not generate filtered statistics.</span></span> <span data-ttu-id="af16a-131">Elle s'applique exclusivement aux statistiques de colonne unique pour la table entière.</span><span class="sxs-lookup"><span data-stu-id="af16a-131">It applies strictly to single-column statistics for the full table.</span></span>  
  
 <span data-ttu-id="af16a-132">Lorsque l'optimiseur de requête crée des statistiques suite à l'utilisation de l'option AUTO_CREATE_STATISTICS, le nom des statistiques commence par `_WA`.</span><span class="sxs-lookup"><span data-stu-id="af16a-132">When the query optimizer creates statistics as a result of using the AUTO_CREATE_STATISTICS option, the statistics name starts with `_WA`.</span></span> <span data-ttu-id="af16a-133">Vous pouvez utiliser la requête suivante pour déterminer si l'optimiseur de requête a créé des statistiques pour une colonne de prédicat de requête.</span><span class="sxs-lookup"><span data-stu-id="af16a-133">You can use the following query to determine if the query optimizer has created statistics for a query predicate column.</span></span>  
  
```  
SELECT OBJECT_NAME(s.object_id) AS object_name,  
    COL_NAME(sc.object_id, sc.column_id) AS column_name,  
    s.name AS statistics_name  
FROM sys.stats AS s JOIN sys.stats_columns AS sc  
    ON s.stats_id = sc.stats_id AND s.object_id = sc.object_id  
WHERE s.name like '_WA%'  
ORDER BY s.name;  
```  
  
 <span data-ttu-id="af16a-134">Option AUTO_UPDATE_STATISTICS</span><span class="sxs-lookup"><span data-stu-id="af16a-134">AUTO_UPDATE_STATISTICS Option</span></span>  
 <span data-ttu-id="af16a-135">Lorsque l'option de mise à jour automatique des statistiques AUTO_UPDATE_STATISTICS est activée, l'optimiseur de requête détermine si les statistiques sont obsolètes et les met éventuellement à jour lorsqu'elles sont utilisées par une requête.</span><span class="sxs-lookup"><span data-stu-id="af16a-135">When the automatic update statistics option, AUTO_UPDATE_STATISTICS, is on, the query optimizer determines when statistics might be out-of-date and then updates them when they are used by a query.</span></span> <span data-ttu-id="af16a-136">Les statistiques deviennent obsolètes après que des opérations d'insertion, de mise à jour, de suppression ou de fusion ont modifié la distribution des données dans la table ou la vue indexée.</span><span class="sxs-lookup"><span data-stu-id="af16a-136">Statistics become out-of-date after insert, update, delete, or merge operations change the data distribution in the table or indexed view.</span></span> <span data-ttu-id="af16a-137">L'optimiseur de requête détermine si les statistiques sont obsolètes en comptant le nombre de modifications de données depuis la dernière mise à jour des statistiques et en comparant le nombre de modifications à un seuil.</span><span class="sxs-lookup"><span data-stu-id="af16a-137">The query optimizer determines when statistics might be out-of-date by counting the number of data modifications since the last statistics update and comparing the number of modifications to a threshold.</span></span> <span data-ttu-id="af16a-138">Ce seuil est basé sur le nombre de lignes contenues dans la table ou la vue indexée.</span><span class="sxs-lookup"><span data-stu-id="af16a-138">The threshold is based on the number of rows in the table or indexed view.</span></span>  
  
 <span data-ttu-id="af16a-139">L'optimiseur de requête vérifie s'il existe des statistiques obsolètes avant de compiler une requête et avant d'exécuter un plan de requête mis en cache.</span><span class="sxs-lookup"><span data-stu-id="af16a-139">The query optimizer checks for out-of-date statistics before compiling a query and before executing a cached query plan.</span></span> <span data-ttu-id="af16a-140">Avant de compiler une requête, l'optimiseur de requête utilise les colonnes, les tables et les vues indexées du prédicat de requête pour identifier les statistiques susceptibles d'être obsolètes.</span><span class="sxs-lookup"><span data-stu-id="af16a-140">Before compiling a query, the query optimizer uses the columns, tables, and indexed views in the query predicate to determine which statistics might be out-of-date.</span></span> <span data-ttu-id="af16a-141">Avant d'exécuter un plan de requête mis en cache, le [!INCLUDE[ssDE](../../../includes/ssde-md.md)] vérifie que le plan de requête fait référence à des statistiques à jour.</span><span class="sxs-lookup"><span data-stu-id="af16a-141">Before executing a cached query plan, the [!INCLUDE[ssDE](../../../includes/ssde-md.md)] verifies that the query plan references up-to-date statistics.</span></span>  
  
 <span data-ttu-id="af16a-142">L’option AUTO_UPDATE_STATISTICS s’applique aux objets de statistiques créés pour les index, aux colonnes uniques contenues dans les prédicats de requête et aux statistiques créées à l’aide de l’instruction [CREATE STATISTICS](/sql/t-sql/statements/create-statistics-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="af16a-142">The AUTO_UPDATE_STATISTICS option applies to statistics objects created for indexes, single-columns in query predicates, and statistics created with the [CREATE STATISTICS](/sql/t-sql/statements/create-statistics-transact-sql) statement.</span></span> <span data-ttu-id="af16a-143">Cette option s'applique également aux statistiques filtrées.</span><span class="sxs-lookup"><span data-stu-id="af16a-143">This option also applies to filtered statistics.</span></span>  
  
 <span data-ttu-id="af16a-144">AUTO_UPDATE_STATISTICS_ASYNC</span><span class="sxs-lookup"><span data-stu-id="af16a-144">AUTO_UPDATE_STATISTICS_ASYNC</span></span>  
 <span data-ttu-id="af16a-145">L'option de mise à jour asynchrone des statistiques AUTO_UPDATE_STATISTICS_ASYNC détermine si l'optimiseur de requête utilise des mises à jour de statistiques synchrones ou asynchrones.</span><span class="sxs-lookup"><span data-stu-id="af16a-145">The asynchronous statistics update option, AUTO_UPDATE_STATISTICS_ASYNC, determines whether the query optimizer uses synchronous or asynchronous statistics updates.</span></span> <span data-ttu-id="af16a-146">Par défaut, l'option de mise à jour asynchrone des statistiques est désactivée, et l'optimiseur de requête met à jour les statistiques en mode synchrone.</span><span class="sxs-lookup"><span data-stu-id="af16a-146">By default, the asynchronous statistics update option is off, and the query optimizer updates statistics synchronously.</span></span> <span data-ttu-id="af16a-147">L’option AUTO_UPDATE_STATISTICS_ASYNC s’applique aux objets de statistiques créés pour les index, aux colonnes uniques contenues dans les prédicats de requête et aux statistiques créées à l’aide de l’instruction [CREATE STATISTICS](/sql/t-sql/statements/create-statistics-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="af16a-147">The AUTO_UPDATE_STATISTICS_ASYNC option applies to statistics objects created for indexes, single columns in query predicates, and statistics created with the [CREATE STATISTICS](/sql/t-sql/statements/create-statistics-transact-sql) statement.</span></span>  
  
 <span data-ttu-id="af16a-148">La mise à jour des statistiques peut être synchrone (par défaut) ou asynchrone.</span><span class="sxs-lookup"><span data-stu-id="af16a-148">Statistics updates can be either synchronous (the default) or asynchronous.</span></span> <span data-ttu-id="af16a-149">Dans le cas de la mise à jour synchrone des statistiques, les requêtes sont systématiquement compilées et exécutées avec des statistiques à jour ; si les statistiques sont obsolètes, l'optimiseur de requête attend que les statistiques soient mises à jour avant de compiler et d'exécuter les requêtes.</span><span class="sxs-lookup"><span data-stu-id="af16a-149">With synchronous statistics updates, queries always compile and execute with up-to-date statistics; When statistics are out-of-date, the query optimizer waits for updated statistics before compiling and executing the query.</span></span> <span data-ttu-id="af16a-150">Dans le cas de la mise à jour asynchrone des statistiques, les requêtes sont compilées avec les statistiques existantes, même si celles-ci sont obsolètes ; l'optimiseur de requête peut très bien choisir un plan de requête non optimal si les statistiques sont obsolètes au moment où les requêtes sont compilées.</span><span class="sxs-lookup"><span data-stu-id="af16a-150">With asynchronous statistics updates, queries compile with existing statistics even if the existing statistics are out-of-date; The query optimizer could choose a suboptimal query plan if statistics are out-of-date when the query compiles.</span></span> <span data-ttu-id="af16a-151">Les requêtes compilées à l'issue d'une mise à jour asynchrone ont l'avantage d'utiliser des statistiques mises à jour.</span><span class="sxs-lookup"><span data-stu-id="af16a-151">Queries that compile after the asynchronous updates have completed will benefit from using the updated statistics.</span></span>  
  
 <span data-ttu-id="af16a-152">Envisagez d'utiliser des statistiques synchrones lorsque vous effectuez des opérations qui modifient la distribution des données, telles que la troncation d'une table ou une mise à jour en bloc d'un fort pourcentage de lignes.</span><span class="sxs-lookup"><span data-stu-id="af16a-152">Consider using synchronous statistics when you perform operations that change the distribution of data, such as truncating a table or performing a bulk update of a large percentage of the rows.</span></span> <span data-ttu-id="af16a-153">Si vous ne mettez pas à jour les statistiques à l'issue de l'opération, l'utilisation de statistiques synchrones vous garantira que les statistiques sont à jour avant d'exécuter des requêtes sur les données modifiées.</span><span class="sxs-lookup"><span data-stu-id="af16a-153">If you do not update the statistics after completing the operation, using synchronous statistics will ensure statistics are up-to-date before executing queries on the changed data.</span></span>  
  
 <span data-ttu-id="af16a-154">Envisagez d'utiliser des statistiques asynchrones pour obtenir des temps de réponse des requêtes plus prévisibles pour les scénarios suivants :</span><span class="sxs-lookup"><span data-stu-id="af16a-154">Consider using asynchronous statistics to achieve more predictable query response times for the following scenarios:</span></span>  
  
-   <span data-ttu-id="af16a-155">Votre application exécute régulièrement la même requête, des requêtes similaires ou des plans de requête mis en cache similaires.</span><span class="sxs-lookup"><span data-stu-id="af16a-155">Your application frequently executes the same query, similar queries, or similar cached query plans.</span></span> <span data-ttu-id="af16a-156">Il se peut que les temps de réponse de vos requêtes soient plus prévisibles avec des mises à jour de statistiques asynchrones qu'avec des mises à jour de statistiques synchrones, car l'optimiseur de requête peut exécuter les requêtes entrantes sans attendre la mise à jour des statistiques.</span><span class="sxs-lookup"><span data-stu-id="af16a-156">Your query response times might be more predictable with asynchronous statistics updates than with synchronous statistics updates because the query optimizer can execute incoming queries without waiting for up-to-date statistics.</span></span> <span data-ttu-id="af16a-157">Cela évite de retarder certaines requêtes et pas les autres.</span><span class="sxs-lookup"><span data-stu-id="af16a-157">This avoids delaying some queries and not others.</span></span>  
  
-   <span data-ttu-id="af16a-158">Votre application a connu des expirations de délai de demandes clientes causées par une ou plusieurs requêtes en attente de statistiques mises à jour.</span><span class="sxs-lookup"><span data-stu-id="af16a-158">Your application has experienced client request time outs caused by one or more queries waiting for updated statistics.</span></span> <span data-ttu-id="af16a-159">Dans certains cas, l'attente de statistiques synchrones peut entraîner l'échec des applications dont les délais d'expiration sont agressifs.</span><span class="sxs-lookup"><span data-stu-id="af16a-159">In some cases, waiting for synchronous statistics could cause applications with aggressive time outs to fail.</span></span>  
  
 <span data-ttu-id="af16a-160">INCREMENTAL STATS</span><span class="sxs-lookup"><span data-stu-id="af16a-160">INCREMENTAL STATS</span></span>  
 <span data-ttu-id="af16a-161">Si la valeur ON est définie, les statistiques sont créées par partition.</span><span class="sxs-lookup"><span data-stu-id="af16a-161">When ON, the statistics created are per partition statistics.</span></span> <span data-ttu-id="af16a-162">Si la valeur est OFF, l'arborescence des statistiques est supprimée et [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] recalcule les statistiques.</span><span class="sxs-lookup"><span data-stu-id="af16a-162">When OFF, the statistics tree is dropped and [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] re-computes the statistics.</span></span> <span data-ttu-id="af16a-163">La valeur par défaut est OFF.</span><span class="sxs-lookup"><span data-stu-id="af16a-163">The default is OFF.</span></span> <span data-ttu-id="af16a-164">Ce paramètre remplace la propriété INCREMENTAL de niveau base de données.</span><span class="sxs-lookup"><span data-stu-id="af16a-164">This setting overrides the database level INCREMENTAL property.</span></span>  
  
 <span data-ttu-id="af16a-165">Lorsque de nouvelles partitions sont ajoutées à une table volumineuse, les statistiques doivent être mises à jour afin d'inclure les nouvelles partitions.</span><span class="sxs-lookup"><span data-stu-id="af16a-165">When new partitions are added to a large table, statistics should be updated to include the new partitions.</span></span> <span data-ttu-id="af16a-166">Cependant, la durée nécessaire pour analyser la table entière (option FULLSCAN ou SAMPLE) peut être assez longue.</span><span class="sxs-lookup"><span data-stu-id="af16a-166">However the time required to scan the entire table (FULLSCAN or SAMPLE option) might be quite long.</span></span> <span data-ttu-id="af16a-167">En outre, l'analyse la table entière n'est pas nécessaire car seules les statistiques sur les nouvelles partitions peuvent être requises.</span><span class="sxs-lookup"><span data-stu-id="af16a-167">Also, scanning the entire table isn't necessary because only the statistics on the new partitions might be needed.</span></span> <span data-ttu-id="af16a-168">L'option incrémentielle crée et stocke des statistiques par partition, et une fois la mise à jour terminée, seules sont actualisées les statistiques sur les partitions qui ont besoin de nouvelles statistiques</span><span class="sxs-lookup"><span data-stu-id="af16a-168">The incremental option creates and stores statistics on a per partition basis, and when updated, only refreshes statistics on those partitions that need new statistics</span></span>  
  
 <span data-ttu-id="af16a-169">Si les statistiques par partition ne sont pas prises en charge, l'option est ignorée et un avertissement est généré.</span><span class="sxs-lookup"><span data-stu-id="af16a-169">If per partition statistics are not supported the option is ignored and a warning is generated.</span></span> <span data-ttu-id="af16a-170">Les statistiques incrémentielles ne sont pas prises en charge pour les types de statistiques suivants :</span><span class="sxs-lookup"><span data-stu-id="af16a-170">Incremental stats are not supported for following statistics types:</span></span>  
  
-   <span data-ttu-id="af16a-171">statistiques créées avec des index qui ne sont pas alignés sur les partitions avec la table de base ;</span><span class="sxs-lookup"><span data-stu-id="af16a-171">Statistics created with indexes that are not partition-aligned with the base table.</span></span>  
  
-   <span data-ttu-id="af16a-172">statistiques créées sur les bases de données secondaires lisibles AlwaysOn ;</span><span class="sxs-lookup"><span data-stu-id="af16a-172">Statistics created on AlwaysOn readable secondary databases.</span></span>  
  
-   <span data-ttu-id="af16a-173">statistiques créées sur les bases de données en lecture seule ;</span><span class="sxs-lookup"><span data-stu-id="af16a-173">Statistics created on read-only databases.</span></span>  
  
-   <span data-ttu-id="af16a-174">statistiques créées sur les index filtrés ;</span><span class="sxs-lookup"><span data-stu-id="af16a-174">Statistics created on filtered indexes.</span></span>  
  
-   <span data-ttu-id="af16a-175">statistiques créées sur les vues ;</span><span class="sxs-lookup"><span data-stu-id="af16a-175">Statistics created on views.</span></span>  
  
-   <span data-ttu-id="af16a-176">statistiques créées sur les tables internes ;</span><span class="sxs-lookup"><span data-stu-id="af16a-176">Statistics created on internal tables.</span></span>  
  
-   <span data-ttu-id="af16a-177">Statistiques créées avec les index spatiaux ou les index XML.</span><span class="sxs-lookup"><span data-stu-id="af16a-177">Statistics created with spatial indexes or XML indexes.</span></span>  
  
||  
|-|  
|<span data-ttu-id="af16a-178">**S'applique à**: [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] jusqu'à [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span><span class="sxs-lookup"><span data-stu-id="af16a-178">**Applies to**: [!INCLUDE[ssSQL14](../../includes/sssql14-md.md)] through [!INCLUDE[ssCurrent](../../includes/sscurrent-md.md)].</span></span>|  
  
##  <a name="when-to-create-statistics"></a><a name="CreateStatistics"></a><span data-ttu-id="af16a-179">Quand créer des statistiques</span><span class="sxs-lookup"><span data-stu-id="af16a-179">When to Create Statistics</span></span>  
 <span data-ttu-id="af16a-180">L'optimiseur de requête crée déjà des statistiques selon les méthodes suivantes :</span><span class="sxs-lookup"><span data-stu-id="af16a-180">The query optimizer already creates statistics in the following ways:</span></span>  
  
1.  <span data-ttu-id="af16a-181">L'optimiseur de requête crée des statistiques pour les index de tables ou de vues lors de la création des index.</span><span class="sxs-lookup"><span data-stu-id="af16a-181">The query optimizer creates statistics for indexes on tables or views when the index is created.</span></span> <span data-ttu-id="af16a-182">Ces statistiques sont créées sur les colonnes de clés de l'index.</span><span class="sxs-lookup"><span data-stu-id="af16a-182">These statistics are created on the key columns of the index.</span></span> <span data-ttu-id="af16a-183">Si l'index est un index filtré, l'optimiseur de requête crée des statistiques filtrées sur le même sous-ensemble de lignes spécifié pour l'index filtré.</span><span class="sxs-lookup"><span data-stu-id="af16a-183">If the index is a filtered index, the query optimizer creates filtered statistics on the same subset of rows specified for the filtered index.</span></span> <span data-ttu-id="af16a-184">Pour plus d’informations sur les index filtrés, consultez [Créer des index filtrés](../indexes/create-filtered-indexes.md) et [CREATE INDEX &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-index-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="af16a-184">For more information about filtered indexes, see [Create Filtered Indexes](../indexes/create-filtered-indexes.md) and [CREATE INDEX &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-index-transact-sql).</span></span>  
  
2.  <span data-ttu-id="af16a-185">L'optimiseur de requête crée des statistiques pour les colonnes uniques des prédicats de requête lorsque l'option AUTO_CREATE_STATISTICS est activée.</span><span class="sxs-lookup"><span data-stu-id="af16a-185">The query optimizer creates statistics for single columns in query predicates when AUTO_CREATE_STATISTICS is on.</span></span>  
  
 <span data-ttu-id="af16a-186">Pour la plupart des requêtes, ces deux méthodes de création de statistiques sont l’assurance de disposer d’un plan de requête de haute qualité. Dans certains cas, vous pouvez améliorer les plans de requête en créant des statistiques supplémentaires à l’aide de l’instruction [CREATE STATISTICS](/sql/t-sql/statements/create-statistics-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="af16a-186">For most queries, these two methods for creating statistics ensure a high-quality query plan; in a few cases, you can improve query plans by creating additional statistics with the [CREATE STATISTICS](/sql/t-sql/statements/create-statistics-transact-sql) statement.</span></span> <span data-ttu-id="af16a-187">Ces statistiques supplémentaires peuvent capturer des corrélations statistiques dont l'optimiseur de requête ne tient pas compte lorsqu'il crée des statistiques pour des index ou des colonnes uniques.</span><span class="sxs-lookup"><span data-stu-id="af16a-187">These additional statistics can capture statistical correlations that the query optimizer does not account for when it creates statistics for indexes or single columns.</span></span> <span data-ttu-id="af16a-188">Il se peut que votre application présente des corrélations statistiques supplémentaires dans les données de table qui, si elles sont calculées dans un objet de statistiques, peuvent permettre à l'optimiseur de requête d'améliorer les plans de requête.</span><span class="sxs-lookup"><span data-stu-id="af16a-188">Your application might have additional statistical correlations in the table data that, if calculated into a statistics object, could enable the query optimizer to improve query plans.</span></span> <span data-ttu-id="af16a-189">Par exemple, les statistiques filtrées sur un sous-ensemble de lignes de données ou les statistiques multicolonnes sur des colonnes de prédicat de requête sont susceptibles d'améliorer le plan de requête.</span><span class="sxs-lookup"><span data-stu-id="af16a-189">For example, filtered statistics on a subset of data rows or multicolumn statistics on query predicate columns might improve the query plan.</span></span>  
  
 <span data-ttu-id="af16a-190">Dans le cadre de la création de statistiques à l'aide de l'instruction CREATE STATISTICS, nous vous recommandons de maintenir l'option AUTO_CREATE_STATISTICS activée de sorte que l'optimiseur de requête continue de créer de manière régulière des statistiques de colonne unique pour les colonnes de prédicat de requête.</span><span class="sxs-lookup"><span data-stu-id="af16a-190">When creating statistics with the CREATE STATISTICS statement, we recommend keeping the AUTO_CREATE_STATISTICS option on so that the query optimizer continues to routinely create single-column statistics for query predicate columns.</span></span> <span data-ttu-id="af16a-191">Pour plus d’informations sur les prédicats de requête, consultez [Condition de recherche &#40;Transact-SQL&#41;](/sql/t-sql/queries/search-condition-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="af16a-191">For more information about query predicates, see [Search Condition &#40;Transact-SQL&#41;](/sql/t-sql/queries/search-condition-transact-sql).</span></span>  
  
 <span data-ttu-id="af16a-192">Envisagez de créer des statistiques avec l'instruction CREATE STATISTICS dans l'un des cas suivants :</span><span class="sxs-lookup"><span data-stu-id="af16a-192">Consider creating statistics with the CREATE STATISTICS statement when any of the following applies:</span></span>  
  
-   <span data-ttu-id="af16a-193">l'Assistant Paramétrage du [!INCLUDE[ssDE](../../../includes/ssde-md.md)] suggère de créer des statistiques ;</span><span class="sxs-lookup"><span data-stu-id="af16a-193">The [!INCLUDE[ssDE](../../../includes/ssde-md.md)] Tuning Advisor suggests creating statistics.</span></span>  
  
-   <span data-ttu-id="af16a-194">le prédicat de requête contient plusieurs colonnes corrélées qui ne figurent pas déjà dans le même index ;</span><span class="sxs-lookup"><span data-stu-id="af16a-194">The query predicate contains multiple correlated columns that are not already in the same index.</span></span>  
  
-   <span data-ttu-id="af16a-195">la requête effectue une sélection dans un sous-ensemble de données ;</span><span class="sxs-lookup"><span data-stu-id="af16a-195">The query selects from a subset of data.</span></span>  
  
-   <span data-ttu-id="af16a-196">il manque des statistiques pour la requête.</span><span class="sxs-lookup"><span data-stu-id="af16a-196">The query has missing statistics.</span></span>  
  
### <a name="query-predicate-contains-multiple-correlated-columns"></a><span data-ttu-id="af16a-197">Le prédicat de requête contient plusieurs colonnes corrélées</span><span class="sxs-lookup"><span data-stu-id="af16a-197">Query Predicate Contains Multiple Correlated Columns</span></span>  
 <span data-ttu-id="af16a-198">Lorsqu'un prédicat de requête contient plusieurs colonnes ayant entre elles des relations et des dépendances, des statistiques sur les différentes colonnes peuvent améliorer le plan de requête.</span><span class="sxs-lookup"><span data-stu-id="af16a-198">When a query predicate contains multiple columns that have cross-column relationships and dependencies, statistics on the multiple columns might improve the query plan.</span></span> <span data-ttu-id="af16a-199">Les statistiques sur plusieurs colonnes contiennent des statistiques de corrélation entre les colonnes appelées *densités*, qui ne sont pas disponibles dans les statistiques de colonne unique.</span><span class="sxs-lookup"><span data-stu-id="af16a-199">Statistics on multiple columns contain cross-column correlation statistics, called *densities*, that are not available in single-column statistics.</span></span> <span data-ttu-id="af16a-200">Les densités peuvent améliorer les estimations de cardinalité lorsque les résultats de requête dépendent des relations de données entre plusieurs colonnes.</span><span class="sxs-lookup"><span data-stu-id="af16a-200">Densities can improve cardinality estimates when query results depend on data relationships among multiple columns.</span></span>  
  
 <span data-ttu-id="af16a-201">Si les colonnes figurent déjà dans le même index, l'objet de statistiques multicolonnes existe déjà et il n'est pas nécessaire de le créer manuellement.</span><span class="sxs-lookup"><span data-stu-id="af16a-201">If the columns are already in the same index, the multicolumn statistics object already exists and it is not necessary to create it manually.</span></span> <span data-ttu-id="af16a-202">Si les colonnes ne figurent pas déjà dans le même index, vous pouvez créer des statistiques multicolonnes en créant un index sur les colonnes ou en utilisant l'instruction CREATE STATISTICS.</span><span class="sxs-lookup"><span data-stu-id="af16a-202">If the columns are not already in the same index, you can create multicolumn statistics by creating an index on the columns or by using the CREATE STATISTICS statement.</span></span> <span data-ttu-id="af16a-203">Un index exige davantage de ressources système qu'un objet de statistiques.</span><span class="sxs-lookup"><span data-stu-id="af16a-203">It requires more system resources to maintain an index than a statistics object.</span></span> <span data-ttu-id="af16a-204">Ainsi, si l'application n'a pas besoin de l'index multicolonne, vous pouvez économiser des ressources système en créant l'objet de statistiques sans créer l'index.</span><span class="sxs-lookup"><span data-stu-id="af16a-204">If the application does not require the multicolumn index, you can economize on system resources by creating the statistics object without creating the index.</span></span>  
  
 <span data-ttu-id="af16a-205">Lors de la création de statistiques multicolonnes, l'ordre des colonnes dans la définition de l'objet de statistiques a une incidence sur l'efficacité des densités lorsqu'il s'agit de réaliser des estimations de cardinalité.</span><span class="sxs-lookup"><span data-stu-id="af16a-205">When creating multicolumn statistics, the order of the columns in the statistics object definition affects the effectiveness of densities for making cardinality estimates.</span></span> <span data-ttu-id="af16a-206">L'objet de statistiques stocke des densités pour chaque préfixe de colonnes de clés contenu dans la définition de l'objet de statistiques.</span><span class="sxs-lookup"><span data-stu-id="af16a-206">The statistics object stores densities for each prefix of key columns in the statistics object definition.</span></span> <span data-ttu-id="af16a-207">Pour plus d’informations sur les densités, consultez [DBCC SHOW_STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-show-statistics-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="af16a-207">For more information about densities, see [DBCC SHOW_STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-show-statistics-transact-sql).</span></span>  
  
 <span data-ttu-id="af16a-208">Pour créer des densités utiles aux estimations de cardinalité, les colonnes du prédicat de requête doivent correspondre à l'un des préfixes de colonnes contenus dans la définition de l'objet de statistiques.</span><span class="sxs-lookup"><span data-stu-id="af16a-208">To create densities that are useful for cardinality estimates, the columns in the query predicate must match one of the prefixes of columns in the statistics object definition.</span></span> <span data-ttu-id="af16a-209">Par exemple, le code suivant crée un objet de statistiques multicolonnes sur les colonnes `LastName`, `MiddleName`et `FirstName`.</span><span class="sxs-lookup"><span data-stu-id="af16a-209">For example, the following creates a multicolumn statistics object on the columns `LastName`, `MiddleName`, and `FirstName`.</span></span>  
  
```  
USE AdventureWorks2012;  
GO  
IF EXISTS (SELECT name FROM sys.stats  
    WHERE name = 'LastFirst'  
    AND object_ID = OBJECT_ID ('Person.Person'))  
DROP STATISTICS Person.Person.LastFirst;  
GO  
CREATE STATISTICS LastFirst ON Person.Person (LastName, MiddleName, FirstName);  
GO  
```  
  
 <span data-ttu-id="af16a-210">Dans cet exemple, l'objet de statistiques `LastFirst` comprend des densités pour les préfixes de colonne suivants : (`LastName`), (`LastName, MiddleName`) et (`LastName, MiddleName, FirstName`).</span><span class="sxs-lookup"><span data-stu-id="af16a-210">In this example, the statistics object `LastFirst` has densities for the following column prefixes: (`LastName`), (`LastName, MiddleName`), and (`LastName, MiddleName, FirstName`).</span></span> <span data-ttu-id="af16a-211">La densité n'est pas disponible pour (`LastName, FirstName`).</span><span class="sxs-lookup"><span data-stu-id="af16a-211">The density is not available for (`LastName, FirstName`).</span></span> <span data-ttu-id="af16a-212">Si la requête utilise `LastName` et `FirstName` sans utiliser `MiddleName`, la densité n'est pas disponible pour les estimations de cardinalité.</span><span class="sxs-lookup"><span data-stu-id="af16a-212">If the query uses `LastName` and `FirstName` without using `MiddleName`, the density is not available for cardinality estimates.</span></span>  
  
### <a name="query-selects-from-a-subset-of-data"></a><span data-ttu-id="af16a-213">La requête effectue une sélection dans un sous-ensemble de données</span><span class="sxs-lookup"><span data-stu-id="af16a-213">Query Selects from a Subset of Data</span></span>  
 <span data-ttu-id="af16a-214">Lorsque l'optimiseur de requête crée des statistiques pour des colonnes et des index uniques, il crée les statistiques pour les valeurs contenues dans toutes les lignes.</span><span class="sxs-lookup"><span data-stu-id="af16a-214">When the query optimizer creates statistics for single columns and indexes, it creates the statistics for the values in all rows.</span></span> <span data-ttu-id="af16a-215">Lorsque les requêtes effectuent une sélection dans un sous-ensemble de lignes et que ce sous-ensemble de lignes présente une distribution de données unique, des statistiques filtrées peuvent améliorer les plans de requête.</span><span class="sxs-lookup"><span data-stu-id="af16a-215">When queries select from a subset of rows, and that subset of rows has a unique data distribution, filtered statistics can improve query plans.</span></span> <span data-ttu-id="af16a-216">Vous pouvez créer des statistiques filtrées à l'aide de l'instruction CREATE STATISTICS avec la clause WHERE pour définir l'expression de prédicat de filtre.</span><span class="sxs-lookup"><span data-stu-id="af16a-216">You can create filtered statistics by using the CREATE STATISTICS statement with the WHERE clause to define the filter predicate expression.</span></span>  
  
 <span data-ttu-id="af16a-217">Par exemple, dans [!INCLUDE[ssSampleDBnormal](../../includes/sssampledbnormal-md.md)], chaque produit de la table Production.Product appartient à l'une des quatre catégories de la table Production.ProductCategory : Bikes, Components, Clothing et Accessories.</span><span class="sxs-lookup"><span data-stu-id="af16a-217">For example, using [!INCLUDE[ssSampleDBnormal](../../includes/sssampledbnormal-md.md)], each product in the Production.Product table belongs to one of four categories in the Production.ProductCategory table: Bikes, Components, Clothing, and Accessories.</span></span> <span data-ttu-id="af16a-218">Chacune de ces catégories présente une distribution de données différente pour le poids (Weight) : le poids des bicyclettes (Bikes) varie de 13,77 à 30,0, le poids des composants (Components) varie de 2,12 à 1 050,00 avec quelques valeurs NULL, le poids des vêtements (Clothing) est toujours NULL et le poids des accessoires (Accessories) est également toujours NULL.</span><span class="sxs-lookup"><span data-stu-id="af16a-218">Each of the categories has a different data distribution for weight: bike weights range from 13.77 to 30.0, component weights range from 2.12 to 1050.00 with some NULL values, clothing weights are all NULL, and accessory weights are also NULL.</span></span>  
  
 <span data-ttu-id="af16a-219">Si l'on prend la catégorie Bikes pour exemple, les statistiques filtrées sur tous les poids de bicyclettes fournissent des statistiques plus précises à l'optimisateur de requête et peuvent améliorer la qualité du plan de requête par rapport aux statistiques de table entière ou aux statistiques inexistantes de la colonne Weight (Poids).</span><span class="sxs-lookup"><span data-stu-id="af16a-219">Using Bikes as an example, filtered statistics on all bike weights will provide more accurate statistics to the query optimizer and can improve the query plan quality compared with full-table statistics or nonexistent statistics on the Weight column.</span></span> <span data-ttu-id="af16a-220">Si la colonne où figure le poids des bicyclettes constitue un candidat valable pour les statistiques filtrées, tel n'est pas forcément le cas pour un index filtré si le nombre de recherches de poids est relativement faible.</span><span class="sxs-lookup"><span data-stu-id="af16a-220">The bike weight column is a good candidate for filtered statistics but not necessarily a good candidate for a filtered index if the number of weight lookups is relatively small.</span></span> <span data-ttu-id="af16a-221">Les gains en performances offerts par un index filtré lors des recherches risquent de ne pas compenser les coûts de maintenance et de stockage supplémentaires liés à l'ajout d'un index filtré à la base de données.</span><span class="sxs-lookup"><span data-stu-id="af16a-221">The performance gain for lookups that a filtered index provides might not outweigh the additional maintenance and storage cost for adding a filtered index to the database.</span></span>  
  
 <span data-ttu-id="af16a-222">L'instruction suivante crée les statistiques filtrées `BikeWeights` sur toutes les sous-catégories de bicyclettes (Bikes).</span><span class="sxs-lookup"><span data-stu-id="af16a-222">The following statement creates the `BikeWeights` filtered statistics on all of the subcategories for Bikes.</span></span> <span data-ttu-id="af16a-223">L'expression de prédicat filtré définit les bicyclettes en énumérant toutes les sous-catégories de bicyclettes à l'aide de la comparaison `Production.ProductSubcategoryID IN (1,2,3)`.</span><span class="sxs-lookup"><span data-stu-id="af16a-223">The filtered predicate expression defines bikes by enumerating all of the bike subcategories with the comparison `Production.ProductSubcategoryID IN (1,2,3)`.</span></span> <span data-ttu-id="af16a-224">Le prédicat ne peut pas utiliser le nom de catégorie Bikes car il est stocké dans la table Production.ProductCategory, et toutes les colonnes spécifiées dans l'expression de filtre doivent se trouver dans la même table.</span><span class="sxs-lookup"><span data-stu-id="af16a-224">The predicate cannot use the Bikes category name because it is stored in the Production.ProductCategory table, and all columns in the filter expression must be in the same table.</span></span>  
  
 [!code-sql[StatisticsDDL#FilteredStats2](../../snippets/tsql/SQL14/tsql/statisticsddl/transact-sql/filteredstats.sql#filteredstats2)]  
  
 <span data-ttu-id="af16a-225">L'optimiseur de requête peut utiliser les statistiques filtrées `BikeWeights` pour améliorer le plan de requête de la requête suivante qui sélectionne toutes les bicyclettes dont le poids est supérieur à `25`.</span><span class="sxs-lookup"><span data-stu-id="af16a-225">The query optimizer can use the `BikeWeights` filtered statistics to improve the query plan for the following query that selects all of the bikes that weigh more than `25`.</span></span>  
  
```  
SELECT P.Weight AS Weight, S.Name AS BikeName  
FROM Production.Product AS P  
    JOIN Production.ProductSubcategory AS S   
    ON P.ProductSubcategoryID = S.ProductSubcategoryID  
WHERE P.ProductSubcategoryID IN (1,2,3) AND P.Weight > 25  
ORDER BY P.Weight;  
GO  
```  
  
### <a name="query-identifies-missing-statistics"></a><span data-ttu-id="af16a-226">La requête identifie les statistiques manquantes</span><span class="sxs-lookup"><span data-stu-id="af16a-226">Query Identifies Missing Statistics</span></span>  
 <span data-ttu-id="af16a-227">Si une erreur ou tout autre événement empêche l'optimiseur de requête de créer des statistiques, il crée le plan de requête sans utiliser de statistiques.</span><span class="sxs-lookup"><span data-stu-id="af16a-227">If an error or other event prevents the query optimizer from creating statistics, the query optimizer creates the query plan without using statistics.</span></span> <span data-ttu-id="af16a-228">L'optimiseur de requête indique que les statistiques sont manquantes et tente de les régénérer à la prochaine exécution de la requête.</span><span class="sxs-lookup"><span data-stu-id="af16a-228">The query optimizer marks the statistics as missing and attempts to regenerate the statistics the next time the query is executed.</span></span>  
  
 <span data-ttu-id="af16a-229">Les statistiques manquantes sont indiquées comme des avertissements (nom de la table en rouge) lorsque le plan d'exécution d'une requête est affiché sous forme graphique à l'aide de [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)].</span><span class="sxs-lookup"><span data-stu-id="af16a-229">Missing statistics are indicated as warnings (table name in red text) when the execution plan of a query is graphically displayed using [!INCLUDE[ssManStudioFull](../../includes/ssmanstudiofull-md.md)].</span></span> <span data-ttu-id="af16a-230">D'autre part, le **permet de surveiller la classe d'événements** Missing Column Statistics [!INCLUDE[ssSqlProfiler](../../includes/sssqlprofiler-md.md)] et d'être tenu informé lorsque des statistiques manquent.</span><span class="sxs-lookup"><span data-stu-id="af16a-230">Additionally, monitoring the **Missing Column Statistics** event class by using [!INCLUDE[ssSqlProfiler](../../includes/sssqlprofiler-md.md)] indicates when statistics are missing.</span></span> <span data-ttu-id="af16a-231">Pour plus d’informations, consultez [Catégorie d’événement Erreurs et avertissements &#40;moteur de base de données&#41;](../event-classes/errors-and-warnings-event-category-database-engine.md).</span><span class="sxs-lookup"><span data-stu-id="af16a-231">For more information, see [Errors and Warnings Event Category &#40;Database Engine&#41;](../event-classes/errors-and-warnings-event-category-database-engine.md).</span></span>  
  
 <span data-ttu-id="af16a-232">S'il manque des statistiques, procédez comme suit :</span><span class="sxs-lookup"><span data-stu-id="af16a-232">If statistics are missing, perform the following steps:</span></span>  
  
-   <span data-ttu-id="af16a-233">vérifiez que les options AUTO_CREATE_STATISTICS et AUTO_UPDATE_STATISTICS sont activées ;</span><span class="sxs-lookup"><span data-stu-id="af16a-233">Verify that AUTO_CREATE_STATISTICS and AUTO_UPDATE_STATISTICS are on.</span></span>  
  
-   <span data-ttu-id="af16a-234">vérifiez que la base de données n'est pas en lecture seule.</span><span class="sxs-lookup"><span data-stu-id="af16a-234">Verify that the database is not read-only.</span></span> <span data-ttu-id="af16a-235">Si la base de données est en lecture seule, l'optimiseur de requête ne peut pas enregistrer les statistiques ;</span><span class="sxs-lookup"><span data-stu-id="af16a-235">If the database is read-only, the query optimizer cannot save statistics.</span></span>  
  
-   <span data-ttu-id="af16a-236">créez les statistiques manquantes à l'aide de l'instruction CREATE STATISTICS.</span><span class="sxs-lookup"><span data-stu-id="af16a-236">Create the missing statistics by using the CREATE STATISTICS statement.</span></span>  
  
 <span data-ttu-id="af16a-237">Lorsque les statistiques sur une base de données en lecture seule ou un instantané en lecture seule sont absentes ou obsolètes, le [!INCLUDE[ssDE](../../../includes/ssde-md.md)] crée et gère les statistiques temporaires dans `tempdb`.</span><span class="sxs-lookup"><span data-stu-id="af16a-237">When statistics on a read-only database or read-only snapshot are missing or stale, the [!INCLUDE[ssDE](../../../includes/ssde-md.md)] creates and maintains temporary statistics in `tempdb`.</span></span> <span data-ttu-id="af16a-238">Lorsque le [!INCLUDE[ssDE](../../../includes/ssde-md.md)] crée des statistiques temporaires, le nom des statistiques est ajouté avec le suffixe _readonly_database_statistic pour différencier les statistiques temporaires des statistiques permanentes.</span><span class="sxs-lookup"><span data-stu-id="af16a-238">When the [!INCLUDE[ssDE](../../../includes/ssde-md.md)] creates temporary statistics, the statistics name is appended with the suffix _readonly_database_statistic to differentiate the temporary statistics from the permanent statistics.</span></span> <span data-ttu-id="af16a-239">Le suffixe _readonly_database_statistic est réservé aux statistiques générées par [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="af16a-239">The suffix _readonly_database_statistic is reserved for statistics generated by [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="af16a-240">Des scripts pour les statistiques temporaires peuvent être créés et reproduits sur une base de données en lecture-écriture.</span><span class="sxs-lookup"><span data-stu-id="af16a-240">Scripts for the temporary statistics can be created and reproduced on a read-write database.</span></span> <span data-ttu-id="af16a-241">Le cas échéant, [!INCLUDE[ssManStudio](../../includes/ssmanstudio-md.md)] remplace le suffixe du nom des statistiques _readonly_database_statistic par _readonly_database_statistic_scripted.</span><span class="sxs-lookup"><span data-stu-id="af16a-241">When scripted, [!INCLUDE[ssManStudio](../../includes/ssmanstudio-md.md)] changes the suffix of the statistics name from _readonly_database_statistic to _readonly_database_statistic_scripted.</span></span>  
  
 <span data-ttu-id="af16a-242">Seul [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] peut créer et mettre à jour les statistiques temporaires.</span><span class="sxs-lookup"><span data-stu-id="af16a-242">Only [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] can create and update temporary statistics.</span></span> <span data-ttu-id="af16a-243">Toutefois, vous pouvez supprimer des statistiques temporaires et analyser les propriétés des statistiques en utilisant les mêmes outils que ceux que vous utilisez pour les statistiques permanentes :</span><span class="sxs-lookup"><span data-stu-id="af16a-243">However, you can delete temporary statistics and monitor statistics properties using the same tools that you use for permanent statistics:</span></span>  
  
-   <span data-ttu-id="af16a-244">Supprimez les statistiques temporaires à l’aide de l’instruction [DROP STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/drop-statistics-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="af16a-244">Delete temporary statistics using the [DROP STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/drop-statistics-transact-sql) statement.</span></span>  
  
-   <span data-ttu-id="af16a-245">Analysez les statistiques à l’aide des affichages catalogue **sys.stats** et **sys.stats_columns** .</span><span class="sxs-lookup"><span data-stu-id="af16a-245">Monitor statistics using the **sys.stats** and **sys.stats_columns** catalog views.</span></span> <span data-ttu-id="af16a-246">**sys_stats** inclut la colonne **is_temporary** pour indiquer les statistiques permanentes et temporaires.</span><span class="sxs-lookup"><span data-stu-id="af16a-246">**sys_stats** includes the **is_temporary** column, to indicate which statistics are permanent and which are temporary.</span></span>  
  
 <span data-ttu-id="af16a-247">Étant donné que les statistiques temporaires sont stockées dans `tempdb`, un redémarrage du service [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] provoque la disparition de toutes les statistiques temporaires.</span><span class="sxs-lookup"><span data-stu-id="af16a-247">Because temporary statistics are stored in `tempdb`, a restart of the [!INCLUDE[ssNoVersion](../../../includes/ssnoversion-md.md)] service causes all temporary statistics to disappear.</span></span>  
  
##  <a name="when-to-update-statistics"></a><a name="UpdateStatistics"></a><span data-ttu-id="af16a-248">Quand mettre à jour les statistiques</span><span class="sxs-lookup"><span data-stu-id="af16a-248">When to Update Statistics</span></span>  
 <span data-ttu-id="af16a-249">L'optimiseur de requête détermine si les statistiques sont obsolètes et les met éventuellement à jour lorsqu'elles sont requises par un plan de requête.</span><span class="sxs-lookup"><span data-stu-id="af16a-249">The query optimizer determines when statistics might be out-of-date and then updates them when they are needed for a query plan.</span></span> <span data-ttu-id="af16a-250">Dans certains cas, vous pouvez améliorer le plan de requête et donc les performances des requêtes en mettant à jour les statistiques de façon plus régulière que lorsque l'option AUTO_UPDATE_STATISTICS est activée.</span><span class="sxs-lookup"><span data-stu-id="af16a-250">In some cases you can improve the query plan and therefore improve query performance by updating statistics more frequently than occur when AUTO_UPDATE_STATISTICS is on.</span></span> <span data-ttu-id="af16a-251">Vous pouvez mettre à jour les statistiques à l'aide de l'instruction UPDATE STATISTICS ou de la procédure stockée sp_updatestats.</span><span class="sxs-lookup"><span data-stu-id="af16a-251">You can update statistics with the UPDATE STATISTICS statement or the stored procedure sp_updatestats.</span></span>  
  
 <span data-ttu-id="af16a-252">La mise à jour des statistiques est l'assurance que les requêtes sont compilées avec des statistiques à jour.</span><span class="sxs-lookup"><span data-stu-id="af16a-252">Updating statistics ensures that queries compile with up-to-date statistics.</span></span> <span data-ttu-id="af16a-253">Toutefois, la mise à jour des statistiques entraîne une recompilation des requêtes.</span><span class="sxs-lookup"><span data-stu-id="af16a-253">However, updating statistics causes queries to recompile.</span></span> <span data-ttu-id="af16a-254">À ce titre, il est déconseillé de mettre à jour les statistiques de façon trop régulière eu égard aux performances. Un compromis doit être trouvé entre le souhait d'améliorer les plans de requête et le temps nécessaire à la recompilation des requêtes.</span><span class="sxs-lookup"><span data-stu-id="af16a-254">We recommend not updating statistics too frequently because there is a performance tradeoff between improving query plans and the time it takes to recompile queries.</span></span> <span data-ttu-id="af16a-255">Ce compromis peut varier en fonction de votre application.</span><span class="sxs-lookup"><span data-stu-id="af16a-255">The specific tradeoffs depend on your application.</span></span>  
  
 <span data-ttu-id="af16a-256">Dans le cadre d'une mise à jour des statistiques avec UPDATE STATISTICS ou sp_updatestats, nous vous recommandons de maintenir l'option AUTO_UPDATE_STATISTICS activée (valeur ON) de sorte que l'optimiseur de requête continue de mettre à jour les statistiques de façon régulière.</span><span class="sxs-lookup"><span data-stu-id="af16a-256">When updating statistics with UPDATE STATISTICS or sp_updatestats, we recommend keeping AUTO_UPDATE_STATISTICS set to ON so that the query optimizer continues to routinely update statistics.</span></span> <span data-ttu-id="af16a-257">Pour plus d’informations sur la façon de mettre à jour les statistiques sur une colonne, un index, une table ou une vue indexée, consultez [UPDATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/update-statistics-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="af16a-257">For more information about how to update statistics on a column, an index, a table, or an indexed view, see [UPDATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/update-statistics-transact-sql).</span></span> <span data-ttu-id="af16a-258">Pour plus d’informations sur la mise à jour des statistiques pour toutes les tables définies par l’utilisateur et les tables internes de la base de données, consultez la procédure stockée [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="af16a-258">For information about how to update statistics for all user-defined and internal tables in the database, see the stored procedure [sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql).</span></span>  
  
 <span data-ttu-id="af16a-259">Pour déterminer la date de la dernière mise à jour des statistiques, utilisez la fonction [STATS_DATE](/sql/t-sql/functions/stats-date-transact-sql) .</span><span class="sxs-lookup"><span data-stu-id="af16a-259">To determine when statistics were last updated, use the [STATS_DATE](/sql/t-sql/functions/stats-date-transact-sql) function.</span></span>  
  
 <span data-ttu-id="af16a-260">Envisagez de mettre à jour les statistiques dans les cas suivants :</span><span class="sxs-lookup"><span data-stu-id="af16a-260">Consider updating statistics for the following conditions:</span></span>  
  
-   <span data-ttu-id="af16a-261">lenteur d'exécution des requêtes ;</span><span class="sxs-lookup"><span data-stu-id="af16a-261">Query execution times are slow.</span></span>  
  
-   <span data-ttu-id="af16a-262">opérations d'insertion appliquées à des colonnes de clés triées par ordre croissant ou décroissant ;</span><span class="sxs-lookup"><span data-stu-id="af16a-262">Insert operations occur on ascending or descending key columns.</span></span>  
  
-   <span data-ttu-id="af16a-263">opérations de maintenance fraîchement effectuées.</span><span class="sxs-lookup"><span data-stu-id="af16a-263">After maintenance operations.</span></span>  
  
### <a name="query-execution-times-are-slow"></a><span data-ttu-id="af16a-264">Lenteur d'exécution des requêtes</span><span class="sxs-lookup"><span data-stu-id="af16a-264">Query Execution Times Are Slow</span></span>  
 <span data-ttu-id="af16a-265">Si les temps de réponse des requêtes sont longs ou imprévisibles, assurez-vous que les requêtes disposent de statistiques à jour avant d'exécuter d'autres procédures de dépannage.</span><span class="sxs-lookup"><span data-stu-id="af16a-265">If query response times are slow or unpredictable, ensure that queries have up-to-date statistics before performing additional troubleshooting steps.</span></span>  
  
### <a name="insert-operations-occur-on-ascending-or-descending-key-columns"></a><span data-ttu-id="af16a-266">Opérations d'insertion appliquées à des colonnes de clés triées par ordre croissant ou décroissant</span><span class="sxs-lookup"><span data-stu-id="af16a-266">Insert Operations Occur on Ascending or Descending Key Columns</span></span>  
 <span data-ttu-id="af16a-267">Les statistiques sur les colonnes de clés triées par ordre croissant ou décroissant, telles que les colonnes IDENTITY ou les colonnes de type timestamp en temps réel, peuvent nécessiter des mises à jour plus régulières que celles effectuées par l'optimiseur de requête.</span><span class="sxs-lookup"><span data-stu-id="af16a-267">Statistics on ascending or descending key columns, such as IDENTITY or real-time timestamp columns, might require more frequent statistics updates than the query optimizer performs.</span></span> <span data-ttu-id="af16a-268">Les opérations d'insertion ajoutent de nouvelles valeurs aux colonnes triées par ordre croissant ou décroissant.</span><span class="sxs-lookup"><span data-stu-id="af16a-268">Insert operations append new values to ascending or descending columns.</span></span> <span data-ttu-id="af16a-269">Le nombre de lignes ajoutées peut s'avérer trop faible pour déclencher une mise à jour des statistiques.</span><span class="sxs-lookup"><span data-stu-id="af16a-269">The number of rows added might be too small to trigger a statistics update.</span></span> <span data-ttu-id="af16a-270">Si les statistiques ne sont pas à jour et que les requêtes sélectionnent des lignes récemment ajoutées, les statistiques actuelles ne comporteront pas d'estimations de cardinalité pour ces nouvelles valeurs.</span><span class="sxs-lookup"><span data-stu-id="af16a-270">If statistics are not up-to-date and queries select from the most recently added rows, the current statistics will not have cardinality estimates for these new values.</span></span> <span data-ttu-id="af16a-271">Cela peut se traduire par des estimations de cardinalité imprécises et des performances de requêtes en retrait.</span><span class="sxs-lookup"><span data-stu-id="af16a-271">This can result in inaccurate cardinality estimates and slow query performance.</span></span>  
  
 <span data-ttu-id="af16a-272">Par exemple, une requête qui sélectionne des dates de commande parmi les plus récentes présentera des estimations de cardinalité imprécises si les statistiques ne sont pas mises à jour pour inclure les estimations de cardinalité des dates de commande les plus récentes.</span><span class="sxs-lookup"><span data-stu-id="af16a-272">For example, a query that selects from the most recent sales order dates will have inaccurate cardinality estimates if the statistics are not updated to include cardinality estimates for the most recent sales order dates.</span></span>  
  
### <a name="after-maintenance-operations"></a><span data-ttu-id="af16a-273">Opérations de maintenance fraîchement effectuées</span><span class="sxs-lookup"><span data-stu-id="af16a-273">After Maintenance Operations</span></span>  
 <span data-ttu-id="af16a-274">Envisagez de mettre à jour les statistiques après avoir exécuté des procédures de maintenance qui modifient la distribution des données, telles que la troncation d'une table ou l'exécution d'une insertion en bloc d'un fort pourcentage de lignes.</span><span class="sxs-lookup"><span data-stu-id="af16a-274">Consider updating statistics after performing maintenance procedures that change the distribution of data, such as truncating a table or performing a bulk insert of a large percentage of the rows.</span></span> <span data-ttu-id="af16a-275">Vous éviterez ainsi des retards dans le traitement ultérieur des requêtes du fait de l'attente des mises à jour automatiques des statistiques.</span><span class="sxs-lookup"><span data-stu-id="af16a-275">This can avoid future delays in query processing while queries wait for automatic statistics updates.</span></span>  
  
 <span data-ttu-id="af16a-276">Les opérations de reconstruction, de défragmentation ou de réorganisation d'index ne modifient pas la distribution des données.</span><span class="sxs-lookup"><span data-stu-id="af16a-276">Operations such as rebuilding, defragmenting, or reorganizing an index do not change the distribution of data.</span></span> <span data-ttu-id="af16a-277">Par conséquent, vous n'avez pas besoin de mettre à jour les statistiques après avoir effectué des opérations ALTER INDEX REBUILD, DBCC REINDEX, DBCC INDEXDEFRAG ou ALTER INDEX REORGANIZE.</span><span class="sxs-lookup"><span data-stu-id="af16a-277">Therefore, you do not need to update statistics after performing ALTER INDEX REBUILD, DBCC REINDEX, DBCC INDEXDEFRAG, or ALTER INDEX REORGANIZE operations.</span></span> <span data-ttu-id="af16a-278">Si l'optimiseur de requête met effectivement à jour les statistiques lors de la reconstruction d'un index sur une table ou une vue via ALTER INDEX REBUILD ou DBCC DBREINDEX, cette mise à jour des statistiques est une conséquence de la recréation de l'index.</span><span class="sxs-lookup"><span data-stu-id="af16a-278">The query optimizer updates statistics when you rebuild an index on a table or view with ALTER INDEX REBUILD or DBCC DBREINDEX, however; this statistics update is a byproduct of re-creating the index.</span></span> <span data-ttu-id="af16a-279">L'optimiseur de requête ne met pas à jour les statistiques suite à des opérations DBCC INDEXDEFRAG ou ALTER INDEX REORGANIZE.</span><span class="sxs-lookup"><span data-stu-id="af16a-279">The query optimizer does not update statistics after DBCC INDEXDEFRAG or ALTER INDEX REORGANIZE operations.</span></span>  
  
##  <a name="queries-that-use-statistics-effectively"></a><a name="DesignStatistics"></a><span data-ttu-id="af16a-280">Requêtes qui utilisent les statistiques efficacement</span><span class="sxs-lookup"><span data-stu-id="af16a-280">Queries That Use Statistics Effectively</span></span>  
 <span data-ttu-id="af16a-281">Certaines implémentations de requête, telles que les variables locales et les expressions complexes contenues dans le prédicat de requête, peuvent produire des plans de requête non optimaux.</span><span class="sxs-lookup"><span data-stu-id="af16a-281">Certain query implementations, such as local variables and complex expressions in the query predicate, can lead to suboptimal query plans.</span></span> <span data-ttu-id="af16a-282">Cela peut s'éviter en suivant les recommandations en matière de conception de requêtes pour une utilisation efficace des statistiques.</span><span class="sxs-lookup"><span data-stu-id="af16a-282">Following query design guidelines for using statistics effectively can help to avoid this.</span></span> <span data-ttu-id="af16a-283">Pour plus d’informations sur les prédicats de requête, consultez [Condition de recherche &#40;Transact-SQL&#41;](/sql/t-sql/queries/search-condition-transact-sql).</span><span class="sxs-lookup"><span data-stu-id="af16a-283">For more information about query predicates, see [Search Condition &#40;Transact-SQL&#41;](/sql/t-sql/queries/search-condition-transact-sql).</span></span>  
  
 <span data-ttu-id="af16a-284">Vous pouvez améliorer les plans de requête en appliquant les recommandations en matière de conception de requêtes pour une utilisation efficace des statistiques. Les *estimations de cardinalité* relatives aux expressions, aux variables et aux fonctions utilisées dans les prédicats de requête s'en trouveront améliorées.</span><span class="sxs-lookup"><span data-stu-id="af16a-284">You can improve query plans by applying query design guidelines that use statistics effectively to improve *cardinality estimates* for expressions, variables, and functions used in query predicates.</span></span> <span data-ttu-id="af16a-285">Lorsque l'optimiseur de requête ne connaît pas la valeur d'une expression, d'une variable ou d'une fonction, il ne sait pas quelle valeur rechercher dans l'histogramme et ne peut donc pas extraire la meilleure estimation de cardinalité de l'histogramme.</span><span class="sxs-lookup"><span data-stu-id="af16a-285">When the query optimizer does not know the value of an expression, variable, or function, it does not know which value to lookup in the histogram and therefore cannot retrieve the best cardinality estimate from the histogram.</span></span> <span data-ttu-id="af16a-286">Au lieu de cela, l'optimiseur de requête base l'estimation de cardinalité sur le nombre moyen de lignes par valeur distincte pour toutes les lignes échantillonnées dans l'histogramme.</span><span class="sxs-lookup"><span data-stu-id="af16a-286">Instead, the query optimizer bases the cardinality estimate on the average number of rows per distinct value for all of the sampled rows in the histogram.</span></span> <span data-ttu-id="af16a-287">Il en résulte des estimations de cardinalité non optimales et une altération potentielle des performances des requêtes.</span><span class="sxs-lookup"><span data-stu-id="af16a-287">This leads to suboptimal cardinality estimates and can hurt query performance.</span></span>  
  
 <span data-ttu-id="af16a-288">Les recommandations suivantes indiquent comment écrire les requêtes pour améliorer les plans de requête à travers l'amélioration des estimations de cardinalité.</span><span class="sxs-lookup"><span data-stu-id="af16a-288">The following guidelines describe how to write queries to improve query plans by improving cardinality estimates.</span></span>  
  
### <a name="improving-cardinality-estimates-for-expressions"></a><span data-ttu-id="af16a-289">Amélioration des estimations de cardinalité pour les expressions</span><span class="sxs-lookup"><span data-stu-id="af16a-289">Improving Cardinality Estimates for Expressions</span></span>  
 <span data-ttu-id="af16a-290">Pour améliorer les estimations de cardinalité pour les expressions, respectez les principes suivants :</span><span class="sxs-lookup"><span data-stu-id="af16a-290">To improve cardinality estimates for expressions, follow these guidelines:</span></span>  
  
-   <span data-ttu-id="af16a-291">Dans la mesure du possible, simplifiez les expressions en y intégrant des constantes.</span><span class="sxs-lookup"><span data-stu-id="af16a-291">Whenever possible, simplify expressions with constants in them.</span></span> <span data-ttu-id="af16a-292">L'optimiseur de requête n'évalue pas toutes les fonctions et les expressions contenant des constantes avant de déterminer les estimations de cardinalité.</span><span class="sxs-lookup"><span data-stu-id="af16a-292">The query optimizer does not evaluate all functions and expressions containing constants prior to determining cardinality estimates.</span></span> <span data-ttu-id="af16a-293">Par exemple, simplifiez l'expression ABS(`-100) to 100`.</span><span class="sxs-lookup"><span data-stu-id="af16a-293">For example, simplify the expression ABS(`-100) to 100`.</span></span>  
  
-   <span data-ttu-id="af16a-294">Si l'expression utilise plusieurs variables, songez à créer une colonne calculée pour l'expression, puis créez des statistiques ou un index sur la colonne calculée.</span><span class="sxs-lookup"><span data-stu-id="af16a-294">If the expression uses multiple variables, consider creating a computed column for the expression and then create statistics or an index on the computed column.</span></span> <span data-ttu-id="af16a-295">Par exemple, le prédicat de requête `WHERE PRICE + Tax > 100` bénéficiera peut-être d'une meilleure estimation de cardinalité si vous créez une colonne calculée pour l'expression `Price + Tax`.</span><span class="sxs-lookup"><span data-stu-id="af16a-295">For example, the query predicate `WHERE PRICE + Tax > 100` might have a better cardinality estimate if you create a computed column for the expression `Price + Tax`.</span></span>  
  
### <a name="improving-cardinality-estimates-for-variables-and-functions"></a><span data-ttu-id="af16a-296">Amélioration des estimations de cardinalité pour les variables et les fonctions</span><span class="sxs-lookup"><span data-stu-id="af16a-296">Improving Cardinality Estimates for Variables and Functions</span></span>  
 <span data-ttu-id="af16a-297">Pour améliorer les estimations de cardinalité pour les variables et les fonctions, respectez les principes suivants :</span><span class="sxs-lookup"><span data-stu-id="af16a-297">To improve the cardinality estimates for variables and functions, follow these guidelines:</span></span>  
  
-   <span data-ttu-id="af16a-298">Si le prédicat de requête utilise une variable locale, envisagez de réécrire la requête de sorte qu'elle utilise un paramètre au lieu d'une variable locale.</span><span class="sxs-lookup"><span data-stu-id="af16a-298">If the query predicate uses a local variable, consider rewriting the query to use a parameter instead of a local variable.</span></span> <span data-ttu-id="af16a-299">La valeur d'une variable locale n'est pas connue au moment où l'optimiseur de requête crée le plan d'exécution de requête.</span><span class="sxs-lookup"><span data-stu-id="af16a-299">The value of a local variable is not known when the query optimizer creates the query execution plan.</span></span> <span data-ttu-id="af16a-300">Lorsqu'une requête utilise un paramètre, l'optimiseur de requête utilise l'estimation de cardinalité pour la première valeur effective du paramètre qui est transmise à la procédure stockée.</span><span class="sxs-lookup"><span data-stu-id="af16a-300">When a query uses a parameter, the query optimizer uses the cardinality estimate for the first actual parameter value that is passed to the stored procedure.</span></span>  
  
-   <span data-ttu-id="af16a-301">Envisagez d'utiliser une table standard ou une table temporaire pour consigner les résultats de fonctions table à instructions multiples.</span><span class="sxs-lookup"><span data-stu-id="af16a-301">Consider using a standard table or temporary table to hold the results of multi-statement table-valued functions.</span></span> <span data-ttu-id="af16a-302">L'optimiseur de requête ne crée pas de statistiques pour les fonctions table à instructions multiples.</span><span class="sxs-lookup"><span data-stu-id="af16a-302">The query optimizer does not create statistics for multi-statement table-valued functions.</span></span> <span data-ttu-id="af16a-303">Du fait de cette approche, l'optimiseur de requête peut créer des statistiques sur les colonnes de table et s'en servir pour créer un meilleur plan de requête.</span><span class="sxs-lookup"><span data-stu-id="af16a-303">With this approach the query optimizer can create statistics on the table columns and use them to create a better query plan.</span></span>  
  
-   <span data-ttu-id="af16a-304">Envisagez d'utiliser une table standard ou une table temporaire en remplacement de variables de table.</span><span class="sxs-lookup"><span data-stu-id="af16a-304">Consider using a standard table or temporary table as a replacement for table variables.</span></span> <span data-ttu-id="af16a-305">L'optimiseur de requête ne crée pas de statistiques pour les variables de table.</span><span class="sxs-lookup"><span data-stu-id="af16a-305">The query optimizer does not create statistics for table variables.</span></span> <span data-ttu-id="af16a-306">Du fait de cette approche, l'optimiseur de requête peut créer des statistiques sur les colonnes de table et s'en servir pour créer un meilleur plan de requête.</span><span class="sxs-lookup"><span data-stu-id="af16a-306">With this approach the query optimizer can create statistics on the table columns and use them to create a better query plan.</span></span> <span data-ttu-id="af16a-307">Il convient de peser le pour et le contre au moment d'opter pour une table temporaire ou une variable de table : les variables de table utilisées dans les procédures stockées aboutissent à moins de recompilations de ces dernières que les tables temporaires.</span><span class="sxs-lookup"><span data-stu-id="af16a-307">There are tradeoffs in determining whether to use a temporary table or a table variable; Table variables used in stored procedures cause fewer recompilations of the stored procedure than temporary tables.</span></span> <span data-ttu-id="af16a-308">Selon l'application, l'utilisation d'une table temporaire à la place d'une variable de table n'améliorera pas forcément les performances.</span><span class="sxs-lookup"><span data-stu-id="af16a-308">Depending on the application, using a temporary table instead of a table variable might not improve performance.</span></span>  
  
-   <span data-ttu-id="af16a-309">Si une procédure stockée contient une requête qui utilise un paramètre transmis, évitez de modifier la valeur du paramètre dans la procédure stockée avant de l'utiliser dans la requête.</span><span class="sxs-lookup"><span data-stu-id="af16a-309">If a stored procedure contains a query that uses a passed-in parameter, avoid changing the parameter value within the stored procedure before using it in the query.</span></span> <span data-ttu-id="af16a-310">Les estimations de cardinalité de la requête sont basées sur la valeur du paramètre transmis et non sur la valeur mise à jour.</span><span class="sxs-lookup"><span data-stu-id="af16a-310">The cardinality estimates for the query are based on the passed-in parameter value and not the updated value.</span></span> <span data-ttu-id="af16a-311">Pour éviter de modifier la valeur du paramètre, vous pouvez réécrire la requête de sorte qu'elle utilise deux procédures stockées.</span><span class="sxs-lookup"><span data-stu-id="af16a-311">To avoid changing the parameter value, you can rewrite the query to use two stored procedures.</span></span>  
  
     <span data-ttu-id="af16a-312">Par exemple, la procédure stockée suivante `Sales.GetRecentSales` modifie la valeur du paramètre `@date` lorsque `@date is NULL`.</span><span class="sxs-lookup"><span data-stu-id="af16a-312">For example, the following stored procedure `Sales.GetRecentSales` changes the value of the parameter `@date` when `@date is NULL`.</span></span>  
  
    ```  
    USE AdventureWorks2012;  
    GO  
    IF OBJECT_ID ( 'Sales.GetRecentSales', 'P') IS NOT NULL  
        DROP PROCEDURE Sales.GetRecentSales;  
    GO  
    CREATE PROCEDURE Sales.GetRecentSales (@date datetime)  
    AS BEGIN  
        IF @date is NULL  
            SET @date = DATEADD(MONTH, -3, (SELECT MAX(ORDERDATE) FROM Sales.SalesOrderHeader))  
        SELECT * FROM Sales.SalesOrderHeader h, Sales.SalesOrderDetail d  
        WHERE h.SalesOrderID = d.SalesOrderID  
        AND h.OrderDate > @date  
    END  
    GO  
    ```  
  
     <span data-ttu-id="af16a-313">Si le premier appel à la procédure stockée `Sales.GetRecentSales` transmet une valeur NULL pour le paramètre `@date` , l'optimiseur de requête compilera la procédure stockée avec l'estimation de cardinalité de `@date = NULL` même si le prédicat de requête n'est pas appelé avec `@date = NULL`.</span><span class="sxs-lookup"><span data-stu-id="af16a-313">If the first call to the stored procedure `Sales.GetRecentSales` passes a NULL for the `@date` parameter, the query optimizer will compile the stored procedure with the cardinality estimate for `@date = NULL` even though the query predicate is not called with `@date = NULL`.</span></span> <span data-ttu-id="af16a-314">Il se peut que cette estimation de cardinalité soit sensiblement différente du nombre de lignes présenté dans le résultat réel de la requête.</span><span class="sxs-lookup"><span data-stu-id="af16a-314">This cardinality estimate might be significantly different than the number of rows in the actual query result.</span></span> <span data-ttu-id="af16a-315">En conséquence, l'optimiseur de requête risque de choisir un plan de requête non optimisé.</span><span class="sxs-lookup"><span data-stu-id="af16a-315">As a result, the query optimizer might choose a suboptimal query plan.</span></span> <span data-ttu-id="af16a-316">Pour éviter cela, vous pouvez réécrire la procédure stockée dans deux procédures comme dans l'exemple suivant :</span><span class="sxs-lookup"><span data-stu-id="af16a-316">To help avoid this, you can rewrite the stored procedure into two procedures as follows:</span></span>  
  
    ```  
    USE AdventureWorks2012;  
    GO  
    IF OBJECT_ID ( 'Sales.GetNullRecentSales', 'P') IS NOT NULL  
        DROP PROCEDURE Sales.GetNullRecentSales;  
    GO  
    CREATE PROCEDURE Sales.GetNullRecentSales (@date datetime)  
    AS BEGIN  
        IF @date is NULL  
            SET @date = DATEADD(MONTH, -3, (SELECT MAX(ORDERDATE) FROM Sales.SalesOrderHeader))  
        EXEC Sales.GetNonNullRecentSales @date;  
    END  
    GO  
    IF OBJECT_ID ( 'Sales.GetNonNullRecentSales', 'P') IS NOT NULL  
        DROP PROCEDURE Sales.GetNonNullRecentSales;  
    GO  
    CREATE PROCEDURE Sales.GetNonNullRecentSales (@date datetime)  
    AS BEGIN  
        SELECT * FROM Sales.SalesOrderHeader h, Sales.SalesOrderDetail d  
        WHERE h.SalesOrderID = d.SalesOrderID  
        AND h.OrderDate > @date  
    END  
    GO  
    ```  
  
### <a name="improving-cardinality-estimates-with-query-hints"></a><span data-ttu-id="af16a-317">Amélioration des estimations de cardinalité au moyen d'indicateurs de requête</span><span class="sxs-lookup"><span data-stu-id="af16a-317">Improving Cardinality Estimates with Query Hints</span></span>  
 <span data-ttu-id="af16a-318">Pour améliorer les estimations de cardinalité des variables locales, vous pouvez utiliser les indicateurs de requête OPTIMIZE FOR ou OPTIMIZE FOR UNKNOWN avec RECOMPILE.</span><span class="sxs-lookup"><span data-stu-id="af16a-318">To improve cardinality estimates for local variables, you can use the OPTIMIZE FOR or OPTIMIZE FOR UNKNOWN query hints with RECOMPILE.</span></span> <span data-ttu-id="af16a-319">Pour plus d’informations, consultez [Indicateurs de requête &#40;Transact-SQL&#41;](/sql/t-sql/queries/hints-transact-sql-query).</span><span class="sxs-lookup"><span data-stu-id="af16a-319">For more information, see [Query Hints &#40;Transact-SQL&#41;](/sql/t-sql/queries/hints-transact-sql-query).</span></span>  
  
 <span data-ttu-id="af16a-320">Pour certaines applications, la recompilation de la requête à chacune de ses exécutions peu prendre trop de temps.</span><span class="sxs-lookup"><span data-stu-id="af16a-320">For some applications, recompiling the query each time it executes might take too much time.</span></span> <span data-ttu-id="af16a-321">L'indicateur de requête OPTIMIZER FOR peut s'avérer utile même si vous n'utilisez pas l'option RECOMPILE.</span><span class="sxs-lookup"><span data-stu-id="af16a-321">The OPTIMIZER FOR query hint can help even if you don't use the RECOMPILE option.</span></span> <span data-ttu-id="af16a-322">Par exemple, vous pouvez ajouter une option OPTIMIZER FOR à la procédure stockée Sales.GetRecentSales pour spécifier une date précise.</span><span class="sxs-lookup"><span data-stu-id="af16a-322">For example, you could add an OPTIMIZER FOR option to the stored procedure Sales.GetRecentSales to specify a specific date.</span></span> <span data-ttu-id="af16a-323">L'exemple suivant ajoute l'option OPTIMIZER FOR à la procédure Sales.GetRecentSales.</span><span class="sxs-lookup"><span data-stu-id="af16a-323">The following example adds the OPTIMIZE FOR option to the Sales.GetRecentSales procedure.</span></span>  
  
```sql
USE AdventureWorks2012;  
GO  
IF OBJECT_ID ( 'Sales.GetRecentSales', 'P') IS NOT NULL  
    DROP PROCEDURE Sales.GetRecentSales;  
GO  
CREATE PROCEDURE Sales.GetRecentSales (@date datetime)  
AS BEGIN  
    IF @date is NULL  
        SET @date = DATEADD(MONTH, -3, (SELECT MAX(ORDERDATE) FROM Sales.SalesOrderHeader))  
    SELECT * FROM Sales.SalesOrderHeader h, Sales.SalesOrderDetail d  
    WHERE h.SalesOrderID = d.SalesOrderID  
    AND h.OrderDate > @date  
    OPTION ( OPTIMIZE FOR ( @date = '2004-05-01 00:00:00.000'))  
END;  
GO  
```  
  
### <a name="improving-cardinality-estimates-with-plan-guides"></a><span data-ttu-id="af16a-324">Amélioration des estimations de cardinalité au moyen de repères de plan</span><span class="sxs-lookup"><span data-stu-id="af16a-324">Improving Cardinality Estimates with Plan Guides</span></span>  
 <span data-ttu-id="af16a-325">Pour certaines applications, les recommandations en matière de conception de requêtes peuvent ne pas s'appliquer, soit parce que vous ne pouvez pas modifier la requête, soit parce que l'utilisation de l'indicateur de requête RECOMPILE peut entraîner un nombre trop important de recompilations.</span><span class="sxs-lookup"><span data-stu-id="af16a-325">For some applications, query design guidelines might not apply because you cannot change the query or using the RECOMPILE query hint might be cause too many recompiles.</span></span> <span data-ttu-id="af16a-326">Vous pouvez utiliser des repères de plan pour spécifier d'autres indicateurs, tels que USE PLAN, dans le but de contrôler le comportement de la requête, en attendant de trouver une solution avec l'éditeur de l'application.</span><span class="sxs-lookup"><span data-stu-id="af16a-326">You can use plan guides to specify other hints, such as USE PLAN, to control the behavior of the query while investigating application changes with the application vendor.</span></span> <span data-ttu-id="af16a-327">Pour plus d'informations sur les repères de plan, consultez [Plan Guides](../performance/plan-guides.md).</span><span class="sxs-lookup"><span data-stu-id="af16a-327">For more information about plan guides, see [Plan Guides](../performance/plan-guides.md).</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="af16a-328">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="af16a-328">See Also</span></span>  
 <span data-ttu-id="af16a-329">[CREATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-statistics-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="af16a-329">[CREATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-statistics-transact-sql) </span></span>  
 <span data-ttu-id="af16a-330">[UPDATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/update-statistics-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="af16a-330">[UPDATE STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/update-statistics-transact-sql) </span></span>  
 <span data-ttu-id="af16a-331">[sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="af16a-331">[sp_updatestats &#40;Transact-SQL&#41;](/sql/relational-databases/system-stored-procedures/sp-updatestats-transact-sql) </span></span>  
 <span data-ttu-id="af16a-332">[DBCC SHOW_STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-show-statistics-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="af16a-332">[DBCC SHOW_STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/database-console-commands/dbcc-show-statistics-transact-sql) </span></span>  
 <span data-ttu-id="af16a-333">[Options ALTER DATABASE SET &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql-set-options) </span><span class="sxs-lookup"><span data-stu-id="af16a-333">[ALTER DATABASE SET Options &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-database-transact-sql-set-options) </span></span>  
 <span data-ttu-id="af16a-334">[DROP STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/drop-statistics-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="af16a-334">[DROP STATISTICS &#40;Transact-SQL&#41;](/sql/t-sql/statements/drop-statistics-transact-sql) </span></span>  
 <span data-ttu-id="af16a-335">[CREATE INDEX &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-index-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="af16a-335">[CREATE INDEX &#40;Transact-SQL&#41;](/sql/t-sql/statements/create-index-transact-sql) </span></span>  
 <span data-ttu-id="af16a-336">[ALTER INDEX &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-index-transact-sql) </span><span class="sxs-lookup"><span data-stu-id="af16a-336">[ALTER INDEX &#40;Transact-SQL&#41;](/sql/t-sql/statements/alter-index-transact-sql) </span></span>  
 [<span data-ttu-id="af16a-337">Créer des index filtrés</span><span class="sxs-lookup"><span data-stu-id="af16a-337">Create Filtered Indexes</span></span>](../indexes/create-filtered-indexes.md)  
