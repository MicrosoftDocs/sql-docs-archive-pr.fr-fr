---
title: Préparation de commandes | Microsoft Docs
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: native-client
ms.topic: reference
helpviewer_keywords:
- SQL Server Native Client OLE DB provider, commands
- prepared statements [SQL Server Native Client]
- commands [OLE DB]
- command preparation [SQL Server Native Client]
ms.assetid: 09ec0c6c-0a44-4766-b9b7-5092f676ee54
author: rothja
ms.author: jroth
ms.openlocfilehash: e06e6afab622953452a00751e3a55d49fc7b8ec7
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87696836"
---
# <a name="preparing-commands"></a><span data-ttu-id="75ae8-102">Préparation des commandes</span><span class="sxs-lookup"><span data-stu-id="75ae8-102">Preparing Commands</span></span>
  <span data-ttu-id="75ae8-103">Le fournisseur OLE DB [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client prend en charge la préparation de commande pour l'exécution multiple optimisée d'une commande unique ; toutefois, la préparation de commande génère une charge mémoire et un consommateur n'a pas besoin de préparer une commande pour l'exécuter plus d'une fois.</span><span class="sxs-lookup"><span data-stu-id="75ae8-103">The [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB provider supports command preparation for optimized multiple execution of a single command; however, command preparation generates overhead, and a consumer does not need to prepare a command to execute it more than once.</span></span> <span data-ttu-id="75ae8-104">En général, la préparation de commande est nécessaire si celle-ci doit être exécutée plus de trois fois.</span><span class="sxs-lookup"><span data-stu-id="75ae8-104">In general, a command should be prepared if it will be executed more than three times.</span></span>  
  
 <span data-ttu-id="75ae8-105">Pour des raisons de performance, la préparation de commande est différée jusqu'à ce que la commande soit exécutée.</span><span class="sxs-lookup"><span data-stu-id="75ae8-105">For performance reasons, the command preparation is deferred until the command is executed.</span></span> <span data-ttu-id="75ae8-106">Il s'agit du comportement par défaut.</span><span class="sxs-lookup"><span data-stu-id="75ae8-106">This is the default behavior.</span></span> <span data-ttu-id="75ae8-107">Toute erreur dans la commande en cours de préparation est inconnue tant que la commande n'a pas été exécutée ou qu'une opération de métapropriété n'a pas été effectuée.</span><span class="sxs-lookup"><span data-stu-id="75ae8-107">Any errors in the command being prepared are not known until the command is executed or a metaproperty operation is performed.</span></span> <span data-ttu-id="75ae8-108">L'affectation de la valeur FALSE à la propriété [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] SSPROP_DEFERPREPARE peut désactiver ce comportement par défaut.</span><span class="sxs-lookup"><span data-stu-id="75ae8-108">Setting the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] property SSPROP_DEFERPREPARE to FALSE can turn off this default behavior.</span></span>  
  
 <span data-ttu-id="75ae8-109">Dans [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], lorsqu'une commande est exécutée directement (sans la préparer au préalable), un plan d'exécution est créé et mis en cache.</span><span class="sxs-lookup"><span data-stu-id="75ae8-109">In [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)], when a command is executed directly (without preparing it first), an execution plan is created and cached.</span></span> <span data-ttu-id="75ae8-110">Si l'instruction SQL est réexécutée, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] dispose d'un algorithme efficace pour faire correspondre la nouvelle instruction au plan d'exécution existant dans le cache et réutilise le plan d'exécution pour cette instruction.</span><span class="sxs-lookup"><span data-stu-id="75ae8-110">If the SQL statement is executed again, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] has an efficient algorithm to match the new statement with the existing execution plan in the cache, and reuses the execution plan for that statement.</span></span>  
  
 <span data-ttu-id="75ae8-111">Pour les commandes préparées, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] fournit la prise en charge native de la préparation et de l'exécution des instructions de commande.</span><span class="sxs-lookup"><span data-stu-id="75ae8-111">For prepared commands, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] provides native support for preparing and executing command statements.</span></span> <span data-ttu-id="75ae8-112">Lorsque vous préparez une instruction, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] crée un plan d'exécution, le met en cache et retourne un handle de ce plan d'exécution au fournisseur.</span><span class="sxs-lookup"><span data-stu-id="75ae8-112">When you prepare a statement, [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] creates an execution plan, caches it, and returns a handle to this execution plan to the provider.</span></span> <span data-ttu-id="75ae8-113">Le fournisseur utilise ensuite ce handle pour exécuter l'instruction à plusieurs reprises.</span><span class="sxs-lookup"><span data-stu-id="75ae8-113">The provider then uses this handle to execute the statement repeatedly.</span></span> <span data-ttu-id="75ae8-114">Aucune procédure stockée n'est créée.</span><span class="sxs-lookup"><span data-stu-id="75ae8-114">No stored procedures are created.</span></span> <span data-ttu-id="75ae8-115">Étant donné que le handle identifie directement le plan d'exécution pour une instruction SQL au lieu de faire correspondre l'instruction au plan d'exécution dans le cache (comme c'est le cas pour l'exécution directe), il est plus efficace de préparer une instruction que de l'exécuter directement, si vous savez que l'instruction sera exécutée plusieurs fois.</span><span class="sxs-lookup"><span data-stu-id="75ae8-115">Because the handle directly identifies the execution plan for an SQL statement instead of matching the statement to the execution plan in the cache (as is the case for direct execution), it is more efficient to prepare a statement than to execute it directly, if you know the statement will be executed more than a few times.</span></span>  
  
 <span data-ttu-id="75ae8-116">Dans [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)], les instructions préparées ne peuvent pas être utilisées pour créer des objets temporaires et elles ne peuvent pas référencer des procédures stockées système qui créent des objets temporaires, comme des tables temporaires.</span><span class="sxs-lookup"><span data-stu-id="75ae8-116">In [!INCLUDE[ssVersion2005](../../includes/ssversion2005-md.md)], the prepared statements cannot be used to create temporary objects and cannot reference system stored procedures that create temporary objects, such as temporary tables.</span></span> <span data-ttu-id="75ae8-117">Ces procédures doivent être exécutées directement.</span><span class="sxs-lookup"><span data-stu-id="75ae8-117">These procedures must be executed directly.</span></span>  
  
 <span data-ttu-id="75ae8-118">Certaines commandes ne doivent jamais être préparées.</span><span class="sxs-lookup"><span data-stu-id="75ae8-118">Some commands should never be prepared.</span></span> <span data-ttu-id="75ae8-119">Par exemple, les commandes qui spécifient l'exécution de procédure stockée ou incluent du texte non valide pour la création de procédure stockée [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] ne doivent pas être préparées.</span><span class="sxs-lookup"><span data-stu-id="75ae8-119">For example, commands that specify stored procedure execution or include invalid text for [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] stored procedure creation should not be prepared.</span></span>  
  
 <span data-ttu-id="75ae8-120">Si une procédure stockée temporaire est créée, le fournisseur OLE DB [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client exécute la procédure stockée temporaire et retourne des résultats comme si l'instruction elle-même avait été exécutée.</span><span class="sxs-lookup"><span data-stu-id="75ae8-120">If a temporary stored procedure is created, the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB provider executes the temporary stored procedure, returning results as if the statement itself was executed.</span></span>  
  
 <span data-ttu-id="75ae8-121">La création de procédure stockée temporaire est contrôlée par la propriété d'initialisation spécifique au fournisseur OLE DB [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client SSPROP_INIT_USEPROCFORPREP.</span><span class="sxs-lookup"><span data-stu-id="75ae8-121">Temporary stored procedure creation is controlled by the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB provider -specific initialization property SSPROP_INIT_USEPROCFORPREP.</span></span> <span data-ttu-id="75ae8-122">Si la valeur de propriété est SSPROPVAL_USEPROCFORPREP_ON ou SSPROPVAL_USEPROCFORPREP_ON_DROP, le fournisseur OLE DB [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client essaie de créer une procédure stockée lorsqu'une commande est préparée.</span><span class="sxs-lookup"><span data-stu-id="75ae8-122">If the property value is either SSPROPVAL_USEPROCFORPREP_ON or SSPROPVAL_USEPROCFORPREP_ON_DROP, the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB provider attempts to create a stored procedure when a command is prepared.</span></span> <span data-ttu-id="75ae8-123">La création de procédure stockée réussit si l'utilisateur d'application a des autorisations [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] suffisantes.</span><span class="sxs-lookup"><span data-stu-id="75ae8-123">Stored procedure creation succeeds if the application user has sufficient [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] permissions.</span></span>  
  
 <span data-ttu-id="75ae8-124">Pour les consommateurs qui se déconnectent rarement, la création de procédures stockées temporaires peut nécessiter des ressources significatives de **tempdb**, la base de données système de [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] où les objets temporaires sont créés.</span><span class="sxs-lookup"><span data-stu-id="75ae8-124">For consumers that infrequently disconnect, creation of temporary stored procedures can require significant resources of **tempdb**, the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] system database in which temporary objects are created.</span></span> <span data-ttu-id="75ae8-125">Lorsque la valeur de SSPROP_INIT_USEPROCFORPREP est SSPROPVAL_USEPROCFORPREP_ ON, les procédures stockées temporaires créées par le fournisseur OLE DB [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client sont supprimées uniquement lorsque la session qui a créé la commande perd sa connexion à l'instance de [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span><span class="sxs-lookup"><span data-stu-id="75ae8-125">When the value of SSPROP_INIT_USEPROCFORPREP is SSPROPVAL_USEPROCFORPREP_ ON, temporary stored procedures created by the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB provider are dropped only when the session that created the command loses its connection to the instance of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)].</span></span> <span data-ttu-id="75ae8-126">Si cette connexion est la connexion par défaut créée lors de l'initialisation de la source de données, la procédure stockée temporaire est supprimée uniquement lorsque la source de données devient non initialisée.</span><span class="sxs-lookup"><span data-stu-id="75ae8-126">If that connection is the default connection created on data source initialization, the temporary stored procedure is dropped only when the data source becomes uninitialized.</span></span>  
  
 <span data-ttu-id="75ae8-127">Lorsque la valeur de SSPROP_INIT_USEPROCFORPREP est SSPROPVAL_USEPROCFORPREP_ON_DROP, les procédures stockées temporaires du fournisseur OLE DB [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client sont supprimées lorsque l'un des événements suivants se produit :</span><span class="sxs-lookup"><span data-stu-id="75ae8-127">When the value of SSPROP_INIT_USEPROCFORPREP is SSPROPVAL_USEPROCFORPREP_ON_DROP, the [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)] Native Client OLE DB provider temporary stored procedures are dropped when one of the following occurs:</span></span>  
  
-   <span data-ttu-id="75ae8-128">Le consommateur utilise **ICommandText::SetCommandText** pour indiquer une nouvelle commande.</span><span class="sxs-lookup"><span data-stu-id="75ae8-128">The consumer uses **ICommandText::SetCommandText** to indicate a new command.</span></span>  
  
-   <span data-ttu-id="75ae8-129">Le consommateur utilise **ICommandPrepare::Unprepare** pour indiquer qu’il n’a plus besoin du texte de la commande.</span><span class="sxs-lookup"><span data-stu-id="75ae8-129">The consumer uses **ICommandPrepare::Unprepare** to indicate that it no longer requires the command text.</span></span>  
  
-   <span data-ttu-id="75ae8-130">Le consommateur libère toutes les références à l'objet de commande à l'aide de la procédure stockée temporaire.</span><span class="sxs-lookup"><span data-stu-id="75ae8-130">The consumer releases all references to the command object using the temporary stored procedure.</span></span>  
  
 <span data-ttu-id="75ae8-131">Un objet de commande a au plus une procédure stockée temporaire dans **tempdb**.</span><span class="sxs-lookup"><span data-stu-id="75ae8-131">A command object has at most one temporary stored procedure in **tempdb**.</span></span> <span data-ttu-id="75ae8-132">Toute procédure stockée temporaire existante représente le texte de commande actuel d'un objet de commande spécifique.</span><span class="sxs-lookup"><span data-stu-id="75ae8-132">Any existing temporary stored procedure represents the current command text of a specific command object.</span></span>  
  
## <a name="see-also"></a><span data-ttu-id="75ae8-133">Voir aussi</span><span class="sxs-lookup"><span data-stu-id="75ae8-133">See Also</span></span>  
 [<span data-ttu-id="75ae8-134">Commandes</span><span class="sxs-lookup"><span data-stu-id="75ae8-134">Commands</span></span>](commands.md)  
  
  
