---
title: MERGE dans les packages Integration Services | Microsoft Docs
ms.custom: ''
ms.date: 03/06/2017
ms.prod: sql-server-2014
ms.reviewer: ''
ms.technology: integration-services
ms.topic: conceptual
helpviewer_keywords:
- MERGE statement [SQL Server]
ms.assetid: 7e44a5c2-e6d6-4fe2-a079-4f95ccdb147b
author: chugugrace
ms.author: chugu
ms.openlocfilehash: cc6de738d44b91a9e2a4885978ba4a46dfede8cf
ms.sourcegitcommit: ad4d92dce894592a259721a1571b1d8736abacdb
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 08/04/2020
ms.locfileid: "87604065"
---
# <a name="merge-in-integration-services-packages"></a><span data-ttu-id="f7747-102">MERGE in Integration Services Packages</span><span class="sxs-lookup"><span data-stu-id="f7747-102">MERGE in Integration Services Packages</span></span>
  <span data-ttu-id="f7747-103">Dans la version actuelle de [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)][!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)], l’instruction SQL d’une tâche d’exécution SQL peut contenir une instruction MERGE.</span><span class="sxs-lookup"><span data-stu-id="f7747-103">In the current release of [!INCLUDE[ssNoVersion](../../includes/ssnoversion-md.md)][!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)], the SQL statement in an Execute SQL task can contain a MERGE statement.</span></span> <span data-ttu-id="f7747-104">Cette instruction MERGE vous permet d'accomplir plusieurs opérations INSERT, UPDATE et DELETE dans une même instruction.</span><span class="sxs-lookup"><span data-stu-id="f7747-104">This MERGE statement enables you to accomplish multiple INSERT, UPDATE, and DELETE operations in a single statement.</span></span>  
  
 <span data-ttu-id="f7747-105">Pour utiliser l'instruction MERGE dans un package, procédez comme suit :</span><span class="sxs-lookup"><span data-stu-id="f7747-105">To use the MERGE statement in a package, follow these steps:</span></span>  
  
-   <span data-ttu-id="f7747-106">Créez une tâche de flux de données qui charge, transforme et enregistre les données sources dans une table temporaire ou intermédiaire.</span><span class="sxs-lookup"><span data-stu-id="f7747-106">Create a Data Flow task that loads, transforms, and saves the source data to a temporary or staging table.</span></span>  
  
-   <span data-ttu-id="f7747-107">Créez une tâche d'exécution SQL contenant l'instruction MERGE.</span><span class="sxs-lookup"><span data-stu-id="f7747-107">Create an Execute SQL task that contains the MERGE statement.</span></span>  
  
-   <span data-ttu-id="f7747-108">Connectez la tâche de flux de données à la tâche d'exécution SQL et utilisez les données de la table intermédiaire comme entrée pour l'instruction MERGE.</span><span class="sxs-lookup"><span data-stu-id="f7747-108">Connect the Data Flow task to the Execute SQL task, and use the data in the staging table as the input for the MERGE statement.</span></span>  
  
    > [!NOTE]  
    >  <span data-ttu-id="f7747-109">Bien qu'une instruction MERGE requière en général une table intermédiaire dans ce scénario, les performances de l'instruction MERGE dépassent habituellement celles de la recherche ligne par ligne effectuée par la transformation de recherche.</span><span class="sxs-lookup"><span data-stu-id="f7747-109">Although a MERGE statement typically requires a staging table in this scenario, the performance of the MERGE statement usually exceeds that of the row-by-row lookup performed by the Lookup transformation.</span></span> <span data-ttu-id="f7747-110">L'instruction MERGE est également utile lorsque la grande taille d'une table de recherche pourrait tester la mémoire mise à la disposition de la transformation de recherche pour mettre en cache sa table de référence.</span><span class="sxs-lookup"><span data-stu-id="f7747-110">MERGE is also useful when the large size of a lookup table would test the memory that is available to the Lookup transformation for caching its reference table.</span></span>  
  
 <span data-ttu-id="f7747-111">Le reste de cette rubrique présente d'autres utilisations possibles de l'instruction MERGE.</span><span class="sxs-lookup"><span data-stu-id="f7747-111">The remainder of this topic discusses some additional uses for the MERGE statement.</span></span>  
  
 <span data-ttu-id="f7747-112">Pour obtenir un exemple de composant de destination prenant en charge l'utilisation de l'instruction MERGE, consultez l'exemple de la communauté CodePlex, [Destination de l'instruction MERGE](https://go.microsoft.com/fwlink/?LinkId=141215).</span><span class="sxs-lookup"><span data-stu-id="f7747-112">For a sample destination component that supports the use of the MERGE statement, see the CodePlex community sample, [MERGE Destination](https://go.microsoft.com/fwlink/?LinkId=141215).</span></span>  
  
## <a name="using-merge"></a><span data-ttu-id="f7747-113">Utilisation de MERGE</span><span class="sxs-lookup"><span data-stu-id="f7747-113">Using MERGE</span></span>  
 <span data-ttu-id="f7747-114">En général, vous utilisez l'instruction MERGE lorsque vous souhaitez appliquer des modifications qui incluent des insertions, des mises à jour et des suppressions d'une table à une autre table.</span><span class="sxs-lookup"><span data-stu-id="f7747-114">Typically, you use the MERGE statement when you want to apply changes that include inserts, updates, and deletions from one table to another table.</span></span> <span data-ttu-id="f7747-115">Avant [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)], ce processus requérait à la fois une transformation de recherche et plusieurs transformations de commande OLE DB.</span><span class="sxs-lookup"><span data-stu-id="f7747-115">Prior to [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)], this process required both a Lookup transformation and multiple OLE DB Command transformations.</span></span> <span data-ttu-id="f7747-116">La transformation de recherche effectuait une recherche ligne par ligne pour déterminer si chaque ligne était nouvelle ou modifiée.</span><span class="sxs-lookup"><span data-stu-id="f7747-116">The Lookup transformation performed a row-by-row lookup to determine whether each row was new or changed.</span></span> <span data-ttu-id="f7747-117">Les transformations de commande OLE DB effectuaient alors les opérations INSERT, UPDATE et DELETE nécessaires.</span><span class="sxs-lookup"><span data-stu-id="f7747-117">The OLE DB Command transformations then performed the necessary INSERT, UPDATE, and DELETE operations.</span></span> <span data-ttu-id="f7747-118">À compter de [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)], une instruction MERGE unique peut remplacer la transformation de recherche et les transformations de commande OLE DB correspondantes réunies.</span><span class="sxs-lookup"><span data-stu-id="f7747-118">Beginning in [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)], a single MERGE statement can replace both the Lookup transformation and the corresponding OLE DB Command transformations.</span></span>  
  
### <a name="merge-with-incremental-loads"></a><span data-ttu-id="f7747-119">MERGE avec des charges incrémentielles</span><span class="sxs-lookup"><span data-stu-id="f7747-119">MERGE with Incremental Loads</span></span>  
 <span data-ttu-id="f7747-120">Les fonctionnalités de capture de données modifiées, nouvelles dans [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)] , permettent d'effectuer de manière fiable des charges incrémentielles dans un entrepôt de données.</span><span class="sxs-lookup"><span data-stu-id="f7747-120">The change data capture functionality that is new in [!INCLUDE[ssKatmai](../../includes/sskatmai-md.md)] makes it easier to perform incremental loads reliably to a data warehouse.</span></span> <span data-ttu-id="f7747-121">Comme alternative à l'utilisation de transformations de commande OLE DB paramétrables pour effectuer les insertions et les mises à jour, vous pouvez utiliser l'instruction MERGE pour associer ces deux types d'opérations.</span><span class="sxs-lookup"><span data-stu-id="f7747-121">As an alternative to using parameterized OLE DB Command transformations to perform the inserts and the updates, you can use the MERGE statement to combine both operations.</span></span>  
  
 <span data-ttu-id="f7747-122">Pour plus d’informations, consultez [Appliquer les modifications à la destination](../change-data-capture/apply-the-changes-to-the-destination.md).</span><span class="sxs-lookup"><span data-stu-id="f7747-122">For more information, see [Apply the Changes to the Destination](../change-data-capture/apply-the-changes-to-the-destination.md).</span></span>  
  
#### <a name="merge-in-other-scenarios"></a><span data-ttu-id="f7747-123">MERGE dans d'autres scénarios</span><span class="sxs-lookup"><span data-stu-id="f7747-123">MERGE in Other Scenarios</span></span>  
 <span data-ttu-id="f7747-124">Dans les scénarios suivants, vous pouvez utiliser l'instruction MERGE à l'extérieur ou à l'intérieur d'un package [!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)] .</span><span class="sxs-lookup"><span data-stu-id="f7747-124">In the following scenarios, you can use the MERGE statement either outside or inside an [!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)] package.</span></span> <span data-ttu-id="f7747-125">Toutefois, un package [!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)] est souvent requis pour charger les données à partir de plusieurs sources hétérogènes, puis pour associer et assainir ces données.</span><span class="sxs-lookup"><span data-stu-id="f7747-125">However, an [!INCLUDE[ssISnoversion](../../includes/ssisnoversion-md.md)] package is often required to load this data from multiple heterogeneous sources, and then to combine and cleanse the data.</span></span> <span data-ttu-id="f7747-126">Par conséquent, vous pouvez envisager d'utiliser l'instruction MERGE dans un package pour le côté pratique et pour faciliter la maintenance.</span><span class="sxs-lookup"><span data-stu-id="f7747-126">Therefore, you might consider using the MERGE statement in a package for convenience and ease of maintenance.</span></span>  
  
##### <a name="track-buying-habits"></a><span data-ttu-id="f7747-127">Assurer le suivi des habitudes d'achat</span><span class="sxs-lookup"><span data-stu-id="f7747-127">Track Buying Habits</span></span>  
 <span data-ttu-id="f7747-128">La table FactBuyingHabits incluse dans l'entrepôt de données indique la dernière date à laquelle un client a acheté un produit donné.</span><span class="sxs-lookup"><span data-stu-id="f7747-128">The FactBuyingHabits table in the data warehouse tracks the last date on which a customer bought a given product.</span></span> <span data-ttu-id="f7747-129">La table se compose des colonnes ProductID, CustomerID et PurchaseDate.</span><span class="sxs-lookup"><span data-stu-id="f7747-129">The table consists of ProductID, CustomerID and PurchaseDate columns.</span></span> <span data-ttu-id="f7747-130">Chaque semaine, la base de données transactionnelle génère une table PurchaseRecords qui inclut les achats effectués pendant la semaine.</span><span class="sxs-lookup"><span data-stu-id="f7747-130">Every week, the transactional database generates a PurchaseRecords table that includes the purchases made during that week.</span></span> <span data-ttu-id="f7747-131">L'objectif est d'utiliser une instruction MERGE unique pour fusionner les informations de la table PurchaseRecords dans la table FactBuyingHabits.</span><span class="sxs-lookup"><span data-stu-id="f7747-131">The objective is to use a single MERGE statement to merge the information in the PurchaseRecords table into the FactBuyingHabits table.</span></span> <span data-ttu-id="f7747-132">Pour les paires client–produit qui n'existent pas, l'instruction MERGE insère de nouvelles lignes.</span><span class="sxs-lookup"><span data-stu-id="f7747-132">For product-customer pairs that do not exist, the MERGE statement inserts new rows.</span></span> <span data-ttu-id="f7747-133">Pour les paires client–produit qui existent, l'instruction MERGE met à jour la date d'achat la plus récente.</span><span class="sxs-lookup"><span data-stu-id="f7747-133">For product-customer pairs that exist, the MERGE statement updates the most recent date-of-purchase.</span></span>  
  
###### <a name="track-price-history"></a><span data-ttu-id="f7747-134">Assurer le suivi de l'historique des prix</span><span class="sxs-lookup"><span data-stu-id="f7747-134">Track Price History</span></span>  
 <span data-ttu-id="f7747-135">La table DimBook représente la liste des livres dans l'inventaire d'un libraire et identifie l'historique des prix de chaque ouvrage.</span><span class="sxs-lookup"><span data-stu-id="f7747-135">The DimBook table represents the list of books in the inventory of a book seller and identifies the price history of each book.</span></span> <span data-ttu-id="f7747-136">Cette table inclut les colonnes : ISBN, ProductID, Price, Shelf et IsCurrent.</span><span class="sxs-lookup"><span data-stu-id="f7747-136">This table has these columns: ISBN, ProductID, Price, Shelf, and IsCurrent.</span></span> <span data-ttu-id="f7747-137">Cette table possède également une ligne pour chaque prix que le livre a eu.</span><span class="sxs-lookup"><span data-stu-id="f7747-137">This table also has one row for each price the book has had.</span></span> <span data-ttu-id="f7747-138">L'une de ces lignes contient le prix actuel.</span><span class="sxs-lookup"><span data-stu-id="f7747-138">One of these rows contains the current price.</span></span> <span data-ttu-id="f7747-139">Pour indiquer la ligne qui contient le prix actuel, la valeur de la colonne IsCurrent est égale à 1 pour cette ligne.</span><span class="sxs-lookup"><span data-stu-id="f7747-139">To indicate which row contains the current price, the value of the IsCurrent column for that row is set to 1.</span></span>  
  
 <span data-ttu-id="f7747-140">Chaque semaine, la base de données génère une table WeeklyChanges qui contient les modifications des prix pour la semaine et les nouveaux livres qui ont été ajoutés pendant la semaine.</span><span class="sxs-lookup"><span data-stu-id="f7747-140">Every week, the database generates a WeeklyChanges table that contains price changes for the week and new books that were added during the week.</span></span> <span data-ttu-id="f7747-141">En utilisant une instruction MERGE unique, vous pouvez appliquer les modifications présentes dans la table WeeklyChanges à la table DimBook.</span><span class="sxs-lookup"><span data-stu-id="f7747-141">By using a single MERGE statement, you can apply the changes in the WeeklyChanges table to the DimBook table.</span></span> <span data-ttu-id="f7747-142">L'instruction MERGE insère de nouvelles lignes pour les nouveaux livres ajoutés et met à jour la colonne IsCurrent en spécifiant 0 pour les lignes des livres existants dont le prix a changé.</span><span class="sxs-lookup"><span data-stu-id="f7747-142">The MERGE statement inserts new rows for newly-added books, and updates the IsCurrent column to 0 for rows of existing books whose prices have changed.</span></span> <span data-ttu-id="f7747-143">L'instruction MERGE insère également de nouvelles lignes pour les livres dont le prix a changé et, pour ces nouvelles lignes, elle affecte la valeur 1 à la colonne IsCurrent.</span><span class="sxs-lookup"><span data-stu-id="f7747-143">The MERGE statement also inserts new rows for books whose prices have changed, and for these new rows, sets the value of the IsCurrent column to 1.</span></span>  
  
### <a name="merge-a-table-with-new-data-against-the-old-table"></a><span data-ttu-id="f7747-144">Fusionner une table avec des données nouvelles par rapport à l'ancienne table</span><span class="sxs-lookup"><span data-stu-id="f7747-144">Merge a Table with New Data Against the Old Table</span></span>  
 <span data-ttu-id="f7747-145">La base de données modélise les propriétés d’un objet en utilisant un « schéma ouvert », ce qui signifie qu’une table contient des paires nom–valeur pour chaque propriété.</span><span class="sxs-lookup"><span data-stu-id="f7747-145">The database models the properties of an object by using an "open schema," that is, a table contains name-value pairs for each property.</span></span> <span data-ttu-id="f7747-146">La table Properties a trois colonnes : EntityID, PropertyID et Value.</span><span class="sxs-lookup"><span data-stu-id="f7747-146">The Properties table has three columns: EntityID, PropertyID, and Value.</span></span> <span data-ttu-id="f7747-147">Une table NewProperties qui est une version plus récente de la table doit être synchronisée avec la table Properties.</span><span class="sxs-lookup"><span data-stu-id="f7747-147">A NewProperties table that is a newer version of the table has to be synchronized with the Properties table.</span></span> <span data-ttu-id="f7747-148">Pour synchroniser ces deux tables, vous pouvez utiliser une instruction MERGE unique pour effectuer les opérations suivantes :</span><span class="sxs-lookup"><span data-stu-id="f7747-148">To synchronize these two tables, you can use a single MERGE statement to perform the following operations:</span></span>  
  
-   <span data-ttu-id="f7747-149">supprimer des propriétés de la table Properties si elles ne figurent pas dans la table NewProperties ;</span><span class="sxs-lookup"><span data-stu-id="f7747-149">Delete properties from the Properties table if they are absent from the NewProperties table.</span></span>  
  
-   <span data-ttu-id="f7747-150">mettre à jour les valeurs des propriétés dans la table Properties avec les nouvelles valeurs présentes dans la table NewProperties ;</span><span class="sxs-lookup"><span data-stu-id="f7747-150">Update values for properties that are in the Properties table with new values found in the NewProperties table.</span></span>  
  
-   <span data-ttu-id="f7747-151">insérer de nouvelles propriétés pour les propriétés présentes dans la table NewProperties mais qui ne figurent pas dans la table Properties.</span><span class="sxs-lookup"><span data-stu-id="f7747-151">Insert new properties for properties that are in the NewProperties table but are not found in the Properties table.</span></span>  
  
 <span data-ttu-id="f7747-152">Cette approche est utile dans les scénarios qui ressemblent à des scénarios de réplication, où l'objectif est de maintenir la synchronisation entre les données de deux tables sur deux serveurs.</span><span class="sxs-lookup"><span data-stu-id="f7747-152">This approach is useful in scenarios that resemble replication scenarios, where the objective is to keep data in two tables on two servers synchronized.</span></span>  
  
### <a name="track-inventory"></a><span data-ttu-id="f7747-153">Assurer le suivi du stock</span><span class="sxs-lookup"><span data-stu-id="f7747-153">Track Inventory</span></span>  
 <span data-ttu-id="f7747-154">La base de données Inventory possède une table ProductsInventory qui inclut les colonnes ProductID et StockOnHand.</span><span class="sxs-lookup"><span data-stu-id="f7747-154">The Inventory database has a ProductsInventory table that has ProductID and StockOnHand columns.</span></span> <span data-ttu-id="f7747-155">Une table Shipments dotée des colonnes ProductID, CustomerID et Quantity établit le suivi des livraisons de produits aux clients.</span><span class="sxs-lookup"><span data-stu-id="f7747-155">A Shipments table with ProductID, CustomerID, and Quantity columns tracks shipments of products to customers.</span></span> <span data-ttu-id="f7747-156">La table ProductInventory doit être mise à jour quotidiennement en fonction des informations de la table Shipments.</span><span class="sxs-lookup"><span data-stu-id="f7747-156">The ProductInventory table has to be updated daily based on information in the Shipments table.</span></span> <span data-ttu-id="f7747-157">Une instruction MERGE unique peut réduire l'inventaire dans la table ProductInventory en fonction des livraisons effectuées.</span><span class="sxs-lookup"><span data-stu-id="f7747-157">A single MERGE statement can reduce the inventory in the ProductInventory table based on the shipments made.</span></span> <span data-ttu-id="f7747-158">Si l'inventaire d'un produit a été réduit à 0, cette instruction MERGE peut également supprimer cette ligne de produit de la table ProductInventory.</span><span class="sxs-lookup"><span data-stu-id="f7747-158">If the inventory for a product has been reduced to 0, that MERGE statement can also delete that product row from the ProductInventory table.</span></span>  
  
  
